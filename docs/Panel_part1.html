<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Tobias RÃ¼ttenauer">

<title>Panel Data Analysis - 1) Panel data methods</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Panel Data Analysis</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html" rel="" target="">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="./Panel_part1.html" rel="" target="" aria-current="page">
 <span class="menu-text">1) Panel data methods</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./Panel_part2.html" rel="" target="">
 <span class="menu-text">2) Advanced Methods</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./Panel_part3.html" rel="" target="">
 <span class="menu-text">3) Exercises</span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools ms-auto">
    <div class="dropdown">
      <a href="" title="" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" aria-label=""><i class="bi bi-github"></i></a>
      <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="quarto-navigation-tool-dropdown-0">
          <li>
            <a class="dropdown-item quarto-navbar-tools ms-auto-item" href="https://ruettenauer.github.io/Panel-Data-Analysis/">
            Source Code
            </a>
          </li>
      </ul>
    </div>
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#required-packages" id="toc-required-packages" class="nav-link active" data-scroll-target="#required-packages">Required packages</a></li>
  <li><a href="#session-info" id="toc-session-info" class="nav-link" data-scroll-target="#session-info">Session info</a></li>
  <li><a href="#outline" id="toc-outline" class="nav-link" data-scroll-target="#outline">Outline</a></li>
  <li><a href="#panel-data-structure" id="toc-panel-data-structure" class="nav-link" data-scroll-target="#panel-data-structure">Panel data structure</a></li>
  <li><a href="#decomposing-variance" id="toc-decomposing-variance" class="nav-link" data-scroll-target="#decomposing-variance">Decomposing variance</a>
  <ul class="collapse">
  <li><a href="#cross-sectional-setting" id="toc-cross-sectional-setting" class="nav-link" data-scroll-target="#cross-sectional-setting">Cross-sectional setting</a></li>
  <li><a href="#panel-data-setting" id="toc-panel-data-setting" class="nav-link" data-scroll-target="#panel-data-setting">Panel data setting</a>
  <ul class="collapse">
  <li><a href="#pooled-estimator" id="toc-pooled-estimator" class="nav-link" data-scroll-target="#pooled-estimator">Pooled estimator</a></li>
  <li><a href="#between-estimator" id="toc-between-estimator" class="nav-link" data-scroll-target="#between-estimator">Between estimator</a></li>
  <li><a href="#within-estimator" id="toc-within-estimator" class="nav-link" data-scroll-target="#within-estimator">Within estimator</a></li>
  <li><a href="#comparison" id="toc-comparison" class="nav-link" data-scroll-target="#comparison">Comparison</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#fixed-effects-estimator" id="toc-fixed-effects-estimator" class="nav-link" data-scroll-target="#fixed-effects-estimator">Fixed effects estimator</a>
  <ul class="collapse">
  <li><a href="#pooled-ols-again" id="toc-pooled-ols-again" class="nav-link" data-scroll-target="#pooled-ols-again">Pooled OLS (again)</a></li>
  <li><a href="#one-way-fixed-effects" id="toc-one-way-fixed-effects" class="nav-link" data-scroll-target="#one-way-fixed-effects">One-way fixed effects</a></li>
  <li><a href="#two-ways-fe" id="toc-two-ways-fe" class="nav-link" data-scroll-target="#two-ways-fe">Two-ways FE</a></li>
  <li><a href="#still-a-very-critical-assumption" id="toc-still-a-very-critical-assumption" class="nav-link" data-scroll-target="#still-a-very-critical-assumption">Still a very critical assumption</a></li>
  <li><a href="#difference-in-differences" id="toc-difference-in-differences" class="nav-link" data-scroll-target="#difference-in-differences">Difference in Differences</a></li>
  </ul></li>
  <li><a href="#random-effects-estimator" id="toc-random-effects-estimator" class="nav-link" data-scroll-target="#random-effects-estimator">Random effects estimator</a>
  <ul class="collapse">
  <li><a href="#there-are-two-main-problems-with-the-re-estimator" id="toc-there-are-two-main-problems-with-the-re-estimator" class="nav-link" data-scroll-target="#there-are-two-main-problems-with-the-re-estimator">There are two main problems with the RE estimator:</a></li>
  <li><a href="#hausman-test" id="toc-hausman-test" class="nav-link" data-scroll-target="#hausman-test">Hausman test</a></li>
  </ul></li>
  <li><a href="#hybrid-models" id="toc-hybrid-models" class="nav-link" data-scroll-target="#hybrid-models">Hybrid models</a></li>
  <li><a href="#statistical-inference" id="toc-statistical-inference" class="nav-link" data-scroll-target="#statistical-inference">Statistical inference</a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">1) Panel data methods</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>


<div class="quarto-title-meta-author">
  <div class="quarto-title-meta-heading">Author</div>
  <div class="quarto-title-meta-heading">Affiliation</div>
  
    <div class="quarto-title-meta-contents">
    <p class="author"><a href="https://ruettenauer.github.io/">Tobias RÃ¼ttenauer</a> <a href="https://orcid.org/0000-0001-5747-9735" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
  </div>
    <div class="quarto-title-meta-contents">
        <p class="affiliation">
            UCL Social Research Institute
          </p>
      </div>
    </div>

<div class="quarto-title-meta">

      
  
    
  </div>
  

</header>

<section id="required-packages" class="level3">
<h3 class="anchored" data-anchor-id="required-packages">Required packages</h3>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>pkgs <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"plm"</span>, <span class="st">"lfe"</span>, <span class="st">"texreg"</span>, <span class="st">"tidyr"</span>, <span class="st">"dplyr"</span>, <span class="st">"lmtest"</span>, <span class="st">"sandwich"</span>, </span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>          <span class="st">"ggplot2"</span>, <span class="st">"ggforce"</span>) </span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">lapply</span>(pkgs, require, <span class="at">character.only =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="session-info" class="level3">
<h3 class="anchored" data-anchor-id="session-info">Session info</h3>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.3.1 (2023-06-16 ucrt)
Platform: x86_64-w64-mingw32/x64 (64-bit)
Running under: Windows 10 x64 (build 19044)

Matrix products: default


locale:
[1] LC_COLLATE=English_United Kingdom.utf8 
[2] LC_CTYPE=English_United Kingdom.utf8   
[3] LC_MONETARY=English_United Kingdom.utf8
[4] LC_NUMERIC=C                           
[5] LC_TIME=English_United Kingdom.utf8    

time zone: Europe/London
tzcode source: internal

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
 [1] ggforce_0.4.1  ggplot2_3.4.2  sandwich_3.0-2 lmtest_0.9-40  zoo_1.8-12    
 [6] dplyr_1.1.2    tidyr_1.3.0    texreg_1.38.6  lfe_2.9-0      Matrix_1.5-4.1
[11] plm_2.6-3     

loaded via a namespace (and not attached):
 [1] utf8_1.2.3          generics_0.1.3      dreamerr_1.2.3     
 [4] lattice_0.21-8      digest_0.6.32       magrittr_2.0.3     
 [7] evaluate_0.21       grid_4.3.1          fastmap_1.1.1      
[10] jsonlite_1.8.5      Formula_1.2-5       httr_1.4.6         
[13] purrr_1.0.1         fansi_1.0.4         scales_1.2.1       
[16] tweenr_2.0.2        numDeriv_2016.8-1.1 Rdpack_2.4         
[19] cli_3.6.1           rlang_1.1.1         polyclip_1.10-4    
[22] rbibutils_2.2.13    miscTools_0.6-28    munsell_0.5.0      
[25] withr_2.5.0         yaml_2.3.7          fixest_0.11.1      
[28] tools_4.3.1         parallel_4.3.1      bdsmatrix_1.3-6    
[31] colorspace_2.1-0    maxLik_1.5-2        vctrs_0.6.3        
[34] R6_2.5.1            lifecycle_1.0.3     htmlwidgets_1.6.2  
[37] MASS_7.3-60         pkgconfig_2.0.3     gtable_0.3.3       
[40] pillar_1.9.0        glue_1.6.2          Rcpp_1.0.10        
[43] collapse_1.9.6      xfun_0.39           tibble_3.2.1       
[46] tidyselect_1.2.0    rstudioapi_0.14     knitr_1.43         
[49] farver_2.1.1        xtable_1.8-4        htmltools_0.5.5    
[52] nlme_3.1-162        rmarkdown_2.23      compiler_4.3.1     </code></pre>
</div>
</div>
</section>
<section id="outline" class="level1">
<h1>Outline</h1>
<ul>
<li><p>Panel data structure</p></li>
<li><p>Decomposing variance</p></li>
<li><p>Fixed Effects estimator</p></li>
<li><p>Random Effects estimator</p></li>
<li><p>Hybrid / Mundlak models</p></li>
<li><p>Statistical inference</p></li>
</ul>
</section>
<section id="panel-data-structure" class="level1">
<h1>Panel data structure</h1>
<p>Usually cross-sectional data is organized as a matrix, where rows represent the obervation / individual and the columns hold the variables. In panel data settings, we need to add the dimension of time. There are two ways to do so:</p>
<ul>
<li><p>Long format: <span class="math inline">\(N \times T\)</span> observations (rows), with variables âidâ and âtimeâ.</p></li>
<li><p>Wide format: <span class="math inline">\(N\)</span> observations, and <span class="math inline">\(T \times K\)</span> variables, which one variable for each time-period.</p></li>
</ul>
<p>Letâs have a look at the âMalesâ data of the <code>plm</code> package.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">"Males"</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(Males[,<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>], <span class="at">n =</span> <span class="dv">16</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   nr year school exper union
1  13 1980     14     1    no
2  13 1981     14     2   yes
3  13 1982     14     3    no
4  13 1983     14     4    no
5  13 1984     14     5    no
6  13 1985     14     6    no
7  13 1986     14     7    no
8  13 1987     14     8    no
9  17 1980     13     4    no
10 17 1981     13     5    no
11 17 1982     13     6    no
12 17 1983     13     7    no
13 17 1984     13     8    no
14 17 1985     13     9    no
15 17 1986     13    10    no
16 17 1987     13    11    no</code></pre>
</div>
</div>
<p>This is long format, with <code>nr</code> as person identifier (id) and <code>year</code> as time indicator. Long format is what we usually need for analysing data.</p>
<p>Sometimes data comes in wide format. Luckily, we can easily switch between those formats using <code>tidyr</code>.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>Males_wide <span class="ot">&lt;-</span> <span class="fu">pivot_wider</span>(Males, <span class="at">id_cols =</span> nr, <span class="at">names_from =</span> year, </span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>                          <span class="at">values_from =</span> <span class="dv">3</span><span class="sc">:</span><span class="fu">ncol</span>(Males), <span class="at">names_sep =</span> <span class="st">"_"</span>)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(Males_wide[,<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>], <span class="at">n =</span> <span class="dv">16</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 16 Ã 5
      nr school_1980 school_1981 school_1982 school_1983
   &lt;int&gt;       &lt;int&gt;       &lt;int&gt;       &lt;int&gt;       &lt;int&gt;
 1    13          14          14          14          14
 2    17          13          13          13          13
 3    18          12          12          12          12
 4    45          12          12          12          12
 5   110          12          12          12          12
 6   120          10          10          10          10
 7   126          13          13          13          13
 8   150          12          12          12          12
 9   162          11          11          11          11
10   166          10          10          10          10
11   189          14          14          14          14
12   193          14          14          14          14
13   209          11          11          11          11
14   212          11          11          11          11
15   218          15          15          15          15
16   243          12          12          12          12</code></pre>
</div>
</div>
<p>And we can go back to long again:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>Males_long <span class="ot">&lt;-</span> <span class="fu">pivot_longer</span>(Males_wide, <span class="at">cols =</span> <span class="dv">2</span><span class="sc">:</span><span class="fu">ncol</span>(Males_wide), </span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>                           <span class="at">names_to =</span> <span class="fu">c</span>(<span class="st">".value"</span>, <span class="st">"year"</span>), </span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>                           <span class="at">names_pattern =</span> <span class="st">"(.*)_(.*)"</span>)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(Males_long[,<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>], <span class="at">n =</span> <span class="dv">16</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 16 Ã 5
      nr year  school exper union
   &lt;int&gt; &lt;chr&gt;  &lt;int&gt; &lt;int&gt; &lt;fct&gt;
 1    13 1980      14     1 no   
 2    13 1981      14     2 yes  
 3    13 1982      14     3 no   
 4    13 1983      14     4 no   
 5    13 1984      14     5 no   
 6    13 1985      14     6 no   
 7    13 1986      14     7 no   
 8    13 1987      14     8 no   
 9    17 1980      13     4 no   
10    17 1981      13     5 no   
11    17 1982      13     6 no   
12    17 1983      13     7 no   
13    17 1984      13     8 no   
14    17 1985      13     9 no   
15    17 1986      13    10 no   
16    17 1987      13    11 no   </code></pre>
</div>
</div>
<p>Moreover, there two types of panel data:</p>
<ul>
<li><p>Balanced: Contains information for each unit at each time period</p></li>
<li><p>Unbalanced: Some units have missing information at some time periods</p></li>
</ul>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">is.pbalanced</span>(Males, <span class="at">index =</span> <span class="fu">c</span>(<span class="st">"nr"</span>, <span class="st">"year"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
</div>
<p>In our example, we have balanced data (although there might still be NAs in the data).</p>
<p>A nice feature of panel data is that we can do some within-person transformation. For instance we can calculate the lags and leads, or first differences of data.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>always make sure the data is sorted properly before you do!</p>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Order data</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>Males <span class="ot">&lt;-</span> Males[<span class="fu">order</span>(Males<span class="sc">$</span>nr, Males<span class="sc">$</span>year),]</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Person specific means</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>Males<span class="sc">$</span>m_wage <span class="ot">&lt;-</span> <span class="fu">ave</span>(Males<span class="sc">$</span>wage,</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>                    Males<span class="sc">$</span>nr,</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>                    <span class="at">FUN =</span> <span class="cf">function</span>(x) <span class="fu">mean</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Lag (last years value)</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>Males<span class="sc">$</span>lag_wage <span class="ot">&lt;-</span> <span class="fu">ave</span>(Males<span class="sc">$</span>wage,</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>                      Males<span class="sc">$</span>nr,</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>                      <span class="at">FUN =</span> <span class="cf">function</span>(x) dplyr<span class="sc">::</span><span class="fu">lag</span>(x, <span class="at">n =</span> <span class="dv">1</span>))</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Lead (next years value)</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>Males<span class="sc">$</span>lead_wage <span class="ot">&lt;-</span> <span class="fu">ave</span>(Males<span class="sc">$</span>wage,</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>                      Males<span class="sc">$</span>nr,</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>                      <span class="at">FUN =</span> <span class="cf">function</span>(x) dplyr<span class="sc">::</span><span class="fu">lead</span>(x, <span class="at">n =</span> <span class="dv">1</span>))</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a><span class="co"># First difference (this years value minus last years value)</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>Males<span class="sc">$</span>fd_wage <span class="ot">&lt;-</span> <span class="fu">ave</span>(Males<span class="sc">$</span>wage,</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>                      Males<span class="sc">$</span>nr,</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>                      <span class="at">FUN =</span> <span class="cf">function</span>(x) x <span class="sc">-</span> dplyr<span class="sc">::</span><span class="fu">lag</span>(x, <span class="at">n =</span> <span class="dv">1</span>))</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(Males[, <span class="fu">c</span>(<span class="st">"nr"</span>, <span class="st">"year"</span>, <span class="st">"wage"</span>, <span class="st">"m_wage"</span>, <span class="st">"lag_wage"</span>, <span class="st">"lead_wage"</span>, <span class="st">"fd_wage"</span>)], <span class="at">n =</span> <span class="dv">16</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   nr year       wage   m_wage   lag_wage  lead_wage     fd_wage
1  13 1980  1.1975402 1.255652         NA  1.8530600          NA
2  13 1981  1.8530600 1.255652  1.1975402  1.3444617  0.65551979
3  13 1982  1.3444617 1.255652  1.8530600  1.4332133 -0.50859832
4  13 1983  1.4332133 1.255652  1.3444617  1.5681251  0.08875166
5  13 1984  1.5681251 1.255652  1.4332133  1.6998909  0.13491174
6  13 1985  1.6998909 1.255652  1.5681251 -0.7202626  0.13176586
7  13 1986 -0.7202626 1.255652  1.6998909  1.6691879 -2.42015352
8  13 1987  1.6691879 1.255652 -0.7202626         NA  2.38945049
9  17 1980  1.6759624 1.637786         NA  1.5183982          NA
10 17 1981  1.5183982 1.637786  1.6759624  1.5591905 -0.15756420
11 17 1982  1.5591905 1.637786  1.5183982  1.7254101  0.04079228
12 17 1983  1.7254101 1.637786  1.5591905  1.6220223  0.16621961
13 17 1984  1.6220223 1.637786  1.7254101  1.6085883 -0.10338777
14 17 1985  1.6085883 1.637786  1.6220223  1.5723854 -0.01343405
15 17 1986  1.5723854 1.637786  1.6085883  1.8203339 -0.03620286
16 17 1987  1.8203339 1.637786  1.5723854         NA  0.24794844</code></pre>
</div>
</div>
<p>There are a lot of different panel data sources available. Some examples are:</p>
<ul>
<li><p><a href="https://psidonline.isr.umich.edu/">PSID</a></p></li>
<li><p><a href="https://www.nlsinfo.org/content/cohorts/nlsy79">National Longitudinal Survey of Youth</a></p></li>
<li><p><a href="https://www.understandingsociety.ac.uk/">Understanding Society</a></p></li>
<li><p><a href="https://cls.ucl.ac.uk/cls-studies/millennium-cohort-study/">Millennium Cohort Study</a></p></li>
<li><p><a href="https://www.diw.de/en/diw_01.c.615551.en/research_infrastructure__socio-economic_panel__soep.html">SOEP</a></p></li>
<li><p><a href="https://www.pairfam.de/">Pairfam</a></p></li>
<li><p><a href="http://www.share-project.org/home0.html">SHARE</a></p></li>
</ul>
<p>And there are various process generated data having a longitudinal / panel dimension as well. For instance:</p>
<ul>
<li><p><a href="https://github.com/owid/covid-19-data">Our world in data COVID</a></p></li>
<li><p><a href="https://www.nomisweb.co.uk/sources/census">UK Census</a></p></li>
<li><p><a href="https://data.london.gov.uk/air-quality/">London Air Pollution</a></p></li>
<li><p><a href="https://land.copernicus.eu/pan-european/high-resolution-layers/forests/tree-cover-density/status-maps">European Tree Cover Density</a></p></li>
</ul>
<p>One thing that is often difficult: Many panel data come as a bunch of single (cross-sectional) files and have to be combined into a single dataset. However, many data providers (or nice colleagues) now offer simplified long-format data or pre-written scripts to merge data across waves (e.g.&nbsp;<a href="https://www.understandingsociety.ac.uk/documentation/mainstage/syntax">here</a> for Understanding Society, or <a href="https://www.ls3.soziologie.uni-muenchen.de/studium-lehre/lehrmaterialien/index.html">here</a> for SOEP).</p>
<p>A second problem is panel attrition. Usually, the number of individuals participating repeatedly goes down over time.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="fig/soep.PNG" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Rainer Siegers, Veronika Belcheva, Tobias Silbermann 2020: https://www.diw.de/documents/publikationen/73/diw_01.c.745900.de/diw_ssp0826.pdf</figcaption>
</figure>
</div>
<p>The main question here: Is attrition (as good as) random or are drop-outs systematic? How does this affect the sample composition and representativeness?</p>
<p>Most panels also provide inverse-probability of staying weights to account for the possibility of non-random attrition. Note that these also probability weights can only account for attrition based on observables. For a general discussion about weighting see for instance <span class="citation" data-cites="Solon.2015">Solon, Haider, and Wooldridge (<a href="#ref-Solon.2015" role="doc-biblioref">2015</a>)</span>.</p>
</section>
<section id="decomposing-variance" class="level1">
<h1>Decomposing variance</h1>
<p>Letâs clarify the idea and advantage of panel data with an example. Assume we want to know the relationship between age (as our independent variable) and happiness (as our dependent variable), and we have data on 24 observations.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r fold-hide code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="do">################################</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="do">### Example 1: Age happiness </span><span class="al">###</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="do">################################</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">213</span>)</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="do">### Data simulation program</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>simdata <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">N =</span> <span class="dv">6</span>, <span class="at">T =</span> <span class="dv">4</span>,</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>                    <span class="at">age_range =</span> <span class="fu">c</span>(<span class="dv">20</span><span class="sc">:</span><span class="dv">60</span>), </span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>                    <span class="at">u_sd =</span> <span class="fl">0.2</span>, <span class="at">uw_sd =</span> <span class="dv">0</span>){</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># id and wave</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">nrow =</span> N<span class="sc">*</span>T))</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(df) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"id"</span>, <span class="st">"time"</span>)</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>id <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>N, <span class="at">each =</span> T)</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>time <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>T, <span class="at">times =</span> N)</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>idname <span class="ot">&lt;-</span> <span class="fu">factor</span>(df<span class="sc">$</span>id, <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span>N), <span class="at">labels =</span> <span class="fu">paste</span>(<span class="st">"Person"</span>, <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span>N)))</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># age</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>  startingage <span class="ot">&lt;-</span> age_range</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>  startingage <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">quantile</span>(startingage, <span class="at">probs =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span><span class="sc">/</span>(N<span class="dv">-1</span>))), <span class="dv">0</span>)</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>age <span class="ot">&lt;-</span> <span class="fu">unname</span>(<span class="fu">rep</span>(startingage, <span class="at">each =</span> T)) <span class="sc">+</span> df<span class="sc">$</span>time<span class="sc">*</span><span class="dv">2</span></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># cohort </span></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>cohort <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>cohort[(N<span class="sc">*</span>T<span class="sc">/</span><span class="dv">2</span> <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(N<span class="sc">*</span>T)] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>cohort <span class="ot">&lt;-</span> <span class="fu">factor</span>(df<span class="sc">$</span>cohort, <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), </span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>                      <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Younger cohort"</span>, <span class="st">"Older cohort"</span>))</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>  <span class="co"># demeaned age</span></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>dm_age <span class="ot">&lt;-</span> df<span class="sc">$</span>age <span class="sc">-</span> <span class="fu">ave</span>(df<span class="sc">$</span>age, df<span class="sc">$</span>id, <span class="at">FUN =</span> <span class="cf">function</span>(x) <span class="fu">mean</span>(x)) </span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Personal intercept</span></span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>intercept <span class="ot">&lt;-</span> <span class="dv">5</span> <span class="sc">+</span> <span class="fl">0.5</span> <span class="sc">*</span> df<span class="sc">$</span>id</span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Overall error</span></span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>  u <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N<span class="sc">*</span>T, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> u_sd)</span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Additional within error</span></span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>  uw <span class="ot">&lt;-</span> <span class="fu">unlist</span>(<span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>N, <span class="cf">function</span>(x) <span class="fu">rnorm</span>(T, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> uw_sd)))</span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Gen happiness</span></span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">+</span> <span class="fl">0.05</span> <span class="sc">*</span> df<span class="sc">$</span>age <span class="sc">-</span> <span class="fl">0.2</span> <span class="sc">*</span> df<span class="sc">$</span>dm_age <span class="sc">+</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fu">as.numeric</span>(df<span class="sc">$</span>cohort) <span class="sc">+</span> u <span class="sc">+</span> uw</span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>happiness <span class="ot">&lt;-</span> y</span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Gen person means</span></span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>m_age <span class="ot">&lt;-</span> <span class="fu">ave</span>(df<span class="sc">$</span>age, df<span class="sc">$</span>id, <span class="at">FUN =</span> <span class="cf">function</span>(x) <span class="fu">mean</span>(x)) </span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>m_happiness <span class="ot">&lt;-</span> <span class="fu">ave</span>(df<span class="sc">$</span>happiness, df<span class="sc">$</span>id, <span class="at">FUN =</span> <span class="cf">function</span>(x) <span class="fu">mean</span>(x)) </span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(df)</span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-54"><a href="#cb14-54" aria-hidden="true" tabindex="-1"></a><span class="do">### Set up six individuals with age and happiness</span></span>
<span id="cb14-55"><a href="#cb14-55" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">6</span></span>
<span id="cb14-56"><a href="#cb14-56" aria-hidden="true" tabindex="-1"></a>T <span class="ot">&lt;-</span> <span class="dv">4</span></span>
<span id="cb14-57"><a href="#cb14-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-58"><a href="#cb14-58" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">simdata</span>(<span class="at">N =</span> N, <span class="at">T =</span> T)</span>
<span id="cb14-59"><a href="#cb14-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-60"><a href="#cb14-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-61"><a href="#cb14-61" aria-hidden="true" tabindex="-1"></a><span class="co"># Total line for plot</span></span>
<span id="cb14-62"><a href="#cb14-62" aria-hidden="true" tabindex="-1"></a>lm1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(happiness <span class="sc">~</span> age, <span class="at">data =</span> df)</span>
<span id="cb14-63"><a href="#cb14-63" aria-hidden="true" tabindex="-1"></a>lm2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(happiness <span class="sc">~</span> age <span class="sc">+</span> cohort, <span class="at">data =</span> df)</span>
<span id="cb14-64"><a href="#cb14-64" aria-hidden="true" tabindex="-1"></a>lm3 <span class="ot">&lt;-</span> <span class="fu">lm</span>(happiness <span class="sc">~</span> age <span class="sc">+</span> idname, <span class="at">data =</span> df)</span>
<span id="cb14-65"><a href="#cb14-65" aria-hidden="true" tabindex="-1"></a>lm4 <span class="ot">&lt;-</span> <span class="fu">lm</span>(m_happiness <span class="sc">~</span> m_age, <span class="at">data =</span> df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="cross-sectional-setting" class="level2">
<h2 class="anchored" data-anchor-id="cross-sectional-setting">Cross-sectional setting</h2>
<p>In a cross-sectional setting, we could just run a standard linear regression model using Omitted Least Squares (OLS) of the form <span class="math display">\[
y_{i} = \alpha + \beta_1 x_{i} + \upsilon_{i},
\]</span> where <span class="math inline">\(y_{i}\)</span> is the dependent variable (happiness) and <span class="math inline">\(x_i\)</span> the independent variable of each observation <span class="math inline">\(i \in \{1, \dots, 24\}\)</span>. <span class="math inline">\(\beta_1\)</span> is the coefficient of interest, <span class="math inline">\(\alpha\)</span> the overall intercept and <span class="math inline">\(\upsilon_{i}\)</span> the error term.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>lm1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(happiness <span class="sc">~</span> age, <span class="at">data =</span> df)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(lm1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = happiness ~ age, data = df)

Residuals:
    Min      1Q  Median      3Q     Max 
-1.4964 -0.4209 -0.1201  0.6615  1.6868 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)   1.0506     0.5696   1.844   0.0787 .  
age           0.1151     0.0121   9.515 2.96e-09 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.8206 on 22 degrees of freedom
Multiple R-squared:  0.8045,    Adjusted R-squared:  0.7956 
F-statistic: 90.53 on 1 and 22 DF,  p-value: 2.96e-09</code></pre>
</div>
</div>
<p>This indicates a positive relation between age and happiness. Graphically, this would look like:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r fold-hide code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The palette with black:</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>cbp2 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"#000000"</span>, </span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>          <span class="st">"#E69F00"</span>, </span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>          <span class="st">"#56B4E9"</span>, </span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>          <span class="st">"#009E73"</span>,</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>          <span class="st">"#F0E442"</span>, </span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>          <span class="st">"#0072B2"</span>, </span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>          <span class="st">"#D55E00"</span>, </span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>          <span class="st">"#CC79A7"</span>)</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the residual values</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>predicted <span class="ot">&lt;-</span> <span class="fu">predict</span>(lm1)</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>residuals <span class="ot">&lt;-</span> <span class="fu">residuals</span>(lm1)</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>zp1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df, <span class="fu">aes</span>(age, happiness)) <span class="sc">+</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>( <span class="fu">aes</span>(<span class="at">x =</span> age, <span class="at">y =</span> happiness), <span class="at">size =</span> <span class="dv">2</span>, <span class="at">stroke =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">'lm'</span>, <span class="at">formula =</span> y <span class="sc">~</span> x, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">color  =</span> <span class="st">"deeppink"</span>) <span class="sc">+</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_segment</span>(<span class="at">data =</span> df, <span class="fu">aes</span>(<span class="at">xend =</span> age, <span class="at">yend =</span> predicted), </span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>               <span class="at">alpha =</span> .<span class="dv">3</span>, <span class="at">color =</span> <span class="st">"purple"</span>) <span class="sc">+</span></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="fl">3.3</span>, <span class="fl">9.2</span>) <span class="sc">+</span> <span class="fu">expand_limits</span>(<span class="at">y =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span> </span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.key =</span> <span class="fu">element_blank</span>(), <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.95</span>,<span class="fl">0.05</span>), <span class="at">legend.justification =</span> <span class="fu">c</span>(<span class="st">"right"</span>, <span class="st">"bottom"</span>),</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.box.background =</span> <span class="fu">element_rect</span>(<span class="at">colour =</span> <span class="st">"black"</span>))</span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>zp1  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Panel_part1_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Obviously, we might suspect some other characteristics to influence our results. For instance, birth cohort might be a potential confounder that affects age and happiness. We can easily add a control for the cohort to account for this possibility. We would then estimate the model</p>
<p><span class="math display">\[
y_{i} = \alpha + \beta_1 x_{i} + \beta_2 z_{it} + \upsilon_{i},
\]</span> where <span class="math inline">\(z_i\)</span> is the control variable or confounder (cohort).</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>lm2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(happiness <span class="sc">~</span> age <span class="sc">+</span> cohort, <span class="at">data =</span> df)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(lm2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = happiness ~ age + cohort, data = df)

Residuals:
     Min       1Q   Median       3Q      Max 
-1.01188 -0.35012 -0.01682  0.31611  0.92289 

Coefficients:
                   Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)         3.32191    0.52030   6.385 2.50e-06 ***
age                 0.03687    0.01512   2.439   0.0237 *  
cohortOlder cohort  2.49959    0.41862   5.971 6.31e-06 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.5114 on 21 degrees of freedom
Multiple R-squared:  0.9275,    Adjusted R-squared:  0.9206 
F-statistic: 134.4 on 2 and 21 DF,  p-value: 1.075e-12</code></pre>
</div>
</div>
<p>As a result, the effect of age becomes weaker. Graphically, this would look like:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r fold-hide code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the residual values</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="fu">unique</span>(df<span class="sc">$</span>cohort)){</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  oo <span class="ot">&lt;-</span> <span class="fu">which</span>(df<span class="sc">$</span>cohort <span class="sc">==</span> i)</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  lmt <span class="ot">&lt;-</span> <span class="fu">lm</span>(happiness <span class="sc">~</span> age, <span class="at">data =</span> df[oo, ])</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>predicted[oo] <span class="ot">&lt;-</span> <span class="fu">predict</span>(lmt)</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>residuals[oo] <span class="ot">&lt;-</span> <span class="fu">residuals</span>(lmt)</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>zp2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df, <span class="fu">aes</span>(age, happiness)) <span class="sc">+</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> age, <span class="at">y =</span> happiness, <span class="at">shape =</span> cohort, <span class="at">colour =</span> cohort), </span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>              <span class="at">size =</span> <span class="dv">2</span>, <span class="at">stroke =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">'lm'</span>, <span class="at">formula =</span> y <span class="sc">~</span> x, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>,</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>              <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">colour =</span> cohort, <span class="at">linetype =</span> cohort)) <span class="sc">+</span>  </span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_segment</span>(<span class="at">data =</span> df, <span class="fu">aes</span>(<span class="at">xend =</span> age, <span class="at">yend =</span> predicted), </span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>               <span class="at">alpha =</span> .<span class="dv">3</span>, <span class="at">color =</span> <span class="st">"purple"</span>) <span class="sc">+</span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">intercept =</span> lm2<span class="sc">$</span>coefficients[<span class="dv">1</span>] <span class="sc">+</span> <span class="fl">0.5</span> <span class="sc">*</span> lm2<span class="sc">$</span>coefficients[<span class="dv">3</span>], </span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>                               <span class="at">slope =</span> lm2<span class="sc">$</span>coefficients[<span class="dv">2</span>], <span class="at">color  =</span> <span class="st">"deeppink"</span>) <span class="sc">+</span>  </span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="fl">3.3</span>, <span class="fl">9.2</span>) <span class="sc">+</span> <span class="fu">expand_limits</span>(<span class="at">y =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span> </span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_manual</span>(<span class="at">values =</span> cbp2[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>)]) <span class="sc">+</span> </span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> cbp2[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>)]) <span class="sc">+</span> </span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_shape_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="dv">15</span><span class="sc">:</span><span class="dv">18</span>, <span class="dv">25</span>, <span class="dv">20</span>)) <span class="sc">+</span></span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.key =</span> <span class="fu">element_blank</span>(), <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.95</span>,<span class="fl">0.05</span>), <span class="at">legend.justification =</span> <span class="fu">c</span>(<span class="st">"right"</span>, <span class="st">"bottom"</span>),</span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.box.background =</span> <span class="fu">element_rect</span>(<span class="at">colour =</span> <span class="st">"black"</span>))</span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>zp2  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Panel_part1_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>So, what we basically receive here is the (weighted) average effect within each birth cohort. We use only similar observations (in terms of cohort) to estimate our effect of interest - the correlation between age and happiness. If we add any controls, we always decompose the variance which contributes to our estimator, and we eliminate the variance that is attributed to the confounder / control variable.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="fig/NHK_Control.gif" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Illustration by <span class="citation" data-cites="Huntington-Klein.2021">Huntington-Klein (<a href="#ref-Huntington-Klein.2021" role="doc-biblioref">2021</a>)</span>: Introducing a binary control variable</figcaption>
</figure>
</div>
</section>
<section id="panel-data-setting" class="level2">
<h2 class="anchored" data-anchor-id="panel-data-setting">Panel data setting</h2>
<p>Now, with panel data, we can even go a step further. Assume we would not have observed 24 independent observations, but rather 6 independent individuals (N = 6) at 4 time-points each (T = 4).</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r fold-hide code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>zp3 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df, <span class="fu">aes</span>(age, happiness)) <span class="sc">+</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>( <span class="fu">aes</span>(<span class="at">x =</span> age, <span class="at">y =</span> happiness, <span class="at">shape =</span> idname, <span class="at">colour =</span> idname, <span class="at">fill =</span> idname), </span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>              <span class="at">size =</span> <span class="dv">2</span>, <span class="at">stroke =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="fl">3.3</span>, <span class="fl">9.2</span>) <span class="sc">+</span> <span class="fu">expand_limits</span>(<span class="at">y =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span> </span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_manual</span>(<span class="at">values =</span> cbp2[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>)]) <span class="sc">+</span> </span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> cbp2[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>)]) <span class="sc">+</span> </span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_shape_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="dv">15</span><span class="sc">:</span><span class="dv">18</span>, <span class="dv">25</span>, <span class="dv">20</span>)) <span class="sc">+</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.key =</span> <span class="fu">element_blank</span>(), <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.95</span>,<span class="fl">0.05</span>), <span class="at">legend.justification =</span> <span class="fu">c</span>(<span class="st">"right"</span>, <span class="st">"bottom"</span>),</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.box.background =</span> <span class="fu">element_rect</span>(<span class="at">colour =</span> <span class="st">"black"</span>))</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>zp3 </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Panel_part1_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We can then decompose the available variance into three different parts:</p>
<ul>
<li><p>Pooled variance</p></li>
<li><p>Between variance</p></li>
<li><p>Within variance</p></li>
</ul>
<section id="pooled-estimator" class="level3">
<h3 class="anchored" data-anchor-id="pooled-estimator">Pooled estimator</h3>
<p>The pooled estimator equals what we have seen in the cross-sectional example: we basically assume that we have 24 independent observations and we ignore the person and time dimension. The Pooled OLS estimator is simply:</p>
<p><span class="math display">\[
y_{it} = \alpha + \beta_{POLS} x_{it} + \upsilon_{it},
\]</span></p>
<p>And, as above, we use the simple <code>lm()</code> command</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>lm1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(happiness <span class="sc">~</span> age, <span class="at">data =</span> df)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(lm1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = happiness ~ age, data = df)

Residuals:
    Min      1Q  Median      3Q     Max 
-1.4964 -0.4209 -0.1201  0.6615  1.6868 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)   1.0506     0.5696   1.844   0.0787 .  
age           0.1151     0.0121   9.515 2.96e-09 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.8206 on 22 degrees of freedom
Multiple R-squared:  0.8045,    Adjusted R-squared:  0.7956 
F-statistic: 90.53 on 1 and 22 DF,  p-value: 2.96e-09</code></pre>
</div>
</div>
<p>which graphically looks like:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r fold-hide code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the residual values</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>predicted <span class="ot">&lt;-</span> <span class="fu">predict</span>(lm1)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>residuals <span class="ot">&lt;-</span> <span class="fu">residuals</span>(lm1)</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>zp3 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df, <span class="fu">aes</span>(age, happiness)) <span class="sc">+</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>( <span class="fu">aes</span>(<span class="at">x =</span> age, <span class="at">y =</span> happiness, <span class="at">shape =</span> idname, <span class="at">colour =</span> idname, <span class="at">fill =</span> idname), </span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>              <span class="at">size =</span> <span class="dv">2</span>, <span class="at">stroke =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">'lm'</span>, <span class="at">formula =</span> y <span class="sc">~</span> x, <span class="at">se =</span> <span class="cn">FALSE</span>,</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>              <span class="at">color  =</span> <span class="st">"deeppink"</span>) <span class="sc">+</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_segment</span>(<span class="fu">aes</span>(<span class="at">xend =</span> age, <span class="at">yend =</span> predicted), </span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>               <span class="at">alpha =</span> .<span class="dv">3</span>, <span class="at">color =</span> <span class="st">"purple"</span>) <span class="sc">+</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="dv">35</span>, <span class="at">y =</span> <span class="fl">8.0</span>, </span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>           <span class="at">label =</span> <span class="fu">paste0</span>(<span class="st">"beta[Pooled] =="</span>, <span class="fu">round</span>(lm1<span class="sc">$</span>coefficients[<span class="dv">2</span>], <span class="dv">3</span>)), </span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>           <span class="at">parse =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="fl">3.3</span>, <span class="fl">9.2</span>) <span class="sc">+</span> <span class="fu">expand_limits</span>(<span class="at">y =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span> </span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_manual</span>(<span class="at">values =</span> cbp2[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>)]) <span class="sc">+</span> </span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> cbp2[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>)]) <span class="sc">+</span> </span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_shape_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="dv">15</span><span class="sc">:</span><span class="dv">18</span>, <span class="dv">25</span>, <span class="dv">20</span>)) <span class="sc">+</span></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"A) Pooled Estimate"</span>) <span class="sc">+</span></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.key =</span> <span class="fu">element_blank</span>(), </span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a>        <span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.95</span>,<span class="fl">0.05</span>), </span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.justification =</span> <span class="fu">c</span>(<span class="st">"right"</span>, <span class="st">"bottom"</span>),</span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.box.background =</span> <span class="fu">element_rect</span>(<span class="at">colour =</span> <span class="st">"black"</span>))</span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a>zp3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Panel_part1_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Interpretation: The higher the age of an observation, the higher their happiness.</p>
</section>
<section id="between-estimator" class="level3">
<h3 class="anchored" data-anchor-id="between-estimator">Between estimator</h3>
<p>The between estimator only compares different persons and discards the within-person variance. Therefore, we simply run a model that only uses the person-specific means</p>
<p><span class="math display">\[
\bar{y_{i}} = \alpha + \beta_{BTW} \bar{x_{i}} + \bar{\upsilon_{i}},
\]</span></p>
<p>We can either estimate this by hand:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>m_happiness <span class="ot">&lt;-</span> <span class="fu">ave</span>(df<span class="sc">$</span>happiness, df<span class="sc">$</span>id, <span class="at">FUN =</span> mean)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>m_age <span class="ot">&lt;-</span> <span class="fu">ave</span>(df<span class="sc">$</span>age, df<span class="sc">$</span>id, <span class="at">FUN =</span> mean)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>lm2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(m_happiness <span class="sc">~</span> m_age, <span class="at">data =</span> df)</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(lm2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = m_happiness ~ m_age, data = df)

Residuals:
     Min       1Q   Median       3Q      Max 
-0.77437 -0.17518 -0.06819  0.25424  0.83169 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept) 0.733095   0.356036   2.059   0.0515 .  
m_age       0.122176   0.007571  16.138 1.12e-13 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.5067 on 22 degrees of freedom
Multiple R-squared:  0.9221,    Adjusted R-squared:  0.9186 
F-statistic: 260.4 on 1 and 22 DF,  p-value: 1.118e-13</code></pre>
</div>
</div>
<p>or we use the <code>plm</code> package to do the job for us</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>btw2 <span class="ot">&lt;-</span> <span class="fu">plm</span>(happiness <span class="sc">~</span> age, <span class="at">data =</span> df,</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>           <span class="at">index =</span> <span class="fu">c</span>(<span class="st">"id"</span>, <span class="st">"time"</span>),</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">effect =</span> <span class="st">"individual"</span>, <span class="at">model =</span> <span class="st">"between"</span>)</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(btw2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Oneway (individual) effect Between Model

Call:
plm(formula = happiness ~ age, data = df, effect = "individual", 
    model = "between", index = c("id", "time"))

Balanced Panel: n = 6, T = 4, N = 24
Observations used in estimation: 6

Residuals:
        1         2         3         4         5         6 
 0.254242 -0.158370 -0.774367  0.831689  0.021989 -0.175184 

Coefficients:
            Estimate Std. Error t-value Pr(&gt;|t|)   
(Intercept) 0.733095   0.834979  0.8780 0.429528   
age         0.122176   0.017755  6.8813 0.002337 **
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Total Sum of Squares:    18.13
Residual Sum of Squares: 1.4122
R-Squared:      0.92211
Adj. R-Squared: 0.90263
F-statistic: 47.3519 on 1 and 4 DF, p-value: 0.0023371</code></pre>
</div>
</div>
<p>NOTE the line âobservations used in estimationâ ! The manual approach with <code>lm</code> assumes we have 24 independent observations. This is not true, we only have 6 independent observations, where each is replicated 4 times in the data.</p>
<p>Graphically this result looks like:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r fold-hide code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>df2 <span class="ot">&lt;-</span> df</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>happiness <span class="ot">&lt;-</span> df2<span class="sc">$</span>m_happiness</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>age <span class="ot">&lt;-</span> df2<span class="sc">$</span>m_age</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>df2 <span class="ot">&lt;-</span> df2[<span class="fu">which</span>(df2<span class="sc">$</span>time <span class="sc">==</span> <span class="dv">1</span>), ]</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the residual values</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>lm4 <span class="ot">&lt;-</span> <span class="fu">lm</span>(m_happiness <span class="sc">~</span> m_age, <span class="at">data =</span> df2)</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>predicted <span class="ot">&lt;-</span> <span class="fu">predict</span>(lm4)</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>residuals <span class="ot">&lt;-</span> <span class="fu">residuals</span>(lm4)</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>zp4 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df, <span class="fu">aes</span>(age, happiness)) <span class="sc">+</span></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> age, <span class="at">y =</span> happiness, <span class="at">shape =</span> idname), </span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>              <span class="at">size =</span> <span class="dv">2</span>, <span class="at">stroke =</span> <span class="dv">1</span>, <span class="at">colour =</span> <span class="fu">alpha</span>(<span class="st">"black"</span>, .<span class="dv">3</span>), <span class="at">fill =</span> <span class="fu">alpha</span>(<span class="st">"black"</span>, .<span class="dv">3</span>)) <span class="sc">+</span></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> m_age, <span class="at">y =</span> m_happiness, <span class="at">shape =</span> idname, <span class="at">colour =</span> idname,</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>                 <span class="at">fill =</span> idname), </span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>             <span class="at">size =</span> <span class="dv">2</span>, <span class="at">stroke =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">data =</span> df2, </span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>              <span class="at">method =</span> <span class="st">'lm'</span>, <span class="at">formula =</span> y <span class="sc">~</span> x, <span class="at">se =</span> <span class="cn">FALSE</span>,</span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>              <span class="at">color  =</span> <span class="st">"deeppink"</span>) <span class="sc">+</span></span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_segment</span>(<span class="at">data =</span> df2, <span class="fu">aes</span>(<span class="at">xend =</span> age, <span class="at">yend =</span> predicted), </span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>               <span class="at">alpha =</span> .<span class="dv">3</span>, <span class="at">color =</span> <span class="st">"purple"</span>) <span class="sc">+</span></span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="dv">35</span>, <span class="at">y =</span> <span class="fl">8.0</span>, </span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>           <span class="at">label =</span> <span class="fu">paste0</span>(<span class="st">"beta[Between] =="</span>, <span class="fu">round</span>(lm4<span class="sc">$</span>coefficients[<span class="dv">2</span>], <span class="dv">3</span>)), </span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>           <span class="at">parse =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="fl">3.3</span>, <span class="fl">9.2</span>) <span class="sc">+</span> <span class="fu">expand_limits</span>(<span class="at">y =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span> </span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_manual</span>(<span class="at">values =</span> cbp2[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>)]) <span class="sc">+</span> </span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> cbp2[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>)]) <span class="sc">+</span> </span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_shape_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="dv">15</span><span class="sc">:</span><span class="dv">18</span>, <span class="dv">25</span>, <span class="dv">20</span>)) <span class="sc">+</span></span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"B) Between Estimate"</span>) <span class="sc">+</span></span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.key =</span> <span class="fu">element_blank</span>(), </span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a>        <span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.95</span>,<span class="fl">0.05</span>), </span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.justification =</span> <span class="fu">c</span>(<span class="st">"right"</span>, <span class="st">"bottom"</span>),</span>
<span id="cb29-36"><a href="#cb29-36" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb29-37"><a href="#cb29-37" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.box.background =</span> <span class="fu">element_rect</span>(<span class="at">colour =</span> <span class="st">"black"</span>))</span>
<span id="cb29-38"><a href="#cb29-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-39"><a href="#cb29-39" aria-hidden="true" tabindex="-1"></a>zp4  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Panel_part1_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Interpretation: The older a person the higher their hapinness (as compared to younger people).</p>
</section>
<section id="within-estimator" class="level3">
<h3 class="anchored" data-anchor-id="within-estimator">Within estimator</h3>
<p>The within estimator only compares different periods within the same person and discards the between-person variance. We could also say the estimator is solely based on changes over time. To achieve this, we simply give every person their own intercept / add a dummy for each person (similar to the cohort example above).</p>
<p><span class="math display">\[
y_{it} = \alpha_i + \beta_{WI} x_{it} + \epsilon_{it},
\]</span></p>
<p>Again, we could run this manually</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>lm3 <span class="ot">&lt;-</span> <span class="fu">lm</span>(happiness <span class="sc">~</span> age <span class="sc">+</span> idname, <span class="at">data =</span> df)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(lm3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = happiness ~ age + idname, data = df)

Residuals:
     Min       1Q   Median       3Q      Max 
-0.28791 -0.11875  0.03583  0.14172  0.27594 

Coefficients:
               Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)     7.74785    0.44579  17.380 2.93e-12 ***
age            -0.14824    0.01742  -8.511 1.56e-07 ***
idnamePerson 2  1.75075    0.19396   9.026 6.80e-08 ***
idnamePerson 3  3.29812    0.30964  10.652 6.09e-09 ***
idnamePerson 4  7.06754    0.43927  16.089 1.01e-11 ***
idnamePerson 5  8.42120    0.57348  14.684 4.34e-11 ***
idnamePerson 6 10.38740    0.70968  14.637 4.57e-11 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.1908 on 17 degrees of freedom
Multiple R-squared:  0.9918,    Adjusted R-squared:  0.9889 
F-statistic: 344.1 on 6 and 17 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
</div>
<p>or we use <code>plm</code>:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>fe1 <span class="ot">&lt;-</span> <span class="fu">plm</span>(happiness <span class="sc">~</span> age, <span class="at">data =</span> df,</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>           <span class="at">index =</span> <span class="fu">c</span>(<span class="st">"id"</span>, <span class="st">"time"</span>),</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">effect =</span> <span class="st">"individual"</span>, <span class="at">model =</span> <span class="st">"within"</span>)</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fe1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Oneway (individual) effect Within Model

Call:
plm(formula = happiness ~ age, data = df, effect = "individual", 
    model = "within", index = c("id", "time"))

Balanced Panel: n = 6, T = 4, N = 24

Residuals:
     Min.   1st Qu.    Median   3rd Qu.      Max. 
-0.287907 -0.118754  0.035834  0.141721  0.275941 

Coefficients:
     Estimate Std. Error t-value  Pr(&gt;|t|)    
age -0.148245   0.017418 -8.5108 1.556e-07 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Total Sum of Squares:    3.2561
Residual Sum of Squares: 0.61893
R-Squared:      0.80992
Adj. R-Squared: 0.74283
F-statistic: 72.4345 on 1 and 17 DF, p-value: 1.5556e-07</code></pre>
</div>
</div>
<p>Graphically, this would look like:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r fold-hide code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>df2 <span class="ot">&lt;-</span> df</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>happiness <span class="ot">&lt;-</span> df2<span class="sc">$</span>happiness <span class="sc">-</span> df2<span class="sc">$</span>m_happiness <span class="sc">+</span> <span class="fu">mean</span>(df<span class="sc">$</span>happiness)</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>age <span class="ot">&lt;-</span> df2<span class="sc">$</span>age <span class="sc">-</span> df2<span class="sc">$</span>m_age  <span class="sc">+</span> <span class="fu">mean</span>(df<span class="sc">$</span>age)</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the residual values</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="fu">unique</span>(df<span class="sc">$</span>id)){</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>  oo <span class="ot">&lt;-</span> <span class="fu">which</span>(df<span class="sc">$</span>id <span class="sc">==</span> i)</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>  lmt <span class="ot">&lt;-</span> <span class="fu">lm</span>(happiness <span class="sc">~</span> age, <span class="at">data =</span> df[oo, ])</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>predicted[oo] <span class="ot">&lt;-</span> <span class="fu">predict</span>(lmt)</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>residuals[oo] <span class="ot">&lt;-</span> <span class="fu">residuals</span>(lmt)</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>zp5 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df, <span class="fu">aes</span>(age, happiness)) <span class="sc">+</span></span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>( <span class="fu">aes</span>(<span class="at">x =</span> age, <span class="at">y =</span> happiness, <span class="at">shape =</span> idname, <span class="at">colour =</span> idname, <span class="at">fill  =</span> idname), </span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>              <span class="at">size =</span> <span class="dv">2</span>, <span class="at">stroke =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">'lm'</span>, <span class="at">formula =</span> y <span class="sc">~</span> x, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>,</span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>              <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">group =</span> idname),</span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>              <span class="at">color  =</span> <span class="st">"deeppink"</span>, <span class="at">linetype =</span> <span class="st">"dotted"</span>) <span class="sc">+</span></span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">'lm'</span>, <span class="at">formula =</span> y <span class="sc">~</span> x, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>,</span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a>              <span class="at">data =</span> df2, <span class="at">color  =</span> <span class="st">"deeppink"</span>, <span class="at">fullrange =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_segment</span>(<span class="at">data =</span> df, <span class="fu">aes</span>(<span class="at">xend =</span> age, <span class="at">yend =</span> predicted), </span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a>               <span class="at">alpha =</span> .<span class="dv">3</span>, <span class="at">color =</span> <span class="st">"purple"</span>) <span class="sc">+</span></span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="dv">35</span>, <span class="at">y =</span> <span class="fl">8.0</span>, </span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a>           <span class="at">label =</span> <span class="fu">paste0</span>(<span class="st">"beta[Within] =="</span>, <span class="fu">round</span>(lm3<span class="sc">$</span>coefficients[<span class="dv">2</span>], <span class="dv">3</span>)), </span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a>           <span class="at">parse =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="fl">3.3</span>, <span class="fl">9.2</span>) <span class="sc">+</span> <span class="fu">expand_limits</span>(<span class="at">y =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span> </span>
<span id="cb34-28"><a href="#cb34-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> cbp2[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>)]) <span class="sc">+</span></span>
<span id="cb34-29"><a href="#cb34-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_manual</span>(<span class="at">values =</span> cbp2[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>)]) <span class="sc">+</span> </span>
<span id="cb34-30"><a href="#cb34-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_shape_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="dv">15</span><span class="sc">:</span><span class="dv">18</span>, <span class="dv">25</span>, <span class="dv">20</span>)) <span class="sc">+</span></span>
<span id="cb34-31"><a href="#cb34-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"C) Within Estimate / Fixed Effects"</span>) <span class="sc">+</span></span>
<span id="cb34-32"><a href="#cb34-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb34-33"><a href="#cb34-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.key =</span> <span class="fu">element_blank</span>(), </span>
<span id="cb34-34"><a href="#cb34-34" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb34-35"><a href="#cb34-35" aria-hidden="true" tabindex="-1"></a>        <span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb34-36"><a href="#cb34-36" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.95</span>,<span class="fl">0.05</span>), </span>
<span id="cb34-37"><a href="#cb34-37" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.justification =</span> <span class="fu">c</span>(<span class="st">"right"</span>, <span class="st">"bottom"</span>),</span>
<span id="cb34-38"><a href="#cb34-38" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb34-39"><a href="#cb34-39" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.box.background =</span> <span class="fu">element_rect</span>(<span class="at">colour =</span> <span class="st">"black"</span>))</span>
<span id="cb34-40"><a href="#cb34-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-41"><a href="#cb34-41" aria-hidden="true" tabindex="-1"></a>zp5</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Panel_part1_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Now, we have estimated the effect by only taking observations within each person into account: given the person id, how does age correlate with happiness.</p>
<p>Interpretation: The older a person gets, the lower this personâs happiness (as compared to the same persons younger age).</p>
<p>The principle is very similar to including a (binary) control variable. Itâs just that we include a lot of them to get rid of a lot of (potentially confounded) variance.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="fig/NHK_FE.gif" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Illustration by <span class="citation" data-cites="Huntington-Klein.2021">Huntington-Klein (<a href="#ref-Huntington-Klein.2021" role="doc-biblioref">2021</a>)</span>: Introducing fixed effects</figcaption>
</figure>
</div>
</section>
<section id="comparison" class="level3">
<h3 class="anchored" data-anchor-id="comparison">Comparison</h3>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">screenreg</span>(<span class="fu">list</span>(lm1, lm2, lm3), <span class="at">digits =</span> <span class="dv">3</span>, </span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>          <span class="at">custom.model.names =</span> <span class="fu">c</span>(<span class="st">"POLS"</span>, <span class="st">"Between"</span>, <span class="st">"Within"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
==================================================
                POLS        Between     Within    
--------------------------------------------------
(Intercept)      1.051       0.733       7.748 ***
                (0.570)     (0.356)     (0.446)   
age              0.115 ***              -0.148 ***
                (0.012)                 (0.017)   
m_age                        0.122 ***            
                            (0.008)               
idnamePerson 2                           1.751 ***
                                        (0.194)   
idnamePerson 3                           3.298 ***
                                        (0.310)   
idnamePerson 4                           7.068 ***
                                        (0.439)   
idnamePerson 5                           8.421 ***
                                        (0.573)   
idnamePerson 6                          10.387 ***
                                        (0.710)   
--------------------------------------------------
R^2              0.805       0.922       0.992    
Adj. R^2         0.796       0.919       0.989    
Num. obs.       24          24          24        
==================================================
*** p &lt; 0.001; ** p &lt; 0.01; * p &lt; 0.05</code></pre>
</div>
</div>
<p>POLS: The older an observation (person-year), the higher its happiness.</p>
<p>Between: The older a person, the higher their happiness.</p>
<p>Within: Increasing age within a person goes along with declining happiness within the same person.</p>
<p>The estimates for <span class="math inline">\(\beta_{POLS}\)</span> and <span class="math inline">\(\beta_{BTW}\)</span> are very similar here. We will see below why.</p>
<section id="this-is-how-the-within-person-relationship-looks-with-real-world-data-in-germany-soep" class="level4">
<h4 class="anchored" data-anchor-id="this-is-how-the-within-person-relationship-looks-with-real-world-data-in-germany-soep">This is how the within-person relationship looks with real world data in Germany (SOEP)</h4>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="fig/kratz.PNG" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Working paper by <span class="citation" data-cites="Kratz.2021">Kratz and BrÃ¼derl (<a href="#ref-Kratz.2021" role="doc-biblioref">2021</a>)</span></figcaption>
</figure>
</div>
</section>
</section>
</section>
</section>
<section id="fixed-effects-estimator" class="level1">
<h1>Fixed effects estimator</h1>
<p>The estimator we used above to derive the within coefficient is the fixed effects (FE) estimator. This method is very widely used, especially with survey data.</p>
<p>We use a second example here: assume we observe 4 individuals over 6 periods, and we want to estimate the effect of marriage on the wage for males. This is the so called âmarriage wage premiumâ <span class="citation" data-cites="Ludwig.2018">(<a href="#ref-Ludwig.2018" role="doc-biblioref">Ludwig and BrÃ¼derl 2018</a>)</span>.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r fold-hide code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="do">##################################</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="do">### Example 2: Marriage Income </span><span class="al">###</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="do">##################################</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="do">### Set up six individuals with age and happiness</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">4</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>T <span class="ot">&lt;-</span> <span class="dv">6</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a><span class="co"># id and wave</span></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>df2 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">nrow =</span> N<span class="sc">*</span>T))</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(df2) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"id"</span>, <span class="st">"time"</span>)</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>id <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>N, <span class="at">each =</span> T)</span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>time <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>T, <span class="at">times =</span> N)</span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>idname <span class="ot">&lt;-</span> <span class="fu">factor</span>(df2<span class="sc">$</span>id, <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span>N), <span class="at">labels =</span> <span class="fu">paste</span>(<span class="st">"Person"</span>, <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span>N)))</span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Marriage dummy</span></span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>marriage_ever <span class="ot">&lt;-</span> <span class="dv">0</span> </span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>marriage_ever[(N<span class="sc">*</span>T<span class="sc">/</span><span class="dv">2</span> <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(N<span class="sc">*</span>T)] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>marriage <span class="ot">&lt;-</span> df2<span class="sc">$</span>marriage_ever <span class="sc">*</span> <span class="fu">ifelse</span>(df2<span class="sc">$</span>time <span class="sc">&gt;=</span> <span class="dv">4</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Starting wage</span></span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a>stw <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">2000</span>, <span class="dv">5000</span>)</span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a>stw <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">quantile</span>(stw, <span class="at">probs =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span><span class="sc">/</span>(N<span class="dv">-1</span>))), <span class="dv">0</span>)</span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true" tabindex="-1"></a><span class="co"># wage equation</span></span>
<span id="cb37-28"><a href="#cb37-28" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>wage <span class="ot">&lt;-</span> <span class="fu">unname</span>(<span class="fu">rep</span>(stw, <span class="at">each =</span> T)) <span class="sc">+</span> (df2<span class="sc">$</span>time <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">*</span><span class="dv">50</span> <span class="sc">+</span> <span class="dv">200</span> <span class="sc">*</span> <span class="fu">ifelse</span>(df2<span class="sc">$</span>time <span class="sc">&gt;=</span><span class="dv">4</span>, <span class="dv">1</span>, <span class="dv">0</span>) <span class="sc">+</span> df2<span class="sc">$</span>marriage <span class="sc">*</span> <span class="dv">500</span></span>
<span id="cb37-29"><a href="#cb37-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-30"><a href="#cb37-30" aria-hidden="true" tabindex="-1"></a><span class="co"># counterfactual parallel trend</span></span>
<span id="cb37-31"><a href="#cb37-31" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>pti <span class="ot">&lt;-</span> <span class="fu">unname</span>(<span class="fu">rep</span>(stw, <span class="at">each =</span> T)) <span class="sc">+</span> (df2<span class="sc">$</span>time <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">*</span><span class="dv">50</span> </span>
<span id="cb37-32"><a href="#cb37-32" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>pt <span class="ot">&lt;-</span> <span class="fu">unname</span>(<span class="fu">rep</span>(stw, <span class="at">each =</span> T)) <span class="sc">+</span> (df2<span class="sc">$</span>time <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">*</span><span class="dv">50</span> <span class="sc">+</span> <span class="dv">200</span> <span class="sc">*</span> <span class="fu">ifelse</span>(df2<span class="sc">$</span>time <span class="sc">&gt;=</span><span class="dv">4</span>, <span class="dv">1</span>, <span class="dv">0</span>) </span>
<span id="cb37-33"><a href="#cb37-33" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>pti[df2<span class="sc">$</span>marriage_ever <span class="sc">==</span> <span class="dv">0</span> <span class="sc">|</span> df2<span class="sc">$</span>time <span class="sc">&lt;</span> <span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb37-34"><a href="#cb37-34" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>pt[df2<span class="sc">$</span>marriage_ever <span class="sc">==</span> <span class="dv">0</span> <span class="sc">|</span> df2<span class="sc">$</span>time <span class="sc">&lt;</span> <span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb37-35"><a href="#cb37-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-36"><a href="#cb37-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-37"><a href="#cb37-37" aria-hidden="true" tabindex="-1"></a><span class="do">### Add individual slope / heterogeneous time trends</span></span>
<span id="cb37-38"><a href="#cb37-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-39"><a href="#cb37-39" aria-hidden="true" tabindex="-1"></a><span class="co"># wage equation</span></span>
<span id="cb37-40"><a href="#cb37-40" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>wage2 <span class="ot">&lt;-</span> <span class="fu">unname</span>(<span class="fu">rep</span>(stw, <span class="at">each =</span> T)) <span class="sc">+</span> (df2<span class="sc">$</span>time <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">*</span><span class="dv">50</span>  <span class="sc">+</span> (df2<span class="sc">$</span>time <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">*</span><span class="dv">150</span><span class="sc">*</span>df2<span class="sc">$</span>marriage_ever <span class="sc">+</span> <span class="dv">200</span> <span class="sc">*</span> <span class="fu">ifelse</span>(df2<span class="sc">$</span>time <span class="sc">&gt;=</span><span class="dv">4</span>, <span class="dv">1</span>, <span class="dv">0</span>) <span class="sc">+</span> df2<span class="sc">$</span>marriage <span class="sc">*</span> <span class="dv">500</span></span>
<span id="cb37-41"><a href="#cb37-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-42"><a href="#cb37-42" aria-hidden="true" tabindex="-1"></a><span class="co"># parallel trend</span></span>
<span id="cb37-43"><a href="#cb37-43" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>pt2 <span class="ot">&lt;-</span> <span class="fu">unname</span>(<span class="fu">rep</span>(stw, <span class="at">each =</span> T)) <span class="sc">+</span> (df2<span class="sc">$</span>time <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">*</span><span class="dv">50</span> <span class="sc">+</span> <span class="dv">200</span> <span class="sc">*</span> <span class="fu">ifelse</span>(df2<span class="sc">$</span>time <span class="sc">&gt;=</span><span class="dv">4</span>, <span class="dv">1</span>, <span class="dv">0</span>) <span class="sc">+</span> <span class="dv">2</span><span class="sc">*</span><span class="dv">150</span></span>
<span id="cb37-44"><a href="#cb37-44" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>pt2[df2<span class="sc">$</span>marriage_ever <span class="sc">==</span> <span class="dv">0</span> <span class="sc">|</span> df2<span class="sc">$</span>time <span class="sc">&lt;</span> <span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb37-45"><a href="#cb37-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-46"><a href="#cb37-46" aria-hidden="true" tabindex="-1"></a><span class="co"># actual trend</span></span>
<span id="cb37-47"><a href="#cb37-47" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>pt2_cr <span class="ot">&lt;-</span> <span class="fu">unname</span>(<span class="fu">rep</span>(stw, <span class="at">each =</span> T)) <span class="sc">+</span> (df2<span class="sc">$</span>time <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">*</span><span class="dv">50</span> <span class="sc">+</span> (df2<span class="sc">$</span>time <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">*</span><span class="dv">150</span><span class="sc">*</span>df2<span class="sc">$</span>marriage_ever <span class="sc">+</span> <span class="dv">200</span> <span class="sc">*</span> <span class="fu">ifelse</span>(df2<span class="sc">$</span>time <span class="sc">&gt;=</span><span class="dv">4</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb37-48"><a href="#cb37-48" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>pt2_cr[df2<span class="sc">$</span>marriage_ever <span class="sc">==</span> <span class="dv">0</span> <span class="sc">|</span> df2<span class="sc">$</span>time <span class="sc">&lt;</span> <span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb37-49"><a href="#cb37-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-50"><a href="#cb37-50" aria-hidden="true" tabindex="-1"></a><span class="co"># Marry to factor</span></span>
<span id="cb37-51"><a href="#cb37-51" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>marriage <span class="ot">&lt;-</span> <span class="fu">factor</span>(df2<span class="sc">$</span>marriage, <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"not married"</span>, <span class="st">"married"</span>))</span>
<span id="cb37-52"><a href="#cb37-52" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>marriage_ever <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(df2<span class="sc">$</span>marriage_ever)</span>
<span id="cb37-53"><a href="#cb37-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-54"><a href="#cb37-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-55"><a href="#cb37-55" aria-hidden="true" tabindex="-1"></a><span class="do">### Plot </span></span>
<span id="cb37-56"><a href="#cb37-56" aria-hidden="true" tabindex="-1"></a>zp1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df2, <span class="fu">aes</span>(time, wage)) <span class="sc">+</span></span>
<span id="cb37-57"><a href="#cb37-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> wage, <span class="at">group =</span> id), <span class="at">lty =</span> <span class="st">"solid"</span>, <span class="at">colour =</span> <span class="st">"black"</span>, <span class="at">lwd =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb37-58"><a href="#cb37-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>( <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> wage, <span class="at">shape =</span> marriage, <span class="at">fill =</span> marriage), </span>
<span id="cb37-59"><a href="#cb37-59" aria-hidden="true" tabindex="-1"></a>             <span class="at">size =</span> <span class="dv">4</span>, <span class="at">stroke =</span> <span class="fl">1.5</span>, <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb37-60"><a href="#cb37-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb37-61"><a href="#cb37-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_shape_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="dv">21</span>, <span class="dv">24</span>)) <span class="sc">+</span></span>
<span id="cb37-62"><a href="#cb37-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#85144b"</span>, <span class="st">"#0074D9"</span>)) <span class="sc">+</span></span>
<span id="cb37-63"><a href="#cb37-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#85144b"</span>, <span class="st">"#0074D9"</span>)) <span class="sc">+</span></span>
<span id="cb37-64"><a href="#cb37-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.key =</span> <span class="fu">element_blank</span>(), <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb37-65"><a href="#cb37-65" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.05</span>,<span class="fl">0.95</span>), <span class="at">legend.justification =</span> <span class="fu">c</span>(<span class="st">"left"</span>, <span class="st">"top"</span>),</span>
<span id="cb37-66"><a href="#cb37-66" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb37-67"><a href="#cb37-67" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.box.background =</span> <span class="fu">element_rect</span>(<span class="at">colour =</span> <span class="st">"black"</span>),</span>
<span id="cb37-68"><a href="#cb37-68" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.spacing.y =</span> <span class="fu">unit</span>(<span class="sc">-</span><span class="fl">0.1</span>, <span class="st">"cm"</span>))</span>
<span id="cb37-69"><a href="#cb37-69" aria-hidden="true" tabindex="-1"></a>zp1 </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Panel_part1_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<section id="pooled-ols-again" class="level3">
<h3 class="anchored" data-anchor-id="pooled-ols-again">Pooled OLS (again)</h3>
<p>Letâs start with the conventional Pooled OLS (POLS) estimator on panel data</p>
<p><span class="math display">\[
y_{it} = \alpha + \beta x_{it} + \upsilon_{it}
\]</span></p>
<p>The main problem: this model relies on very strong assumptions for consistency, with the most important one being:</p>
<ul>
<li><span class="math inline">\(\mathrm{E}(\upsilon_{it} | x_{it}) = 0\)</span>, or <span class="math inline">\(Cov(x_{it}, \upsilon_{it}) = 0\)</span></li>
</ul>
<p>The error (including omitted variables) must not be correlated with <span class="math inline">\(x_{it}\)</span>. In observational studies, we cannot observe a lot of things and characteristics (unobservables) such as personal views, psychological traits, or empathy. However, everything that influences <span class="math inline">\(y_{it}\)</span> but is unobserved ends up in <span class="math inline">\(\upsilon_{it}\)</span>. If anything correlates with <span class="math inline">\(x_{it}\)</span>, it is endogenous, and <span class="math inline">\(\hat{\beta}_x\)</span> will be biased.</p>
<p>Take our marriage example.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">lm</span>(wage <span class="sc">~</span> marriage, <span class="at">data =</span> df2))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = wage ~ marriage, data = df2)

Residuals:
    Min      1Q  Median      3Q     Max 
-1333.3  -633.3  -108.3   579.2  1766.7 

Coefficients:
                Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)       3333.3      223.2  14.934 5.37e-13 ***
marriagemarried   2066.7      446.4   4.629  0.00013 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 947 on 22 degrees of freedom
Multiple R-squared:  0.4935,    Adjusted R-squared:  0.4704 
F-statistic: 21.43 on 1 and 22 DF,  p-value: 0.0001297</code></pre>
</div>
</div>
<p>We would estimate a marriage premium of more than 2,000. The true value is 500. The reason: those who marry at some point already had higher wages before they married. Maybe friendly or emphatic people are more likely to mary and also do better in their job.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r fold-hide code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="do">### Plot </span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>zp2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df2, <span class="fu">aes</span>(time, wage)) <span class="sc">+</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> wage, <span class="at">group =</span> id), <span class="at">lty =</span> <span class="st">"solid"</span>, <span class="at">colour =</span> <span class="st">"black"</span>, <span class="at">lwd =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>( <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> wage, <span class="at">shape =</span> marriage, <span class="at">fill =</span> marriage), </span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">size =</span> <span class="dv">4</span>, <span class="at">stroke =</span> <span class="fl">1.5</span>, <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_mark_hull</span>(<span class="at">expand =</span> <span class="fl">0.01</span>, <span class="fu">aes</span>(<span class="at">fill =</span> marriage), <span class="at">show.legend =</span> <span class="cn">FALSE</span>, <span class="at">colour =</span> <span class="cn">NA</span>) <span class="sc">+</span> </span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_shape_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="dv">21</span>, <span class="dv">24</span>)) <span class="sc">+</span></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#85144b"</span>, <span class="st">"#0074D9"</span>)) <span class="sc">+</span></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#85144b"</span>, <span class="st">"#0074D9"</span>)) <span class="sc">+</span></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.key =</span> <span class="fu">element_blank</span>(), <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.05</span>,<span class="fl">0.95</span>), <span class="at">legend.justification =</span> <span class="fu">c</span>(<span class="st">"left"</span>, <span class="st">"top"</span>),</span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.box.background =</span> <span class="fu">element_rect</span>(<span class="at">colour =</span> <span class="st">"black"</span>),</span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.spacing.y =</span> <span class="fu">unit</span>(<span class="sc">-</span><span class="fl">0.1</span>, <span class="st">"cm"</span>))</span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>zp2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Panel_part1_files/figure-html/unnamed-chunk-25-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="one-way-fixed-effects" class="level3">
<h3 class="anchored" data-anchor-id="one-way-fixed-effects">One-way fixed effects</h3>
<p>To relax the strong assumption, we can decompose the error into two parts (between and within) if we use panel data: <span class="math inline">\(\upsilon_{it} = \alpha_i + \epsilon_{it}\)</span>, where <span class="math inline">\(\alpha_i\)</span> is the time-constant (person-specific or between) part of the error, and <span class="math inline">\(\epsilon_{it}\)</span> is the time-varying (idiosyncratic or within) part of the error.</p>
<p>We can thus split up our main assumption for consistency:</p>
<ul>
<li><p><span class="math inline">\(\mathrm{E}(\alpha_{i} | x_{it}) = 0\)</span>: No time-constant unobserved heterogeneity</p></li>
<li><p><span class="math inline">\(\mathrm{E}(\epsilon_{it} | x_{it}) = 0\)</span>: No time-varying unobserved heterogeneity</p></li>
</ul>
<p>And write the error component model:</p>
<p><span class="math display">\[
y_{it} = \beta x_{it} + \alpha_i + \epsilon_{it}
\]</span> As we have seen above, we can include person-dummies to estimate the model above. However, this becomes computationally intense if we have thousands of individuals</p>
<p>Thus, we usually use a transformation approach, where we first subtract the between variance by using use the person-specific means:</p>
<p><span class="math display">\[
\bar{y_{i}} = \beta \bar{x_{i}} + \alpha_i + \bar{\epsilon_{i}}
\]</span></p>
<p>We then subtract this between part from the pooled data:</p>
<p><span class="math display">\[
y_{it} - \bar{y_{i}} = \beta (x_{it}-\bar{x_{i}}) + (\alpha_i - \alpha_i) + (\epsilon_{it}-\bar{\epsilon_{i}})\\
\tilde{y}_{it} = \beta \tilde{x}_{it} + \tilde{\epsilon}_{it}.
\]</span></p>
<p>This is called the within transformation. For each group (individual, district, firm), we subtract the group-specific mean from the original variable. This eliminates all between-group variance, including the person-specific part of the error term (<span class="math inline">\(\alpha_i\)</span>).</p>
<p>The <span class="math inline">\(\hat{\beta}_{FE}\)</span> is then just the OLS estimator on the transformed data:</p>
<p><span class="math display">\[
\hat{\boldsymbol{\mathbf{\beta}}} = (\boldsymbol{\mathbf{X}}^\intercal\boldsymbol{\mathbf{X}})^{-1}\boldsymbol{\mathbf{X}}^\intercal \boldsymbol{\mathbf{y}}
\]</span></p>
<p><strong>This also means that every time-constant variable is wiped out - we cannot estimate their effects in FE models!</strong> :::</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The FE estimator can only be applied to observations which are at least observed 2 times (<span class="math inline">\(T \geq 2\)</span>)!__</p>
</div>
</div>
<p>The main assumption for consistency now is</p>
<ul>
<li><span class="math inline">\(\mathrm{E}(\epsilon_{it} | x_{it}, \alpha_i) = 0\)</span></li>
</ul>
<p>Idiosyncratic time-variation in <span class="math inline">\(\epsilon_it\)</span> must be uncorrelated with variation in <span class="math inline">\(x_it\)</span> across all time periods. However, <span class="math inline">\(\mathrm{E}(\alpha_{i} | x_{i})\)</span> can be any function of <span class="math inline">\(x_i\)</span>.</p>
<ul>
<li><p>Time-constant unobserved heterogeneity is allowed</p></li>
<li><p>Only time-varying unobserved heterogeneity biases the estimator</p></li>
</ul>
<p>We can use the plm package with options <code>effect = "individual"</code> and <code>model = "within"</code> to estimate one-ways FE models:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>fe2 <span class="ot">&lt;-</span> <span class="fu">plm</span>(wage <span class="sc">~</span> marriage, <span class="at">data =</span> df2,</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>           <span class="at">index =</span> <span class="fu">c</span>(<span class="st">"id"</span>, <span class="st">"time"</span>),</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">effect =</span> <span class="st">"individual"</span>, <span class="at">model =</span> <span class="st">"within"</span>)</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fe2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Oneway (individual) effect Within Model

Call:
plm(formula = wage ~ marriage, data = df2, effect = "individual", 
    model = "within", index = c("id", "time"))

Balanced Panel: n = 4, T = 6, N = 24

Residuals:
   Min. 1st Qu.  Median 3rd Qu.    Max. 
-225.00  -68.75    0.00   68.75  225.00 

Coefficients:
                Estimate Std. Error t-value  Pr(&gt;|t|)    
marriagemarried  850.000     84.552  10.053 4.834e-09 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Total Sum of Squares:    2575000
Residual Sum of Squares: 407500
R-Squared:      0.84175
Adj. R-Squared: 0.80843
F-statistic: 101.061 on 1 and 19 DF, p-value: 4.8337e-09</code></pre>
</div>
</div>
<p>Hm, 850 is closer to 500, but still quite far off! Letâs see why.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r fold-hide code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="do">### Plot </span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>zp3 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df2, <span class="fu">aes</span>(time, wage)) <span class="sc">+</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> wage, <span class="at">group =</span> id, <span class="at">alpha =</span> marriage_ever), <span class="at">lty =</span> <span class="st">"solid"</span>, <span class="at">colour =</span> <span class="st">"black"</span>, <span class="at">lwd =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>( <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> wage, <span class="at">shape =</span> marriage, <span class="at">fill =</span> marriage, <span class="at">alpha =</span> marriage_ever), </span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>              <span class="at">size =</span> <span class="dv">4</span>, <span class="at">stroke =</span> <span class="fl">1.5</span>, <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> pti, <span class="at">group =</span> id, <span class="at">linetype =</span> <span class="st">"dashed"</span>), <span class="at">colour =</span> <span class="st">"blue"</span>, <span class="at">lwd =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_linetype_identity</span>(<span class="at">labels =</span> <span class="st">"Counterfactual"</span>, <span class="at">guide =</span> <span class="st">"legend"</span>) <span class="sc">+</span></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_alpha_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="dv">1</span>), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># geom_mark_hull(data = df2[df2$marriage_ever == 1, ], aes(x = time, y = wage, fill = marriage),</span></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>  <span class="co">#                expand = 0.01, show.legend = FALSE, colour = NA) + </span></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_shape_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="dv">21</span>, <span class="dv">24</span>)) <span class="sc">+</span></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#85144b"</span>, <span class="st">"#0074D9"</span>)) <span class="sc">+</span></span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#85144b"</span>, <span class="st">"#0074D9"</span>)) <span class="sc">+</span></span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.key =</span> <span class="fu">element_blank</span>(), <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.05</span>,<span class="fl">0.95</span>), <span class="at">legend.justification =</span> <span class="fu">c</span>(<span class="st">"left"</span>, <span class="st">"top"</span>),</span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.box.background =</span> <span class="fu">element_rect</span>(<span class="at">colour =</span> <span class="st">"black"</span>),</span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.spacing.y =</span> <span class="fu">unit</span>(<span class="sc">-</span><span class="fl">0.1</span>, <span class="st">"cm"</span>))</span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>zp3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Panel_part1_files/figure-html/unnamed-chunk-27-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>A one-ways FE would effectively drop all those observations without within-variance on the independent variables. In our case, we would disregard those who never marry.</p>
</div>
</div>
<p>However, they also experienced an increase in wages when the other two married.</p>
</section>
<section id="two-ways-fe" class="level3">
<h3 class="anchored" data-anchor-id="two-ways-fe">Two-ways FE</h3>
<p>To circumvent the problem above, we want to add the never-married as a control group in our estimator.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>In general, it is always a good idea to control for temporal shocks!</strong></p>
</div>
</div>
<p>We can do so by including person fixed effects and time fixed effects:</p>
<p><span class="math display">\[
y_{it} = \beta x_{it} + \alpha_i + \zeta_t + \epsilon_{it},
\]</span></p>
<p>where <span class="math inline">\(\zeta_t\)</span> are time fixed effects (analogous to <span class="math inline">\(\alpha_i\)</span>). In terms of demeaning this would look like:</p>
<p><span class="math display">\[
(y_{it} - \bar{y}_i  - \bar{y}_t + \bar{y}) = \beta (x_{it} - \bar{x}_i - \bar{x}_t + \bar{x}) + (\epsilon_{it} - \bar{\epsilon}_i  - \bar{\epsilon}_t + \bar{\epsilon}).
\]</span></p>
<p>This removes common time shocks independent of treatment, and takes back in individuals without variation in <span class="math inline">\(x\)</span>. We basically add a `control-groupâ to the estimation.</p>
<p>We can just change the <code>effect</code> option in <code>plm</code> to âtwowaysâ to achieve this:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>fe3 <span class="ot">&lt;-</span> <span class="fu">plm</span>(wage <span class="sc">~</span> marriage, <span class="at">data =</span> df2,</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>           <span class="at">index =</span> <span class="fu">c</span>(<span class="st">"id"</span>, <span class="st">"time"</span>),</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">effect =</span> <span class="st">"twoways"</span>, <span class="at">model =</span> <span class="st">"within"</span>)</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fe3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Twoways effects Within Model

Call:
plm(formula = wage ~ marriage, data = df2, effect = "twoways", 
    model = "within", index = c("id", "time"))

Balanced Panel: n = 4, T = 6, N = 24

Residuals:
       Min.     1st Qu.      Median     3rd Qu.        Max. 
-1.1603e-14 -1.1603e-14  1.1603e-14  1.1603e-14  2.6687e-13 

Coefficients:
                  Estimate Std. Error   t-value  Pr(&gt;|t|)    
marriagemarried 5.0000e+02 5.9489e-14 8.405e+15 &lt; 2.2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Total Sum of Squares:    375000
Residual Sum of Squares: 7.4317e-26
R-Squared:      1
Adj. R-Squared: 1
F-statistic: 7.06433e+31 on 1 and 14 DF, p-value: &lt; 2.22e-16</code></pre>
</div>
</div>
<p>And here we go with our 500 marriage wage premium. What we do graphically is</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r fold-hide code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="do">### Plot </span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>zp4 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df2, <span class="fu">aes</span>(time, wage)) <span class="sc">+</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> wage, <span class="at">group =</span> id), <span class="at">lty =</span> <span class="st">"solid"</span>, <span class="at">colour =</span> <span class="st">"black"</span>, <span class="at">lwd =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>( <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> wage, <span class="at">shape =</span> marriage, <span class="at">fill =</span> marriage), </span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>              <span class="at">size =</span> <span class="dv">4</span>, <span class="at">stroke =</span> <span class="fl">1.5</span>, <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> pt, <span class="at">group =</span> id, <span class="at">linetype =</span> <span class="st">"dashed"</span>), <span class="at">colour =</span> <span class="st">"blue"</span>, <span class="at">lwd =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_linetype_identity</span>(<span class="at">labels =</span> <span class="st">"Counterfactual"</span>, <span class="at">guide =</span> <span class="st">"legend"</span>) <span class="sc">+</span></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_shape_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="dv">21</span>, <span class="dv">24</span>)) <span class="sc">+</span></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#85144b"</span>, <span class="st">"#0074D9"</span>)) <span class="sc">+</span></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#85144b"</span>, <span class="st">"#0074D9"</span>)) <span class="sc">+</span></span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.key =</span> <span class="fu">element_blank</span>(), <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.05</span>,<span class="fl">0.95</span>), <span class="at">legend.justification =</span> <span class="fu">c</span>(<span class="st">"left"</span>, <span class="st">"top"</span>),</span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.box.background =</span> <span class="fu">element_rect</span>(<span class="at">colour =</span> <span class="st">"black"</span>),</span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.spacing.y =</span> <span class="fu">unit</span>(<span class="sc">-</span><span class="fl">0.1</span>, <span class="st">"cm"</span>))</span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a>zp4</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Panel_part1_files/figure-html/unnamed-chunk-29-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="still-a-very-critical-assumption" class="level3">
<h3 class="anchored" data-anchor-id="still-a-very-critical-assumption">Still a very critical assumption</h3>
<p>In the example above, the twoways FE model works very well. However, adding the control group back in comes with another (relatively strong) assumption:</p>
<p><strong>Parallel trends between âtreatmentâ and âcontrolâ units</strong></p>
<p>Comparing the 3 waves before the treatment above, this assumption here holds. Both - those who marry and those who never marry - have the same time trend in wages before the âtreatedâ marry.</p>
<p>However, consider the following example. We still have a marriage premium of 500.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r fold-hide code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>zp5 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df2, <span class="fu">aes</span>(time, wage2)) <span class="sc">+</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> wage2, <span class="at">group =</span> id), <span class="at">lty =</span> <span class="st">"solid"</span>, <span class="at">colour =</span> <span class="st">"black"</span>, <span class="at">lwd =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>( <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> wage2, <span class="at">shape =</span> marriage, <span class="at">fill =</span> marriage), </span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>              <span class="at">size =</span> <span class="dv">4</span>, <span class="at">stroke =</span> <span class="fl">1.5</span>, <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># geom_line(aes(x = time, y = pt2, group = id, linetype = "dashed"), colour = "blue", lwd = 1) +</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># geom_line(aes(x = time, y = pt2_cr, group = id, linetype = "dashed"), colour = "grey", lwd = 1, show.legend = FALSE, alpha = 0.7) +</span></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_linetype_identity</span>(<span class="at">labels =</span> <span class="st">"Counterfactual"</span>, <span class="at">guide =</span> <span class="st">"legend"</span>) <span class="sc">+</span></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># scale_alpha_manual(values = c(0.3, 1), guide = "none") +</span></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ylim(3.3, 9.2) + expand_limits(y = c(0, 0)) + </span></span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_shape_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="dv">21</span>, <span class="dv">24</span>)) <span class="sc">+</span></span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#85144b"</span>, <span class="st">"#0074D9"</span>)) <span class="sc">+</span></span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#85144b"</span>, <span class="st">"#0074D9"</span>)) <span class="sc">+</span></span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"wage"</span>) <span class="sc">+</span></span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.key =</span> <span class="fu">element_blank</span>(), <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.05</span>,<span class="fl">0.95</span>), <span class="at">legend.justification =</span> <span class="fu">c</span>(<span class="st">"left"</span>, <span class="st">"top"</span>),</span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.box.background =</span> <span class="fu">element_rect</span>(<span class="at">colour =</span> <span class="st">"black"</span>),</span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.spacing.y =</span> <span class="fu">unit</span>(<span class="sc">-</span><span class="fl">0.1</span>, <span class="st">"cm"</span>))</span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a>zp5</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Panel_part1_files/figure-html/unnamed-chunk-30-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>A two-ways FE will now give us:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>fe3 <span class="ot">&lt;-</span> <span class="fu">plm</span>(wage2 <span class="sc">~</span> marriage, <span class="at">data =</span> df2,</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>           <span class="at">index =</span> <span class="fu">c</span>(<span class="st">"id"</span>, <span class="st">"time"</span>),</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">effect =</span> <span class="st">"twoways"</span>, <span class="at">model =</span> <span class="st">"within"</span>)</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fe3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Twoways effects Within Model

Call:
plm(formula = wage2 ~ marriage, data = df2, effect = "twoways", 
    model = "within", index = c("id", "time"))

Balanced Panel: n = 4, T = 6, N = 24

Residuals:
   Min. 1st Qu.  Median 3rd Qu.    Max. 
    -75     -75       0      75      75 

Coefficients:
                Estimate Std. Error t-value  Pr(&gt;|t|)    
marriagemarried  950.000     65.465  14.511 7.881e-10 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Total Sum of Squares:    1443800
Residual Sum of Squares: 90000
R-Squared:      0.93766
Adj. R-Squared: 0.89759
F-statistic: 210.583 on 1 and 14 DF, p-value: 7.8808e-10</code></pre>
</div>
</div>
<p>The problem: the model does not take into account that the treatment group already had a steeper wage trajectory than the control group. The parallel trends assumption fails.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r fold-hide code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>zp5 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df2, <span class="fu">aes</span>(time, wage2)) <span class="sc">+</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> wage2, <span class="at">group =</span> id), <span class="at">lty =</span> <span class="st">"solid"</span>, <span class="at">colour =</span> <span class="st">"black"</span>, <span class="at">lwd =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>( <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> wage2, <span class="at">shape =</span> marriage, <span class="at">fill =</span> marriage), </span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>              <span class="at">size =</span> <span class="dv">4</span>, <span class="at">stroke =</span> <span class="fl">1.5</span>, <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> pt2, <span class="at">group =</span> id, <span class="at">linetype =</span> <span class="st">"dashed"</span>), <span class="at">colour =</span> <span class="st">"blue"</span>, <span class="at">lwd =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> pt2_cr, <span class="at">group =</span> id, <span class="at">linetype =</span> <span class="st">"dashed"</span>), <span class="at">colour =</span> <span class="st">"grey"</span>, <span class="at">lwd =</span> <span class="dv">1</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_linetype_identity</span>(<span class="at">labels =</span> <span class="st">"Counterfactual"</span>, <span class="at">guide =</span> <span class="st">"legend"</span>) <span class="sc">+</span></span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># scale_alpha_manual(values = c(0.3, 1), guide = "none") +</span></span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ylim(3.3, 9.2) + expand_limits(y = c(0, 0)) + </span></span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_shape_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="dv">21</span>, <span class="dv">24</span>)) <span class="sc">+</span></span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#85144b"</span>, <span class="st">"#0074D9"</span>)) <span class="sc">+</span></span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#85144b"</span>, <span class="st">"#0074D9"</span>)) <span class="sc">+</span></span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"wage"</span>) <span class="sc">+</span></span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.key =</span> <span class="fu">element_blank</span>(), <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.05</span>,<span class="fl">0.95</span>), <span class="at">legend.justification =</span> <span class="fu">c</span>(<span class="st">"left"</span>, <span class="st">"top"</span>),</span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.box.background =</span> <span class="fu">element_rect</span>(<span class="at">colour =</span> <span class="st">"black"</span>),</span>
<span id="cb50-19"><a href="#cb50-19" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.spacing.y =</span> <span class="fu">unit</span>(<span class="sc">-</span><span class="fl">0.1</span>, <span class="st">"cm"</span>))</span>
<span id="cb50-20"><a href="#cb50-20" aria-hidden="true" tabindex="-1"></a>zp5</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Panel_part1_files/figure-html/unnamed-chunk-32-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>A possible extension to tackle this problem are fixed effects individual slopes (FEIS) estimators. See the second part.</p>
</section>
<section id="difference-in-differences" class="level3">
<h3 class="anchored" data-anchor-id="difference-in-differences">Difference in Differences</h3>
<p>The difference-in-differences (DD) design is a very basic and popular design to identify causal treatment effects in a panel data setting.</p>
<p>The most basic setting, is a <span class="math inline">\(2\times 2\)</span> DD estimator. It consists of a setting where we have 2 groups: a treatment group (<span class="math inline">\(T\)</span>) and control group (<span class="math inline">\(C\)</span>). Each group has been observed at 2 time points: before treatment (<span class="math inline">\(pre\)</span>) and after treatment (<span class="math inline">\(post\)</span>).</p>
<p>In this setting we can calculate the change in the treatment group: <span class="math display">\[
\mathrm{E}(\Delta y_{T}) = \mathrm{E}(y_{T}^{post}) - \mathrm{E}(y_{T}^{pre}),
\]</span></p>
<p>and likewise in the control group: <span class="math display">\[
\mathrm{E}(\Delta y_{C}) = \mathrm{E}(y_{C}^{post}) - \mathrm{E}(y_{C}^{pre}).
\]</span> The simple DD estimator is then the difference between the differences in the treatment group and the differences in the control group:</p>
<p><span class="math display">\[
\hat{\delta}_{DD} = \mathrm{E}(\Delta y_{T}) - \mathrm{E}(\Delta y_{C}) = (\mathrm{E}(y_{T}^{post}) - \mathrm{E}(y_{T}^{pre})) - (\mathrm{E}(y_{C}^{post}) - \mathrm{E}(y_{C}^{pre})).
\]</span></p>
<p>In our marriage example:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>marry_post <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>marry_post[df2<span class="sc">$</span>time <span class="sc">&gt;=</span> <span class="dv">4</span>] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>y_t_post <span class="ot">&lt;-</span> <span class="fu">mean</span>(df2<span class="sc">$</span>wage[df2<span class="sc">$</span>marry_post <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> df2<span class="sc">$</span>marriage_ever <span class="sc">==</span> <span class="dv">1</span>])</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>y_t_pre <span class="ot">&lt;-</span> <span class="fu">mean</span>(df2<span class="sc">$</span>wage[df2<span class="sc">$</span>marry_post <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> df2<span class="sc">$</span>marriage_ever <span class="sc">==</span> <span class="dv">1</span>])</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>y_c_post <span class="ot">&lt;-</span> <span class="fu">mean</span>(df2<span class="sc">$</span>wage[df2<span class="sc">$</span>marry_post <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> df2<span class="sc">$</span>marriage_ever <span class="sc">==</span> <span class="dv">0</span>])</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>y_c_pre <span class="ot">&lt;-</span> <span class="fu">mean</span>(df2<span class="sc">$</span>wage[df2<span class="sc">$</span>marry_post <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> df2<span class="sc">$</span>marriage_ever <span class="sc">==</span> <span class="dv">0</span>])</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Diff in Diff</span></span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>(y_t_post <span class="sc">-</span> y_t_pre) <span class="sc">-</span> (y_c_post <span class="sc">-</span> y_c_pre)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 500</code></pre>
</div>
</div>
<p>In a setting where <span class="math inline">\(T=2\)</span> or in a setting where every observation is treated at the same time, the DD equals the two-ways FE. In general, DD and two-ways DD are often seen as equivalents. However, the situation becomes more complicated when treatment timing varies <span class="citation" data-cites="Goodman-Bacon.2021">(<a href="#ref-Goodman-Bacon.2021" role="doc-biblioref">Goodman-Bacon 2021</a>)</span>.</p>
<p>We can receive the same estimator in a simple regression. Lets assume <span class="math inline">\(D \in {0, 1}\)</span> is a binary indicator of the treatment group and <span class="math inline">\(Post \in {0, 1}\)</span> a binary indicator of pre- or post-treatment period. Then we can get the DD estimator with an interaction between those two two variables:</p>
<p><span class="math display">\[
y_{it} = \alpha + \gamma D_{i} + \lambda Post_{t} + \delta_{DD} (D_{i} \times Post_{t}) + \upsilon_{it}.
\]</span></p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="fig/dd-diagram-1.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Diff-in-Diff design, adopted from <span class="citation" data-cites="Cunningham.2021">Cunningham (<a href="#ref-Cunningham.2021" role="doc-biblioref">2021</a>)</span></figcaption>
</figure>
</div>
<p>The coefficients correspond to:</p>
<ul>
<li><p><span class="math inline">\(\alpha\)</span>: average outcome of control group in pre-treatment period</p></li>
<li><p><span class="math inline">\(\gamma\)</span>: average difference between treatment and control group in pre-treatment period</p></li>
<li><p><span class="math inline">\(\lambda\)</span>: average difference between post- pre-treatment period in control group</p></li>
<li><p><span class="math inline">\(\delta_{DD}\)</span>: difference between treatment and control group in difference between post- pre-treatment period</p></li>
</ul>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">lm</span>(wage <span class="sc">~</span> marriage_ever<span class="sc">*</span>marry_post, <span class="at">data =</span> df2))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = wage ~ marriage_ever * marry_post, data = df2)

Residuals:
   Min     1Q Median     3Q    Max 
  -550   -500      0    500    550 

Coefficients:
                          Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)                 2550.0      224.4  11.366 3.53e-10 ***
marriage_ever1              2000.0      317.3   6.304 3.74e-06 ***
marry_post                   350.0      317.3   1.103    0.283    
marriage_ever1:marry_post    500.0      448.7   1.114    0.278    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 549.5 on 20 degrees of freedom
Multiple R-squared:  0.8449,    Adjusted R-squared:  0.8217 
F-statistic: 36.32 on 3 and 20 DF,  p-value: 2.757e-08</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Selecting the estimation sample
</div>
</div>
<div class="callout-body-container callout-body">
<p>When estimating FE or Diff-in-Diff estimators, selecting the estimation sample may play an important role.</p>
<p><span class="citation" data-cites="Bruderl.2015">BrÃ¼derl and Ludwig (<a href="#ref-Bruderl.2015" role="doc-biblioref">2015</a>)</span> recommend â<em>one should restrict the estimation sample to those persons who can potentially experience the treatment during the observation window</em>â. Usually this means that we start with the not-yet-treated and omit the already-treated (as in the Diff-in-Diff example above).</p>
<p>The rational behind this: the already-treated may experience ongoing dynamic treatment effects. We thus do not want them as a control group. This discussion is similar to the discussion about dynamic treatment effects (<a href="./Panel_part2.html#dynamic-diff-in-diff">Next Chapter</a>). Differences are often likely to be small, but it is advisable to do at least do some robustness checks!</p>
</div>
</div>
</section>
</section>
<section id="random-effects-estimator" class="level1">
<h1>Random effects estimator</h1>
<p>There is another popular estimation strategy for panel data: the random effects (RE) estimator. The RE estimator is not only popular for panel data but also very commonly used for hierarchical data, where it is usually called a âmultilevel modelâ. More precisely, the RE estimator in the panel context equals a âmultilevel model with random interceptsâ.</p>
<p>The RE estimator has two main âadvantagesâ over the FE estimator:</p>
<ol type="1">
<li><p>It is more efficient if <span class="math inline">\(\mathrm{E}(\alpha_{i} | x_{it}) = 0\)</span>: it has lower standard errors</p></li>
<li><p>It allows to estimate the effects of time-constant variables</p></li>
</ol>
<p>However, it obscures the main advantage of panel data: the relaxation of assumptions for consistency of estimators. The RE estimator needs the same assumptions as POLS for consistency:</p>
<ul>
<li><p><span class="math inline">\(\mathrm{E}(\alpha_{i} | x_{it}) = 0\)</span>: No time-constant unobserved heterogeneity</p></li>
<li><p><span class="math inline">\(\mathrm{E}(\epsilon_{it} | x_{it}) = 0\)</span>: No time-varying unobserved heterogeneity</p></li>
</ul>
<p>The RE estimator can be written as:</p>
<p><span class="math display">\[
y_{it} = \alpha + \beta x_{it} + \alpha_i + \vartheta_{it}.
\]</span></p>
<p>Instead of assuming <span class="math inline">\(\alpha_i\)</span> are fixed effects, we treat them as i.i.d random effects, usually assuming they are normally distributed</p>
<p>We can also write the RE as a quasi-demeaned estimator:</p>
<p><span class="math display">\[
(y_{it} - \lambda\bar{y}_i) = \beta (x_{it} - \lambda\bar{x}_i) + (\epsilon_{it} - \lambda\bar{\epsilon}_i)  
\]</span> where <span class="math inline">\(\hat{\lambda} = 1 - \sqrt{\frac{\sigma^2_\epsilon}{\sigma^2_\epsilon + T\sigma^2_\alpha}}\)</span>, with <span class="math inline">\(\sigma^2_\epsilon\)</span> denoting the residual variance, and <span class="math inline">\(\sigma^2_\alpha\)</span> denoting the variance of the individual effects <span class="math inline">\(\alpha_i\)</span>.</p>
<p>The RE (as POLS) is thus a weighted average of between and within estimator. The weights are determined by the residual variance in FE as share of total residual variance:</p>
<p><span class="math display">\[
\beta_{RE} = \omega_{GLS} \beta_{FE} + (1-\omega_{GLS}) \beta_{BE},\\
\omega_{GLS} = \frac{\sigma^2_{\tilde{x}}}{\sigma^2_{\tilde{x}} + \phi^2 (\sigma^2_x-\sigma^2_{\tilde{x}})},\\
\phi = \sqrt{\frac{\hat{\sigma}^2_{FE}}{\hat{\sigma}^2_{BE}}},
\]</span></p>
<p>It thus follows that:</p>
<ul>
<li><p><span class="math inline">\(T\)</span> large, <span class="math inline">\(\sigma^2_\alpha\)</span> large, then RE <span class="math inline">\(\rightarrow\)</span> FE</p></li>
<li><p><span class="math inline">\(\sigma^2_\alpha\)</span> small, then RE <span class="math inline">\(\rightarrow\)</span> POLS</p></li>
</ul>
<p>The RE uses all the available information - between and within variance - and weights the two components by its âpredictive powerâ. This makes it the most efficient estimator.</p>
<p>We could, by the way, do the same for the POLS estimator. Here, however, the weights are just determined by the overall and the within variance in the independent variable: <span class="math display">\[
\beta_{POLS} = \omega_{OLS} \beta_{FE} + (1-\omega_{OLS}) \beta_{BE},\\
\omega_{OLS} = \sigma^2_{\tilde{x}} / \sigma^2_x.
\]</span></p>
<p>Letâs estimate the RE for the happiness - age example, again using the <code>plm</code> package.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>re1 <span class="ot">&lt;-</span> <span class="fu">plm</span>(happiness <span class="sc">~</span> age, <span class="at">data =</span> df,</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>           <span class="at">index =</span> <span class="fu">c</span>(<span class="st">"id"</span>, <span class="st">"time"</span>),</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">effect =</span> <span class="st">"individual"</span>, <span class="at">model =</span> <span class="st">"random"</span>)</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(re1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Oneway (individual) effect Random Effect Model 
   (Swamy-Arora's transformation)

Call:
plm(formula = happiness ~ age, data = df, effect = "individual", 
    model = "random", index = c("id", "time"))

Balanced Panel: n = 6, T = 4, N = 24

Effects:
                  var std.dev share
idiosyncratic 0.03641 0.19081 0.096
individual    0.34396 0.58648 0.904
theta: 0.8394

Residuals:
     Min.   1st Qu.    Median   3rd Qu.      Max. 
-1.054061 -0.353296  0.013426  0.316500  0.898703 

Coefficients:
             Estimate Std. Error z-value  Pr(&gt;|z|)    
(Intercept)  6.933947   1.534054  4.5200 6.183e-06 ***
age         -0.015621   0.031277 -0.4994    0.6175    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Total Sum of Squares:    5.1257
Residual Sum of Squares: 5.0683
R-Squared:      0.011211
Adj. R-Squared: -0.033734
Chisq: 0.249442 on 1 DF, p-value: 0.61747</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Save for later</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>df_orig <span class="ot">&lt;-</span> df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>This indicates that there is barely any relation between age and happiness. This is because the within and the between estimates cancel out each other.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r fold-hide code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(viridis)</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">6</span></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>T <span class="ot">&lt;-</span> <span class="dv">4</span></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a><span class="do">### Models</span></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Total line for plot</span></span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>lm1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(happiness <span class="sc">~</span> age, <span class="at">data =</span> df)</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>lm2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(happiness <span class="sc">~</span> age <span class="sc">+</span> cohort, <span class="at">data =</span> df)</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>lm3 <span class="ot">&lt;-</span> <span class="fu">lm</span>(happiness <span class="sc">~</span> age <span class="sc">+</span> idname, <span class="at">data =</span> df)</span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>lm4 <span class="ot">&lt;-</span> <span class="fu">lm</span>(m_happiness <span class="sc">~</span> m_age, <span class="at">data =</span> df)</span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>re <span class="ot">&lt;-</span> <span class="fu">plm</span>(happiness <span class="sc">~</span> age, df, <span class="at">model =</span> <span class="st">"random"</span>, <span class="at">effect =</span> <span class="st">"individual"</span>)</span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a><span class="do">### Compare POLS, BE, FE, and RE</span></span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a>estimates <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">ncol =</span> <span class="dv">3</span>, <span class="at">nrow =</span> <span class="dv">4</span>))</span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(estimates) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Model"</span>, <span class="st">"Intercept"</span>, <span class="st">"slope"</span>)</span>
<span id="cb58-16"><a href="#cb58-16" aria-hidden="true" tabindex="-1"></a>estimates[<span class="dv">1</span>,] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"POLS"</span>,</span>
<span id="cb58-17"><a href="#cb58-17" aria-hidden="true" tabindex="-1"></a>                   lm1<span class="sc">$</span>coefficients[<span class="dv">1</span>],</span>
<span id="cb58-18"><a href="#cb58-18" aria-hidden="true" tabindex="-1"></a>                   lm1<span class="sc">$</span>coefficients[<span class="dv">2</span>])</span>
<span id="cb58-19"><a href="#cb58-19" aria-hidden="true" tabindex="-1"></a>estimates[<span class="dv">2</span>,] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"BE"</span>,</span>
<span id="cb58-20"><a href="#cb58-20" aria-hidden="true" tabindex="-1"></a>                   lm4<span class="sc">$</span>coefficients[<span class="dv">1</span>], </span>
<span id="cb58-21"><a href="#cb58-21" aria-hidden="true" tabindex="-1"></a>                   lm4<span class="sc">$</span>coefficients[<span class="dv">2</span>])</span>
<span id="cb58-22"><a href="#cb58-22" aria-hidden="true" tabindex="-1"></a>estimates[<span class="dv">3</span>,] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"FE"</span>,</span>
<span id="cb58-23"><a href="#cb58-23" aria-hidden="true" tabindex="-1"></a>                   lm3<span class="sc">$</span>coefficients[<span class="dv">1</span>] <span class="sc">+</span> <span class="dv">1</span><span class="sc">/</span>N <span class="sc">*</span> lm3<span class="sc">$</span>coefficients[<span class="dv">3</span>]  <span class="sc">+</span> <span class="dv">1</span><span class="sc">/</span>N <span class="sc">*</span> lm3<span class="sc">$</span>coefficients[<span class="dv">4</span>] </span>
<span id="cb58-24"><a href="#cb58-24" aria-hidden="true" tabindex="-1"></a>                   <span class="sc">+</span> <span class="dv">1</span><span class="sc">/</span>N <span class="sc">*</span> lm3<span class="sc">$</span>coefficients[<span class="dv">5</span>]  <span class="sc">+</span> <span class="dv">1</span><span class="sc">/</span>N <span class="sc">*</span> lm3<span class="sc">$</span>coefficients[<span class="dv">6</span>]  <span class="sc">+</span> <span class="dv">1</span><span class="sc">/</span>N <span class="sc">*</span> lm3<span class="sc">$</span>coefficients[<span class="dv">7</span>], </span>
<span id="cb58-25"><a href="#cb58-25" aria-hidden="true" tabindex="-1"></a>                   lm3<span class="sc">$</span>coefficients[<span class="dv">2</span>])</span>
<span id="cb58-26"><a href="#cb58-26" aria-hidden="true" tabindex="-1"></a>estimates[<span class="dv">4</span>,] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"RE"</span>,</span>
<span id="cb58-27"><a href="#cb58-27" aria-hidden="true" tabindex="-1"></a>                   re<span class="sc">$</span>coefficients[<span class="dv">1</span>], </span>
<span id="cb58-28"><a href="#cb58-28" aria-hidden="true" tabindex="-1"></a>                   re<span class="sc">$</span>coefficients[<span class="dv">2</span>])</span>
<span id="cb58-29"><a href="#cb58-29" aria-hidden="true" tabindex="-1"></a>estimates[, <span class="sc">-</span><span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">apply</span>(estimates[, <span class="sc">-</span><span class="dv">1</span>], <span class="dv">2</span>, <span class="at">FUN =</span> <span class="cf">function</span>(x) <span class="fu">as.numeric</span>(x))</span>
<span id="cb58-30"><a href="#cb58-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-31"><a href="#cb58-31" aria-hidden="true" tabindex="-1"></a>newdf <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">nrow =</span> <span class="dv">2</span>))</span>
<span id="cb58-32"><a href="#cb58-32" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(newdf) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>)</span>
<span id="cb58-33"><a href="#cb58-33" aria-hidden="true" tabindex="-1"></a>newdf<span class="sc">$</span>x <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">min</span>(df<span class="sc">$</span>age), <span class="fu">max</span>(df<span class="sc">$</span>age))</span>
<span id="cb58-34"><a href="#cb58-34" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(estimates)){</span>
<span id="cb58-35"><a href="#cb58-35" aria-hidden="true" tabindex="-1"></a>  newdf<span class="sc">$</span>y <span class="ot">&lt;-</span> estimates[i, <span class="st">"Intercept"</span>] <span class="sc">+</span> estimates[i, <span class="st">"slope"</span>]<span class="sc">*</span>newdf<span class="sc">$</span>x</span>
<span id="cb58-36"><a href="#cb58-36" aria-hidden="true" tabindex="-1"></a>  newdf<span class="sc">$</span>Model <span class="ot">&lt;-</span> estimates[i, <span class="st">"Model"</span>]</span>
<span id="cb58-37"><a href="#cb58-37" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(i <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb58-38"><a href="#cb58-38" aria-hidden="true" tabindex="-1"></a>    pred <span class="ot">&lt;-</span> newdf</span>
<span id="cb58-39"><a href="#cb58-39" aria-hidden="true" tabindex="-1"></a>  }<span class="cf">else</span>{pred <span class="ot">&lt;-</span> <span class="fu">rbind</span>(pred, newdf)}</span>
<span id="cb58-40"><a href="#cb58-40" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb58-41"><a href="#cb58-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-42"><a href="#cb58-42" aria-hidden="true" tabindex="-1"></a>estimates<span class="sc">$</span>Model <span class="ot">&lt;-</span> <span class="fu">factor</span>(estimates<span class="sc">$</span>Model, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"POLS"</span>, <span class="st">"BE"</span>, <span class="st">"FE"</span>, <span class="st">"RE"</span>))</span>
<span id="cb58-43"><a href="#cb58-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-44"><a href="#cb58-44" aria-hidden="true" tabindex="-1"></a>gg_color_hue <span class="ot">&lt;-</span> <span class="cf">function</span>(n) {</span>
<span id="cb58-45"><a href="#cb58-45" aria-hidden="true" tabindex="-1"></a>  hues <span class="ot">=</span> <span class="fu">seq</span>(<span class="dv">15</span>, <span class="dv">375</span>, <span class="at">length =</span> n <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb58-46"><a href="#cb58-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">hcl</span>(<span class="at">h =</span> hues, <span class="at">l =</span> <span class="dv">65</span>, <span class="at">c =</span> <span class="dv">100</span>)[<span class="dv">1</span><span class="sc">:</span>n]</span>
<span id="cb58-47"><a href="#cb58-47" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb58-48"><a href="#cb58-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-49"><a href="#cb58-49" aria-hidden="true" tabindex="-1"></a>zp6 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df, <span class="fu">aes</span>(age, happiness)) <span class="sc">+</span></span>
<span id="cb58-50"><a href="#cb58-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> age, <span class="at">y =</span> happiness, <span class="at">shape =</span> idname),</span>
<span id="cb58-51"><a href="#cb58-51" aria-hidden="true" tabindex="-1"></a>             <span class="at">colour =</span> <span class="fu">rep</span>(<span class="fu">gg_color_hue</span>(<span class="dv">6</span>), <span class="at">each =</span> T),</span>
<span id="cb58-52"><a href="#cb58-52" aria-hidden="true" tabindex="-1"></a>              <span class="at">size =</span> <span class="dv">2</span>, <span class="at">stroke =</span> <span class="dv">1</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb58-53"><a href="#cb58-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">'lm'</span>, <span class="at">formula =</span> y <span class="sc">~</span> x, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>,</span>
<span id="cb58-54"><a href="#cb58-54" aria-hidden="true" tabindex="-1"></a>              <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="fu">aes</span>(<span class="at">group =</span> idname), <span class="at">colour =</span> <span class="fu">alpha</span>(<span class="st">"gray"</span>, <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb58-55"><a href="#cb58-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> <span class="fu">unique</span>(df[, <span class="fu">c</span>(<span class="st">"m_age"</span>, <span class="st">"m_happiness"</span>, <span class="st">"idname"</span>)]),</span>
<span id="cb58-56"><a href="#cb58-56" aria-hidden="true" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">x =</span> m_age, <span class="at">y =</span> m_happiness, <span class="at">shape =</span> idname),</span>
<span id="cb58-57"><a href="#cb58-57" aria-hidden="true" tabindex="-1"></a>             <span class="at">colour =</span> <span class="fu">gg_color_hue</span>(<span class="dv">6</span>), <span class="at">alpha =</span> <span class="fl">0.5</span>,</span>
<span id="cb58-58"><a href="#cb58-58" aria-hidden="true" tabindex="-1"></a>              <span class="at">size =</span> <span class="dv">3</span>, <span class="at">stroke =</span> <span class="dv">2</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb58-59"><a href="#cb58-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> cbp2[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>)]) <span class="sc">+</span></span>
<span id="cb58-60"><a href="#cb58-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_manual</span>(<span class="at">values =</span> cbp2[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>)]) <span class="sc">+</span> </span>
<span id="cb58-61"><a href="#cb58-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_shape_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="dv">15</span><span class="sc">:</span><span class="dv">18</span>, <span class="dv">25</span>, <span class="dv">20</span>)) <span class="sc">+</span></span>
<span id="cb58-62"><a href="#cb58-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">data =</span> estimates, <span class="at">lwd =</span> <span class="fl">1.2</span>,</span>
<span id="cb58-63"><a href="#cb58-63" aria-hidden="true" tabindex="-1"></a>              <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">intercept =</span> Intercept, <span class="at">slope =</span> slope, </span>
<span id="cb58-64"><a href="#cb58-64" aria-hidden="true" tabindex="-1"></a>                            <span class="at">colour =</span> Model, <span class="at">linetype =</span> Model)) <span class="sc">+</span></span>
<span id="cb58-65"><a href="#cb58-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_linetype_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"solid"</span>, <span class="st">"twodash"</span>, <span class="st">"longdash"</span>, <span class="st">"dotdash"</span>)) <span class="sc">+</span></span>
<span id="cb58-66"><a href="#cb58-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis</span>(<span class="at">discrete =</span> <span class="cn">TRUE</span>, <span class="at">option =</span> <span class="st">"D"</span>)<span class="sc">+</span></span>
<span id="cb58-67"><a href="#cb58-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="fl">3.3</span>, <span class="fl">9.2</span>) <span class="sc">+</span> <span class="fu">expand_limits</span>(<span class="at">y =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span> </span>
<span id="cb58-68"><a href="#cb58-68" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb58-69"><a href="#cb58-69" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.key =</span> <span class="fu">element_blank</span>(), <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb58-70"><a href="#cb58-70" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.95</span>,<span class="fl">0.05</span>), <span class="at">legend.justification =</span> <span class="fu">c</span>(<span class="st">"right"</span>, <span class="st">"bottom"</span>),</span>
<span id="cb58-71"><a href="#cb58-71" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb58-72"><a href="#cb58-72" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.box.background =</span> <span class="fu">element_rect</span>(<span class="at">colour =</span> <span class="st">"black"</span>),</span>
<span id="cb58-73"><a href="#cb58-73" aria-hidden="true" tabindex="-1"></a>        <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>))</span>
<span id="cb58-74"><a href="#cb58-74" aria-hidden="true" tabindex="-1"></a>zp6</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Panel_part1_files/figure-html/unnamed-chunk-36-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Both - within and between estimator - get a similar weight for the RE estimator in our example. The reason is that we have nearly identical errors / noise in the in the between model and the within model.</p>
<p>However, this obviously can vary strongly across empirical settings. Lets see what happens when we increase T in our example:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r fold-hide code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">6</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>T <span class="ot">&lt;-</span> <span class="dv">8</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">simdata</span>(<span class="at">N =</span> N, <span class="at">T =</span> T, <span class="at">uw_sd =</span> <span class="dv">0</span>, <span class="at">age_range =</span> <span class="fu">c</span>(<span class="dv">20</span><span class="sc">:</span><span class="dv">60</span>))</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a><span class="do">### Models</span></span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Total line for plot</span></span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>lm1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(happiness <span class="sc">~</span> age, <span class="at">data =</span> df)</span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>lm2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(happiness <span class="sc">~</span> age <span class="sc">+</span> cohort, <span class="at">data =</span> df)</span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a>lm3 <span class="ot">&lt;-</span> <span class="fu">lm</span>(happiness <span class="sc">~</span> age <span class="sc">+</span> idname, <span class="at">data =</span> df)</span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a>lm4 <span class="ot">&lt;-</span> <span class="fu">lm</span>(m_happiness <span class="sc">~</span> m_age, <span class="at">data =</span> df)</span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a>re <span class="ot">&lt;-</span> <span class="fu">plm</span>(happiness <span class="sc">~</span> age, df, <span class="at">model =</span> <span class="st">"random"</span>, <span class="at">effect =</span> <span class="st">"individual"</span>)</span>
<span id="cb59-14"><a href="#cb59-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-15"><a href="#cb59-15" aria-hidden="true" tabindex="-1"></a><span class="do">### Compare POLS, BE, FE, and RE</span></span>
<span id="cb59-16"><a href="#cb59-16" aria-hidden="true" tabindex="-1"></a>estimates <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">ncol =</span> <span class="dv">3</span>, <span class="at">nrow =</span> <span class="dv">4</span>))</span>
<span id="cb59-17"><a href="#cb59-17" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(estimates) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Model"</span>, <span class="st">"Intercept"</span>, <span class="st">"slope"</span>)</span>
<span id="cb59-18"><a href="#cb59-18" aria-hidden="true" tabindex="-1"></a>estimates[<span class="dv">1</span>,] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"POLS"</span>,</span>
<span id="cb59-19"><a href="#cb59-19" aria-hidden="true" tabindex="-1"></a>                   lm1<span class="sc">$</span>coefficients[<span class="dv">1</span>],</span>
<span id="cb59-20"><a href="#cb59-20" aria-hidden="true" tabindex="-1"></a>                   lm1<span class="sc">$</span>coefficients[<span class="dv">2</span>])</span>
<span id="cb59-21"><a href="#cb59-21" aria-hidden="true" tabindex="-1"></a>estimates[<span class="dv">2</span>,] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"BE"</span>,</span>
<span id="cb59-22"><a href="#cb59-22" aria-hidden="true" tabindex="-1"></a>                   lm4<span class="sc">$</span>coefficients[<span class="dv">1</span>], </span>
<span id="cb59-23"><a href="#cb59-23" aria-hidden="true" tabindex="-1"></a>                   lm4<span class="sc">$</span>coefficients[<span class="dv">2</span>])</span>
<span id="cb59-24"><a href="#cb59-24" aria-hidden="true" tabindex="-1"></a>estimates[<span class="dv">3</span>,] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"FE"</span>,</span>
<span id="cb59-25"><a href="#cb59-25" aria-hidden="true" tabindex="-1"></a>                   lm3<span class="sc">$</span>coefficients[<span class="dv">1</span>] <span class="sc">+</span> <span class="dv">1</span><span class="sc">/</span>N <span class="sc">*</span> lm3<span class="sc">$</span>coefficients[<span class="dv">3</span>]  <span class="sc">+</span> <span class="dv">1</span><span class="sc">/</span>N <span class="sc">*</span> lm3<span class="sc">$</span>coefficients[<span class="dv">4</span>] </span>
<span id="cb59-26"><a href="#cb59-26" aria-hidden="true" tabindex="-1"></a>                   <span class="sc">+</span> <span class="dv">1</span><span class="sc">/</span>N <span class="sc">*</span> lm3<span class="sc">$</span>coefficients[<span class="dv">5</span>]  <span class="sc">+</span> <span class="dv">1</span><span class="sc">/</span>N <span class="sc">*</span> lm3<span class="sc">$</span>coefficients[<span class="dv">6</span>]  <span class="sc">+</span> <span class="dv">1</span><span class="sc">/</span>N <span class="sc">*</span> lm3<span class="sc">$</span>coefficients[<span class="dv">7</span>], </span>
<span id="cb59-27"><a href="#cb59-27" aria-hidden="true" tabindex="-1"></a>                   lm3<span class="sc">$</span>coefficients[<span class="dv">2</span>])</span>
<span id="cb59-28"><a href="#cb59-28" aria-hidden="true" tabindex="-1"></a>estimates[<span class="dv">4</span>,] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"RE"</span>,</span>
<span id="cb59-29"><a href="#cb59-29" aria-hidden="true" tabindex="-1"></a>                   re<span class="sc">$</span>coefficients[<span class="dv">1</span>], </span>
<span id="cb59-30"><a href="#cb59-30" aria-hidden="true" tabindex="-1"></a>                   re<span class="sc">$</span>coefficients[<span class="dv">2</span>])</span>
<span id="cb59-31"><a href="#cb59-31" aria-hidden="true" tabindex="-1"></a>estimates[, <span class="sc">-</span><span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">apply</span>(estimates[, <span class="sc">-</span><span class="dv">1</span>], <span class="dv">2</span>, <span class="at">FUN =</span> <span class="cf">function</span>(x) <span class="fu">as.numeric</span>(x))</span>
<span id="cb59-32"><a href="#cb59-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-33"><a href="#cb59-33" aria-hidden="true" tabindex="-1"></a>newdf <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">nrow =</span> <span class="dv">2</span>))</span>
<span id="cb59-34"><a href="#cb59-34" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(newdf) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>)</span>
<span id="cb59-35"><a href="#cb59-35" aria-hidden="true" tabindex="-1"></a>newdf<span class="sc">$</span>x <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">min</span>(df<span class="sc">$</span>age), <span class="fu">max</span>(df<span class="sc">$</span>age))</span>
<span id="cb59-36"><a href="#cb59-36" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(estimates)){</span>
<span id="cb59-37"><a href="#cb59-37" aria-hidden="true" tabindex="-1"></a>  newdf<span class="sc">$</span>y <span class="ot">&lt;-</span> estimates[i, <span class="st">"Intercept"</span>] <span class="sc">+</span> estimates[i, <span class="st">"slope"</span>]<span class="sc">*</span>newdf<span class="sc">$</span>x</span>
<span id="cb59-38"><a href="#cb59-38" aria-hidden="true" tabindex="-1"></a>  newdf<span class="sc">$</span>Model <span class="ot">&lt;-</span> estimates[i, <span class="st">"Model"</span>]</span>
<span id="cb59-39"><a href="#cb59-39" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(i <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb59-40"><a href="#cb59-40" aria-hidden="true" tabindex="-1"></a>    pred <span class="ot">&lt;-</span> newdf</span>
<span id="cb59-41"><a href="#cb59-41" aria-hidden="true" tabindex="-1"></a>  }<span class="cf">else</span>{pred <span class="ot">&lt;-</span> <span class="fu">rbind</span>(pred, newdf)}</span>
<span id="cb59-42"><a href="#cb59-42" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb59-43"><a href="#cb59-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-44"><a href="#cb59-44" aria-hidden="true" tabindex="-1"></a>estimates<span class="sc">$</span>Model <span class="ot">&lt;-</span> <span class="fu">factor</span>(estimates<span class="sc">$</span>Model, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"POLS"</span>, <span class="st">"BE"</span>, <span class="st">"FE"</span>, <span class="st">"RE"</span>))</span>
<span id="cb59-45"><a href="#cb59-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-46"><a href="#cb59-46" aria-hidden="true" tabindex="-1"></a>gg_color_hue <span class="ot">&lt;-</span> <span class="cf">function</span>(n) {</span>
<span id="cb59-47"><a href="#cb59-47" aria-hidden="true" tabindex="-1"></a>  hues <span class="ot">=</span> <span class="fu">seq</span>(<span class="dv">15</span>, <span class="dv">375</span>, <span class="at">length =</span> n <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb59-48"><a href="#cb59-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">hcl</span>(<span class="at">h =</span> hues, <span class="at">l =</span> <span class="dv">65</span>, <span class="at">c =</span> <span class="dv">100</span>)[<span class="dv">1</span><span class="sc">:</span>n]</span>
<span id="cb59-49"><a href="#cb59-49" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb59-50"><a href="#cb59-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-51"><a href="#cb59-51" aria-hidden="true" tabindex="-1"></a>zp7 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df, <span class="fu">aes</span>(age, happiness)) <span class="sc">+</span></span>
<span id="cb59-52"><a href="#cb59-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> age, <span class="at">y =</span> happiness, <span class="at">shape =</span> idname),</span>
<span id="cb59-53"><a href="#cb59-53" aria-hidden="true" tabindex="-1"></a>             <span class="at">colour =</span> <span class="fu">rep</span>(<span class="fu">gg_color_hue</span>(<span class="dv">6</span>), <span class="at">each =</span> T),</span>
<span id="cb59-54"><a href="#cb59-54" aria-hidden="true" tabindex="-1"></a>              <span class="at">size =</span> <span class="dv">2</span>, <span class="at">stroke =</span> <span class="dv">1</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb59-55"><a href="#cb59-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">'lm'</span>, <span class="at">formula =</span> y <span class="sc">~</span> x, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>,</span>
<span id="cb59-56"><a href="#cb59-56" aria-hidden="true" tabindex="-1"></a>              <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="fu">aes</span>(<span class="at">group =</span> idname), <span class="at">colour =</span> <span class="fu">alpha</span>(<span class="st">"gray"</span>, <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb59-57"><a href="#cb59-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> <span class="fu">unique</span>(df[, <span class="fu">c</span>(<span class="st">"m_age"</span>, <span class="st">"m_happiness"</span>, <span class="st">"idname"</span>)]),</span>
<span id="cb59-58"><a href="#cb59-58" aria-hidden="true" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">x =</span> m_age, <span class="at">y =</span> m_happiness, <span class="at">shape =</span> idname),</span>
<span id="cb59-59"><a href="#cb59-59" aria-hidden="true" tabindex="-1"></a>             <span class="at">colour =</span> <span class="fu">gg_color_hue</span>(<span class="dv">6</span>), <span class="at">alpha =</span> <span class="fl">0.5</span>,</span>
<span id="cb59-60"><a href="#cb59-60" aria-hidden="true" tabindex="-1"></a>              <span class="at">size =</span> <span class="dv">3</span>, <span class="at">stroke =</span> <span class="dv">2</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb59-61"><a href="#cb59-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> cbp2[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>)]) <span class="sc">+</span></span>
<span id="cb59-62"><a href="#cb59-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_manual</span>(<span class="at">values =</span> cbp2[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>)]) <span class="sc">+</span> </span>
<span id="cb59-63"><a href="#cb59-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_shape_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="dv">15</span><span class="sc">:</span><span class="dv">18</span>, <span class="dv">25</span>, <span class="dv">20</span>)) <span class="sc">+</span></span>
<span id="cb59-64"><a href="#cb59-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">data =</span> estimates, <span class="at">lwd =</span> <span class="fl">1.2</span>,</span>
<span id="cb59-65"><a href="#cb59-65" aria-hidden="true" tabindex="-1"></a>              <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">intercept =</span> Intercept, <span class="at">slope =</span> slope, </span>
<span id="cb59-66"><a href="#cb59-66" aria-hidden="true" tabindex="-1"></a>                            <span class="at">colour =</span> Model, <span class="at">linetype =</span> Model)) <span class="sc">+</span></span>
<span id="cb59-67"><a href="#cb59-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_linetype_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"solid"</span>, <span class="st">"twodash"</span>, <span class="st">"longdash"</span>, <span class="st">"dotdash"</span>)) <span class="sc">+</span></span>
<span id="cb59-68"><a href="#cb59-68" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis</span>(<span class="at">discrete =</span> <span class="cn">TRUE</span>, <span class="at">option =</span> <span class="st">"D"</span>)<span class="sc">+</span></span>
<span id="cb59-69"><a href="#cb59-69" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_linetype_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"solid"</span>, <span class="st">"twodash"</span>, <span class="st">"longdash"</span>, <span class="st">"dotdash"</span>)) <span class="sc">+</span></span>
<span id="cb59-70"><a href="#cb59-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="fl">3.3</span>, <span class="fl">9.2</span>) <span class="sc">+</span> <span class="fu">expand_limits</span>(<span class="at">y =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span> </span>
<span id="cb59-71"><a href="#cb59-71" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb59-72"><a href="#cb59-72" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.key =</span> <span class="fu">element_blank</span>(), <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb59-73"><a href="#cb59-73" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.95</span>,<span class="fl">0.05</span>), <span class="at">legend.justification =</span> <span class="fu">c</span>(<span class="st">"right"</span>, <span class="st">"bottom"</span>),</span>
<span id="cb59-74"><a href="#cb59-74" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb59-75"><a href="#cb59-75" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.box.background =</span> <span class="fu">element_rect</span>(<span class="at">colour =</span> <span class="st">"black"</span>),</span>
<span id="cb59-76"><a href="#cb59-76" aria-hidden="true" tabindex="-1"></a>        <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>))</span>
<span id="cb59-77"><a href="#cb59-77" aria-hidden="true" tabindex="-1"></a>zp7</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Panel_part1_files/figure-html/unnamed-chunk-37-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The POLS goes very slightly towards the within estimator. This is because we have increased the within variance in age, but there is still much more variance in age between individuals.</p>
<p>The RE goes strongly towards FE. This is because - by increasing T - the between model now makes a larger error: there are more data points far away from the green BE line. The error or the within model, in contrast, remain unchanged. So RE gives more weight to the within estimator.</p>
<p>However, if we increase the noise in the within estimator (bringing the data points further away from each id-specific regression line), RE would move back towards the between estimator:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r fold-hide code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">6</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>T <span class="ot">&lt;-</span> <span class="dv">8</span></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">simdata</span>(<span class="at">N =</span> N, <span class="at">T =</span> T, <span class="at">uw_sd =</span> <span class="fl">0.5</span>, <span class="at">age_range =</span> <span class="fu">c</span>(<span class="dv">20</span><span class="sc">:</span><span class="dv">60</span>))</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a><span class="do">### Models</span></span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Total line for plot</span></span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>lm1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(happiness <span class="sc">~</span> age, <span class="at">data =</span> df)</span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a>lm2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(happiness <span class="sc">~</span> age <span class="sc">+</span> cohort, <span class="at">data =</span> df)</span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a>lm3 <span class="ot">&lt;-</span> <span class="fu">lm</span>(happiness <span class="sc">~</span> age <span class="sc">+</span> idname, <span class="at">data =</span> df)</span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a>lm4 <span class="ot">&lt;-</span> <span class="fu">lm</span>(m_happiness <span class="sc">~</span> m_age, <span class="at">data =</span> df)</span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a>re <span class="ot">&lt;-</span> <span class="fu">plm</span>(happiness <span class="sc">~</span> age, df, <span class="at">model =</span> <span class="st">"random"</span>, <span class="at">effect =</span> <span class="st">"individual"</span>)</span>
<span id="cb60-14"><a href="#cb60-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-15"><a href="#cb60-15" aria-hidden="true" tabindex="-1"></a><span class="do">### Compare POLS, BE, FE, and RE</span></span>
<span id="cb60-16"><a href="#cb60-16" aria-hidden="true" tabindex="-1"></a>estimates <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">ncol =</span> <span class="dv">3</span>, <span class="at">nrow =</span> <span class="dv">4</span>))</span>
<span id="cb60-17"><a href="#cb60-17" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(estimates) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Model"</span>, <span class="st">"Intercept"</span>, <span class="st">"slope"</span>)</span>
<span id="cb60-18"><a href="#cb60-18" aria-hidden="true" tabindex="-1"></a>estimates[<span class="dv">1</span>,] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"POLS"</span>,</span>
<span id="cb60-19"><a href="#cb60-19" aria-hidden="true" tabindex="-1"></a>                   lm1<span class="sc">$</span>coefficients[<span class="dv">1</span>],</span>
<span id="cb60-20"><a href="#cb60-20" aria-hidden="true" tabindex="-1"></a>                   lm1<span class="sc">$</span>coefficients[<span class="dv">2</span>])</span>
<span id="cb60-21"><a href="#cb60-21" aria-hidden="true" tabindex="-1"></a>estimates[<span class="dv">2</span>,] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"BE"</span>,</span>
<span id="cb60-22"><a href="#cb60-22" aria-hidden="true" tabindex="-1"></a>                   lm4<span class="sc">$</span>coefficients[<span class="dv">1</span>], </span>
<span id="cb60-23"><a href="#cb60-23" aria-hidden="true" tabindex="-1"></a>                   lm4<span class="sc">$</span>coefficients[<span class="dv">2</span>])</span>
<span id="cb60-24"><a href="#cb60-24" aria-hidden="true" tabindex="-1"></a>estimates[<span class="dv">3</span>,] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"FE"</span>,</span>
<span id="cb60-25"><a href="#cb60-25" aria-hidden="true" tabindex="-1"></a>                   lm3<span class="sc">$</span>coefficients[<span class="dv">1</span>] <span class="sc">+</span> <span class="dv">1</span><span class="sc">/</span>N <span class="sc">*</span> lm3<span class="sc">$</span>coefficients[<span class="dv">3</span>]  <span class="sc">+</span> <span class="dv">1</span><span class="sc">/</span>N <span class="sc">*</span> lm3<span class="sc">$</span>coefficients[<span class="dv">4</span>] </span>
<span id="cb60-26"><a href="#cb60-26" aria-hidden="true" tabindex="-1"></a>                   <span class="sc">+</span> <span class="dv">1</span><span class="sc">/</span>N <span class="sc">*</span> lm3<span class="sc">$</span>coefficients[<span class="dv">5</span>]  <span class="sc">+</span> <span class="dv">1</span><span class="sc">/</span>N <span class="sc">*</span> lm3<span class="sc">$</span>coefficients[<span class="dv">6</span>]  <span class="sc">+</span> <span class="dv">1</span><span class="sc">/</span>N <span class="sc">*</span> lm3<span class="sc">$</span>coefficients[<span class="dv">7</span>], </span>
<span id="cb60-27"><a href="#cb60-27" aria-hidden="true" tabindex="-1"></a>                   lm3<span class="sc">$</span>coefficients[<span class="dv">2</span>])</span>
<span id="cb60-28"><a href="#cb60-28" aria-hidden="true" tabindex="-1"></a>estimates[<span class="dv">4</span>,] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"RE"</span>,</span>
<span id="cb60-29"><a href="#cb60-29" aria-hidden="true" tabindex="-1"></a>                   re<span class="sc">$</span>coefficients[<span class="dv">1</span>], </span>
<span id="cb60-30"><a href="#cb60-30" aria-hidden="true" tabindex="-1"></a>                   re<span class="sc">$</span>coefficients[<span class="dv">2</span>])</span>
<span id="cb60-31"><a href="#cb60-31" aria-hidden="true" tabindex="-1"></a>estimates[, <span class="sc">-</span><span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">apply</span>(estimates[, <span class="sc">-</span><span class="dv">1</span>], <span class="dv">2</span>, <span class="at">FUN =</span> <span class="cf">function</span>(x) <span class="fu">as.numeric</span>(x))</span>
<span id="cb60-32"><a href="#cb60-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-33"><a href="#cb60-33" aria-hidden="true" tabindex="-1"></a>newdf <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">nrow =</span> <span class="dv">2</span>))</span>
<span id="cb60-34"><a href="#cb60-34" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(newdf) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>)</span>
<span id="cb60-35"><a href="#cb60-35" aria-hidden="true" tabindex="-1"></a>newdf<span class="sc">$</span>x <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">min</span>(df<span class="sc">$</span>age), <span class="fu">max</span>(df<span class="sc">$</span>age))</span>
<span id="cb60-36"><a href="#cb60-36" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(estimates)){</span>
<span id="cb60-37"><a href="#cb60-37" aria-hidden="true" tabindex="-1"></a>  newdf<span class="sc">$</span>y <span class="ot">&lt;-</span> estimates[i, <span class="st">"Intercept"</span>] <span class="sc">+</span> estimates[i, <span class="st">"slope"</span>]<span class="sc">*</span>newdf<span class="sc">$</span>x</span>
<span id="cb60-38"><a href="#cb60-38" aria-hidden="true" tabindex="-1"></a>  newdf<span class="sc">$</span>Model <span class="ot">&lt;-</span> estimates[i, <span class="st">"Model"</span>]</span>
<span id="cb60-39"><a href="#cb60-39" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(i <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb60-40"><a href="#cb60-40" aria-hidden="true" tabindex="-1"></a>    pred <span class="ot">&lt;-</span> newdf</span>
<span id="cb60-41"><a href="#cb60-41" aria-hidden="true" tabindex="-1"></a>  }<span class="cf">else</span>{pred <span class="ot">&lt;-</span> <span class="fu">rbind</span>(pred, newdf)}</span>
<span id="cb60-42"><a href="#cb60-42" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb60-43"><a href="#cb60-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-44"><a href="#cb60-44" aria-hidden="true" tabindex="-1"></a>estimates<span class="sc">$</span>Model <span class="ot">&lt;-</span> <span class="fu">factor</span>(estimates<span class="sc">$</span>Model, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"POLS"</span>, <span class="st">"BE"</span>, <span class="st">"FE"</span>, <span class="st">"RE"</span>))</span>
<span id="cb60-45"><a href="#cb60-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-46"><a href="#cb60-46" aria-hidden="true" tabindex="-1"></a>gg_color_hue <span class="ot">&lt;-</span> <span class="cf">function</span>(n) {</span>
<span id="cb60-47"><a href="#cb60-47" aria-hidden="true" tabindex="-1"></a>  hues <span class="ot">=</span> <span class="fu">seq</span>(<span class="dv">15</span>, <span class="dv">375</span>, <span class="at">length =</span> n <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb60-48"><a href="#cb60-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">hcl</span>(<span class="at">h =</span> hues, <span class="at">l =</span> <span class="dv">65</span>, <span class="at">c =</span> <span class="dv">100</span>)[<span class="dv">1</span><span class="sc">:</span>n]</span>
<span id="cb60-49"><a href="#cb60-49" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb60-50"><a href="#cb60-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-51"><a href="#cb60-51" aria-hidden="true" tabindex="-1"></a>zp7 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df, <span class="fu">aes</span>(age, happiness)) <span class="sc">+</span></span>
<span id="cb60-52"><a href="#cb60-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> age, <span class="at">y =</span> happiness, <span class="at">shape =</span> idname),</span>
<span id="cb60-53"><a href="#cb60-53" aria-hidden="true" tabindex="-1"></a>             <span class="at">colour =</span> <span class="fu">rep</span>(<span class="fu">gg_color_hue</span>(<span class="dv">6</span>), <span class="at">each =</span> T),</span>
<span id="cb60-54"><a href="#cb60-54" aria-hidden="true" tabindex="-1"></a>              <span class="at">size =</span> <span class="dv">2</span>, <span class="at">stroke =</span> <span class="dv">1</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb60-55"><a href="#cb60-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">'lm'</span>, <span class="at">formula =</span> y <span class="sc">~</span> x, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>,</span>
<span id="cb60-56"><a href="#cb60-56" aria-hidden="true" tabindex="-1"></a>              <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="fu">aes</span>(<span class="at">group =</span> idname), <span class="at">colour =</span> <span class="fu">alpha</span>(<span class="st">"gray"</span>, <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb60-57"><a href="#cb60-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> <span class="fu">unique</span>(df[, <span class="fu">c</span>(<span class="st">"m_age"</span>, <span class="st">"m_happiness"</span>, <span class="st">"idname"</span>)]),</span>
<span id="cb60-58"><a href="#cb60-58" aria-hidden="true" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">x =</span> m_age, <span class="at">y =</span> m_happiness, <span class="at">shape =</span> idname),</span>
<span id="cb60-59"><a href="#cb60-59" aria-hidden="true" tabindex="-1"></a>             <span class="at">colour =</span> <span class="fu">gg_color_hue</span>(<span class="dv">6</span>), <span class="at">alpha =</span> <span class="fl">0.5</span>,</span>
<span id="cb60-60"><a href="#cb60-60" aria-hidden="true" tabindex="-1"></a>              <span class="at">size =</span> <span class="dv">3</span>, <span class="at">stroke =</span> <span class="dv">2</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb60-61"><a href="#cb60-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> cbp2[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>)]) <span class="sc">+</span></span>
<span id="cb60-62"><a href="#cb60-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_manual</span>(<span class="at">values =</span> cbp2[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>)]) <span class="sc">+</span> </span>
<span id="cb60-63"><a href="#cb60-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_shape_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="dv">15</span><span class="sc">:</span><span class="dv">18</span>, <span class="dv">25</span>, <span class="dv">20</span>)) <span class="sc">+</span></span>
<span id="cb60-64"><a href="#cb60-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">data =</span> estimates, <span class="at">lwd =</span> <span class="fl">1.2</span>,</span>
<span id="cb60-65"><a href="#cb60-65" aria-hidden="true" tabindex="-1"></a>              <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">intercept =</span> Intercept, <span class="at">slope =</span> slope, </span>
<span id="cb60-66"><a href="#cb60-66" aria-hidden="true" tabindex="-1"></a>                            <span class="at">colour =</span> Model, <span class="at">linetype =</span> Model)) <span class="sc">+</span></span>
<span id="cb60-67"><a href="#cb60-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_linetype_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"solid"</span>, <span class="st">"twodash"</span>, <span class="st">"longdash"</span>, <span class="st">"dotdash"</span>)) <span class="sc">+</span></span>
<span id="cb60-68"><a href="#cb60-68" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis</span>(<span class="at">discrete =</span> <span class="cn">TRUE</span>, <span class="at">option =</span> <span class="st">"D"</span>)<span class="sc">+</span></span>
<span id="cb60-69"><a href="#cb60-69" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="fl">3.3</span>, <span class="fl">9.2</span>) <span class="sc">+</span> <span class="fu">expand_limits</span>(<span class="at">y =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span> </span>
<span id="cb60-70"><a href="#cb60-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb60-71"><a href="#cb60-71" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.key =</span> <span class="fu">element_blank</span>(), <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb60-72"><a href="#cb60-72" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.95</span>,<span class="fl">0.05</span>), <span class="at">legend.justification =</span> <span class="fu">c</span>(<span class="st">"right"</span>, <span class="st">"bottom"</span>),</span>
<span id="cb60-73"><a href="#cb60-73" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb60-74"><a href="#cb60-74" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.box.background =</span> <span class="fu">element_rect</span>(<span class="at">colour =</span> <span class="st">"black"</span>),</span>
<span id="cb60-75"><a href="#cb60-75" aria-hidden="true" tabindex="-1"></a>        <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>))</span>
<span id="cb60-76"><a href="#cb60-76" aria-hidden="true" tabindex="-1"></a>zp7</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Panel_part1_files/figure-html/unnamed-chunk-38-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Do you have an idea what happens if we reduce the range of the starting age of the individuals (bringing them closer together)?</p>
<section id="there-are-two-main-problems-with-the-re-estimator" class="level3">
<h3 class="anchored" data-anchor-id="there-are-two-main-problems-with-the-re-estimator">There are two main problems with the RE estimator:</h3>
<ol type="1">
<li><p>Interpretation: how to interpret an estimator based on a mix of <strong>within</strong> and <strong>between</strong> variance?</p></li>
<li><p>Strong assumptions for consistency of no time-constant unobserved heterogeneity: very likely to be biased in practice</p></li>
</ol>
<p>I personally would generally suggest against the use of RE. Rather, ask yourself whether you are interested in a between or a within question and use the theoretically relevant method.</p>
</section>
<section id="hausman-test" class="level3">
<h3 class="anchored" data-anchor-id="hausman-test">Hausman test</h3>
<p>If one has a strong reason to use the RE, it is at least advisable to perform a specification test. The Hausman test <span class="citation" data-cites="Hausman.1978">(<a href="#ref-Hausman.1978" role="doc-biblioref">Hausman 1978</a>)</span> is the most common specification test to test the consistency of the RE estimator.</p>
<p><span class="math display">\[
H = (\hat{\boldsymbol{\mathbf{\beta}}}_1 - \hat{\boldsymbol{\mathbf{\beta}}}_0)^\intercal (N^{-1} {\boldsymbol{\mathbf{V}}}_{\hat{\boldsymbol{\mathbf{\beta}}}_1 - \hat{\boldsymbol{\mathbf{\beta}}}_0})^{-1} (\hat{\boldsymbol{\mathbf{\beta}}}_1 - \hat{\boldsymbol{\mathbf{\beta}}}_0),
\]</span> where <span class="math inline">\(\hat{\boldsymbol{\mathbf{\beta}}}_1\)</span> is consistent, and <span class="math inline">\(\hat{\boldsymbol{\mathbf{\beta}}}_0\)</span> is efficient, <span class="math inline">\(N^{-1} {\boldsymbol{\mathbf{V}}}_{\hat{\boldsymbol{\mathbf{\beta}}}_1 - \hat{\boldsymbol{\mathbf{\beta}}}_0} = \mathrm{Var}(\hat{\boldsymbol{\mathbf{\beta}}}_1 - \hat{\boldsymbol{\mathbf{\beta}}}_0)\)</span>, and with RE being fully efficient: <span class="math inline">\(\mathrm{Var}(\hat{\boldsymbol{\mathbf{\beta}}}_1 - \hat{\boldsymbol{\mathbf{\beta}}}_0) = \mathrm{Var}(\hat{\boldsymbol{\mathbf{\beta}}}_1) - \mathrm{Var}(\hat{\boldsymbol{\mathbf{\beta}}}_0)\)</span>.</p>
<p>This basically perform a test of the Null H<span class="math inline">\(_0\)</span>: <span class="math inline">\(\hat{\beta}_{FE} = \hat{\beta}_{RE}\)</span>, and shows us if the two estimates differ significantly.</p>
<p><strong>Use FE if Hausman test significant, and H<span class="math inline">\(_0\)</span> rejected.</strong></p>
<p>Letâs check in our example:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">phtest</span>(fe1, re1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
    Hausman Test

data:  happiness ~ age
chisq = 26.063, df = 1, p-value = 3.304e-07
alternative hypothesis: one model is inconsistent</code></pre>
</div>
</div>
<p>The test is highly significant and thus suggest that we should use the FE rather than the RE.</p>
<p>Obviously, this test is not helpful if both estimates are biased.</p>
</section>
</section>
<section id="hybrid-models" class="level1">
<h1>Hybrid models</h1>
<p>One of the stated advantages of the RE is that we can also estimate the effect for time-constant variables. However, there is an easy way of combining the benefits of both worlds: we can just estimate the within effects of time-varying variables in a RE model.</p>
<p>This is often called the correlated random effects (CRE) model <span class="citation" data-cites="Chamberlain.1982 Mundlak.1978">(<a href="#ref-Chamberlain.1982" role="doc-biblioref">Chamberlain 1982</a>; <a href="#ref-Mundlak.1978" role="doc-biblioref">Mundlak 1978</a>)</span>. In sociology, the very similar hybrid model <span class="citation" data-cites="Allison.2009">(<a href="#ref-Allison.2009" role="doc-biblioref">Allison 2009</a>.)</span> is more common.</p>
<p>In general, we just add the person specific means as additional covariates, and estimate a random effects model:</p>
<p><span class="math display">\[
y_{it} = \alpha + \beta x_{it} + \gamma \bar{x}_{i} + \xi_{it}  
\]</span></p>
<p>We split up the individual effect <span class="math inline">\(\alpha_i = \gamma \bar{x}_{i} + \eta_i\)</span>, and thus only control partially for time-constant heterogeneity by adding the person-specific means <span class="math inline">\(\bar{x}_{i}\)</span>.</p>
<p><strong><span class="math inline">\(\hat{\beta}\)</span> gives us the within estimate for <span class="math inline">\(x\)</span></strong></p>
<p>See our happiness example</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Person specific means</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>m_age <span class="ot">&lt;-</span> <span class="fu">ave</span>(df<span class="sc">$</span>age,</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>                df<span class="sc">$</span>id,</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>                <span class="at">FUN =</span> mean)</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>cre <span class="ot">&lt;-</span> <span class="fu">plm</span>(happiness <span class="sc">~</span> age <span class="sc">+</span> m_age, <span class="at">data =</span> df_orig,</span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>           <span class="at">index =</span> <span class="fu">c</span>(<span class="st">"id"</span>, <span class="st">"time"</span>),</span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>           <span class="at">effect =</span> <span class="st">"individual"</span>, <span class="at">model =</span> <span class="st">"random"</span>)</span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a><span class="fu">screenreg</span>(<span class="fu">list</span>(fe1, btw2, re1, cre), <span class="at">digits =</span> <span class="dv">3</span>,</span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a>          <span class="at">custom.model.names =</span> <span class="fu">c</span>(<span class="st">"FE"</span>, <span class="st">"BTW"</span>, <span class="st">"RE"</span>, <span class="st">"CRE"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
==========================================================
             FE          BTW        RE          CRE       
----------------------------------------------------------
age          -0.148 ***   0.122 **  -0.016      -0.148 ***
             (0.017)     (0.018)    (0.031)     (0.017)   
(Intercept)               0.733      6.934 ***   0.733    
                         (0.835)    (1.534)     (0.835)   
m_age                                            0.270 ***
                                                (0.025)   
----------------------------------------------------------
R^2           0.810       0.922      0.011       0.851    
Adj. R^2      0.743       0.903     -0.034       0.837    
Num. obs.    24           6         24          24        
s_idios                              0.191       0.191    
s_id                                 0.586       0.586    
==========================================================
*** p &lt; 0.001; ** p &lt; 0.01; * p &lt; 0.05</code></pre>
</div>
</div>
<p>The estimate for <span class="math inline">\(\beta_{CRE}\)</span> equals the within effect. Note that the coefficient for the mean does not equal the between effect. It equals <span class="math inline">\(\hat{\beta}_{BTW} - \hat{\beta}_{FE}\)</span>. This differs from <span class="citation" data-cites="Allison.2009">Allison (<a href="#ref-Allison.2009" role="doc-biblioref">2009</a>)</span>. hybrid model.</p>
<p>For consistency of <span class="math inline">\(\hat{\beta}_x\)</span> we only need <span class="math inline">\(\mathrm{E}(\epsilon_{it} | x_{i}, \bar{x}_{i}) = 0\)</span>: equals the FE assumption for variables additionally included as person-specific means. Usually, one would include person-specific means for all time-varying <span class="math inline">\(\boldsymbol{\mathbf{x}}\)</span> (except <span class="math inline">\(\mu_t\)</span> in case of a twoways specification).</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The CRE can also be quite helpful in the case of non-linear models. We cannot just include person-dummies in non-linear models such as logit! <span class="citation" data-cites="Wooldridge.2010">Wooldridge (<a href="#ref-Wooldridge.2010" role="doc-biblioref">2010</a>)</span> describes the best way of estimating FE non-linear models: a) Estimate a CRE specification within a Random Effects Probit, b) obtain the marginal effects of the time-varying coefficients. See <span class="citation" data-cites="Ruttenauer.2022b">RÃ¼ttenauer and Best (<a href="#ref-Ruttenauer.2022b" role="doc-biblioref">2022</a>)</span> for an applied example on the likelihood of relocation.</p>
</div>
</div>
</section>
<section id="statistical-inference" class="level1">
<h1>Statistical inference</h1>
<p>The standard errors we have seen so far, were conventional standard error, not taking into account the panel structure.</p>
<p>In the case of a simple linear regression of the form <span class="math inline">\(\boldsymbol{\mathbf{y}} = \boldsymbol{\mathbf{X}} \boldsymbol{\mathbf{\beta }}+ \boldsymbol{\mathbf{\upsilon}}\)</span> with the coefficients calculated by OLS <span class="math inline">\(\hat{\boldsymbol{\mathbf{\beta}}} = (\boldsymbol{\mathbf{X}}^\intercal\boldsymbol{\mathbf{X}})^{-1}\boldsymbol{\mathbf{X}}^\intercal \boldsymbol{\mathbf{y}}\)</span>, the covariance matrix is usually calculated as:</p>
<p><span class="math display">\[
\mathrm{Var}(\hat{\boldsymbol{\mathbf{\beta}}}) = \hat{\sigma}^2(\boldsymbol{\mathbf{X}}^\intercal \boldsymbol{\mathbf{X}})^{-1},
\]</span> where <span class="math inline">\(\hat{\sigma}^2\)</span> is the estimated error variance:</p>
<p><span class="math display">\[
\hat{\sigma}^2 = \frac{1}{N-K}\sum^N_{i=1}(\hat\upsilon_i)^2
\]</span></p>
<p>However, with panel data, the idiosyncratic errors are probably:</p>
<ul>
<li><p>heteroskedastic: have a non-constant variance</p></li>
<li><p>autocorrelated: error in one period correlate with errors in other periods</p></li>
</ul>
<p><strong>The conventional errors (as reported in <code>lm()</code> and <code>plm()</code>) are thus likely to be underestimated.</strong></p>
<p>The easiest solution is to estimate panel-robust standard errors <span class="citation" data-cites="Millo.2017 Wooldridge.2010">(<a href="#ref-Millo.2017" role="doc-biblioref">Millo 2017</a>; <a href="#ref-Wooldridge.2010" role="doc-biblioref">Wooldridge 2010</a>)</span>.</p>
<p>There are various ways for correcting heteroskedastic and autocorrelated standard errors. The most common version is based on work by Arellano and White and takes the form:</p>
<p><span class="math display">\[
\mathrm{Var}(\hat{\boldsymbol{\mathbf{\beta}}}_{FE}) = (\tilde{\boldsymbol{\mathbf{X}}}^\intercal \tilde{\boldsymbol{\mathbf{X}}})^{-1}
(\sum_{i=1}^N \tilde{\boldsymbol{\mathbf{X}}}^\intercal_i \hat{\tilde{\boldsymbol{\mathbf{\epsilon}}}}_i \hat{\tilde{\boldsymbol{\mathbf{\epsilon}}}}_i^\intercal \tilde{\boldsymbol{\mathbf{X}}}_i)
(\tilde{\boldsymbol{\mathbf{X}}}^\intercal \tilde{\boldsymbol{\mathbf{X}}})^{-1},
\]</span></p>
<p>where <span class="math inline">\(\hat{\tilde{\boldsymbol{\mathbf{\varepsilon}}}}_i\)</span> is the vector of FE residuals for each person <span class="math inline">\(i\)</span>, and <span class="math inline">\(\tilde{\boldsymbol{\mathbf{X}}}\)</span> are the transformed data <span class="citation" data-cites="Millo.2017">(<a href="#ref-Millo.2017" role="doc-biblioref">Millo 2017</a>)</span>. This basically clusters the standard within each cross-sectional unit. Obviously, one could cluster by other grouping variables such as time (e.g.&nbsp;with large <span class="math inline">\(T\)</span> and small <span class="math inline">\(N\)</span>) or perform double clustering <span class="citation" data-cites="Millo.2017">(<a href="#ref-Millo.2017" role="doc-biblioref">Millo 2017</a>)</span>.</p>
<p>to calculate those standard errors, we can use the <code>sandwich</code> and <code>coeftest</code> packages. For more information on the various types and options in the command see <span class="citation" data-cites="Millo.2017">Millo (<a href="#ref-Millo.2017" role="doc-biblioref">2017</a>)</span>.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fe1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Oneway (individual) effect Within Model

Call:
plm(formula = happiness ~ age, data = df, effect = "individual", 
    model = "within", index = c("id", "time"))

Balanced Panel: n = 6, T = 4, N = 24

Residuals:
     Min.   1st Qu.    Median   3rd Qu.      Max. 
-0.287907 -0.118754  0.035834  0.141721  0.275941 

Coefficients:
     Estimate Std. Error t-value  Pr(&gt;|t|)    
age -0.148245   0.017418 -8.5108 1.556e-07 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Total Sum of Squares:    3.2561
Residual Sum of Squares: 0.61893
R-Squared:      0.80992
Adj. R-Squared: 0.74283
F-statistic: 72.4345 on 1 and 17 DF, p-value: 1.5556e-07</code></pre>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get variance covariance matrix directly</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>vcovx <span class="ot">&lt;-</span> <span class="fu">vcovHC</span>(fe1, <span class="at">cluster =</span> <span class="st">"group"</span>, <span class="at">method =</span> <span class="st">"arellano"</span>, <span class="at">type =</span> <span class="st">"HC3"</span>)</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Get model output with the robust SEs</span></span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a><span class="fu">coeftest</span>(fe1, <span class="at">vcov =</span> <span class="cf">function</span>(x) <span class="fu">vcovHC</span>(x, <span class="at">method =</span> <span class="st">"arellano"</span>, <span class="at">type =</span> <span class="st">"HC3"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
t test of coefficients:

     Estimate Std. Error t value  Pr(&gt;|t|)    
age -0.148245   0.016494 -8.9879 7.223e-08 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
<p>In this case the robust SEs are actually smaller!! This is because this stylized example does not include heteroskedasticity or autocorrelation. However, we will see the difference with some real data.</p>
<p>For a timely discussion on clustering standard error, when to cluster, and which variables to cluster on see <span class="citation" data-cites="Abadie.2022">Abadie et al. (<a href="#ref-Abadie.2022" role="doc-biblioref">2022</a>)</span>.</p>
<p><strong>One hint for large data</strong>: <code>coeftest</code> and <code>sandwich</code> can be slow on large data. It might be more efficient to use the package <code>lfe</code> right away. The <code>felm()</code> function (to estimate FE models) requires a four part formula of the form <code>y ~ x1 + x2 | f1 + f2 | (Q|W ~ x3+x4) | clu1 + clu2</code>, where âxâ are ordinary covariates, âfâ are the fixed effects, the third part allows to instrument covariates, and âcluâ are clusters for robust standard errors:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>fe1_2 <span class="ot">&lt;-</span> <span class="fu">felm</span>(happiness <span class="sc">~</span> age <span class="sc">|</span> id <span class="sc">|</span> <span class="dv">0</span> <span class="sc">|</span> id,</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>               <span class="at">data =</span> df, <span class="at">cmethod =</span> <span class="st">'cgm2'</span>)</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fe1_2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
   felm(formula = happiness ~ age | id | 0 | id, data = df, cmethod = "cgm2") 

Residuals:
    Min      1Q  Median      3Q     Max 
-1.1657 -0.2714 -0.0410  0.2729  1.1037 

Coefficients:
    Estimate Cluster s.e. t value Pr(&gt;|t|)    
age  -0.1531       0.0076  -20.14 5.57e-06 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.4567 on 41 degrees of freedom
Multiple R-squared(full model): 0.9484   Adjusted R-squared: 0.9409 
Multiple R-squared(proj model): 0.7342   Adjusted R-squared: 0.6953 
F-statistic(full model, *iid*):125.7 on 6 and 41 DF, p-value: &lt; 2.2e-16 
F-statistic(proj model): 405.8 on 1 and 5 DF, p-value: 5.572e-06 </code></pre>
</div>
</div>
</section>
<section id="references" class="level1">



<!-- -->


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" role="list">
<div id="ref-Abadie.2022" class="csl-entry" role="listitem">
Abadie, Alberto, Susan Athey, Guido Imbens, and Jeffrey Wooldridge. 2022. <span>âWhen <span>Should You Adjust Standard Errors</span> for <span>Clustering</span>?â</span> <span>arXiv</span>. <a href="https://arxiv.org/abs/1710.02926">https://arxiv.org/abs/1710.02926</a>.
</div>
<div id="ref-Allison.2009" class="csl-entry" role="listitem">
Allison, Paul David. 2009. <em>Fixed <span>Effects Regression Models</span></em>. Vol. 160. Quantitative <span>Applications</span> in the <span>Social Sciences</span>. <span>Los Angeles</span>: <span>Sage</span>.
</div>
<div id="ref-Bruderl.2015" class="csl-entry" role="listitem">
BrÃ¼derl, Josef, and Volker Ludwig. 2015. <span>âFixed-<span>Effects Panel Regression</span>.â</span> In <em>The <span>Sage Handbook</span> of <span>Regression Analysis</span> and <span>Causal Inference</span></em>, edited by Henning Best and Christof Wolf, 327â57. <span>Los Angeles</span>: <span>Sage</span>.
</div>
<div id="ref-Chamberlain.1982" class="csl-entry" role="listitem">
Chamberlain, Gary. 1982. <span>âMultivariate <span>Regression Models</span> for <span>Panel Data</span>.â</span> <em>Journal of Econometrics</em> 18 (1): 5â46. <a href="https://doi.org/10.1016/0304-4076(82)90094-X">https://doi.org/10.1016/0304-4076(82)90094-X</a>.
</div>
<div id="ref-Cunningham.2021" class="csl-entry" role="listitem">
Cunningham, Scott. 2021. <em>Causal <span>Inference</span>: <span>The Mixtape</span></em>. <span>New Haven and London</span>: <span>Yale University Press</span>.
</div>
<div id="ref-Goodman-Bacon.2021" class="csl-entry" role="listitem">
Goodman-Bacon, Andrew. 2021. <span>âDifference-in-Differences with Variation in Treatment Timing.â</span> <em>Journal of Econometrics</em> 225 (2): 254â77. <a href="https://doi.org/10.1016/j.jeconom.2021.03.014">https://doi.org/10.1016/j.jeconom.2021.03.014</a>.
</div>
<div id="ref-Hausman.1978" class="csl-entry" role="listitem">
Hausman, Jerry A. 1978. <span>âSpecification <span>Tests</span> in <span>Econometrics</span>.â</span> <em>Econometrica</em> 46 (6): 1251â71. <a href="https://doi.org/10.2307/1913827">https://doi.org/10.2307/1913827</a>.
</div>
<div id="ref-Huntington-Klein.2021" class="csl-entry" role="listitem">
Huntington-Klein, Nick. 2021. <em>The <span>Effect</span>: <span>An Introduction</span> to <span>Research Design</span> and <span>Causality</span></em>. <span>Boca Raton</span>: <span>Chapman &amp; Hall/CRC</span>.
</div>
<div id="ref-Kratz.2021" class="csl-entry" role="listitem">
Kratz, Fabian, and Josef BrÃ¼derl. 2021. <span>âThe <span>Age Trajectory</span> of <span>Happiness</span>.â</span> <em>PsyArXiv</em>. <a href="https://doi.org/10.31234/osf.io/d8f2z">https://doi.org/10.31234/osf.io/d8f2z</a>.
</div>
<div id="ref-Ludwig.2018" class="csl-entry" role="listitem">
Ludwig, Volker, and Josef BrÃ¼derl. 2018. <span>âIs <span>There</span> a <span>Male Marital Wage Premium</span>? <span>New Evidence</span> from the <span>United States</span>.â</span> <em>American Sociological Review</em> 83 (4): 744â70. <a href="https://doi.org/10.1177/0003122418784909">https://doi.org/10.1177/0003122418784909</a>.
</div>
<div id="ref-Millo.2017" class="csl-entry" role="listitem">
Millo, Giovanni. 2017. <span>âRobust <span>Standard Error Estimators</span> for <span>Panel Models</span>: <span>A Unifying Approach</span>.â</span> <em>Journal of Statistical Software</em> 82 (3). <a href="https://doi.org/10.18637/jss.v082.i03">https://doi.org/10.18637/jss.v082.i03</a>.
</div>
<div id="ref-Mundlak.1978" class="csl-entry" role="listitem">
Mundlak, Yair. 1978. <span>âOn the <span>Pooling</span> of <span>Time Series</span> and <span>Cross Section Data</span>.â</span> <em>Econometrica</em> 46 (1): 69. <a href="https://doi.org/10.2307/1913646">https://doi.org/10.2307/1913646</a>.
</div>
<div id="ref-Ruttenauer.2022b" class="csl-entry" role="listitem">
RÃ¼ttenauer, Tobias, and Henning Best. 2022. <span>âPerceived Pollution and Selective Out-Migration: Revisiting the Role of Income for Environmental Inequality.â</span> <em>Journal of Ethnic and Migration Studies</em> 48 (15): 3505â23. <a href="https://doi.org/10.1080/1369183X.2022.2030211">https://doi.org/10.1080/1369183X.2022.2030211</a>.
</div>
<div id="ref-Solon.2015" class="csl-entry" role="listitem">
Solon, Gary, Steven J. Haider, and Jeffrey M. Wooldridge. 2015. <span>âWhat <span>Are We Weighting For</span>?â</span> <em>Journal of Human Resources</em> 50 (2): 301â16. <a href="https://doi.org/10.3368/jhr.50.2.301">https://doi.org/10.3368/jhr.50.2.301</a>.
</div>
<div id="ref-Wooldridge.2010" class="csl-entry" role="listitem">
Wooldridge, Jeffrey M. 2010. <em>Econometric <span>Analysis</span> of <span>Cross Section</span> and <span>Panel Data</span></em>. <span>Cambridge, Mass.</span>: <span>MIT Press</span>.
</div>
</div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "î§";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb71" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "1) Panel data methods"</span></span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: true</span></span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a><span class="an">output:</span><span class="co"> </span></span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a><span class="co">  html_document:</span></span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a><span class="co">    toc: true</span></span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a><span class="co">    toc_float: true</span></span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a><span class="co">    toc_depth: 2</span></span>
<span id="cb71-12"><a href="#cb71-12" aria-hidden="true" tabindex="-1"></a><span class="co">    number_sections: true</span></span>
<span id="cb71-13"><a href="#cb71-13" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span></span>
<span id="cb71-14"><a href="#cb71-14" aria-hidden="true" tabindex="-1"></a><span class="co">  - name: Tobias RÃ¼ttenauer</span></span>
<span id="cb71-15"><a href="#cb71-15" aria-hidden="true" tabindex="-1"></a><span class="co">    orcid:  0000-0001-5747-9735</span></span>
<span id="cb71-16"><a href="#cb71-16" aria-hidden="true" tabindex="-1"></a><span class="co">    email: t.ruttenauer@ucl.ac.uk</span></span>
<span id="cb71-17"><a href="#cb71-17" aria-hidden="true" tabindex="-1"></a><span class="co">    url: https://ruettenauer.github.io/</span></span>
<span id="cb71-18"><a href="#cb71-18" aria-hidden="true" tabindex="-1"></a><span class="co">    affiliations:</span></span>
<span id="cb71-19"><a href="#cb71-19" aria-hidden="true" tabindex="-1"></a><span class="co">      - name: UCL Social Research Institute</span></span>
<span id="cb71-20"><a href="#cb71-20" aria-hidden="true" tabindex="-1"></a><span class="co">        address: University College London</span></span>
<span id="cb71-21"><a href="#cb71-21" aria-hidden="true" tabindex="-1"></a><span class="co">        city: London WC1H 0AL</span></span>
<span id="cb71-22"><a href="#cb71-22" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb71-23"><a href="#cb71-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-24"><a href="#cb71-24" aria-hidden="true" tabindex="-1"></a>\newcommand{\Cov}{\mathrm{Cov}}</span>
<span id="cb71-25"><a href="#cb71-25" aria-hidden="true" tabindex="-1"></a>\newcommand{\Var}{\mathrm{Var}}</span>
<span id="cb71-26"><a href="#cb71-26" aria-hidden="true" tabindex="-1"></a>\newcommand{\tr}{\mathrm{tr}}</span>
<span id="cb71-27"><a href="#cb71-27" aria-hidden="true" tabindex="-1"></a>\newcommand{\plim}{\operatornamewithlimits{plim}}</span>
<span id="cb71-28"><a href="#cb71-28" aria-hidden="true" tabindex="-1"></a>\newcommand{\diag}{\mathrm{diag}}</span>
<span id="cb71-29"><a href="#cb71-29" aria-hidden="true" tabindex="-1"></a>\newcommand{\E}{\mathrm{E}}</span>
<span id="cb71-30"><a href="#cb71-30" aria-hidden="true" tabindex="-1"></a>\newcommand{\Prob}{\mathrm{Prob}}</span>
<span id="cb71-31"><a href="#cb71-31" aria-hidden="true" tabindex="-1"></a>\newcommand{\bm}<span class="co">[</span><span class="ot">1</span><span class="co">]</span>{\boldsymbol{\mathbf{#1}}}</span>
<span id="cb71-32"><a href="#cb71-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-33"><a href="#cb71-33" aria-hidden="true" tabindex="-1"></a><span class="fu">### Required packages</span></span>
<span id="cb71-34"><a href="#cb71-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-35"><a href="#cb71-35" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message = FALSE, warning = FALSE, results = 'hide'}</span></span>
<span id="cb71-36"><a href="#cb71-36" aria-hidden="true" tabindex="-1"></a>pkgs <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"plm"</span>, <span class="st">"lfe"</span>, <span class="st">"texreg"</span>, <span class="st">"tidyr"</span>, <span class="st">"dplyr"</span>, <span class="st">"lmtest"</span>, <span class="st">"sandwich"</span>, </span>
<span id="cb71-37"><a href="#cb71-37" aria-hidden="true" tabindex="-1"></a>          <span class="st">"ggplot2"</span>, <span class="st">"ggforce"</span>) </span>
<span id="cb71-38"><a href="#cb71-38" aria-hidden="true" tabindex="-1"></a><span class="fu">lapply</span>(pkgs, require, <span class="at">character.only =</span> <span class="cn">TRUE</span>)</span>
<span id="cb71-39"><a href="#cb71-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-40"><a href="#cb71-40" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb71-41"><a href="#cb71-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-42"><a href="#cb71-42" aria-hidden="true" tabindex="-1"></a><span class="fu">### Session info</span></span>
<span id="cb71-43"><a href="#cb71-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-46"><a href="#cb71-46" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb71-47"><a href="#cb71-47" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span>
<span id="cb71-48"><a href="#cb71-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-49"><a href="#cb71-49" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb71-50"><a href="#cb71-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-51"><a href="#cb71-51" aria-hidden="true" tabindex="-1"></a><span class="fu"># Outline</span></span>
<span id="cb71-52"><a href="#cb71-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-53"><a href="#cb71-53" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Panel data structure</span>
<span id="cb71-54"><a href="#cb71-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-55"><a href="#cb71-55" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Decomposing variance</span>
<span id="cb71-56"><a href="#cb71-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-57"><a href="#cb71-57" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Fixed Effects estimator</span>
<span id="cb71-58"><a href="#cb71-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-59"><a href="#cb71-59" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Random Effects estimator</span>
<span id="cb71-60"><a href="#cb71-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-61"><a href="#cb71-61" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Hybrid / Mundlak models</span>
<span id="cb71-62"><a href="#cb71-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-63"><a href="#cb71-63" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Statistical inference</span>
<span id="cb71-64"><a href="#cb71-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-65"><a href="#cb71-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-66"><a href="#cb71-66" aria-hidden="true" tabindex="-1"></a><span class="fu"># Panel data structure</span></span>
<span id="cb71-67"><a href="#cb71-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-68"><a href="#cb71-68" aria-hidden="true" tabindex="-1"></a>Usually cross-sectional data is organized as a matrix, where rows represent the obervation / individual and the columns hold the variables. In panel data settings, we need to add the dimension of time. There are two ways to do so:</span>
<span id="cb71-69"><a href="#cb71-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-70"><a href="#cb71-70" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Long format: $N \times T$ observations (rows), with variables "id" and "time".</span>
<span id="cb71-71"><a href="#cb71-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-72"><a href="#cb71-72" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Wide format: $N$ observations, and $T \times K$ variables, which one variable for each time-period.</span>
<span id="cb71-73"><a href="#cb71-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-74"><a href="#cb71-74" aria-hidden="true" tabindex="-1"></a>Let's have a look at the "Males" data of the <span class="in">`plm`</span> package.</span>
<span id="cb71-75"><a href="#cb71-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-78"><a href="#cb71-78" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb71-79"><a href="#cb71-79" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">"Males"</span>)</span>
<span id="cb71-80"><a href="#cb71-80" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(Males[,<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>], <span class="at">n =</span> <span class="dv">16</span>)</span>
<span id="cb71-81"><a href="#cb71-81" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb71-82"><a href="#cb71-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-83"><a href="#cb71-83" aria-hidden="true" tabindex="-1"></a>This is long format, with <span class="in">`nr`</span> as person identifier (id) and <span class="in">`year`</span> as time indicator. Long format is what we usually need for analysing data.</span>
<span id="cb71-84"><a href="#cb71-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-85"><a href="#cb71-85" aria-hidden="true" tabindex="-1"></a>Sometimes data comes in wide format. Luckily, we can easily switch between those formats using <span class="in">`tidyr`</span>.</span>
<span id="cb71-86"><a href="#cb71-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-89"><a href="#cb71-89" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb71-90"><a href="#cb71-90" aria-hidden="true" tabindex="-1"></a>Males_wide <span class="ot">&lt;-</span> <span class="fu">pivot_wider</span>(Males, <span class="at">id_cols =</span> nr, <span class="at">names_from =</span> year, </span>
<span id="cb71-91"><a href="#cb71-91" aria-hidden="true" tabindex="-1"></a>                          <span class="at">values_from =</span> <span class="dv">3</span><span class="sc">:</span><span class="fu">ncol</span>(Males), <span class="at">names_sep =</span> <span class="st">"_"</span>)</span>
<span id="cb71-92"><a href="#cb71-92" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(Males_wide[,<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>], <span class="at">n =</span> <span class="dv">16</span>)</span>
<span id="cb71-93"><a href="#cb71-93" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb71-94"><a href="#cb71-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-95"><a href="#cb71-95" aria-hidden="true" tabindex="-1"></a>And we can go back to long again:</span>
<span id="cb71-96"><a href="#cb71-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-99"><a href="#cb71-99" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb71-100"><a href="#cb71-100" aria-hidden="true" tabindex="-1"></a>Males_long <span class="ot">&lt;-</span> <span class="fu">pivot_longer</span>(Males_wide, <span class="at">cols =</span> <span class="dv">2</span><span class="sc">:</span><span class="fu">ncol</span>(Males_wide), </span>
<span id="cb71-101"><a href="#cb71-101" aria-hidden="true" tabindex="-1"></a>                           <span class="at">names_to =</span> <span class="fu">c</span>(<span class="st">".value"</span>, <span class="st">"year"</span>), </span>
<span id="cb71-102"><a href="#cb71-102" aria-hidden="true" tabindex="-1"></a>                           <span class="at">names_pattern =</span> <span class="st">"(.*)_(.*)"</span>)</span>
<span id="cb71-103"><a href="#cb71-103" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(Males_long[,<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>], <span class="at">n =</span> <span class="dv">16</span>)</span>
<span id="cb71-104"><a href="#cb71-104" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb71-105"><a href="#cb71-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-106"><a href="#cb71-106" aria-hidden="true" tabindex="-1"></a>Moreover, there two types of panel data:</span>
<span id="cb71-107"><a href="#cb71-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-108"><a href="#cb71-108" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Balanced: Contains information for each unit at each time period</span>
<span id="cb71-109"><a href="#cb71-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-110"><a href="#cb71-110" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Unbalanced: Some units have missing information at some time periods</span>
<span id="cb71-111"><a href="#cb71-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-114"><a href="#cb71-114" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb71-115"><a href="#cb71-115" aria-hidden="true" tabindex="-1"></a><span class="fu">is.pbalanced</span>(Males, <span class="at">index =</span> <span class="fu">c</span>(<span class="st">"nr"</span>, <span class="st">"year"</span>))</span>
<span id="cb71-116"><a href="#cb71-116" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb71-117"><a href="#cb71-117" aria-hidden="true" tabindex="-1"></a>In our example, we have balanced data (although there might still be NAs in the data).</span>
<span id="cb71-118"><a href="#cb71-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-119"><a href="#cb71-119" aria-hidden="true" tabindex="-1"></a>A nice feature of panel data is that we can do some within-person transformation. For instance we can calculate the lags and leads, or first differences of data. </span>
<span id="cb71-120"><a href="#cb71-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-121"><a href="#cb71-121" aria-hidden="true" tabindex="-1"></a>::: {.callout-note}</span>
<span id="cb71-122"><a href="#cb71-122" aria-hidden="true" tabindex="-1"></a>always make sure the data is sorted properly before you do!</span>
<span id="cb71-123"><a href="#cb71-123" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb71-124"><a href="#cb71-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-125"><a href="#cb71-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-128"><a href="#cb71-128" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb71-129"><a href="#cb71-129" aria-hidden="true" tabindex="-1"></a><span class="co"># Order data</span></span>
<span id="cb71-130"><a href="#cb71-130" aria-hidden="true" tabindex="-1"></a>Males <span class="ot">&lt;-</span> Males[<span class="fu">order</span>(Males<span class="sc">$</span>nr, Males<span class="sc">$</span>year),]</span>
<span id="cb71-131"><a href="#cb71-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-132"><a href="#cb71-132" aria-hidden="true" tabindex="-1"></a><span class="co"># Person specific means</span></span>
<span id="cb71-133"><a href="#cb71-133" aria-hidden="true" tabindex="-1"></a>Males<span class="sc">$</span>m_wage <span class="ot">&lt;-</span> <span class="fu">ave</span>(Males<span class="sc">$</span>wage,</span>
<span id="cb71-134"><a href="#cb71-134" aria-hidden="true" tabindex="-1"></a>                    Males<span class="sc">$</span>nr,</span>
<span id="cb71-135"><a href="#cb71-135" aria-hidden="true" tabindex="-1"></a>                    <span class="at">FUN =</span> <span class="cf">function</span>(x) <span class="fu">mean</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb71-136"><a href="#cb71-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-137"><a href="#cb71-137" aria-hidden="true" tabindex="-1"></a><span class="co"># Lag (last years value)</span></span>
<span id="cb71-138"><a href="#cb71-138" aria-hidden="true" tabindex="-1"></a>Males<span class="sc">$</span>lag_wage <span class="ot">&lt;-</span> <span class="fu">ave</span>(Males<span class="sc">$</span>wage,</span>
<span id="cb71-139"><a href="#cb71-139" aria-hidden="true" tabindex="-1"></a>                      Males<span class="sc">$</span>nr,</span>
<span id="cb71-140"><a href="#cb71-140" aria-hidden="true" tabindex="-1"></a>                      <span class="at">FUN =</span> <span class="cf">function</span>(x) dplyr<span class="sc">::</span><span class="fu">lag</span>(x, <span class="at">n =</span> <span class="dv">1</span>))</span>
<span id="cb71-141"><a href="#cb71-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-142"><a href="#cb71-142" aria-hidden="true" tabindex="-1"></a><span class="co"># Lead (next years value)</span></span>
<span id="cb71-143"><a href="#cb71-143" aria-hidden="true" tabindex="-1"></a>Males<span class="sc">$</span>lead_wage <span class="ot">&lt;-</span> <span class="fu">ave</span>(Males<span class="sc">$</span>wage,</span>
<span id="cb71-144"><a href="#cb71-144" aria-hidden="true" tabindex="-1"></a>                      Males<span class="sc">$</span>nr,</span>
<span id="cb71-145"><a href="#cb71-145" aria-hidden="true" tabindex="-1"></a>                      <span class="at">FUN =</span> <span class="cf">function</span>(x) dplyr<span class="sc">::</span><span class="fu">lead</span>(x, <span class="at">n =</span> <span class="dv">1</span>))</span>
<span id="cb71-146"><a href="#cb71-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-147"><a href="#cb71-147" aria-hidden="true" tabindex="-1"></a><span class="co"># First difference (this years value minus last years value)</span></span>
<span id="cb71-148"><a href="#cb71-148" aria-hidden="true" tabindex="-1"></a>Males<span class="sc">$</span>fd_wage <span class="ot">&lt;-</span> <span class="fu">ave</span>(Males<span class="sc">$</span>wage,</span>
<span id="cb71-149"><a href="#cb71-149" aria-hidden="true" tabindex="-1"></a>                      Males<span class="sc">$</span>nr,</span>
<span id="cb71-150"><a href="#cb71-150" aria-hidden="true" tabindex="-1"></a>                      <span class="at">FUN =</span> <span class="cf">function</span>(x) x <span class="sc">-</span> dplyr<span class="sc">::</span><span class="fu">lag</span>(x, <span class="at">n =</span> <span class="dv">1</span>))</span>
<span id="cb71-151"><a href="#cb71-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-152"><a href="#cb71-152" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(Males[, <span class="fu">c</span>(<span class="st">"nr"</span>, <span class="st">"year"</span>, <span class="st">"wage"</span>, <span class="st">"m_wage"</span>, <span class="st">"lag_wage"</span>, <span class="st">"lead_wage"</span>, <span class="st">"fd_wage"</span>)], <span class="at">n =</span> <span class="dv">16</span>)</span>
<span id="cb71-153"><a href="#cb71-153" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb71-154"><a href="#cb71-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-155"><a href="#cb71-155" aria-hidden="true" tabindex="-1"></a>There are a lot of different panel data sources available. Some examples are:</span>
<span id="cb71-156"><a href="#cb71-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-157"><a href="#cb71-157" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="co">[</span><span class="ot">PSID</span><span class="co">](https://psidonline.isr.umich.edu/)</span></span>
<span id="cb71-158"><a href="#cb71-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-159"><a href="#cb71-159" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="co">[</span><span class="ot">National Longitudinal Survey of Youth</span><span class="co">](https://www.nlsinfo.org/content/cohorts/nlsy79)</span></span>
<span id="cb71-160"><a href="#cb71-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-161"><a href="#cb71-161" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="co">[</span><span class="ot">Understanding Society</span><span class="co">](https://www.understandingsociety.ac.uk/)</span></span>
<span id="cb71-162"><a href="#cb71-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-163"><a href="#cb71-163" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="co">[</span><span class="ot">Millennium Cohort Study</span><span class="co">](https://cls.ucl.ac.uk/cls-studies/millennium-cohort-study/)</span></span>
<span id="cb71-164"><a href="#cb71-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-165"><a href="#cb71-165" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="co">[</span><span class="ot">SOEP</span><span class="co">](https://www.diw.de/en/diw_01.c.615551.en/research_infrastructure__socio-economic_panel__soep.html)</span></span>
<span id="cb71-166"><a href="#cb71-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-167"><a href="#cb71-167" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="co">[</span><span class="ot">Pairfam</span><span class="co">](https://www.pairfam.de/)</span></span>
<span id="cb71-168"><a href="#cb71-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-169"><a href="#cb71-169" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="co">[</span><span class="ot">SHARE</span><span class="co">](http://www.share-project.org/home0.html)</span></span>
<span id="cb71-170"><a href="#cb71-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-171"><a href="#cb71-171" aria-hidden="true" tabindex="-1"></a>And there are various process generated data having a longitudinal / panel dimension as well. For instance:</span>
<span id="cb71-172"><a href="#cb71-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-173"><a href="#cb71-173" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="co">[</span><span class="ot">Our world in data COVID</span><span class="co">](https://github.com/owid/covid-19-data)</span></span>
<span id="cb71-174"><a href="#cb71-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-175"><a href="#cb71-175" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="co">[</span><span class="ot">UK Census</span><span class="co">](https://www.nomisweb.co.uk/sources/census)</span></span>
<span id="cb71-176"><a href="#cb71-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-177"><a href="#cb71-177" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="co">[</span><span class="ot">London Air Pollution</span><span class="co">](https://data.london.gov.uk/air-quality/)</span></span>
<span id="cb71-178"><a href="#cb71-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-179"><a href="#cb71-179" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="co">[</span><span class="ot">European Tree Cover Density</span><span class="co">](https://land.copernicus.eu/pan-european/high-resolution-layers/forests/tree-cover-density/status-maps)</span></span>
<span id="cb71-180"><a href="#cb71-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-181"><a href="#cb71-181" aria-hidden="true" tabindex="-1"></a>One thing that is often difficult: Many panel data come as a bunch of single (cross-sectional) files and have to be combined into a single dataset. However, many data providers (or nice colleagues) now offer simplified long-format data or pre-written scripts to merge data across waves (e.g. <span class="co">[</span><span class="ot">here</span><span class="co">](https://www.understandingsociety.ac.uk/documentation/mainstage/syntax)</span> for Understanding Society, or <span class="co">[</span><span class="ot">here</span><span class="co">](https://www.ls3.soziologie.uni-muenchen.de/studium-lehre/lehrmaterialien/index.html)</span> for SOEP).</span>
<span id="cb71-182"><a href="#cb71-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-183"><a href="#cb71-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-184"><a href="#cb71-184" aria-hidden="true" tabindex="-1"></a>A second problem is panel attrition. Usually, the number of individuals participating repeatedly goes down over time.</span>
<span id="cb71-185"><a href="#cb71-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-186"><a href="#cb71-186" aria-hidden="true" tabindex="-1"></a><span class="al">![Rainer Siegers, Veronika Belcheva, Tobias Silbermann 2020: https://www.diw.de/documents/publikationen/73/diw_01.c.745900.de/diw_ssp0826.pdf](fig/soep.PNG)</span></span>
<span id="cb71-187"><a href="#cb71-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-188"><a href="#cb71-188" aria-hidden="true" tabindex="-1"></a>The main question here: Is attrition (as good as) random or are drop-outs systematic? How does this affect the sample composition and representativeness?</span>
<span id="cb71-189"><a href="#cb71-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-190"><a href="#cb71-190" aria-hidden="true" tabindex="-1"></a>Most panels also provide inverse-probability of staying weights to account for the possibility of non-random attrition. Note that these also probability weights can only account for attrition based on observables. For a general discussion about weighting see for instance @Solon.2015.</span>
<span id="cb71-191"><a href="#cb71-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-192"><a href="#cb71-192" aria-hidden="true" tabindex="-1"></a><span class="fu"># Decomposing variance</span></span>
<span id="cb71-193"><a href="#cb71-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-194"><a href="#cb71-194" aria-hidden="true" tabindex="-1"></a>Let's clarify the idea and advantage of panel data with an example. Assume we want to know the relationship between age (as our independent variable) and happiness (as our dependent variable), and we have data on 24 observations.</span>
<span id="cb71-195"><a href="#cb71-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-196"><a href="#cb71-196" aria-hidden="true" tabindex="-1"></a><span class="in">```{r class.source = 'fold-hide', message = FALSE, warning = FALSE}</span></span>
<span id="cb71-197"><a href="#cb71-197" aria-hidden="true" tabindex="-1"></a><span class="do">################################</span></span>
<span id="cb71-198"><a href="#cb71-198" aria-hidden="true" tabindex="-1"></a><span class="do">### Example 1: Age happiness </span><span class="al">###</span></span>
<span id="cb71-199"><a href="#cb71-199" aria-hidden="true" tabindex="-1"></a><span class="do">################################</span></span>
<span id="cb71-200"><a href="#cb71-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-201"><a href="#cb71-201" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">213</span>)</span>
<span id="cb71-202"><a href="#cb71-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-203"><a href="#cb71-203" aria-hidden="true" tabindex="-1"></a><span class="do">### Data simulation program</span></span>
<span id="cb71-204"><a href="#cb71-204" aria-hidden="true" tabindex="-1"></a>simdata <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">N =</span> <span class="dv">6</span>, <span class="at">T =</span> <span class="dv">4</span>,</span>
<span id="cb71-205"><a href="#cb71-205" aria-hidden="true" tabindex="-1"></a>                    <span class="at">age_range =</span> <span class="fu">c</span>(<span class="dv">20</span><span class="sc">:</span><span class="dv">60</span>), </span>
<span id="cb71-206"><a href="#cb71-206" aria-hidden="true" tabindex="-1"></a>                    <span class="at">u_sd =</span> <span class="fl">0.2</span>, <span class="at">uw_sd =</span> <span class="dv">0</span>){</span>
<span id="cb71-207"><a href="#cb71-207" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb71-208"><a href="#cb71-208" aria-hidden="true" tabindex="-1"></a>  <span class="co"># id and wave</span></span>
<span id="cb71-209"><a href="#cb71-209" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">nrow =</span> N<span class="sc">*</span>T))</span>
<span id="cb71-210"><a href="#cb71-210" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(df) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"id"</span>, <span class="st">"time"</span>)</span>
<span id="cb71-211"><a href="#cb71-211" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb71-212"><a href="#cb71-212" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>id <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>N, <span class="at">each =</span> T)</span>
<span id="cb71-213"><a href="#cb71-213" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>time <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>T, <span class="at">times =</span> N)</span>
<span id="cb71-214"><a href="#cb71-214" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>idname <span class="ot">&lt;-</span> <span class="fu">factor</span>(df<span class="sc">$</span>id, <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span>N), <span class="at">labels =</span> <span class="fu">paste</span>(<span class="st">"Person"</span>, <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span>N)))</span>
<span id="cb71-215"><a href="#cb71-215" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb71-216"><a href="#cb71-216" aria-hidden="true" tabindex="-1"></a>  <span class="co"># age</span></span>
<span id="cb71-217"><a href="#cb71-217" aria-hidden="true" tabindex="-1"></a>  startingage <span class="ot">&lt;-</span> age_range</span>
<span id="cb71-218"><a href="#cb71-218" aria-hidden="true" tabindex="-1"></a>  startingage <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">quantile</span>(startingage, <span class="at">probs =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span><span class="sc">/</span>(N<span class="dv">-1</span>))), <span class="dv">0</span>)</span>
<span id="cb71-219"><a href="#cb71-219" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>age <span class="ot">&lt;-</span> <span class="fu">unname</span>(<span class="fu">rep</span>(startingage, <span class="at">each =</span> T)) <span class="sc">+</span> df<span class="sc">$</span>time<span class="sc">*</span><span class="dv">2</span></span>
<span id="cb71-220"><a href="#cb71-220" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb71-221"><a href="#cb71-221" aria-hidden="true" tabindex="-1"></a>  <span class="co"># cohort </span></span>
<span id="cb71-222"><a href="#cb71-222" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>cohort <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb71-223"><a href="#cb71-223" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>cohort[(N<span class="sc">*</span>T<span class="sc">/</span><span class="dv">2</span> <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(N<span class="sc">*</span>T)] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb71-224"><a href="#cb71-224" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>cohort <span class="ot">&lt;-</span> <span class="fu">factor</span>(df<span class="sc">$</span>cohort, <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), </span>
<span id="cb71-225"><a href="#cb71-225" aria-hidden="true" tabindex="-1"></a>                      <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Younger cohort"</span>, <span class="st">"Older cohort"</span>))</span>
<span id="cb71-226"><a href="#cb71-226" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb71-227"><a href="#cb71-227" aria-hidden="true" tabindex="-1"></a>  <span class="co"># demeaned age</span></span>
<span id="cb71-228"><a href="#cb71-228" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>dm_age <span class="ot">&lt;-</span> df<span class="sc">$</span>age <span class="sc">-</span> <span class="fu">ave</span>(df<span class="sc">$</span>age, df<span class="sc">$</span>id, <span class="at">FUN =</span> <span class="cf">function</span>(x) <span class="fu">mean</span>(x)) </span>
<span id="cb71-229"><a href="#cb71-229" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb71-230"><a href="#cb71-230" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Personal intercept</span></span>
<span id="cb71-231"><a href="#cb71-231" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>intercept <span class="ot">&lt;-</span> <span class="dv">5</span> <span class="sc">+</span> <span class="fl">0.5</span> <span class="sc">*</span> df<span class="sc">$</span>id</span>
<span id="cb71-232"><a href="#cb71-232" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb71-233"><a href="#cb71-233" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Overall error</span></span>
<span id="cb71-234"><a href="#cb71-234" aria-hidden="true" tabindex="-1"></a>  u <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N<span class="sc">*</span>T, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> u_sd)</span>
<span id="cb71-235"><a href="#cb71-235" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb71-236"><a href="#cb71-236" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Additional within error</span></span>
<span id="cb71-237"><a href="#cb71-237" aria-hidden="true" tabindex="-1"></a>  uw <span class="ot">&lt;-</span> <span class="fu">unlist</span>(<span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>N, <span class="cf">function</span>(x) <span class="fu">rnorm</span>(T, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> uw_sd)))</span>
<span id="cb71-238"><a href="#cb71-238" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb71-239"><a href="#cb71-239" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Gen happiness</span></span>
<span id="cb71-240"><a href="#cb71-240" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">+</span> <span class="fl">0.05</span> <span class="sc">*</span> df<span class="sc">$</span>age <span class="sc">-</span> <span class="fl">0.2</span> <span class="sc">*</span> df<span class="sc">$</span>dm_age <span class="sc">+</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fu">as.numeric</span>(df<span class="sc">$</span>cohort) <span class="sc">+</span> u <span class="sc">+</span> uw</span>
<span id="cb71-241"><a href="#cb71-241" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>happiness <span class="ot">&lt;-</span> y</span>
<span id="cb71-242"><a href="#cb71-242" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb71-243"><a href="#cb71-243" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Gen person means</span></span>
<span id="cb71-244"><a href="#cb71-244" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>m_age <span class="ot">&lt;-</span> <span class="fu">ave</span>(df<span class="sc">$</span>age, df<span class="sc">$</span>id, <span class="at">FUN =</span> <span class="cf">function</span>(x) <span class="fu">mean</span>(x)) </span>
<span id="cb71-245"><a href="#cb71-245" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>m_happiness <span class="ot">&lt;-</span> <span class="fu">ave</span>(df<span class="sc">$</span>happiness, df<span class="sc">$</span>id, <span class="at">FUN =</span> <span class="cf">function</span>(x) <span class="fu">mean</span>(x)) </span>
<span id="cb71-246"><a href="#cb71-246" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb71-247"><a href="#cb71-247" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(df)</span>
<span id="cb71-248"><a href="#cb71-248" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb71-249"><a href="#cb71-249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-250"><a href="#cb71-250" aria-hidden="true" tabindex="-1"></a><span class="do">### Set up six individuals with age and happiness</span></span>
<span id="cb71-251"><a href="#cb71-251" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">6</span></span>
<span id="cb71-252"><a href="#cb71-252" aria-hidden="true" tabindex="-1"></a>T <span class="ot">&lt;-</span> <span class="dv">4</span></span>
<span id="cb71-253"><a href="#cb71-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-254"><a href="#cb71-254" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">simdata</span>(<span class="at">N =</span> N, <span class="at">T =</span> T)</span>
<span id="cb71-255"><a href="#cb71-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-256"><a href="#cb71-256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-257"><a href="#cb71-257" aria-hidden="true" tabindex="-1"></a><span class="co"># Total line for plot</span></span>
<span id="cb71-258"><a href="#cb71-258" aria-hidden="true" tabindex="-1"></a>lm1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(happiness <span class="sc">~</span> age, <span class="at">data =</span> df)</span>
<span id="cb71-259"><a href="#cb71-259" aria-hidden="true" tabindex="-1"></a>lm2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(happiness <span class="sc">~</span> age <span class="sc">+</span> cohort, <span class="at">data =</span> df)</span>
<span id="cb71-260"><a href="#cb71-260" aria-hidden="true" tabindex="-1"></a>lm3 <span class="ot">&lt;-</span> <span class="fu">lm</span>(happiness <span class="sc">~</span> age <span class="sc">+</span> idname, <span class="at">data =</span> df)</span>
<span id="cb71-261"><a href="#cb71-261" aria-hidden="true" tabindex="-1"></a>lm4 <span class="ot">&lt;-</span> <span class="fu">lm</span>(m_happiness <span class="sc">~</span> m_age, <span class="at">data =</span> df)</span>
<span id="cb71-262"><a href="#cb71-262" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb71-263"><a href="#cb71-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-264"><a href="#cb71-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-265"><a href="#cb71-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-266"><a href="#cb71-266" aria-hidden="true" tabindex="-1"></a><span class="fu">## Cross-sectional setting</span></span>
<span id="cb71-267"><a href="#cb71-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-268"><a href="#cb71-268" aria-hidden="true" tabindex="-1"></a>In a cross-sectional setting, we could just run a standard linear regression model using Omitted Least Squares (OLS) of the form</span>
<span id="cb71-269"><a href="#cb71-269" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb71-270"><a href="#cb71-270" aria-hidden="true" tabindex="-1"></a>y_{i} = \alpha + \beta_1 x_{i} + \upsilon_{i},</span>
<span id="cb71-271"><a href="#cb71-271" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb71-272"><a href="#cb71-272" aria-hidden="true" tabindex="-1"></a>where $y_{i}$ is the dependent variable (happiness) and $x_i$ the independent variable of each observation $i \in <span class="sc">\{</span>1, \dots, 24<span class="sc">\}</span>$. $\beta_1$ is the coefficient of interest, $\alpha$ the overall intercept and $\upsilon_{i}$ the error term.</span>
<span id="cb71-273"><a href="#cb71-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-276"><a href="#cb71-276" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb71-277"><a href="#cb71-277" aria-hidden="true" tabindex="-1"></a>lm1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(happiness <span class="sc">~</span> age, <span class="at">data =</span> df)</span>
<span id="cb71-278"><a href="#cb71-278" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(lm1)</span>
<span id="cb71-279"><a href="#cb71-279" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb71-280"><a href="#cb71-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-281"><a href="#cb71-281" aria-hidden="true" tabindex="-1"></a>This indicates a positive relation between age and happiness. Graphically, this would look like:</span>
<span id="cb71-282"><a href="#cb71-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-283"><a href="#cb71-283" aria-hidden="true" tabindex="-1"></a><span class="in">```{r class.source = 'fold-hide', message = FALSE, warning = FALSE}</span></span>
<span id="cb71-284"><a href="#cb71-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-285"><a href="#cb71-285" aria-hidden="true" tabindex="-1"></a><span class="co"># The palette with black:</span></span>
<span id="cb71-286"><a href="#cb71-286" aria-hidden="true" tabindex="-1"></a>cbp2 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"#000000"</span>, </span>
<span id="cb71-287"><a href="#cb71-287" aria-hidden="true" tabindex="-1"></a>          <span class="st">"#E69F00"</span>, </span>
<span id="cb71-288"><a href="#cb71-288" aria-hidden="true" tabindex="-1"></a>          <span class="st">"#56B4E9"</span>, </span>
<span id="cb71-289"><a href="#cb71-289" aria-hidden="true" tabindex="-1"></a>          <span class="st">"#009E73"</span>,</span>
<span id="cb71-290"><a href="#cb71-290" aria-hidden="true" tabindex="-1"></a>          <span class="st">"#F0E442"</span>, </span>
<span id="cb71-291"><a href="#cb71-291" aria-hidden="true" tabindex="-1"></a>          <span class="st">"#0072B2"</span>, </span>
<span id="cb71-292"><a href="#cb71-292" aria-hidden="true" tabindex="-1"></a>          <span class="st">"#D55E00"</span>, </span>
<span id="cb71-293"><a href="#cb71-293" aria-hidden="true" tabindex="-1"></a>          <span class="st">"#CC79A7"</span>)</span>
<span id="cb71-294"><a href="#cb71-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-295"><a href="#cb71-295" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the residual values</span></span>
<span id="cb71-296"><a href="#cb71-296" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>predicted <span class="ot">&lt;-</span> <span class="fu">predict</span>(lm1)</span>
<span id="cb71-297"><a href="#cb71-297" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>residuals <span class="ot">&lt;-</span> <span class="fu">residuals</span>(lm1)</span>
<span id="cb71-298"><a href="#cb71-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-299"><a href="#cb71-299" aria-hidden="true" tabindex="-1"></a>zp1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df, <span class="fu">aes</span>(age, happiness)) <span class="sc">+</span></span>
<span id="cb71-300"><a href="#cb71-300" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>( <span class="fu">aes</span>(<span class="at">x =</span> age, <span class="at">y =</span> happiness), <span class="at">size =</span> <span class="dv">2</span>, <span class="at">stroke =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb71-301"><a href="#cb71-301" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">'lm'</span>, <span class="at">formula =</span> y <span class="sc">~</span> x, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">color  =</span> <span class="st">"deeppink"</span>) <span class="sc">+</span></span>
<span id="cb71-302"><a href="#cb71-302" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_segment</span>(<span class="at">data =</span> df, <span class="fu">aes</span>(<span class="at">xend =</span> age, <span class="at">yend =</span> predicted), </span>
<span id="cb71-303"><a href="#cb71-303" aria-hidden="true" tabindex="-1"></a>               <span class="at">alpha =</span> .<span class="dv">3</span>, <span class="at">color =</span> <span class="st">"purple"</span>) <span class="sc">+</span></span>
<span id="cb71-304"><a href="#cb71-304" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="fl">3.3</span>, <span class="fl">9.2</span>) <span class="sc">+</span> <span class="fu">expand_limits</span>(<span class="at">y =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span> </span>
<span id="cb71-305"><a href="#cb71-305" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb71-306"><a href="#cb71-306" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.key =</span> <span class="fu">element_blank</span>(), <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb71-307"><a href="#cb71-307" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.95</span>,<span class="fl">0.05</span>), <span class="at">legend.justification =</span> <span class="fu">c</span>(<span class="st">"right"</span>, <span class="st">"bottom"</span>),</span>
<span id="cb71-308"><a href="#cb71-308" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb71-309"><a href="#cb71-309" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.box.background =</span> <span class="fu">element_rect</span>(<span class="at">colour =</span> <span class="st">"black"</span>))</span>
<span id="cb71-310"><a href="#cb71-310" aria-hidden="true" tabindex="-1"></a>zp1  </span>
<span id="cb71-311"><a href="#cb71-311" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb71-312"><a href="#cb71-312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-313"><a href="#cb71-313" aria-hidden="true" tabindex="-1"></a>Obviously, we might suspect some other characteristics to influence our results. For instance, birth cohort might be a potential confounder that affects age and happiness. We can easily add a control for the cohort to account for this possibility. We would then estimate the model  </span>
<span id="cb71-314"><a href="#cb71-314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-315"><a href="#cb71-315" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb71-316"><a href="#cb71-316" aria-hidden="true" tabindex="-1"></a>y_{i} = \alpha + \beta_1 x_{i} + \beta_2 z_{it} + \upsilon_{i},</span>
<span id="cb71-317"><a href="#cb71-317" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb71-318"><a href="#cb71-318" aria-hidden="true" tabindex="-1"></a>where $z_i$ is the control variable or confounder (cohort).</span>
<span id="cb71-319"><a href="#cb71-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-322"><a href="#cb71-322" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb71-323"><a href="#cb71-323" aria-hidden="true" tabindex="-1"></a>lm2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(happiness <span class="sc">~</span> age <span class="sc">+</span> cohort, <span class="at">data =</span> df)</span>
<span id="cb71-324"><a href="#cb71-324" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(lm2)</span>
<span id="cb71-325"><a href="#cb71-325" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb71-326"><a href="#cb71-326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-327"><a href="#cb71-327" aria-hidden="true" tabindex="-1"></a>As a result, the effect of age becomes weaker. Graphically, this would look like:</span>
<span id="cb71-328"><a href="#cb71-328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-329"><a href="#cb71-329" aria-hidden="true" tabindex="-1"></a><span class="in">```{r class.source = 'fold-hide', message = FALSE, warning = FALSE}</span></span>
<span id="cb71-330"><a href="#cb71-330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-331"><a href="#cb71-331" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the residual values</span></span>
<span id="cb71-332"><a href="#cb71-332" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="fu">unique</span>(df<span class="sc">$</span>cohort)){</span>
<span id="cb71-333"><a href="#cb71-333" aria-hidden="true" tabindex="-1"></a>  oo <span class="ot">&lt;-</span> <span class="fu">which</span>(df<span class="sc">$</span>cohort <span class="sc">==</span> i)</span>
<span id="cb71-334"><a href="#cb71-334" aria-hidden="true" tabindex="-1"></a>  lmt <span class="ot">&lt;-</span> <span class="fu">lm</span>(happiness <span class="sc">~</span> age, <span class="at">data =</span> df[oo, ])</span>
<span id="cb71-335"><a href="#cb71-335" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>predicted[oo] <span class="ot">&lt;-</span> <span class="fu">predict</span>(lmt)</span>
<span id="cb71-336"><a href="#cb71-336" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>residuals[oo] <span class="ot">&lt;-</span> <span class="fu">residuals</span>(lmt)</span>
<span id="cb71-337"><a href="#cb71-337" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb71-338"><a href="#cb71-338" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-339"><a href="#cb71-339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-340"><a href="#cb71-340" aria-hidden="true" tabindex="-1"></a>zp2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df, <span class="fu">aes</span>(age, happiness)) <span class="sc">+</span></span>
<span id="cb71-341"><a href="#cb71-341" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> age, <span class="at">y =</span> happiness, <span class="at">shape =</span> cohort, <span class="at">colour =</span> cohort), </span>
<span id="cb71-342"><a href="#cb71-342" aria-hidden="true" tabindex="-1"></a>              <span class="at">size =</span> <span class="dv">2</span>, <span class="at">stroke =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb71-343"><a href="#cb71-343" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">'lm'</span>, <span class="at">formula =</span> y <span class="sc">~</span> x, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>,</span>
<span id="cb71-344"><a href="#cb71-344" aria-hidden="true" tabindex="-1"></a>              <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">colour =</span> cohort, <span class="at">linetype =</span> cohort)) <span class="sc">+</span>  </span>
<span id="cb71-345"><a href="#cb71-345" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_segment</span>(<span class="at">data =</span> df, <span class="fu">aes</span>(<span class="at">xend =</span> age, <span class="at">yend =</span> predicted), </span>
<span id="cb71-346"><a href="#cb71-346" aria-hidden="true" tabindex="-1"></a>               <span class="at">alpha =</span> .<span class="dv">3</span>, <span class="at">color =</span> <span class="st">"purple"</span>) <span class="sc">+</span></span>
<span id="cb71-347"><a href="#cb71-347" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">intercept =</span> lm2<span class="sc">$</span>coefficients[<span class="dv">1</span>] <span class="sc">+</span> <span class="fl">0.5</span> <span class="sc">*</span> lm2<span class="sc">$</span>coefficients[<span class="dv">3</span>], </span>
<span id="cb71-348"><a href="#cb71-348" aria-hidden="true" tabindex="-1"></a>                               <span class="at">slope =</span> lm2<span class="sc">$</span>coefficients[<span class="dv">2</span>], <span class="at">color  =</span> <span class="st">"deeppink"</span>) <span class="sc">+</span>  </span>
<span id="cb71-349"><a href="#cb71-349" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="fl">3.3</span>, <span class="fl">9.2</span>) <span class="sc">+</span> <span class="fu">expand_limits</span>(<span class="at">y =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span> </span>
<span id="cb71-350"><a href="#cb71-350" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_manual</span>(<span class="at">values =</span> cbp2[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>)]) <span class="sc">+</span> </span>
<span id="cb71-351"><a href="#cb71-351" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> cbp2[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>)]) <span class="sc">+</span> </span>
<span id="cb71-352"><a href="#cb71-352" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_shape_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="dv">15</span><span class="sc">:</span><span class="dv">18</span>, <span class="dv">25</span>, <span class="dv">20</span>)) <span class="sc">+</span></span>
<span id="cb71-353"><a href="#cb71-353" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb71-354"><a href="#cb71-354" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.key =</span> <span class="fu">element_blank</span>(), <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb71-355"><a href="#cb71-355" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.95</span>,<span class="fl">0.05</span>), <span class="at">legend.justification =</span> <span class="fu">c</span>(<span class="st">"right"</span>, <span class="st">"bottom"</span>),</span>
<span id="cb71-356"><a href="#cb71-356" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb71-357"><a href="#cb71-357" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.box.background =</span> <span class="fu">element_rect</span>(<span class="at">colour =</span> <span class="st">"black"</span>))</span>
<span id="cb71-358"><a href="#cb71-358" aria-hidden="true" tabindex="-1"></a>zp2  </span>
<span id="cb71-359"><a href="#cb71-359" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb71-360"><a href="#cb71-360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-361"><a href="#cb71-361" aria-hidden="true" tabindex="-1"></a>So, what we basically receive here is the (weighted) average effect within each birth cohort. We use only similar observations (in terms of cohort) to estimate our effect of interest - the correlation between age and happiness. If we add any controls, we always decompose the variance which contributes to our estimator, and we eliminate the variance that is attributed to the confounder / control variable.</span>
<span id="cb71-362"><a href="#cb71-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-363"><a href="#cb71-363" aria-hidden="true" tabindex="-1"></a><span class="al">![Illustration by @Huntington-Klein.2021: Introducing a binary control variable](fig/NHK_Control.gif)</span></span>
<span id="cb71-364"><a href="#cb71-364" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-365"><a href="#cb71-365" aria-hidden="true" tabindex="-1"></a><span class="fu">## Panel data setting</span></span>
<span id="cb71-366"><a href="#cb71-366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-367"><a href="#cb71-367" aria-hidden="true" tabindex="-1"></a>Now, with panel data, we can even go a step further. Assume we would not have observed 24 independent observations, but rather 6 independent individuals (N = 6) at 4 time-points each (T = 4). </span>
<span id="cb71-368"><a href="#cb71-368" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-369"><a href="#cb71-369" aria-hidden="true" tabindex="-1"></a><span class="in">```{r class.source = 'fold-hide', message = FALSE, warning = FALSE}</span></span>
<span id="cb71-370"><a href="#cb71-370" aria-hidden="true" tabindex="-1"></a>zp3 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df, <span class="fu">aes</span>(age, happiness)) <span class="sc">+</span></span>
<span id="cb71-371"><a href="#cb71-371" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>( <span class="fu">aes</span>(<span class="at">x =</span> age, <span class="at">y =</span> happiness, <span class="at">shape =</span> idname, <span class="at">colour =</span> idname, <span class="at">fill =</span> idname), </span>
<span id="cb71-372"><a href="#cb71-372" aria-hidden="true" tabindex="-1"></a>              <span class="at">size =</span> <span class="dv">2</span>, <span class="at">stroke =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb71-373"><a href="#cb71-373" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="fl">3.3</span>, <span class="fl">9.2</span>) <span class="sc">+</span> <span class="fu">expand_limits</span>(<span class="at">y =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span> </span>
<span id="cb71-374"><a href="#cb71-374" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_manual</span>(<span class="at">values =</span> cbp2[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>)]) <span class="sc">+</span> </span>
<span id="cb71-375"><a href="#cb71-375" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> cbp2[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>)]) <span class="sc">+</span> </span>
<span id="cb71-376"><a href="#cb71-376" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_shape_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="dv">15</span><span class="sc">:</span><span class="dv">18</span>, <span class="dv">25</span>, <span class="dv">20</span>)) <span class="sc">+</span></span>
<span id="cb71-377"><a href="#cb71-377" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb71-378"><a href="#cb71-378" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.key =</span> <span class="fu">element_blank</span>(), <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb71-379"><a href="#cb71-379" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.95</span>,<span class="fl">0.05</span>), <span class="at">legend.justification =</span> <span class="fu">c</span>(<span class="st">"right"</span>, <span class="st">"bottom"</span>),</span>
<span id="cb71-380"><a href="#cb71-380" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb71-381"><a href="#cb71-381" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.box.background =</span> <span class="fu">element_rect</span>(<span class="at">colour =</span> <span class="st">"black"</span>))</span>
<span id="cb71-382"><a href="#cb71-382" aria-hidden="true" tabindex="-1"></a>zp3 </span>
<span id="cb71-383"><a href="#cb71-383" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb71-384"><a href="#cb71-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-385"><a href="#cb71-385" aria-hidden="true" tabindex="-1"></a>We can then decompose the available variance into three different parts:</span>
<span id="cb71-386"><a href="#cb71-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-387"><a href="#cb71-387" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Pooled variance</span>
<span id="cb71-388"><a href="#cb71-388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-389"><a href="#cb71-389" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Between variance</span>
<span id="cb71-390"><a href="#cb71-390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-391"><a href="#cb71-391" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Within variance</span>
<span id="cb71-392"><a href="#cb71-392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-393"><a href="#cb71-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-394"><a href="#cb71-394" aria-hidden="true" tabindex="-1"></a><span class="fu">### Pooled estimator</span></span>
<span id="cb71-395"><a href="#cb71-395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-396"><a href="#cb71-396" aria-hidden="true" tabindex="-1"></a>The pooled estimator equals what we have seen in the cross-sectional example: we basically assume that we have 24 independent observations and we ignore the person and time dimension. The Pooled OLS estimator is simply:</span>
<span id="cb71-397"><a href="#cb71-397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-398"><a href="#cb71-398" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb71-399"><a href="#cb71-399" aria-hidden="true" tabindex="-1"></a>y_{it} = \alpha + \beta_{POLS} x_{it} + \upsilon_{it},</span>
<span id="cb71-400"><a href="#cb71-400" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb71-401"><a href="#cb71-401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-402"><a href="#cb71-402" aria-hidden="true" tabindex="-1"></a>And, as above, we use the simple <span class="in">`lm()`</span> command</span>
<span id="cb71-403"><a href="#cb71-403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-406"><a href="#cb71-406" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb71-407"><a href="#cb71-407" aria-hidden="true" tabindex="-1"></a>lm1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(happiness <span class="sc">~</span> age, <span class="at">data =</span> df)</span>
<span id="cb71-408"><a href="#cb71-408" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(lm1)</span>
<span id="cb71-409"><a href="#cb71-409" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb71-410"><a href="#cb71-410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-411"><a href="#cb71-411" aria-hidden="true" tabindex="-1"></a>which graphically looks like:</span>
<span id="cb71-412"><a href="#cb71-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-413"><a href="#cb71-413" aria-hidden="true" tabindex="-1"></a><span class="in">```{r class.source = 'fold-hide', message = FALSE, warning = FALSE}</span></span>
<span id="cb71-414"><a href="#cb71-414" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the residual values</span></span>
<span id="cb71-415"><a href="#cb71-415" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>predicted <span class="ot">&lt;-</span> <span class="fu">predict</span>(lm1)</span>
<span id="cb71-416"><a href="#cb71-416" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>residuals <span class="ot">&lt;-</span> <span class="fu">residuals</span>(lm1)</span>
<span id="cb71-417"><a href="#cb71-417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-418"><a href="#cb71-418" aria-hidden="true" tabindex="-1"></a>zp3 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df, <span class="fu">aes</span>(age, happiness)) <span class="sc">+</span></span>
<span id="cb71-419"><a href="#cb71-419" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>( <span class="fu">aes</span>(<span class="at">x =</span> age, <span class="at">y =</span> happiness, <span class="at">shape =</span> idname, <span class="at">colour =</span> idname, <span class="at">fill =</span> idname), </span>
<span id="cb71-420"><a href="#cb71-420" aria-hidden="true" tabindex="-1"></a>              <span class="at">size =</span> <span class="dv">2</span>, <span class="at">stroke =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb71-421"><a href="#cb71-421" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">'lm'</span>, <span class="at">formula =</span> y <span class="sc">~</span> x, <span class="at">se =</span> <span class="cn">FALSE</span>,</span>
<span id="cb71-422"><a href="#cb71-422" aria-hidden="true" tabindex="-1"></a>              <span class="at">color  =</span> <span class="st">"deeppink"</span>) <span class="sc">+</span></span>
<span id="cb71-423"><a href="#cb71-423" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_segment</span>(<span class="fu">aes</span>(<span class="at">xend =</span> age, <span class="at">yend =</span> predicted), </span>
<span id="cb71-424"><a href="#cb71-424" aria-hidden="true" tabindex="-1"></a>               <span class="at">alpha =</span> .<span class="dv">3</span>, <span class="at">color =</span> <span class="st">"purple"</span>) <span class="sc">+</span></span>
<span id="cb71-425"><a href="#cb71-425" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="dv">35</span>, <span class="at">y =</span> <span class="fl">8.0</span>, </span>
<span id="cb71-426"><a href="#cb71-426" aria-hidden="true" tabindex="-1"></a>           <span class="at">label =</span> <span class="fu">paste0</span>(<span class="st">"beta[Pooled] =="</span>, <span class="fu">round</span>(lm1<span class="sc">$</span>coefficients[<span class="dv">2</span>], <span class="dv">3</span>)), </span>
<span id="cb71-427"><a href="#cb71-427" aria-hidden="true" tabindex="-1"></a>           <span class="at">parse =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb71-428"><a href="#cb71-428" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="fl">3.3</span>, <span class="fl">9.2</span>) <span class="sc">+</span> <span class="fu">expand_limits</span>(<span class="at">y =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span> </span>
<span id="cb71-429"><a href="#cb71-429" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_manual</span>(<span class="at">values =</span> cbp2[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>)]) <span class="sc">+</span> </span>
<span id="cb71-430"><a href="#cb71-430" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> cbp2[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>)]) <span class="sc">+</span> </span>
<span id="cb71-431"><a href="#cb71-431" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_shape_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="dv">15</span><span class="sc">:</span><span class="dv">18</span>, <span class="dv">25</span>, <span class="dv">20</span>)) <span class="sc">+</span></span>
<span id="cb71-432"><a href="#cb71-432" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"A) Pooled Estimate"</span>) <span class="sc">+</span></span>
<span id="cb71-433"><a href="#cb71-433" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb71-434"><a href="#cb71-434" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.key =</span> <span class="fu">element_blank</span>(), </span>
<span id="cb71-435"><a href="#cb71-435" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb71-436"><a href="#cb71-436" aria-hidden="true" tabindex="-1"></a>        <span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb71-437"><a href="#cb71-437" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.95</span>,<span class="fl">0.05</span>), </span>
<span id="cb71-438"><a href="#cb71-438" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.justification =</span> <span class="fu">c</span>(<span class="st">"right"</span>, <span class="st">"bottom"</span>),</span>
<span id="cb71-439"><a href="#cb71-439" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb71-440"><a href="#cb71-440" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.box.background =</span> <span class="fu">element_rect</span>(<span class="at">colour =</span> <span class="st">"black"</span>))</span>
<span id="cb71-441"><a href="#cb71-441" aria-hidden="true" tabindex="-1"></a>zp3</span>
<span id="cb71-442"><a href="#cb71-442" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb71-443"><a href="#cb71-443" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-444"><a href="#cb71-444" aria-hidden="true" tabindex="-1"></a>Interpretation: The higher the age of an observation, the higher their happiness.</span>
<span id="cb71-445"><a href="#cb71-445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-446"><a href="#cb71-446" aria-hidden="true" tabindex="-1"></a><span class="fu">### Between estimator</span></span>
<span id="cb71-447"><a href="#cb71-447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-448"><a href="#cb71-448" aria-hidden="true" tabindex="-1"></a>The between estimator only compares different persons and discards the within-person variance. Therefore, we simply run a model that only uses the person-specific means</span>
<span id="cb71-449"><a href="#cb71-449" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-450"><a href="#cb71-450" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb71-451"><a href="#cb71-451" aria-hidden="true" tabindex="-1"></a>\bar{y_{i}} = \alpha + \beta_{BTW} \bar{x_{i}} + \bar{\upsilon_{i}},</span>
<span id="cb71-452"><a href="#cb71-452" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb71-453"><a href="#cb71-453" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-454"><a href="#cb71-454" aria-hidden="true" tabindex="-1"></a>We can either estimate this by hand:</span>
<span id="cb71-455"><a href="#cb71-455" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-458"><a href="#cb71-458" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb71-459"><a href="#cb71-459" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>m_happiness <span class="ot">&lt;-</span> <span class="fu">ave</span>(df<span class="sc">$</span>happiness, df<span class="sc">$</span>id, <span class="at">FUN =</span> mean)</span>
<span id="cb71-460"><a href="#cb71-460" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>m_age <span class="ot">&lt;-</span> <span class="fu">ave</span>(df<span class="sc">$</span>age, df<span class="sc">$</span>id, <span class="at">FUN =</span> mean)</span>
<span id="cb71-461"><a href="#cb71-461" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-462"><a href="#cb71-462" aria-hidden="true" tabindex="-1"></a>lm2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(m_happiness <span class="sc">~</span> m_age, <span class="at">data =</span> df)</span>
<span id="cb71-463"><a href="#cb71-463" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(lm2)</span>
<span id="cb71-464"><a href="#cb71-464" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb71-465"><a href="#cb71-465" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-466"><a href="#cb71-466" aria-hidden="true" tabindex="-1"></a>or we use the <span class="in">`plm`</span> package to do the job for us</span>
<span id="cb71-467"><a href="#cb71-467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-470"><a href="#cb71-470" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb71-471"><a href="#cb71-471" aria-hidden="true" tabindex="-1"></a>btw2 <span class="ot">&lt;-</span> <span class="fu">plm</span>(happiness <span class="sc">~</span> age, <span class="at">data =</span> df,</span>
<span id="cb71-472"><a href="#cb71-472" aria-hidden="true" tabindex="-1"></a>           <span class="at">index =</span> <span class="fu">c</span>(<span class="st">"id"</span>, <span class="st">"time"</span>),</span>
<span id="cb71-473"><a href="#cb71-473" aria-hidden="true" tabindex="-1"></a>           <span class="at">effect =</span> <span class="st">"individual"</span>, <span class="at">model =</span> <span class="st">"between"</span>)</span>
<span id="cb71-474"><a href="#cb71-474" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(btw2)</span>
<span id="cb71-475"><a href="#cb71-475" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb71-476"><a href="#cb71-476" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-477"><a href="#cb71-477" aria-hidden="true" tabindex="-1"></a>NOTE the line "observations used in estimation" ! The manual approach with <span class="in">`lm`</span> assumes we have 24 independent observations. This is not true, we only have 6 independent observations, where each is replicated 4 times in the data.</span>
<span id="cb71-478"><a href="#cb71-478" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-479"><a href="#cb71-479" aria-hidden="true" tabindex="-1"></a>Graphically this result looks like:</span>
<span id="cb71-480"><a href="#cb71-480" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-481"><a href="#cb71-481" aria-hidden="true" tabindex="-1"></a><span class="in">```{r class.source = 'fold-hide', message = FALSE, warning = FALSE}</span></span>
<span id="cb71-482"><a href="#cb71-482" aria-hidden="true" tabindex="-1"></a>df2 <span class="ot">&lt;-</span> df</span>
<span id="cb71-483"><a href="#cb71-483" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>happiness <span class="ot">&lt;-</span> df2<span class="sc">$</span>m_happiness</span>
<span id="cb71-484"><a href="#cb71-484" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>age <span class="ot">&lt;-</span> df2<span class="sc">$</span>m_age</span>
<span id="cb71-485"><a href="#cb71-485" aria-hidden="true" tabindex="-1"></a>df2 <span class="ot">&lt;-</span> df2[<span class="fu">which</span>(df2<span class="sc">$</span>time <span class="sc">==</span> <span class="dv">1</span>), ]</span>
<span id="cb71-486"><a href="#cb71-486" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-487"><a href="#cb71-487" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the residual values</span></span>
<span id="cb71-488"><a href="#cb71-488" aria-hidden="true" tabindex="-1"></a>lm4 <span class="ot">&lt;-</span> <span class="fu">lm</span>(m_happiness <span class="sc">~</span> m_age, <span class="at">data =</span> df2)</span>
<span id="cb71-489"><a href="#cb71-489" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>predicted <span class="ot">&lt;-</span> <span class="fu">predict</span>(lm4)</span>
<span id="cb71-490"><a href="#cb71-490" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>residuals <span class="ot">&lt;-</span> <span class="fu">residuals</span>(lm4)</span>
<span id="cb71-491"><a href="#cb71-491" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-492"><a href="#cb71-492" aria-hidden="true" tabindex="-1"></a>zp4 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df, <span class="fu">aes</span>(age, happiness)) <span class="sc">+</span></span>
<span id="cb71-493"><a href="#cb71-493" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> age, <span class="at">y =</span> happiness, <span class="at">shape =</span> idname), </span>
<span id="cb71-494"><a href="#cb71-494" aria-hidden="true" tabindex="-1"></a>              <span class="at">size =</span> <span class="dv">2</span>, <span class="at">stroke =</span> <span class="dv">1</span>, <span class="at">colour =</span> <span class="fu">alpha</span>(<span class="st">"black"</span>, .<span class="dv">3</span>), <span class="at">fill =</span> <span class="fu">alpha</span>(<span class="st">"black"</span>, .<span class="dv">3</span>)) <span class="sc">+</span></span>
<span id="cb71-495"><a href="#cb71-495" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> m_age, <span class="at">y =</span> m_happiness, <span class="at">shape =</span> idname, <span class="at">colour =</span> idname,</span>
<span id="cb71-496"><a href="#cb71-496" aria-hidden="true" tabindex="-1"></a>                 <span class="at">fill =</span> idname), </span>
<span id="cb71-497"><a href="#cb71-497" aria-hidden="true" tabindex="-1"></a>             <span class="at">size =</span> <span class="dv">2</span>, <span class="at">stroke =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb71-498"><a href="#cb71-498" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">data =</span> df2, </span>
<span id="cb71-499"><a href="#cb71-499" aria-hidden="true" tabindex="-1"></a>              <span class="at">method =</span> <span class="st">'lm'</span>, <span class="at">formula =</span> y <span class="sc">~</span> x, <span class="at">se =</span> <span class="cn">FALSE</span>,</span>
<span id="cb71-500"><a href="#cb71-500" aria-hidden="true" tabindex="-1"></a>              <span class="at">color  =</span> <span class="st">"deeppink"</span>) <span class="sc">+</span></span>
<span id="cb71-501"><a href="#cb71-501" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_segment</span>(<span class="at">data =</span> df2, <span class="fu">aes</span>(<span class="at">xend =</span> age, <span class="at">yend =</span> predicted), </span>
<span id="cb71-502"><a href="#cb71-502" aria-hidden="true" tabindex="-1"></a>               <span class="at">alpha =</span> .<span class="dv">3</span>, <span class="at">color =</span> <span class="st">"purple"</span>) <span class="sc">+</span></span>
<span id="cb71-503"><a href="#cb71-503" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="dv">35</span>, <span class="at">y =</span> <span class="fl">8.0</span>, </span>
<span id="cb71-504"><a href="#cb71-504" aria-hidden="true" tabindex="-1"></a>           <span class="at">label =</span> <span class="fu">paste0</span>(<span class="st">"beta[Between] =="</span>, <span class="fu">round</span>(lm4<span class="sc">$</span>coefficients[<span class="dv">2</span>], <span class="dv">3</span>)), </span>
<span id="cb71-505"><a href="#cb71-505" aria-hidden="true" tabindex="-1"></a>           <span class="at">parse =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb71-506"><a href="#cb71-506" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="fl">3.3</span>, <span class="fl">9.2</span>) <span class="sc">+</span> <span class="fu">expand_limits</span>(<span class="at">y =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span> </span>
<span id="cb71-507"><a href="#cb71-507" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_manual</span>(<span class="at">values =</span> cbp2[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>)]) <span class="sc">+</span> </span>
<span id="cb71-508"><a href="#cb71-508" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> cbp2[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>)]) <span class="sc">+</span> </span>
<span id="cb71-509"><a href="#cb71-509" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_shape_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="dv">15</span><span class="sc">:</span><span class="dv">18</span>, <span class="dv">25</span>, <span class="dv">20</span>)) <span class="sc">+</span></span>
<span id="cb71-510"><a href="#cb71-510" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"B) Between Estimate"</span>) <span class="sc">+</span></span>
<span id="cb71-511"><a href="#cb71-511" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb71-512"><a href="#cb71-512" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.key =</span> <span class="fu">element_blank</span>(), </span>
<span id="cb71-513"><a href="#cb71-513" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb71-514"><a href="#cb71-514" aria-hidden="true" tabindex="-1"></a>        <span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb71-515"><a href="#cb71-515" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.95</span>,<span class="fl">0.05</span>), </span>
<span id="cb71-516"><a href="#cb71-516" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.justification =</span> <span class="fu">c</span>(<span class="st">"right"</span>, <span class="st">"bottom"</span>),</span>
<span id="cb71-517"><a href="#cb71-517" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb71-518"><a href="#cb71-518" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.box.background =</span> <span class="fu">element_rect</span>(<span class="at">colour =</span> <span class="st">"black"</span>))</span>
<span id="cb71-519"><a href="#cb71-519" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-520"><a href="#cb71-520" aria-hidden="true" tabindex="-1"></a>zp4  </span>
<span id="cb71-521"><a href="#cb71-521" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb71-522"><a href="#cb71-522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-523"><a href="#cb71-523" aria-hidden="true" tabindex="-1"></a>Interpretation: The older a person the higher their hapinness (as compared to younger people).</span>
<span id="cb71-524"><a href="#cb71-524" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-525"><a href="#cb71-525" aria-hidden="true" tabindex="-1"></a><span class="fu">### Within estimator</span></span>
<span id="cb71-526"><a href="#cb71-526" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-527"><a href="#cb71-527" aria-hidden="true" tabindex="-1"></a>The within estimator only compares different periods within the same person and discards the between-person variance. We could also say the estimator is solely based on changes over time. To achieve this, we simply give every person their own intercept / add a dummy for each person (similar to the cohort example above).</span>
<span id="cb71-528"><a href="#cb71-528" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-529"><a href="#cb71-529" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb71-530"><a href="#cb71-530" aria-hidden="true" tabindex="-1"></a>y_{it} = \alpha_i + \beta_{WI} x_{it} + \epsilon_{it},</span>
<span id="cb71-531"><a href="#cb71-531" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb71-532"><a href="#cb71-532" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-533"><a href="#cb71-533" aria-hidden="true" tabindex="-1"></a>Again, we could run this manually</span>
<span id="cb71-534"><a href="#cb71-534" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-537"><a href="#cb71-537" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb71-538"><a href="#cb71-538" aria-hidden="true" tabindex="-1"></a>lm3 <span class="ot">&lt;-</span> <span class="fu">lm</span>(happiness <span class="sc">~</span> age <span class="sc">+</span> idname, <span class="at">data =</span> df)</span>
<span id="cb71-539"><a href="#cb71-539" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(lm3)</span>
<span id="cb71-540"><a href="#cb71-540" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb71-541"><a href="#cb71-541" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-542"><a href="#cb71-542" aria-hidden="true" tabindex="-1"></a>or we use <span class="in">`plm`</span>:</span>
<span id="cb71-543"><a href="#cb71-543" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-546"><a href="#cb71-546" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb71-547"><a href="#cb71-547" aria-hidden="true" tabindex="-1"></a>fe1 <span class="ot">&lt;-</span> <span class="fu">plm</span>(happiness <span class="sc">~</span> age, <span class="at">data =</span> df,</span>
<span id="cb71-548"><a href="#cb71-548" aria-hidden="true" tabindex="-1"></a>           <span class="at">index =</span> <span class="fu">c</span>(<span class="st">"id"</span>, <span class="st">"time"</span>),</span>
<span id="cb71-549"><a href="#cb71-549" aria-hidden="true" tabindex="-1"></a>           <span class="at">effect =</span> <span class="st">"individual"</span>, <span class="at">model =</span> <span class="st">"within"</span>)</span>
<span id="cb71-550"><a href="#cb71-550" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fe1)</span>
<span id="cb71-551"><a href="#cb71-551" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb71-552"><a href="#cb71-552" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-553"><a href="#cb71-553" aria-hidden="true" tabindex="-1"></a>Graphically, this would look like:</span>
<span id="cb71-554"><a href="#cb71-554" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-555"><a href="#cb71-555" aria-hidden="true" tabindex="-1"></a><span class="in">```{r class.source = 'fold-hide', message = FALSE, warning = FALSE}</span></span>
<span id="cb71-556"><a href="#cb71-556" aria-hidden="true" tabindex="-1"></a>df2 <span class="ot">&lt;-</span> df</span>
<span id="cb71-557"><a href="#cb71-557" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>happiness <span class="ot">&lt;-</span> df2<span class="sc">$</span>happiness <span class="sc">-</span> df2<span class="sc">$</span>m_happiness <span class="sc">+</span> <span class="fu">mean</span>(df<span class="sc">$</span>happiness)</span>
<span id="cb71-558"><a href="#cb71-558" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>age <span class="ot">&lt;-</span> df2<span class="sc">$</span>age <span class="sc">-</span> df2<span class="sc">$</span>m_age  <span class="sc">+</span> <span class="fu">mean</span>(df<span class="sc">$</span>age)</span>
<span id="cb71-559"><a href="#cb71-559" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-560"><a href="#cb71-560" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the residual values</span></span>
<span id="cb71-561"><a href="#cb71-561" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="fu">unique</span>(df<span class="sc">$</span>id)){</span>
<span id="cb71-562"><a href="#cb71-562" aria-hidden="true" tabindex="-1"></a>  oo <span class="ot">&lt;-</span> <span class="fu">which</span>(df<span class="sc">$</span>id <span class="sc">==</span> i)</span>
<span id="cb71-563"><a href="#cb71-563" aria-hidden="true" tabindex="-1"></a>  lmt <span class="ot">&lt;-</span> <span class="fu">lm</span>(happiness <span class="sc">~</span> age, <span class="at">data =</span> df[oo, ])</span>
<span id="cb71-564"><a href="#cb71-564" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>predicted[oo] <span class="ot">&lt;-</span> <span class="fu">predict</span>(lmt)</span>
<span id="cb71-565"><a href="#cb71-565" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>residuals[oo] <span class="ot">&lt;-</span> <span class="fu">residuals</span>(lmt)</span>
<span id="cb71-566"><a href="#cb71-566" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb71-567"><a href="#cb71-567" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-568"><a href="#cb71-568" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-569"><a href="#cb71-569" aria-hidden="true" tabindex="-1"></a>zp5 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df, <span class="fu">aes</span>(age, happiness)) <span class="sc">+</span></span>
<span id="cb71-570"><a href="#cb71-570" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>( <span class="fu">aes</span>(<span class="at">x =</span> age, <span class="at">y =</span> happiness, <span class="at">shape =</span> idname, <span class="at">colour =</span> idname, <span class="at">fill  =</span> idname), </span>
<span id="cb71-571"><a href="#cb71-571" aria-hidden="true" tabindex="-1"></a>              <span class="at">size =</span> <span class="dv">2</span>, <span class="at">stroke =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb71-572"><a href="#cb71-572" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">'lm'</span>, <span class="at">formula =</span> y <span class="sc">~</span> x, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>,</span>
<span id="cb71-573"><a href="#cb71-573" aria-hidden="true" tabindex="-1"></a>              <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">group =</span> idname),</span>
<span id="cb71-574"><a href="#cb71-574" aria-hidden="true" tabindex="-1"></a>              <span class="at">color  =</span> <span class="st">"deeppink"</span>, <span class="at">linetype =</span> <span class="st">"dotted"</span>) <span class="sc">+</span></span>
<span id="cb71-575"><a href="#cb71-575" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">'lm'</span>, <span class="at">formula =</span> y <span class="sc">~</span> x, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>,</span>
<span id="cb71-576"><a href="#cb71-576" aria-hidden="true" tabindex="-1"></a>              <span class="at">data =</span> df2, <span class="at">color  =</span> <span class="st">"deeppink"</span>, <span class="at">fullrange =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb71-577"><a href="#cb71-577" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_segment</span>(<span class="at">data =</span> df, <span class="fu">aes</span>(<span class="at">xend =</span> age, <span class="at">yend =</span> predicted), </span>
<span id="cb71-578"><a href="#cb71-578" aria-hidden="true" tabindex="-1"></a>               <span class="at">alpha =</span> .<span class="dv">3</span>, <span class="at">color =</span> <span class="st">"purple"</span>) <span class="sc">+</span></span>
<span id="cb71-579"><a href="#cb71-579" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="dv">35</span>, <span class="at">y =</span> <span class="fl">8.0</span>, </span>
<span id="cb71-580"><a href="#cb71-580" aria-hidden="true" tabindex="-1"></a>           <span class="at">label =</span> <span class="fu">paste0</span>(<span class="st">"beta[Within] =="</span>, <span class="fu">round</span>(lm3<span class="sc">$</span>coefficients[<span class="dv">2</span>], <span class="dv">3</span>)), </span>
<span id="cb71-581"><a href="#cb71-581" aria-hidden="true" tabindex="-1"></a>           <span class="at">parse =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb71-582"><a href="#cb71-582" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="fl">3.3</span>, <span class="fl">9.2</span>) <span class="sc">+</span> <span class="fu">expand_limits</span>(<span class="at">y =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span> </span>
<span id="cb71-583"><a href="#cb71-583" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> cbp2[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>)]) <span class="sc">+</span></span>
<span id="cb71-584"><a href="#cb71-584" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_manual</span>(<span class="at">values =</span> cbp2[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>)]) <span class="sc">+</span> </span>
<span id="cb71-585"><a href="#cb71-585" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_shape_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="dv">15</span><span class="sc">:</span><span class="dv">18</span>, <span class="dv">25</span>, <span class="dv">20</span>)) <span class="sc">+</span></span>
<span id="cb71-586"><a href="#cb71-586" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"C) Within Estimate / Fixed Effects"</span>) <span class="sc">+</span></span>
<span id="cb71-587"><a href="#cb71-587" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb71-588"><a href="#cb71-588" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.key =</span> <span class="fu">element_blank</span>(), </span>
<span id="cb71-589"><a href="#cb71-589" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb71-590"><a href="#cb71-590" aria-hidden="true" tabindex="-1"></a>        <span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb71-591"><a href="#cb71-591" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.95</span>,<span class="fl">0.05</span>), </span>
<span id="cb71-592"><a href="#cb71-592" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.justification =</span> <span class="fu">c</span>(<span class="st">"right"</span>, <span class="st">"bottom"</span>),</span>
<span id="cb71-593"><a href="#cb71-593" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb71-594"><a href="#cb71-594" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.box.background =</span> <span class="fu">element_rect</span>(<span class="at">colour =</span> <span class="st">"black"</span>))</span>
<span id="cb71-595"><a href="#cb71-595" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-596"><a href="#cb71-596" aria-hidden="true" tabindex="-1"></a>zp5</span>
<span id="cb71-597"><a href="#cb71-597" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb71-598"><a href="#cb71-598" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-599"><a href="#cb71-599" aria-hidden="true" tabindex="-1"></a>Now, we have estimated the effect by only taking observations within each person into account: given the person id, how does age correlate with happiness.</span>
<span id="cb71-600"><a href="#cb71-600" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-601"><a href="#cb71-601" aria-hidden="true" tabindex="-1"></a>Interpretation: The older a person gets, the lower this person's happiness (as compared to the same persons younger age).</span>
<span id="cb71-602"><a href="#cb71-602" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-603"><a href="#cb71-603" aria-hidden="true" tabindex="-1"></a>The principle is very similar to including a (binary) control variable. It's just that we include a lot of them to get rid of a lot of (potentially confounded) variance.</span>
<span id="cb71-604"><a href="#cb71-604" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-605"><a href="#cb71-605" aria-hidden="true" tabindex="-1"></a><span class="al">![Illustration by @Huntington-Klein.2021: Introducing fixed effects](fig/NHK_FE.gif)</span></span>
<span id="cb71-606"><a href="#cb71-606" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-607"><a href="#cb71-607" aria-hidden="true" tabindex="-1"></a><span class="fu">### Comparison</span></span>
<span id="cb71-608"><a href="#cb71-608" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-611"><a href="#cb71-611" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb71-612"><a href="#cb71-612" aria-hidden="true" tabindex="-1"></a><span class="fu">screenreg</span>(<span class="fu">list</span>(lm1, lm2, lm3), <span class="at">digits =</span> <span class="dv">3</span>, </span>
<span id="cb71-613"><a href="#cb71-613" aria-hidden="true" tabindex="-1"></a>          <span class="at">custom.model.names =</span> <span class="fu">c</span>(<span class="st">"POLS"</span>, <span class="st">"Between"</span>, <span class="st">"Within"</span>))</span>
<span id="cb71-614"><a href="#cb71-614" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb71-615"><a href="#cb71-615" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-616"><a href="#cb71-616" aria-hidden="true" tabindex="-1"></a>POLS: The older an observation (person-year), the higher its happiness.</span>
<span id="cb71-617"><a href="#cb71-617" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-618"><a href="#cb71-618" aria-hidden="true" tabindex="-1"></a>Between: The older a person, the higher their happiness.</span>
<span id="cb71-619"><a href="#cb71-619" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-620"><a href="#cb71-620" aria-hidden="true" tabindex="-1"></a>Within: Increasing age within a person goes along with declining happiness within the same person.</span>
<span id="cb71-621"><a href="#cb71-621" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-622"><a href="#cb71-622" aria-hidden="true" tabindex="-1"></a>The estimates for $\beta_{POLS}$ and $\beta_{BTW}$ are very similar here. We will see below why.</span>
<span id="cb71-623"><a href="#cb71-623" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-624"><a href="#cb71-624" aria-hidden="true" tabindex="-1"></a><span class="fu">#### This is how the within-person relationship looks with real world data in Germany (SOEP)</span></span>
<span id="cb71-625"><a href="#cb71-625" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-626"><a href="#cb71-626" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-627"><a href="#cb71-627" aria-hidden="true" tabindex="-1"></a><span class="al">![Working paper by @Kratz.2021](fig/kratz.PNG)</span></span>
<span id="cb71-628"><a href="#cb71-628" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-629"><a href="#cb71-629" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-630"><a href="#cb71-630" aria-hidden="true" tabindex="-1"></a><span class="fu"># Fixed effects estimator</span></span>
<span id="cb71-631"><a href="#cb71-631" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-632"><a href="#cb71-632" aria-hidden="true" tabindex="-1"></a>The estimator we used above to derive the within coefficient is the fixed effects (FE) estimator. This method is very widely used, especially with survey data.</span>
<span id="cb71-633"><a href="#cb71-633" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-634"><a href="#cb71-634" aria-hidden="true" tabindex="-1"></a>We use a second example here: assume we observe 4 individuals over 6 periods, and we want to estimate the effect of marriage on the wage for males. This is the so called "marriage wage premium" <span class="co">[</span><span class="ot">@Ludwig.2018</span><span class="co">]</span>.</span>
<span id="cb71-635"><a href="#cb71-635" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-636"><a href="#cb71-636" aria-hidden="true" tabindex="-1"></a><span class="in">```{r class.source = 'fold-hide', message = FALSE, warning = FALSE}</span></span>
<span id="cb71-637"><a href="#cb71-637" aria-hidden="true" tabindex="-1"></a><span class="do">##################################</span></span>
<span id="cb71-638"><a href="#cb71-638" aria-hidden="true" tabindex="-1"></a><span class="do">### Example 2: Marriage Income </span><span class="al">###</span></span>
<span id="cb71-639"><a href="#cb71-639" aria-hidden="true" tabindex="-1"></a><span class="do">##################################</span></span>
<span id="cb71-640"><a href="#cb71-640" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-641"><a href="#cb71-641" aria-hidden="true" tabindex="-1"></a><span class="do">### Set up six individuals with age and happiness</span></span>
<span id="cb71-642"><a href="#cb71-642" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">4</span></span>
<span id="cb71-643"><a href="#cb71-643" aria-hidden="true" tabindex="-1"></a>T <span class="ot">&lt;-</span> <span class="dv">6</span></span>
<span id="cb71-644"><a href="#cb71-644" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-645"><a href="#cb71-645" aria-hidden="true" tabindex="-1"></a><span class="co"># id and wave</span></span>
<span id="cb71-646"><a href="#cb71-646" aria-hidden="true" tabindex="-1"></a>df2 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">nrow =</span> N<span class="sc">*</span>T))</span>
<span id="cb71-647"><a href="#cb71-647" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(df2) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"id"</span>, <span class="st">"time"</span>)</span>
<span id="cb71-648"><a href="#cb71-648" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-649"><a href="#cb71-649" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>id <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>N, <span class="at">each =</span> T)</span>
<span id="cb71-650"><a href="#cb71-650" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>time <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>T, <span class="at">times =</span> N)</span>
<span id="cb71-651"><a href="#cb71-651" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>idname <span class="ot">&lt;-</span> <span class="fu">factor</span>(df2<span class="sc">$</span>id, <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span>N), <span class="at">labels =</span> <span class="fu">paste</span>(<span class="st">"Person"</span>, <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span>N)))</span>
<span id="cb71-652"><a href="#cb71-652" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-653"><a href="#cb71-653" aria-hidden="true" tabindex="-1"></a><span class="co"># Marriage dummy</span></span>
<span id="cb71-654"><a href="#cb71-654" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>marriage_ever <span class="ot">&lt;-</span> <span class="dv">0</span> </span>
<span id="cb71-655"><a href="#cb71-655" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>marriage_ever[(N<span class="sc">*</span>T<span class="sc">/</span><span class="dv">2</span> <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(N<span class="sc">*</span>T)] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb71-656"><a href="#cb71-656" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-657"><a href="#cb71-657" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>marriage <span class="ot">&lt;-</span> df2<span class="sc">$</span>marriage_ever <span class="sc">*</span> <span class="fu">ifelse</span>(df2<span class="sc">$</span>time <span class="sc">&gt;=</span> <span class="dv">4</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb71-658"><a href="#cb71-658" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-659"><a href="#cb71-659" aria-hidden="true" tabindex="-1"></a><span class="co"># Starting wage</span></span>
<span id="cb71-660"><a href="#cb71-660" aria-hidden="true" tabindex="-1"></a>stw <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">2000</span>, <span class="dv">5000</span>)</span>
<span id="cb71-661"><a href="#cb71-661" aria-hidden="true" tabindex="-1"></a>stw <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">quantile</span>(stw, <span class="at">probs =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span><span class="sc">/</span>(N<span class="dv">-1</span>))), <span class="dv">0</span>)</span>
<span id="cb71-662"><a href="#cb71-662" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-663"><a href="#cb71-663" aria-hidden="true" tabindex="-1"></a><span class="co"># wage equation</span></span>
<span id="cb71-664"><a href="#cb71-664" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>wage <span class="ot">&lt;-</span> <span class="fu">unname</span>(<span class="fu">rep</span>(stw, <span class="at">each =</span> T)) <span class="sc">+</span> (df2<span class="sc">$</span>time <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">*</span><span class="dv">50</span> <span class="sc">+</span> <span class="dv">200</span> <span class="sc">*</span> <span class="fu">ifelse</span>(df2<span class="sc">$</span>time <span class="sc">&gt;=</span><span class="dv">4</span>, <span class="dv">1</span>, <span class="dv">0</span>) <span class="sc">+</span> df2<span class="sc">$</span>marriage <span class="sc">*</span> <span class="dv">500</span></span>
<span id="cb71-665"><a href="#cb71-665" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-666"><a href="#cb71-666" aria-hidden="true" tabindex="-1"></a><span class="co"># counterfactual parallel trend</span></span>
<span id="cb71-667"><a href="#cb71-667" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>pti <span class="ot">&lt;-</span> <span class="fu">unname</span>(<span class="fu">rep</span>(stw, <span class="at">each =</span> T)) <span class="sc">+</span> (df2<span class="sc">$</span>time <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">*</span><span class="dv">50</span> </span>
<span id="cb71-668"><a href="#cb71-668" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>pt <span class="ot">&lt;-</span> <span class="fu">unname</span>(<span class="fu">rep</span>(stw, <span class="at">each =</span> T)) <span class="sc">+</span> (df2<span class="sc">$</span>time <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">*</span><span class="dv">50</span> <span class="sc">+</span> <span class="dv">200</span> <span class="sc">*</span> <span class="fu">ifelse</span>(df2<span class="sc">$</span>time <span class="sc">&gt;=</span><span class="dv">4</span>, <span class="dv">1</span>, <span class="dv">0</span>) </span>
<span id="cb71-669"><a href="#cb71-669" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>pti[df2<span class="sc">$</span>marriage_ever <span class="sc">==</span> <span class="dv">0</span> <span class="sc">|</span> df2<span class="sc">$</span>time <span class="sc">&lt;</span> <span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb71-670"><a href="#cb71-670" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>pt[df2<span class="sc">$</span>marriage_ever <span class="sc">==</span> <span class="dv">0</span> <span class="sc">|</span> df2<span class="sc">$</span>time <span class="sc">&lt;</span> <span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb71-671"><a href="#cb71-671" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-672"><a href="#cb71-672" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-673"><a href="#cb71-673" aria-hidden="true" tabindex="-1"></a><span class="do">### Add individual slope / heterogeneous time trends</span></span>
<span id="cb71-674"><a href="#cb71-674" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-675"><a href="#cb71-675" aria-hidden="true" tabindex="-1"></a><span class="co"># wage equation</span></span>
<span id="cb71-676"><a href="#cb71-676" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>wage2 <span class="ot">&lt;-</span> <span class="fu">unname</span>(<span class="fu">rep</span>(stw, <span class="at">each =</span> T)) <span class="sc">+</span> (df2<span class="sc">$</span>time <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">*</span><span class="dv">50</span>  <span class="sc">+</span> (df2<span class="sc">$</span>time <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">*</span><span class="dv">150</span><span class="sc">*</span>df2<span class="sc">$</span>marriage_ever <span class="sc">+</span> <span class="dv">200</span> <span class="sc">*</span> <span class="fu">ifelse</span>(df2<span class="sc">$</span>time <span class="sc">&gt;=</span><span class="dv">4</span>, <span class="dv">1</span>, <span class="dv">0</span>) <span class="sc">+</span> df2<span class="sc">$</span>marriage <span class="sc">*</span> <span class="dv">500</span></span>
<span id="cb71-677"><a href="#cb71-677" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-678"><a href="#cb71-678" aria-hidden="true" tabindex="-1"></a><span class="co"># parallel trend</span></span>
<span id="cb71-679"><a href="#cb71-679" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>pt2 <span class="ot">&lt;-</span> <span class="fu">unname</span>(<span class="fu">rep</span>(stw, <span class="at">each =</span> T)) <span class="sc">+</span> (df2<span class="sc">$</span>time <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">*</span><span class="dv">50</span> <span class="sc">+</span> <span class="dv">200</span> <span class="sc">*</span> <span class="fu">ifelse</span>(df2<span class="sc">$</span>time <span class="sc">&gt;=</span><span class="dv">4</span>, <span class="dv">1</span>, <span class="dv">0</span>) <span class="sc">+</span> <span class="dv">2</span><span class="sc">*</span><span class="dv">150</span></span>
<span id="cb71-680"><a href="#cb71-680" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>pt2[df2<span class="sc">$</span>marriage_ever <span class="sc">==</span> <span class="dv">0</span> <span class="sc">|</span> df2<span class="sc">$</span>time <span class="sc">&lt;</span> <span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb71-681"><a href="#cb71-681" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-682"><a href="#cb71-682" aria-hidden="true" tabindex="-1"></a><span class="co"># actual trend</span></span>
<span id="cb71-683"><a href="#cb71-683" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>pt2_cr <span class="ot">&lt;-</span> <span class="fu">unname</span>(<span class="fu">rep</span>(stw, <span class="at">each =</span> T)) <span class="sc">+</span> (df2<span class="sc">$</span>time <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">*</span><span class="dv">50</span> <span class="sc">+</span> (df2<span class="sc">$</span>time <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">*</span><span class="dv">150</span><span class="sc">*</span>df2<span class="sc">$</span>marriage_ever <span class="sc">+</span> <span class="dv">200</span> <span class="sc">*</span> <span class="fu">ifelse</span>(df2<span class="sc">$</span>time <span class="sc">&gt;=</span><span class="dv">4</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb71-684"><a href="#cb71-684" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>pt2_cr[df2<span class="sc">$</span>marriage_ever <span class="sc">==</span> <span class="dv">0</span> <span class="sc">|</span> df2<span class="sc">$</span>time <span class="sc">&lt;</span> <span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb71-685"><a href="#cb71-685" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-686"><a href="#cb71-686" aria-hidden="true" tabindex="-1"></a><span class="co"># Marry to factor</span></span>
<span id="cb71-687"><a href="#cb71-687" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>marriage <span class="ot">&lt;-</span> <span class="fu">factor</span>(df2<span class="sc">$</span>marriage, <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"not married"</span>, <span class="st">"married"</span>))</span>
<span id="cb71-688"><a href="#cb71-688" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>marriage_ever <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(df2<span class="sc">$</span>marriage_ever)</span>
<span id="cb71-689"><a href="#cb71-689" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-690"><a href="#cb71-690" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-691"><a href="#cb71-691" aria-hidden="true" tabindex="-1"></a><span class="do">### Plot </span></span>
<span id="cb71-692"><a href="#cb71-692" aria-hidden="true" tabindex="-1"></a>zp1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df2, <span class="fu">aes</span>(time, wage)) <span class="sc">+</span></span>
<span id="cb71-693"><a href="#cb71-693" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> wage, <span class="at">group =</span> id), <span class="at">lty =</span> <span class="st">"solid"</span>, <span class="at">colour =</span> <span class="st">"black"</span>, <span class="at">lwd =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb71-694"><a href="#cb71-694" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>( <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> wage, <span class="at">shape =</span> marriage, <span class="at">fill =</span> marriage), </span>
<span id="cb71-695"><a href="#cb71-695" aria-hidden="true" tabindex="-1"></a>             <span class="at">size =</span> <span class="dv">4</span>, <span class="at">stroke =</span> <span class="fl">1.5</span>, <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb71-696"><a href="#cb71-696" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb71-697"><a href="#cb71-697" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_shape_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="dv">21</span>, <span class="dv">24</span>)) <span class="sc">+</span></span>
<span id="cb71-698"><a href="#cb71-698" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#85144b"</span>, <span class="st">"#0074D9"</span>)) <span class="sc">+</span></span>
<span id="cb71-699"><a href="#cb71-699" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#85144b"</span>, <span class="st">"#0074D9"</span>)) <span class="sc">+</span></span>
<span id="cb71-700"><a href="#cb71-700" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.key =</span> <span class="fu">element_blank</span>(), <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb71-701"><a href="#cb71-701" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.05</span>,<span class="fl">0.95</span>), <span class="at">legend.justification =</span> <span class="fu">c</span>(<span class="st">"left"</span>, <span class="st">"top"</span>),</span>
<span id="cb71-702"><a href="#cb71-702" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb71-703"><a href="#cb71-703" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.box.background =</span> <span class="fu">element_rect</span>(<span class="at">colour =</span> <span class="st">"black"</span>),</span>
<span id="cb71-704"><a href="#cb71-704" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.spacing.y =</span> <span class="fu">unit</span>(<span class="sc">-</span><span class="fl">0.1</span>, <span class="st">"cm"</span>))</span>
<span id="cb71-705"><a href="#cb71-705" aria-hidden="true" tabindex="-1"></a>zp1 </span>
<span id="cb71-706"><a href="#cb71-706" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-707"><a href="#cb71-707" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb71-708"><a href="#cb71-708" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-709"><a href="#cb71-709" aria-hidden="true" tabindex="-1"></a><span class="fu">### Pooled OLS (again)</span></span>
<span id="cb71-710"><a href="#cb71-710" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-711"><a href="#cb71-711" aria-hidden="true" tabindex="-1"></a>Let's start with the conventional Pooled OLS (POLS) estimator on panel data</span>
<span id="cb71-712"><a href="#cb71-712" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-713"><a href="#cb71-713" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb71-714"><a href="#cb71-714" aria-hidden="true" tabindex="-1"></a>y_{it} = \alpha + \beta x_{it} + \upsilon_{it}</span>
<span id="cb71-715"><a href="#cb71-715" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb71-716"><a href="#cb71-716" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-717"><a href="#cb71-717" aria-hidden="true" tabindex="-1"></a>The main problem: this model relies on very strong assumptions for consistency, with the most important one being: </span>
<span id="cb71-718"><a href="#cb71-718" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-719"><a href="#cb71-719" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>$\E(\upsilon_{it} | x_{it}) = 0$, or $Cov(x_{it}, \upsilon_{it}) = 0$</span>
<span id="cb71-720"><a href="#cb71-720" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-721"><a href="#cb71-721" aria-hidden="true" tabindex="-1"></a>The error (including omitted variables) must not be correlated with $x_{it}$. In observational studies, we cannot observe a lot of things and characteristics (unobservables) such as personal views, psychological traits, or empathy. However, everything that influences $y_{it}$ but is unobserved ends up in $\upsilon_{it}$. If anything correlates with $x_{it}$, it is endogenous, and $\hat{\beta}_x$ will be biased.  </span>
<span id="cb71-722"><a href="#cb71-722" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-723"><a href="#cb71-723" aria-hidden="true" tabindex="-1"></a>Take our marriage example. </span>
<span id="cb71-724"><a href="#cb71-724" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-727"><a href="#cb71-727" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb71-728"><a href="#cb71-728" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">lm</span>(wage <span class="sc">~</span> marriage, <span class="at">data =</span> df2))</span>
<span id="cb71-729"><a href="#cb71-729" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb71-730"><a href="#cb71-730" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-731"><a href="#cb71-731" aria-hidden="true" tabindex="-1"></a>We would estimate a marriage premium of more than 2,000. The true value is 500. The reason: those who marry at some point already had higher wages before they married. Maybe friendly or emphatic people are more likely to mary and also do better in their job.</span>
<span id="cb71-732"><a href="#cb71-732" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-733"><a href="#cb71-733" aria-hidden="true" tabindex="-1"></a><span class="in">```{r class.source = 'fold-hide', message = FALSE, warning = FALSE}</span></span>
<span id="cb71-734"><a href="#cb71-734" aria-hidden="true" tabindex="-1"></a><span class="do">### Plot </span></span>
<span id="cb71-735"><a href="#cb71-735" aria-hidden="true" tabindex="-1"></a>zp2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df2, <span class="fu">aes</span>(time, wage)) <span class="sc">+</span></span>
<span id="cb71-736"><a href="#cb71-736" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> wage, <span class="at">group =</span> id), <span class="at">lty =</span> <span class="st">"solid"</span>, <span class="at">colour =</span> <span class="st">"black"</span>, <span class="at">lwd =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb71-737"><a href="#cb71-737" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>( <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> wage, <span class="at">shape =</span> marriage, <span class="at">fill =</span> marriage), </span>
<span id="cb71-738"><a href="#cb71-738" aria-hidden="true" tabindex="-1"></a>               <span class="at">size =</span> <span class="dv">4</span>, <span class="at">stroke =</span> <span class="fl">1.5</span>, <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb71-739"><a href="#cb71-739" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_mark_hull</span>(<span class="at">expand =</span> <span class="fl">0.01</span>, <span class="fu">aes</span>(<span class="at">fill =</span> marriage), <span class="at">show.legend =</span> <span class="cn">FALSE</span>, <span class="at">colour =</span> <span class="cn">NA</span>) <span class="sc">+</span> </span>
<span id="cb71-740"><a href="#cb71-740" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb71-741"><a href="#cb71-741" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_shape_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="dv">21</span>, <span class="dv">24</span>)) <span class="sc">+</span></span>
<span id="cb71-742"><a href="#cb71-742" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#85144b"</span>, <span class="st">"#0074D9"</span>)) <span class="sc">+</span></span>
<span id="cb71-743"><a href="#cb71-743" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#85144b"</span>, <span class="st">"#0074D9"</span>)) <span class="sc">+</span></span>
<span id="cb71-744"><a href="#cb71-744" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.key =</span> <span class="fu">element_blank</span>(), <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb71-745"><a href="#cb71-745" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.05</span>,<span class="fl">0.95</span>), <span class="at">legend.justification =</span> <span class="fu">c</span>(<span class="st">"left"</span>, <span class="st">"top"</span>),</span>
<span id="cb71-746"><a href="#cb71-746" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb71-747"><a href="#cb71-747" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.box.background =</span> <span class="fu">element_rect</span>(<span class="at">colour =</span> <span class="st">"black"</span>),</span>
<span id="cb71-748"><a href="#cb71-748" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.spacing.y =</span> <span class="fu">unit</span>(<span class="sc">-</span><span class="fl">0.1</span>, <span class="st">"cm"</span>))</span>
<span id="cb71-749"><a href="#cb71-749" aria-hidden="true" tabindex="-1"></a>zp2</span>
<span id="cb71-750"><a href="#cb71-750" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb71-751"><a href="#cb71-751" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-752"><a href="#cb71-752" aria-hidden="true" tabindex="-1"></a><span class="fu">### One-way fixed effects</span></span>
<span id="cb71-753"><a href="#cb71-753" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-754"><a href="#cb71-754" aria-hidden="true" tabindex="-1"></a>To relax the strong assumption, we can decompose the error into two parts (between and within) if we use panel data: $\upsilon_{it} = \alpha_i + \epsilon_{it}$, where $\alpha_i$ is the time-constant (person-specific or between) part of the error, and $\epsilon_{it}$ is the time-varying (idiosyncratic or within) part of the error. </span>
<span id="cb71-755"><a href="#cb71-755" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-756"><a href="#cb71-756" aria-hidden="true" tabindex="-1"></a>We can thus split up our main assumption for consistency:</span>
<span id="cb71-757"><a href="#cb71-757" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-758"><a href="#cb71-758" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>$\E(\alpha_{i} | x_{it}) = 0$: No time-constant unobserved heterogeneity</span>
<span id="cb71-759"><a href="#cb71-759" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-760"><a href="#cb71-760" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>$\E(\epsilon_{it} | x_{it}) = 0$: No time-varying unobserved heterogeneity</span>
<span id="cb71-761"><a href="#cb71-761" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-762"><a href="#cb71-762" aria-hidden="true" tabindex="-1"></a>And write the error component model:</span>
<span id="cb71-763"><a href="#cb71-763" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-764"><a href="#cb71-764" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb71-765"><a href="#cb71-765" aria-hidden="true" tabindex="-1"></a>y_{it} = \beta x_{it} + \alpha_i + \epsilon_{it}</span>
<span id="cb71-766"><a href="#cb71-766" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb71-767"><a href="#cb71-767" aria-hidden="true" tabindex="-1"></a>As we have seen above, we can include person-dummies to estimate the model above. However, this becomes computationally intense if we have thousands of individuals</span>
<span id="cb71-768"><a href="#cb71-768" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-769"><a href="#cb71-769" aria-hidden="true" tabindex="-1"></a>Thus, we usually use a transformation approach, where we first subtract the between variance by using use the person-specific means:</span>
<span id="cb71-770"><a href="#cb71-770" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-771"><a href="#cb71-771" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb71-772"><a href="#cb71-772" aria-hidden="true" tabindex="-1"></a>\bar{y_{i}} = \beta \bar{x_{i}} + \alpha_i + \bar{\epsilon_{i}}</span>
<span id="cb71-773"><a href="#cb71-773" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb71-774"><a href="#cb71-774" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-775"><a href="#cb71-775" aria-hidden="true" tabindex="-1"></a>We then subtract this between part from the pooled data:</span>
<span id="cb71-776"><a href="#cb71-776" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-777"><a href="#cb71-777" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb71-778"><a href="#cb71-778" aria-hidden="true" tabindex="-1"></a>y_{it} - \bar{y_{i}} = \beta (x_{it}-\bar{x_{i}}) + (\alpha_i - \alpha_i) + (\epsilon_{it}-\bar{\epsilon_{i}})<span class="sc">\\</span></span>
<span id="cb71-779"><a href="#cb71-779" aria-hidden="true" tabindex="-1"></a>\tilde{y}_{it} = \beta \tilde{x}_{it} + \tilde{\epsilon}_{it}.</span>
<span id="cb71-780"><a href="#cb71-780" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb71-781"><a href="#cb71-781" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-782"><a href="#cb71-782" aria-hidden="true" tabindex="-1"></a>This is called the within transformation. For each group (individual, district, firm), we subtract the group-specific mean from the original variable. This eliminates all between-group variance, including the person-specific part of the error term ($\alpha_i$).</span>
<span id="cb71-783"><a href="#cb71-783" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-784"><a href="#cb71-784" aria-hidden="true" tabindex="-1"></a>The $\hat{\beta}_{FE}$ is then just the OLS estimator on the transformed data:</span>
<span id="cb71-785"><a href="#cb71-785" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-786"><a href="#cb71-786" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb71-787"><a href="#cb71-787" aria-hidden="true" tabindex="-1"></a>\hat{\bm \beta} = (\bm X^\intercal\bm X)^{-1}\bm X^\intercal \bm y</span>
<span id="cb71-788"><a href="#cb71-788" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb71-789"><a href="#cb71-789" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-790"><a href="#cb71-790" aria-hidden="true" tabindex="-1"></a>__This also means that every time-constant variable is wiped out - we cannot estimate their effects in FE models!__ </span>
<span id="cb71-791"><a href="#cb71-791" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb71-792"><a href="#cb71-792" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-793"><a href="#cb71-793" aria-hidden="true" tabindex="-1"></a>::: {.callout-note}</span>
<span id="cb71-794"><a href="#cb71-794" aria-hidden="true" tabindex="-1"></a>The FE estimator can only be applied to observations which are at least observed 2 times ($T \geq 2$)!__</span>
<span id="cb71-795"><a href="#cb71-795" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb71-796"><a href="#cb71-796" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-797"><a href="#cb71-797" aria-hidden="true" tabindex="-1"></a>The main assumption for consistency now is</span>
<span id="cb71-798"><a href="#cb71-798" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-799"><a href="#cb71-799" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>$\E(\epsilon_{it} | x_{it}, \alpha_i) = 0$</span>
<span id="cb71-800"><a href="#cb71-800" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-801"><a href="#cb71-801" aria-hidden="true" tabindex="-1"></a>Idiosyncratic time-variation in $\epsilon_it$ must be uncorrelated with variation in $x_it$ across all time periods. However, $\E(\alpha_{i} | x_{i})$ can be any function of $x_i$.</span>
<span id="cb71-802"><a href="#cb71-802" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-803"><a href="#cb71-803" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Time-constant unobserved heterogeneity is allowed</span>
<span id="cb71-804"><a href="#cb71-804" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-805"><a href="#cb71-805" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Only time-varying unobserved heterogeneity biases the estimator</span>
<span id="cb71-806"><a href="#cb71-806" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-807"><a href="#cb71-807" aria-hidden="true" tabindex="-1"></a>We can use the plm package with options <span class="in">`effect = "individual"`</span> and <span class="in">`model = "within"`</span> to estimate one-ways FE models:</span>
<span id="cb71-808"><a href="#cb71-808" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-811"><a href="#cb71-811" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb71-812"><a href="#cb71-812" aria-hidden="true" tabindex="-1"></a>fe2 <span class="ot">&lt;-</span> <span class="fu">plm</span>(wage <span class="sc">~</span> marriage, <span class="at">data =</span> df2,</span>
<span id="cb71-813"><a href="#cb71-813" aria-hidden="true" tabindex="-1"></a>           <span class="at">index =</span> <span class="fu">c</span>(<span class="st">"id"</span>, <span class="st">"time"</span>),</span>
<span id="cb71-814"><a href="#cb71-814" aria-hidden="true" tabindex="-1"></a>           <span class="at">effect =</span> <span class="st">"individual"</span>, <span class="at">model =</span> <span class="st">"within"</span>)</span>
<span id="cb71-815"><a href="#cb71-815" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fe2)</span>
<span id="cb71-816"><a href="#cb71-816" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb71-817"><a href="#cb71-817" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-818"><a href="#cb71-818" aria-hidden="true" tabindex="-1"></a>Hm, 850 is closer to 500, but still quite far off! Let's see why.</span>
<span id="cb71-819"><a href="#cb71-819" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-820"><a href="#cb71-820" aria-hidden="true" tabindex="-1"></a><span class="in">```{r class.source = 'fold-hide', message = FALSE, warning = FALSE}</span></span>
<span id="cb71-821"><a href="#cb71-821" aria-hidden="true" tabindex="-1"></a><span class="do">### Plot </span></span>
<span id="cb71-822"><a href="#cb71-822" aria-hidden="true" tabindex="-1"></a>zp3 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df2, <span class="fu">aes</span>(time, wage)) <span class="sc">+</span></span>
<span id="cb71-823"><a href="#cb71-823" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> wage, <span class="at">group =</span> id, <span class="at">alpha =</span> marriage_ever), <span class="at">lty =</span> <span class="st">"solid"</span>, <span class="at">colour =</span> <span class="st">"black"</span>, <span class="at">lwd =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb71-824"><a href="#cb71-824" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>( <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> wage, <span class="at">shape =</span> marriage, <span class="at">fill =</span> marriage, <span class="at">alpha =</span> marriage_ever), </span>
<span id="cb71-825"><a href="#cb71-825" aria-hidden="true" tabindex="-1"></a>              <span class="at">size =</span> <span class="dv">4</span>, <span class="at">stroke =</span> <span class="fl">1.5</span>, <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb71-826"><a href="#cb71-826" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> pti, <span class="at">group =</span> id, <span class="at">linetype =</span> <span class="st">"dashed"</span>), <span class="at">colour =</span> <span class="st">"blue"</span>, <span class="at">lwd =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb71-827"><a href="#cb71-827" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_linetype_identity</span>(<span class="at">labels =</span> <span class="st">"Counterfactual"</span>, <span class="at">guide =</span> <span class="st">"legend"</span>) <span class="sc">+</span></span>
<span id="cb71-828"><a href="#cb71-828" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_alpha_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="dv">1</span>), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb71-829"><a href="#cb71-829" aria-hidden="true" tabindex="-1"></a>  <span class="co"># geom_mark_hull(data = df2[df2$marriage_ever == 1, ], aes(x = time, y = wage, fill = marriage),</span></span>
<span id="cb71-830"><a href="#cb71-830" aria-hidden="true" tabindex="-1"></a>  <span class="co">#                expand = 0.01, show.legend = FALSE, colour = NA) + </span></span>
<span id="cb71-831"><a href="#cb71-831" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb71-832"><a href="#cb71-832" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_shape_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="dv">21</span>, <span class="dv">24</span>)) <span class="sc">+</span></span>
<span id="cb71-833"><a href="#cb71-833" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#85144b"</span>, <span class="st">"#0074D9"</span>)) <span class="sc">+</span></span>
<span id="cb71-834"><a href="#cb71-834" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#85144b"</span>, <span class="st">"#0074D9"</span>)) <span class="sc">+</span></span>
<span id="cb71-835"><a href="#cb71-835" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.key =</span> <span class="fu">element_blank</span>(), <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb71-836"><a href="#cb71-836" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.05</span>,<span class="fl">0.95</span>), <span class="at">legend.justification =</span> <span class="fu">c</span>(<span class="st">"left"</span>, <span class="st">"top"</span>),</span>
<span id="cb71-837"><a href="#cb71-837" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb71-838"><a href="#cb71-838" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.box.background =</span> <span class="fu">element_rect</span>(<span class="at">colour =</span> <span class="st">"black"</span>),</span>
<span id="cb71-839"><a href="#cb71-839" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.spacing.y =</span> <span class="fu">unit</span>(<span class="sc">-</span><span class="fl">0.1</span>, <span class="st">"cm"</span>))</span>
<span id="cb71-840"><a href="#cb71-840" aria-hidden="true" tabindex="-1"></a>zp3</span>
<span id="cb71-841"><a href="#cb71-841" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb71-842"><a href="#cb71-842" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-843"><a href="#cb71-843" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-844"><a href="#cb71-844" aria-hidden="true" tabindex="-1"></a>::: {.callout-note}</span>
<span id="cb71-845"><a href="#cb71-845" aria-hidden="true" tabindex="-1"></a>A one-ways FE would effectively drop all those observations without within-variance on the independent variables. In our case, we would disregard those who never marry. </span>
<span id="cb71-846"><a href="#cb71-846" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb71-847"><a href="#cb71-847" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-848"><a href="#cb71-848" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-849"><a href="#cb71-849" aria-hidden="true" tabindex="-1"></a>However, they also experienced an increase in wages when the other two married.</span>
<span id="cb71-850"><a href="#cb71-850" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-851"><a href="#cb71-851" aria-hidden="true" tabindex="-1"></a><span class="fu">### Two-ways FE</span></span>
<span id="cb71-852"><a href="#cb71-852" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-853"><a href="#cb71-853" aria-hidden="true" tabindex="-1"></a>To circumvent the problem above, we want to add the never-married as a control group in our estimator. </span>
<span id="cb71-854"><a href="#cb71-854" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-855"><a href="#cb71-855" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip}</span>
<span id="cb71-856"><a href="#cb71-856" aria-hidden="true" tabindex="-1"></a>__In general, it is always a good idea to control for temporal shocks!__</span>
<span id="cb71-857"><a href="#cb71-857" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb71-858"><a href="#cb71-858" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-859"><a href="#cb71-859" aria-hidden="true" tabindex="-1"></a>We can do so by including person fixed effects and time fixed effects:</span>
<span id="cb71-860"><a href="#cb71-860" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-861"><a href="#cb71-861" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb71-862"><a href="#cb71-862" aria-hidden="true" tabindex="-1"></a>y_{it} = \beta x_{it} + \alpha_i + \zeta_t + \epsilon_{it},</span>
<span id="cb71-863"><a href="#cb71-863" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb71-864"><a href="#cb71-864" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-865"><a href="#cb71-865" aria-hidden="true" tabindex="-1"></a>where $\zeta_t$ are time fixed effects (analogous to $\alpha_i$). In terms of demeaning this would look like:</span>
<span id="cb71-866"><a href="#cb71-866" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-867"><a href="#cb71-867" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb71-868"><a href="#cb71-868" aria-hidden="true" tabindex="-1"></a>(y_{it} - \bar{y}_i  - \bar{y}_t + \bar{y}) = \beta (x_{it} - \bar{x}_i - \bar{x}_t + \bar{x}) + (\epsilon_{it} - \bar{\epsilon}_i  - \bar{\epsilon}_t + \bar{\epsilon}).</span>
<span id="cb71-869"><a href="#cb71-869" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb71-870"><a href="#cb71-870" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-871"><a href="#cb71-871" aria-hidden="true" tabindex="-1"></a>This removes common time shocks independent of treatment, and takes back in individuals without variation in $x$. We basically add a `control-group' to the estimation.</span>
<span id="cb71-872"><a href="#cb71-872" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-873"><a href="#cb71-873" aria-hidden="true" tabindex="-1"></a>We can just change the <span class="in">`effect`</span> option in <span class="in">`plm`</span> to "twoways" to achieve this:</span>
<span id="cb71-874"><a href="#cb71-874" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-875"><a href="#cb71-875" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message = FALSE, warning = FALSE}</span></span>
<span id="cb71-876"><a href="#cb71-876" aria-hidden="true" tabindex="-1"></a>fe3 <span class="ot">&lt;-</span> <span class="fu">plm</span>(wage <span class="sc">~</span> marriage, <span class="at">data =</span> df2,</span>
<span id="cb71-877"><a href="#cb71-877" aria-hidden="true" tabindex="-1"></a>           <span class="at">index =</span> <span class="fu">c</span>(<span class="st">"id"</span>, <span class="st">"time"</span>),</span>
<span id="cb71-878"><a href="#cb71-878" aria-hidden="true" tabindex="-1"></a>           <span class="at">effect =</span> <span class="st">"twoways"</span>, <span class="at">model =</span> <span class="st">"within"</span>)</span>
<span id="cb71-879"><a href="#cb71-879" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fe3)</span>
<span id="cb71-880"><a href="#cb71-880" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb71-881"><a href="#cb71-881" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-882"><a href="#cb71-882" aria-hidden="true" tabindex="-1"></a>And here we go with our 500 marriage wage premium. What we do graphically is</span>
<span id="cb71-883"><a href="#cb71-883" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-884"><a href="#cb71-884" aria-hidden="true" tabindex="-1"></a><span class="in">```{r class.source = 'fold-hide', message = FALSE, warning = FALSE}</span></span>
<span id="cb71-885"><a href="#cb71-885" aria-hidden="true" tabindex="-1"></a><span class="do">### Plot </span></span>
<span id="cb71-886"><a href="#cb71-886" aria-hidden="true" tabindex="-1"></a>zp4 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df2, <span class="fu">aes</span>(time, wage)) <span class="sc">+</span></span>
<span id="cb71-887"><a href="#cb71-887" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> wage, <span class="at">group =</span> id), <span class="at">lty =</span> <span class="st">"solid"</span>, <span class="at">colour =</span> <span class="st">"black"</span>, <span class="at">lwd =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb71-888"><a href="#cb71-888" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>( <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> wage, <span class="at">shape =</span> marriage, <span class="at">fill =</span> marriage), </span>
<span id="cb71-889"><a href="#cb71-889" aria-hidden="true" tabindex="-1"></a>              <span class="at">size =</span> <span class="dv">4</span>, <span class="at">stroke =</span> <span class="fl">1.5</span>, <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb71-890"><a href="#cb71-890" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> pt, <span class="at">group =</span> id, <span class="at">linetype =</span> <span class="st">"dashed"</span>), <span class="at">colour =</span> <span class="st">"blue"</span>, <span class="at">lwd =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb71-891"><a href="#cb71-891" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_linetype_identity</span>(<span class="at">labels =</span> <span class="st">"Counterfactual"</span>, <span class="at">guide =</span> <span class="st">"legend"</span>) <span class="sc">+</span></span>
<span id="cb71-892"><a href="#cb71-892" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb71-893"><a href="#cb71-893" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_shape_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="dv">21</span>, <span class="dv">24</span>)) <span class="sc">+</span></span>
<span id="cb71-894"><a href="#cb71-894" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#85144b"</span>, <span class="st">"#0074D9"</span>)) <span class="sc">+</span></span>
<span id="cb71-895"><a href="#cb71-895" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#85144b"</span>, <span class="st">"#0074D9"</span>)) <span class="sc">+</span></span>
<span id="cb71-896"><a href="#cb71-896" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.key =</span> <span class="fu">element_blank</span>(), <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb71-897"><a href="#cb71-897" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.05</span>,<span class="fl">0.95</span>), <span class="at">legend.justification =</span> <span class="fu">c</span>(<span class="st">"left"</span>, <span class="st">"top"</span>),</span>
<span id="cb71-898"><a href="#cb71-898" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb71-899"><a href="#cb71-899" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.box.background =</span> <span class="fu">element_rect</span>(<span class="at">colour =</span> <span class="st">"black"</span>),</span>
<span id="cb71-900"><a href="#cb71-900" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.spacing.y =</span> <span class="fu">unit</span>(<span class="sc">-</span><span class="fl">0.1</span>, <span class="st">"cm"</span>))</span>
<span id="cb71-901"><a href="#cb71-901" aria-hidden="true" tabindex="-1"></a>zp4</span>
<span id="cb71-902"><a href="#cb71-902" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb71-903"><a href="#cb71-903" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-904"><a href="#cb71-904" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-905"><a href="#cb71-905" aria-hidden="true" tabindex="-1"></a><span class="fu">### Still a very critical assumption</span></span>
<span id="cb71-906"><a href="#cb71-906" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-907"><a href="#cb71-907" aria-hidden="true" tabindex="-1"></a>In the example above, the twoways FE model works very well. However, adding the control group back in comes with another (relatively strong) assumption:</span>
<span id="cb71-908"><a href="#cb71-908" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-909"><a href="#cb71-909" aria-hidden="true" tabindex="-1"></a>__Parallel trends between "treatment" and "control" units__</span>
<span id="cb71-910"><a href="#cb71-910" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-911"><a href="#cb71-911" aria-hidden="true" tabindex="-1"></a>Comparing the 3 waves before the treatment above, this assumption here holds. Both - those who marry and those who never marry - have the same time trend in wages before the "treated" marry.</span>
<span id="cb71-912"><a href="#cb71-912" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-913"><a href="#cb71-913" aria-hidden="true" tabindex="-1"></a>However, consider the following example. We still have a marriage premium of 500.</span>
<span id="cb71-914"><a href="#cb71-914" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-915"><a href="#cb71-915" aria-hidden="true" tabindex="-1"></a><span class="in">```{r class.source = 'fold-hide', message = FALSE, warning = FALSE}</span></span>
<span id="cb71-916"><a href="#cb71-916" aria-hidden="true" tabindex="-1"></a>zp5 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df2, <span class="fu">aes</span>(time, wage2)) <span class="sc">+</span></span>
<span id="cb71-917"><a href="#cb71-917" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> wage2, <span class="at">group =</span> id), <span class="at">lty =</span> <span class="st">"solid"</span>, <span class="at">colour =</span> <span class="st">"black"</span>, <span class="at">lwd =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb71-918"><a href="#cb71-918" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>( <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> wage2, <span class="at">shape =</span> marriage, <span class="at">fill =</span> marriage), </span>
<span id="cb71-919"><a href="#cb71-919" aria-hidden="true" tabindex="-1"></a>              <span class="at">size =</span> <span class="dv">4</span>, <span class="at">stroke =</span> <span class="fl">1.5</span>, <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb71-920"><a href="#cb71-920" aria-hidden="true" tabindex="-1"></a>  <span class="co"># geom_line(aes(x = time, y = pt2, group = id, linetype = "dashed"), colour = "blue", lwd = 1) +</span></span>
<span id="cb71-921"><a href="#cb71-921" aria-hidden="true" tabindex="-1"></a>  <span class="co"># geom_line(aes(x = time, y = pt2_cr, group = id, linetype = "dashed"), colour = "grey", lwd = 1, show.legend = FALSE, alpha = 0.7) +</span></span>
<span id="cb71-922"><a href="#cb71-922" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_linetype_identity</span>(<span class="at">labels =</span> <span class="st">"Counterfactual"</span>, <span class="at">guide =</span> <span class="st">"legend"</span>) <span class="sc">+</span></span>
<span id="cb71-923"><a href="#cb71-923" aria-hidden="true" tabindex="-1"></a>  <span class="co"># scale_alpha_manual(values = c(0.3, 1), guide = "none") +</span></span>
<span id="cb71-924"><a href="#cb71-924" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ylim(3.3, 9.2) + expand_limits(y = c(0, 0)) + </span></span>
<span id="cb71-925"><a href="#cb71-925" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb71-926"><a href="#cb71-926" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_shape_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="dv">21</span>, <span class="dv">24</span>)) <span class="sc">+</span></span>
<span id="cb71-927"><a href="#cb71-927" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#85144b"</span>, <span class="st">"#0074D9"</span>)) <span class="sc">+</span></span>
<span id="cb71-928"><a href="#cb71-928" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#85144b"</span>, <span class="st">"#0074D9"</span>)) <span class="sc">+</span></span>
<span id="cb71-929"><a href="#cb71-929" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"wage"</span>) <span class="sc">+</span></span>
<span id="cb71-930"><a href="#cb71-930" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.key =</span> <span class="fu">element_blank</span>(), <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb71-931"><a href="#cb71-931" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.05</span>,<span class="fl">0.95</span>), <span class="at">legend.justification =</span> <span class="fu">c</span>(<span class="st">"left"</span>, <span class="st">"top"</span>),</span>
<span id="cb71-932"><a href="#cb71-932" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb71-933"><a href="#cb71-933" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.box.background =</span> <span class="fu">element_rect</span>(<span class="at">colour =</span> <span class="st">"black"</span>),</span>
<span id="cb71-934"><a href="#cb71-934" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.spacing.y =</span> <span class="fu">unit</span>(<span class="sc">-</span><span class="fl">0.1</span>, <span class="st">"cm"</span>))</span>
<span id="cb71-935"><a href="#cb71-935" aria-hidden="true" tabindex="-1"></a>zp5</span>
<span id="cb71-936"><a href="#cb71-936" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb71-937"><a href="#cb71-937" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-938"><a href="#cb71-938" aria-hidden="true" tabindex="-1"></a>A two-ways FE will now give us:</span>
<span id="cb71-939"><a href="#cb71-939" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-940"><a href="#cb71-940" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message = FALSE, warning = FALSE}</span></span>
<span id="cb71-941"><a href="#cb71-941" aria-hidden="true" tabindex="-1"></a>fe3 <span class="ot">&lt;-</span> <span class="fu">plm</span>(wage2 <span class="sc">~</span> marriage, <span class="at">data =</span> df2,</span>
<span id="cb71-942"><a href="#cb71-942" aria-hidden="true" tabindex="-1"></a>           <span class="at">index =</span> <span class="fu">c</span>(<span class="st">"id"</span>, <span class="st">"time"</span>),</span>
<span id="cb71-943"><a href="#cb71-943" aria-hidden="true" tabindex="-1"></a>           <span class="at">effect =</span> <span class="st">"twoways"</span>, <span class="at">model =</span> <span class="st">"within"</span>)</span>
<span id="cb71-944"><a href="#cb71-944" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fe3)</span>
<span id="cb71-945"><a href="#cb71-945" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb71-946"><a href="#cb71-946" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-947"><a href="#cb71-947" aria-hidden="true" tabindex="-1"></a>The problem: the model does not take into account that the treatment group already had a steeper wage trajectory than the control group. The parallel trends assumption fails.</span>
<span id="cb71-948"><a href="#cb71-948" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-949"><a href="#cb71-949" aria-hidden="true" tabindex="-1"></a><span class="in">```{r class.source = 'fold-hide', message = FALSE, warning = FALSE}</span></span>
<span id="cb71-950"><a href="#cb71-950" aria-hidden="true" tabindex="-1"></a>zp5 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df2, <span class="fu">aes</span>(time, wage2)) <span class="sc">+</span></span>
<span id="cb71-951"><a href="#cb71-951" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> wage2, <span class="at">group =</span> id), <span class="at">lty =</span> <span class="st">"solid"</span>, <span class="at">colour =</span> <span class="st">"black"</span>, <span class="at">lwd =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb71-952"><a href="#cb71-952" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>( <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> wage2, <span class="at">shape =</span> marriage, <span class="at">fill =</span> marriage), </span>
<span id="cb71-953"><a href="#cb71-953" aria-hidden="true" tabindex="-1"></a>              <span class="at">size =</span> <span class="dv">4</span>, <span class="at">stroke =</span> <span class="fl">1.5</span>, <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb71-954"><a href="#cb71-954" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> pt2, <span class="at">group =</span> id, <span class="at">linetype =</span> <span class="st">"dashed"</span>), <span class="at">colour =</span> <span class="st">"blue"</span>, <span class="at">lwd =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb71-955"><a href="#cb71-955" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> pt2_cr, <span class="at">group =</span> id, <span class="at">linetype =</span> <span class="st">"dashed"</span>), <span class="at">colour =</span> <span class="st">"grey"</span>, <span class="at">lwd =</span> <span class="dv">1</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb71-956"><a href="#cb71-956" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_linetype_identity</span>(<span class="at">labels =</span> <span class="st">"Counterfactual"</span>, <span class="at">guide =</span> <span class="st">"legend"</span>) <span class="sc">+</span></span>
<span id="cb71-957"><a href="#cb71-957" aria-hidden="true" tabindex="-1"></a>  <span class="co"># scale_alpha_manual(values = c(0.3, 1), guide = "none") +</span></span>
<span id="cb71-958"><a href="#cb71-958" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ylim(3.3, 9.2) + expand_limits(y = c(0, 0)) + </span></span>
<span id="cb71-959"><a href="#cb71-959" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb71-960"><a href="#cb71-960" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_shape_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="dv">21</span>, <span class="dv">24</span>)) <span class="sc">+</span></span>
<span id="cb71-961"><a href="#cb71-961" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#85144b"</span>, <span class="st">"#0074D9"</span>)) <span class="sc">+</span></span>
<span id="cb71-962"><a href="#cb71-962" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#85144b"</span>, <span class="st">"#0074D9"</span>)) <span class="sc">+</span></span>
<span id="cb71-963"><a href="#cb71-963" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"wage"</span>) <span class="sc">+</span></span>
<span id="cb71-964"><a href="#cb71-964" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.key =</span> <span class="fu">element_blank</span>(), <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb71-965"><a href="#cb71-965" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.05</span>,<span class="fl">0.95</span>), <span class="at">legend.justification =</span> <span class="fu">c</span>(<span class="st">"left"</span>, <span class="st">"top"</span>),</span>
<span id="cb71-966"><a href="#cb71-966" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb71-967"><a href="#cb71-967" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.box.background =</span> <span class="fu">element_rect</span>(<span class="at">colour =</span> <span class="st">"black"</span>),</span>
<span id="cb71-968"><a href="#cb71-968" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.spacing.y =</span> <span class="fu">unit</span>(<span class="sc">-</span><span class="fl">0.1</span>, <span class="st">"cm"</span>))</span>
<span id="cb71-969"><a href="#cb71-969" aria-hidden="true" tabindex="-1"></a>zp5</span>
<span id="cb71-970"><a href="#cb71-970" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb71-971"><a href="#cb71-971" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-972"><a href="#cb71-972" aria-hidden="true" tabindex="-1"></a>A possible extension to tackle this problem are fixed effects individual slopes (FEIS) estimators. See the second part.</span>
<span id="cb71-973"><a href="#cb71-973" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-974"><a href="#cb71-974" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-975"><a href="#cb71-975" aria-hidden="true" tabindex="-1"></a><span class="fu">### Difference in Differences</span></span>
<span id="cb71-976"><a href="#cb71-976" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-977"><a href="#cb71-977" aria-hidden="true" tabindex="-1"></a>The difference-in-differences (DD) design is a very basic and popular design to identify causal treatment effects in a panel data setting. </span>
<span id="cb71-978"><a href="#cb71-978" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-979"><a href="#cb71-979" aria-hidden="true" tabindex="-1"></a>The most basic setting, is a $2\times 2$ DD estimator. It consists of a setting where we have 2 groups: a treatment group ($T$) and control group ($C$). Each group has been observed at 2 time points: before treatment ($pre$) and after treatment ($post$). </span>
<span id="cb71-980"><a href="#cb71-980" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-981"><a href="#cb71-981" aria-hidden="true" tabindex="-1"></a>In this setting we can calculate the change in the treatment group:</span>
<span id="cb71-982"><a href="#cb71-982" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb71-983"><a href="#cb71-983" aria-hidden="true" tabindex="-1"></a>\E(\Delta y_{T}) = \E(y_{T}^{post}) - \E(y_{T}^{pre}),</span>
<span id="cb71-984"><a href="#cb71-984" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb71-985"><a href="#cb71-985" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-986"><a href="#cb71-986" aria-hidden="true" tabindex="-1"></a>and likewise in the control group:</span>
<span id="cb71-987"><a href="#cb71-987" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb71-988"><a href="#cb71-988" aria-hidden="true" tabindex="-1"></a>\E(\Delta y_{C}) = \E(y_{C}^{post}) - \E(y_{C}^{pre}).</span>
<span id="cb71-989"><a href="#cb71-989" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb71-990"><a href="#cb71-990" aria-hidden="true" tabindex="-1"></a>The simple DD estimator is then the difference between the differences in the treatment group and the differences in the control group:</span>
<span id="cb71-991"><a href="#cb71-991" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-992"><a href="#cb71-992" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb71-993"><a href="#cb71-993" aria-hidden="true" tabindex="-1"></a>\hat{\delta}_{DD} = \E(\Delta y_{T}) - \E(\Delta y_{C}) = (\E(y_{T}^{post}) - \E(y_{T}^{pre})) - (\E(y_{C}^{post}) - \E(y_{C}^{pre})).</span>
<span id="cb71-994"><a href="#cb71-994" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb71-995"><a href="#cb71-995" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-996"><a href="#cb71-996" aria-hidden="true" tabindex="-1"></a>In our marriage example:</span>
<span id="cb71-997"><a href="#cb71-997" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1000"><a href="#cb71-1000" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb71-1001"><a href="#cb71-1001" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>marry_post <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb71-1002"><a href="#cb71-1002" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>marry_post[df2<span class="sc">$</span>time <span class="sc">&gt;=</span> <span class="dv">4</span>] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb71-1003"><a href="#cb71-1003" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1004"><a href="#cb71-1004" aria-hidden="true" tabindex="-1"></a>y_t_post <span class="ot">&lt;-</span> <span class="fu">mean</span>(df2<span class="sc">$</span>wage[df2<span class="sc">$</span>marry_post <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> df2<span class="sc">$</span>marriage_ever <span class="sc">==</span> <span class="dv">1</span>])</span>
<span id="cb71-1005"><a href="#cb71-1005" aria-hidden="true" tabindex="-1"></a>y_t_pre <span class="ot">&lt;-</span> <span class="fu">mean</span>(df2<span class="sc">$</span>wage[df2<span class="sc">$</span>marry_post <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> df2<span class="sc">$</span>marriage_ever <span class="sc">==</span> <span class="dv">1</span>])</span>
<span id="cb71-1006"><a href="#cb71-1006" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1007"><a href="#cb71-1007" aria-hidden="true" tabindex="-1"></a>y_c_post <span class="ot">&lt;-</span> <span class="fu">mean</span>(df2<span class="sc">$</span>wage[df2<span class="sc">$</span>marry_post <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> df2<span class="sc">$</span>marriage_ever <span class="sc">==</span> <span class="dv">0</span>])</span>
<span id="cb71-1008"><a href="#cb71-1008" aria-hidden="true" tabindex="-1"></a>y_c_pre <span class="ot">&lt;-</span> <span class="fu">mean</span>(df2<span class="sc">$</span>wage[df2<span class="sc">$</span>marry_post <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> df2<span class="sc">$</span>marriage_ever <span class="sc">==</span> <span class="dv">0</span>])</span>
<span id="cb71-1009"><a href="#cb71-1009" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1010"><a href="#cb71-1010" aria-hidden="true" tabindex="-1"></a><span class="co"># Diff in Diff</span></span>
<span id="cb71-1011"><a href="#cb71-1011" aria-hidden="true" tabindex="-1"></a>(y_t_post <span class="sc">-</span> y_t_pre) <span class="sc">-</span> (y_c_post <span class="sc">-</span> y_c_pre)</span>
<span id="cb71-1012"><a href="#cb71-1012" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1013"><a href="#cb71-1013" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb71-1014"><a href="#cb71-1014" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1015"><a href="#cb71-1015" aria-hidden="true" tabindex="-1"></a>In a setting where $T=2$ or in a setting where every observation is treated at the same time, the DD equals the two-ways FE. In general, DD and two-ways DD are often seen as equivalents. However, the situation becomes more complicated when treatment timing varies <span class="co">[</span><span class="ot">@Goodman-Bacon.2021</span><span class="co">]</span>.</span>
<span id="cb71-1016"><a href="#cb71-1016" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1017"><a href="#cb71-1017" aria-hidden="true" tabindex="-1"></a>We can receive the same estimator in a simple regression. Lets assume $D \in {0, 1}$ is a binary indicator of the treatment group and $Post \in {0, 1}$ a binary indicator of pre- or post-treatment period. Then we can get the DD estimator with an interaction between those two two variables:</span>
<span id="cb71-1018"><a href="#cb71-1018" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1019"><a href="#cb71-1019" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb71-1020"><a href="#cb71-1020" aria-hidden="true" tabindex="-1"></a>y_{it} = \alpha + \gamma D_{i} + \lambda Post_{t} + \delta_{DD} (D_{i} \times Post_{t}) + \upsilon_{it}.</span>
<span id="cb71-1021"><a href="#cb71-1021" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb71-1022"><a href="#cb71-1022" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1023"><a href="#cb71-1023" aria-hidden="true" tabindex="-1"></a><span class="al">![Diff-in-Diff design, adopted from @Cunningham.2021](fig/dd-diagram-1.png)</span></span>
<span id="cb71-1024"><a href="#cb71-1024" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1025"><a href="#cb71-1025" aria-hidden="true" tabindex="-1"></a>The coefficients correspond to:</span>
<span id="cb71-1026"><a href="#cb71-1026" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1027"><a href="#cb71-1027" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>$\alpha$: average outcome of control group in pre-treatment period </span>
<span id="cb71-1028"><a href="#cb71-1028" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1029"><a href="#cb71-1029" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>$\gamma$: average difference between treatment and control group in pre-treatment period </span>
<span id="cb71-1030"><a href="#cb71-1030" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1031"><a href="#cb71-1031" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>$\lambda$: average difference between post- pre-treatment period in control group</span>
<span id="cb71-1032"><a href="#cb71-1032" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1033"><a href="#cb71-1033" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>$\delta_{DD}$: difference between treatment and control group in difference between post- pre-treatment period </span>
<span id="cb71-1034"><a href="#cb71-1034" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1035"><a href="#cb71-1035" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1038"><a href="#cb71-1038" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb71-1039"><a href="#cb71-1039" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">lm</span>(wage <span class="sc">~</span> marriage_ever<span class="sc">*</span>marry_post, <span class="at">data =</span> df2))</span>
<span id="cb71-1040"><a href="#cb71-1040" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb71-1041"><a href="#cb71-1041" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1042"><a href="#cb71-1042" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1043"><a href="#cb71-1043" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip}</span>
<span id="cb71-1044"><a href="#cb71-1044" aria-hidden="true" tabindex="-1"></a><span class="fu">## Selecting the estimation sample</span></span>
<span id="cb71-1045"><a href="#cb71-1045" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1046"><a href="#cb71-1046" aria-hidden="true" tabindex="-1"></a>When estimating FE or Diff-in-Diff estimators, selecting the estimation sample may play an important role. </span>
<span id="cb71-1047"><a href="#cb71-1047" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1048"><a href="#cb71-1048" aria-hidden="true" tabindex="-1"></a>@Bruderl.2015 recommend "*one should restrict the estimation sample to those persons who can potentially</span>
<span id="cb71-1049"><a href="#cb71-1049" aria-hidden="true" tabindex="-1"></a>experience the treatment during the observation window*". Usually this means that we start with the not-yet-treated and omit the already-treated (as in the Diff-in-Diff example above).</span>
<span id="cb71-1050"><a href="#cb71-1050" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1051"><a href="#cb71-1051" aria-hidden="true" tabindex="-1"></a>The rational behind this: the already-treated may experience ongoing dynamic treatment effects. We thus do not want them as a control group. This discussion is similar to the discussion about dynamic treatment effects (<span class="co">[</span><span class="ot">Next Chapter</span><span class="co">](Panel_part2.qmd#dynamic-diff-in-diff)</span>). Differences are often likely to be small, but it is advisable to do at least do some robustness checks!</span>
<span id="cb71-1052"><a href="#cb71-1052" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb71-1053"><a href="#cb71-1053" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1054"><a href="#cb71-1054" aria-hidden="true" tabindex="-1"></a><span class="fu"># Random effects estimator</span></span>
<span id="cb71-1055"><a href="#cb71-1055" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1056"><a href="#cb71-1056" aria-hidden="true" tabindex="-1"></a>There is another popular estimation strategy for panel data: the random effects (RE) estimator. The RE estimator is not only popular for panel data but also very commonly used for hierarchical data, where it is usually called a "multilevel model". More precisely, the RE estimator in the panel context equals a "multilevel model with random intercepts".</span>
<span id="cb71-1057"><a href="#cb71-1057" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1058"><a href="#cb71-1058" aria-hidden="true" tabindex="-1"></a>The RE estimator has two main "advantages" over the FE estimator:</span>
<span id="cb71-1059"><a href="#cb71-1059" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1060"><a href="#cb71-1060" aria-hidden="true" tabindex="-1"></a>1) It is more efficient if $\E(\alpha_{i} | x_{it}) = 0$: it has lower standard errors </span>
<span id="cb71-1061"><a href="#cb71-1061" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1062"><a href="#cb71-1062" aria-hidden="true" tabindex="-1"></a>2) It allows to estimate the effects of time-constant variables</span>
<span id="cb71-1063"><a href="#cb71-1063" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1064"><a href="#cb71-1064" aria-hidden="true" tabindex="-1"></a>However, it obscures the main advantage of panel data: the relaxation of assumptions for consistency of estimators. The RE estimator needs the same assumptions as POLS for consistency:</span>
<span id="cb71-1065"><a href="#cb71-1065" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1066"><a href="#cb71-1066" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>$\E(\alpha_{i} | x_{it}) = 0$: No time-constant unobserved heterogeneity</span>
<span id="cb71-1067"><a href="#cb71-1067" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1068"><a href="#cb71-1068" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>$\E(\epsilon_{it} | x_{it}) = 0$: No time-varying unobserved heterogeneity</span>
<span id="cb71-1069"><a href="#cb71-1069" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1070"><a href="#cb71-1070" aria-hidden="true" tabindex="-1"></a>The RE estimator can be written as:</span>
<span id="cb71-1071"><a href="#cb71-1071" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1072"><a href="#cb71-1072" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb71-1073"><a href="#cb71-1073" aria-hidden="true" tabindex="-1"></a>y_{it} = \alpha + \beta x_{it} + \alpha_i + \vartheta_{it}.</span>
<span id="cb71-1074"><a href="#cb71-1074" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb71-1075"><a href="#cb71-1075" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1076"><a href="#cb71-1076" aria-hidden="true" tabindex="-1"></a>Instead of assuming $\alpha_i$ are fixed effects, we treat them as i.i.d random effects, usually assuming they are normally distributed</span>
<span id="cb71-1077"><a href="#cb71-1077" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1078"><a href="#cb71-1078" aria-hidden="true" tabindex="-1"></a>We can also write the RE as a quasi-demeaned estimator:</span>
<span id="cb71-1079"><a href="#cb71-1079" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1080"><a href="#cb71-1080" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb71-1081"><a href="#cb71-1081" aria-hidden="true" tabindex="-1"></a>(y_{it} - \lambda\bar{y}_i) = \beta (x_{it} - \lambda\bar{x}_i) + (\epsilon_{it} - \lambda\bar{\epsilon}_i)  </span>
<span id="cb71-1082"><a href="#cb71-1082" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb71-1083"><a href="#cb71-1083" aria-hidden="true" tabindex="-1"></a>where $\hat{\lambda} = 1 - \sqrt{\frac{\sigma^2_\epsilon}{\sigma^2_\epsilon + T\sigma^2_\alpha}}$, with $\sigma^2_\epsilon$ denoting the residual variance, and $\sigma^2_\alpha$ denoting the variance of the individual effects $\alpha_i$.</span>
<span id="cb71-1084"><a href="#cb71-1084" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1085"><a href="#cb71-1085" aria-hidden="true" tabindex="-1"></a>The RE (as POLS) is thus a weighted average of between and within estimator. The weights are determined by the residual variance in FE as share of total residual variance:</span>
<span id="cb71-1086"><a href="#cb71-1086" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1087"><a href="#cb71-1087" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb71-1088"><a href="#cb71-1088" aria-hidden="true" tabindex="-1"></a>\beta_{RE} = \omega_{GLS} \beta_{FE} + (1-\omega_{GLS}) \beta_{BE},<span class="sc">\\</span></span>
<span id="cb71-1089"><a href="#cb71-1089" aria-hidden="true" tabindex="-1"></a>\omega_{GLS} = \frac{\sigma^2_{\tilde{x}}}{\sigma^2_{\tilde{x}} + \phi^2 (\sigma^2_x-\sigma^2_{\tilde{x}})},<span class="sc">\\</span></span>
<span id="cb71-1090"><a href="#cb71-1090" aria-hidden="true" tabindex="-1"></a>\phi = \sqrt{\frac{\hat{\sigma}^2_{FE}}{\hat{\sigma}^2_{BE}}},</span>
<span id="cb71-1091"><a href="#cb71-1091" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb71-1092"><a href="#cb71-1092" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1093"><a href="#cb71-1093" aria-hidden="true" tabindex="-1"></a>It thus follows that:</span>
<span id="cb71-1094"><a href="#cb71-1094" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1095"><a href="#cb71-1095" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>$T$ large, $\sigma^2_\alpha$ large, then RE $\rightarrow$ FE</span>
<span id="cb71-1096"><a href="#cb71-1096" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1097"><a href="#cb71-1097" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>$\sigma^2_\alpha$ small, then RE $\rightarrow$ POLS</span>
<span id="cb71-1098"><a href="#cb71-1098" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1099"><a href="#cb71-1099" aria-hidden="true" tabindex="-1"></a>The RE uses all the available information - between and within variance - and weights the two components by its "predictive power". This makes it the most efficient estimator. </span>
<span id="cb71-1100"><a href="#cb71-1100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1101"><a href="#cb71-1101" aria-hidden="true" tabindex="-1"></a>We could, by the way, do the same for the POLS estimator. Here, however, the weights are just determined by the overall and the within variance in the independent variable:</span>
<span id="cb71-1102"><a href="#cb71-1102" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb71-1103"><a href="#cb71-1103" aria-hidden="true" tabindex="-1"></a>\beta_{POLS} = \omega_{OLS} \beta_{FE} + (1-\omega_{OLS}) \beta_{BE},<span class="sc">\\</span></span>
<span id="cb71-1104"><a href="#cb71-1104" aria-hidden="true" tabindex="-1"></a>\omega_{OLS} = \sigma^2_{\tilde{x}} / \sigma^2_x.</span>
<span id="cb71-1105"><a href="#cb71-1105" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb71-1106"><a href="#cb71-1106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1107"><a href="#cb71-1107" aria-hidden="true" tabindex="-1"></a>Let's estimate the RE for the happiness - age example, again using the <span class="in">`plm`</span> package.</span>
<span id="cb71-1108"><a href="#cb71-1108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1111"><a href="#cb71-1111" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb71-1112"><a href="#cb71-1112" aria-hidden="true" tabindex="-1"></a>re1 <span class="ot">&lt;-</span> <span class="fu">plm</span>(happiness <span class="sc">~</span> age, <span class="at">data =</span> df,</span>
<span id="cb71-1113"><a href="#cb71-1113" aria-hidden="true" tabindex="-1"></a>           <span class="at">index =</span> <span class="fu">c</span>(<span class="st">"id"</span>, <span class="st">"time"</span>),</span>
<span id="cb71-1114"><a href="#cb71-1114" aria-hidden="true" tabindex="-1"></a>           <span class="at">effect =</span> <span class="st">"individual"</span>, <span class="at">model =</span> <span class="st">"random"</span>)</span>
<span id="cb71-1115"><a href="#cb71-1115" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(re1)</span>
<span id="cb71-1116"><a href="#cb71-1116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1117"><a href="#cb71-1117" aria-hidden="true" tabindex="-1"></a><span class="co"># Save for later</span></span>
<span id="cb71-1118"><a href="#cb71-1118" aria-hidden="true" tabindex="-1"></a>df_orig <span class="ot">&lt;-</span> df</span>
<span id="cb71-1119"><a href="#cb71-1119" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb71-1120"><a href="#cb71-1120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1121"><a href="#cb71-1121" aria-hidden="true" tabindex="-1"></a>This indicates that there is barely any relation between age and happiness. This is because the within and the between estimates cancel out each other. </span>
<span id="cb71-1122"><a href="#cb71-1122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1123"><a href="#cb71-1123" aria-hidden="true" tabindex="-1"></a><span class="in">```{r class.source = 'fold-hide', message = FALSE, warning = FALSE}</span></span>
<span id="cb71-1124"><a href="#cb71-1124" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(viridis)</span>
<span id="cb71-1125"><a href="#cb71-1125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1126"><a href="#cb71-1126" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">6</span></span>
<span id="cb71-1127"><a href="#cb71-1127" aria-hidden="true" tabindex="-1"></a>T <span class="ot">&lt;-</span> <span class="dv">4</span></span>
<span id="cb71-1128"><a href="#cb71-1128" aria-hidden="true" tabindex="-1"></a><span class="do">### Models</span></span>
<span id="cb71-1129"><a href="#cb71-1129" aria-hidden="true" tabindex="-1"></a><span class="co"># Total line for plot</span></span>
<span id="cb71-1130"><a href="#cb71-1130" aria-hidden="true" tabindex="-1"></a>lm1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(happiness <span class="sc">~</span> age, <span class="at">data =</span> df)</span>
<span id="cb71-1131"><a href="#cb71-1131" aria-hidden="true" tabindex="-1"></a>lm2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(happiness <span class="sc">~</span> age <span class="sc">+</span> cohort, <span class="at">data =</span> df)</span>
<span id="cb71-1132"><a href="#cb71-1132" aria-hidden="true" tabindex="-1"></a>lm3 <span class="ot">&lt;-</span> <span class="fu">lm</span>(happiness <span class="sc">~</span> age <span class="sc">+</span> idname, <span class="at">data =</span> df)</span>
<span id="cb71-1133"><a href="#cb71-1133" aria-hidden="true" tabindex="-1"></a>lm4 <span class="ot">&lt;-</span> <span class="fu">lm</span>(m_happiness <span class="sc">~</span> m_age, <span class="at">data =</span> df)</span>
<span id="cb71-1134"><a href="#cb71-1134" aria-hidden="true" tabindex="-1"></a>re <span class="ot">&lt;-</span> <span class="fu">plm</span>(happiness <span class="sc">~</span> age, df, <span class="at">model =</span> <span class="st">"random"</span>, <span class="at">effect =</span> <span class="st">"individual"</span>)</span>
<span id="cb71-1135"><a href="#cb71-1135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1136"><a href="#cb71-1136" aria-hidden="true" tabindex="-1"></a><span class="do">### Compare POLS, BE, FE, and RE</span></span>
<span id="cb71-1137"><a href="#cb71-1137" aria-hidden="true" tabindex="-1"></a>estimates <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">ncol =</span> <span class="dv">3</span>, <span class="at">nrow =</span> <span class="dv">4</span>))</span>
<span id="cb71-1138"><a href="#cb71-1138" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(estimates) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Model"</span>, <span class="st">"Intercept"</span>, <span class="st">"slope"</span>)</span>
<span id="cb71-1139"><a href="#cb71-1139" aria-hidden="true" tabindex="-1"></a>estimates[<span class="dv">1</span>,] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"POLS"</span>,</span>
<span id="cb71-1140"><a href="#cb71-1140" aria-hidden="true" tabindex="-1"></a>                   lm1<span class="sc">$</span>coefficients[<span class="dv">1</span>],</span>
<span id="cb71-1141"><a href="#cb71-1141" aria-hidden="true" tabindex="-1"></a>                   lm1<span class="sc">$</span>coefficients[<span class="dv">2</span>])</span>
<span id="cb71-1142"><a href="#cb71-1142" aria-hidden="true" tabindex="-1"></a>estimates[<span class="dv">2</span>,] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"BE"</span>,</span>
<span id="cb71-1143"><a href="#cb71-1143" aria-hidden="true" tabindex="-1"></a>                   lm4<span class="sc">$</span>coefficients[<span class="dv">1</span>], </span>
<span id="cb71-1144"><a href="#cb71-1144" aria-hidden="true" tabindex="-1"></a>                   lm4<span class="sc">$</span>coefficients[<span class="dv">2</span>])</span>
<span id="cb71-1145"><a href="#cb71-1145" aria-hidden="true" tabindex="-1"></a>estimates[<span class="dv">3</span>,] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"FE"</span>,</span>
<span id="cb71-1146"><a href="#cb71-1146" aria-hidden="true" tabindex="-1"></a>                   lm3<span class="sc">$</span>coefficients[<span class="dv">1</span>] <span class="sc">+</span> <span class="dv">1</span><span class="sc">/</span>N <span class="sc">*</span> lm3<span class="sc">$</span>coefficients[<span class="dv">3</span>]  <span class="sc">+</span> <span class="dv">1</span><span class="sc">/</span>N <span class="sc">*</span> lm3<span class="sc">$</span>coefficients[<span class="dv">4</span>] </span>
<span id="cb71-1147"><a href="#cb71-1147" aria-hidden="true" tabindex="-1"></a>                   <span class="sc">+</span> <span class="dv">1</span><span class="sc">/</span>N <span class="sc">*</span> lm3<span class="sc">$</span>coefficients[<span class="dv">5</span>]  <span class="sc">+</span> <span class="dv">1</span><span class="sc">/</span>N <span class="sc">*</span> lm3<span class="sc">$</span>coefficients[<span class="dv">6</span>]  <span class="sc">+</span> <span class="dv">1</span><span class="sc">/</span>N <span class="sc">*</span> lm3<span class="sc">$</span>coefficients[<span class="dv">7</span>], </span>
<span id="cb71-1148"><a href="#cb71-1148" aria-hidden="true" tabindex="-1"></a>                   lm3<span class="sc">$</span>coefficients[<span class="dv">2</span>])</span>
<span id="cb71-1149"><a href="#cb71-1149" aria-hidden="true" tabindex="-1"></a>estimates[<span class="dv">4</span>,] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"RE"</span>,</span>
<span id="cb71-1150"><a href="#cb71-1150" aria-hidden="true" tabindex="-1"></a>                   re<span class="sc">$</span>coefficients[<span class="dv">1</span>], </span>
<span id="cb71-1151"><a href="#cb71-1151" aria-hidden="true" tabindex="-1"></a>                   re<span class="sc">$</span>coefficients[<span class="dv">2</span>])</span>
<span id="cb71-1152"><a href="#cb71-1152" aria-hidden="true" tabindex="-1"></a>estimates[, <span class="sc">-</span><span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">apply</span>(estimates[, <span class="sc">-</span><span class="dv">1</span>], <span class="dv">2</span>, <span class="at">FUN =</span> <span class="cf">function</span>(x) <span class="fu">as.numeric</span>(x))</span>
<span id="cb71-1153"><a href="#cb71-1153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1154"><a href="#cb71-1154" aria-hidden="true" tabindex="-1"></a>newdf <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">nrow =</span> <span class="dv">2</span>))</span>
<span id="cb71-1155"><a href="#cb71-1155" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(newdf) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>)</span>
<span id="cb71-1156"><a href="#cb71-1156" aria-hidden="true" tabindex="-1"></a>newdf<span class="sc">$</span>x <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">min</span>(df<span class="sc">$</span>age), <span class="fu">max</span>(df<span class="sc">$</span>age))</span>
<span id="cb71-1157"><a href="#cb71-1157" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(estimates)){</span>
<span id="cb71-1158"><a href="#cb71-1158" aria-hidden="true" tabindex="-1"></a>  newdf<span class="sc">$</span>y <span class="ot">&lt;-</span> estimates[i, <span class="st">"Intercept"</span>] <span class="sc">+</span> estimates[i, <span class="st">"slope"</span>]<span class="sc">*</span>newdf<span class="sc">$</span>x</span>
<span id="cb71-1159"><a href="#cb71-1159" aria-hidden="true" tabindex="-1"></a>  newdf<span class="sc">$</span>Model <span class="ot">&lt;-</span> estimates[i, <span class="st">"Model"</span>]</span>
<span id="cb71-1160"><a href="#cb71-1160" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(i <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb71-1161"><a href="#cb71-1161" aria-hidden="true" tabindex="-1"></a>    pred <span class="ot">&lt;-</span> newdf</span>
<span id="cb71-1162"><a href="#cb71-1162" aria-hidden="true" tabindex="-1"></a>  }<span class="cf">else</span>{pred <span class="ot">&lt;-</span> <span class="fu">rbind</span>(pred, newdf)}</span>
<span id="cb71-1163"><a href="#cb71-1163" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb71-1164"><a href="#cb71-1164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1165"><a href="#cb71-1165" aria-hidden="true" tabindex="-1"></a>estimates<span class="sc">$</span>Model <span class="ot">&lt;-</span> <span class="fu">factor</span>(estimates<span class="sc">$</span>Model, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"POLS"</span>, <span class="st">"BE"</span>, <span class="st">"FE"</span>, <span class="st">"RE"</span>))</span>
<span id="cb71-1166"><a href="#cb71-1166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1167"><a href="#cb71-1167" aria-hidden="true" tabindex="-1"></a>gg_color_hue <span class="ot">&lt;-</span> <span class="cf">function</span>(n) {</span>
<span id="cb71-1168"><a href="#cb71-1168" aria-hidden="true" tabindex="-1"></a>  hues <span class="ot">=</span> <span class="fu">seq</span>(<span class="dv">15</span>, <span class="dv">375</span>, <span class="at">length =</span> n <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb71-1169"><a href="#cb71-1169" aria-hidden="true" tabindex="-1"></a>  <span class="fu">hcl</span>(<span class="at">h =</span> hues, <span class="at">l =</span> <span class="dv">65</span>, <span class="at">c =</span> <span class="dv">100</span>)[<span class="dv">1</span><span class="sc">:</span>n]</span>
<span id="cb71-1170"><a href="#cb71-1170" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb71-1171"><a href="#cb71-1171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1172"><a href="#cb71-1172" aria-hidden="true" tabindex="-1"></a>zp6 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df, <span class="fu">aes</span>(age, happiness)) <span class="sc">+</span></span>
<span id="cb71-1173"><a href="#cb71-1173" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> age, <span class="at">y =</span> happiness, <span class="at">shape =</span> idname),</span>
<span id="cb71-1174"><a href="#cb71-1174" aria-hidden="true" tabindex="-1"></a>             <span class="at">colour =</span> <span class="fu">rep</span>(<span class="fu">gg_color_hue</span>(<span class="dv">6</span>), <span class="at">each =</span> T),</span>
<span id="cb71-1175"><a href="#cb71-1175" aria-hidden="true" tabindex="-1"></a>              <span class="at">size =</span> <span class="dv">2</span>, <span class="at">stroke =</span> <span class="dv">1</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb71-1176"><a href="#cb71-1176" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">'lm'</span>, <span class="at">formula =</span> y <span class="sc">~</span> x, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>,</span>
<span id="cb71-1177"><a href="#cb71-1177" aria-hidden="true" tabindex="-1"></a>              <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="fu">aes</span>(<span class="at">group =</span> idname), <span class="at">colour =</span> <span class="fu">alpha</span>(<span class="st">"gray"</span>, <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb71-1178"><a href="#cb71-1178" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> <span class="fu">unique</span>(df[, <span class="fu">c</span>(<span class="st">"m_age"</span>, <span class="st">"m_happiness"</span>, <span class="st">"idname"</span>)]),</span>
<span id="cb71-1179"><a href="#cb71-1179" aria-hidden="true" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">x =</span> m_age, <span class="at">y =</span> m_happiness, <span class="at">shape =</span> idname),</span>
<span id="cb71-1180"><a href="#cb71-1180" aria-hidden="true" tabindex="-1"></a>             <span class="at">colour =</span> <span class="fu">gg_color_hue</span>(<span class="dv">6</span>), <span class="at">alpha =</span> <span class="fl">0.5</span>,</span>
<span id="cb71-1181"><a href="#cb71-1181" aria-hidden="true" tabindex="-1"></a>              <span class="at">size =</span> <span class="dv">3</span>, <span class="at">stroke =</span> <span class="dv">2</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb71-1182"><a href="#cb71-1182" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> cbp2[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>)]) <span class="sc">+</span></span>
<span id="cb71-1183"><a href="#cb71-1183" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_manual</span>(<span class="at">values =</span> cbp2[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>)]) <span class="sc">+</span> </span>
<span id="cb71-1184"><a href="#cb71-1184" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_shape_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="dv">15</span><span class="sc">:</span><span class="dv">18</span>, <span class="dv">25</span>, <span class="dv">20</span>)) <span class="sc">+</span></span>
<span id="cb71-1185"><a href="#cb71-1185" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">data =</span> estimates, <span class="at">lwd =</span> <span class="fl">1.2</span>,</span>
<span id="cb71-1186"><a href="#cb71-1186" aria-hidden="true" tabindex="-1"></a>              <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">intercept =</span> Intercept, <span class="at">slope =</span> slope, </span>
<span id="cb71-1187"><a href="#cb71-1187" aria-hidden="true" tabindex="-1"></a>                            <span class="at">colour =</span> Model, <span class="at">linetype =</span> Model)) <span class="sc">+</span></span>
<span id="cb71-1188"><a href="#cb71-1188" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_linetype_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"solid"</span>, <span class="st">"twodash"</span>, <span class="st">"longdash"</span>, <span class="st">"dotdash"</span>)) <span class="sc">+</span></span>
<span id="cb71-1189"><a href="#cb71-1189" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis</span>(<span class="at">discrete =</span> <span class="cn">TRUE</span>, <span class="at">option =</span> <span class="st">"D"</span>)<span class="sc">+</span></span>
<span id="cb71-1190"><a href="#cb71-1190" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="fl">3.3</span>, <span class="fl">9.2</span>) <span class="sc">+</span> <span class="fu">expand_limits</span>(<span class="at">y =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span> </span>
<span id="cb71-1191"><a href="#cb71-1191" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb71-1192"><a href="#cb71-1192" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.key =</span> <span class="fu">element_blank</span>(), <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb71-1193"><a href="#cb71-1193" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.95</span>,<span class="fl">0.05</span>), <span class="at">legend.justification =</span> <span class="fu">c</span>(<span class="st">"right"</span>, <span class="st">"bottom"</span>),</span>
<span id="cb71-1194"><a href="#cb71-1194" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb71-1195"><a href="#cb71-1195" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.box.background =</span> <span class="fu">element_rect</span>(<span class="at">colour =</span> <span class="st">"black"</span>),</span>
<span id="cb71-1196"><a href="#cb71-1196" aria-hidden="true" tabindex="-1"></a>        <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>))</span>
<span id="cb71-1197"><a href="#cb71-1197" aria-hidden="true" tabindex="-1"></a>zp6</span>
<span id="cb71-1198"><a href="#cb71-1198" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb71-1199"><a href="#cb71-1199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1200"><a href="#cb71-1200" aria-hidden="true" tabindex="-1"></a>Both - within and between estimator - get a similar weight for the RE estimator in our example. The reason is that we have nearly identical errors / noise in the in the between model and the within model.</span>
<span id="cb71-1201"><a href="#cb71-1201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1202"><a href="#cb71-1202" aria-hidden="true" tabindex="-1"></a>However, this obviously can vary strongly across empirical settings. Lets see what happens when we increase T in our example:</span>
<span id="cb71-1203"><a href="#cb71-1203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1204"><a href="#cb71-1204" aria-hidden="true" tabindex="-1"></a><span class="in">```{r class.source = 'fold-hide', message = FALSE, warning = FALSE}</span></span>
<span id="cb71-1205"><a href="#cb71-1205" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">6</span></span>
<span id="cb71-1206"><a href="#cb71-1206" aria-hidden="true" tabindex="-1"></a>T <span class="ot">&lt;-</span> <span class="dv">8</span></span>
<span id="cb71-1207"><a href="#cb71-1207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1208"><a href="#cb71-1208" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb71-1209"><a href="#cb71-1209" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">simdata</span>(<span class="at">N =</span> N, <span class="at">T =</span> T, <span class="at">uw_sd =</span> <span class="dv">0</span>, <span class="at">age_range =</span> <span class="fu">c</span>(<span class="dv">20</span><span class="sc">:</span><span class="dv">60</span>))</span>
<span id="cb71-1210"><a href="#cb71-1210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1211"><a href="#cb71-1211" aria-hidden="true" tabindex="-1"></a><span class="do">### Models</span></span>
<span id="cb71-1212"><a href="#cb71-1212" aria-hidden="true" tabindex="-1"></a><span class="co"># Total line for plot</span></span>
<span id="cb71-1213"><a href="#cb71-1213" aria-hidden="true" tabindex="-1"></a>lm1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(happiness <span class="sc">~</span> age, <span class="at">data =</span> df)</span>
<span id="cb71-1214"><a href="#cb71-1214" aria-hidden="true" tabindex="-1"></a>lm2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(happiness <span class="sc">~</span> age <span class="sc">+</span> cohort, <span class="at">data =</span> df)</span>
<span id="cb71-1215"><a href="#cb71-1215" aria-hidden="true" tabindex="-1"></a>lm3 <span class="ot">&lt;-</span> <span class="fu">lm</span>(happiness <span class="sc">~</span> age <span class="sc">+</span> idname, <span class="at">data =</span> df)</span>
<span id="cb71-1216"><a href="#cb71-1216" aria-hidden="true" tabindex="-1"></a>lm4 <span class="ot">&lt;-</span> <span class="fu">lm</span>(m_happiness <span class="sc">~</span> m_age, <span class="at">data =</span> df)</span>
<span id="cb71-1217"><a href="#cb71-1217" aria-hidden="true" tabindex="-1"></a>re <span class="ot">&lt;-</span> <span class="fu">plm</span>(happiness <span class="sc">~</span> age, df, <span class="at">model =</span> <span class="st">"random"</span>, <span class="at">effect =</span> <span class="st">"individual"</span>)</span>
<span id="cb71-1218"><a href="#cb71-1218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1219"><a href="#cb71-1219" aria-hidden="true" tabindex="-1"></a><span class="do">### Compare POLS, BE, FE, and RE</span></span>
<span id="cb71-1220"><a href="#cb71-1220" aria-hidden="true" tabindex="-1"></a>estimates <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">ncol =</span> <span class="dv">3</span>, <span class="at">nrow =</span> <span class="dv">4</span>))</span>
<span id="cb71-1221"><a href="#cb71-1221" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(estimates) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Model"</span>, <span class="st">"Intercept"</span>, <span class="st">"slope"</span>)</span>
<span id="cb71-1222"><a href="#cb71-1222" aria-hidden="true" tabindex="-1"></a>estimates[<span class="dv">1</span>,] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"POLS"</span>,</span>
<span id="cb71-1223"><a href="#cb71-1223" aria-hidden="true" tabindex="-1"></a>                   lm1<span class="sc">$</span>coefficients[<span class="dv">1</span>],</span>
<span id="cb71-1224"><a href="#cb71-1224" aria-hidden="true" tabindex="-1"></a>                   lm1<span class="sc">$</span>coefficients[<span class="dv">2</span>])</span>
<span id="cb71-1225"><a href="#cb71-1225" aria-hidden="true" tabindex="-1"></a>estimates[<span class="dv">2</span>,] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"BE"</span>,</span>
<span id="cb71-1226"><a href="#cb71-1226" aria-hidden="true" tabindex="-1"></a>                   lm4<span class="sc">$</span>coefficients[<span class="dv">1</span>], </span>
<span id="cb71-1227"><a href="#cb71-1227" aria-hidden="true" tabindex="-1"></a>                   lm4<span class="sc">$</span>coefficients[<span class="dv">2</span>])</span>
<span id="cb71-1228"><a href="#cb71-1228" aria-hidden="true" tabindex="-1"></a>estimates[<span class="dv">3</span>,] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"FE"</span>,</span>
<span id="cb71-1229"><a href="#cb71-1229" aria-hidden="true" tabindex="-1"></a>                   lm3<span class="sc">$</span>coefficients[<span class="dv">1</span>] <span class="sc">+</span> <span class="dv">1</span><span class="sc">/</span>N <span class="sc">*</span> lm3<span class="sc">$</span>coefficients[<span class="dv">3</span>]  <span class="sc">+</span> <span class="dv">1</span><span class="sc">/</span>N <span class="sc">*</span> lm3<span class="sc">$</span>coefficients[<span class="dv">4</span>] </span>
<span id="cb71-1230"><a href="#cb71-1230" aria-hidden="true" tabindex="-1"></a>                   <span class="sc">+</span> <span class="dv">1</span><span class="sc">/</span>N <span class="sc">*</span> lm3<span class="sc">$</span>coefficients[<span class="dv">5</span>]  <span class="sc">+</span> <span class="dv">1</span><span class="sc">/</span>N <span class="sc">*</span> lm3<span class="sc">$</span>coefficients[<span class="dv">6</span>]  <span class="sc">+</span> <span class="dv">1</span><span class="sc">/</span>N <span class="sc">*</span> lm3<span class="sc">$</span>coefficients[<span class="dv">7</span>], </span>
<span id="cb71-1231"><a href="#cb71-1231" aria-hidden="true" tabindex="-1"></a>                   lm3<span class="sc">$</span>coefficients[<span class="dv">2</span>])</span>
<span id="cb71-1232"><a href="#cb71-1232" aria-hidden="true" tabindex="-1"></a>estimates[<span class="dv">4</span>,] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"RE"</span>,</span>
<span id="cb71-1233"><a href="#cb71-1233" aria-hidden="true" tabindex="-1"></a>                   re<span class="sc">$</span>coefficients[<span class="dv">1</span>], </span>
<span id="cb71-1234"><a href="#cb71-1234" aria-hidden="true" tabindex="-1"></a>                   re<span class="sc">$</span>coefficients[<span class="dv">2</span>])</span>
<span id="cb71-1235"><a href="#cb71-1235" aria-hidden="true" tabindex="-1"></a>estimates[, <span class="sc">-</span><span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">apply</span>(estimates[, <span class="sc">-</span><span class="dv">1</span>], <span class="dv">2</span>, <span class="at">FUN =</span> <span class="cf">function</span>(x) <span class="fu">as.numeric</span>(x))</span>
<span id="cb71-1236"><a href="#cb71-1236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1237"><a href="#cb71-1237" aria-hidden="true" tabindex="-1"></a>newdf <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">nrow =</span> <span class="dv">2</span>))</span>
<span id="cb71-1238"><a href="#cb71-1238" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(newdf) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>)</span>
<span id="cb71-1239"><a href="#cb71-1239" aria-hidden="true" tabindex="-1"></a>newdf<span class="sc">$</span>x <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">min</span>(df<span class="sc">$</span>age), <span class="fu">max</span>(df<span class="sc">$</span>age))</span>
<span id="cb71-1240"><a href="#cb71-1240" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(estimates)){</span>
<span id="cb71-1241"><a href="#cb71-1241" aria-hidden="true" tabindex="-1"></a>  newdf<span class="sc">$</span>y <span class="ot">&lt;-</span> estimates[i, <span class="st">"Intercept"</span>] <span class="sc">+</span> estimates[i, <span class="st">"slope"</span>]<span class="sc">*</span>newdf<span class="sc">$</span>x</span>
<span id="cb71-1242"><a href="#cb71-1242" aria-hidden="true" tabindex="-1"></a>  newdf<span class="sc">$</span>Model <span class="ot">&lt;-</span> estimates[i, <span class="st">"Model"</span>]</span>
<span id="cb71-1243"><a href="#cb71-1243" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(i <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb71-1244"><a href="#cb71-1244" aria-hidden="true" tabindex="-1"></a>    pred <span class="ot">&lt;-</span> newdf</span>
<span id="cb71-1245"><a href="#cb71-1245" aria-hidden="true" tabindex="-1"></a>  }<span class="cf">else</span>{pred <span class="ot">&lt;-</span> <span class="fu">rbind</span>(pred, newdf)}</span>
<span id="cb71-1246"><a href="#cb71-1246" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb71-1247"><a href="#cb71-1247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1248"><a href="#cb71-1248" aria-hidden="true" tabindex="-1"></a>estimates<span class="sc">$</span>Model <span class="ot">&lt;-</span> <span class="fu">factor</span>(estimates<span class="sc">$</span>Model, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"POLS"</span>, <span class="st">"BE"</span>, <span class="st">"FE"</span>, <span class="st">"RE"</span>))</span>
<span id="cb71-1249"><a href="#cb71-1249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1250"><a href="#cb71-1250" aria-hidden="true" tabindex="-1"></a>gg_color_hue <span class="ot">&lt;-</span> <span class="cf">function</span>(n) {</span>
<span id="cb71-1251"><a href="#cb71-1251" aria-hidden="true" tabindex="-1"></a>  hues <span class="ot">=</span> <span class="fu">seq</span>(<span class="dv">15</span>, <span class="dv">375</span>, <span class="at">length =</span> n <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb71-1252"><a href="#cb71-1252" aria-hidden="true" tabindex="-1"></a>  <span class="fu">hcl</span>(<span class="at">h =</span> hues, <span class="at">l =</span> <span class="dv">65</span>, <span class="at">c =</span> <span class="dv">100</span>)[<span class="dv">1</span><span class="sc">:</span>n]</span>
<span id="cb71-1253"><a href="#cb71-1253" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb71-1254"><a href="#cb71-1254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1255"><a href="#cb71-1255" aria-hidden="true" tabindex="-1"></a>zp7 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df, <span class="fu">aes</span>(age, happiness)) <span class="sc">+</span></span>
<span id="cb71-1256"><a href="#cb71-1256" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> age, <span class="at">y =</span> happiness, <span class="at">shape =</span> idname),</span>
<span id="cb71-1257"><a href="#cb71-1257" aria-hidden="true" tabindex="-1"></a>             <span class="at">colour =</span> <span class="fu">rep</span>(<span class="fu">gg_color_hue</span>(<span class="dv">6</span>), <span class="at">each =</span> T),</span>
<span id="cb71-1258"><a href="#cb71-1258" aria-hidden="true" tabindex="-1"></a>              <span class="at">size =</span> <span class="dv">2</span>, <span class="at">stroke =</span> <span class="dv">1</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb71-1259"><a href="#cb71-1259" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">'lm'</span>, <span class="at">formula =</span> y <span class="sc">~</span> x, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>,</span>
<span id="cb71-1260"><a href="#cb71-1260" aria-hidden="true" tabindex="-1"></a>              <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="fu">aes</span>(<span class="at">group =</span> idname), <span class="at">colour =</span> <span class="fu">alpha</span>(<span class="st">"gray"</span>, <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb71-1261"><a href="#cb71-1261" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> <span class="fu">unique</span>(df[, <span class="fu">c</span>(<span class="st">"m_age"</span>, <span class="st">"m_happiness"</span>, <span class="st">"idname"</span>)]),</span>
<span id="cb71-1262"><a href="#cb71-1262" aria-hidden="true" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">x =</span> m_age, <span class="at">y =</span> m_happiness, <span class="at">shape =</span> idname),</span>
<span id="cb71-1263"><a href="#cb71-1263" aria-hidden="true" tabindex="-1"></a>             <span class="at">colour =</span> <span class="fu">gg_color_hue</span>(<span class="dv">6</span>), <span class="at">alpha =</span> <span class="fl">0.5</span>,</span>
<span id="cb71-1264"><a href="#cb71-1264" aria-hidden="true" tabindex="-1"></a>              <span class="at">size =</span> <span class="dv">3</span>, <span class="at">stroke =</span> <span class="dv">2</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb71-1265"><a href="#cb71-1265" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> cbp2[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>)]) <span class="sc">+</span></span>
<span id="cb71-1266"><a href="#cb71-1266" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_manual</span>(<span class="at">values =</span> cbp2[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>)]) <span class="sc">+</span> </span>
<span id="cb71-1267"><a href="#cb71-1267" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_shape_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="dv">15</span><span class="sc">:</span><span class="dv">18</span>, <span class="dv">25</span>, <span class="dv">20</span>)) <span class="sc">+</span></span>
<span id="cb71-1268"><a href="#cb71-1268" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">data =</span> estimates, <span class="at">lwd =</span> <span class="fl">1.2</span>,</span>
<span id="cb71-1269"><a href="#cb71-1269" aria-hidden="true" tabindex="-1"></a>              <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">intercept =</span> Intercept, <span class="at">slope =</span> slope, </span>
<span id="cb71-1270"><a href="#cb71-1270" aria-hidden="true" tabindex="-1"></a>                            <span class="at">colour =</span> Model, <span class="at">linetype =</span> Model)) <span class="sc">+</span></span>
<span id="cb71-1271"><a href="#cb71-1271" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_linetype_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"solid"</span>, <span class="st">"twodash"</span>, <span class="st">"longdash"</span>, <span class="st">"dotdash"</span>)) <span class="sc">+</span></span>
<span id="cb71-1272"><a href="#cb71-1272" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis</span>(<span class="at">discrete =</span> <span class="cn">TRUE</span>, <span class="at">option =</span> <span class="st">"D"</span>)<span class="sc">+</span></span>
<span id="cb71-1273"><a href="#cb71-1273" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_linetype_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"solid"</span>, <span class="st">"twodash"</span>, <span class="st">"longdash"</span>, <span class="st">"dotdash"</span>)) <span class="sc">+</span></span>
<span id="cb71-1274"><a href="#cb71-1274" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="fl">3.3</span>, <span class="fl">9.2</span>) <span class="sc">+</span> <span class="fu">expand_limits</span>(<span class="at">y =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span> </span>
<span id="cb71-1275"><a href="#cb71-1275" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb71-1276"><a href="#cb71-1276" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.key =</span> <span class="fu">element_blank</span>(), <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb71-1277"><a href="#cb71-1277" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.95</span>,<span class="fl">0.05</span>), <span class="at">legend.justification =</span> <span class="fu">c</span>(<span class="st">"right"</span>, <span class="st">"bottom"</span>),</span>
<span id="cb71-1278"><a href="#cb71-1278" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb71-1279"><a href="#cb71-1279" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.box.background =</span> <span class="fu">element_rect</span>(<span class="at">colour =</span> <span class="st">"black"</span>),</span>
<span id="cb71-1280"><a href="#cb71-1280" aria-hidden="true" tabindex="-1"></a>        <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>))</span>
<span id="cb71-1281"><a href="#cb71-1281" aria-hidden="true" tabindex="-1"></a>zp7</span>
<span id="cb71-1282"><a href="#cb71-1282" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb71-1283"><a href="#cb71-1283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1284"><a href="#cb71-1284" aria-hidden="true" tabindex="-1"></a>The POLS goes very slightly towards the within estimator. This is because we have increased the within variance in age, but there is still much more variance in age between individuals.</span>
<span id="cb71-1285"><a href="#cb71-1285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1286"><a href="#cb71-1286" aria-hidden="true" tabindex="-1"></a>The RE goes strongly towards FE. This is because - by increasing T - the between model now makes a larger error: there are more data points far away from the green BE line. The error or the within model, in contrast, remain unchanged. So RE gives more weight to the within estimator.</span>
<span id="cb71-1287"><a href="#cb71-1287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1288"><a href="#cb71-1288" aria-hidden="true" tabindex="-1"></a>However, if we increase the noise in the within estimator (bringing the data points further away from each id-specific regression line), RE would move back towards the between estimator:</span>
<span id="cb71-1289"><a href="#cb71-1289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1290"><a href="#cb71-1290" aria-hidden="true" tabindex="-1"></a><span class="in">```{r class.source = 'fold-hide', message = FALSE, warning = FALSE}</span></span>
<span id="cb71-1291"><a href="#cb71-1291" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">6</span></span>
<span id="cb71-1292"><a href="#cb71-1292" aria-hidden="true" tabindex="-1"></a>T <span class="ot">&lt;-</span> <span class="dv">8</span></span>
<span id="cb71-1293"><a href="#cb71-1293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1294"><a href="#cb71-1294" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb71-1295"><a href="#cb71-1295" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">simdata</span>(<span class="at">N =</span> N, <span class="at">T =</span> T, <span class="at">uw_sd =</span> <span class="fl">0.5</span>, <span class="at">age_range =</span> <span class="fu">c</span>(<span class="dv">20</span><span class="sc">:</span><span class="dv">60</span>))</span>
<span id="cb71-1296"><a href="#cb71-1296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1297"><a href="#cb71-1297" aria-hidden="true" tabindex="-1"></a><span class="do">### Models</span></span>
<span id="cb71-1298"><a href="#cb71-1298" aria-hidden="true" tabindex="-1"></a><span class="co"># Total line for plot</span></span>
<span id="cb71-1299"><a href="#cb71-1299" aria-hidden="true" tabindex="-1"></a>lm1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(happiness <span class="sc">~</span> age, <span class="at">data =</span> df)</span>
<span id="cb71-1300"><a href="#cb71-1300" aria-hidden="true" tabindex="-1"></a>lm2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(happiness <span class="sc">~</span> age <span class="sc">+</span> cohort, <span class="at">data =</span> df)</span>
<span id="cb71-1301"><a href="#cb71-1301" aria-hidden="true" tabindex="-1"></a>lm3 <span class="ot">&lt;-</span> <span class="fu">lm</span>(happiness <span class="sc">~</span> age <span class="sc">+</span> idname, <span class="at">data =</span> df)</span>
<span id="cb71-1302"><a href="#cb71-1302" aria-hidden="true" tabindex="-1"></a>lm4 <span class="ot">&lt;-</span> <span class="fu">lm</span>(m_happiness <span class="sc">~</span> m_age, <span class="at">data =</span> df)</span>
<span id="cb71-1303"><a href="#cb71-1303" aria-hidden="true" tabindex="-1"></a>re <span class="ot">&lt;-</span> <span class="fu">plm</span>(happiness <span class="sc">~</span> age, df, <span class="at">model =</span> <span class="st">"random"</span>, <span class="at">effect =</span> <span class="st">"individual"</span>)</span>
<span id="cb71-1304"><a href="#cb71-1304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1305"><a href="#cb71-1305" aria-hidden="true" tabindex="-1"></a><span class="do">### Compare POLS, BE, FE, and RE</span></span>
<span id="cb71-1306"><a href="#cb71-1306" aria-hidden="true" tabindex="-1"></a>estimates <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">ncol =</span> <span class="dv">3</span>, <span class="at">nrow =</span> <span class="dv">4</span>))</span>
<span id="cb71-1307"><a href="#cb71-1307" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(estimates) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Model"</span>, <span class="st">"Intercept"</span>, <span class="st">"slope"</span>)</span>
<span id="cb71-1308"><a href="#cb71-1308" aria-hidden="true" tabindex="-1"></a>estimates[<span class="dv">1</span>,] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"POLS"</span>,</span>
<span id="cb71-1309"><a href="#cb71-1309" aria-hidden="true" tabindex="-1"></a>                   lm1<span class="sc">$</span>coefficients[<span class="dv">1</span>],</span>
<span id="cb71-1310"><a href="#cb71-1310" aria-hidden="true" tabindex="-1"></a>                   lm1<span class="sc">$</span>coefficients[<span class="dv">2</span>])</span>
<span id="cb71-1311"><a href="#cb71-1311" aria-hidden="true" tabindex="-1"></a>estimates[<span class="dv">2</span>,] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"BE"</span>,</span>
<span id="cb71-1312"><a href="#cb71-1312" aria-hidden="true" tabindex="-1"></a>                   lm4<span class="sc">$</span>coefficients[<span class="dv">1</span>], </span>
<span id="cb71-1313"><a href="#cb71-1313" aria-hidden="true" tabindex="-1"></a>                   lm4<span class="sc">$</span>coefficients[<span class="dv">2</span>])</span>
<span id="cb71-1314"><a href="#cb71-1314" aria-hidden="true" tabindex="-1"></a>estimates[<span class="dv">3</span>,] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"FE"</span>,</span>
<span id="cb71-1315"><a href="#cb71-1315" aria-hidden="true" tabindex="-1"></a>                   lm3<span class="sc">$</span>coefficients[<span class="dv">1</span>] <span class="sc">+</span> <span class="dv">1</span><span class="sc">/</span>N <span class="sc">*</span> lm3<span class="sc">$</span>coefficients[<span class="dv">3</span>]  <span class="sc">+</span> <span class="dv">1</span><span class="sc">/</span>N <span class="sc">*</span> lm3<span class="sc">$</span>coefficients[<span class="dv">4</span>] </span>
<span id="cb71-1316"><a href="#cb71-1316" aria-hidden="true" tabindex="-1"></a>                   <span class="sc">+</span> <span class="dv">1</span><span class="sc">/</span>N <span class="sc">*</span> lm3<span class="sc">$</span>coefficients[<span class="dv">5</span>]  <span class="sc">+</span> <span class="dv">1</span><span class="sc">/</span>N <span class="sc">*</span> lm3<span class="sc">$</span>coefficients[<span class="dv">6</span>]  <span class="sc">+</span> <span class="dv">1</span><span class="sc">/</span>N <span class="sc">*</span> lm3<span class="sc">$</span>coefficients[<span class="dv">7</span>], </span>
<span id="cb71-1317"><a href="#cb71-1317" aria-hidden="true" tabindex="-1"></a>                   lm3<span class="sc">$</span>coefficients[<span class="dv">2</span>])</span>
<span id="cb71-1318"><a href="#cb71-1318" aria-hidden="true" tabindex="-1"></a>estimates[<span class="dv">4</span>,] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"RE"</span>,</span>
<span id="cb71-1319"><a href="#cb71-1319" aria-hidden="true" tabindex="-1"></a>                   re<span class="sc">$</span>coefficients[<span class="dv">1</span>], </span>
<span id="cb71-1320"><a href="#cb71-1320" aria-hidden="true" tabindex="-1"></a>                   re<span class="sc">$</span>coefficients[<span class="dv">2</span>])</span>
<span id="cb71-1321"><a href="#cb71-1321" aria-hidden="true" tabindex="-1"></a>estimates[, <span class="sc">-</span><span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">apply</span>(estimates[, <span class="sc">-</span><span class="dv">1</span>], <span class="dv">2</span>, <span class="at">FUN =</span> <span class="cf">function</span>(x) <span class="fu">as.numeric</span>(x))</span>
<span id="cb71-1322"><a href="#cb71-1322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1323"><a href="#cb71-1323" aria-hidden="true" tabindex="-1"></a>newdf <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">nrow =</span> <span class="dv">2</span>))</span>
<span id="cb71-1324"><a href="#cb71-1324" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(newdf) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>)</span>
<span id="cb71-1325"><a href="#cb71-1325" aria-hidden="true" tabindex="-1"></a>newdf<span class="sc">$</span>x <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">min</span>(df<span class="sc">$</span>age), <span class="fu">max</span>(df<span class="sc">$</span>age))</span>
<span id="cb71-1326"><a href="#cb71-1326" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(estimates)){</span>
<span id="cb71-1327"><a href="#cb71-1327" aria-hidden="true" tabindex="-1"></a>  newdf<span class="sc">$</span>y <span class="ot">&lt;-</span> estimates[i, <span class="st">"Intercept"</span>] <span class="sc">+</span> estimates[i, <span class="st">"slope"</span>]<span class="sc">*</span>newdf<span class="sc">$</span>x</span>
<span id="cb71-1328"><a href="#cb71-1328" aria-hidden="true" tabindex="-1"></a>  newdf<span class="sc">$</span>Model <span class="ot">&lt;-</span> estimates[i, <span class="st">"Model"</span>]</span>
<span id="cb71-1329"><a href="#cb71-1329" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(i <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb71-1330"><a href="#cb71-1330" aria-hidden="true" tabindex="-1"></a>    pred <span class="ot">&lt;-</span> newdf</span>
<span id="cb71-1331"><a href="#cb71-1331" aria-hidden="true" tabindex="-1"></a>  }<span class="cf">else</span>{pred <span class="ot">&lt;-</span> <span class="fu">rbind</span>(pred, newdf)}</span>
<span id="cb71-1332"><a href="#cb71-1332" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb71-1333"><a href="#cb71-1333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1334"><a href="#cb71-1334" aria-hidden="true" tabindex="-1"></a>estimates<span class="sc">$</span>Model <span class="ot">&lt;-</span> <span class="fu">factor</span>(estimates<span class="sc">$</span>Model, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"POLS"</span>, <span class="st">"BE"</span>, <span class="st">"FE"</span>, <span class="st">"RE"</span>))</span>
<span id="cb71-1335"><a href="#cb71-1335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1336"><a href="#cb71-1336" aria-hidden="true" tabindex="-1"></a>gg_color_hue <span class="ot">&lt;-</span> <span class="cf">function</span>(n) {</span>
<span id="cb71-1337"><a href="#cb71-1337" aria-hidden="true" tabindex="-1"></a>  hues <span class="ot">=</span> <span class="fu">seq</span>(<span class="dv">15</span>, <span class="dv">375</span>, <span class="at">length =</span> n <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb71-1338"><a href="#cb71-1338" aria-hidden="true" tabindex="-1"></a>  <span class="fu">hcl</span>(<span class="at">h =</span> hues, <span class="at">l =</span> <span class="dv">65</span>, <span class="at">c =</span> <span class="dv">100</span>)[<span class="dv">1</span><span class="sc">:</span>n]</span>
<span id="cb71-1339"><a href="#cb71-1339" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb71-1340"><a href="#cb71-1340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1341"><a href="#cb71-1341" aria-hidden="true" tabindex="-1"></a>zp7 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df, <span class="fu">aes</span>(age, happiness)) <span class="sc">+</span></span>
<span id="cb71-1342"><a href="#cb71-1342" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> age, <span class="at">y =</span> happiness, <span class="at">shape =</span> idname),</span>
<span id="cb71-1343"><a href="#cb71-1343" aria-hidden="true" tabindex="-1"></a>             <span class="at">colour =</span> <span class="fu">rep</span>(<span class="fu">gg_color_hue</span>(<span class="dv">6</span>), <span class="at">each =</span> T),</span>
<span id="cb71-1344"><a href="#cb71-1344" aria-hidden="true" tabindex="-1"></a>              <span class="at">size =</span> <span class="dv">2</span>, <span class="at">stroke =</span> <span class="dv">1</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb71-1345"><a href="#cb71-1345" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">'lm'</span>, <span class="at">formula =</span> y <span class="sc">~</span> x, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>,</span>
<span id="cb71-1346"><a href="#cb71-1346" aria-hidden="true" tabindex="-1"></a>              <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="fu">aes</span>(<span class="at">group =</span> idname), <span class="at">colour =</span> <span class="fu">alpha</span>(<span class="st">"gray"</span>, <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb71-1347"><a href="#cb71-1347" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> <span class="fu">unique</span>(df[, <span class="fu">c</span>(<span class="st">"m_age"</span>, <span class="st">"m_happiness"</span>, <span class="st">"idname"</span>)]),</span>
<span id="cb71-1348"><a href="#cb71-1348" aria-hidden="true" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">x =</span> m_age, <span class="at">y =</span> m_happiness, <span class="at">shape =</span> idname),</span>
<span id="cb71-1349"><a href="#cb71-1349" aria-hidden="true" tabindex="-1"></a>             <span class="at">colour =</span> <span class="fu">gg_color_hue</span>(<span class="dv">6</span>), <span class="at">alpha =</span> <span class="fl">0.5</span>,</span>
<span id="cb71-1350"><a href="#cb71-1350" aria-hidden="true" tabindex="-1"></a>              <span class="at">size =</span> <span class="dv">3</span>, <span class="at">stroke =</span> <span class="dv">2</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb71-1351"><a href="#cb71-1351" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> cbp2[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>)]) <span class="sc">+</span></span>
<span id="cb71-1352"><a href="#cb71-1352" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_manual</span>(<span class="at">values =</span> cbp2[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>)]) <span class="sc">+</span> </span>
<span id="cb71-1353"><a href="#cb71-1353" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_shape_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="dv">15</span><span class="sc">:</span><span class="dv">18</span>, <span class="dv">25</span>, <span class="dv">20</span>)) <span class="sc">+</span></span>
<span id="cb71-1354"><a href="#cb71-1354" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">data =</span> estimates, <span class="at">lwd =</span> <span class="fl">1.2</span>,</span>
<span id="cb71-1355"><a href="#cb71-1355" aria-hidden="true" tabindex="-1"></a>              <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">intercept =</span> Intercept, <span class="at">slope =</span> slope, </span>
<span id="cb71-1356"><a href="#cb71-1356" aria-hidden="true" tabindex="-1"></a>                            <span class="at">colour =</span> Model, <span class="at">linetype =</span> Model)) <span class="sc">+</span></span>
<span id="cb71-1357"><a href="#cb71-1357" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_linetype_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"solid"</span>, <span class="st">"twodash"</span>, <span class="st">"longdash"</span>, <span class="st">"dotdash"</span>)) <span class="sc">+</span></span>
<span id="cb71-1358"><a href="#cb71-1358" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis</span>(<span class="at">discrete =</span> <span class="cn">TRUE</span>, <span class="at">option =</span> <span class="st">"D"</span>)<span class="sc">+</span></span>
<span id="cb71-1359"><a href="#cb71-1359" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="fl">3.3</span>, <span class="fl">9.2</span>) <span class="sc">+</span> <span class="fu">expand_limits</span>(<span class="at">y =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span> </span>
<span id="cb71-1360"><a href="#cb71-1360" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb71-1361"><a href="#cb71-1361" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.key =</span> <span class="fu">element_blank</span>(), <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb71-1362"><a href="#cb71-1362" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.95</span>,<span class="fl">0.05</span>), <span class="at">legend.justification =</span> <span class="fu">c</span>(<span class="st">"right"</span>, <span class="st">"bottom"</span>),</span>
<span id="cb71-1363"><a href="#cb71-1363" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb71-1364"><a href="#cb71-1364" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.box.background =</span> <span class="fu">element_rect</span>(<span class="at">colour =</span> <span class="st">"black"</span>),</span>
<span id="cb71-1365"><a href="#cb71-1365" aria-hidden="true" tabindex="-1"></a>        <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>))</span>
<span id="cb71-1366"><a href="#cb71-1366" aria-hidden="true" tabindex="-1"></a>zp7</span>
<span id="cb71-1367"><a href="#cb71-1367" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb71-1368"><a href="#cb71-1368" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1369"><a href="#cb71-1369" aria-hidden="true" tabindex="-1"></a>Do you have an idea what happens if we reduce the range of the starting age of the individuals (bringing them closer together)? </span>
<span id="cb71-1370"><a href="#cb71-1370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1371"><a href="#cb71-1371" aria-hidden="true" tabindex="-1"></a><span class="fu">### There are two main problems with the RE estimator:</span></span>
<span id="cb71-1372"><a href="#cb71-1372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1373"><a href="#cb71-1373" aria-hidden="true" tabindex="-1"></a>1) Interpretation: how to interpret an estimator based on a mix of __within__ and __between__ variance?</span>
<span id="cb71-1374"><a href="#cb71-1374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1375"><a href="#cb71-1375" aria-hidden="true" tabindex="-1"></a>2) Strong assumptions for consistency of no time-constant unobserved heterogeneity: very likely to be biased in practice</span>
<span id="cb71-1376"><a href="#cb71-1376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1377"><a href="#cb71-1377" aria-hidden="true" tabindex="-1"></a>I personally would generally suggest against the use of RE. Rather, ask yourself whether you are interested in a between or a within question and use the theoretically relevant method.</span>
<span id="cb71-1378"><a href="#cb71-1378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1379"><a href="#cb71-1379" aria-hidden="true" tabindex="-1"></a><span class="fu">### Hausman test</span></span>
<span id="cb71-1380"><a href="#cb71-1380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1381"><a href="#cb71-1381" aria-hidden="true" tabindex="-1"></a>If one has a strong reason to use the RE, it is at least advisable to perform a specification test. The Hausman test <span class="co">[</span><span class="ot">@Hausman.1978</span><span class="co">]</span> is the most common specification test to test the consistency of the RE estimator.</span>
<span id="cb71-1382"><a href="#cb71-1382" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1383"><a href="#cb71-1383" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb71-1384"><a href="#cb71-1384" aria-hidden="true" tabindex="-1"></a>H = (\hat{\bm \beta}_1 - \hat{\bm \beta}_0)^\intercal (N^{-1} {\bm V}_{\hat{\bm \beta}_1 - \hat{\bm \beta}_0})^{-1} (\hat{\bm \beta}_1 - \hat{\bm \beta}_0),</span>
<span id="cb71-1385"><a href="#cb71-1385" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb71-1386"><a href="#cb71-1386" aria-hidden="true" tabindex="-1"></a>where $\hat{\bm \beta}_1$ is consistent, and $\hat{\bm \beta}_0$ is efficient, $N^{-1} {\bm V}_{\hat{\bm \beta}_1 - \hat{\bm \beta}_0} = \Var(\hat{\bm \beta}_1 - \hat{\bm \beta}_0)$, and with RE being fully efficient: $\Var(\hat{\bm \beta}_1 - \hat{\bm \beta}_0) = \Var(\hat{\bm \beta}_1) - \Var(\hat{\bm \beta}_0)$.</span>
<span id="cb71-1387"><a href="#cb71-1387" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1388"><a href="#cb71-1388" aria-hidden="true" tabindex="-1"></a>This basically perform a test of the Null H$_0$: $\hat{\beta}_{FE} = \hat{\beta}_{RE}$, and shows us if the two estimates differ significantly.</span>
<span id="cb71-1389"><a href="#cb71-1389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1390"><a href="#cb71-1390" aria-hidden="true" tabindex="-1"></a>__Use FE if Hausman test significant, and H$_0$ rejected.__</span>
<span id="cb71-1391"><a href="#cb71-1391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1392"><a href="#cb71-1392" aria-hidden="true" tabindex="-1"></a>Let's check in our example:</span>
<span id="cb71-1393"><a href="#cb71-1393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1396"><a href="#cb71-1396" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb71-1397"><a href="#cb71-1397" aria-hidden="true" tabindex="-1"></a><span class="fu">phtest</span>(fe1, re1)</span>
<span id="cb71-1398"><a href="#cb71-1398" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb71-1399"><a href="#cb71-1399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1400"><a href="#cb71-1400" aria-hidden="true" tabindex="-1"></a>The test is highly significant and thus suggest that we should use the FE rather than the RE.</span>
<span id="cb71-1401"><a href="#cb71-1401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1402"><a href="#cb71-1402" aria-hidden="true" tabindex="-1"></a>Obviously, this test is not helpful if both estimates are biased.</span>
<span id="cb71-1403"><a href="#cb71-1403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1404"><a href="#cb71-1404" aria-hidden="true" tabindex="-1"></a><span class="fu"># Hybrid models</span></span>
<span id="cb71-1405"><a href="#cb71-1405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1406"><a href="#cb71-1406" aria-hidden="true" tabindex="-1"></a>One of the stated advantages of the RE is that we can also estimate the effect for time-constant variables. However, there is an easy way of combining the benefits of both worlds: we can just estimate the within effects of time-varying variables in a RE model. </span>
<span id="cb71-1407"><a href="#cb71-1407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1408"><a href="#cb71-1408" aria-hidden="true" tabindex="-1"></a>This is often called the correlated random effects (CRE) model <span class="co">[</span><span class="ot">@Chamberlain.1982; @Mundlak.1978</span><span class="co">]</span>. In sociology, the very similar hybrid model <span class="co">[</span><span class="ot">@Allison.2009.</span><span class="co">]</span> is more common.</span>
<span id="cb71-1409"><a href="#cb71-1409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1410"><a href="#cb71-1410" aria-hidden="true" tabindex="-1"></a>In general, we just add the person specific means as additional covariates, and estimate a random effects model:</span>
<span id="cb71-1411"><a href="#cb71-1411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1412"><a href="#cb71-1412" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb71-1413"><a href="#cb71-1413" aria-hidden="true" tabindex="-1"></a>y_{it} = \alpha + \beta x_{it} + \gamma \bar{x}_{i} + \xi_{it}  </span>
<span id="cb71-1414"><a href="#cb71-1414" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb71-1415"><a href="#cb71-1415" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1416"><a href="#cb71-1416" aria-hidden="true" tabindex="-1"></a>We split up the individual effect $\alpha_i = \gamma \bar{x}_{i} + \eta_i$, and thus only control partially for time-constant heterogeneity by adding the person-specific means $\bar{x}_{i}$.</span>
<span id="cb71-1417"><a href="#cb71-1417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1418"><a href="#cb71-1418" aria-hidden="true" tabindex="-1"></a>__$\hat{\beta}$ gives us the within estimate for $x$__</span>
<span id="cb71-1419"><a href="#cb71-1419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1420"><a href="#cb71-1420" aria-hidden="true" tabindex="-1"></a>See our happiness example</span>
<span id="cb71-1421"><a href="#cb71-1421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1424"><a href="#cb71-1424" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb71-1425"><a href="#cb71-1425" aria-hidden="true" tabindex="-1"></a><span class="co"># Person specific means</span></span>
<span id="cb71-1426"><a href="#cb71-1426" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>m_age <span class="ot">&lt;-</span> <span class="fu">ave</span>(df<span class="sc">$</span>age,</span>
<span id="cb71-1427"><a href="#cb71-1427" aria-hidden="true" tabindex="-1"></a>                df<span class="sc">$</span>id,</span>
<span id="cb71-1428"><a href="#cb71-1428" aria-hidden="true" tabindex="-1"></a>                <span class="at">FUN =</span> mean)</span>
<span id="cb71-1429"><a href="#cb71-1429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1430"><a href="#cb71-1430" aria-hidden="true" tabindex="-1"></a>cre <span class="ot">&lt;-</span> <span class="fu">plm</span>(happiness <span class="sc">~</span> age <span class="sc">+</span> m_age, <span class="at">data =</span> df_orig,</span>
<span id="cb71-1431"><a href="#cb71-1431" aria-hidden="true" tabindex="-1"></a>           <span class="at">index =</span> <span class="fu">c</span>(<span class="st">"id"</span>, <span class="st">"time"</span>),</span>
<span id="cb71-1432"><a href="#cb71-1432" aria-hidden="true" tabindex="-1"></a>           <span class="at">effect =</span> <span class="st">"individual"</span>, <span class="at">model =</span> <span class="st">"random"</span>)</span>
<span id="cb71-1433"><a href="#cb71-1433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1434"><a href="#cb71-1434" aria-hidden="true" tabindex="-1"></a><span class="fu">screenreg</span>(<span class="fu">list</span>(fe1, btw2, re1, cre), <span class="at">digits =</span> <span class="dv">3</span>,</span>
<span id="cb71-1435"><a href="#cb71-1435" aria-hidden="true" tabindex="-1"></a>          <span class="at">custom.model.names =</span> <span class="fu">c</span>(<span class="st">"FE"</span>, <span class="st">"BTW"</span>, <span class="st">"RE"</span>, <span class="st">"CRE"</span>))</span>
<span id="cb71-1436"><a href="#cb71-1436" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb71-1437"><a href="#cb71-1437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1438"><a href="#cb71-1438" aria-hidden="true" tabindex="-1"></a>The estimate for $\beta_{CRE}$ equals the within effect. Note that the coefficient for the mean does not equal the between effect. It equals $\hat{\beta}_{BTW} -  \hat{\beta}_{FE}$. This differs from @Allison.2009. hybrid model.</span>
<span id="cb71-1439"><a href="#cb71-1439" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1440"><a href="#cb71-1440" aria-hidden="true" tabindex="-1"></a>For consistency of $\hat{\beta}_x$ we only need $\E(\epsilon_{it} | x_{i}, \bar{x}_{i}) = 0$: equals the FE assumption for variables additionally included as person-specific means. Usually, one would include person-specific means for all time-varying $\bm x$ (except $\mu_t$ in case of a twoways specification). </span>
<span id="cb71-1441"><a href="#cb71-1441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1442"><a href="#cb71-1442" aria-hidden="true" tabindex="-1"></a>::: {.callout-note}</span>
<span id="cb71-1443"><a href="#cb71-1443" aria-hidden="true" tabindex="-1"></a>The CRE can also be quite helpful in the case of non-linear models. We cannot just include person-dummies in non-linear models such as logit! @Wooldridge.2010 describes the best way of estimating FE non-linear models: a) Estimate a CRE specification within a Random Effects Probit, b) obtain the marginal effects of the time-varying coefficients. See @Ruttenauer.2022b for an applied example on the likelihood of relocation.</span>
<span id="cb71-1444"><a href="#cb71-1444" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb71-1445"><a href="#cb71-1445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1446"><a href="#cb71-1446" aria-hidden="true" tabindex="-1"></a><span class="fu"># Statistical inference</span></span>
<span id="cb71-1447"><a href="#cb71-1447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1448"><a href="#cb71-1448" aria-hidden="true" tabindex="-1"></a>The standard errors we have seen so far, were conventional standard error, not taking into account the panel structure.</span>
<span id="cb71-1449"><a href="#cb71-1449" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1450"><a href="#cb71-1450" aria-hidden="true" tabindex="-1"></a>In the case of a simple linear regression of the form $\bm y = \bm X \bm \beta + \bm \upsilon$ with the coefficients calculated by OLS $\hat{\bm \beta} = (\bm X^\intercal\bm X)^{-1}\bm X^\intercal \bm y$, the covariance matrix is usually calculated as:</span>
<span id="cb71-1451"><a href="#cb71-1451" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1452"><a href="#cb71-1452" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb71-1453"><a href="#cb71-1453" aria-hidden="true" tabindex="-1"></a>\Var(\hat{\bm \beta}) = \hat{\sigma}^2(\bm X^\intercal \bm X)^{-1},</span>
<span id="cb71-1454"><a href="#cb71-1454" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb71-1455"><a href="#cb71-1455" aria-hidden="true" tabindex="-1"></a>where $\hat{\sigma}^2$ is the estimated error variance:</span>
<span id="cb71-1456"><a href="#cb71-1456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1457"><a href="#cb71-1457" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb71-1458"><a href="#cb71-1458" aria-hidden="true" tabindex="-1"></a>\hat{\sigma}^2 = \frac{1}{N-K}\sum^N_{i=1}(\hat\upsilon_i)^2</span>
<span id="cb71-1459"><a href="#cb71-1459" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb71-1460"><a href="#cb71-1460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1461"><a href="#cb71-1461" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1462"><a href="#cb71-1462" aria-hidden="true" tabindex="-1"></a>However, with panel data, the idiosyncratic errors are probably:</span>
<span id="cb71-1463"><a href="#cb71-1463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1464"><a href="#cb71-1464" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>heteroskedastic: have a non-constant variance</span>
<span id="cb71-1465"><a href="#cb71-1465" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1466"><a href="#cb71-1466" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>autocorrelated: error in one period correlate with errors in other periods</span>
<span id="cb71-1467"><a href="#cb71-1467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1468"><a href="#cb71-1468" aria-hidden="true" tabindex="-1"></a>__The conventional errors (as reported in `lm()` and `plm()`) are thus likely to be underestimated.__</span>
<span id="cb71-1469"><a href="#cb71-1469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1470"><a href="#cb71-1470" aria-hidden="true" tabindex="-1"></a>The easiest solution is to estimate panel-robust standard errors <span class="co">[</span><span class="ot">@Millo.2017; @Wooldridge.2010</span><span class="co">]</span>.</span>
<span id="cb71-1471"><a href="#cb71-1471" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1472"><a href="#cb71-1472" aria-hidden="true" tabindex="-1"></a>There are various ways for correcting heteroskedastic and autocorrelated standard errors. The most common version is based on work by Arellano and White and takes the form:</span>
<span id="cb71-1473"><a href="#cb71-1473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1474"><a href="#cb71-1474" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb71-1475"><a href="#cb71-1475" aria-hidden="true" tabindex="-1"></a>\Var(\hat{\bm \beta}_{FE}) = (\tilde{\bm X}^\intercal \tilde{\bm X})^{-1} </span>
<span id="cb71-1476"><a href="#cb71-1476" aria-hidden="true" tabindex="-1"></a>(\sum_{i=1}^N \tilde{\bm X}^\intercal_i \hat{\tilde{\bm\epsilon}}_i \hat{\tilde{\bm\epsilon}}_i^\intercal \tilde{\bm X}_i) </span>
<span id="cb71-1477"><a href="#cb71-1477" aria-hidden="true" tabindex="-1"></a>(\tilde{\bm X}^\intercal \tilde{\bm X})^{-1},</span>
<span id="cb71-1478"><a href="#cb71-1478" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb71-1479"><a href="#cb71-1479" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1480"><a href="#cb71-1480" aria-hidden="true" tabindex="-1"></a>where $\hat{\tilde{\boldsymbol{\mathbf{\varepsilon}}}}_i$ is the vector of FE residuals for each person $i$, and $\tilde{\boldsymbol{\mathbf{X}}}$ are the transformed data <span class="co">[</span><span class="ot">@Millo.2017</span><span class="co">]</span>. This basically clusters the standard within each cross-sectional unit. Obviously, one could cluster by other grouping variables such as time (e.g. with large $T$ and small $N$) or perform double clustering <span class="co">[</span><span class="ot">@Millo.2017</span><span class="co">]</span>.</span>
<span id="cb71-1481"><a href="#cb71-1481" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1482"><a href="#cb71-1482" aria-hidden="true" tabindex="-1"></a>to calculate those standard errors, we can use the <span class="in">`sandwich`</span> and <span class="in">`coeftest`</span> packages. For more information on the various types and options in the command see @Millo.2017.</span>
<span id="cb71-1483"><a href="#cb71-1483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1486"><a href="#cb71-1486" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb71-1487"><a href="#cb71-1487" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fe1)</span>
<span id="cb71-1488"><a href="#cb71-1488" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb71-1489"><a href="#cb71-1489" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1492"><a href="#cb71-1492" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb71-1493"><a href="#cb71-1493" aria-hidden="true" tabindex="-1"></a><span class="co"># Get variance covariance matrix directly</span></span>
<span id="cb71-1494"><a href="#cb71-1494" aria-hidden="true" tabindex="-1"></a>vcovx <span class="ot">&lt;-</span> <span class="fu">vcovHC</span>(fe1, <span class="at">cluster =</span> <span class="st">"group"</span>, <span class="at">method =</span> <span class="st">"arellano"</span>, <span class="at">type =</span> <span class="st">"HC3"</span>)</span>
<span id="cb71-1495"><a href="#cb71-1495" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1496"><a href="#cb71-1496" aria-hidden="true" tabindex="-1"></a><span class="co"># Get model output with the robust SEs</span></span>
<span id="cb71-1497"><a href="#cb71-1497" aria-hidden="true" tabindex="-1"></a><span class="fu">coeftest</span>(fe1, <span class="at">vcov =</span> <span class="cf">function</span>(x) <span class="fu">vcovHC</span>(x, <span class="at">method =</span> <span class="st">"arellano"</span>, <span class="at">type =</span> <span class="st">"HC3"</span>))</span>
<span id="cb71-1498"><a href="#cb71-1498" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb71-1499"><a href="#cb71-1499" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1500"><a href="#cb71-1500" aria-hidden="true" tabindex="-1"></a>In this case the robust SEs are actually smaller!! This is because this stylized example does not include heteroskedasticity or autocorrelation. However, we will see the difference with some real data.</span>
<span id="cb71-1501"><a href="#cb71-1501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1502"><a href="#cb71-1502" aria-hidden="true" tabindex="-1"></a>For a timely discussion on clustering standard error, when to cluster, and which variables to cluster on see @Abadie.2022.</span>
<span id="cb71-1503"><a href="#cb71-1503" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1504"><a href="#cb71-1504" aria-hidden="true" tabindex="-1"></a>__One hint for large data__: <span class="in">`coeftest`</span> and <span class="in">`sandwich`</span> can be slow on large data. It might be more efficient to use the package <span class="in">`lfe`</span> right away. The <span class="in">`felm()`</span> function (to estimate FE models) requires a four part formula of the form <span class="in">`y ~ x1 + x2 | f1 + f2 | (Q|W ~ x3+x4) | clu1 + clu2`</span>, where "x" are ordinary covariates, "f" are the fixed effects, the third part allows to instrument covariates, and "clu" are clusters for robust standard errors:</span>
<span id="cb71-1505"><a href="#cb71-1505" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1508"><a href="#cb71-1508" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb71-1509"><a href="#cb71-1509" aria-hidden="true" tabindex="-1"></a>fe1_2 <span class="ot">&lt;-</span> <span class="fu">felm</span>(happiness <span class="sc">~</span> age <span class="sc">|</span> id <span class="sc">|</span> <span class="dv">0</span> <span class="sc">|</span> id,</span>
<span id="cb71-1510"><a href="#cb71-1510" aria-hidden="true" tabindex="-1"></a>               <span class="at">data =</span> df, <span class="at">cmethod =</span> <span class="st">'cgm2'</span>)</span>
<span id="cb71-1511"><a href="#cb71-1511" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fe1_2)</span>
<span id="cb71-1512"><a href="#cb71-1512" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb71-1513"><a href="#cb71-1513" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1514"><a href="#cb71-1514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-1515"><a href="#cb71-1515" aria-hidden="true" tabindex="-1"></a><span class="fu"># References</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



</body></html>