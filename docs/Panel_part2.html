<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Tobias Rüttenauer">

<title>Panel Data Analysis - 2) Advanced methods</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Panel Data Analysis</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html" rel="" target="">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./Panel_part1.html" rel="" target="">
 <span class="menu-text">1) Panel data methods</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="./Panel_part2.html" rel="" target="" aria-current="page">
 <span class="menu-text">2) Advanced Methods</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./Panel_part3.html" rel="" target="">
 <span class="menu-text">3) Exercises</span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools ms-auto">
    <div class="dropdown">
      <a href="" title="" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" aria-label=""><i class="bi bi-github"></i></a>
      <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="quarto-navigation-tool-dropdown-0">
          <li>
            <a class="dropdown-item quarto-navbar-tools ms-auto-item" href="https://ruettenauer.github.io/Panel-Data-Analysis/">
            Source Code
            </a>
          </li>
      </ul>
    </div>
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#required-packages" id="toc-required-packages" class="nav-link active" data-scroll-target="#required-packages">Required packages</a></li>
  <li><a href="#session-info" id="toc-session-info" class="nav-link" data-scroll-target="#session-info">Session info</a></li>
  <li><a href="#outline" id="toc-outline" class="nav-link" data-scroll-target="#outline">Outline</a></li>
  <li><a href="#fixed-effects-individual-slopes" id="toc-fixed-effects-individual-slopes" class="nav-link" data-scroll-target="#fixed-effects-individual-slopes">Fixed Effects Individual Slopes</a>
  <ul class="collapse">
  <li><a href="#example" id="toc-example" class="nav-link" data-scroll-target="#example">Example</a></li>
  </ul></li>
  <li><a href="#dynamic-treatment-effects" id="toc-dynamic-treatment-effects" class="nav-link" data-scroll-target="#dynamic-treatment-effects">Dynamic treatment effects</a>
  <ul class="collapse">
  <li><a href="#example-1" id="toc-example-1" class="nav-link" data-scroll-target="#example-1">Example</a></li>
  </ul></li>
  <li><a href="#dynamic-diff-in-diff" id="toc-dynamic-diff-in-diff" class="nav-link" data-scroll-target="#dynamic-diff-in-diff">Dynamic Diff-in-Diff</a>
  <ul class="collapse">
  <li><a href="#biased-estimates" id="toc-biased-estimates" class="nav-link" data-scroll-target="#biased-estimates">Biased Estimates</a></li>
  <li><a href="#callaway-santanna-dynamic-diff-in-diff" id="toc-callaway-santanna-dynamic-diff-in-diff" class="nav-link" data-scroll-target="#callaway-santanna-dynamic-diff-in-diff">Callaway &amp; Sant’Anna dynamic Diff-in-Diff</a></li>
  <li><a href="#example-2" id="toc-example-2" class="nav-link" data-scroll-target="#example-2">Example</a></li>
  </ul></li>
  <li><a href="#synthetic-control" id="toc-synthetic-control" class="nav-link" data-scroll-target="#synthetic-control">Synthetic Control</a>
  <ul class="collapse">
  <li><a href="#statistical-inference-with-synthetic-control" id="toc-statistical-inference-with-synthetic-control" class="nav-link" data-scroll-target="#statistical-inference-with-synthetic-control">Statistical inference with synthetic control</a></li>
  <li><a href="#example-3" id="toc-example-3" class="nav-link" data-scroll-target="#example-3">Example</a></li>
  </ul></li>
  <li><a href="#generalized-synthetic-control" id="toc-generalized-synthetic-control" class="nav-link" data-scroll-target="#generalized-synthetic-control">Generalized Synthetic Control</a></li>
  <li><a href="#matrix-completion" id="toc-matrix-completion" class="nav-link" data-scroll-target="#matrix-completion">Matrix Completion</a>
  <ul class="collapse">
  <li><a href="#the-algorithm" id="toc-the-algorithm" class="nav-link" data-scroll-target="#the-algorithm">The algorithm</a></li>
  </ul></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">2) Advanced methods</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>


<div class="quarto-title-meta-author">
  <div class="quarto-title-meta-heading">Author</div>
  <div class="quarto-title-meta-heading">Affiliation</div>
  
    <div class="quarto-title-meta-contents">
    <p class="author"><a href="https://ruettenauer.github.io/">Tobias Rüttenauer</a> <a href="https://orcid.org/0000-0001-5747-9735" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
  </div>
    <div class="quarto-title-meta-contents">
        <p class="affiliation">
            UCL Social Research Institute
          </p>
      </div>
    </div>

<div class="quarto-title-meta">

      
  
    
  </div>
  

</header>

<section id="required-packages" class="level3">
<h3 class="anchored" data-anchor-id="required-packages">Required packages</h3>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>pkgs <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"plm"</span>, <span class="st">"feisr"</span>, <span class="st">"did"</span>, <span class="st">"Synth"</span>, <span class="st">"SCtools"</span>, </span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>          <span class="st">"panelView"</span>, <span class="st">"texreg"</span>, <span class="st">"tidyr"</span>, <span class="st">"dplyr"</span>, <span class="st">"ggplot2"</span>, <span class="st">"ggforce"</span>) </span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">lapply</span>(pkgs, require, <span class="at">character.only =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="session-info" class="level3">
<h3 class="anchored" data-anchor-id="session-info">Session info</h3>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.3.1 (2023-06-16 ucrt)
Platform: x86_64-w64-mingw32/x64 (64-bit)
Running under: Windows 10 x64 (build 19044)

Matrix products: default


locale:
[1] LC_COLLATE=English_United Kingdom.utf8 
[2] LC_CTYPE=English_United Kingdom.utf8   
[3] LC_MONETARY=English_United Kingdom.utf8
[4] LC_NUMERIC=C                           
[5] LC_TIME=English_United Kingdom.utf8    

time zone: Europe/London
tzcode source: internal

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
 [1] ggforce_0.4.1    ggplot2_3.4.2    dplyr_1.1.2      tidyr_1.3.0     
 [5] texreg_1.38.6    panelView_1.1.17 SCtools_0.3.2.1  future_1.33.0   
 [9] Synth_1.1-8      did_2.1.2        feisr_1.3.0      plm_2.6-3       

loaded via a namespace (and not attached):
 [1] tidyselect_1.2.0    farver_2.1.1        fastmap_1.1.1      
 [4] tweenr_2.0.2        fixest_0.11.1       digest_0.6.32      
 [7] lifecycle_1.0.3     dreamerr_1.2.3      magrittr_2.0.3     
[10] kernlab_0.9-32      compiler_4.3.1      rlang_1.1.1        
[13] tools_4.3.1         utf8_1.2.3          yaml_2.3.7         
[16] data.table_1.14.8   collapse_1.9.6      knitr_1.43         
[19] ggsignif_0.6.4      htmlwidgets_1.6.2   abind_1.4-5        
[22] withr_2.5.0         purrr_1.0.1         numDeriv_2016.8-1.1
[25] polyclip_1.10-4     grid_4.3.1          rgenoud_5.9-0.3    
[28] fansi_1.0.4         ggpubr_0.6.0        xtable_1.8-4       
[31] lfe_2.9-0           colorspace_2.1-0    BMisc_1.4.5        
[34] globals_0.16.2      scales_1.2.1        MASS_7.3-60        
[37] cli_3.6.1           rmarkdown_2.23      miscTools_0.6-28   
[40] generics_0.1.3      rstudioapi_0.14     httr_1.4.6         
[43] bdsmatrix_1.3-6     parallel_4.3.1      vctrs_0.6.3        
[46] Matrix_1.5-4.1      sandwich_3.0-2      jsonlite_1.8.5     
[49] carData_3.0-5       car_3.1-2           rstatix_0.7.2      
[52] Formula_1.2-5       listenv_0.9.0       optimx_2022-4.30   
[55] glue_1.6.2          parallelly_1.36.0   codetools_0.2-19   
[58] gtable_0.3.3        lmtest_0.9-40       munsell_0.5.0      
[61] tibble_3.2.1        pillar_1.9.0        htmltools_0.5.5    
[64] R6_2.5.1            maxLik_1.5-2        Rdpack_2.4         
[67] evaluate_0.21       lattice_0.21-8      rbibutils_2.2.13   
[70] backports_1.4.1     broom_1.0.5         Rcpp_1.0.10        
[73] gridExtra_2.3       nlme_3.1-162        xfun_0.39          
[76] zoo_1.8-12          pkgconfig_2.0.3    </code></pre>
</div>
</div>
</section>
<section id="outline" class="level1">
<h1>Outline</h1>
<ul>
<li><p>Fixed Effects Individual Slopes</p></li>
<li><p>Dynamic treatment effects</p></li>
<li><p>Dynamic Diff-in-Diff</p></li>
<li><p>Synthetic Control</p></li>
<li><p>TBD: Generalized Synthetic Control</p></li>
</ul>
</section>
<section id="fixed-effects-individual-slopes" class="level1">
<h1>Fixed Effects Individual Slopes</h1>
<p>Remeber that we have to make the parallel trends assumption in twoways FE models. A violation of the parallel trends assumption leads to biased estimates. Usually, when controlling for time fixed effects, we make the assumption that every observation experiences the same “effect of time”.</p>
<p>However, we can relax this assumption by giving each individual their own intercept <strong>and</strong> their own slope.</p>
<p>The fixed effects individual slope (FEIS) estimator is a more general version of the well-known fixed effects estimator (FE), which allows to control for heterogeneous slopes in addition to time-constant heterogeneity <span class="citation" data-cites="Bruderl.2015 Polachek.1994 Ruttenauer.2023 Wooldridge.2010">(e.g. <a href="#ref-Bruderl.2015" role="doc-biblioref">Brüderl and Ludwig 2015</a>; <a href="#ref-Polachek.1994" role="doc-biblioref">Polachek and Kim 1994</a>; <a href="#ref-Ruttenauer.2023" role="doc-biblioref">Rüttenauer and Ludwig 2023</a>; <a href="#ref-Wooldridge.2010" role="doc-biblioref">Wooldridge 2010</a>)</span>. Formally, the FEIS estimator can be expressed as</p>
<p><span class="math display">\[
\begin{align}
\boldsymbol{\mathbf{y}}_{i} =&amp; \boldsymbol{\mathbf{X}}_{i}\boldsymbol{\mathbf{\beta }}+ \boldsymbol{\mathbf{W}}_i \boldsymbol{\mathbf{\alpha}}_i + \boldsymbol{\mathbf{\epsilon}}_{i},
\end{align}
\]</span> where <span class="math inline">\(\boldsymbol{\mathbf{y}}_{i}\)</span> is <span class="math inline">\(T \times 1\)</span>, <span class="math inline">\(\boldsymbol{\mathbf{X}}_{i}\)</span> is <span class="math inline">\(T \times K\)</span>, and <span class="math inline">\(\boldsymbol{\mathbf{\epsilon}}_{i}\)</span> is <span class="math inline">\(T \times 1\)</span>. <span class="math inline">\(\boldsymbol{\mathbf{W}}_i\)</span> is a <span class="math inline">\(T \times J\)</span> matrix of slope variables, and <span class="math inline">\(\boldsymbol{\mathbf{\alpha}}_i\)</span> a <span class="math inline">\(J \times 1\)</span> vector of individual-specific slope parameters, for <span class="math inline">\(J\)</span> slope parameters including a constant term. If <span class="math inline">\(\boldsymbol{\mathbf{W}}_i\)</span> consists of a constant term only, <span class="math inline">\(\boldsymbol{\mathbf{W}}_i = \boldsymbol{\mathbf{1}}\)</span>, thus <span class="math inline">\(\boldsymbol{\mathbf{\alpha}}_i\)</span> reduces to <span class="math inline">\(\alpha_{i1}\)</span>, and the above equation represents the well-known formula of a conventional FE model with individual fixed effects.</p>
<p>As with the conventional FE, FEIS can be estimated using <code>lm()</code> by including <span class="math inline">\(N-1\)</span> individual-specific dummies and interaction terms of each slope variable with the <span class="math inline">\(N-1\)</span> individual-specific dummies (<span class="math inline">\((N-1) *J\)</span> controls). This is however highly inefficient. As with the conventional FE estimator, we can achieve the same result by running an <code>lm()</code> on pre-transformed data. Therefore, specify the ‘residual maker’ matrix <span class="math inline">\(\boldsymbol{\mathbf{M}}_i = \boldsymbol{\mathbf{I}}_T - \boldsymbol{\mathbf{W}}_i(\boldsymbol{\mathbf{W}}^\intercal_i \boldsymbol{\mathbf{W}}_i)^{-1}\boldsymbol{\mathbf{W}}^\intercal_i\)</span>, and estimate <span class="math display">\[
\begin{align}
y_{it} - \hat{y}_{it} =&amp; (\boldsymbol{\mathbf{x}}_{it} - \hat{\boldsymbol{\mathbf{x}}}_{it})\boldsymbol{\mathbf{\beta }}+ \epsilon_{it} - \hat{\epsilon}_{it}, \\
\boldsymbol{\mathbf{M}}_i \boldsymbol{\mathbf{y}}_i =&amp; \boldsymbol{\mathbf{M}}_i \boldsymbol{\mathbf{X}}_i\boldsymbol{\mathbf{\beta }}+ \boldsymbol{\mathbf{M}}_i \boldsymbol{\mathbf{\epsilon}}_{i}, \\
\tilde{\boldsymbol{\mathbf{y}}}_{i} =&amp; \tilde{\boldsymbol{\mathbf{X}}}_{i}\boldsymbol{\mathbf{\beta }}+ \tilde{\boldsymbol{\mathbf{\epsilon}}}_{i},
\end{align}
\]</span> where <span class="math inline">\(\tilde{\boldsymbol{\mathbf{y}}}_{i}\)</span>, <span class="math inline">\(\tilde{\boldsymbol{\mathbf{X}}}_{i}\)</span>, and <span class="math inline">\(\tilde{\boldsymbol{\mathbf{\epsilon}}}_{i}\)</span> are the residuals of regressing <span class="math inline">\(\boldsymbol{\mathbf{y}}_{i}\)</span>, each column-vector of <span class="math inline">\(\boldsymbol{\mathbf{X}}_{i}\)</span>, and <span class="math inline">\(\boldsymbol{\mathbf{\epsilon}}_{i}\)</span> on <span class="math inline">\(\boldsymbol{\mathbf{W}}_i\)</span>.</p>
<p><strong>Intuitively</strong>, we</p>
<ol type="1">
<li><p>estimate the individual-specific predicted values for the dependent variable and each covariate based on an individual intercept and the additional slope variables of <span class="math inline">\(\boldsymbol{\mathbf{W}}_i\)</span>,</p></li>
<li><p>‘detrend’ the original data by these individual-specific predicted values, and</p></li>
<li><p>run an OLS model on the residual (‘detrended’) data.</p></li>
</ol>
<p>Similarly, we can estimate a correlated random effects (CRE) model <span class="citation" data-cites="Chamberlain.1982 Mundlak.1978 Wooldridge.2010">(<a href="#ref-Chamberlain.1982" role="doc-biblioref">Chamberlain 1982</a>; <a href="#ref-Mundlak.1978" role="doc-biblioref">Mundlak 1978</a>; <a href="#ref-Wooldridge.2010" role="doc-biblioref">Wooldridge 2010</a>)</span> including the individual specific predictions <span class="math inline">\(\hat{\boldsymbol{\mathbf{X}}}_{i}\)</span> to obtain the FEIS estimator: <span class="math display">\[
\begin{align}
\boldsymbol{\mathbf{y}}_{i} =&amp; \boldsymbol{\mathbf{X}}_{i}\boldsymbol{\mathbf{\beta }}+ \hat{\boldsymbol{\mathbf{X}}}_{i}\boldsymbol{\mathbf{\rho }}+ \boldsymbol{\mathbf{\epsilon}}_{i}.
\end{align}
\]</span></p>
<p>Although we are here mainly interested in controlling for individual time, FEIS can be used to control for individual specific effects of any covariate. For instance, <span class="citation" data-cites="Ruttenauer.2023">Rüttenauer and Ludwig (<a href="#ref-Ruttenauer.2023" role="doc-biblioref">2023</a>)</span> discuss an example of controlling for family-specific pre-treatment conditions in a sibling study on the effect of participating in pre-school programs on later life outcomes.</p>
<section id="example" class="level3">
<h3 class="anchored" data-anchor-id="example">Example</h3>
<p>As an example, we use the <code>mwp</code> panel data, containing information on wages and family status of 268 men. This is a random sample drawn from the National Longitudinal Survey of Youth <span class="citation" data-cites="NLSY79.2001">(<a href="#ref-NLSY79.2001" role="doc-biblioref">NLSY79, n.d.</a>)</span>, and more details on the selection of observations and variable construction can be found in <span class="citation" data-cites="Ludwig.2018">Ludwig and Brüderl (<a href="#ref-Ludwig.2018" role="doc-biblioref">2018</a>)</span>.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">"mwp"</span>, <span class="at">package =</span> <span class="st">"feisr"</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(mwp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  id year      lnw      exp      expq marry evermarry enrol yeduc age cohort
1  1 1981 1.934358 1.076923  1.159763     0         1     1    11  18   1963
2  1 1983 2.468140 3.019231  9.115755     0         1     1    12  20   1963
3  1 1984 2.162480 4.038462 16.309174     0         1     1    12  21   1963
4  1 1985 1.746280 5.076923 25.775146     0         1     0    12  22   1963
5  1 1986 2.527840 6.096154 37.163090     0         1     1    13  23   1963
6  1 1987 2.365361 7.500000 56.250000     0         1     1    13  24   1963
  yeargr yeargr1 yeargr2 yeargr3 yeargr4 yeargr5
1      2       0       1       0       0       0
2      2       0       1       0       0       0
3      2       0       1       0       0       0
4      2       0       1       0       0       0
5      3       0       0       1       0       0
6      3       0       0       1       0       0</code></pre>
</div>
</div>
<p>The data set contains a unique person identifier (<code>id</code>) and survey year indicator (<code>year</code>). Furthermore, we have information about the log hourly wage rate (<code>lnwage</code>), work experience (<code>exp</code>) and its square (<code>expq</code>), family status (<code>marry</code>), enrollment in current education (<code>enrol</code>), years of formal education education (<code>yeduc</code>), age (<code>age</code>), birth cohort (<code>cohort</code>), and a grouped year indicator (<code>yeargr</code>).</p>
<p>we exemplary investigate the ‘marriage wage premium’: we analyze whether marriage leads to an increase in the hourly wage for men. We use the function <code>feis</code> to estimate fixed effects individual slope models to control for the hypothesis that those men who are more likely to marry or marry earlier, also have a steeper wage growth over time.</p>
<p>Let’s start with our most common panel models (FE and RE):</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>wages.fe <span class="ot">&lt;-</span> <span class="fu">plm</span>(lnw <span class="sc">~</span> marry <span class="sc">+</span> enrol <span class="sc">+</span> yeduc <span class="sc">+</span> <span class="fu">as.factor</span>(yeargr)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>                <span class="sc">+</span> exp <span class="sc">+</span> <span class="fu">I</span>(exp<span class="sc">^</span><span class="dv">2</span>), <span class="at">data =</span> mwp, <span class="at">index =</span> <span class="fu">c</span>(<span class="st">"id"</span>, <span class="st">"year"</span>),</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>                <span class="at">model =</span> <span class="st">"within"</span>, <span class="at">effect =</span> <span class="st">"individual"</span>)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>wages.re <span class="ot">&lt;-</span> <span class="fu">plm</span>(lnw <span class="sc">~</span> marry <span class="sc">+</span> enrol <span class="sc">+</span> yeduc <span class="sc">+</span> <span class="fu">as.factor</span>(yeargr)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>                <span class="sc">+</span> exp <span class="sc">+</span> <span class="fu">I</span>(exp<span class="sc">^</span><span class="dv">2</span>), <span class="at">data =</span> mwp, <span class="at">index =</span> <span class="fu">c</span>(<span class="st">"id"</span>, <span class="st">"year"</span>),</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>                <span class="at">model =</span> <span class="st">"random"</span>, <span class="at">effect =</span> <span class="st">"individual"</span>)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(wages.fe)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Oneway (individual) effect Within Model

Call:
plm(formula = lnw ~ marry + enrol + yeduc + as.factor(yeargr) + 
    exp + I(exp^2), data = mwp, effect = "individual", model = "within", 
    index = c("id", "year"))

Unbalanced Panel: n = 268, T = 4-19, N = 3100

Residuals:
      Min.    1st Qu.     Median    3rd Qu.       Max. 
-2.5870006 -0.1580744  0.0081262  0.1701488  1.9958088 

Coefficients:
                      Estimate  Std. Error t-value  Pr(&gt;|t|)    
marry               0.07773216  0.02160148  3.5985 0.0003256 ***
enrol              -0.20810059  0.02282898 -9.1156 &lt; 2.2e-16 ***
yeduc               0.05584485  0.00715655  7.8033 8.424e-15 ***
as.factor(yeargr)2 -0.14080625  0.03036533 -4.6371 3.694e-06 ***
as.factor(yeargr)3 -0.16453499  0.04696595 -3.5033 0.0004667 ***
as.factor(yeargr)4 -0.27553668  0.06196892 -4.4464 9.071e-06 ***
as.factor(yeargr)5 -0.29750723  0.07932341 -3.7506 0.0001800 ***
exp                 0.07299927  0.00867777  8.4122 &lt; 2.2e-16 ***
I(exp^2)           -0.00127502  0.00036103 -3.5317 0.0004196 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Total Sum of Squares:    559.75
Residual Sum of Squares: 327.88
R-Squared:      0.41424
Adj. R-Squared: 0.35697
F-statistic: 221.816 on 9 and 2823 DF, p-value: &lt; 2.22e-16</code></pre>
</div>
</div>
<p>and we calculate panel robust standard errors and attach them back to the model output:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate vcov</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>vcovx_fe <span class="ot">&lt;-</span> <span class="fu">vcovHC</span>(wages.fe, <span class="at">cluster =</span> <span class="st">"group"</span>, <span class="at">method =</span> <span class="st">"arellano"</span>, <span class="at">type =</span> <span class="st">"HC3"</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>vcovx_re <span class="ot">&lt;-</span> <span class="fu">vcovHC</span>(wages.re, <span class="at">cluster =</span> <span class="st">"group"</span>, <span class="at">method =</span> <span class="st">"arellano"</span>, <span class="at">type =</span> <span class="st">"HC3"</span>)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Replace original vcov in output</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>wages.fe<span class="sc">$</span>vcov <span class="ot">&lt;-</span> vcovx_fe</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>wages.re<span class="sc">$</span>vcov <span class="ot">&lt;-</span> vcovx_re</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Replacing the vcov in the model output has the advantage that we now use the cluster robust SEs in all following operations (like <code>summary()</code> or <code>screenreg</code>).</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(wages.fe)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Oneway (individual) effect Within Model

Call:
plm(formula = lnw ~ marry + enrol + yeduc + as.factor(yeargr) + 
    exp + I(exp^2), data = mwp, effect = "individual", model = "within", 
    index = c("id", "year"))

Unbalanced Panel: n = 268, T = 4-19, N = 3100

Residuals:
      Min.    1st Qu.     Median    3rd Qu.       Max. 
-2.5870006 -0.1580744  0.0081262  0.1701488  1.9958088 

Coefficients:
                      Estimate  Std. Error t-value  Pr(&gt;|t|)    
marry               0.07773216  0.03160634  2.4594 0.0139771 *  
enrol              -0.20810059  0.02738300 -7.5996 4.015e-14 ***
yeduc               0.05584485  0.01025801  5.4440 5.656e-08 ***
as.factor(yeargr)2 -0.14080625  0.03554205 -3.9617 7.627e-05 ***
as.factor(yeargr)3 -0.16453499  0.05338645 -3.0820 0.0020763 ** 
as.factor(yeargr)4 -0.27553668  0.06829208 -4.0347 5.613e-05 ***
as.factor(yeargr)5 -0.29750723  0.08916462 -3.3366 0.0008591 ***
exp                 0.07299927  0.01245954  5.8589 5.198e-09 ***
I(exp^2)           -0.00127502  0.00057274 -2.2262 0.0260794 *  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Total Sum of Squares:    559.75
Residual Sum of Squares: 327.88
R-Squared:      0.41424
Adj. R-Squared: 0.35697
F-statistic: 77.9716 on 9 and 2823 DF, p-value: &lt; 2.22e-16</code></pre>
</div>
</div>
<p>And finally, we allow for individual specific trends. To replicate the analysis of <span class="citation" data-cites="Ludwig.2018">Ludwig and Brüderl (<a href="#ref-Ludwig.2018" role="doc-biblioref">2018</a>)</span>, we use work experience (<code>exp</code>) and squared work experience as the slope variables.</p>
<p><strong>One mayor advantage of using work experience as slope is that we can still control for (grouped) time fixed effects</strong></p>
<p><strong>Assuming linear trends (only using exp), is a strong assumption. However, for each additional slope (e.g.&nbsp;polynomial), FEIS becomes more data hungry: each individual needs at least <span class="math inline">\(T \geq K + 1\)</span> observations to contribute to the model. If not, they are dropped!</strong></p>
<p>Here we use <code>feis</code> with panel robust standard errors. The command <code>felm</code> from <code>lfe</code> can be used to calculate individual slopes as well.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>wages.feis <span class="ot">&lt;-</span> <span class="fu">feis</span>(lnw <span class="sc">~</span> marry <span class="sc">+</span> enrol <span class="sc">+</span> yeduc <span class="sc">+</span> <span class="fu">as.factor</span>(yeargr)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>                   <span class="sc">|</span> exp <span class="sc">+</span> <span class="fu">I</span>(exp<span class="sc">^</span><span class="dv">2</span>), <span class="at">data =</span> mwp, <span class="at">id =</span> <span class="st">"id"</span>,</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>                   <span class="at">robust =</span> <span class="cn">TRUE</span>)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(wages.feis)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>

Call:
feis(formula = lnw ~ marry + enrol + yeduc + as.factor(yeargr) | 
    exp + I(exp^2), data = mwp, id = "id", robust = TRUE)


Residuals:
      Min.    1st Qu.     Median    3rd Qu.       Max. 
-2.0790815 -0.1050450  0.0046876  0.1112708  1.9412090 

Coefficients:
                     Estimate Std. Error t-value  Pr(&gt;|t|)    
marry               0.0134582  0.0292771  0.4597   0.64579    
enrol              -0.1181725  0.0235003 -5.0286 5.325e-07 ***
yeduc              -0.0020607  0.0175059 -0.1177   0.90630    
as.factor(yeargr)2 -0.0464504  0.0378675 -1.2267   0.22008    
as.factor(yeargr)3 -0.0189333  0.0524265 -0.3611   0.71803    
as.factor(yeargr)4 -0.1361305  0.0615033 -2.2134   0.02697 *  
as.factor(yeargr)5 -0.1868589  0.0742904 -2.5152   0.01196 *  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Cluster robust standard errors
Slope parameters:  exp, I(exp^2) 
Total Sum of Squares:    190.33
Residual Sum of Squares: 185.64
R-Squared:      0.024626
Adj. R-Squared: 0.022419</code></pre>
</div>
</div>
<p>Let’s compare the results.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">screenreg</span>(<span class="fu">list</span>(wages.re, wages.fe, wages.feis), <span class="at">digits =</span> <span class="dv">3</span>,</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>          <span class="at">custom.model.names =</span> <span class="fu">c</span>(<span class="st">"RE"</span>, <span class="st">"FE"</span>, <span class="st">"FEIS"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
============================================================
                    RE            FE            FEIS        
------------------------------------------------------------
(Intercept)            1.562 ***                            
                      (0.094)                               
marry                  0.091 **      0.078 *       0.013    
                      (0.032)       (0.032)       (0.029)   
enrol                 -0.202 ***    -0.208 ***    -0.118 ***
                      (0.025)       (0.027)       (0.024)   
yeduc                  0.063 ***     0.056 ***    -0.002    
                      (0.008)       (0.010)       (0.018)   
as.factor(yeargr)2    -0.157 ***    -0.141 ***    -0.046    
                      (0.034)       (0.036)       (0.038)   
as.factor(yeargr)3    -0.197 ***    -0.165 **     -0.019    
                      (0.050)       (0.053)       (0.052)   
as.factor(yeargr)4    -0.316 ***    -0.276 ***    -0.136 *  
                      (0.066)       (0.068)       (0.062)   
as.factor(yeargr)5    -0.349 ***    -0.298 ***    -0.187 *  
                      (0.089)       (0.089)       (0.074)   
exp                    0.074 ***     0.073 ***              
                      (0.012)       (0.012)                 
exp^2                 -0.001 *      -0.001 *                
                      (0.001)       (0.001)                 
------------------------------------------------------------
s_idios                0.341                                
s_id                   0.279                                
R^2                    0.440         0.414         0.025    
Adj. R^2               0.439         0.357         0.022    
Num. obs.           3100          3100          3100        
Num. groups: id                                  268        
RMSE                                               0.285    
============================================================
*** p &lt; 0.001; ** p &lt; 0.01; * p &lt; 0.05</code></pre>
</div>
</div>
<p>Interpretation:</p>
<ul>
<li><p>RE: Married observations have a significantly higher wage than unmarried observations.</p></li>
<li><p>FE: If people marry, they experience an increase in wages afterwards. The effect is significant and slightly lower than the RE.</p></li>
<li><p>FEIS: Accounting for the individual wage trend before marriage, we do not observe an increase in wages if people marry. The effect is small and non-significant.</p></li>
</ul>
<p>Overall, this indicates that there is a problem with non-parallel trends: Those with steeper wage trajectories are more likely to marry (or marry earlier).</p>
<p>As mentioned above, we can achieve the same by 1) manually calculating the individual specific trends and 2) including them as additional covariates in the model.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="do">### Individual predicted value of covariates</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>vars <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"marry"</span>, <span class="st">"enrol"</span>, <span class="st">"yeduc"</span>, </span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>          <span class="st">"yeargr2"</span>, <span class="st">"yeargr3"</span>, <span class="st">"yeargr4"</span>, <span class="st">"yeargr5"</span>)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(v <span class="cf">in</span> vars){</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  fm <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="fu">paste</span>(v, <span class="st">"~ exp + expq"</span>))</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>  pred_x <span class="ot">&lt;-</span> <span class="fu">by</span>(mwp[, <span class="fu">c</span>(v, <span class="st">"exp"</span>, <span class="st">"expq"</span>)],</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>                mwp<span class="sc">$</span>id,</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>                <span class="at">FUN =</span> <span class="cf">function</span>(z) <span class="fu">predict</span>(<span class="fu">lm</span>(fm, <span class="at">data =</span> z)))</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>  pred_x <span class="ot">&lt;-</span> <span class="fu">unlist</span>(pred_x)</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>  mwp[, <span class="fu">paste0</span>(<span class="st">"pred_"</span>, v)] <span class="ot">&lt;-</span> pred_x</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(mwp[, <span class="fu">c</span>(<span class="st">"id"</span>, <span class="st">"pred_marry"</span>, <span class="st">"pred_enrol"</span>)], <span class="at">n =</span> <span class="dv">20</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   id  pred_marry   pred_enrol
1   1 -0.12205318  1.206579223
2   1 -0.03068796  0.863033817
3   1  0.03926230  0.716309276
4   1  0.12611077  0.590568171
5   1  0.22664093  0.490467488
6   1  0.38990636  0.390403467
7   1  0.54837205  0.340389443
8   1  0.66317654  0.324200699
9   1  0.87480284  0.326554307
10  1  1.04489924  0.351640932
11  1  1.23957011  0.399853176
12  2  0.00000000  1.103938282
13  2  0.00000000  0.503880518
14  2  0.00000000  0.304456317
15  2  0.00000000  0.176757843
16  2  0.00000000  0.012061441
17  2  0.00000000 -0.105551709
18  2  0.00000000  0.004457309
19  3  0.00000000  0.000000000
20  3  0.00000000  0.000000000</code></pre>
</div>
</div>
<p>This gives us individual-specific predicted values of each covariate based on and intercept, exp and expsq. Note that - in contrast to person-specific means - these predicted values (can) vary within a person.</p>
<p>Do you know why person-id 2 has all zeros on the pre_marry variable?</p>
<p>Using these individual predicted values, we can retreive the FEIS estimates in a Mundlak-style model.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>wages.lmfeis <span class="ot">&lt;-</span> <span class="fu">lm</span>(lnw <span class="sc">~</span> marry <span class="sc">+</span> enrol <span class="sc">+</span> yeduc <span class="sc">+</span> <span class="fu">as.factor</span>(yeargr) <span class="sc">+</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>                     pred_marry <span class="sc">+</span> pred_enrol <span class="sc">+</span> pred_yeduc <span class="sc">+</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>                     pred_yeargr2 <span class="sc">+</span> pred_yeargr3 <span class="sc">+</span> pred_yeargr4 <span class="sc">+</span> pred_yeargr5,</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>                   <span class="at">data =</span> mwp)</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="fu">screenreg</span>(<span class="fu">list</span>(wages.feis, wages.lmfeis), <span class="at">digits =</span> <span class="dv">3</span>,</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>          <span class="at">custom.model.names =</span> <span class="fu">c</span>(<span class="st">"FEIS"</span>, <span class="st">"Manual FEIS"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
==============================================
                    FEIS          Manual FEIS 
----------------------------------------------
marry                  0.013         0.013    
                      (0.029)       (0.043)   
enrol                 -0.118 ***    -0.118 ** 
                      (0.024)       (0.037)   
yeduc                 -0.002        -0.002    
                      (0.018)       (0.022)   
as.factor(yeargr)2    -0.046        -0.046    
                      (0.038)       (0.055)   
as.factor(yeargr)3    -0.019        -0.019    
                      (0.052)       (0.080)   
as.factor(yeargr)4    -0.136 *      -0.136    
                      (0.062)       (0.097)   
as.factor(yeargr)5    -0.187 *      -0.187    
                      (0.074)       (0.121)   
(Intercept)                          1.576 ***
                                    (0.056)   
pred_marry                           0.269 ***
                                    (0.048)   
pred_enrol                          -0.238 ***
                                    (0.048)   
pred_yeduc                           0.079 ***
                                    (0.022)   
pred_yeargr2                        -0.061    
                                    (0.074)   
pred_yeargr3                        -0.012    
                                    (0.092)   
pred_yeargr4                         0.169    
                                    (0.110)   
pred_yeargr5                         0.347 ** 
                                    (0.132)   
----------------------------------------------
R^2                    0.025         0.359    
Adj. R^2               0.022         0.356    
Num. obs.           3100          3100        
Num. groups: id      268                      
RMSE                   0.285                  
==============================================
*** p &lt; 0.001; ** p &lt; 0.01; * p &lt; 0.05</code></pre>
</div>
</div>
<p>Note, however, that this manual approach will lead to incorrect standard errors!</p>
</section>
</section>
<section id="dynamic-treatment-effects" class="level1">
<h1>Dynamic treatment effects</h1>
<p>Often, we are not only interested in the overall treatment effect, but we also want to know how treatment effects unfold after a treatment. For example, how does happiness change around specific life course events <span class="citation" data-cites="Clark.2013">(<a href="#ref-Clark.2013" role="doc-biblioref">Clark and Georgellis 2013</a>)</span>, or how do housing prices develop after the opening of an industrial plant <span class="citation" data-cites="Currie.2015">(<a href="#ref-Currie.2015" role="doc-biblioref">Currie et al. 2015</a>)</span>?</p>
<p>There are various ways of calculating how a treatment effect develops over time:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="fig/Impact-function.PNG" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Various impact functions for event study designs from <a href="https://www.ls3.soziologie.uni-muenchen.de/studium-lehre/archiv/teaching-marterials/panel-analysis_april-2019.pdf">Brüderl/Ludwig 2019 teaching materials</a></figcaption>
</figure>
</div>
<p>Usually, it is best to not impose a structural form, but rather to use dummy impact functions. However, even with this, there is an ongoing debate on what is the best choice of specification <span class="citation" data-cites="Ludwig.2021">(<a href="#ref-Ludwig.2021" role="doc-biblioref">Ludwig and Brüderl 2021</a>)</span>, or see for instance <a href="https://pedrohcgs.github.io/posts/twfe">blog post by Pedro H. C. Sant’Anna and Brantly Callaway</a>.</p>
<p><strong>Note that these settings usually require a staggered treatment adoption: individuals are treated once, and afterwards remain treated</strong></p>
<p>There are many cases where this does not apply. However, one can think about potential ways of artificially creating such designs:</p>
<ul>
<li><p>Dichotomize continuous treatments (if theoretically plausible!)</p></li>
<li><p>Create id-period splits. E.g. if a person gets divorced, either drop from sample, or treat as a “new id” as a person can re-marry (note that this assumes that first and second marriage have equal effects).</p></li>
</ul>
<section id="example-1" class="level3">
<h3 class="anchored" data-anchor-id="example-1">Example</h3>
<p>We stick with our example and try to estimate how the wage changes around the year of marriage.</p>
<p>To do so, we first make sure the data is ordered by id and time</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>mwp <span class="ot">&lt;-</span> mwp[<span class="fu">order</span>(mwp<span class="sc">$</span>id, mwp<span class="sc">$</span>year), ]</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(mwp[, <span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>], <span class="at">n =</span> <span class="dv">20</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   id year      lnw        exp        expq marry
1   1 1981 1.934358  1.0769231   1.1597635     0
2   1 1983 2.468140  3.0192308   9.1157551     0
3   1 1984 2.162480  4.0384617  16.3091736     0
4   1 1985 1.746280  5.0769229  25.7751465     0
5   1 1986 2.527840  6.0961537  37.1630898     0
6   1 1987 2.365361  7.5000000  56.2500000     0
7   1 1988 2.467478  8.6730766  75.2222595     1
8   1 1989 4.398027  9.4423075  89.1571732     1
9   1 1990 2.822144 10.7307692 115.1494064     1
10  1 1991 2.654965 11.6730766 136.2607117     1
11  1 1992 2.665088 12.6730766 160.6068726     1
12  2 1979 2.236233  0.9423077   0.8879438     0
13  2 1981 2.916389  2.9615386   8.7707109     0
14  2 1982 2.751646  3.8269231  14.6453409     0
15  2 1983 2.629372  4.4807692  20.0772915     0
16  2 1984 2.965442  5.5384617  30.6745586     0
17  2 1985 2.890669  6.6538463  44.2736702     0
18  2 1989 2.392579 11.1538458 124.4082794     0
19  3 1979 2.456405  1.1730769   1.3761094     0
20  3 1980 2.661142  2.1153846   4.4748521     0</code></pre>
</div>
</div>
<p>Then, we make sure that our data looks like a staggered treatment design. Are there people who jump from married to not married in the data?</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Change in marriage status within an id</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>mwp<span class="sc">$</span>fd_marry <span class="ot">&lt;-</span> <span class="fu">ave</span>(mwp<span class="sc">$</span>marry,</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>                    mwp<span class="sc">$</span>id,</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>                    <span class="at">FUN =</span> <span class="cf">function</span>(x) x <span class="sc">-</span> dplyr<span class="sc">::</span><span class="fu">lag</span>(x, <span class="dv">1</span>, <span class="at">default =</span> <span class="dv">0</span>)) <span class="co"># 0 insteat of NA for 1st year</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Mark observations starting with a negative fd value (jump from marry=1 to marry =0)</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>mwp<span class="sc">$</span>notstag_marry <span class="ot">&lt;-</span> <span class="fu">ave</span>(<span class="fu">ifelse</span>(mwp<span class="sc">$</span>fd_marry <span class="sc">==</span> <span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>                         mwp<span class="sc">$</span>id,</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>                         <span class="at">FUN =</span> <span class="cf">function</span>(x) <span class="fu">cumsum</span>(x))</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(mwp<span class="sc">$</span>fd_marry)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
   0    1 
2896  204 </code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(mwp<span class="sc">$</span>notstag_marry)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
   0 
3100 </code></pre>
</div>
</div>
<p>Luckily, the dataset is already cleaned: there are only transitions into marriage, not out of marriage.</p>
<p>Next we want to make sure if there are any individuals who already start with the treatment (who are married right from their first wave on).</p>
<p><strong>We only want to have those in our sample who potentially can go from not-treated to treated!</strong></p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>mwp <span class="ot">&lt;-</span> mwp[<span class="fu">order</span>(mwp<span class="sc">$</span>id, mwp<span class="sc">$</span>year), ] <span class="co"># just to be sure</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Person year number</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>mwp<span class="sc">$</span>pynr <span class="ot">&lt;-</span> <span class="fu">ave</span>(mwp<span class="sc">$</span>year,</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>                mwp<span class="sc">$</span>id,</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>                <span class="at">FUN =</span> <span class="cf">function</span>(x) <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(x))</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Marry status at first wave</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>mwp<span class="sc">$</span>f_marry <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(mwp<span class="sc">$</span>pynr <span class="sc">==</span> <span class="dv">1</span>, mwp<span class="sc">$</span>marry, <span class="cn">NA</span>)</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Distribute across individual, using mean and na.rm = TRUE</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>mwp<span class="sc">$</span>f_marry <span class="ot">&lt;-</span> <span class="fu">ave</span>(mwp<span class="sc">$</span>f_marry,</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>                   mwp<span class="sc">$</span>id,</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>                   <span class="at">FUN =</span> <span class="cf">function</span>(x) <span class="fu">mean</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(mwp<span class="sc">$</span>f_marry)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
   0 
3100 </code></pre>
</div>
</div>
<p>Again, someone has already done the job. There are no individuals who start married in the first wave.</p>
<p>We can also look at this graphically with <code>panelView</code> (mainly helpful for small N data):</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">panelview</span>(lnw <span class="sc">~</span> marry, </span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>          <span class="at">data =</span> mwp, <span class="at">index =</span> <span class="fu">c</span>(<span class="st">"id"</span>,<span class="st">"year"</span>),</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>          <span class="at">type =</span> <span class="st">"treat"</span>, <span class="at">theme.bw =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Time is not evenly distributed (possibly due to missing data).</code></pre>
</div>
<div class="cell-output-display">
<p><img src="Panel_part2_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid" width="480"></p>
</div>
</div>
<p>Alright, so lets create a dummy impact function / a count variable around the treatment.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>mwp <span class="ot">&lt;-</span> mwp[<span class="fu">order</span>(mwp<span class="sc">$</span>id, mwp<span class="sc">$</span>year), ] <span class="co"># just to be sure!!</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Function that creates distance to the treatment (assuming 0=control, 1=treated)</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>impfun <span class="ot">&lt;-</span> <span class="cf">function</span>(x, <span class="at">default =</span> <span class="sc">-</span><span class="dv">99</span>){</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>  nas <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">is.na</span>(x))  <span class="co">#save nas</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>  ft <span class="ot">&lt;-</span> <span class="fu">which</span>(x <span class="sc">==</span> <span class="dv">1</span>)[<span class="dv">1</span>]  <span class="co">#first teatment index</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.na</span>(ft)){          <span class="co">#replicate default if never treated</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>    count <span class="ot">&lt;-</span> <span class="fu">rep</span>(default, <span class="fu">length</span>(x))</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>    ri <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(x)       <span class="co">#running index</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>    count <span class="ot">&lt;-</span> ri <span class="sc">-</span> ft        <span class="co">#distance to first treatment</span></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">length</span>(nas) <span class="sc">!=</span> <span class="dv">0</span>){   <span class="co">#replace nas if any</span></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>    count[nas] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(count)           <span class="co">#return counter</span></span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply to each individual</span></span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>mwp<span class="sc">$</span>marry_if <span class="ot">&lt;-</span> <span class="fu">ave</span>(mwp<span class="sc">$</span>marry,</span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>                    mwp<span class="sc">$</span>id,</span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>                    <span class="at">FUN =</span> <span class="cf">function</span>(x) <span class="fu">impfun</span>(x))</span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(mwp[, <span class="fu">c</span>(<span class="st">"id"</span>, <span class="st">"year"</span>, <span class="st">"marry"</span>, <span class="st">"marry_if"</span>)], <span class="at">n =</span> <span class="dv">50</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   id year marry marry_if
1   1 1981     0       -6
2   1 1983     0       -5
3   1 1984     0       -4
4   1 1985     0       -3
5   1 1986     0       -2
6   1 1987     0       -1
7   1 1988     1        0
8   1 1989     1        1
9   1 1990     1        2
10  1 1991     1        3
11  1 1992     1        4
12  2 1979     0      -99
13  2 1981     0      -99
14  2 1982     0      -99
15  2 1983     0      -99
16  2 1984     0      -99
17  2 1985     0      -99
18  2 1989     0      -99
19  3 1979     0      -99
20  3 1980     0      -99
21  3 1981     0      -99
22  3 1982     0      -99
23  3 1983     0      -99
24  3 1984     0      -99
25  3 1985     0      -99
26  3 1986     0      -99
27  3 1987     0      -99
28  3 1988     0      -99
29  3 1989     0      -99
30  3 1993     0      -99
31  3 1994     0      -99
32  3 2000     0      -99
33  4 1979     0       -2
34  4 1981     0       -1
35  4 1982     1        0
36  4 1983     1        1
37  4 1984     1        2
38  4 1985     1        3
39  4 1986     1        4
40  4 1987     1        5
41  4 1988     1        6
42  4 1989     1        7
43  4 1990     1        8
44  4 1991     1        9
45  4 1992     1       10
46  4 1993     1       11
47  5 1979     0       -6
48  5 1980     0       -5
49  5 1981     0       -4
50  5 1982     0       -3</code></pre>
</div>
</div>
<p>We can now use this time count function to estimate dynamic treatment effects.</p>
<p>Note that we need to make to important decisions (<a href="https://pedrohcgs.github.io/posts/twfe">blog post by Pedro H. C. Sant’Anna and Brantly Callaway</a>):</p>
<ul>
<li><p>Which dates to use a reference category</p></li>
<li><p>How many pre-treatment periods to include (to test for anticipation or potential pre-treatment differences)</p></li>
</ul>
<p>Here, re will just include three periods before marriage and use the rest as reference categories</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set all before -3 to -99</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>mwp<span class="sc">$</span>marry_if[mwp<span class="sc">$</span>marry_if <span class="sc">&lt;</span> <span class="sc">-</span><span class="dv">3</span> <span class="sc">&amp;</span> mwp<span class="sc">$</span>marry_if <span class="sc">&gt;</span> <span class="sc">-</span><span class="dv">99</span>] <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">99</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Make factor with -99 as reference category</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>mwp<span class="sc">$</span>marry_if <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(mwp<span class="sc">$</span>marry_if)</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>mwp<span class="sc">$</span>marry_if <span class="ot">&lt;-</span> <span class="fu">relevel</span>(mwp<span class="sc">$</span>marry_if, <span class="st">"-99"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>And we use this as our treatment variable in the FE estimator.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Standard marriage indicator</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>wages.fe <span class="ot">&lt;-</span> <span class="fu">plm</span>(lnw <span class="sc">~</span> marry <span class="sc">+</span> enrol <span class="sc">+</span> yeduc <span class="sc">+</span> <span class="fu">as.factor</span>(yeargr)</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>                <span class="sc">+</span> exp <span class="sc">+</span> <span class="fu">I</span>(exp<span class="sc">^</span><span class="dv">2</span>), <span class="at">data =</span> mwp, <span class="at">index =</span> <span class="fu">c</span>(<span class="st">"id"</span>, <span class="st">"year"</span>),</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>                <span class="at">model =</span> <span class="st">"within"</span>, <span class="at">effect =</span> <span class="st">"individual"</span>)</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="co"># with dummy impact function</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>wages2.fe <span class="ot">&lt;-</span> <span class="fu">plm</span>(lnw <span class="sc">~</span> marry_if <span class="sc">+</span> enrol <span class="sc">+</span> yeduc <span class="sc">+</span> <span class="fu">as.factor</span>(yeargr)</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>                 <span class="sc">+</span> exp <span class="sc">+</span> <span class="fu">I</span>(exp<span class="sc">^</span><span class="dv">2</span>), <span class="at">data =</span> mwp, <span class="at">index =</span> <span class="fu">c</span>(<span class="st">"id"</span>, <span class="st">"year"</span>),</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>                 <span class="at">model =</span> <span class="st">"within"</span>, <span class="at">effect =</span> <span class="st">"individual"</span>)</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a><span class="co"># add cluster robust SEs</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>vcovx_fe2 <span class="ot">&lt;-</span> <span class="fu">vcovHC</span>(wages2.fe, <span class="at">cluster =</span> <span class="st">"group"</span>, <span class="at">method =</span> <span class="st">"arellano"</span>, <span class="at">type =</span> <span class="st">"HC3"</span>)</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>wages2.fe<span class="sc">$</span>vcov <span class="ot">&lt;-</span> vcovx_fe2</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(wages2.fe)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Oneway (individual) effect Within Model

Call:
plm(formula = lnw ~ marry_if + enrol + yeduc + as.factor(yeargr) + 
    exp + I(exp^2), data = mwp, effect = "individual", model = "within", 
    index = c("id", "year"))

Unbalanced Panel: n = 268, T = 4-19, N = 3100

Residuals:
     Min.   1st Qu.    Median   3rd Qu.      Max. 
-2.566752 -0.160001  0.010038  0.175003  2.011790 

Coefficients:
                      Estimate  Std. Error t-value  Pr(&gt;|t|)    
marry_if-3          0.03388225  0.03253942  1.0413 0.2978411    
marry_if-2          0.05166995  0.04238715  1.2190 0.2229466    
marry_if-1          0.09151624  0.04265046  2.1457 0.0319803 *  
marry_if0           0.08816919  0.05121551  1.7215 0.0852644 .  
marry_if1           0.15544954  0.05601346  2.7752 0.0055530 ** 
marry_if2           0.15658061  0.06078860  2.5758 0.0100509 *  
marry_if3           0.16687443  0.06762257  2.4677 0.0136564 *  
marry_if4           0.14591461  0.07412203  1.9686 0.0491005 *  
marry_if5           0.14033773  0.07930392  1.7696 0.0768992 .  
marry_if6           0.15706194  0.08660097  1.8136 0.0698418 .  
marry_if7           0.13008248  0.09727237  1.3373 0.1812327    
marry_if8           0.11979150  0.10451397  1.1462 0.2518197    
marry_if9           0.14007172  0.10390453  1.3481 0.1777412    
marry_if10          0.11550144  0.11151584  1.0357 0.3004126    
marry_if11          0.20483579  0.12281306  1.6679 0.0954538 .  
marry_if12          0.10767466  0.12345702  0.8722 0.3831940    
marry_if13          0.10542488  0.13897395  0.7586 0.4481589    
marry_if14         -0.13934447  0.12815514 -1.0873 0.2769929    
enrol              -0.20477142  0.02737332 -7.4807 9.833e-14 ***
yeduc               0.05500238  0.01059840  5.1897 2.257e-07 ***
as.factor(yeargr)2 -0.13830215  0.03594278 -3.8478 0.0001218 ***
as.factor(yeargr)3 -0.16356110  0.05379641 -3.0404 0.0023847 ** 
as.factor(yeargr)4 -0.27248909  0.06839547 -3.9840 6.948e-05 ***
as.factor(yeargr)5 -0.28895919  0.08907335 -3.2441 0.0011922 ** 
exp                 0.06728858  0.01357307  4.9575 7.565e-07 ***
I(exp^2)           -0.00111675  0.00061151 -1.8262 0.0679250 .  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Total Sum of Squares:    559.75
Residual Sum of Squares: 325.96
R-Squared:      0.41767
Adj. R-Squared: 0.35686
F-statistic: 75.8727 on 26 and 2806 DF, p-value: &lt; 2.22e-16</code></pre>
</div>
</div>
<p>Let’s plot that</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set up results matrix</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>coef.df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">matrix</span>(<span class="cn">NA</span>,</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">nrow =</span> (<span class="fu">length</span>(<span class="fu">levels</span>(mwp<span class="sc">$</span>marry_if)) <span class="sc">-</span> <span class="dv">1</span>),</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">ncol =</span> <span class="dv">3</span>))</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(coef.df) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"time"</span>, <span class="st">"att"</span>, <span class="st">"se"</span>)</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a><span class="co"># paste results</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>coef.df<span class="sc">$</span>time <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">3</span><span class="sc">:</span><span class="dv">14</span>)</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>output <span class="ot">&lt;-</span> <span class="fu">summary</span>(wages2.fe)<span class="sc">$</span>coefficients</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>coef.df[, <span class="fu">c</span>(<span class="st">"att"</span>, <span class="st">"se"</span>)] <span class="ot">&lt;-</span> output[<span class="fu">which</span>(<span class="fu">grepl</span>(<span class="st">"marry_if"</span>, <span class="fu">rownames</span>(output))), <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a><span class="co"># 95% CI</span></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>interval2  <span class="ot">&lt;-</span>  <span class="sc">-</span><span class="fu">qnorm</span>((<span class="dv">1</span><span class="fl">-0.95</span>)<span class="sc">/</span><span class="dv">2</span>)  <span class="co"># 95% multiplier</span></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>coef.df<span class="sc">$</span>ll <span class="ot">&lt;-</span> coef.df<span class="sc">$</span>att <span class="sc">-</span> coef.df<span class="sc">$</span>se<span class="sc">*</span>interval2</span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>coef.df<span class="sc">$</span>ul <span class="ot">&lt;-</span> coef.df<span class="sc">$</span>att <span class="sc">+</span> coef.df<span class="sc">$</span>se<span class="sc">*</span>interval2</span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>zp1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(coef.df[coef.df<span class="sc">$</span>time <span class="sc">&lt;</span> <span class="dv">7</span>, ], </span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>              <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> att)) <span class="sc">+</span>  </span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_pointrange</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> att, <span class="at">ymin =</span> ll, <span class="at">ymax =</span> ul),</span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a>                                <span class="at">lwd =</span> <span class="dv">1</span>, <span class="at">fatten =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> att)) <span class="sc">+</span></span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">colour =</span> <span class="fu">gray</span>(<span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>), <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">lwd =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="sc">-</span><span class="fl">0.5</span>, <span class="at">colour =</span> <span class="st">"black"</span>, <span class="at">lty =</span> <span class="dv">1</span>, <span class="at">lwd =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a>zp1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Panel_part2_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>An interesting finding here. There is a positive anticipation effect: “The anticipation of marriage already increases the husbands wage”.</p>
<p>Is this plausible?</p>
<p><strong>FEIS</strong></p>
<p>Obviously, we can also use these dummy impact function in other estimators.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="do">### FEIS with dummy impact function</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>wages2.feis <span class="ot">&lt;-</span> <span class="fu">feis</span>(lnw <span class="sc">~</span> marry_if <span class="sc">+</span> enrol <span class="sc">+</span> yeduc <span class="sc">+</span> <span class="fu">as.factor</span>(yeargr)</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>                   <span class="sc">|</span> exp <span class="sc">+</span> <span class="fu">I</span>(exp<span class="sc">^</span><span class="dv">2</span>), </span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>                   <span class="at">data =</span> mwp, <span class="at">id =</span> <span class="st">"id"</span>,</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">robust =</span> <span class="cn">TRUE</span>)</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(wages2.feis)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>

Call:
feis(formula = lnw ~ marry_if + enrol + yeduc + as.factor(yeargr) | 
    exp + I(exp^2), data = mwp, id = "id", robust = TRUE)


Residuals:
      Min.    1st Qu.     Median    3rd Qu.       Max. 
-2.0385140 -0.1070148  0.0063363  0.1116305  1.9422823 

Coefficients:
                      Estimate  Std. Error t-value  Pr(&gt;|t|)    
marry_if-3         -0.01009512  0.03282428 -0.3076   0.75845    
marry_if-2         -0.01269923  0.05387564 -0.2357   0.81368    
marry_if-1          0.00945697  0.06556529  0.1442   0.88533    
marry_if0          -0.00934465  0.08669423 -0.1078   0.91417    
marry_if1           0.05239527  0.10439373  0.5019   0.61579    
marry_if2           0.06024667  0.11996538  0.5022   0.61558    
marry_if3           0.05481404  0.14066586  0.3897   0.69681    
marry_if4           0.03469671  0.15894441  0.2183   0.82722    
marry_if5           0.04209049  0.18134196  0.2321   0.81648    
marry_if6           0.07219889  0.20694589  0.3489   0.72721    
marry_if7           0.05371600  0.22543835  0.2383   0.81169    
marry_if8           0.00422209  0.26924683  0.0157   0.98749    
marry_if9           0.05496285  0.29238662  0.1880   0.85091    
marry_if10          0.08980275  0.34176479  0.2628   0.79276    
marry_if11          0.18093806  0.40047134  0.4518   0.65145    
marry_if12          0.11491753  0.44824664  0.2564   0.79769    
marry_if13          0.07479506  0.51906834  0.1441   0.88544    
marry_if14          0.14775390  0.57381382  0.2575   0.79682    
enrol              -0.11902058  0.02363290 -5.0362 5.122e-07 ***
yeduc              -0.00082298  0.01772763 -0.0464   0.96298    
as.factor(yeargr)2 -0.04618140  0.04080643 -1.1317   0.25787    
as.factor(yeargr)3 -0.01934802  0.05387474 -0.3591   0.71953    
as.factor(yeargr)4 -0.13656650  0.06179928 -2.2098   0.02722 *  
as.factor(yeargr)5 -0.18414365  0.07407322 -2.4860   0.01299 *  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Cluster robust standard errors
Slope parameters:  exp, I(exp^2) 
Total Sum of Squares:    190.33
Residual Sum of Squares: 184.71
R-Squared:      0.029511
Adj. R-Squared: 0.021939</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="do">### Plot</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Set up results matrix</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>coef2.df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">matrix</span>(<span class="cn">NA</span>,</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">nrow =</span> (<span class="fu">length</span>(<span class="fu">levels</span>(mwp<span class="sc">$</span>marry_if)) <span class="sc">-</span> <span class="dv">1</span>),</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>                  <span class="at">ncol =</span> <span class="dv">3</span>))</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(coef2.df) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"time"</span>, <span class="st">"att"</span>, <span class="st">"se"</span>)</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a><span class="co"># paste results</span></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>coef2.df<span class="sc">$</span>time <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">3</span><span class="sc">:</span><span class="dv">14</span>)</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>output <span class="ot">&lt;-</span> <span class="fu">summary</span>(wages2.feis)<span class="sc">$</span>coefficients</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>coef2.df[, <span class="fu">c</span>(<span class="st">"att"</span>, <span class="st">"se"</span>)] <span class="ot">&lt;-</span> output[<span class="fu">which</span>(<span class="fu">grepl</span>(<span class="st">"marry_if"</span>, <span class="fu">rownames</span>(output))), <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a><span class="co"># 95% CI</span></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>interval2  <span class="ot">&lt;-</span>  <span class="sc">-</span><span class="fu">qnorm</span>((<span class="dv">1</span><span class="fl">-0.95</span>)<span class="sc">/</span><span class="dv">2</span>)  <span class="co"># 95% multiplier</span></span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>coef2.df<span class="sc">$</span>ll <span class="ot">&lt;-</span> coef2.df<span class="sc">$</span>att <span class="sc">-</span> coef2.df<span class="sc">$</span>se<span class="sc">*</span>interval2</span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>coef2.df<span class="sc">$</span>ul <span class="ot">&lt;-</span> coef2.df<span class="sc">$</span>att <span class="sc">+</span> coef2.df<span class="sc">$</span>se<span class="sc">*</span>interval2</span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a>zp2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(coef2.df[coef2.df<span class="sc">$</span>time <span class="sc">&lt;</span> <span class="dv">7</span>, ], </span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>              <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> att)) <span class="sc">+</span>  </span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_pointrange</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> att, <span class="at">ymin =</span> ll, <span class="at">ymax =</span> ul),</span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a>                                <span class="at">lwd =</span> <span class="dv">1</span>, <span class="at">fatten =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> att)) <span class="sc">+</span></span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">colour =</span> <span class="fu">gray</span>(<span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>), <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">lwd =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="sc">-</span><span class="fl">0.5</span>, <span class="at">colour =</span> <span class="st">"black"</span>, <span class="at">lty =</span> <span class="dv">1</span>, <span class="at">lwd =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb37-28"><a href="#cb37-28" aria-hidden="true" tabindex="-1"></a>zp2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Panel_part2_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>This gives us what we already expected: using FEIS, the marital wage premium disappears.</p>
</section>
</section>
<section id="dynamic-diff-in-diff" class="level1">
<h1>Dynamic Diff-in-Diff</h1>
<p>Remember, we have defined the <strong>2</strong> <span class="math inline">\(\times\)</span> <strong>2 Diff-in-Diff</strong> as:</p>
<p><span class="math display">\[
y_{it} = \alpha + \gamma D_{i} + \lambda Post_{t} + \delta_{DD} (D_{i} \times Post_{t}) + \upsilon_{it},
\]</span></p>
<p>which we can easily estimate as:</p>
<p><span class="math display">\[
\hat{\delta}_{DD} = \mathrm{E}(\Delta y_{T}) - \mathrm{E}(\Delta y_{C}) = (\mathrm{E}(y_{T}^{post}) - \mathrm{E}(y_{T}^{pre})) - (\mathrm{E}(y_{C}^{post}) - \mathrm{E}(y_{C}^{pre})).
\]</span></p>
<p>Moreover, we have written the <strong>twoways FE</strong> estimator as:</p>
<p><span class="math display">\[
y_{it} = \beta_{TWFE} D_{it} + \alpha_i + \zeta_t + \epsilon_{it},
\]</span> In a setting with only two time periods, a binary treatment, and all observations untreated in <span class="math inline">\(t=1\)</span>, the Diff-in-Diff estimator equals the twoways FE estimator <span class="math inline">\(\hat{\delta}_{DD} = \hat{\beta}_{TWFE}\)</span>.</p>
<p>However, it is more complicated when we go beyond the 2 <span class="math inline">\(\times\)</span> 2 setting. There is an ongoing discussion on how the Difference in Differences estimator relates to the two-ways FE estimator when treatment timing varies: different individuals receive the treatment at different periods.</p>
<p>Assume we can divide our setting into treatment groups (treated vs.&nbsp;control) and into timing groups (every observation treated in the same period form a timing group).</p>
<p><span class="citation" data-cites="Goodman-Bacon.2021">Goodman-Bacon (<a href="#ref-Goodman-Bacon.2021" role="doc-biblioref">2021</a>)</span> shows that the two-ways FE is a weighted average of all possible two-group/two-period DD estimators. The weights determine how much each of these single combinations contributes to the two-ways FE are determined by the group size (e.g.&nbsp;how long do we observe each combination before and after treatment) and the variance in the treatment.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="fig/goodman.jpg" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Two-ways FE and DD with varying treatment timing <span class="citation" data-cites="Goodman-Bacon.2021">(<a href="#ref-Goodman-Bacon.2021" role="doc-biblioref">Goodman-Bacon 2021</a>)</span>.</figcaption>
</figure>
</div>
<p>In the example above we have three groups: 1) control / never treated (<span class="math inline">\(C\)</span>), 2) early treated (at period <span class="math inline">\(k\)</span>), and 3) late treated (at period <span class="math inline">\(l\)</span>). Those who are treated in later time periods are not only compared to those who are never treated but also to those who have already been treated in earlier periods.</p>
<p><span class="citation" data-cites="Goodman-Bacon.2021">Goodman-Bacon (<a href="#ref-Goodman-Bacon.2021" role="doc-biblioref">2021</a>)</span> shows that this setting with three treatment groups consists of 4 possible 2 <span class="math inline">\(\times\)</span> 2 Diff-in-Diff settings.</p>
<p>Panels A) and B) compare <span class="math inline">\(j = k,l\)</span> against control group <span class="math inline">\(C\)</span>, and can be written as: <span class="math display">\[
\hat{\delta}_{DD}^{jC} = (\mathrm{E}(y_{j}^{post(j)}) - \mathrm{E}(y_{j}^{pre(j)})) - (\mathrm{E}(y_{C}^{post}) - \mathrm{E}(y_{C}^{pre})), ~\text{with} ~ j = k,l.
\]</span></p>
<p>Panel C) compares early treated <span class="math inline">\(k\)</span> against untreated periods of late treated <span class="math inline">\(l\)</span>. Note that we replace the <span class="math inline">\(POST\)</span> period with period between treatment of the early treated and the late treated <span class="math inline">\(MID(k,l)\)</span> <span class="math display">\[
\hat{\delta}_{DD}^{kl} = (\mathrm{E}(y_{k}^{MID(k,l)}) - \mathrm{E}(y_{k}^{pre(k)})) - (\mathrm{E}(y_{l}^{MID(k,l)}) - \mathrm{E}(y_{l}^{pre(k)})).
\]</span></p>
<p>Panel D) compares late treated <span class="math inline">\(l\)</span> against already treated periods of early treated <span class="math inline">\(k\)</span>. Note that we replace the <span class="math inline">\(PRE\)</span> period with period between treatment of the early treated and the late treated <span class="math inline">\(MID(k,l)\)</span> <span class="math display">\[
\hat{\delta}_{DD}^{lk} = (\mathrm{E}(y_{l}^{post(l)}) - \mathrm{E}(y_{l}^{MID(k,l)})) - (\mathrm{E}(y_{k}^{post(l)}) - \mathrm{E}(y_{k}^{MID(k,l)})).
\]</span></p>
<p>THE twoways FE estimator can now be recovered as a weighted combinations of these four <span class="math inline">\(2\times2\)</span> Diff-in-Diff estimators.</p>
<p>The <strong>weights</strong> of each of them depend on</p>
<ol type="a">
<li><p><strong>the number of periods each subsample uses</strong>, and</p></li>
<li><p><strong>the amount of treatment variance within each subsample</strong>.</p></li>
</ol>
<p>Define <span class="math inline">\(\bar{D}_{kl}\)</span> as the mean of <span class="math inline">\(D_{it}\)</span> in the subsample that compares groups <span class="math inline">\(k\)</span> and <span class="math inline">\(l\)</span> - denoting the share of time the group spends treated -, and the relative size of each group in the pair <span class="math inline">\(n_{kl} = \frac{n_k}{n_k + n_l}\)</span>. Further <span class="math inline">\(\hat{V}_D\)</span> equals the overal variance in <span class="math inline">\(D_{it}\)</span>, and <span class="math inline">\(\hat{V}_D^{jC}\)</span> denotes the amount of identifying variation for comparison of groups <span class="math inline">\(j\)</span> and <span class="math inline">\(C\)</span>. Then, the weights are given by:</p>
<p><span class="math display">\[
W_{jC} = \frac{(n_j + n_C)^2 \hat{V}_D^{jC}}{\hat{V}_D}, ~\text{with}~ \hat{V}_D^{jC} = n_{jC}(1-n_{jC}) \bar{D}_j(1-\bar{D}_j), ~for~ j = k,l.
\]</span></p>
<p><span class="math display">\[
W_{kl} = \frac{\bigl( (n_k + n_l)(1-\bar{D}_l) \bigr)^2 \hat{V}_D^{kl}}{\hat{V}_D}, ~\text{with}~ \hat{V}_D^{kl} = n_{kl}(1-n_{kl}) \frac{\bar{D}_k-\bar{D}_l}{1-\bar{D}_l} \frac{1-\bar{D}_k}{1-\bar{D}_l}.
\]</span></p>
<p><span class="math display">\[
W_{lk} = \frac{\bigl( (n_l + n_k)\bar{D}_k \bigr)^2 \hat{V}_D^{lk}}{\hat{V}_D}, ~\text{with}~ \hat{V}_D^{lk} = n_{lk}(1-n_{lk}) \frac{\bar{D}_l}{\bar{D}_k} \frac{\bar{D}_k-\bar{D}_l}{\bar{D}_k}.
\]</span></p>
<p>If group-sizes are equal, then the treatment variance <span class="math inline">\(\hat{V}_D\)</span> in each combination group depends on the timing of the treatment. The variance get larger the more similar the groups sizes <span class="math inline">\(n_{ju}\)</span>, and the more central (in the middle of the observation period) the treatment timing (<span class="math inline">\(\bar{D}_k, \frac{\bar{D}_k-\bar{D}_l}{1-\bar{D}_l}, \frac{\bar{D}_l}{\bar{D}_k}\)</span> close to 0.5).</p>
<p>Note that <strong>these weights are always positive</strong>.</p>
<p>QUESTION: Do you know which of the above groups A), B), C), D) get the highest weights in the example. Why?</p>
<section id="biased-estimates" class="level3">
<h3 class="anchored" data-anchor-id="biased-estimates">Biased Estimates</h3>
<p>So why (or when) could this lead to problems with the twoways FE estimator? <span class="citation" data-cites="deChaisemartin.2020">de Chaisemartin and D’Haultfœuille (<a href="#ref-deChaisemartin.2020" role="doc-biblioref">2020</a>)</span> and <span class="citation" data-cites="Sun.2021">Sun and Abraham (<a href="#ref-Sun.2021" role="doc-biblioref">2021</a>)</span> criticize the TWFE on the grounds of negative weights of some subgroups / sub-effects, arguing that this may induce substantial bias in the case of heterogeneous treatment effects.</p>
<p><span class="citation" data-cites="Goodman-Bacon.2021">Goodman-Bacon (<a href="#ref-Goodman-Bacon.2021" role="doc-biblioref">2021</a>)</span> also explains the observation of these “negative” weights:</p>
<blockquote class="blockquote">
<p>“Negative weights only arise when average treatment effects vary over time. The DD decomposition shows why: when already-treated units act as controls, changes in their outcomes are subtracted and these changes may include time-varying treatment effects. This does not imply a failure of the design in the sense of non-parallel trends in counterfactual outcomes, but it does suggest caution when using TWFE estimators to summarize treatment effects.”</p>
</blockquote>
<p>Basically, if the treatment effect varies over time (e.g.&nbsp;treatment effect grows over time) TWFE might be biased because early treated groups (with an increasing treatment effect) are used as control groups for late treated groups, thereby masking the treatment effect of these late treated groups (which might however receive a high weight for the overall treatment effect).</p>
<p>Especially for “trend-breaking” treatment effects like in the following figure, this will lead to biased estimates of the average treatment effect <span class="citation" data-cites="Goodman-Bacon.2021 Meer.2016">(<a href="#ref-Goodman-Bacon.2021" role="doc-biblioref">Goodman-Bacon 2021</a>; <a href="#ref-Meer.2016" role="doc-biblioref">Meer and West 2016</a>)</span>.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="fig/goodman2.jpg" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Bias of two-ways FE with trend-breaking treatment <span class="citation" data-cites="Goodman-Bacon.2021">(<a href="#ref-Goodman-Bacon.2021" role="doc-biblioref">Goodman-Bacon 2021</a>)</span>.</figcaption>
</figure>
</div>
<p>In the middle period, we compare the trend in the early treated with the not-yet treated periods of the late treatment group, and we see the divergence between those two groups (a positive treatment effect). However, for the late treated (right art of the figure), the earlier treated are the control cases (which already includes a trend-breaking treatment effect). For the late treatment group, and we do not observe a positive, but actually a negative treatment effect as we erroneously have the treatment effect in the control group!!!</p>
<p>The trend-breaking treatment case is obviously an exception (this would be a really strong treatment effect). However, a similar problem arises with less strong dynamic treatment effects. Below, we set up panel data with three groups and and 12 periods. There is a never-treated group, and early-treated group and a late-treated group. As shown in <a href="#fig-forbidden">Figure&nbsp;1</a>, we could either have A) a statistic treatment effect that changes the outcome level from one period to the other, or B) assume that the treatment effect unfolds dynamically over six periods before it stabilises.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r fold-hide code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="do">#############################</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="do">### Example: Callaway DID </span><span class="al">###</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="do">#############################</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gridExtra)</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggpubr)</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a><span class="do">### Set up six individuals with age and happiness</span></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>T <span class="ot">&lt;-</span> <span class="dv">12</span></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a><span class="co"># id and time</span></span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>df2 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">nrow =</span> N<span class="sc">*</span>T))</span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(df2) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"id"</span>, <span class="st">"time"</span>)</span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>id <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>N, <span class="at">each =</span> T)</span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>time <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>T, <span class="at">times =</span> N)</span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>idname <span class="ot">&lt;-</span> <span class="fu">factor</span>(df2<span class="sc">$</span>id, <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span>N), <span class="at">labels =</span> <span class="fu">paste</span>(<span class="st">"Person"</span>, <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span>N)))</span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Treatment group</span></span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>D <span class="ot">&lt;-</span> <span class="dv">0</span> </span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>D[(<span class="dv">1</span><span class="sc">*</span>T <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(<span class="dv">2</span><span class="sc">*</span>T)] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>D[(<span class="dv">2</span><span class="sc">*</span>T <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(<span class="dv">3</span><span class="sc">*</span>T)] <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb38-26"><a href="#cb38-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-27"><a href="#cb38-27" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>Treatment <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(df2<span class="sc">$</span>time <span class="sc">&gt;=</span> <span class="dv">4</span> <span class="sc">&amp;</span> df2<span class="sc">$</span>D <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb38-28"><a href="#cb38-28" aria-hidden="true" tabindex="-1"></a>oo <span class="ot">&lt;-</span> <span class="fu">which</span>(df2<span class="sc">$</span>time <span class="sc">&gt;=</span> <span class="dv">8</span> <span class="sc">&amp;</span> df2<span class="sc">$</span>D <span class="sc">==</span> <span class="dv">2</span>)</span>
<span id="cb38-29"><a href="#cb38-29" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>Treatment[oo] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb38-30"><a href="#cb38-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-31"><a href="#cb38-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Starting wage</span></span>
<span id="cb38-32"><a href="#cb38-32" aria-hidden="true" tabindex="-1"></a>stw <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">2300</span>, <span class="dv">3000</span>, <span class="dv">4000</span>)</span>
<span id="cb38-33"><a href="#cb38-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-34"><a href="#cb38-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Dynamic treatment</span></span>
<span id="cb38-35"><a href="#cb38-35" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>DT <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">as.character</span>(df2<span class="sc">$</span>Treatment))</span>
<span id="cb38-36"><a href="#cb38-36" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>DT_time <span class="ot">&lt;-</span> <span class="fu">ave</span>(df2<span class="sc">$</span>DT,</span>
<span id="cb38-37"><a href="#cb38-37" aria-hidden="true" tabindex="-1"></a>                   df2<span class="sc">$</span>id,</span>
<span id="cb38-38"><a href="#cb38-38" aria-hidden="true" tabindex="-1"></a>                   <span class="at">FUN =</span> <span class="cf">function</span>(x) <span class="fu">cumsum</span>(x))</span>
<span id="cb38-39"><a href="#cb38-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-40"><a href="#cb38-40" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">max</span>(df2<span class="sc">$</span>DT_time)){</span>
<span id="cb38-41"><a href="#cb38-41" aria-hidden="true" tabindex="-1"></a>  X <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(df2<span class="sc">$</span>DT_time <span class="sc">==</span> i, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb38-42"><a href="#cb38-42" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(i <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb38-43"><a href="#cb38-43" aria-hidden="true" tabindex="-1"></a>    Treatmat <span class="ot">&lt;-</span> X</span>
<span id="cb38-44"><a href="#cb38-44" aria-hidden="true" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb38-45"><a href="#cb38-45" aria-hidden="true" tabindex="-1"></a>    Treatmat <span class="ot">&lt;-</span> <span class="fu">cbind</span>(Treatmat, X)</span>
<span id="cb38-46"><a href="#cb38-46" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb38-47"><a href="#cb38-47" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb38-48"><a href="#cb38-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-49"><a href="#cb38-49" aria-hidden="true" tabindex="-1"></a>beta <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">100</span>, <span class="dv">300</span>, <span class="dv">500</span>, <span class="dv">400</span>, <span class="dv">300</span>, <span class="dv">200</span>, <span class="dv">100</span>, <span class="dv">100</span>, <span class="dv">100</span>)</span>
<span id="cb38-50"><a href="#cb38-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-51"><a href="#cb38-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-52"><a href="#cb38-52" aria-hidden="true" tabindex="-1"></a><span class="co"># wage equation</span></span>
<span id="cb38-53"><a href="#cb38-53" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>wage <span class="ot">&lt;-</span> <span class="fu">unname</span>(<span class="fu">rep</span>(stw, <span class="at">each =</span> T)) <span class="sc">+</span> (df2<span class="sc">$</span>time <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">*</span><span class="dv">50</span> <span class="sc">+</span> Treatmat <span class="sc">%*%</span> beta</span>
<span id="cb38-54"><a href="#cb38-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-55"><a href="#cb38-55" aria-hidden="true" tabindex="-1"></a><span class="co"># alternative wage equation</span></span>
<span id="cb38-56"><a href="#cb38-56" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>alt_wage <span class="ot">&lt;-</span> <span class="fu">unname</span>(<span class="fu">rep</span>(stw, <span class="at">each =</span> T)) <span class="sc">+</span> (df2<span class="sc">$</span>time <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">*</span><span class="dv">50</span> <span class="sc">+</span> df2<span class="sc">$</span>Treatment <span class="sc">*</span> <span class="dv">500</span></span>
<span id="cb38-57"><a href="#cb38-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-58"><a href="#cb38-58" aria-hidden="true" tabindex="-1"></a><span class="co"># counterfactual</span></span>
<span id="cb38-59"><a href="#cb38-59" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>wage0 <span class="ot">&lt;-</span> <span class="fu">unname</span>(<span class="fu">rep</span>(stw, <span class="at">each =</span> T)) <span class="sc">+</span> (df2<span class="sc">$</span>time <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">*</span><span class="dv">50</span></span>
<span id="cb38-60"><a href="#cb38-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-61"><a href="#cb38-61" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>Treatment <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(df2<span class="sc">$</span>Treatment)</span>
<span id="cb38-62"><a href="#cb38-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-63"><a href="#cb38-63" aria-hidden="true" tabindex="-1"></a><span class="co"># Add comparison groups</span></span>
<span id="cb38-64"><a href="#cb38-64" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>wage2 <span class="ot">&lt;-</span> <span class="fu">ave</span>(df2<span class="sc">$</span>wage,</span>
<span id="cb38-65"><a href="#cb38-65" aria-hidden="true" tabindex="-1"></a>                 df2<span class="sc">$</span>id,</span>
<span id="cb38-66"><a href="#cb38-66" aria-hidden="true" tabindex="-1"></a>                 <span class="at">FUN =</span> <span class="cf">function</span>(x) dplyr<span class="sc">::</span><span class="fu">lag</span>(x))</span>
<span id="cb38-67"><a href="#cb38-67" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>time2 <span class="ot">&lt;-</span> <span class="fu">ave</span>(df2<span class="sc">$</span>time,</span>
<span id="cb38-68"><a href="#cb38-68" aria-hidden="true" tabindex="-1"></a>                 df2<span class="sc">$</span>id,</span>
<span id="cb38-69"><a href="#cb38-69" aria-hidden="true" tabindex="-1"></a>                 <span class="at">FUN =</span> <span class="cf">function</span>(x) dplyr<span class="sc">::</span><span class="fu">lag</span>(x))</span>
<span id="cb38-70"><a href="#cb38-70" aria-hidden="true" tabindex="-1"></a>oo <span class="ot">&lt;-</span> <span class="fu">which</span>(df2<span class="sc">$</span>Treatment <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb38-71"><a href="#cb38-71" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>wage2[oo] <span class="ot">&lt;-</span> <span class="fu">ave</span>(df2<span class="sc">$</span>wage2[oo],</span>
<span id="cb38-72"><a href="#cb38-72" aria-hidden="true" tabindex="-1"></a>                 df2<span class="sc">$</span>id[oo],</span>
<span id="cb38-73"><a href="#cb38-73" aria-hidden="true" tabindex="-1"></a>                 <span class="at">FUN =</span> <span class="cf">function</span>(x) x[<span class="dv">1</span>])</span>
<span id="cb38-74"><a href="#cb38-74" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>time2[oo] <span class="ot">&lt;-</span> <span class="fu">ave</span>(df2<span class="sc">$</span>time2[oo],</span>
<span id="cb38-75"><a href="#cb38-75" aria-hidden="true" tabindex="-1"></a>                 df2<span class="sc">$</span>id[oo],</span>
<span id="cb38-76"><a href="#cb38-76" aria-hidden="true" tabindex="-1"></a>                 <span class="at">FUN =</span> <span class="cf">function</span>(x) x[<span class="dv">1</span>])</span>
<span id="cb38-77"><a href="#cb38-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-78"><a href="#cb38-78" aria-hidden="true" tabindex="-1"></a><span class="co"># for alpha</span></span>
<span id="cb38-79"><a href="#cb38-79" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>D2 <span class="ot">&lt;-</span> df2<span class="sc">$</span>D</span>
<span id="cb38-80"><a href="#cb38-80" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>D3 <span class="ot">&lt;-</span> df2<span class="sc">$</span>D</span>
<span id="cb38-81"><a href="#cb38-81" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>D2[<span class="fu">which</span>(df2<span class="sc">$</span>id <span class="sc">==</span> <span class="dv">2</span> <span class="sc">&amp;</span> df2<span class="sc">$</span>time <span class="sc">&gt;=</span> <span class="dv">8</span>)] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb38-82"><a href="#cb38-82" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>D3[<span class="fu">which</span>(df2<span class="sc">$</span>id <span class="sc">==</span> <span class="dv">2</span> <span class="sc">&amp;</span> df2<span class="sc">$</span>time <span class="sc">&gt;=</span> <span class="dv">7</span>)] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb38-83"><a href="#cb38-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-84"><a href="#cb38-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-85"><a href="#cb38-85" aria-hidden="true" tabindex="-1"></a><span class="do">### Plot the Callaway Sant Anna Comparisons </span><span class="al">###</span></span>
<span id="cb38-86"><a href="#cb38-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-87"><a href="#cb38-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-88"><a href="#cb38-88" aria-hidden="true" tabindex="-1"></a>zp1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df2, <span class="fu">aes</span>(time, wage)) <span class="sc">+</span></span>
<span id="cb38-89"><a href="#cb38-89" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> wage, <span class="at">group =</span> id, <span class="at">alpha =</span> <span class="fu">as.factor</span>(D)), <span class="at">lty =</span> <span class="st">"solid"</span>, </span>
<span id="cb38-90"><a href="#cb38-90" aria-hidden="true" tabindex="-1"></a>            <span class="at">colour =</span> <span class="st">"black"</span>, <span class="at">lwd =</span> <span class="dv">1</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span> </span>
<span id="cb38-91"><a href="#cb38-91" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>( <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> wage, <span class="at">fill =</span> Treatment, <span class="at">shape =</span> Treatment, <span class="at">alpha =</span> <span class="fu">as.factor</span>(D)), </span>
<span id="cb38-92"><a href="#cb38-92" aria-hidden="true" tabindex="-1"></a>              <span class="at">size =</span> <span class="dv">4</span>, <span class="at">stroke =</span> <span class="fl">1.5</span>, <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb38-93"><a href="#cb38-93" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_alpha_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="fl">0.2</span>), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb38-94"><a href="#cb38-94" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb38-95"><a href="#cb38-95" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>( <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">12</span>, <span class="dv">2</span>))  <span class="sc">+</span></span>
<span id="cb38-96"><a href="#cb38-96" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#85144b"</span>, <span class="st">"#0074D9"</span>)) <span class="sc">+</span></span>
<span id="cb38-97"><a href="#cb38-97" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#85144b"</span>, <span class="st">"#0074D9"</span>)) <span class="sc">+</span></span>
<span id="cb38-98"><a href="#cb38-98" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_shape_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="dv">21</span>, <span class="dv">24</span>)) <span class="sc">+</span></span>
<span id="cb38-99"><a href="#cb38-99" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Group 1: 11 2x2 DID estimates vs. never-treated"</span>) <span class="sc">+</span></span>
<span id="cb38-100"><a href="#cb38-100" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.05</span>,<span class="fl">0.95</span>), <span class="at">legend.justification =</span> <span class="fu">c</span>(<span class="st">"left"</span>, <span class="st">"top"</span>),</span>
<span id="cb38-101"><a href="#cb38-101" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb38-102"><a href="#cb38-102" aria-hidden="true" tabindex="-1"></a>        <span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb38-103"><a href="#cb38-103" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.box.background =</span> <span class="fu">element_rect</span>(<span class="at">colour =</span> <span class="st">"black"</span>)) <span class="sc">+</span></span>
<span id="cb38-104"><a href="#cb38-104" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_curve</span>(<span class="fu">aes</span>(<span class="at">x =</span> time2, <span class="at">y =</span> wage2, <span class="at">xend =</span> time, <span class="at">yend =</span> wage, <span class="at">color =</span> Treatment), </span>
<span id="cb38-105"><a href="#cb38-105" aria-hidden="true" tabindex="-1"></a>             <span class="at">curvature =</span> <span class="fl">0.3</span>, <span class="at">data =</span> df2[df2<span class="sc">$</span>D <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(df2<span class="sc">$</span>wage2), ])</span>
<span id="cb38-106"><a href="#cb38-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-107"><a href="#cb38-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-108"><a href="#cb38-108" aria-hidden="true" tabindex="-1"></a>zp2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df2, <span class="fu">aes</span>(time, wage)) <span class="sc">+</span></span>
<span id="cb38-109"><a href="#cb38-109" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> wage, <span class="at">group =</span> id, <span class="at">alpha =</span> <span class="fu">as.factor</span>(D3)), <span class="at">lty =</span> <span class="st">"solid"</span>, </span>
<span id="cb38-110"><a href="#cb38-110" aria-hidden="true" tabindex="-1"></a>            <span class="at">colour =</span> <span class="st">"black"</span>, <span class="at">lwd =</span> <span class="dv">1</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span> </span>
<span id="cb38-111"><a href="#cb38-111" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>( <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> wage,  <span class="at">fill =</span> Treatment, <span class="at">shape =</span> Treatment, <span class="at">alpha =</span> <span class="fu">as.factor</span>(D2)), </span>
<span id="cb38-112"><a href="#cb38-112" aria-hidden="true" tabindex="-1"></a>              <span class="at">size =</span> <span class="dv">4</span>, <span class="at">stroke =</span> <span class="fl">1.5</span>,  <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb38-113"><a href="#cb38-113" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_shape_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="dv">21</span>, <span class="dv">24</span>)) <span class="sc">+</span></span>
<span id="cb38-114"><a href="#cb38-114" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_alpha_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="dv">1</span>, <span class="fl">0.2</span>), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb38-115"><a href="#cb38-115" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#85144b"</span>, <span class="st">"#0074D9"</span>)) <span class="sc">+</span></span>
<span id="cb38-116"><a href="#cb38-116" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#85144b"</span>, <span class="st">"#0074D9"</span>)) <span class="sc">+</span></span>
<span id="cb38-117"><a href="#cb38-117" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> wage, <span class="at">group =</span> id, ), <span class="at">lty =</span> <span class="st">"solid"</span>, <span class="at">colour =</span> <span class="st">"black"</span>, <span class="at">lwd =</span> <span class="dv">1</span>,</span>
<span id="cb38-118"><a href="#cb38-118" aria-hidden="true" tabindex="-1"></a>            <span class="at">data =</span> df2[df2<span class="sc">$</span>D2 <span class="sc">==</span> <span class="dv">2</span> <span class="sc">&amp;</span> df2<span class="sc">$</span>time <span class="sc">&lt;=</span> <span class="dv">7</span>, ]) <span class="sc">+</span> </span>
<span id="cb38-119"><a href="#cb38-119" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>( <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> wage, <span class="at">fill =</span> Treatment, <span class="at">shape =</span> Treatment),</span>
<span id="cb38-120"><a href="#cb38-120" aria-hidden="true" tabindex="-1"></a>              <span class="at">data =</span> df2[df2<span class="sc">$</span>D <span class="sc">==</span> <span class="dv">2</span> <span class="sc">&amp;</span> df2<span class="sc">$</span>time <span class="sc">&lt;=</span> <span class="dv">7</span>, ],</span>
<span id="cb38-121"><a href="#cb38-121" aria-hidden="true" tabindex="-1"></a>              <span class="at">size =</span> <span class="dv">4</span>, <span class="at">stroke =</span> <span class="fl">1.5</span>,  <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb38-122"><a href="#cb38-122" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_shape_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="dv">21</span>, <span class="dv">24</span>)) <span class="sc">+</span></span>
<span id="cb38-123"><a href="#cb38-123" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb38-124"><a href="#cb38-124" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>( <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">12</span>, <span class="dv">2</span>))  <span class="sc">+</span></span>
<span id="cb38-125"><a href="#cb38-125" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Group 1: 6 2x2 DID estimates vs. not-yet-treated"</span>) <span class="sc">+</span></span>
<span id="cb38-126"><a href="#cb38-126" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.05</span>,<span class="fl">0.95</span>), <span class="at">legend.justification =</span> <span class="fu">c</span>(<span class="st">"left"</span>, <span class="st">"top"</span>),</span>
<span id="cb38-127"><a href="#cb38-127" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb38-128"><a href="#cb38-128" aria-hidden="true" tabindex="-1"></a>        <span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb38-129"><a href="#cb38-129" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.box.background =</span> <span class="fu">element_rect</span>(<span class="at">colour =</span> <span class="st">"black"</span>)) <span class="sc">+</span></span>
<span id="cb38-130"><a href="#cb38-130" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_curve</span>(<span class="fu">aes</span>(<span class="at">x =</span> time2, <span class="at">y =</span> wage2, <span class="at">xend =</span> time, <span class="at">yend =</span> wage, <span class="at">color =</span> Treatment), </span>
<span id="cb38-131"><a href="#cb38-131" aria-hidden="true" tabindex="-1"></a>             <span class="at">curvature =</span> <span class="fl">0.3</span>, <span class="at">data =</span> df2[df2<span class="sc">$</span>D <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(df2<span class="sc">$</span>wage2) <span class="sc">&amp;</span> df2<span class="sc">$</span>time <span class="sc">&lt;=</span> <span class="dv">7</span>, ])</span>
<span id="cb38-132"><a href="#cb38-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-133"><a href="#cb38-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-134"><a href="#cb38-134" aria-hidden="true" tabindex="-1"></a>zp3 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df2, <span class="fu">aes</span>(time, wage)) <span class="sc">+</span></span>
<span id="cb38-135"><a href="#cb38-135" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> wage, <span class="at">group =</span> id, <span class="at">alpha =</span> <span class="fu">as.factor</span>(D)), <span class="at">lty =</span> <span class="st">"solid"</span>, </span>
<span id="cb38-136"><a href="#cb38-136" aria-hidden="true" tabindex="-1"></a>            <span class="at">colour =</span> <span class="st">"black"</span>, <span class="at">lwd =</span> <span class="dv">1</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span> </span>
<span id="cb38-137"><a href="#cb38-137" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> wage, <span class="at">fill =</span> Treatment, <span class="at">shape =</span> Treatment, <span class="at">alpha =</span> <span class="fu">as.factor</span>(D)), </span>
<span id="cb38-138"><a href="#cb38-138" aria-hidden="true" tabindex="-1"></a>              <span class="at">size =</span> <span class="dv">4</span>, <span class="at">stroke =</span><span class="fl">1.5</span>, <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb38-139"><a href="#cb38-139" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#85144b"</span>, <span class="st">"#0074D9"</span>)) <span class="sc">+</span></span>
<span id="cb38-140"><a href="#cb38-140" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#85144b"</span>, <span class="st">"#0074D9"</span>)) <span class="sc">+</span></span>
<span id="cb38-141"><a href="#cb38-141" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_shape_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="dv">21</span>, <span class="dv">24</span>)) <span class="sc">+</span></span>
<span id="cb38-142"><a href="#cb38-142" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_alpha_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="fl">0.2</span>, <span class="dv">1</span>), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb38-143"><a href="#cb38-143" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb38-144"><a href="#cb38-144" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>( <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">12</span>, <span class="dv">2</span>))  <span class="sc">+</span></span>
<span id="cb38-145"><a href="#cb38-145" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Group 2: 11 2x2 DID estimates vs. never-treated"</span>) <span class="sc">+</span></span>
<span id="cb38-146"><a href="#cb38-146" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.05</span>,<span class="fl">0.95</span>), <span class="at">legend.justification =</span> <span class="fu">c</span>(<span class="st">"left"</span>, <span class="st">"top"</span>),</span>
<span id="cb38-147"><a href="#cb38-147" aria-hidden="true" tabindex="-1"></a>        <span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb38-148"><a href="#cb38-148" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb38-149"><a href="#cb38-149" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.box.background =</span> <span class="fu">element_rect</span>(<span class="at">colour =</span> <span class="st">"black"</span>)) <span class="sc">+</span></span>
<span id="cb38-150"><a href="#cb38-150" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_curve</span>(<span class="fu">aes</span>(<span class="at">x =</span> time2, <span class="at">y =</span> wage2, <span class="at">xend =</span> time, <span class="at">yend =</span> wage, <span class="at">color =</span> Treatment), </span>
<span id="cb38-151"><a href="#cb38-151" aria-hidden="true" tabindex="-1"></a>             <span class="at">curvature =</span> <span class="fl">0.3</span>, <span class="at">data =</span> df2[df2<span class="sc">$</span>D <span class="sc">==</span> <span class="dv">2</span> <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(df2<span class="sc">$</span>wage2), ])</span>
<span id="cb38-152"><a href="#cb38-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-153"><a href="#cb38-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-154"><a href="#cb38-154" aria-hidden="true" tabindex="-1"></a>text <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">"DOES NOT compare</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb38-155"><a href="#cb38-155" aria-hidden="true" tabindex="-1"></a>                             <span class="st">"group 2 (late treatment) vs.</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb38-156"><a href="#cb38-156" aria-hidden="true" tabindex="-1"></a>                             <span class="st">"the already treated periods of group 1"</span>)</span>
<span id="cb38-157"><a href="#cb38-157" aria-hidden="true" tabindex="-1"></a>zp4 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb38-158"><a href="#cb38-158" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="dv">4</span>, <span class="at">y =</span> <span class="dv">25</span>, <span class="at">size=</span><span class="dv">8</span>, <span class="at">label =</span> text, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span> </span>
<span id="cb38-159"><a href="#cb38-159" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span>
<span id="cb38-160"><a href="#cb38-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-161"><a href="#cb38-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-162"><a href="#cb38-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-163"><a href="#cb38-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-164"><a href="#cb38-164" aria-hidden="true" tabindex="-1"></a><span class="do">### Plot the Forbidden Comparisons Comparisons </span><span class="al">###</span></span>
<span id="cb38-165"><a href="#cb38-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-166"><a href="#cb38-166" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>D4 <span class="ot">&lt;-</span> df2<span class="sc">$</span>D</span>
<span id="cb38-167"><a href="#cb38-167" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>D4[df2<span class="sc">$</span>time <span class="sc">&lt;=</span> <span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb38-168"><a href="#cb38-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-169"><a href="#cb38-169" aria-hidden="true" tabindex="-1"></a><span class="co"># Feed forward</span></span>
<span id="cb38-170"><a href="#cb38-170" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>l_Treatment <span class="ot">&lt;-</span> <span class="fu">ave</span>(df2<span class="sc">$</span>Treatment,</span>
<span id="cb38-171"><a href="#cb38-171" aria-hidden="true" tabindex="-1"></a>                       df2<span class="sc">$</span>id,</span>
<span id="cb38-172"><a href="#cb38-172" aria-hidden="true" tabindex="-1"></a>                       <span class="at">FUN =</span> <span class="cf">function</span>(x) dplyr<span class="sc">::</span><span class="fu">lead</span>(x))</span>
<span id="cb38-173"><a href="#cb38-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-174"><a href="#cb38-174" aria-hidden="true" tabindex="-1"></a>fp1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df2, <span class="fu">aes</span>(time, wage)) <span class="sc">+</span></span>
<span id="cb38-175"><a href="#cb38-175" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> wage, <span class="at">group =</span> id, <span class="at">alpha =</span> <span class="fu">as.factor</span>(D4)), <span class="at">lty =</span> <span class="st">"solid"</span>, </span>
<span id="cb38-176"><a href="#cb38-176" aria-hidden="true" tabindex="-1"></a>            <span class="at">colour =</span> <span class="st">"black"</span>, <span class="at">lwd =</span> <span class="dv">1</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span> </span>
<span id="cb38-177"><a href="#cb38-177" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> wage, <span class="at">fill =</span> Treatment, <span class="at">shape =</span> Treatment, <span class="at">alpha =</span> <span class="fu">as.factor</span>(D4)), </span>
<span id="cb38-178"><a href="#cb38-178" aria-hidden="true" tabindex="-1"></a>              <span class="at">size =</span> <span class="dv">4</span>, <span class="at">stroke =</span><span class="fl">1.5</span>, <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb38-179"><a href="#cb38-179" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> wage0, <span class="at">group =</span> id), </span>
<span id="cb38-180"><a href="#cb38-180" aria-hidden="true" tabindex="-1"></a>            <span class="at">data =</span> df2[df2<span class="sc">$</span>l_Treatment <span class="sc">==</span> <span class="dv">1</span> <span class="sc">|</span> df2<span class="sc">$</span>Treatment <span class="sc">==</span> <span class="dv">1</span>, ],</span>
<span id="cb38-181"><a href="#cb38-181" aria-hidden="true" tabindex="-1"></a>            <span class="at">lty =</span> <span class="st">"dashed"</span>, <span class="at">alpha =</span> <span class="fl">0.2</span>,</span>
<span id="cb38-182"><a href="#cb38-182" aria-hidden="true" tabindex="-1"></a>            <span class="at">colour =</span> <span class="st">"black"</span>, <span class="at">lwd =</span> <span class="dv">1</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span> </span>
<span id="cb38-183"><a href="#cb38-183" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> wage0), </span>
<span id="cb38-184"><a href="#cb38-184" aria-hidden="true" tabindex="-1"></a>             <span class="at">data =</span> df2[df2<span class="sc">$</span>Treatment <span class="sc">==</span> <span class="dv">1</span>, ],</span>
<span id="cb38-185"><a href="#cb38-185" aria-hidden="true" tabindex="-1"></a>             <span class="at">size =</span> <span class="dv">3</span>, <span class="at">stroke =</span> <span class="dv">1</span>, <span class="at">alpha =</span> <span class="fl">0.2</span>, <span class="at">shape =</span> <span class="dv">21</span>) <span class="sc">+</span></span>
<span id="cb38-186"><a href="#cb38-186" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_blank</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> alt_wage, <span class="at">fill =</span> Treatment, <span class="at">shape =</span> Treatment, <span class="at">alpha =</span> <span class="fu">as.factor</span>(D4)), </span>
<span id="cb38-187"><a href="#cb38-187" aria-hidden="true" tabindex="-1"></a>              <span class="at">size =</span> <span class="dv">4</span>, <span class="at">stroke =</span><span class="fl">1.5</span>, <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb38-188"><a href="#cb38-188" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#85144b"</span>, <span class="st">"#0074D9"</span>)) <span class="sc">+</span></span>
<span id="cb38-189"><a href="#cb38-189" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#85144b"</span>, <span class="st">"#0074D9"</span>)) <span class="sc">+</span></span>
<span id="cb38-190"><a href="#cb38-190" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_shape_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="dv">21</span>, <span class="dv">24</span>)) <span class="sc">+</span></span>
<span id="cb38-191"><a href="#cb38-191" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_alpha_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="dv">1</span>, <span class="dv">1</span>), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb38-192"><a href="#cb38-192" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb38-193"><a href="#cb38-193" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>( <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">12</span>, <span class="dv">2</span>))  <span class="sc">+</span></span>
<span id="cb38-194"><a href="#cb38-194" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"B) Dynamic treatment effect </span><span class="sc">\n</span><span class="st">    Late-treated vs. already-treated"</span>) <span class="sc">+</span></span>
<span id="cb38-195"><a href="#cb38-195" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.05</span>,<span class="fl">0.95</span>), <span class="at">legend.justification =</span> <span class="fu">c</span>(<span class="st">"left"</span>, <span class="st">"top"</span>),</span>
<span id="cb38-196"><a href="#cb38-196" aria-hidden="true" tabindex="-1"></a>        <span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb38-197"><a href="#cb38-197" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb38-198"><a href="#cb38-198" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.box.background =</span> <span class="fu">element_rect</span>(<span class="at">colour =</span> <span class="st">"black"</span>)) </span>
<span id="cb38-199"><a href="#cb38-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-200"><a href="#cb38-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-201"><a href="#cb38-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-202"><a href="#cb38-202" aria-hidden="true" tabindex="-1"></a>fp2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df2, <span class="fu">aes</span>(time, alt_wage)) <span class="sc">+</span></span>
<span id="cb38-203"><a href="#cb38-203" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> alt_wage, <span class="at">group =</span> id, <span class="at">alpha =</span> <span class="fu">as.factor</span>(D4)), <span class="at">lty =</span> <span class="st">"solid"</span>, </span>
<span id="cb38-204"><a href="#cb38-204" aria-hidden="true" tabindex="-1"></a>            <span class="at">colour =</span> <span class="st">"black"</span>, <span class="at">lwd =</span> <span class="dv">1</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span> </span>
<span id="cb38-205"><a href="#cb38-205" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> alt_wage, <span class="at">fill =</span> Treatment, <span class="at">shape =</span> Treatment, <span class="at">alpha =</span> <span class="fu">as.factor</span>(D4)), </span>
<span id="cb38-206"><a href="#cb38-206" aria-hidden="true" tabindex="-1"></a>              <span class="at">size =</span> <span class="dv">4</span>, <span class="at">stroke =</span><span class="fl">1.5</span>, <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb38-207"><a href="#cb38-207" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> wage0, <span class="at">group =</span> id), </span>
<span id="cb38-208"><a href="#cb38-208" aria-hidden="true" tabindex="-1"></a>            <span class="at">data =</span> df2[df2<span class="sc">$</span>l_Treatment <span class="sc">==</span> <span class="dv">1</span> <span class="sc">|</span> df2<span class="sc">$</span>Treatment <span class="sc">==</span> <span class="dv">1</span>, ],</span>
<span id="cb38-209"><a href="#cb38-209" aria-hidden="true" tabindex="-1"></a>            <span class="at">lty =</span> <span class="st">"dashed"</span>, <span class="at">alpha =</span> <span class="fl">0.2</span>,</span>
<span id="cb38-210"><a href="#cb38-210" aria-hidden="true" tabindex="-1"></a>            <span class="at">colour =</span> <span class="st">"black"</span>, <span class="at">lwd =</span> <span class="dv">1</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span> </span>
<span id="cb38-211"><a href="#cb38-211" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> wage0), </span>
<span id="cb38-212"><a href="#cb38-212" aria-hidden="true" tabindex="-1"></a>             <span class="at">data =</span> df2[df2<span class="sc">$</span>Treatment <span class="sc">==</span> <span class="dv">1</span>, ],</span>
<span id="cb38-213"><a href="#cb38-213" aria-hidden="true" tabindex="-1"></a>             <span class="at">size =</span> <span class="dv">3</span>, <span class="at">stroke =</span> <span class="dv">1</span>, <span class="at">alpha =</span> <span class="fl">0.2</span>, <span class="at">shape =</span> <span class="dv">21</span>) <span class="sc">+</span></span>
<span id="cb38-214"><a href="#cb38-214" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#85144b"</span>, <span class="st">"#0074D9"</span>)) <span class="sc">+</span></span>
<span id="cb38-215"><a href="#cb38-215" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#85144b"</span>, <span class="st">"#0074D9"</span>)) <span class="sc">+</span></span>
<span id="cb38-216"><a href="#cb38-216" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_shape_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="dv">21</span>, <span class="dv">24</span>)) <span class="sc">+</span></span>
<span id="cb38-217"><a href="#cb38-217" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_alpha_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="dv">1</span>, <span class="dv">1</span>), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb38-218"><a href="#cb38-218" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb38-219"><a href="#cb38-219" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>( <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">12</span>, <span class="dv">2</span>))  <span class="sc">+</span></span>
<span id="cb38-220"><a href="#cb38-220" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"A) Static treatment effect </span><span class="sc">\n</span><span class="st">    Late-treated vs. already-treated"</span>) <span class="sc">+</span></span>
<span id="cb38-221"><a href="#cb38-221" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"wage"</span>) <span class="sc">+</span></span>
<span id="cb38-222"><a href="#cb38-222" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.05</span>,<span class="fl">0.95</span>), <span class="at">legend.justification =</span> <span class="fu">c</span>(<span class="st">"left"</span>, <span class="st">"top"</span>),</span>
<span id="cb38-223"><a href="#cb38-223" aria-hidden="true" tabindex="-1"></a>        <span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb38-224"><a href="#cb38-224" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb38-225"><a href="#cb38-225" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.box.background =</span> <span class="fu">element_rect</span>(<span class="at">colour =</span> <span class="st">"black"</span>)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r fold-hide code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>zp <span class="ot">&lt;-</span> <span class="fu">ggarrange</span>(fp2, fp1  <span class="sc">+</span> <span class="fu">rremove</span>(<span class="st">"legend"</span>), </span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>                <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">nrow =</span> <span class="dv">1</span>)</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="fu">cairo_ps</span>(<span class="at">file =</span> <span class="fu">paste</span>(<span class="st">"fig/"</span>, <span class="st">"Forbidden.eps"</span>, <span class="at">sep=</span><span class="st">""</span>), <span class="at">width =</span> <span class="dv">11</span>, <span class="at">height =</span> <span class="fl">4.5</span>, </span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>          <span class="at">bg =</span> <span class="st">"white"</span>, <span class="at">family =</span> <span class="st">"Times New Roman"</span>)</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>))</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>), <span class="at">oma =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>))</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>zp</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a><span class="fu">dev.off</span>()</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a><span class="fu">jpeg</span>(<span class="at">file =</span> <span class="fu">paste</span>(<span class="st">"fig/"</span>, <span class="st">"Forbidden.jpeg"</span>, <span class="at">sep=</span><span class="st">""</span>), <span class="at">width =</span> <span class="dv">11</span>, <span class="at">height =</span> <span class="fl">4.5</span>, </span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">units =</span> <span class="st">"in"</span>, <span class="at">res =</span> <span class="dv">300</span>, <span class="at">type =</span> <span class="st">"cairo"</span>,</span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>          <span class="at">bg =</span> <span class="st">"white"</span>, <span class="at">family =</span> <span class="st">"Times New Roman"</span>)</span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>))</span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>), <span class="at">oma =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>))</span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>zp</span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a><span class="fu">dev.off</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="fig-forbidden" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="fig/Forbidden.jpeg" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;1: Forbidden comparison of late-treated vs already-treated</figcaption>
</figure>
</div>
<p>The problem now arises when FE compares the late treated as treatment group vs.&nbsp;the already treated as control group. In the static treatment case (<a href="#fig-forbidden">Figure&nbsp;1</a> A), everything is fine as the already-treated run parallel to counterfactual of the late-treated. We can thus use them as control. However, in the dynamic treatment case (<a href="#fig-forbidden">Figure&nbsp;1</a> B), the “control” group of already-treated experience still an ongoing dynamic treatment effect when the late-treated are treated. They are thus not running parallel to the counterfactual of the late-treated group. This comparison is thus also called the forbidden comparison <span class="citation" data-cites="Roth.2023">(<a href="#ref-Roth.2023" role="doc-biblioref">Roth et al. 2023</a>)</span>.</p>
<p>One way of counteracting this problem is to use event study / impact function designs (see above) to explicitly model time varying treatment effects.</p>
</section>
<section id="callaway-santanna-dynamic-diff-in-diff" class="level3">
<h3 class="anchored" data-anchor-id="callaway-santanna-dynamic-diff-in-diff">Callaway &amp; Sant’Anna dynamic Diff-in-Diff</h3>
<p>A second way is the application of <strong>flexible Diff-in-Diff</strong> estimators as proposed by <span class="citation" data-cites="Callaway.2020">Callaway and Sant’Anna (<a href="#ref-Callaway.2020" role="doc-biblioref">2020</a>)</span>.</p>
<p>Let’s start again with the <span class="math inline">\(2 \times 2\)</span> Diff-in-Diff estimator as</p>
<p><span class="math display">\[
\delta = \mathrm{E}(\Delta y_{T}) - \mathrm{E}(\Delta y_{C}) = (\mathrm{E}(y_{T}^{post}) - \mathrm{E}(y_{T}^{pre})) - (\mathrm{E}(y_{C}^{post}) - \mathrm{E}(y_{C}^{pre})),
\]</span> where <span class="math inline">\(\delta\)</span> is the average treatment effect on the treated (ATT).</p>
<p><span class="citation" data-cites="Callaway.2020">Callaway and Sant’Anna (<a href="#ref-Callaway.2020" role="doc-biblioref">2020</a>)</span> show that we can generalize this <span class="math inline">\(2 \times 2\)</span> Diff-in-Diff to a mutlti-group and multi-timing setting by computing group-time average treatment effects. We group all treatment units which receive treatment at the same period into a common group <span class="math inline">\(g\)</span>, and for each treatment-group <span class="math inline">\(g\)</span> and time period <span class="math inline">\(t\)</span> we estimate group-specific and time-specific ATTs:</p>
<p><span class="math display">\[
\delta_{g,t} = \mathrm{E}(\Delta y_{g}) - \mathrm{E}(\Delta y_{C}) = (\mathrm{E}(y_{g}^{t}) - \mathrm{E}(y_{g}^{g-1})) - (\mathrm{E}(y_{C}^{t}) - \mathrm{E}(y_{C}^{g-1})),
\]</span></p>
<p>where the control group can either be the never-treated or the not-yet-treated. As shown in <a href="#fig-callaway">Figure&nbsp;2</a> by the convex lines, this means, we estimate an individual treatment effect for each combination of treatment-timing-group and control group.</p>
<p>Obviously, this gives us a large number of different treatment effects. So, in a second step, we re-aggregate these individual combinations back to group or time averaged treatment effect. In an event study design, <span class="citation" data-cites="Callaway.2020">Callaway and Sant’Anna (<a href="#ref-Callaway.2020" role="doc-biblioref">2020</a>)</span> propose the following dynamic treatment effect for each period <span class="math inline">\(e\)</span> after the treatment:</p>
<p><span class="math display">\[
  \theta_D(e) := \sum_{g=1}^G \mathbf{1} \{ g + e \leq T \} \delta(g,g+e) P(G=g | G+e \leq T),
\]</span> where <span class="math inline">\(e\)</span> specifies for how long a unit has been exposed to the treatment. It’s basically the average effects across all treatment-timing groups at the period <span class="math inline">\(e\)</span> after treatment. From here, one can easily calculate the cumulative effect or the overall aggregated effect.</p>
<p>Consider the situation in <a href="#fig-callaway">Figure&nbsp;2</a>, where we have a control group of never-treated units, one treatment group that is treated early (group 1) and one treatment group that is treated late (group 2). As shown below, with <span class="math inline">\(T=12\)</span> we can estimate 11 2 <span class="math inline">\(\times\)</span> 2 Diff-in-Diff estimates of group 1 against the never treated, we can estimate 6 2 <span class="math inline">\(\times\)</span> 2 Diff-in-Diff estimates of group 1 against the not-yet treated (late treatment group), and we can estimate 11 2 <span class="math inline">\(\times\)</span> 2 Diff-in-Diff estimates of group 2 against the never treated.</p>
<p>Note that the control period for all treated periods by default is set to the period before the treatment happened in each group. For group 1 this is period 3, and for group 2 this is period 7. This makes only sense if there is <strong>no treatment anticipation</strong>. Obviously, we can also use other (earlier) periods if we assume treatment anticipation.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r fold-hide code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>zp <span class="ot">&lt;-</span> <span class="fu">ggarrange</span>(zp1, zp2  <span class="sc">+</span> <span class="fu">rremove</span>(<span class="st">"legend"</span>), </span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>                zp3  <span class="sc">+</span> <span class="fu">rremove</span>(<span class="st">"legend"</span>), zp4,</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>                <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">nrow =</span> <span class="dv">2</span>)</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cairo_ps</span>(<span class="at">file =</span> <span class="fu">paste</span>(<span class="st">"fig/"</span>, <span class="st">"DiD.eps"</span>, <span class="at">sep=</span><span class="st">""</span>), <span class="at">width =</span> <span class="dv">11</span>, <span class="at">height =</span> <span class="dv">8</span>, </span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>          <span class="at">bg =</span> <span class="st">"white"</span>, <span class="at">family =</span> <span class="st">"Times New Roman"</span>)</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>))</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>), <span class="at">oma =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>))</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>zp</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a><span class="fu">dev.off</span>()</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a><span class="fu">jpeg</span>(<span class="at">file =</span> <span class="fu">paste</span>(<span class="st">"fig/"</span>, <span class="st">"DiD.jpeg"</span>, <span class="at">sep=</span><span class="st">""</span>), <span class="at">width =</span> <span class="dv">11</span>, <span class="at">height =</span> <span class="dv">8</span>, </span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">units =</span> <span class="st">"in"</span>, <span class="at">res =</span> <span class="dv">300</span>, <span class="at">type =</span> <span class="st">"cairo"</span>,</span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>          <span class="at">bg =</span> <span class="st">"white"</span>, <span class="at">family =</span> <span class="st">"Times New Roman"</span>)</span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>))</span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>), <span class="at">oma =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>))</span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>zp</span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a><span class="fu">dev.off</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="fig-callaway" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="fig/DiD.jpeg" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;2: Multiple 2x2 DiD comparisons with dynamic DiD estimators</figcaption>
</figure>
</div>
<p>For a more detailled introdution see <span class="citation" data-cites="Callaway.2020">Callaway and Sant’Anna (<a href="#ref-Callaway.2020" role="doc-biblioref">2020</a>)</span> or the respective <a href="https://cran.r-project.org/web/packages/did/vignettes/multi-period-did.html">package introcution</a>.</p>
<p><strong>Assumptions</strong>:</p>
<ol type="1">
<li><p>Staggered treatment adoption: once a unit has been treated, it remains treated thereafter (see also the note above).</p></li>
<li><p>Parallel trends assumption</p></li>
</ol>
<ul>
<li>based on never-treated: treated units would have had parallel trends to never-treated if they would not have experienced treatment. In many empirical settings this is a strong assumption (why do some units never experience treatment?).</li>
<li>based on not-yet-treated: treated units would have had parallel trends to not-yet-treated if they would not have experienced treatment. This assumption might be a bit more likely to hold.</li>
</ul>
<ol start="3" type="1">
<li>No treatment anticipation</li>
</ol>
<ul>
<li>based on never-treated: We can relax the assumption by either back-dating the treatment or include the appropriate pre-treatment periods in our results to inspect anticipation qualitatively.</li>
<li>based on not-yet-treated: If there is treatment anticipation, our control group will be confounded by the treatment effect. A violation of the assumption can lead to stronger bias if we use the not-yet-treated as control group.</li>
</ul>
<p><strong>Trade-off</strong>: If assumption 2) is likely to hold, we can use only the never-treated as controls to relax assumption 3). If assumption 3) is likely to hold, we can include the not-yet-treated as control to relax assumption 2).</p>
</section>
<section id="example-2" class="level3">
<h3 class="anchored" data-anchor-id="example-2">Example</h3>
<p>How does that look in our marriage example? To estimate the dynamic DD we use the <code>did</code> package, as describes in more detail <a href="https://cran.r-project.org/web/packages/did/vignettes/did-basics.html">here</a> or in the authors <a href="https://pedrohcgs.github.io/posts/twfe">blog</a>.</p>
<p><strong>Note: This package works with staggered treatment adoption! We thus should perform all the steps we have performed above to restrict and prepare the data!</strong></p>
<p>As a first step, we need to define a variable that contains the treatment timing: the first year an ever-treated individual is treated.</p>
<p>This should be a positive number for all observations in treated groups. It defines which “group” a unit belongs to. It should be 0 for units in the untreated group.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># treatment timing = year if married</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>mwp<span class="sc">$</span>treat_timing <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(mwp<span class="sc">$</span>marry <span class="sc">==</span> <span class="dv">1</span>, mwp<span class="sc">$</span>year, <span class="cn">NA</span>)</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="co"># set never treated to zero</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>mwp<span class="sc">$</span>treat_timing[mwp<span class="sc">$</span>evermarry <span class="sc">==</span> <span class="dv">0</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a><span class="co"># if married is not NA, used min year per id (removing NAs)</span></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>mwp<span class="sc">$</span>treat_timing[<span class="sc">!</span><span class="fu">is.na</span>(mwp<span class="sc">$</span>marry)] <span class="ot">&lt;-</span> <span class="fu">ave</span>(mwp<span class="sc">$</span>treat_timing[<span class="sc">!</span><span class="fu">is.na</span>(mwp<span class="sc">$</span>marry)],</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>                                           mwp<span class="sc">$</span>id[<span class="sc">!</span><span class="fu">is.na</span>(mwp<span class="sc">$</span>marry)],</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">FUN =</span> <span class="cf">function</span>(x) <span class="fu">min</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(mwp[, <span class="fu">c</span>(<span class="st">"id"</span>, <span class="st">"year"</span>, <span class="st">"marry"</span>, <span class="st">"evermarry"</span>, <span class="st">"treat_timing"</span>)], <span class="at">n =</span> <span class="dv">35</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   id year marry evermarry treat_timing
1   1 1981     0         1         1988
2   1 1983     0         1         1988
3   1 1984     0         1         1988
4   1 1985     0         1         1988
5   1 1986     0         1         1988
6   1 1987     0         1         1988
7   1 1988     1         1         1988
8   1 1989     1         1         1988
9   1 1990     1         1         1988
10  1 1991     1         1         1988
11  1 1992     1         1         1988
12  2 1979     0         0            0
13  2 1981     0         0            0
14  2 1982     0         0            0
15  2 1983     0         0            0
16  2 1984     0         0            0
17  2 1985     0         0            0
18  2 1989     0         0            0
19  3 1979     0         0            0
20  3 1980     0         0            0
21  3 1981     0         0            0
22  3 1982     0         0            0
23  3 1983     0         0            0
24  3 1984     0         0            0
25  3 1985     0         0            0
26  3 1986     0         0            0
27  3 1987     0         0            0
28  3 1988     0         0            0
29  3 1989     0         0            0
30  3 1993     0         0            0
31  3 1994     0         0            0
32  3 2000     0         0            0
33  4 1979     0         1         1982
34  4 1981     0         1         1982
35  4 1982     1         1         1982</code></pre>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># estimate group-time average treatment effects using att_gt method</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>wages.attgt <span class="ot">&lt;-</span> <span class="fu">att_gt</span>(<span class="at">yname =</span> <span class="st">"lnw"</span>,</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>                      <span class="at">tname =</span> <span class="st">"year"</span>,</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>                      <span class="at">idname =</span> <span class="st">"id"</span>,</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>                      <span class="at">gname =</span> <span class="st">"treat_timing"</span>,</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>                      <span class="co">#xformla = ~ enrol + yeduc + exp + I(exp^2), # note that we omit the yeargroup here</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data =</span> mwp,</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>                      <span class="at">allow_unbalanced_panel =</span> <span class="cn">TRUE</span>,</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>                      <span class="at">control_group =</span> <span class="st">"notyettreated"</span>,</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>                      <span class="at">est_method =</span> <span class="st">"ipw"</span></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>                        )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in pre_process_did(yname = yname, tname = tname, idname = idname, : Be aware that there are some small groups in your dataset.
  Check groups: 1980,1982,1990,1994.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in compute.att_gt(dp): No units in group 1980 in time period 1996</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in compute.att_gt(dp): No units in group 1980 in time period 1998</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in compute.att_gt(dp): No units in group 1980 in time period 2000</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in compute.att_gt(dp): No units in group 1981 in time period 1996</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in compute.att_gt(dp): No units in group 1981 in time period 1998</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in compute.att_gt(dp): No units in group 1981 in time period 2000</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in compute.att_gt(dp): No units in group 1982 in time period 1994</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in compute.att_gt(dp): No units in group 1982 in time period 1996</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in compute.att_gt(dp): No units in group 1982 in time period 1998</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in compute.att_gt(dp): No units in group 1982 in time period 2000</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in compute.att_gt(dp): No units in group 1983 in time period 1998</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in compute.att_gt(dp): No units in group 1983 in time period 2000</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in compute.att_gt(dp): No units in group 1984 in time period 2000</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in compute.att_gt(dp): No units in group 1985 in time period 2000</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in compute.att_gt(dp): No units in group 1994 in time period 1979</code></pre>
</div>
</div>
<p>One huge advantage: We do not need to make a decision about which periods (before treatment) we want to include, and which observations go into the reference category.</p>
<p>However, we get a lot of individual treatment effects.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Show the group-time specific estimates</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(wages.attgt)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
att_gt(yname = "lnw", tname = "year", idname = "id", gname = "treat_timing", 
    data = mwp, allow_unbalanced_panel = TRUE, control_group = "notyettreated", 
    est_method = "ipw")

Reference: Callaway, Brantly and Pedro H.C. Sant'Anna.  "Difference-in-Differences with Multiple Time Periods." Journal of Econometrics, Vol. 225, No. 2, pp. 200-230, 2021. &lt;https://doi.org/10.1016/j.jeconom.2020.12.001&gt;, &lt;https://arxiv.org/abs/1803.09015&gt; 

Group-Time Average Treatment Effects:
 Group Time ATT(g,t) Std. Error [95% Simult.  Conf. Band]  
  1980 1980   0.0458     0.1705       -0.4971      0.5887  
  1980 1981   0.0231     0.2653       -0.8217      0.8678  
  1980 1982   0.1336     0.1469       -0.3339      0.6011  
  1980 1983  -0.0032     0.2943       -0.9403      0.9338  
  1980 1984   0.1506     0.1571       -0.3497      0.6509  
  1980 1985   0.1559     0.1595       -0.3519      0.6637  
  1980 1986   0.0510     0.1634       -0.4693      0.5713  
  1980 1987   0.0072     0.1556       -0.4883      0.5026  
  1980 1988  -0.0259     0.1654       -0.5526      0.5007  
  1980 1989  -0.0530     0.1956       -0.6757      0.5696  
  1980 1990  -0.0255     0.1635       -0.5460      0.4950  
  1980 1991   0.0051     0.1785       -0.5633      0.5734  
  1980 1992   0.0074     0.2541       -0.8015      0.8163  
  1980 1993   0.1456     0.1942       -0.4727      0.7639  
  1980 1994  -0.2120     0.2070       -0.8710      0.4471  
  1980 1996       NA         NA            NA          NA  
  1980 1998       NA         NA            NA          NA  
  1980 2000       NA         NA            NA          NA  
  1981 1980  -0.1289     0.1112       -0.4830      0.2252  
  1981 1981   0.0490     0.0865       -0.2264      0.3243  
  1981 1982   0.1016     0.1358       -0.3309      0.5340  
  1981 1983  -0.0413     0.1541       -0.5319      0.4494  
  1981 1984   0.0303     0.1689       -0.5075      0.5680  
  1981 1985  -0.0700     0.1418       -0.5214      0.3814  
  1981 1986  -0.1021     0.1415       -0.5527      0.3485  
  1981 1987  -0.0572     0.1661       -0.5862      0.4717  
  1981 1988  -0.0552     0.1686       -0.5918      0.4815  
  1981 1989  -0.1644     0.1452       -0.6266      0.2978  
  1981 1990  -0.1310     0.1256       -0.5309      0.2688  
  1981 1991  -0.2290     0.1891       -0.8311      0.3730  
  1981 1992  -0.0732     0.1616       -0.5878      0.4414  
  1981 1993   0.0749     0.1653       -0.4514      0.6011  
  1981 1994  -0.1662     0.1789       -0.7357      0.4034  
  1981 1996       NA         NA            NA          NA  
  1981 1998       NA         NA            NA          NA  
  1981 2000       NA         NA            NA          NA  
  1982 1980  -0.1950     0.1742       -0.7497      0.3597  
  1982 1981   0.2637     0.1901       -0.3416      0.8689  
  1982 1982   0.1626     0.3080       -0.8179      1.1432  
  1982 1983   0.1908     0.3872       -1.0420      1.4236  
  1982 1984   0.0543     0.3287       -0.9921      1.1007  
  1982 1985   0.3166     0.3390       -0.7626      1.3957  
  1982 1986  -0.0989     0.2082       -0.7616      0.5638  
  1982 1987   0.0248     0.2058       -0.6303      0.6800  
  1982 1988   0.0292     0.2042       -0.6210      0.6794  
  1982 1989   0.1573     0.2028       -0.4885      0.8030  
  1982 1990  -0.0694     0.2141       -0.7509      0.6121  
  1982 1991   0.0606     0.2134       -0.6186      0.7399  
  1982 1992   0.1227     0.2269       -0.5996      0.8451  
  1982 1993   0.0560     0.2336       -0.6877      0.7998  
  1982 1994       NA         NA            NA          NA  
  1982 1996       NA         NA            NA          NA  
  1982 1998       NA         NA            NA          NA  
  1982 2000       NA         NA            NA          NA  
  1983 1980   0.1212     0.0920       -0.1717      0.4141  
  1983 1981  -0.0378     0.0745       -0.2750      0.1995  
  1983 1982   0.1181     0.0790       -0.1335      0.3696  
  1983 1983  -0.0772     0.0880       -0.3574      0.2030  
  1983 1984  -0.0860     0.0901       -0.3730      0.2010  
  1983 1985  -0.0279     0.1055       -0.3637      0.3079  
  1983 1986  -0.0125     0.1273       -0.4178      0.3928  
  1983 1987  -0.0215     0.1820       -0.6008      0.5577  
  1983 1988  -0.1636     0.1643       -0.6868      0.3596  
  1983 1989  -0.1976     0.1554       -0.6922      0.2970  
  1983 1990  -0.2338     0.1530       -0.7208      0.2532  
  1983 1991  -0.1548     0.1669       -0.6861      0.3765  
  1983 1992  -0.1332     0.1838       -0.7185      0.4520  
  1983 1993  -0.0297     0.2373       -0.7852      0.7258  
  1983 1994   0.0511     0.3258       -0.9860      1.0882  
  1983 1996   0.0934     0.2863       -0.8180      1.0048  
  1983 1998       NA         NA            NA          NA  
  1983 2000       NA         NA            NA          NA  
  1984 1980   0.1525     0.0583       -0.0330      0.3379  
  1984 1981  -0.2389     0.2153       -0.9243      0.4464  
  1984 1982   0.4429     0.2138       -0.2379      1.1237  
  1984 1983  -0.1672     0.1165       -0.5381      0.2036  
  1984 1984  -0.2668     0.3667       -1.4342      0.9007  
  1984 1985   0.1108     0.1124       -0.2470      0.4686  
  1984 1986   0.1001     0.1483       -0.3720      0.5722  
  1984 1987  -0.0674     0.2902       -0.9913      0.8565  
  1984 1988   0.1631     0.2376       -0.5934      0.9195  
  1984 1989   0.1929     0.1219       -0.1952      0.5811  
  1984 1990   0.1890     0.1841       -0.3972      0.7751  
  1984 1991   0.2210     0.1222       -0.1680      0.6100  
  1984 1992   0.3217     0.1417       -0.1294      0.7729  
  1984 1993   0.1625     0.1620       -0.3533      0.6783  
  1984 1994   0.3103     0.2299       -0.4216      1.0422  
  1984 1996   0.3587     0.1999       -0.2776      0.9950  
  1984 1998   0.3045     0.2195       -0.3943      1.0033  
  1984 2000       NA         NA            NA          NA  
  1985 1980   0.1140     0.1417       -0.3370      0.5650  
  1985 1981  -0.0779     0.1356       -0.5097      0.3539  
  1985 1982   0.0244     0.1154       -0.3430      0.3919  
  1985 1983   0.0026     0.0758       -0.2388      0.2439  
  1985 1984  -0.0224     0.0743       -0.2590      0.2143  
  1985 1985  -0.0594     0.0595       -0.2488      0.1301  
  1985 1986   0.0003     0.0913       -0.2904      0.2910  
  1985 1987   0.0666     0.1084       -0.2784      0.4115  
  1985 1988   0.1122     0.1246       -0.2844      0.5087  
  1985 1989   0.1080     0.1463       -0.3576      0.5737  
  1985 1990   0.0859     0.1704       -0.4565      0.6283  
  1985 1991   0.0433     0.1862       -0.5493      0.6360  
  1985 1992   0.2087     0.2158       -0.4783      0.8957  
  1985 1993   0.3690     0.2160       -0.3186      1.0565  
  1985 1994   0.3064     0.2410       -0.4609      1.0737  
  1985 1996   0.0689     0.2365       -0.6841      0.8219  
  1985 1998   0.2565     0.3145       -0.7447      1.2577  
  1985 2000       NA         NA            NA          NA  
  1986 1980  -0.0355     0.1974       -0.6638      0.5929  
  1986 1981   0.1164     0.1815       -0.4615      0.6942  
  1986 1982  -0.0427     0.1611       -0.5555      0.4700  
  1986 1983  -0.1012     0.1213       -0.4875      0.2851  
  1986 1984   0.0884     0.1604       -0.4222      0.5990  
  1986 1985   0.0113     0.0854       -0.2607      0.2832  
  1986 1986  -0.2075     0.0845       -0.4764      0.0615  
  1986 1987  -0.0586     0.1031       -0.3867      0.2695  
  1986 1988  -0.0168     0.1322       -0.4377      0.4040  
  1986 1989  -0.3852     0.1567       -0.8842      0.1138  
  1986 1990  -0.1849     0.1459       -0.6495      0.2797  
  1986 1991  -0.2494     0.1398       -0.6944      0.1956  
  1986 1992  -0.1631     0.1629       -0.6817      0.3555  
  1986 1993  -0.3148     0.1901       -0.9201      0.2904  
  1986 1994  -0.1290     0.2529       -0.9341      0.6761  
  1986 1996  -0.3379     0.4452       -1.7551      1.0793  
  1986 1998  -0.4934     0.5864       -2.3603      1.3735  
  1986 2000   0.1782     0.2622       -0.6563      1.0128  
  1987 1980  -0.0870     0.1167       -0.4584      0.2844  
  1987 1981  -0.1077     0.1387       -0.5491      0.3337  
  1987 1982  -0.2367     0.1317       -0.6560      0.1825  
  1987 1983  -0.0504     0.1163       -0.4206      0.3198  
  1987 1984   0.0422     0.1720       -0.5053      0.5896  
  1987 1985   0.3759     0.1382       -0.0640      0.8158  
  1987 1986  -0.0060     0.0998       -0.3237      0.3116  
  1987 1987  -0.0954     0.1434       -0.5518      0.3610  
  1987 1988  -0.1029     0.1158       -0.4716      0.2657  
  1987 1989  -0.1012     0.1108       -0.4540      0.2516  
  1987 1990  -0.0826     0.1132       -0.4431      0.2778  
  1987 1991   0.0224     0.0936       -0.2756      0.3204  
  1987 1992   0.0868     0.1223       -0.3024      0.4761  
  1987 1993   0.0554     0.1344       -0.3725      0.4832  
  1987 1994   0.0322     0.1556       -0.4630      0.5274  
  1987 1996   0.0578     0.1350       -0.3721      0.4877  
  1987 1998   0.1176     0.1753       -0.4405      0.6757  
  1987 2000  -0.0506     0.1945       -0.6696      0.5685  
  1988 1980   0.1629     0.2484       -0.6281      0.9538  
  1988 1981   0.1777     0.1354       -0.2533      0.6086  
  1988 1982   0.0052     0.1561       -0.4918      0.5022  
  1988 1983   0.0105     0.1412       -0.4390      0.4600  
  1988 1984  -0.0048     0.1142       -0.3685      0.3588  
  1988 1985   0.1437     0.0884       -0.1377      0.4251  
  1988 1986  -0.2029     0.1301       -0.6171      0.2112  
  1988 1987  -0.0009     0.0834       -0.2663      0.2645  
  1988 1988   0.1335     0.0703       -0.0904      0.3573  
  1988 1989   0.3157     0.1162       -0.0542      0.6856  
  1988 1990   0.3005     0.1018       -0.0237      0.6247  
  1988 1991   0.3596     0.1092        0.0120      0.7073 *
  1988 1992   0.2546     0.1168       -0.1171      0.6264  
  1988 1993   0.3282     0.1285       -0.0807      0.7372  
  1988 1994   0.3124     0.1705       -0.2305      0.8553  
  1988 1996   0.3425     0.1370       -0.0936      0.7787  
  1988 1998   0.1312     0.2610       -0.6997      0.9621  
  1988 2000   0.1996     0.1583       -0.3043      0.7034  
  1989 1980   0.0841     0.1737       -0.4688      0.6370  
  1989 1981  -0.1884     0.2518       -0.9901      0.6134  
  1989 1982   0.2056     0.2435       -0.5695      0.9807  
  1989 1983   0.0025     0.3195       -1.0148      1.0198  
  1989 1984   0.0223     0.0896       -0.2628      0.3075  
  1989 1985  -0.2832     0.2260       -1.0028      0.4364  
  1989 1986   0.0454     0.2726       -0.8224      0.9132  
  1989 1987  -0.0350     0.1588       -0.5406      0.4705  
  1989 1988   0.0708     0.0897       -0.2148      0.3564  
  1989 1989   0.0486     0.1088       -0.2976      0.3949  
  1989 1990   0.0521     0.1234       -0.3409      0.4451  
  1989 1991   0.0720     0.1636       -0.4487      0.5928  
  1989 1992   0.2708     0.2808       -0.6232      1.1648  
  1989 1993   0.0143     0.2104       -0.6557      0.6842  
  1989 1994   0.1855     0.3078       -0.7944      1.1655  
  1989 1996   0.2842     0.4274       -1.0765      1.6449  
  1989 1998   0.3437     0.3158       -0.6618      1.3492  
  1989 2000   0.0745     0.4148       -1.2461      1.3950  
  1990 1980   0.0271     0.3437       -1.0670      1.1213  
  1990 1981  -0.0903     0.1382       -0.5302      0.3496  
  1990 1982  -0.3019     0.2640       -1.1423      0.5384  
  1990 1983   0.2384     0.2058       -0.4168      0.8936  
  1990 1984   0.4904     0.2609       -0.3400      1.3208  
  1990 1985  -0.5329     0.2190       -1.2301      0.1643  
  1990 1986  -0.1602     0.2090       -0.8255      0.5051  
  1990 1987  -0.0241     0.1236       -0.4175      0.3694  
  1990 1988   0.0585     0.3800       -1.1514      1.2684  
  1990 1989   0.0291     0.3101       -0.9583      1.0164  
  1990 1990   0.0951     0.2418       -0.6748      0.8650  
  1990 1991   0.0717     0.4218       -1.2711      1.4145  
  1990 1992   0.2766     0.2484       -0.5142      1.0673  
  1990 1993   0.3321     0.4031       -0.9511      1.6154  
  1990 1994   0.2388     0.4051       -1.0508      1.5283  
  1990 1996   0.2235     0.3680       -0.9482      1.3952  
  1990 1998   0.2999     0.3549       -0.8301      1.4299  
  1990 2000   0.0711     0.3727       -1.1153      1.2575  
  1991 1980   0.0674     0.3106       -0.9213      1.0561  
  1991 1981   0.1846     0.1249       -0.2131      0.5823  
  1991 1982  -0.3465     0.2610       -1.1774      0.4844  
  1991 1983   0.1857     0.2057       -0.4690      0.8405  
  1991 1984  -0.3355     0.1494       -0.8111      0.1402  
  1991 1985   0.2739     0.2337       -0.4700      1.0179  
  1991 1986   0.0838     0.1681       -0.4515      0.6191  
  1991 1987   0.0179     0.1677       -0.5160      0.5518  
  1991 1988   0.0641     0.1637       -0.4569      0.5851  
  1991 1989  -0.1817     0.1710       -0.7259      0.3626  
  1991 1990   0.2377     0.1234       -0.1552      0.6305  
  1991 1991  -0.0155     0.1047       -0.3486      0.3177  
  1991 1992  -0.0115     0.1382       -0.4514      0.4283  
  1991 1993   0.0052     0.1477       -0.4651      0.4755  
  1991 1994  -0.1098     0.1839       -0.6953      0.4757  
  1991 1996  -0.2591     0.1676       -0.7926      0.2743  
  1991 1998  -0.1275     0.1660       -0.6560      0.4010  
  1991 2000  -0.2352     0.2376       -0.9916      0.5212  
  1992 1980   0.0273     0.2203       -0.6739      0.7285  
  1992 1981  -0.0104     0.2124       -0.6866      0.6659  
  1992 1982   0.1930     0.1387       -0.2485      0.6345  
  1992 1983  -0.0356     0.1416       -0.4866      0.4153  
  1992 1984  -0.1464     0.0981       -0.4588      0.1659  
  1992 1985   0.0910     0.1839       -0.4944      0.6764  
  1992 1986  -0.0967     0.1781       -0.6639      0.4704  
  1992 1987  -0.0081     0.2520       -0.8102      0.7941  
  1992 1988   0.0831     0.1355       -0.3481      0.5144  
  1992 1989  -0.0646     0.0908       -0.3537      0.2245  
  1992 1990   0.1328     0.0866       -0.1428      0.4083  
  1992 1991   0.0683     0.1305       -0.3472      0.4838  
  1992 1992   0.1507     0.1096       -0.1982      0.4996  
  1992 1993  -0.0434     0.1233       -0.4358      0.3491  
  1992 1994  -0.0208     0.1503       -0.4994      0.4578  
  1992 1996  -0.0925     0.1771       -0.6563      0.4712  
  1992 1998  -0.1061     0.2151       -0.7907      0.5786  
  1992 2000  -0.1084     0.1805       -0.6831      0.4663  
  1993 1980   0.0885     0.1361       -0.3449      0.5219  
  1993 1981  -0.1510     0.0472       -0.3012     -0.0008 *
  1993 1982  -0.2665     0.2145       -0.9492      0.4163  
  1993 1983   0.5454     0.2727       -0.3226      1.4134  
  1993 1984  -0.2586     0.1323       -0.6798      0.1626  
  1993 1985   0.3506     0.2189       -0.3463      1.0474  
  1993 1986   0.1320     0.3301       -0.9190      1.1829  
  1993 1987  -0.0727     0.2749       -0.9478      0.8025  
  1993 1988  -0.0676     0.0863       -0.3425      0.2072  
  1993 1989   0.0641     0.0934       -0.2331      0.3614  
  1993 1990  -0.0863     0.0767       -0.3304      0.1577  
  1993 1991  -0.0007     0.0879       -0.2807      0.2793  
  1993 1992  -0.0081     0.1517       -0.4911      0.4749  
  1993 1993  -0.1149     0.1441       -0.5736      0.3437  
  1993 1994  -0.1264     0.1838       -0.7114      0.4587  
  1993 1996   0.0338     0.1675       -0.4995      0.5672  
  1993 1998  -0.0599     0.1892       -0.6622      0.5425  
  1993 2000  -0.2164     0.2332       -0.9587      0.5259  
  1994 1980       NA         NA            NA          NA  
  1994 1981   0.2721     0.0737        0.0375      0.5066 *
  1994 1982  -0.2316     0.0981       -0.5438      0.0807  
  1994 1983   0.2402     0.1582       -0.2636      0.7440  
  1994 1984  -0.4270     0.0517       -0.5916     -0.2624 *
  1994 1985  -0.1525     0.1673       -0.6851      0.3801  
  1994 1986   0.4009     0.2116       -0.2729      1.0747  
  1994 1987   0.2158     0.3557       -0.9167      1.3483  
  1994 1988   0.1474     0.1169       -0.2247      0.5195  
  1994 1989   0.0033     0.0865       -0.2722      0.2788  
  1994 1990  -0.0831     0.0559       -0.2611      0.0950  
  1994 1991   0.0904     0.0580       -0.0943      0.2752  
  1994 1992   0.3169     0.1337       -0.1086      0.7425  
  1994 1993  -0.1169     0.0872       -0.3946      0.1607  
  1994 1994  -0.1990     0.1631       -0.7182      0.3202  
  1994 1996  -0.0386     0.1395       -0.4826      0.4055  
  1994 1998  -0.1785     0.2628       -1.0151      0.6581  
  1994 2000  -0.5138     0.3777       -1.7163      0.6887  
  1996 1980  -0.5476     0.2587       -1.3712      0.2759  
  1996 1981   0.2139     0.1906       -0.3930      0.8207  
  1996 1982   0.0462     0.1638       -0.4752      0.5676  
  1996 1983  -0.3550     0.2068       -1.0132      0.3032  
  1996 1984   0.1749     0.1190       -0.2039      0.5538  
  1996 1985  -0.1094     0.2320       -0.8480      0.6293  
  1996 1986  -0.0334     0.2722       -0.8998      0.8330  
  1996 1987   0.4432     0.3143       -0.5574      1.4438  
  1996 1988  -0.5265     0.3467       -1.6302      0.5773  
  1996 1989   0.3380     0.2378       -0.4191      1.0951  
  1996 1990  -0.0997     0.0825       -0.3623      0.1629  
  1996 1991  -0.0993     0.1375       -0.5370      0.3385  
  1996 1992  -0.0424     0.1843       -0.6292      0.5444  
  1996 1993   0.2969     0.3830       -0.9224      1.5162  
  1996 1994  -0.1758     0.3971       -1.4399      1.0883  
  1996 1996   0.3742     0.2594       -0.4516      1.2001  
  1996 1998   0.1061     0.2186       -0.5899      0.8021  
  1996 2000   0.0994     0.2772       -0.7831      0.9820  
  1998 1980  -0.3484     0.1193       -0.7283      0.0314  
  1998 1981   0.2643     0.1095       -0.0844      0.6130  
  1998 1982   0.1757     0.1717       -0.3710      0.7225  
  1998 1983  -0.1331     0.2186       -0.8289      0.5627  
  1998 1984  -0.0396     0.1387       -0.4812      0.4020  
  1998 1985  -0.2229     0.0932       -0.5197      0.0739  
  1998 1986   0.4393     0.1536       -0.0497      0.9282  
  1998 1987  -0.1735     0.1332       -0.5975      0.2504  
  1998 1988   0.2486     0.0874       -0.0298      0.5270  
  1998 1989  -0.1116     0.3912       -1.3571      1.1339  
  1998 1990  -0.1982     0.3725       -1.3839      0.9876  
  1998 1991   0.1722     0.1384       -0.2685      0.6129  
  1998 1992   0.0115     0.1171       -0.3613      0.3842  
  1998 1993  -0.0237     0.1197       -0.4047      0.3573  
  1998 1994   0.2398     0.3376       -0.8351      1.3147  
  1998 1996  -0.3608     0.3304       -1.4128      0.6912  
  1998 1998  -0.0142     0.1609       -0.5265      0.4981  
  1998 2000   0.1968     0.3466       -0.9066      1.3003  
---
Signif. codes: `*' confidence band does not cover 0

P-value for pre-test of parallel trends assumption:  0
Control Group:  Not Yet Treated,  Anticipation Periods:  0
Estimation Method:  Inverse Probability Weighting</code></pre>
</div>
</div>
<p>These individual effects are similar to running a lot of individual regressions, where we compute a lot of individual <span class="math inline">\(2 \times 2\)</span> DD estimators, e.g.&nbsp;for group 1981:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>t <span class="ot">&lt;-</span> <span class="dv">1981</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a><span class="co"># run individual effects</span></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="fu">sort</span>(<span class="fu">unique</span>(mwp<span class="sc">$</span>year))[<span class="sc">-</span><span class="dv">1</span>]){</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># not yet treated</span></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>  mwp<span class="sc">$</span>notyettreated <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(mwp<span class="sc">$</span>treat_timing <span class="sc">&gt;</span> t <span class="sc">&amp;</span> mwp<span class="sc">$</span>treat_timing <span class="sc">&gt;</span> i, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># select 1980 group, never-treated and not yet treated</span></span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>  oo <span class="ot">&lt;-</span> <span class="fu">which</span>(mwp<span class="sc">$</span>treat_timing <span class="sc">==</span> t <span class="sc">|</span> mwp<span class="sc">$</span>treat_timing <span class="sc">==</span> <span class="dv">0</span> <span class="sc">|</span> mwp<span class="sc">$</span>notyettreated <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> mwp[oo, ]</span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># after set to 1 for year rolling year i</span></span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>after <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb62-15"><a href="#cb62-15" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>after[df<span class="sc">$</span>year <span class="sc">==</span> i] <span class="ot">&lt;-</span> <span class="dv">1</span> </span>
<span id="cb62-16"><a href="#cb62-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb62-17"><a href="#cb62-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># control year</span></span>
<span id="cb62-18"><a href="#cb62-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(i <span class="sc">&lt;</span> t){</span>
<span id="cb62-19"><a href="#cb62-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># if i is still before actual treatment, compare to previous year</span></span>
<span id="cb62-20"><a href="#cb62-20" aria-hidden="true" tabindex="-1"></a>    tc <span class="ot">&lt;-</span> i <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb62-21"><a href="#cb62-21" aria-hidden="true" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb62-22"><a href="#cb62-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># if i is beyond actual treatment, compare to year before actual treatment (t-1)</span></span>
<span id="cb62-23"><a href="#cb62-23" aria-hidden="true" tabindex="-1"></a>    tc <span class="ot">&lt;-</span> t <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb62-24"><a href="#cb62-24" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb62-25"><a href="#cb62-25" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>after[df<span class="sc">$</span>year <span class="sc">==</span> tc] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb62-26"><a href="#cb62-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb62-27"><a href="#cb62-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Restrict to the two years we want to compare</span></span>
<span id="cb62-28"><a href="#cb62-28" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> df[<span class="sc">!</span><span class="fu">is.na</span>(df<span class="sc">$</span>after), ]</span>
<span id="cb62-29"><a href="#cb62-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb62-30"><a href="#cb62-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define treated group</span></span>
<span id="cb62-31"><a href="#cb62-31" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>treat <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(df<span class="sc">$</span>treat_timing <span class="sc">==</span> t, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb62-32"><a href="#cb62-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb62-33"><a href="#cb62-33" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Estiamte 2x2 DD</span></span>
<span id="cb62-34"><a href="#cb62-34" aria-hidden="true" tabindex="-1"></a>  tmp.lm <span class="ot">&lt;-</span> <span class="fu">lm</span>(lnw <span class="sc">~</span> treat<span class="sc">*</span>after, <span class="at">data =</span> df)</span>
<span id="cb62-35"><a href="#cb62-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb62-36"><a href="#cb62-36" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Print</span></span>
<span id="cb62-37"><a href="#cb62-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">paste0</span>(i, <span class="st">": "</span>, <span class="fu">round</span>(tmp.lm<span class="sc">$</span>coefficients[<span class="dv">4</span>], <span class="dv">4</span>)))</span>
<span id="cb62-38"><a href="#cb62-38" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "1980: -0.1289"
[1] "1981: 0.049"
[1] "1982: 0.1016"
[1] "1983: -0.0413"
[1] "1984: 0.0303"
[1] "1985: -0.07"
[1] "1986: -0.1021"
[1] "1987: -0.0572"
[1] "1988: -0.0552"
[1] "1989: -0.1644"
[1] "1990: -0.131"
[1] "1991: -0.229"
[1] "1992: -0.0732"
[1] "1993: 0.0749"
[1] "1994: -0.1662"
[1] "1996: NA"
[1] "1998: NA"
[1] "2000: NA"</code></pre>
</div>
</div>
<p>To make this more interpretable, we re-aggregate the individuals results to a dynamic time-averaged effect (we now restrict this to observations from -3 to 6).</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>wages.dyn <span class="ot">&lt;-</span> <span class="fu">aggte</span>(wages.attgt, <span class="at">type =</span> <span class="st">"dynamic"</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>,</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>                   <span class="at">min_e =</span> <span class="sc">-</span><span class="dv">3</span>, <span class="at">max_e =</span> <span class="dv">6</span>)</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(wages.dyn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
aggte(MP = wages.attgt, type = "dynamic", min_e = -3, max_e = 6, 
    na.rm = TRUE)

Reference: Callaway, Brantly and Pedro H.C. Sant'Anna.  "Difference-in-Differences with Multiple Time Periods." Journal of Econometrics, Vol. 225, No. 2, pp. 200-230, 2021. &lt;https://doi.org/10.1016/j.jeconom.2020.12.001&gt;, &lt;https://arxiv.org/abs/1803.09015&gt; 


Overall summary of ATT's based on event-study/dynamic aggregation:  
    ATT    Std. Error     [ 95%  Conf. Int.] 
 0.0458        0.0418    -0.0362      0.1277 


Dynamic Effects:
 Event time Estimate Std. Error [95% Simult.  Conf. Band] 
         -3   0.0400     0.0460       -0.0792      0.1592 
         -2   0.0172     0.0468       -0.1040      0.1383 
         -1   0.0186     0.0300       -0.0590      0.0961 
          0  -0.0039     0.0330       -0.0892      0.0815 
          1   0.0352     0.0452       -0.0818      0.1522 
          2   0.0705     0.0416       -0.0372      0.1782 
          3   0.0710     0.0538       -0.0684      0.2104 
          4   0.0584     0.0576       -0.0907      0.2074 
          5   0.0508     0.0633       -0.1130      0.2146 
          6   0.0384     0.0736       -0.1522      0.2290 
---
Signif. codes: `*' confidence band does not cover 0

Control Group:  Not Yet Treated,  Anticipation Periods:  0
Estimation Method:  Inverse Probability Weighting</code></pre>
</div>
</div>
<p>The <code>did</code> package also comes with a handy command <code>ggdid()</code> to plot the results</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>zp3 <span class="ot">&lt;-</span> <span class="fu">ggdid</span>(wages.dyn) </span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>zp3 <span class="ot">&lt;-</span> zp3 <span class="sc">+</span> </span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">colour =</span> <span class="fu">gray</span>(<span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>), <span class="at">lty =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="sc">-</span><span class="fl">0.5</span>, <span class="at">colour =</span> <span class="st">"black"</span>, <span class="at">lty =</span> <span class="dv">1</span>)</span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>zp3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Panel_part2_files/figure-html/unnamed-chunk-25-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Although it is definitely not the same, this doesn’t look too different from our earlier FEIS results.</p>
</section>
</section>
<section id="synthetic-control" class="level1">
<h1>Synthetic Control</h1>
<p>So far, we have considered quantitative examples with multiple treated and multiple non-treated units, and we have applied “bruteforce” approaches to identify causal effects.</p>
<p>However, sometimes we face the situation of a single treated unit. This is especially common in comparative case studies. For instance, a single country or region has implemented a specific policy or experienced a specific shock. For instance, we might be interested in how a terrorist attack might influence the economic development of a region <span class="citation" data-cites="Abadie.2003">(<a href="#ref-Abadie.2003" role="doc-biblioref">Abadie and Gardeazabal 2003</a>)</span>.</p>
<p>The synthetic control estimator <span class="citation" data-cites="Abadie.2003 Abadie.2010 Abadie.2021">(<a href="#ref-Abadie.2003" role="doc-biblioref">Abadie and Gardeazabal 2003</a>; <a href="#ref-Abadie.2010" role="doc-biblioref">Abadie, Diamond, and Hainmueller 2010</a>; <a href="#ref-Abadie.2021" role="doc-biblioref">Abadie 2021</a>)</span> has become a very popular way of dealing with situation with a single treated unit.</p>
<p><strong>The general idea: we use the control units to construct an average “synthetic control” unit in a way that the outcome trajectory of the synthetic control unit closely matches the outcome trajectory of the treated unit.</strong> Find weights to construct a “synthetic control” unit (by reweighing non-treated units) that optimally estimates a counterfactual trajectory for the treated unit.</p>
<p>With covariates, the method first calculates the importance of several covariates for the outcome and subsequently computes weights, which minimizes the difference between the treatment and control groups in the importance-weighted covariates.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="fig/abadie.jpg" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Left: treated (California) unit and unweighted average of all other states. Right: treated (California) unit and synthetic control group <span class="citation" data-cites="Abadie.2010">(<a href="#ref-Abadie.2010" role="doc-biblioref">Abadie, Diamond, and Hainmueller 2010</a>)</span></figcaption>
</figure>
</div>
<p><strong>Note that we have to assume that the control units are not affected by the treatment (no spillovers) and that the treatment has no effect on the outcome before the treatment period (no anticipation).</strong></p>
<p>If there are reasons to believe that there potential anticipation effects (often the case), one can back-date the treatment, i.e.&nbsp;we set the treatment timing to the first period where there might possibly be an effect on the outcome.</p>
<p>Formally, the (time-specific) treatment effect is estimated as the difference between the outcome of the treated unit and the average re-weighted control units <span class="citation" data-cites="Abadie.2003 Abadie.2010">Abadie, Diamond, and Hainmueller (<a href="#ref-Abadie.2011" role="doc-biblioref">2011</a>)</span>: <span class="math display">\[
\hat{\delta}_{1t} = Y_{1t} - \sum_{j=2}^{J+1}w_j^*Y_{jt},
\]</span> where <span class="math inline">\(i=1\)</span> is the treated unit and <span class="math inline">\(j\neq i\)</span> are all potential control units (donor pool).</p>
<p><span class="math inline">\(w_j^*\)</span> are the optimally chosen (non-negative) weights for each control unit, where we impose two restrictions: a) the weights are non-negative <span class="math inline">\(w_j \geq 0\)</span> for <span class="math inline">\(j=2,\dots, J+1\)</span>, and the weights sum to one <span class="math inline">\(\sum_{j=2}^{J+1}w_j = 1\)</span>.</p>
<p>This leaves us with the task to find the optimally chosen weights. So assume we have <span class="math inline">\(k = 1,\dots,K\)</span> covariates <span class="math inline">\(\boldsymbol{\mathbf{X}}\)</span>, where <span class="math inline">\(x_{1k}\)</span> is the <span class="math inline">\(k\)</span>-th covariate of the treated unit, and <span class="math inline">\(\boldsymbol{\mathbf{x}}_{0k}\)</span> a <span class="math inline">\(1 \times J\)</span> vector of the same covariate for the control units / donor pool. Then we choose <span class="math inline">\(W^*\)</span> as the value that minimizes <span class="math display">\[
\sum_{k=1}^K v_k(x_{1k} - x_{0k}W)^2,
\]</span> with <span class="math inline">\(v_k\)</span> reflecting the relative importance of the covariate <span class="math inline">\(k\)</span>. As we want the outcome trajectories of the treated unit and synthetic control to closely match, <span class="math inline">\(v_1,\dots,v_K\)</span> is usually determined by the predictive power of the respective covariate.</p>
<p>The original authors <span class="citation" data-cites="Abadie.2003 Abadie.2010">Abadie, Diamond, and Hainmueller (<a href="#ref-Abadie.2011" role="doc-biblioref">2011</a>)</span> use a data driven approach to choose <span class="math inline">\(V^*\)</span> by minimizing the mean squared prediction error (MSPE) of the outcome over the pre-treatment periods <span class="math inline">\(t=1,\dots,T_0\)</span>. Formally, we choose <span class="math inline">\(V^*\)</span> that minimizes: <span class="math display">\[
\sum_{t=1}^{T_0}\Big( Y_{1t} - \sum_{j=2}^{J+1}w_j^*(V)Y_{jt}\Big)
\]</span></p>
<p>Note: with increasing pre-intervention periods (<span class="math inline">\(T_0\)</span>), we can assume that the synthetic control also accounts for unobserved factors affecting <span class="math inline">\(Y\)</span> <span class="citation" data-cites="Abadie.2010">(<a href="#ref-Abadie.2010" role="doc-biblioref">Abadie, Diamond, and Hainmueller 2010</a>)</span>, assuming that only units with similar unobservables exhibit a similar outcome trajectory.</p>
<p>However, with increasing pre-intervention periods, it is important to check if the outcome trajectories match well not only at far temporal distances to the treatment but also in periods closely before the treatment.</p>
<p>A <strong>critical assumption</strong> is that the outcome trajectory (and other covariates) of the treated unit falls into the “convex hull” of the donor pool’s outcome trajectories. Intuitively: we construct the synthetic control by giving each control unit a weight of <span class="math inline">\(\geq 0\)</span> (we only interpolate, but do not extrapolate). Thus, there must be sufficient control units with “higher” and “lower” values in the outcome for pre-intervention periods. If the treated unit is an outlier before the intervention, Synthetic Control does not make much sense.</p>
<section id="statistical-inference-with-synthetic-control" class="level3">
<h3 class="anchored" data-anchor-id="statistical-inference-with-synthetic-control">Statistical inference with synthetic control</h3>
<p>Calculating uncertainty estimates for Synthetic Control methods is an ongoing methodological challenge. Recent work, for instance, suggest to quantify uncertainty based on permutation inference procedures <span class="citation" data-cites="Chernozhukov.2021b">(<a href="#ref-Chernozhukov.2021b" role="doc-biblioref">Chernozhukov, Kasahara, and Schrimpf 2021</a>)</span> or on conditional prediction intervals <span class="citation" data-cites="Cattaneo.2021">(<a href="#ref-Cattaneo.2021" role="doc-biblioref">Cattaneo, Feng, and Titiunik 2021</a>)</span>. In practice, however, both methods are difficult to implement with standard software (especially with covariate matching).</p>
<p><strong>Placebo tests</strong></p>
<p><span class="citation" data-cites="Abadie.2003">Abadie and Gardeazabal (<a href="#ref-Abadie.2003" role="doc-biblioref">2003</a>)</span> and <span class="citation" data-cites="Abadie.2010">Abadie, Diamond, and Hainmueller (<a href="#ref-Abadie.2010" role="doc-biblioref">2010</a>)</span> propose a more qualitative approach to asses the significance of the findings: <strong>placebo tests</strong>. The idea is that we randomly assign the treatment to a control unit and perform the Synthetic Control method with this placebo treatment unit, and we repeat this exercise with every control unit.</p>
<p>Basically, we test what treatment effect we find if we assign treatment status to a unit that actually did not receive the treatment, thereby giving us a distribution of “treatment effects” for non-treated contries. We can then compare these placebo results to our actual treatment effect.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="fig/abadie_placebo.jpg" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Placebo test for Synthetic Control <span class="citation" data-cites="Abadie.2010">(<a href="#ref-Abadie.2010" role="doc-biblioref">Abadie, Diamond, and Hainmueller 2010</a>)</span></figcaption>
</figure>
</div>
<p>To increase the comparability of the actual treatment unit and placebo treatment units, propose to exclude those units which have a poor pre-treatment fit (left panel above) by dropping those with a mean square prediction error above a specific threshold (right panel above).</p>
<p>If the actual treatment effect lies at the extremes of the distribution of the placebo “treatment” units, we can say that the treatment likely had a significant effect on the outcome. If, in contrast, the actual treatment effect lies in the middle of the placebo effects for those not receiving the treatment, this indicates that the treatment did not have a significant influence.</p>
</section>
<section id="example-3" class="level3">
<h3 class="anchored" data-anchor-id="example-3">Example</h3>
<p>Can we use our marriage wage premium example and the respective data to perform a Synthetic Control analysis? Why (not)?</p>
<p>In R, we can use the package <code>Synth</code> to produce Synthetic Control estimates. For a demonstration using Stata by Jens Hainmueller see the following <a href="https://web.stanford.edu/~jhain/Video/SynthDemo.mp4">video</a>.</p>
<p>Here, we use the example of <span class="citation" data-cites="Abadie.2003">Abadie and Gardeazabal (<a href="#ref-Abadie.2003" role="doc-biblioref">2003</a>)</span>, analyzing the influence of the terrorist conflict in Basque on economic outcomes.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Synth)</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a><span class="co"># devtools::install_github("bcastanho/SCtools")</span></span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(SCtools)</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">"basque"</span>)</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>basque <span class="ot">&lt;-</span> basque[<span class="sc">-</span><span class="fu">which</span>(basque<span class="sc">$</span>regionno <span class="sc">==</span> <span class="dv">1</span>), ]</span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(basque[basque<span class="sc">$</span>year <span class="sc">&gt;</span> <span class="dv">1963</span>, ])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   regionno regionname year   gdpcap sec.agriculture sec.energy sec.industry
53        2  Andalucia 1964 2.508855              NA         NA           NA
54        2  Andalucia 1965 2.584690           24.52       2.65        18.18
55        2  Andalucia 1966 2.694444              NA         NA           NA
56        2  Andalucia 1967 2.802342           21.87       2.65        18.22
57        2  Andalucia 1968 2.987361              NA         NA           NA
58        2  Andalucia 1969 3.179092           19.73       3.24        18.43
   sec.construction sec.services.venta sec.services.nonventa school.illit
53               NA                 NA                    NA     924.4030
54             8.55              38.32                  7.78     899.3490
55               NA                 NA                    NA     874.7877
56             8.54              39.08                  9.65     850.7106
57               NA                 NA                    NA     827.1093
58             8.86              39.23                 10.52     803.9755
   school.prim school.med school.high school.post.high popdens   invest
53    3028.127   129.5121    48.95936         24.93797      NA 17.40149
54    3036.816   136.1797    51.77722         25.75277      NA 18.30896
55    3049.442   143.5947    54.98323         26.63120      NA 18.42999
56    3072.636   152.2357    58.61038         27.67255      NA 19.11566
57    3086.955   174.5955    62.49103         28.29547      NA 20.60849
58    3100.572   197.2741    66.77776         30.38357   68.51 22.05559</code></pre>
</div>
</div>
<p>The data contains the GDP per capita for Spanish regions in long format, and several covariates. Our treatment is the onset of political unrest in Basque in the year 1970. However, the terrorist activities were low at the beginning, but increased sharply in 1974.</p>
<p>First, we need to create a dataprep object which ensures that everything is in the right format for the <code>synth()</code> function. Apart from the standard information, we here have to decide which control units should be included, which covariates should be included in the matching procedure, and for which periods these covariates should be included.</p>
<p>Here we want to include the following covariates:</p>
<ul>
<li><p>The average GDP per capita in 1960 - 1964 and in 1965-1969 (we use the <code>special.predictors</code> option).</p></li>
<li><p>The share with high school (“school.high”) and more than high school (“school.post.high”) for the entire observation period (which need to specified using the option <code>time.predictors.prior</code>).</p></li>
<li><p>Population density (“popdens”) in 1969 (we use the <code>special.predictors</code> option).</p></li>
<li><p>Percentage working in the agricultural (“sec.agriculture”), the industrial (“sec.industry”), and the service sector (“sec.services.venta”) from 1961, 1963, 1965, 1967, 1969 (we use the <code>special.predictors</code> option).</p></li>
</ul>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>data_prep.out <span class="ot">&lt;-</span> <span class="fu">dataprep</span>(<span class="at">foo =</span> basque, </span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>                          <span class="at">predictors =</span> <span class="fu">c</span>(<span class="st">"school.high"</span>, <span class="st">"school.post.high"</span>),</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>                          <span class="at">predictors.op =</span> <span class="st">"mean"</span>, </span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>                          <span class="at">time.predictors.prior =</span> <span class="dv">1960</span><span class="sc">:</span><span class="dv">1969</span>,</span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>                          <span class="at">special.predictors =</span> <span class="fu">list</span>(</span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">list</span>(<span class="st">"gdpcap"</span>, <span class="dv">1960</span><span class="sc">:</span><span class="dv">1964</span>, <span class="st">"mean"</span>),</span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">list</span>(<span class="st">"gdpcap"</span>, <span class="dv">1965</span><span class="sc">:</span><span class="dv">1969</span>, <span class="st">"mean"</span>),</span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">list</span>(<span class="st">"sec.agriculture"</span>, <span class="fu">seq</span>(<span class="dv">1961</span>, <span class="dv">1969</span>, <span class="dv">2</span>), <span class="st">"mean"</span>),</span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">list</span>(<span class="st">"sec.industry"</span>, <span class="fu">seq</span>(<span class="dv">1961</span>, <span class="dv">1969</span>, <span class="dv">2</span>), <span class="st">"mean"</span>),</span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">list</span>(<span class="st">"sec.services.venta"</span>, <span class="fu">seq</span>(<span class="dv">1961</span>, <span class="dv">1969</span>, <span class="dv">2</span>), <span class="st">"mean"</span>)</span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a>                          ),</span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a>                          <span class="at">dependent =</span> <span class="st">"gdpcap"</span>, </span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true" tabindex="-1"></a>                          <span class="at">unit.variable =</span> <span class="st">"regionno"</span>,</span>
<span id="cb69-14"><a href="#cb69-14" aria-hidden="true" tabindex="-1"></a>                          <span class="at">time.variable =</span> <span class="st">"year"</span>, </span>
<span id="cb69-15"><a href="#cb69-15" aria-hidden="true" tabindex="-1"></a>                          <span class="at">treatment.identifier =</span> <span class="dv">17</span>,</span>
<span id="cb69-16"><a href="#cb69-16" aria-hidden="true" tabindex="-1"></a>                          <span class="at">controls.identifier =</span> <span class="fu">c</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">16</span>, <span class="dv">18</span>), </span>
<span id="cb69-17"><a href="#cb69-17" aria-hidden="true" tabindex="-1"></a>                          <span class="at">time.optimize.ssr =</span> <span class="dv">1960</span><span class="sc">:</span><span class="dv">1969</span>, </span>
<span id="cb69-18"><a href="#cb69-18" aria-hidden="true" tabindex="-1"></a>                          <span class="at">time.plot =</span> <span class="dv">1960</span><span class="sc">:</span><span class="dv">1997</span>,</span>
<span id="cb69-19"><a href="#cb69-19" aria-hidden="true" tabindex="-1"></a>                          <span class="at">unit.names.variable =</span> <span class="st">"regionname"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
 Missing data- treated unit; predictor: school.high ; for period: 1960 
 We ignore (na.rm = TRUE) all missing values for predictors.op.

 Missing data- treated unit; predictor: school.high ; for period: 1961 
 We ignore (na.rm = TRUE) all missing values for predictors.op.

 Missing data- treated unit; predictor: school.high ; for period: 1962 
 We ignore (na.rm = TRUE) all missing values for predictors.op.

 Missing data- treated unit; predictor: school.high ; for period: 1963 
 We ignore (na.rm = TRUE) all missing values for predictors.op.

 Missing data- treated unit; predictor: school.post.high ; for period: 1960 
 We ignore (na.rm = TRUE) all missing values for predictors.op.

 Missing data- treated unit; predictor: school.post.high ; for period: 1961 
 We ignore (na.rm = TRUE) all missing values for predictors.op.

 Missing data- treated unit; predictor: school.post.high ; for period: 1962 
 We ignore (na.rm = TRUE) all missing values for predictors.op.

 Missing data- treated unit; predictor: school.post.high ; for period: 1963 
 We ignore (na.rm = TRUE) all missing values for predictors.op.

 Missing data - control unit: 2 ; predictor: school.high ; for period: 1960 
 We ignore (na.rm = TRUE) all missing values for predictors.op.

 Missing data - control unit: 2 ; predictor: school.high ; for period: 1961 
 We ignore (na.rm = TRUE) all missing values for predictors.op.

 Missing data - control unit: 2 ; predictor: school.post.high ; for period: 1960 
 We ignore (na.rm = TRUE) all missing values for predictors.op.

 Missing data - control unit: 2 ; predictor: school.post.high ; for period: 1961 
 We ignore (na.rm = TRUE) all missing values for predictors.op.</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cbind</span>(data_prep.out<span class="sc">$</span>X0, data_prep.out<span class="sc">$</span>X1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>                                             2         3         4         5
school.high                          57.266496 16.091676 14.799358  5.921604
school.post.high                     27.278924  8.684416  6.424505  3.680154
special.gdpcap.1960.1964              2.271908  3.326892  3.350914  4.605498
special.gdpcap.1965.1969              2.849586  4.072922  4.116838  5.826450
special.sec.agriculture.1961.1969    24.194000 21.726000 12.362000 13.130000
special.sec.industry.1961.1969       18.276000 22.780000 24.126000 18.258000
special.sec.services.venta.1961.1969 38.186000 34.289999 30.152000 51.752000
                                             6         7         8         9
school.high                          12.086849  7.304420 37.787317 16.539727
school.post.high                      5.844122  2.885214 19.173427  6.308165
special.gdpcap.1960.1964              2.649514  3.526164  2.456512  1.922979
special.gdpcap.1965.1969              3.452514  4.216181  3.157612  2.558398
special.sec.agriculture.1961.1969    19.944000 15.922000 29.718000 36.086001
special.sec.industry.1961.1969        9.816000 36.530000 16.474000 17.178000
special.sec.services.venta.1961.1969 45.278001 33.484000 30.844000 29.238000
                                            10        11        12        13
school.high                          63.608315 34.275772 11.271676 29.341941
school.post.high                     32.374611 16.822106  4.570566 13.543060
special.gdpcap.1960.1964              4.778920  3.548129  1.707641  2.199986
special.gdpcap.1965.1969              5.515096  4.138360  2.145316  2.832591
special.sec.agriculture.1961.1969     6.936000 18.582000 37.948000 28.862000
special.sec.industry.1961.1969       40.056000 28.046000 10.886000 17.882000
special.sec.services.venta.1961.1969 39.068000 39.064001 31.720000 33.714001
                                            14        15        16        18
school.high                          62.458658  9.082540  6.550353  3.377170
school.post.high                     57.704985  4.428528  4.190368  1.732763
special.gdpcap.1960.1964              5.751671  2.507169  3.600557  3.400129
special.gdpcap.1965.1969              6.201714  3.291945  4.391617  4.218281
special.sec.agriculture.1961.1969     1.864000 19.352000 24.704000 30.322001
special.sec.industry.1961.1969       23.834000 19.644000 28.398000 26.612000
special.sec.services.venta.1961.1969 52.714000 36.177999 30.468000 28.300000
                                            17
school.high                          25.727525
school.post.high                     13.479720
special.gdpcap.1960.1964              4.859026
special.gdpcap.1965.1969              5.711911
special.sec.agriculture.1961.1969     6.844000
special.sec.industry.1961.1969       45.082000
special.sec.services.venta.1961.1969 33.754000</code></pre>
</div>
</div>
<p>So, this prepares a list of different objects that are used in the optimazition algorithm later on. Above, we see all the used covariates used for mathing.</p>
<p>we can also use it to print the raw trajecotries of the treated region and the control pool</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r fold-hide code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>Y1 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(data_prep.out<span class="sc">$</span>Y1plot)</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(Y1) <span class="ot">&lt;-</span> <span class="st">"y"</span></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>Y1<span class="sc">$</span>treat <span class="ot">&lt;-</span> <span class="st">"Treatment"</span></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>Y1<span class="sc">$</span>year <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">rownames</span>(Y1))</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>Y0 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">rowMeans</span>(data_prep.out<span class="sc">$</span>Y0plot))</span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(Y0) <span class="ot">&lt;-</span> <span class="st">"y"</span></span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a>Y0<span class="sc">$</span>treat <span class="ot">&lt;-</span> <span class="st">"Control"</span></span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a>Y0<span class="sc">$</span>year <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">rownames</span>(Y0))</span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">rbind</span>(Y1, Y0)</span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data =</span> data, <span class="fu">aes</span>(<span class="at">x =</span> year, <span class="at">y =</span> y)) <span class="sc">+</span></span>
<span id="cb73-14"><a href="#cb73-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">group =</span> treat, <span class="at">color =</span> treat, <span class="at">linetype =</span> treat),</span>
<span id="cb73-15"><a href="#cb73-15" aria-hidden="true" tabindex="-1"></a>            <span class="at">size =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb73-16"><a href="#cb73-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">guide =</span> <span class="fu">guide_axis</span>(<span class="at">check.overlap =</span> <span class="cn">TRUE</span>))<span class="sc">+</span></span>
<span id="cb73-17"><a href="#cb73-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb73-18"><a href="#cb73-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.key =</span> <span class="fu">element_blank</span>(), <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb73-19"><a href="#cb73-19" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.05</span>,<span class="fl">0.95</span>), <span class="at">legend.justification =</span> <span class="fu">c</span>(<span class="st">"left"</span>, <span class="st">"top"</span>),</span>
<span id="cb73-20"><a href="#cb73-20" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb73-21"><a href="#cb73-21" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.box.background =</span> <span class="fu">element_rect</span>(<span class="at">colour =</span> <span class="st">"black"</span>),</span>
<span id="cb73-22"><a href="#cb73-22" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.spacing.y =</span> <span class="fu">unit</span>(<span class="sc">-</span><span class="fl">0.1</span>, <span class="st">"cm"</span>))</span>
<span id="cb73-23"><a href="#cb73-23" aria-hidden="true" tabindex="-1"></a>p1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Panel_part2_files/figure-html/unnamed-chunk-28-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>This seems pretty hard to compare as there were already strong differences between Basque and other Spanish reasons before the onset of terrorist activities.</p>
<p>So, let’s see if we can do better by estimating a synthetic control unit for Basque using the <code>synth()</code> function.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>synth.out <span class="ot">&lt;-</span> <span class="fu">synth</span>(<span class="at">data.prep.obj =</span> data_prep.out)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
X1, X0, Z1, Z0 all come directly from dataprep object.


**************** 
 searching for synthetic control unit  
 

**************** 
**************** 
**************** 

MSPE (LOSS V): 0.004303228 

solution.v:
 0.005771656 0.002774483 0.2459551 0.2711423 0.4700225 0.004333906 2.35e-08 

solution.w:
 3.637e-07 1.0433e-06 0.0001466839 0.2090779 2.1999e-06 9.92302e-05 2.842e-07 2.729e-07 0.6449995 9.236e-07 2.988e-07 4.46e-07 0.1456666 3.3936e-06 6.043e-07 2.627e-07 </code></pre>
</div>
</div>
<p>This already gives us some important information. “solution.v” tells us the weights for the individual covariates, and “solution.w” gives us the weights for the units in the donor pool for constructing the synthetic control unit.</p>
<p>Before looking at the actual results, it is helpful to check some core statistics. For instance, below we see how well the synthetic control unit mirrors our treated region across the included covariates.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>synth.tables  <span class="ot">&lt;-</span> <span class="fu">synth.tab</span>(<span class="at">dataprep.res =</span> data_prep.out, <span class="at">synth.res =</span> synth.out)</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>synth.tables<span class="sc">$</span>tab.pred</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>                                     Treated Synthetic Sample Mean
school.high                           25.728    51.367      24.235
school.post.high                      13.480    30.058      13.478
special.gdpcap.1960.1964               4.859     4.884       3.225
special.gdpcap.1965.1969               5.712     5.680       3.937
special.sec.agriculture.1961.1969      6.844     7.494      21.353
special.sec.industry.1961.1969        45.082    33.133      22.425
special.sec.services.venta.1961.1969  33.754    43.706      36.528</code></pre>
</div>
</div>
<p>For the GDP per capita variables, the synthetic control closely resembles the treated region. That’s good!! However, for other covariates like “school.high” or “school.post.high”, the synthetic control region matches notatbly worse than the raw sample… Nevertheless, why do we not need to worry so much about that? (look at “solution.v” above)</p>
<p>Obviously, we also want to know the weights that each region receives for the construction of the synthetic control.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>synth.tables<span class="sc">$</span>tab.w</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   w.weights                   unit.names unit.numbers
2      0.000                    Andalucia            2
3      0.000                       Aragon            3
4      0.000       Principado De Asturias            4
5      0.209             Baleares (Islas)            5
6      0.000                     Canarias            6
7      0.000                    Cantabria            7
8      0.000              Castilla Y Leon            8
9      0.000           Castilla-La Mancha            9
10     0.645                     Cataluna           10
11     0.000         Comunidad Valenciana           11
12     0.000                  Extremadura           12
13     0.000                      Galicia           13
14     0.146        Madrid (Comunidad De)           14
15     0.000           Murcia (Region de)           15
16     0.000 Navarra (Comunidad Foral De)           16
18     0.000                   Rioja (La)           18</code></pre>
</div>
</div>
<p>So, only the Baleares, Cataluna and Madrid contribute to the synthetic control region, while all others are set to zero. Cataluna by far receives the highest weight.</p>
<p>Finally, how does the synthetic control average look like and how does it compare to the treated unit of Basque?</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="fu">path.plot</span>(<span class="at">synth.res =</span> synth.out, <span class="at">dataprep.res =</span> data_prep.out,</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>          <span class="at">Ylab =</span> <span class="fu">c</span>(<span class="st">"GDP per capita"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Panel_part2_files/figure-html/unnamed-chunk-32-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Before 1970, the synthetic control region aligns very well with the Basque region. From 1970, Basque shows a slightly lower GDP than its counterfactual with terrorist activities. From 1974/75 (after the sharp increase in terrorist activities) we see a pronounced decline in the GDP as compared to the synthetic control unit.</p>
<p>We can also show these differences more clearly, when plotting the differences instead of the trajectory.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="fu">gaps.plot</span>(<span class="at">synth.res =</span> synth.out, <span class="at">dataprep.res =</span> data_prep.out,</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>          <span class="at">Ylab =</span> <span class="fu">c</span>(<span class="st">"Difference in GDP per capita"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Panel_part2_files/figure-html/unnamed-chunk-33-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p><strong>Inferencial statistics</strong></p>
<p>However, is this difference statistically significant or might it be a result of pure chance?</p>
<p>So give some intuition of the significance of the treatment effect, we perform an interaction of placebo test, artificially assigning the treatment status to control regions.</p>
<p>The function <code>generate.placebos()</code> of the <code>SCtools</code> package does all of this automatically for us.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>placebo <span class="ot">&lt;-</span> <span class="fu">generate.placebos</span>(<span class="at">dataprep.out =</span> data_prep.out,</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>                             <span class="at">synth.out =</span> synth.out, </span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>                             <span class="at">strategy =</span> <span class="st">"multisession"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Also creating the respective plot.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_placebos</span>(placebo)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Panel_part2_files/figure-html/unnamed-chunk-35-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The real treatment region seems quite special. For some control regions, we observe similarly stong “treatment effects”. However, these extreme regions have a poor pre-treatment fit, and thus should be disregarded.</p>
</section>
</section>
<section id="generalized-synthetic-control" class="level1">
<h1>Generalized Synthetic Control</h1>
<p>Generalized Synthetic Control <span class="citation" data-cites="Xu.2017">(<a href="#ref-Xu.2017" role="doc-biblioref">Xu 2017</a>)</span> is a way of generalising the “qualitative” approach with one single treated unit to a setting with multiple treated units based on Interactive Fixed Effects or Factor Models:</p>
<p><span class="math display">\[
Y_{it} = \sum_{r=1}^R \gamma_{ir} \delta_{tr} + \epsilon_{it} \quad \text{or} \quad,
\mathbf{Y} = \mathbf U \mathbf V^\mathrm T + \mathbf{\varepsilon}.
\]</span></p>
<ul>
<li>with with <span class="math inline">\(\mathbf U\)</span> being an <span class="math inline">\(N \times r\)</span> matrix of unknown factor loadings (unit-specific intercepts),</li>
<li>and <span class="math inline">\(\mathbf V\)</span> an <span class="math inline">\(T \times r\)</span> matrix of unobserved common factors (time-varying coefficients).</li>
</ul>
<p>Estimate <span class="math inline">\(\\delta\)</span> and <span class="math inline">\(\\gamma\)</span> by least squares and use to impute missing values.</p>
<p><span class="math display">\[
\hat Y _{NT} = \sum_{r=1}^R \hat \delta_{Nr} \hat \gamma_{rT}.
\]</span></p>
<p>In a matrix form, the <span class="math inline">\(Y_{N \times T}\)</span> can be rewritten as:</p>
<p><span class="math display">\[
Y_{N\times T}= \mathbf U \mathbf V^\mathrm T + \epsilon_{N \times T} =  \mathbf L_{N \times T} + \epsilon_{N \times T} = \\ \left(
\begin{array}{ccccccc}
\delta_{11} &amp; \dots &amp; \delta_{R1}  \\
\vdots &amp; \dots &amp; \vdots   \\
\vdots &amp; \dots &amp; \vdots   \\
\vdots &amp; \dots &amp; \vdots   \\
\delta_{1N} &amp; \dots &amp; \delta_{RN}  \\
\end{array}\right)
\left(
\begin{array}{ccccccc}
\gamma_{11}  &amp; \dots \dots \dots &amp; \gamma_{1T}  \\
\vdots &amp; \dots \dots \dots &amp; \vdots   \\
\gamma_{R1}  &amp; \dots \dots \dots &amp; \gamma_{RT}  \\
\end{array}
\right) + \epsilon_{N \times T}
\]</span></p>
</section>
<section id="matrix-completion" class="level1">
<h1>Matrix Completion</h1>
<p>Matrix Completion <span class="citation" data-cites="Athey.2021">(<a href="#ref-Athey.2021" role="doc-biblioref">Athey et al. 2021</a>)</span> uses a very similar approach. Instead of estimating the factors, we estimate the matrix <span class="math inline">\(\mathbf L_{N \times T}\)</span> directly. It is supposed to generalise the horizontal and vertical approach.</p>
<p><span class="math display">\[
Y_{N\times T}=\left(
\begin{array}{cccccccccc}
{\color{red} ?} &amp; {\color{red} ?} &amp; {\color{red} ?} &amp; {\color{red} ?} &amp; {\color{red} ?}&amp; \checkmark  &amp; \dots  &amp; {\color{red} ?}\\
\checkmark &amp; {\color{red} ?} &amp; {\color{red} ?} &amp; {\color{red} ?} &amp; \checkmark &amp; {\color{red} ?}   &amp; \dots &amp; \checkmark  \\
{\color{red} ?}  &amp; \checkmark &amp; {\color{red} ?}  &amp; {\color{red} ?} &amp; {\color{red} ?} &amp; {\color{red} ?} &amp; \dots &amp; {\color{red} ?}  \\
{\color{red} ?} &amp; {\color{red} ?} &amp; {\color{red} ?} &amp; {\color{red} ?} &amp; {\color{red} ?}&amp; \checkmark  &amp; \dots  &amp; {\color{red} ?}\\
\checkmark &amp; {\color{red} ?} &amp; {\color{red} ?} &amp; {\color{red} ?} &amp; {\color{red} ?} &amp; {\color{red} ?}   &amp; \dots &amp; \checkmark  \\
{\color{red} ?}  &amp; \checkmark &amp; {\color{red} ?}  &amp; {\color{red} ?} &amp; {\color{red} ?} &amp; {\color{red} ?} &amp; \dots &amp; {\color{red} ?}  \\
\vdots   &amp;  \vdots &amp; \vdots &amp;\vdots   &amp;  \vdots &amp; \vdots &amp;\ddots &amp;\vdots \\
{\color{red} ?}  &amp; {\color{red} ?} &amp; {\color{red} ?} &amp; {\color{red} ?}&amp; \checkmark &amp; {\color{red} ?}   &amp; \dots &amp; {\color{red} ?}\\
\end{array}
\right)
\]</span></p>
<p>This can be done via Nuclear Norm Minimization:</p>
<p><span class="math display">\[
\min_{L}\frac{1}{|\cal{O}|}
\sum_{(i,t) \in \cal{o}} \left(Y_{it} -
L_{it} \right)^2+\lambda_L \|L\|_*
\]</span></p>
<ul>
<li>where <span class="math inline">\(\cal{O}\)</span> denote the set of pairs of indices corresponding to the observed entries (the entries with <span class="math inline">\(W_{it} = 0\)</span>).</li>
</ul>
<p>Given any <span class="math inline">\(N\times T\)</span> matrix <span class="math inline">\(A\)</span>, define the two <span class="math inline">\(N\times T\)</span> matrices <span class="math inline">\(P_\cal{O}(A)\)</span> and <span class="math inline">\(P_\cal{O}^\perp(A)\)</span> with typical elements: <span class="math display">\[
P_\cal{O}(A)_{it}=
\left\{
\begin{array}{ll}
A_{it}\hskip1cm &amp; {\rm if}\ (i,t)\in\cal{O}\,,\\
0&amp;{\rm if}\ (i,t)\notin\cal{O}\,,
\end{array}\right.
\]</span> and <span class="math display">\[
P_\cal{O}^\perp(A)_{it}=
\left\{
\begin{array}{ll}
0\hskip1cm &amp; {\rm if}\ (i,t)\in\cal{O}\,,\\
A_{it}&amp;{\rm if}\ (i,t)\notin\cal{O}\,.
\end{array}\right.
\]</span></p>
<p>Let <span class="math inline">\(A=S\Sigma R^\top\)</span> be the Singular Value Decomposition for <span class="math inline">\(A\)</span>, with <span class="math inline">\(\sigma_1(A),\ldots,\sigma_{\min(N,T)}(A)\)</span>, denoting the singular values. Then define the matrix shrinkage operator <span class="math display">\[
\ shrink_\lambda(A)=S \tilde\Sigma R^\top\,,
\]</span> where <span class="math inline">\(\tilde\Sigma\)</span> is equal to <span class="math inline">\(\Sigma\)</span> with the <span class="math inline">\(i\)</span>-th singular value <span class="math inline">\(\sigma_i(A)\)</span> replaced by <span class="math inline">\(\max(\sigma_i(A)-\lambda,0)\)</span>.</p>
<section id="the-algorithm" class="level3">
<h3 class="anchored" data-anchor-id="the-algorithm">The algorithm</h3>
<ol type="1">
<li>Start with the initial choice <span class="math inline">\(L_1(\lambda)=P_\cal{O}(Y)\)</span>, with zeros for the missing values.</li>
<li>Then for <span class="math inline">\(k=1,2,\ldots,\)</span> define, <span class="math display">\[
L_{k+1}(\lambda)=shrink_\lambda\Biggl\{P_\cal{O}(Y)+P_\cal{O}^\perp\Big(L_k(\lambda)\Big)\Biggr\}\,
\]</span> until the sequence <span class="math inline">\(\left\{L_k(\lambda)\right\}_{k\ge 1}\)</span> converges.</li>
<li>The limiting matrix <span class="math inline">\(L^*\)</span> is our estimator for the regularization parameter <span class="math inline">\(\lambda\)</span>, denoted by <span class="math inline">\(\hat{L}(\lambda,\cal{O})\)</span>.</li>
</ol>
<p><img src="fig/correlation.png" class="img-fluid"></p>
</section>
</section>
<section id="references" class="level1">



<!-- -->


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" role="list">
<div id="ref-Abadie.2021" class="csl-entry" role="listitem">
Abadie, Alberto. 2021. <span>“Using Synthetic Controls: <span>Feasibility</span>, Data Requirements, and Methodological <span>Aspects</span>.”</span> <em>Journal of Economic Literature</em>, Forthcoming.
</div>
<div id="ref-Abadie.2010" class="csl-entry" role="listitem">
Abadie, Alberto, Alexis Diamond, and Jens Hainmueller. 2010. <span>“Synthetic Control Methods for Comparative Case Studies: <span>Estimating</span> the Effect of <span>California</span>’s Tobacco Control Program.”</span> <em>Journal of the American Statistical Association</em> 105 (490): 493–505. <a href="https://doi.org/10.1198/jasa.2009.ap08746">https://doi.org/10.1198/jasa.2009.ap08746</a>.
</div>
<div id="ref-Abadie.2011" class="csl-entry" role="listitem">
———. 2011. <span>“Synth : <span>An R Package</span> for <span>Synthetic Control Methods</span> in <span>Comparative Case Studies</span>.”</span> <em>Journal of Statistical Software</em> 42 (13). <a href="https://doi.org/10.18637/jss.v042.i13">https://doi.org/10.18637/jss.v042.i13</a>.
</div>
<div id="ref-Abadie.2003" class="csl-entry" role="listitem">
Abadie, Alberto, and Javier Gardeazabal. 2003. <span>“The <span>Economic Costs</span> of <span>Conflict</span>: <span>A Case Study</span> of the <span>Basque Country</span>.”</span> <em>American Economic Review</em> 93 (1): 113–32. <a href="https://doi.org/10.1257/000282803321455188">https://doi.org/10.1257/000282803321455188</a>.
</div>
<div id="ref-Athey.2021" class="csl-entry" role="listitem">
Athey, Susan, Mohsen Bayati, Nikolay Doudchenko, Guido Imbens, and Khashayar Khosravi. 2021. <span>“Matrix Completion Methods for Causal Panel Data Models.”</span> <em>Journal of the American Statistical Association</em> 59: 1–15. <a href="https://doi.org/10.1080/01621459.2021.1891924">https://doi.org/10.1080/01621459.2021.1891924</a>.
</div>
<div id="ref-Bruderl.2015" class="csl-entry" role="listitem">
Brüderl, Josef, and Volker Ludwig. 2015. <span>“Fixed-<span>Effects Panel Regression</span>.”</span> In <em>The <span>Sage Handbook</span> of <span>Regression Analysis</span> and <span>Causal Inference</span></em>, edited by Henning Best and Christof Wolf, 327–57. <span>Los Angeles</span>: <span>Sage</span>.
</div>
<div id="ref-Callaway.2020" class="csl-entry" role="listitem">
Callaway, Brantly, and Pedro H. C. Sant’Anna. 2020. <span>“Difference-in-<span>Differences</span> with Multiple Time Periods.”</span> <em>Journal of Econometrics</em> 72 (5): 1. <a href="https://doi.org/10.1016/j.jeconom.2020.12.001">https://doi.org/10.1016/j.jeconom.2020.12.001</a>.
</div>
<div id="ref-Cattaneo.2021" class="csl-entry" role="listitem">
Cattaneo, Matias D., Yingjie Feng, and Rocio Titiunik. 2021. <span>“Prediction <span>Intervals</span> for <span>Synthetic Control Methods</span>.”</span> <em>Journal of the American Statistical Association</em> 116 (536): 1865–80. <a href="https://doi.org/10.1080/01621459.2021.1979561">https://doi.org/10.1080/01621459.2021.1979561</a>.
</div>
<div id="ref-Chamberlain.1982" class="csl-entry" role="listitem">
Chamberlain, Gary. 1982. <span>“Multivariate <span>Regression Models</span> for <span>Panel Data</span>.”</span> <em>Journal of Econometrics</em> 18 (1): 5–46. <a href="https://doi.org/10.1016/0304-4076(82)90094-X">https://doi.org/10.1016/0304-4076(82)90094-X</a>.
</div>
<div id="ref-Chernozhukov.2021b" class="csl-entry" role="listitem">
Chernozhukov, Victor, Hiroyuki Kasahara, and Paul Schrimpf. 2021. <span>“The Association of Opening <span>K</span> Schools with the Spread of <span>COVID-19</span> in the <span>United States</span>: <span class="nocase">County-level</span> Panel Data Analysis.”</span> <em>Proceedings of the National Academy of Sciences</em> 118 (42): e2103420118. <a href="https://doi.org/10.1073/pnas.2103420118">https://doi.org/10.1073/pnas.2103420118</a>.
</div>
<div id="ref-Clark.2013" class="csl-entry" role="listitem">
Clark, Andrew E., and Yannis Georgellis. 2013. <span>“Back to <span>Baseline</span> in <span>Britain</span>: <span>Adaptation</span> in the <span>British Household Panel Survey</span>.”</span> <em>Economica</em> 80 (319): 496–512. <a href="https://doi.org/10.1111/ecca.12007">https://doi.org/10.1111/ecca.12007</a>.
</div>
<div id="ref-Currie.2015" class="csl-entry" role="listitem">
Currie, Janet, Lucas Davis, Michael Greenstone, and Reed Walker. 2015. <span>“Environmental <span>Health Risks</span> and <span>Housing Values</span>: <span>Evidence</span> from 1,600 <span>Toxic Plant Openings</span> and <span>Closings</span>.”</span> <em>American Economic Review</em> 105 (2): 678–709. <a href="https://doi.org/10.1257/aer.20121656">https://doi.org/10.1257/aer.20121656</a>.
</div>
<div id="ref-deChaisemartin.2020" class="csl-entry" role="listitem">
de Chaisemartin, Clément, and Xavier D’Haultfœuille. 2020. <span>“Two-<span>Way Fixed Effects Estimators</span> with <span>Heterogeneous Treatment Effects</span>.”</span> <em>American Economic Review</em> 110 (9): 2964–96. <a href="https://doi.org/10.1257/aer.20181169">https://doi.org/10.1257/aer.20181169</a>.
</div>
<div id="ref-Goodman-Bacon.2021" class="csl-entry" role="listitem">
Goodman-Bacon, Andrew. 2021. <span>“Difference-in-Differences with Variation in Treatment Timing.”</span> <em>Journal of Econometrics</em> 225 (2): 254–77. <a href="https://doi.org/10.1016/j.jeconom.2021.03.014">https://doi.org/10.1016/j.jeconom.2021.03.014</a>.
</div>
<div id="ref-Ludwig.2018" class="csl-entry" role="listitem">
Ludwig, Volker, and Josef Brüderl. 2018. <span>“Is <span>There</span> a <span>Male Marital Wage Premium</span>? <span>New Evidence</span> from the <span>United States</span>.”</span> <em>American Sociological Review</em> 83 (4): 744–70. <a href="https://doi.org/10.1177/0003122418784909">https://doi.org/10.1177/0003122418784909</a>.
</div>
<div id="ref-Ludwig.2021" class="csl-entry" role="listitem">
———. 2021. <span>“What <span>You Need</span> to <span>Know When Estimating Impact Functions</span> with <span>Panel Data</span> for <span>Demographic Research</span>.”</span> <em>Comparative Population Studies</em> 46. <a href="https://doi.org/10.12765/CPoS-2021-16">https://doi.org/10.12765/CPoS-2021-16</a>.
</div>
<div id="ref-Meer.2016" class="csl-entry" role="listitem">
Meer, Jonathan, and Jeremy West. 2016. <span>“Effects of the <span>Minimum Wage</span> on <span>Employment Dynamics</span>.”</span> <em>Journal of Human Resources</em> 51 (2): 500–522. <a href="https://doi.org/10.3368/jhr.51.2.0414-6298R1">https://doi.org/10.3368/jhr.51.2.0414-6298R1</a>.
</div>
<div id="ref-Mundlak.1978" class="csl-entry" role="listitem">
Mundlak, Yair. 1978. <span>“On the <span>Pooling</span> of <span>Time Series</span> and <span>Cross Section Data</span>.”</span> <em>Econometrica</em> 46 (1): 69. <a href="https://doi.org/10.2307/1913646">https://doi.org/10.2307/1913646</a>.
</div>
<div id="ref-NLSY79.2001" class="csl-entry" role="listitem">
NLSY79. n.d. <em><span>NLSY79</span> Users’ Guide : A Guide to the 1979-2000 <span>National Longitudinal Survey</span> of <span>Youth</span> Data</em>. <span>Columbus, Ohio : Center for Human Resource Research, Ohio State University, [2001]</span>.
</div>
<div id="ref-Polachek.1994" class="csl-entry" role="listitem">
Polachek, Solomon W., and Moon-Kak Kim. 1994. <span>“Panel <span>Estimates</span> of the <span>Gender Earnings Gap</span>.”</span> <em>Journal of Econometrics</em> 61 (1): 23–42. <a href="https://doi.org/10.1016/0304-4076(94)90075-2">https://doi.org/10.1016/0304-4076(94)90075-2</a>.
</div>
<div id="ref-Roth.2023" class="csl-entry" role="listitem">
Roth, Jonathan, Pedro H. C. Sant’Anna, Alyssa Bilinski, and John Poe. 2023. <span>“What’s Trending in Difference-in-Differences? <span>A</span> Synthesis of the Recent Econometrics Literature.”</span> <em>Journal of Econometrics</em> 235 (2): 2218–44. <a href="https://doi.org/10.1016/j.jeconom.2023.03.008">https://doi.org/10.1016/j.jeconom.2023.03.008</a>.
</div>
<div id="ref-Ruttenauer.2023" class="csl-entry" role="listitem">
Rüttenauer, Tobias, and Volker Ludwig. 2023. <span>“Fixed <span>Effects Individual Slopes</span>: <span>Accounting</span> and <span>Testing</span> for <span>Heterogeneous Effects</span> in <span>Panel Data</span> or <span>Other Multilevel Models</span>.”</span> <em>Sociological Methods &amp; Research</em> 52 (1): 43–84. <a href="https://doi.org/10.1177/0049124120926211">https://doi.org/10.1177/0049124120926211</a>.
</div>
<div id="ref-Sun.2021" class="csl-entry" role="listitem">
Sun, Liyang, and Sarah Abraham. 2021. <span>“Estimating Dynamic Treatment Effects in Event Studies with Heterogeneous Treatment Effects.”</span> <em>Journal of Econometrics</em> 225 (2): 175–99. <a href="https://doi.org/10.1016/j.jeconom.2020.09.006">https://doi.org/10.1016/j.jeconom.2020.09.006</a>.
</div>
<div id="ref-Wooldridge.2010" class="csl-entry" role="listitem">
Wooldridge, Jeffrey M. 2010. <em>Econometric <span>Analysis</span> of <span>Cross Section</span> and <span>Panel Data</span></em>. <span>Cambridge, Mass.</span>: <span>MIT Press</span>.
</div>
<div id="ref-Xu.2017" class="csl-entry" role="listitem">
Xu, Yiqing. 2017. <span>“Generalized Synthetic Control Method: <span>Causal</span> Inference with Interactive Fixed Effects Models.”</span> <em>Political Analysis</em> 25 (1): 57–76. <a href="https://doi.org/10.1017/pan.2016.2">https://doi.org/10.1017/pan.2016.2</a>.
</div>
</div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb84" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "2) Advanced methods"</span></span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: true</span></span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a><span class="an">output:</span><span class="co"> </span></span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a><span class="co">  html_document:</span></span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a><span class="co">    toc: true</span></span>
<span id="cb84-10"><a href="#cb84-10" aria-hidden="true" tabindex="-1"></a><span class="co">    toc_float: true</span></span>
<span id="cb84-11"><a href="#cb84-11" aria-hidden="true" tabindex="-1"></a><span class="co">    toc_depth: 2</span></span>
<span id="cb84-12"><a href="#cb84-12" aria-hidden="true" tabindex="-1"></a><span class="co">    number_sections: true</span></span>
<span id="cb84-13"><a href="#cb84-13" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span></span>
<span id="cb84-14"><a href="#cb84-14" aria-hidden="true" tabindex="-1"></a><span class="co">  - name: Tobias Rüttenauer</span></span>
<span id="cb84-15"><a href="#cb84-15" aria-hidden="true" tabindex="-1"></a><span class="co">    orcid:  0000-0001-5747-9735</span></span>
<span id="cb84-16"><a href="#cb84-16" aria-hidden="true" tabindex="-1"></a><span class="co">    email: t.ruttenauer@ucl.ac.uk</span></span>
<span id="cb84-17"><a href="#cb84-17" aria-hidden="true" tabindex="-1"></a><span class="co">    url: https://ruettenauer.github.io/</span></span>
<span id="cb84-18"><a href="#cb84-18" aria-hidden="true" tabindex="-1"></a><span class="co">    affiliations:</span></span>
<span id="cb84-19"><a href="#cb84-19" aria-hidden="true" tabindex="-1"></a><span class="co">      - name: UCL Social Research Institute</span></span>
<span id="cb84-20"><a href="#cb84-20" aria-hidden="true" tabindex="-1"></a><span class="co">        address: University College London</span></span>
<span id="cb84-21"><a href="#cb84-21" aria-hidden="true" tabindex="-1"></a><span class="co">        city: London WC1H 0AL</span></span>
<span id="cb84-22"><a href="#cb84-22" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb84-23"><a href="#cb84-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-24"><a href="#cb84-24" aria-hidden="true" tabindex="-1"></a>\newcommand{\Cov}{\mathrm{Cov}}</span>
<span id="cb84-25"><a href="#cb84-25" aria-hidden="true" tabindex="-1"></a>\newcommand{\Var}{\mathrm{Var}}</span>
<span id="cb84-26"><a href="#cb84-26" aria-hidden="true" tabindex="-1"></a>\newcommand{\tr}{\mathrm{tr}}</span>
<span id="cb84-27"><a href="#cb84-27" aria-hidden="true" tabindex="-1"></a>\newcommand{\plim}{\operatornamewithlimits{plim}}</span>
<span id="cb84-28"><a href="#cb84-28" aria-hidden="true" tabindex="-1"></a>\newcommand{\diag}{\mathrm{diag}}</span>
<span id="cb84-29"><a href="#cb84-29" aria-hidden="true" tabindex="-1"></a>\newcommand{\E}{\mathrm{E}}</span>
<span id="cb84-30"><a href="#cb84-30" aria-hidden="true" tabindex="-1"></a>\newcommand{\Prob}{\mathrm{Prob}}</span>
<span id="cb84-31"><a href="#cb84-31" aria-hidden="true" tabindex="-1"></a>\newcommand{\bm}<span class="co">[</span><span class="ot">1</span><span class="co">]</span>{\boldsymbol{\mathbf{#1}}}</span>
<span id="cb84-32"><a href="#cb84-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-33"><a href="#cb84-33" aria-hidden="true" tabindex="-1"></a><span class="fu">### Required packages</span></span>
<span id="cb84-34"><a href="#cb84-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-35"><a href="#cb84-35" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message = FALSE, warning = FALSE, results = 'hide'}</span></span>
<span id="cb84-36"><a href="#cb84-36" aria-hidden="true" tabindex="-1"></a>pkgs <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"plm"</span>, <span class="st">"feisr"</span>, <span class="st">"did"</span>, <span class="st">"Synth"</span>, <span class="st">"SCtools"</span>, </span>
<span id="cb84-37"><a href="#cb84-37" aria-hidden="true" tabindex="-1"></a>          <span class="st">"panelView"</span>, <span class="st">"texreg"</span>, <span class="st">"tidyr"</span>, <span class="st">"dplyr"</span>, <span class="st">"ggplot2"</span>, <span class="st">"ggforce"</span>) </span>
<span id="cb84-38"><a href="#cb84-38" aria-hidden="true" tabindex="-1"></a><span class="fu">lapply</span>(pkgs, require, <span class="at">character.only =</span> <span class="cn">TRUE</span>)</span>
<span id="cb84-39"><a href="#cb84-39" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb84-40"><a href="#cb84-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-41"><a href="#cb84-41" aria-hidden="true" tabindex="-1"></a><span class="fu">### Session info</span></span>
<span id="cb84-42"><a href="#cb84-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-45"><a href="#cb84-45" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb84-46"><a href="#cb84-46" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span>
<span id="cb84-47"><a href="#cb84-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-48"><a href="#cb84-48" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb84-49"><a href="#cb84-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-50"><a href="#cb84-50" aria-hidden="true" tabindex="-1"></a><span class="fu"># Outline</span></span>
<span id="cb84-51"><a href="#cb84-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-52"><a href="#cb84-52" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Fixed Effects Individual Slopes</span>
<span id="cb84-53"><a href="#cb84-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-54"><a href="#cb84-54" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Dynamic treatment effects</span>
<span id="cb84-55"><a href="#cb84-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-56"><a href="#cb84-56" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Dynamic Diff-in-Diff</span>
<span id="cb84-57"><a href="#cb84-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-58"><a href="#cb84-58" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Synthetic Control</span>
<span id="cb84-59"><a href="#cb84-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-60"><a href="#cb84-60" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>TBD: Generalized Synthetic Control</span>
<span id="cb84-61"><a href="#cb84-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-62"><a href="#cb84-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-63"><a href="#cb84-63" aria-hidden="true" tabindex="-1"></a><span class="fu"># Fixed Effects Individual Slopes</span></span>
<span id="cb84-64"><a href="#cb84-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-65"><a href="#cb84-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-66"><a href="#cb84-66" aria-hidden="true" tabindex="-1"></a>Remeber that we have to make the parallel trends assumption in twoways FE models. A violation of the parallel trends assumption leads to biased estimates. Usually, when controlling for time fixed effects, we make the assumption that every observation experiences the same "effect of time".</span>
<span id="cb84-67"><a href="#cb84-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-68"><a href="#cb84-68" aria-hidden="true" tabindex="-1"></a>However, we can relax this assumption by giving each individual their own intercept __and__ their own slope.</span>
<span id="cb84-69"><a href="#cb84-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-70"><a href="#cb84-70" aria-hidden="true" tabindex="-1"></a>The fixed effects individual slope (FEIS) estimator is a more general version of the well-known fixed effects estimator (FE), which allows to control for heterogeneous slopes in addition to time-constant heterogeneity <span class="co">[</span><span class="ot">e.g. @Bruderl.2015; @Polachek.1994; @Ruttenauer.2023; @Wooldridge.2010</span><span class="co">]</span>. Formally, the FEIS estimator can be expressed as </span>
<span id="cb84-71"><a href="#cb84-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-72"><a href="#cb84-72" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb84-73"><a href="#cb84-73" aria-hidden="true" tabindex="-1"></a>\begin{align} </span>
<span id="cb84-74"><a href="#cb84-74" aria-hidden="true" tabindex="-1"></a>\bm y_{i} =&amp; \bm X_{i}\bm\beta + \bm W_i \bm\alpha_i + \bm \epsilon_{i},</span>
<span id="cb84-75"><a href="#cb84-75" aria-hidden="true" tabindex="-1"></a>\end{align}</span>
<span id="cb84-76"><a href="#cb84-76" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb84-77"><a href="#cb84-77" aria-hidden="true" tabindex="-1"></a>where $\bm y_{i}$ is $T \times 1$, $\bm X_{i}$ is $T \times K$, and $\bm\epsilon_{i}$ is $T \times 1$. $\bm W_i$ is a $T \times J$ matrix of slope variables, and $\bm\alpha_i$ a $J \times 1$ vector of individual-specific slope parameters, for $J$ slope parameters including a constant term. If $\bm W_i$ consists of a constant term only, $\bm W_i = \bm 1$, thus $\bm\alpha_i$ reduces to $\alpha_{i1}$, and the above equation represents the well-known formula of a conventional FE model with individual fixed effects.</span>
<span id="cb84-78"><a href="#cb84-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-79"><a href="#cb84-79" aria-hidden="true" tabindex="-1"></a>As with the conventional FE, FEIS can be estimated using <span class="in">`lm()`</span> by including $N-1$ individual-specific dummies and interaction terms of each slope variable with the $N-1$ individual-specific dummies ($(N-1) *J$ controls). This is however highly inefficient. As with the conventional FE estimator, we can achieve the same result by running an <span class="in">`lm()`</span> on pre-transformed data. Therefore, specify the 'residual maker' matrix $\bm M_i = \bm I_T - \bm W_i(\bm W^\intercal_i \bm W_i)^{-1}\bm W^\intercal_i$, and estimate</span>
<span id="cb84-80"><a href="#cb84-80" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb84-81"><a href="#cb84-81" aria-hidden="true" tabindex="-1"></a>\begin{align} </span>
<span id="cb84-82"><a href="#cb84-82" aria-hidden="true" tabindex="-1"></a>y_{it} - \hat{y}_{it} =&amp; (\bm x_{it} - \hat{\bm x}_{it})\bm\beta + \epsilon_{it} - \hat{\epsilon}_{it}, <span class="sc">\\</span></span>
<span id="cb84-83"><a href="#cb84-83" aria-hidden="true" tabindex="-1"></a>\bm M_i \bm y_i =&amp; \bm M_i \bm X_i\bm\beta + \bm M_i \bm \epsilon_{i}, <span class="sc">\\</span></span>
<span id="cb84-84"><a href="#cb84-84" aria-hidden="true" tabindex="-1"></a>\tilde{\bm y}_{i} =&amp; \tilde{\bm X}_{i}\bm\beta + \tilde{\bm \epsilon}_{i},</span>
<span id="cb84-85"><a href="#cb84-85" aria-hidden="true" tabindex="-1"></a>\end{align} </span>
<span id="cb84-86"><a href="#cb84-86" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb84-87"><a href="#cb84-87" aria-hidden="true" tabindex="-1"></a>where $\tilde{\bm y}_{i}$, $\tilde{\bm X}_{i}$, and $\tilde{\bm \epsilon}_{i}$ are the residuals of regressing $\bm y_{i}$, each column-vector of $\bm X_{i}$, and $\bm \epsilon_{i}$ on $\bm W_i$. </span>
<span id="cb84-88"><a href="#cb84-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-89"><a href="#cb84-89" aria-hidden="true" tabindex="-1"></a>__Intuitively__, we </span>
<span id="cb84-90"><a href="#cb84-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-91"><a href="#cb84-91" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>estimate the individual-specific predicted values for the dependent variable and each covariate based on an individual intercept and the additional slope variables of $\bm W_i$, </span>
<span id="cb84-92"><a href="#cb84-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-93"><a href="#cb84-93" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>'detrend' the original data by these individual-specific predicted values, and </span>
<span id="cb84-94"><a href="#cb84-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-95"><a href="#cb84-95" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>run an OLS model on the residual ('detrended') data. </span>
<span id="cb84-96"><a href="#cb84-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-97"><a href="#cb84-97" aria-hidden="true" tabindex="-1"></a>Similarly, we can estimate a correlated random effects (CRE) model <span class="co">[</span><span class="ot">@Chamberlain.1982; @Mundlak.1978; @Wooldridge.2010</span><span class="co">]</span> including the individual specific predictions $\hat{\bm X}_{i}$ to obtain the FEIS estimator:</span>
<span id="cb84-98"><a href="#cb84-98" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb84-99"><a href="#cb84-99" aria-hidden="true" tabindex="-1"></a>\begin{align} </span>
<span id="cb84-100"><a href="#cb84-100" aria-hidden="true" tabindex="-1"></a>\bm y_{i} =&amp; \bm X_{i}\bm\beta + \hat{\bm X}_{i}\bm\rho + \bm \epsilon_{i}.</span>
<span id="cb84-101"><a href="#cb84-101" aria-hidden="true" tabindex="-1"></a>\end{align}</span>
<span id="cb84-102"><a href="#cb84-102" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb84-103"><a href="#cb84-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-104"><a href="#cb84-104" aria-hidden="true" tabindex="-1"></a>Although we are here mainly interested in controlling for individual time, FEIS can be used to control for individual specific effects of any covariate. For instance, @Ruttenauer.2023 discuss an example of controlling for family-specific pre-treatment conditions in a sibling study on the effect of participating in pre-school programs on later life outcomes.</span>
<span id="cb84-105"><a href="#cb84-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-106"><a href="#cb84-106" aria-hidden="true" tabindex="-1"></a><span class="fu">### Example</span></span>
<span id="cb84-107"><a href="#cb84-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-108"><a href="#cb84-108" aria-hidden="true" tabindex="-1"></a>As an example, we use the <span class="in">`mwp`</span> panel data, containing information on wages and family status of 268 men. This is a random sample drawn from the National Longitudinal Survey of Youth <span class="co">[</span><span class="ot">@NLSY79.2001</span><span class="co">]</span>, and more details on the selection of observations and variable construction can be found in @Ludwig.2018. </span>
<span id="cb84-109"><a href="#cb84-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-112"><a href="#cb84-112" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb84-113"><a href="#cb84-113" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">"mwp"</span>, <span class="at">package =</span> <span class="st">"feisr"</span>)</span>
<span id="cb84-114"><a href="#cb84-114" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(mwp)</span>
<span id="cb84-115"><a href="#cb84-115" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb84-116"><a href="#cb84-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-117"><a href="#cb84-117" aria-hidden="true" tabindex="-1"></a>The data set contains a unique person identifier (<span class="in">`id`</span>) and survey year indicator (<span class="in">`year`</span>). Furthermore, we have information about the log hourly wage rate (<span class="in">`lnwage`</span>), work experience (<span class="in">`exp`</span>) and its square (<span class="in">`expq`</span>), family status (<span class="in">`marry`</span>), enrollment in current education (<span class="in">`enrol`</span>), years of formal education education (<span class="in">`yeduc`</span>), age (<span class="in">`age`</span>), birth cohort (<span class="in">`cohort`</span>), and a grouped year indicator (<span class="in">`yeargr`</span>).</span>
<span id="cb84-118"><a href="#cb84-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-119"><a href="#cb84-119" aria-hidden="true" tabindex="-1"></a>we exemplary investigate the 'marriage wage premium': we analyze whether marriage leads to an increase in the hourly wage for men. We use the function <span class="in">`feis`</span> to estimate fixed effects individual slope models to control for the hypothesis that those men who are more likely to marry or marry earlier, also have a steeper wage growth over time.</span>
<span id="cb84-120"><a href="#cb84-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-121"><a href="#cb84-121" aria-hidden="true" tabindex="-1"></a>Let's start with our most common panel models (FE and RE):</span>
<span id="cb84-122"><a href="#cb84-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-125"><a href="#cb84-125" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb84-126"><a href="#cb84-126" aria-hidden="true" tabindex="-1"></a>wages.fe <span class="ot">&lt;-</span> <span class="fu">plm</span>(lnw <span class="sc">~</span> marry <span class="sc">+</span> enrol <span class="sc">+</span> yeduc <span class="sc">+</span> <span class="fu">as.factor</span>(yeargr)</span>
<span id="cb84-127"><a href="#cb84-127" aria-hidden="true" tabindex="-1"></a>                <span class="sc">+</span> exp <span class="sc">+</span> <span class="fu">I</span>(exp<span class="sc">^</span><span class="dv">2</span>), <span class="at">data =</span> mwp, <span class="at">index =</span> <span class="fu">c</span>(<span class="st">"id"</span>, <span class="st">"year"</span>),</span>
<span id="cb84-128"><a href="#cb84-128" aria-hidden="true" tabindex="-1"></a>                <span class="at">model =</span> <span class="st">"within"</span>, <span class="at">effect =</span> <span class="st">"individual"</span>)</span>
<span id="cb84-129"><a href="#cb84-129" aria-hidden="true" tabindex="-1"></a>wages.re <span class="ot">&lt;-</span> <span class="fu">plm</span>(lnw <span class="sc">~</span> marry <span class="sc">+</span> enrol <span class="sc">+</span> yeduc <span class="sc">+</span> <span class="fu">as.factor</span>(yeargr)</span>
<span id="cb84-130"><a href="#cb84-130" aria-hidden="true" tabindex="-1"></a>                <span class="sc">+</span> exp <span class="sc">+</span> <span class="fu">I</span>(exp<span class="sc">^</span><span class="dv">2</span>), <span class="at">data =</span> mwp, <span class="at">index =</span> <span class="fu">c</span>(<span class="st">"id"</span>, <span class="st">"year"</span>),</span>
<span id="cb84-131"><a href="#cb84-131" aria-hidden="true" tabindex="-1"></a>                <span class="at">model =</span> <span class="st">"random"</span>, <span class="at">effect =</span> <span class="st">"individual"</span>)</span>
<span id="cb84-132"><a href="#cb84-132" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(wages.fe)</span>
<span id="cb84-133"><a href="#cb84-133" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb84-134"><a href="#cb84-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-135"><a href="#cb84-135" aria-hidden="true" tabindex="-1"></a>and we calculate panel robust standard errors and attach them back to the model output:</span>
<span id="cb84-136"><a href="#cb84-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-139"><a href="#cb84-139" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb84-140"><a href="#cb84-140" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate vcov</span></span>
<span id="cb84-141"><a href="#cb84-141" aria-hidden="true" tabindex="-1"></a>vcovx_fe <span class="ot">&lt;-</span> <span class="fu">vcovHC</span>(wages.fe, <span class="at">cluster =</span> <span class="st">"group"</span>, <span class="at">method =</span> <span class="st">"arellano"</span>, <span class="at">type =</span> <span class="st">"HC3"</span>)</span>
<span id="cb84-142"><a href="#cb84-142" aria-hidden="true" tabindex="-1"></a>vcovx_re <span class="ot">&lt;-</span> <span class="fu">vcovHC</span>(wages.re, <span class="at">cluster =</span> <span class="st">"group"</span>, <span class="at">method =</span> <span class="st">"arellano"</span>, <span class="at">type =</span> <span class="st">"HC3"</span>)</span>
<span id="cb84-143"><a href="#cb84-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-144"><a href="#cb84-144" aria-hidden="true" tabindex="-1"></a><span class="co"># Replace original vcov in output</span></span>
<span id="cb84-145"><a href="#cb84-145" aria-hidden="true" tabindex="-1"></a>wages.fe<span class="sc">$</span>vcov <span class="ot">&lt;-</span> vcovx_fe</span>
<span id="cb84-146"><a href="#cb84-146" aria-hidden="true" tabindex="-1"></a>wages.re<span class="sc">$</span>vcov <span class="ot">&lt;-</span> vcovx_re</span>
<span id="cb84-147"><a href="#cb84-147" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb84-148"><a href="#cb84-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-149"><a href="#cb84-149" aria-hidden="true" tabindex="-1"></a>Replacing the vcov in the model output has the advantage that we now use the cluster robust SEs in all following operations (like <span class="in">`summary()`</span> or <span class="in">`screenreg`</span>).</span>
<span id="cb84-150"><a href="#cb84-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-153"><a href="#cb84-153" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb84-154"><a href="#cb84-154" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(wages.fe)</span>
<span id="cb84-155"><a href="#cb84-155" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb84-156"><a href="#cb84-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-157"><a href="#cb84-157" aria-hidden="true" tabindex="-1"></a>And finally, we allow for individual specific trends. To replicate the analysis of @Ludwig.2018, we use work experience (<span class="in">`exp`</span>) and squared work experience as the slope variables.</span>
<span id="cb84-158"><a href="#cb84-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-159"><a href="#cb84-159" aria-hidden="true" tabindex="-1"></a>__One mayor advantage of using work experience as slope is that we can still control for (grouped) time fixed effects__</span>
<span id="cb84-160"><a href="#cb84-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-161"><a href="#cb84-161" aria-hidden="true" tabindex="-1"></a>__Assuming linear trends (only using exp), is a strong assumption. However, for each additional slope (e.g. polynomial), FEIS becomes more data hungry: each individual needs at least $T \geq K + 1$ observations to contribute to the model. If not, they are dropped!__</span>
<span id="cb84-162"><a href="#cb84-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-163"><a href="#cb84-163" aria-hidden="true" tabindex="-1"></a>Here we use <span class="in">`feis`</span> with panel robust standard errors. The command <span class="in">`felm`</span> from <span class="in">`lfe`</span> can be used to calculate individual slopes as well.</span>
<span id="cb84-164"><a href="#cb84-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-167"><a href="#cb84-167" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb84-168"><a href="#cb84-168" aria-hidden="true" tabindex="-1"></a>wages.feis <span class="ot">&lt;-</span> <span class="fu">feis</span>(lnw <span class="sc">~</span> marry <span class="sc">+</span> enrol <span class="sc">+</span> yeduc <span class="sc">+</span> <span class="fu">as.factor</span>(yeargr)</span>
<span id="cb84-169"><a href="#cb84-169" aria-hidden="true" tabindex="-1"></a>                   <span class="sc">|</span> exp <span class="sc">+</span> <span class="fu">I</span>(exp<span class="sc">^</span><span class="dv">2</span>), <span class="at">data =</span> mwp, <span class="at">id =</span> <span class="st">"id"</span>,</span>
<span id="cb84-170"><a href="#cb84-170" aria-hidden="true" tabindex="-1"></a>                   <span class="at">robust =</span> <span class="cn">TRUE</span>)</span>
<span id="cb84-171"><a href="#cb84-171" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(wages.feis)</span>
<span id="cb84-172"><a href="#cb84-172" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb84-173"><a href="#cb84-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-174"><a href="#cb84-174" aria-hidden="true" tabindex="-1"></a>Let's compare the results.</span>
<span id="cb84-175"><a href="#cb84-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-178"><a href="#cb84-178" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb84-179"><a href="#cb84-179" aria-hidden="true" tabindex="-1"></a><span class="fu">screenreg</span>(<span class="fu">list</span>(wages.re, wages.fe, wages.feis), <span class="at">digits =</span> <span class="dv">3</span>,</span>
<span id="cb84-180"><a href="#cb84-180" aria-hidden="true" tabindex="-1"></a>          <span class="at">custom.model.names =</span> <span class="fu">c</span>(<span class="st">"RE"</span>, <span class="st">"FE"</span>, <span class="st">"FEIS"</span>))</span>
<span id="cb84-181"><a href="#cb84-181" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb84-182"><a href="#cb84-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-183"><a href="#cb84-183" aria-hidden="true" tabindex="-1"></a>Interpretation:</span>
<span id="cb84-184"><a href="#cb84-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-185"><a href="#cb84-185" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>RE: Married observations have a significantly higher wage than unmarried observations.</span>
<span id="cb84-186"><a href="#cb84-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-187"><a href="#cb84-187" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>FE: If people marry, they experience an increase in wages afterwards. The effect is significant and slightly lower than the RE.</span>
<span id="cb84-188"><a href="#cb84-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-189"><a href="#cb84-189" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>FEIS: Accounting for the individual wage trend before marriage, we do not observe an increase in wages if people marry. The effect is small and non-significant.</span>
<span id="cb84-190"><a href="#cb84-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-191"><a href="#cb84-191" aria-hidden="true" tabindex="-1"></a>Overall, this indicates that there is a problem with non-parallel trends: Those with steeper wage trajectories are more likely to marry (or marry earlier).</span>
<span id="cb84-192"><a href="#cb84-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-193"><a href="#cb84-193" aria-hidden="true" tabindex="-1"></a>As mentioned above, we can achieve the same by 1) manually calculating the individual specific trends and 2) including them as additional covariates in the model.</span>
<span id="cb84-194"><a href="#cb84-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-197"><a href="#cb84-197" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb84-198"><a href="#cb84-198" aria-hidden="true" tabindex="-1"></a><span class="do">### Individual predicted value of covariates</span></span>
<span id="cb84-199"><a href="#cb84-199" aria-hidden="true" tabindex="-1"></a>vars <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"marry"</span>, <span class="st">"enrol"</span>, <span class="st">"yeduc"</span>, </span>
<span id="cb84-200"><a href="#cb84-200" aria-hidden="true" tabindex="-1"></a>          <span class="st">"yeargr2"</span>, <span class="st">"yeargr3"</span>, <span class="st">"yeargr4"</span>, <span class="st">"yeargr5"</span>)</span>
<span id="cb84-201"><a href="#cb84-201" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(v <span class="cf">in</span> vars){</span>
<span id="cb84-202"><a href="#cb84-202" aria-hidden="true" tabindex="-1"></a>  fm <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="fu">paste</span>(v, <span class="st">"~ exp + expq"</span>))</span>
<span id="cb84-203"><a href="#cb84-203" aria-hidden="true" tabindex="-1"></a>  pred_x <span class="ot">&lt;-</span> <span class="fu">by</span>(mwp[, <span class="fu">c</span>(v, <span class="st">"exp"</span>, <span class="st">"expq"</span>)],</span>
<span id="cb84-204"><a href="#cb84-204" aria-hidden="true" tabindex="-1"></a>                mwp<span class="sc">$</span>id,</span>
<span id="cb84-205"><a href="#cb84-205" aria-hidden="true" tabindex="-1"></a>                <span class="at">FUN =</span> <span class="cf">function</span>(z) <span class="fu">predict</span>(<span class="fu">lm</span>(fm, <span class="at">data =</span> z)))</span>
<span id="cb84-206"><a href="#cb84-206" aria-hidden="true" tabindex="-1"></a>  pred_x <span class="ot">&lt;-</span> <span class="fu">unlist</span>(pred_x)</span>
<span id="cb84-207"><a href="#cb84-207" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb84-208"><a href="#cb84-208" aria-hidden="true" tabindex="-1"></a>  mwp[, <span class="fu">paste0</span>(<span class="st">"pred_"</span>, v)] <span class="ot">&lt;-</span> pred_x</span>
<span id="cb84-209"><a href="#cb84-209" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb84-210"><a href="#cb84-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-211"><a href="#cb84-211" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(mwp[, <span class="fu">c</span>(<span class="st">"id"</span>, <span class="st">"pred_marry"</span>, <span class="st">"pred_enrol"</span>)], <span class="at">n =</span> <span class="dv">20</span>)</span>
<span id="cb84-212"><a href="#cb84-212" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb84-213"><a href="#cb84-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-214"><a href="#cb84-214" aria-hidden="true" tabindex="-1"></a>This gives us individual-specific predicted values of each covariate based on and intercept, exp and expsq. Note that - in contrast to person-specific means - these predicted values (can) vary within a person.</span>
<span id="cb84-215"><a href="#cb84-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-216"><a href="#cb84-216" aria-hidden="true" tabindex="-1"></a>Do you know why person-id 2 has all zeros on the pre_marry variable? </span>
<span id="cb84-217"><a href="#cb84-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-218"><a href="#cb84-218" aria-hidden="true" tabindex="-1"></a>Using these individual predicted values, we can retreive the FEIS estimates in a Mundlak-style model.</span>
<span id="cb84-219"><a href="#cb84-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-222"><a href="#cb84-222" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb84-223"><a href="#cb84-223" aria-hidden="true" tabindex="-1"></a>wages.lmfeis <span class="ot">&lt;-</span> <span class="fu">lm</span>(lnw <span class="sc">~</span> marry <span class="sc">+</span> enrol <span class="sc">+</span> yeduc <span class="sc">+</span> <span class="fu">as.factor</span>(yeargr) <span class="sc">+</span></span>
<span id="cb84-224"><a href="#cb84-224" aria-hidden="true" tabindex="-1"></a>                     pred_marry <span class="sc">+</span> pred_enrol <span class="sc">+</span> pred_yeduc <span class="sc">+</span></span>
<span id="cb84-225"><a href="#cb84-225" aria-hidden="true" tabindex="-1"></a>                     pred_yeargr2 <span class="sc">+</span> pred_yeargr3 <span class="sc">+</span> pred_yeargr4 <span class="sc">+</span> pred_yeargr5,</span>
<span id="cb84-226"><a href="#cb84-226" aria-hidden="true" tabindex="-1"></a>                   <span class="at">data =</span> mwp)</span>
<span id="cb84-227"><a href="#cb84-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-228"><a href="#cb84-228" aria-hidden="true" tabindex="-1"></a><span class="fu">screenreg</span>(<span class="fu">list</span>(wages.feis, wages.lmfeis), <span class="at">digits =</span> <span class="dv">3</span>,</span>
<span id="cb84-229"><a href="#cb84-229" aria-hidden="true" tabindex="-1"></a>          <span class="at">custom.model.names =</span> <span class="fu">c</span>(<span class="st">"FEIS"</span>, <span class="st">"Manual FEIS"</span>))</span>
<span id="cb84-230"><a href="#cb84-230" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb84-231"><a href="#cb84-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-232"><a href="#cb84-232" aria-hidden="true" tabindex="-1"></a>Note, however, that this manual approach will lead to incorrect standard errors!</span>
<span id="cb84-233"><a href="#cb84-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-234"><a href="#cb84-234" aria-hidden="true" tabindex="-1"></a><span class="fu"># Dynamic treatment effects</span></span>
<span id="cb84-235"><a href="#cb84-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-236"><a href="#cb84-236" aria-hidden="true" tabindex="-1"></a>Often, we are not only interested in the overall treatment effect, but we also want to know how treatment effects unfold after a treatment. For example, how does happiness change around specific life course events <span class="co">[</span><span class="ot">@Clark.2013</span><span class="co">]</span>, or how do housing prices develop after the opening of an industrial plant <span class="co">[</span><span class="ot">@Currie.2015</span><span class="co">]</span>?</span>
<span id="cb84-237"><a href="#cb84-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-238"><a href="#cb84-238" aria-hidden="true" tabindex="-1"></a>There are various ways of calculating how a treatment effect develops over time:</span>
<span id="cb84-239"><a href="#cb84-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-240"><a href="#cb84-240" aria-hidden="true" tabindex="-1"></a>!<span class="co">[</span><span class="ot">Various impact functions for event study designs from [Brüderl/Ludwig 2019 teaching materials](https://www.ls3.soziologie.uni-muenchen.de/studium-lehre/archiv/teaching-marterials/panel-analysis_april-2019.pdf)</span><span class="co">](fig/Impact-function.PNG)</span></span>
<span id="cb84-241"><a href="#cb84-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-242"><a href="#cb84-242" aria-hidden="true" tabindex="-1"></a>Usually, it is best to not impose a structural form, but rather to use dummy impact functions. However, even with this, there is an ongoing debate on what is the best choice of specification <span class="co">[</span><span class="ot">@Ludwig.2021</span><span class="co">]</span>, or see for instance <span class="co">[</span><span class="ot">blog post by Pedro H. C. Sant’Anna and Brantly Callaway</span><span class="co">](https://pedrohcgs.github.io/posts/twfe)</span>.</span>
<span id="cb84-243"><a href="#cb84-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-244"><a href="#cb84-244" aria-hidden="true" tabindex="-1"></a>__Note that these settings usually require a staggered treatment adoption: individuals are treated once, and afterwards remain treated__</span>
<span id="cb84-245"><a href="#cb84-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-246"><a href="#cb84-246" aria-hidden="true" tabindex="-1"></a>There are many cases where this does not apply. However, one can think about potential ways of artificially creating such designs:</span>
<span id="cb84-247"><a href="#cb84-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-248"><a href="#cb84-248" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Dichotomize continuous treatments (if theoretically plausible!)</span>
<span id="cb84-249"><a href="#cb84-249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-250"><a href="#cb84-250" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Create id-period splits. E.g. if a person gets divorced, either drop from sample, or treat as a "new id" as a person can re-marry (note that this assumes that first and second marriage have equal effects).</span>
<span id="cb84-251"><a href="#cb84-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-252"><a href="#cb84-252" aria-hidden="true" tabindex="-1"></a><span class="fu">### Example</span></span>
<span id="cb84-253"><a href="#cb84-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-254"><a href="#cb84-254" aria-hidden="true" tabindex="-1"></a>We stick with our example and try to estimate how the wage changes around the year of marriage.</span>
<span id="cb84-255"><a href="#cb84-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-256"><a href="#cb84-256" aria-hidden="true" tabindex="-1"></a>To do so, we first make sure the data is ordered by id and time</span>
<span id="cb84-257"><a href="#cb84-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-260"><a href="#cb84-260" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb84-261"><a href="#cb84-261" aria-hidden="true" tabindex="-1"></a>mwp <span class="ot">&lt;-</span> mwp[<span class="fu">order</span>(mwp<span class="sc">$</span>id, mwp<span class="sc">$</span>year), ]</span>
<span id="cb84-262"><a href="#cb84-262" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(mwp[, <span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>], <span class="at">n =</span> <span class="dv">20</span>)</span>
<span id="cb84-263"><a href="#cb84-263" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb84-264"><a href="#cb84-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-265"><a href="#cb84-265" aria-hidden="true" tabindex="-1"></a>Then, we make sure that our data looks like a staggered treatment design. Are there people who jump from married to not married in the data?</span>
<span id="cb84-266"><a href="#cb84-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-269"><a href="#cb84-269" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb84-270"><a href="#cb84-270" aria-hidden="true" tabindex="-1"></a><span class="co"># Change in marriage status within an id</span></span>
<span id="cb84-271"><a href="#cb84-271" aria-hidden="true" tabindex="-1"></a>mwp<span class="sc">$</span>fd_marry <span class="ot">&lt;-</span> <span class="fu">ave</span>(mwp<span class="sc">$</span>marry,</span>
<span id="cb84-272"><a href="#cb84-272" aria-hidden="true" tabindex="-1"></a>                    mwp<span class="sc">$</span>id,</span>
<span id="cb84-273"><a href="#cb84-273" aria-hidden="true" tabindex="-1"></a>                    <span class="at">FUN =</span> <span class="cf">function</span>(x) x <span class="sc">-</span> dplyr<span class="sc">::</span><span class="fu">lag</span>(x, <span class="dv">1</span>, <span class="at">default =</span> <span class="dv">0</span>)) <span class="co"># 0 insteat of NA for 1st year</span></span>
<span id="cb84-274"><a href="#cb84-274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-275"><a href="#cb84-275" aria-hidden="true" tabindex="-1"></a><span class="co"># Mark observations starting with a negative fd value (jump from marry=1 to marry =0)</span></span>
<span id="cb84-276"><a href="#cb84-276" aria-hidden="true" tabindex="-1"></a>mwp<span class="sc">$</span>notstag_marry <span class="ot">&lt;-</span> <span class="fu">ave</span>(<span class="fu">ifelse</span>(mwp<span class="sc">$</span>fd_marry <span class="sc">==</span> <span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb84-277"><a href="#cb84-277" aria-hidden="true" tabindex="-1"></a>                         mwp<span class="sc">$</span>id,</span>
<span id="cb84-278"><a href="#cb84-278" aria-hidden="true" tabindex="-1"></a>                         <span class="at">FUN =</span> <span class="cf">function</span>(x) <span class="fu">cumsum</span>(x))</span>
<span id="cb84-279"><a href="#cb84-279" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(mwp<span class="sc">$</span>fd_marry)</span>
<span id="cb84-280"><a href="#cb84-280" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(mwp<span class="sc">$</span>notstag_marry)</span>
<span id="cb84-281"><a href="#cb84-281" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb84-282"><a href="#cb84-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-283"><a href="#cb84-283" aria-hidden="true" tabindex="-1"></a>Luckily, the dataset is already cleaned: there are only transitions into marriage, not out of marriage.</span>
<span id="cb84-284"><a href="#cb84-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-285"><a href="#cb84-285" aria-hidden="true" tabindex="-1"></a>Next we want to make sure if there are any individuals who already start with the treatment (who are married right from their first wave on).</span>
<span id="cb84-286"><a href="#cb84-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-287"><a href="#cb84-287" aria-hidden="true" tabindex="-1"></a>__We only want to have those in our sample who potentially can go from not-treated to treated!__</span>
<span id="cb84-288"><a href="#cb84-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-291"><a href="#cb84-291" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb84-292"><a href="#cb84-292" aria-hidden="true" tabindex="-1"></a>mwp <span class="ot">&lt;-</span> mwp[<span class="fu">order</span>(mwp<span class="sc">$</span>id, mwp<span class="sc">$</span>year), ] <span class="co"># just to be sure</span></span>
<span id="cb84-293"><a href="#cb84-293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-294"><a href="#cb84-294" aria-hidden="true" tabindex="-1"></a><span class="co"># Person year number</span></span>
<span id="cb84-295"><a href="#cb84-295" aria-hidden="true" tabindex="-1"></a>mwp<span class="sc">$</span>pynr <span class="ot">&lt;-</span> <span class="fu">ave</span>(mwp<span class="sc">$</span>year,</span>
<span id="cb84-296"><a href="#cb84-296" aria-hidden="true" tabindex="-1"></a>                mwp<span class="sc">$</span>id,</span>
<span id="cb84-297"><a href="#cb84-297" aria-hidden="true" tabindex="-1"></a>                <span class="at">FUN =</span> <span class="cf">function</span>(x) <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(x))</span>
<span id="cb84-298"><a href="#cb84-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-299"><a href="#cb84-299" aria-hidden="true" tabindex="-1"></a><span class="co"># Marry status at first wave</span></span>
<span id="cb84-300"><a href="#cb84-300" aria-hidden="true" tabindex="-1"></a>mwp<span class="sc">$</span>f_marry <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(mwp<span class="sc">$</span>pynr <span class="sc">==</span> <span class="dv">1</span>, mwp<span class="sc">$</span>marry, <span class="cn">NA</span>)</span>
<span id="cb84-301"><a href="#cb84-301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-302"><a href="#cb84-302" aria-hidden="true" tabindex="-1"></a><span class="co"># Distribute across individual, using mean and na.rm = TRUE</span></span>
<span id="cb84-303"><a href="#cb84-303" aria-hidden="true" tabindex="-1"></a>mwp<span class="sc">$</span>f_marry <span class="ot">&lt;-</span> <span class="fu">ave</span>(mwp<span class="sc">$</span>f_marry,</span>
<span id="cb84-304"><a href="#cb84-304" aria-hidden="true" tabindex="-1"></a>                   mwp<span class="sc">$</span>id,</span>
<span id="cb84-305"><a href="#cb84-305" aria-hidden="true" tabindex="-1"></a>                   <span class="at">FUN =</span> <span class="cf">function</span>(x) <span class="fu">mean</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb84-306"><a href="#cb84-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-307"><a href="#cb84-307" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(mwp<span class="sc">$</span>f_marry)</span>
<span id="cb84-308"><a href="#cb84-308" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb84-309"><a href="#cb84-309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-310"><a href="#cb84-310" aria-hidden="true" tabindex="-1"></a>Again, someone has already done the job. There are no individuals who start married in the first wave.</span>
<span id="cb84-311"><a href="#cb84-311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-312"><a href="#cb84-312" aria-hidden="true" tabindex="-1"></a>We can also look at this graphically with <span class="in">`panelView`</span> (mainly helpful for small N data):</span>
<span id="cb84-313"><a href="#cb84-313" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-314"><a href="#cb84-314" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.height = 10, fig.width = 5}</span></span>
<span id="cb84-315"><a href="#cb84-315" aria-hidden="true" tabindex="-1"></a><span class="fu">panelview</span>(lnw <span class="sc">~</span> marry, </span>
<span id="cb84-316"><a href="#cb84-316" aria-hidden="true" tabindex="-1"></a>          <span class="at">data =</span> mwp, <span class="at">index =</span> <span class="fu">c</span>(<span class="st">"id"</span>,<span class="st">"year"</span>),</span>
<span id="cb84-317"><a href="#cb84-317" aria-hidden="true" tabindex="-1"></a>          <span class="at">type =</span> <span class="st">"treat"</span>, <span class="at">theme.bw =</span> <span class="cn">TRUE</span>)</span>
<span id="cb84-318"><a href="#cb84-318" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb84-319"><a href="#cb84-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-320"><a href="#cb84-320" aria-hidden="true" tabindex="-1"></a>Alright, so lets create a dummy impact function / a count variable around the treatment.</span>
<span id="cb84-321"><a href="#cb84-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-324"><a href="#cb84-324" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb84-325"><a href="#cb84-325" aria-hidden="true" tabindex="-1"></a>mwp <span class="ot">&lt;-</span> mwp[<span class="fu">order</span>(mwp<span class="sc">$</span>id, mwp<span class="sc">$</span>year), ] <span class="co"># just to be sure!!</span></span>
<span id="cb84-326"><a href="#cb84-326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-327"><a href="#cb84-327" aria-hidden="true" tabindex="-1"></a><span class="co"># Function that creates distance to the treatment (assuming 0=control, 1=treated)</span></span>
<span id="cb84-328"><a href="#cb84-328" aria-hidden="true" tabindex="-1"></a>impfun <span class="ot">&lt;-</span> <span class="cf">function</span>(x, <span class="at">default =</span> <span class="sc">-</span><span class="dv">99</span>){</span>
<span id="cb84-329"><a href="#cb84-329" aria-hidden="true" tabindex="-1"></a>  nas <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">is.na</span>(x))  <span class="co">#save nas</span></span>
<span id="cb84-330"><a href="#cb84-330" aria-hidden="true" tabindex="-1"></a>  ft <span class="ot">&lt;-</span> <span class="fu">which</span>(x <span class="sc">==</span> <span class="dv">1</span>)[<span class="dv">1</span>]  <span class="co">#first teatment index</span></span>
<span id="cb84-331"><a href="#cb84-331" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.na</span>(ft)){          <span class="co">#replicate default if never treated</span></span>
<span id="cb84-332"><a href="#cb84-332" aria-hidden="true" tabindex="-1"></a>    count <span class="ot">&lt;-</span> <span class="fu">rep</span>(default, <span class="fu">length</span>(x))</span>
<span id="cb84-333"><a href="#cb84-333" aria-hidden="true" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb84-334"><a href="#cb84-334" aria-hidden="true" tabindex="-1"></a>    ri <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(x)       <span class="co">#running index</span></span>
<span id="cb84-335"><a href="#cb84-335" aria-hidden="true" tabindex="-1"></a>    count <span class="ot">&lt;-</span> ri <span class="sc">-</span> ft        <span class="co">#distance to first treatment</span></span>
<span id="cb84-336"><a href="#cb84-336" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb84-337"><a href="#cb84-337" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">length</span>(nas) <span class="sc">!=</span> <span class="dv">0</span>){   <span class="co">#replace nas if any</span></span>
<span id="cb84-338"><a href="#cb84-338" aria-hidden="true" tabindex="-1"></a>    count[nas] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb84-339"><a href="#cb84-339" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb84-340"><a href="#cb84-340" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(count)           <span class="co">#return counter</span></span>
<span id="cb84-341"><a href="#cb84-341" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb84-342"><a href="#cb84-342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-343"><a href="#cb84-343" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply to each individual</span></span>
<span id="cb84-344"><a href="#cb84-344" aria-hidden="true" tabindex="-1"></a>mwp<span class="sc">$</span>marry_if <span class="ot">&lt;-</span> <span class="fu">ave</span>(mwp<span class="sc">$</span>marry,</span>
<span id="cb84-345"><a href="#cb84-345" aria-hidden="true" tabindex="-1"></a>                    mwp<span class="sc">$</span>id,</span>
<span id="cb84-346"><a href="#cb84-346" aria-hidden="true" tabindex="-1"></a>                    <span class="at">FUN =</span> <span class="cf">function</span>(x) <span class="fu">impfun</span>(x))</span>
<span id="cb84-347"><a href="#cb84-347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-348"><a href="#cb84-348" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(mwp[, <span class="fu">c</span>(<span class="st">"id"</span>, <span class="st">"year"</span>, <span class="st">"marry"</span>, <span class="st">"marry_if"</span>)], <span class="at">n =</span> <span class="dv">50</span>)</span>
<span id="cb84-349"><a href="#cb84-349" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb84-350"><a href="#cb84-350" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-351"><a href="#cb84-351" aria-hidden="true" tabindex="-1"></a>We can now use this time count function to estimate dynamic treatment effects. </span>
<span id="cb84-352"><a href="#cb84-352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-353"><a href="#cb84-353" aria-hidden="true" tabindex="-1"></a>Note that we need to make to important decisions (<span class="co">[</span><span class="ot">blog post by Pedro H. C. Sant’Anna and Brantly Callaway</span><span class="co">](https://pedrohcgs.github.io/posts/twfe)</span>):</span>
<span id="cb84-354"><a href="#cb84-354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-355"><a href="#cb84-355" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Which dates to use a reference category</span>
<span id="cb84-356"><a href="#cb84-356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-357"><a href="#cb84-357" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>How many pre-treatment periods to include (to test for anticipation or potential pre-treatment differences)</span>
<span id="cb84-358"><a href="#cb84-358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-359"><a href="#cb84-359" aria-hidden="true" tabindex="-1"></a>Here, re will just include three periods before marriage and use the rest as reference categories</span>
<span id="cb84-360"><a href="#cb84-360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-363"><a href="#cb84-363" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb84-364"><a href="#cb84-364" aria-hidden="true" tabindex="-1"></a><span class="co"># Set all before -3 to -99</span></span>
<span id="cb84-365"><a href="#cb84-365" aria-hidden="true" tabindex="-1"></a>mwp<span class="sc">$</span>marry_if[mwp<span class="sc">$</span>marry_if <span class="sc">&lt;</span> <span class="sc">-</span><span class="dv">3</span> <span class="sc">&amp;</span> mwp<span class="sc">$</span>marry_if <span class="sc">&gt;</span> <span class="sc">-</span><span class="dv">99</span>] <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">99</span></span>
<span id="cb84-366"><a href="#cb84-366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-367"><a href="#cb84-367" aria-hidden="true" tabindex="-1"></a><span class="co"># Make factor with -99 as reference category</span></span>
<span id="cb84-368"><a href="#cb84-368" aria-hidden="true" tabindex="-1"></a>mwp<span class="sc">$</span>marry_if <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(mwp<span class="sc">$</span>marry_if)</span>
<span id="cb84-369"><a href="#cb84-369" aria-hidden="true" tabindex="-1"></a>mwp<span class="sc">$</span>marry_if <span class="ot">&lt;-</span> <span class="fu">relevel</span>(mwp<span class="sc">$</span>marry_if, <span class="st">"-99"</span>)</span>
<span id="cb84-370"><a href="#cb84-370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-371"><a href="#cb84-371" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb84-372"><a href="#cb84-372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-373"><a href="#cb84-373" aria-hidden="true" tabindex="-1"></a>And we use this as our treatment variable in the FE estimator.</span>
<span id="cb84-374"><a href="#cb84-374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-377"><a href="#cb84-377" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb84-378"><a href="#cb84-378" aria-hidden="true" tabindex="-1"></a><span class="co"># Standard marriage indicator</span></span>
<span id="cb84-379"><a href="#cb84-379" aria-hidden="true" tabindex="-1"></a>wages.fe <span class="ot">&lt;-</span> <span class="fu">plm</span>(lnw <span class="sc">~</span> marry <span class="sc">+</span> enrol <span class="sc">+</span> yeduc <span class="sc">+</span> <span class="fu">as.factor</span>(yeargr)</span>
<span id="cb84-380"><a href="#cb84-380" aria-hidden="true" tabindex="-1"></a>                <span class="sc">+</span> exp <span class="sc">+</span> <span class="fu">I</span>(exp<span class="sc">^</span><span class="dv">2</span>), <span class="at">data =</span> mwp, <span class="at">index =</span> <span class="fu">c</span>(<span class="st">"id"</span>, <span class="st">"year"</span>),</span>
<span id="cb84-381"><a href="#cb84-381" aria-hidden="true" tabindex="-1"></a>                <span class="at">model =</span> <span class="st">"within"</span>, <span class="at">effect =</span> <span class="st">"individual"</span>)</span>
<span id="cb84-382"><a href="#cb84-382" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-383"><a href="#cb84-383" aria-hidden="true" tabindex="-1"></a><span class="co"># with dummy impact function</span></span>
<span id="cb84-384"><a href="#cb84-384" aria-hidden="true" tabindex="-1"></a>wages2.fe <span class="ot">&lt;-</span> <span class="fu">plm</span>(lnw <span class="sc">~</span> marry_if <span class="sc">+</span> enrol <span class="sc">+</span> yeduc <span class="sc">+</span> <span class="fu">as.factor</span>(yeargr)</span>
<span id="cb84-385"><a href="#cb84-385" aria-hidden="true" tabindex="-1"></a>                 <span class="sc">+</span> exp <span class="sc">+</span> <span class="fu">I</span>(exp<span class="sc">^</span><span class="dv">2</span>), <span class="at">data =</span> mwp, <span class="at">index =</span> <span class="fu">c</span>(<span class="st">"id"</span>, <span class="st">"year"</span>),</span>
<span id="cb84-386"><a href="#cb84-386" aria-hidden="true" tabindex="-1"></a>                 <span class="at">model =</span> <span class="st">"within"</span>, <span class="at">effect =</span> <span class="st">"individual"</span>)</span>
<span id="cb84-387"><a href="#cb84-387" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-388"><a href="#cb84-388" aria-hidden="true" tabindex="-1"></a><span class="co"># add cluster robust SEs</span></span>
<span id="cb84-389"><a href="#cb84-389" aria-hidden="true" tabindex="-1"></a>vcovx_fe2 <span class="ot">&lt;-</span> <span class="fu">vcovHC</span>(wages2.fe, <span class="at">cluster =</span> <span class="st">"group"</span>, <span class="at">method =</span> <span class="st">"arellano"</span>, <span class="at">type =</span> <span class="st">"HC3"</span>)</span>
<span id="cb84-390"><a href="#cb84-390" aria-hidden="true" tabindex="-1"></a>wages2.fe<span class="sc">$</span>vcov <span class="ot">&lt;-</span> vcovx_fe2</span>
<span id="cb84-391"><a href="#cb84-391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-392"><a href="#cb84-392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-393"><a href="#cb84-393" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(wages2.fe)</span>
<span id="cb84-394"><a href="#cb84-394" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb84-395"><a href="#cb84-395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-396"><a href="#cb84-396" aria-hidden="true" tabindex="-1"></a>Let's plot that</span>
<span id="cb84-397"><a href="#cb84-397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-400"><a href="#cb84-400" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb84-401"><a href="#cb84-401" aria-hidden="true" tabindex="-1"></a><span class="co"># Set up results matrix</span></span>
<span id="cb84-402"><a href="#cb84-402" aria-hidden="true" tabindex="-1"></a>coef.df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">matrix</span>(<span class="cn">NA</span>,</span>
<span id="cb84-403"><a href="#cb84-403" aria-hidden="true" tabindex="-1"></a>                  <span class="at">nrow =</span> (<span class="fu">length</span>(<span class="fu">levels</span>(mwp<span class="sc">$</span>marry_if)) <span class="sc">-</span> <span class="dv">1</span>),</span>
<span id="cb84-404"><a href="#cb84-404" aria-hidden="true" tabindex="-1"></a>                  <span class="at">ncol =</span> <span class="dv">3</span>))</span>
<span id="cb84-405"><a href="#cb84-405" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(coef.df) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"time"</span>, <span class="st">"att"</span>, <span class="st">"se"</span>)</span>
<span id="cb84-406"><a href="#cb84-406" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-407"><a href="#cb84-407" aria-hidden="true" tabindex="-1"></a><span class="co"># paste results</span></span>
<span id="cb84-408"><a href="#cb84-408" aria-hidden="true" tabindex="-1"></a>coef.df<span class="sc">$</span>time <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">3</span><span class="sc">:</span><span class="dv">14</span>)</span>
<span id="cb84-409"><a href="#cb84-409" aria-hidden="true" tabindex="-1"></a>output <span class="ot">&lt;-</span> <span class="fu">summary</span>(wages2.fe)<span class="sc">$</span>coefficients</span>
<span id="cb84-410"><a href="#cb84-410" aria-hidden="true" tabindex="-1"></a>coef.df[, <span class="fu">c</span>(<span class="st">"att"</span>, <span class="st">"se"</span>)] <span class="ot">&lt;-</span> output[<span class="fu">which</span>(<span class="fu">grepl</span>(<span class="st">"marry_if"</span>, <span class="fu">rownames</span>(output))), <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]</span>
<span id="cb84-411"><a href="#cb84-411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-412"><a href="#cb84-412" aria-hidden="true" tabindex="-1"></a><span class="co"># 95% CI</span></span>
<span id="cb84-413"><a href="#cb84-413" aria-hidden="true" tabindex="-1"></a>interval2  <span class="ot">&lt;-</span>  <span class="sc">-</span><span class="fu">qnorm</span>((<span class="dv">1</span><span class="fl">-0.95</span>)<span class="sc">/</span><span class="dv">2</span>)  <span class="co"># 95% multiplier</span></span>
<span id="cb84-414"><a href="#cb84-414" aria-hidden="true" tabindex="-1"></a>coef.df<span class="sc">$</span>ll <span class="ot">&lt;-</span> coef.df<span class="sc">$</span>att <span class="sc">-</span> coef.df<span class="sc">$</span>se<span class="sc">*</span>interval2</span>
<span id="cb84-415"><a href="#cb84-415" aria-hidden="true" tabindex="-1"></a>coef.df<span class="sc">$</span>ul <span class="ot">&lt;-</span> coef.df<span class="sc">$</span>att <span class="sc">+</span> coef.df<span class="sc">$</span>se<span class="sc">*</span>interval2</span>
<span id="cb84-416"><a href="#cb84-416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-417"><a href="#cb84-417" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb84-418"><a href="#cb84-418" aria-hidden="true" tabindex="-1"></a>zp1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(coef.df[coef.df<span class="sc">$</span>time <span class="sc">&lt;</span> <span class="dv">7</span>, ], </span>
<span id="cb84-419"><a href="#cb84-419" aria-hidden="true" tabindex="-1"></a>              <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> att)) <span class="sc">+</span>  </span>
<span id="cb84-420"><a href="#cb84-420" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_pointrange</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> att, <span class="at">ymin =</span> ll, <span class="at">ymax =</span> ul),</span>
<span id="cb84-421"><a href="#cb84-421" aria-hidden="true" tabindex="-1"></a>                                <span class="at">lwd =</span> <span class="dv">1</span>, <span class="at">fatten =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb84-422"><a href="#cb84-422" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> att)) <span class="sc">+</span></span>
<span id="cb84-423"><a href="#cb84-423" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">colour =</span> <span class="fu">gray</span>(<span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>), <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">lwd =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb84-424"><a href="#cb84-424" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="sc">-</span><span class="fl">0.5</span>, <span class="at">colour =</span> <span class="st">"black"</span>, <span class="at">lty =</span> <span class="dv">1</span>, <span class="at">lwd =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb84-425"><a href="#cb84-425" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb84-426"><a href="#cb84-426" aria-hidden="true" tabindex="-1"></a>zp1</span>
<span id="cb84-427"><a href="#cb84-427" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb84-428"><a href="#cb84-428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-429"><a href="#cb84-429" aria-hidden="true" tabindex="-1"></a>An interesting finding here. There is a positive anticipation effect: "The anticipation of marriage already increases the husbands wage".</span>
<span id="cb84-430"><a href="#cb84-430" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-431"><a href="#cb84-431" aria-hidden="true" tabindex="-1"></a>Is this plausible?</span>
<span id="cb84-432"><a href="#cb84-432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-433"><a href="#cb84-433" aria-hidden="true" tabindex="-1"></a>__FEIS__</span>
<span id="cb84-434"><a href="#cb84-434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-435"><a href="#cb84-435" aria-hidden="true" tabindex="-1"></a>Obviously, we can also use these dummy impact function in other estimators.</span>
<span id="cb84-436"><a href="#cb84-436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-437"><a href="#cb84-437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-440"><a href="#cb84-440" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb84-441"><a href="#cb84-441" aria-hidden="true" tabindex="-1"></a><span class="do">### FEIS with dummy impact function</span></span>
<span id="cb84-442"><a href="#cb84-442" aria-hidden="true" tabindex="-1"></a>wages2.feis <span class="ot">&lt;-</span> <span class="fu">feis</span>(lnw <span class="sc">~</span> marry_if <span class="sc">+</span> enrol <span class="sc">+</span> yeduc <span class="sc">+</span> <span class="fu">as.factor</span>(yeargr)</span>
<span id="cb84-443"><a href="#cb84-443" aria-hidden="true" tabindex="-1"></a>                   <span class="sc">|</span> exp <span class="sc">+</span> <span class="fu">I</span>(exp<span class="sc">^</span><span class="dv">2</span>), </span>
<span id="cb84-444"><a href="#cb84-444" aria-hidden="true" tabindex="-1"></a>                   <span class="at">data =</span> mwp, <span class="at">id =</span> <span class="st">"id"</span>,</span>
<span id="cb84-445"><a href="#cb84-445" aria-hidden="true" tabindex="-1"></a>                  <span class="at">robust =</span> <span class="cn">TRUE</span>)</span>
<span id="cb84-446"><a href="#cb84-446" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(wages2.feis)</span>
<span id="cb84-447"><a href="#cb84-447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-448"><a href="#cb84-448" aria-hidden="true" tabindex="-1"></a><span class="do">### Plot</span></span>
<span id="cb84-449"><a href="#cb84-449" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-450"><a href="#cb84-450" aria-hidden="true" tabindex="-1"></a><span class="co"># Set up results matrix</span></span>
<span id="cb84-451"><a href="#cb84-451" aria-hidden="true" tabindex="-1"></a>coef2.df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">matrix</span>(<span class="cn">NA</span>,</span>
<span id="cb84-452"><a href="#cb84-452" aria-hidden="true" tabindex="-1"></a>                  <span class="at">nrow =</span> (<span class="fu">length</span>(<span class="fu">levels</span>(mwp<span class="sc">$</span>marry_if)) <span class="sc">-</span> <span class="dv">1</span>),</span>
<span id="cb84-453"><a href="#cb84-453" aria-hidden="true" tabindex="-1"></a>                  <span class="at">ncol =</span> <span class="dv">3</span>))</span>
<span id="cb84-454"><a href="#cb84-454" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(coef2.df) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"time"</span>, <span class="st">"att"</span>, <span class="st">"se"</span>)</span>
<span id="cb84-455"><a href="#cb84-455" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-456"><a href="#cb84-456" aria-hidden="true" tabindex="-1"></a><span class="co"># paste results</span></span>
<span id="cb84-457"><a href="#cb84-457" aria-hidden="true" tabindex="-1"></a>coef2.df<span class="sc">$</span>time <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">3</span><span class="sc">:</span><span class="dv">14</span>)</span>
<span id="cb84-458"><a href="#cb84-458" aria-hidden="true" tabindex="-1"></a>output <span class="ot">&lt;-</span> <span class="fu">summary</span>(wages2.feis)<span class="sc">$</span>coefficients</span>
<span id="cb84-459"><a href="#cb84-459" aria-hidden="true" tabindex="-1"></a>coef2.df[, <span class="fu">c</span>(<span class="st">"att"</span>, <span class="st">"se"</span>)] <span class="ot">&lt;-</span> output[<span class="fu">which</span>(<span class="fu">grepl</span>(<span class="st">"marry_if"</span>, <span class="fu">rownames</span>(output))), <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]</span>
<span id="cb84-460"><a href="#cb84-460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-461"><a href="#cb84-461" aria-hidden="true" tabindex="-1"></a><span class="co"># 95% CI</span></span>
<span id="cb84-462"><a href="#cb84-462" aria-hidden="true" tabindex="-1"></a>interval2  <span class="ot">&lt;-</span>  <span class="sc">-</span><span class="fu">qnorm</span>((<span class="dv">1</span><span class="fl">-0.95</span>)<span class="sc">/</span><span class="dv">2</span>)  <span class="co"># 95% multiplier</span></span>
<span id="cb84-463"><a href="#cb84-463" aria-hidden="true" tabindex="-1"></a>coef2.df<span class="sc">$</span>ll <span class="ot">&lt;-</span> coef2.df<span class="sc">$</span>att <span class="sc">-</span> coef2.df<span class="sc">$</span>se<span class="sc">*</span>interval2</span>
<span id="cb84-464"><a href="#cb84-464" aria-hidden="true" tabindex="-1"></a>coef2.df<span class="sc">$</span>ul <span class="ot">&lt;-</span> coef2.df<span class="sc">$</span>att <span class="sc">+</span> coef2.df<span class="sc">$</span>se<span class="sc">*</span>interval2</span>
<span id="cb84-465"><a href="#cb84-465" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-466"><a href="#cb84-466" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb84-467"><a href="#cb84-467" aria-hidden="true" tabindex="-1"></a>zp2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(coef2.df[coef2.df<span class="sc">$</span>time <span class="sc">&lt;</span> <span class="dv">7</span>, ], </span>
<span id="cb84-468"><a href="#cb84-468" aria-hidden="true" tabindex="-1"></a>              <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> att)) <span class="sc">+</span>  </span>
<span id="cb84-469"><a href="#cb84-469" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_pointrange</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> att, <span class="at">ymin =</span> ll, <span class="at">ymax =</span> ul),</span>
<span id="cb84-470"><a href="#cb84-470" aria-hidden="true" tabindex="-1"></a>                                <span class="at">lwd =</span> <span class="dv">1</span>, <span class="at">fatten =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb84-471"><a href="#cb84-471" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> att)) <span class="sc">+</span></span>
<span id="cb84-472"><a href="#cb84-472" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">colour =</span> <span class="fu">gray</span>(<span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>), <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">lwd =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb84-473"><a href="#cb84-473" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="sc">-</span><span class="fl">0.5</span>, <span class="at">colour =</span> <span class="st">"black"</span>, <span class="at">lty =</span> <span class="dv">1</span>, <span class="at">lwd =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb84-474"><a href="#cb84-474" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb84-475"><a href="#cb84-475" aria-hidden="true" tabindex="-1"></a>zp2</span>
<span id="cb84-476"><a href="#cb84-476" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb84-477"><a href="#cb84-477" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-478"><a href="#cb84-478" aria-hidden="true" tabindex="-1"></a>This gives us what we already expected: using FEIS, the marital wage premium disappears.</span>
<span id="cb84-479"><a href="#cb84-479" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-480"><a href="#cb84-480" aria-hidden="true" tabindex="-1"></a><span class="fu"># Dynamic Diff-in-Diff</span></span>
<span id="cb84-481"><a href="#cb84-481" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-482"><a href="#cb84-482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-483"><a href="#cb84-483" aria-hidden="true" tabindex="-1"></a>Remember, we have defined the __2__ $\times$ __2 Diff-in-Diff__ as:</span>
<span id="cb84-484"><a href="#cb84-484" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-485"><a href="#cb84-485" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb84-486"><a href="#cb84-486" aria-hidden="true" tabindex="-1"></a>y_{it} = \alpha + \gamma D_{i} + \lambda Post_{t} + \delta_{DD} (D_{i} \times Post_{t}) + \upsilon_{it},</span>
<span id="cb84-487"><a href="#cb84-487" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb84-488"><a href="#cb84-488" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-489"><a href="#cb84-489" aria-hidden="true" tabindex="-1"></a>which we can easily estimate as:</span>
<span id="cb84-490"><a href="#cb84-490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-491"><a href="#cb84-491" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb84-492"><a href="#cb84-492" aria-hidden="true" tabindex="-1"></a>\hat{\delta}_{DD} = \E(\Delta y_{T}) - \E(\Delta y_{C}) = (\E(y_{T}^{post}) - \E(y_{T}^{pre})) - (\E(y_{C}^{post}) - \E(y_{C}^{pre})).</span>
<span id="cb84-493"><a href="#cb84-493" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb84-494"><a href="#cb84-494" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-495"><a href="#cb84-495" aria-hidden="true" tabindex="-1"></a>Moreover, we have written the __twoways FE__ estimator as:</span>
<span id="cb84-496"><a href="#cb84-496" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-497"><a href="#cb84-497" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb84-498"><a href="#cb84-498" aria-hidden="true" tabindex="-1"></a>y_{it} = \beta_{TWFE} D_{it} + \alpha_i + \zeta_t + \epsilon_{it},</span>
<span id="cb84-499"><a href="#cb84-499" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb84-500"><a href="#cb84-500" aria-hidden="true" tabindex="-1"></a>In a setting with only two time periods, a binary treatment, and all observations untreated in $t=1$, the Diff-in-Diff estimator equals the twoways FE estimator $\hat{\delta}_{DD} = \hat{\beta}_{TWFE}$. </span>
<span id="cb84-501"><a href="#cb84-501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-502"><a href="#cb84-502" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-503"><a href="#cb84-503" aria-hidden="true" tabindex="-1"></a>However, it is more complicated when we go beyond the 2 $\times$ 2 setting. There is an ongoing discussion on how the Difference in Differences estimator relates to the two-ways FE estimator when treatment timing varies: different individuals receive the treatment at different periods. </span>
<span id="cb84-504"><a href="#cb84-504" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-505"><a href="#cb84-505" aria-hidden="true" tabindex="-1"></a>Assume we can divide our setting into treatment groups (treated vs. control) and into timing groups (every observation treated in the same period form a timing group).</span>
<span id="cb84-506"><a href="#cb84-506" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-507"><a href="#cb84-507" aria-hidden="true" tabindex="-1"></a>@Goodman-Bacon.2021 shows that the two-ways FE is a weighted average of all possible two-group/two-period DD estimators. The weights determine how much each of these single combinations contributes to the two-ways FE are determined by the group size (e.g. how long do we observe each combination before and after treatment) and the variance in the treatment.</span>
<span id="cb84-508"><a href="#cb84-508" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-509"><a href="#cb84-509" aria-hidden="true" tabindex="-1"></a>!<span class="co">[</span><span class="ot">Two-ways FE and DD with varying treatment timing [@Goodman-Bacon.2021].</span><span class="co">](fig/goodman.jpg)</span></span>
<span id="cb84-510"><a href="#cb84-510" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-511"><a href="#cb84-511" aria-hidden="true" tabindex="-1"></a>In the example above we have three groups: 1) control / never treated ($C$), 2) early treated (at period $k$), and 3) late treated (at period $l$). Those who are treated in later time periods are not only compared to those who are never treated but also to those who have already been treated in earlier periods.</span>
<span id="cb84-512"><a href="#cb84-512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-513"><a href="#cb84-513" aria-hidden="true" tabindex="-1"></a>@Goodman-Bacon.2021 shows that this setting with three treatment groups consists of 4 possible 2 $\times$ 2 Diff-in-Diff settings.</span>
<span id="cb84-514"><a href="#cb84-514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-515"><a href="#cb84-515" aria-hidden="true" tabindex="-1"></a>Panels A) and B) compare $j = k,l$ against control group $C$, and can be written as:</span>
<span id="cb84-516"><a href="#cb84-516" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb84-517"><a href="#cb84-517" aria-hidden="true" tabindex="-1"></a>\hat{\delta}_{DD}^{jC} = (\E(y_{j}^{post(j)}) - \E(y_{j}^{pre(j)})) - (\E(y_{C}^{post}) - \E(y_{C}^{pre})), ~\text{with} ~ j = k,l. </span>
<span id="cb84-518"><a href="#cb84-518" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb84-519"><a href="#cb84-519" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-520"><a href="#cb84-520" aria-hidden="true" tabindex="-1"></a>Panel C) compares early treated $k$ against untreated periods of late treated $l$. Note that we replace the $POST$ period with period between treatment of the early treated and the late treated $MID(k,l)$</span>
<span id="cb84-521"><a href="#cb84-521" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb84-522"><a href="#cb84-522" aria-hidden="true" tabindex="-1"></a>\hat{\delta}_{DD}^{kl} = (\E(y_{k}^{MID(k,l)}) - \E(y_{k}^{pre(k)})) - (\E(y_{l}^{MID(k,l)}) - \E(y_{l}^{pre(k)})). </span>
<span id="cb84-523"><a href="#cb84-523" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb84-524"><a href="#cb84-524" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-525"><a href="#cb84-525" aria-hidden="true" tabindex="-1"></a>Panel D) compares late treated $l$ against already treated periods of early treated $k$. Note that we replace the $PRE$ period with period between treatment of the early treated and the late treated $MID(k,l)$</span>
<span id="cb84-526"><a href="#cb84-526" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb84-527"><a href="#cb84-527" aria-hidden="true" tabindex="-1"></a>\hat{\delta}_{DD}^{lk} = (\E(y_{l}^{post(l)}) - \E(y_{l}^{MID(k,l)})) - (\E(y_{k}^{post(l)}) - \E(y_{k}^{MID(k,l)})). </span>
<span id="cb84-528"><a href="#cb84-528" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb84-529"><a href="#cb84-529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-530"><a href="#cb84-530" aria-hidden="true" tabindex="-1"></a>THE twoways FE estimator can now be recovered as a weighted combinations of these four $2\times2$ Diff-in-Diff estimators.</span>
<span id="cb84-531"><a href="#cb84-531" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-532"><a href="#cb84-532" aria-hidden="true" tabindex="-1"></a>The __weights__ of each of them depend on </span>
<span id="cb84-533"><a href="#cb84-533" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-534"><a href="#cb84-534" aria-hidden="true" tabindex="-1"></a>a) __the number of periods each subsample uses__, and </span>
<span id="cb84-535"><a href="#cb84-535" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-536"><a href="#cb84-536" aria-hidden="true" tabindex="-1"></a>b) __the amount of treatment variance within each subsample__.</span>
<span id="cb84-537"><a href="#cb84-537" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-538"><a href="#cb84-538" aria-hidden="true" tabindex="-1"></a>Define $\bar{D}_{kl}$ as the mean of $D_{it}$ in the subsample that compares groups $k$ and $l$ - denoting the share of time the group spends treated -, and the relative size of each group in the pair $n_{kl} = \frac{n_k}{n_k + n_l}$. Further $\hat{V}_D$ equals the overal variance in $D_{it}$, and $\hat{V}_D^{jC}$ denotes the amount of identifying variation for comparison of groups $j$ and $C$. Then, the weights are given by:</span>
<span id="cb84-539"><a href="#cb84-539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-540"><a href="#cb84-540" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb84-541"><a href="#cb84-541" aria-hidden="true" tabindex="-1"></a>W_{jC} = \frac{(n_j + n_C)^2 \hat{V}_D^{jC}}{\hat{V}_D}, ~\text{with}~ \hat{V}_D^{jC} = n_{jC}(1-n_{jC}) \bar{D}_j(1-\bar{D}_j), ~for~ j = k,l. </span>
<span id="cb84-542"><a href="#cb84-542" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb84-543"><a href="#cb84-543" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-544"><a href="#cb84-544" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb84-545"><a href="#cb84-545" aria-hidden="true" tabindex="-1"></a>W_{kl} = \frac{\bigl( (n_k + n_l)(1-\bar{D}_l) \bigr)^2 \hat{V}_D^{kl}}{\hat{V}_D}, ~\text{with}~ \hat{V}_D^{kl} = n_{kl}(1-n_{kl}) \frac{\bar{D}_k-\bar{D}_l}{1-\bar{D}_l} \frac{1-\bar{D}_k}{1-\bar{D}_l}. </span>
<span id="cb84-546"><a href="#cb84-546" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb84-547"><a href="#cb84-547" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-548"><a href="#cb84-548" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb84-549"><a href="#cb84-549" aria-hidden="true" tabindex="-1"></a>W_{lk} = \frac{\bigl( (n_l + n_k)\bar{D}_k \bigr)^2 \hat{V}_D^{lk}}{\hat{V}_D}, ~\text{with}~ \hat{V}_D^{lk} = n_{lk}(1-n_{lk}) \frac{\bar{D}_l}{\bar{D}_k} \frac{\bar{D}_k-\bar{D}_l}{\bar{D}_k}. </span>
<span id="cb84-550"><a href="#cb84-550" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb84-551"><a href="#cb84-551" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-552"><a href="#cb84-552" aria-hidden="true" tabindex="-1"></a>If group-sizes are equal, then the treatment variance $\hat{V}_D$ in each combination group depends on the timing of the treatment. The variance get larger the more similar the groups sizes $n_{ju}$, and the more central (in the middle of the observation period) the treatment timing ($\bar{D}_k, \frac{\bar{D}_k-\bar{D}_l}{1-\bar{D}_l}, \frac{\bar{D}_l}{\bar{D}_k}$ close to 0.5).</span>
<span id="cb84-553"><a href="#cb84-553" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-554"><a href="#cb84-554" aria-hidden="true" tabindex="-1"></a>Note that __these weights are always positive__.</span>
<span id="cb84-555"><a href="#cb84-555" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-556"><a href="#cb84-556" aria-hidden="true" tabindex="-1"></a>QUESTION: Do you know which of the above groups A), B), C), D) get the highest weights in the example. Why?</span>
<span id="cb84-557"><a href="#cb84-557" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-558"><a href="#cb84-558" aria-hidden="true" tabindex="-1"></a><span class="fu">### Biased Estimates</span></span>
<span id="cb84-559"><a href="#cb84-559" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-560"><a href="#cb84-560" aria-hidden="true" tabindex="-1"></a>So why (or when) could this lead to problems with the twoways FE estimator? @deChaisemartin.2020 and @Sun.2021 criticize the TWFE on the grounds of negative weights of some subgroups / sub-effects, arguing that this may induce substantial bias in the case of heterogeneous treatment effects.</span>
<span id="cb84-561"><a href="#cb84-561" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-562"><a href="#cb84-562" aria-hidden="true" tabindex="-1"></a>@Goodman-Bacon.2021 also explains the observation of these "negative" weights:</span>
<span id="cb84-563"><a href="#cb84-563" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-564"><a href="#cb84-564" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; "Negative weights only arise when average treatment effects vary over time. The DD decomposition shows why: when already-treated units act as controls, changes in their outcomes are subtracted and these changes may include time-varying treatment effects. This does not imply a failure of the design in the sense of non-parallel trends in counterfactual outcomes, but it does suggest caution when using TWFE estimators to summarize treatment effects."</span></span>
<span id="cb84-565"><a href="#cb84-565" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-566"><a href="#cb84-566" aria-hidden="true" tabindex="-1"></a>Basically, if the treatment effect varies over time (e.g. treatment effect grows over time) TWFE might be biased because early treated groups (with an increasing treatment effect) are used as control groups for late treated groups, thereby masking the treatment effect of these late treated groups (which might however receive a high weight for the overall treatment effect).</span>
<span id="cb84-567"><a href="#cb84-567" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-568"><a href="#cb84-568" aria-hidden="true" tabindex="-1"></a>Especially for "trend-breaking" treatment effects like in the following figure, this will lead to biased estimates of the average treatment effect <span class="co">[</span><span class="ot">@Goodman-Bacon.2021; @Meer.2016</span><span class="co">]</span>.</span>
<span id="cb84-569"><a href="#cb84-569" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-570"><a href="#cb84-570" aria-hidden="true" tabindex="-1"></a>!<span class="co">[</span><span class="ot">Bias of two-ways FE with trend-breaking treatment [@Goodman-Bacon.2021].</span><span class="co">](fig/goodman2.jpg)</span></span>
<span id="cb84-571"><a href="#cb84-571" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-572"><a href="#cb84-572" aria-hidden="true" tabindex="-1"></a>In the middle period, we compare the trend in the early treated with the not-yet treated periods of the late treatment group, and we see the divergence between those two groups (a positive treatment effect). However, for the late treated (right art of the figure), the earlier treated are the control cases (which already includes a trend-breaking treatment effect). For the late treatment group, and we do not observe a positive, but actually a negative treatment effect as we erroneously have the treatment effect in the control group!!!</span>
<span id="cb84-573"><a href="#cb84-573" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-574"><a href="#cb84-574" aria-hidden="true" tabindex="-1"></a>The trend-breaking treatment case is obviously an exception (this would be a really strong treatment effect). However, a similar problem arises with less strong dynamic treatment effects. Below, we set up panel data with three groups and and 12 periods. There is a never-treated group, and early-treated group and a late-treated group. As shown in @fig-forbidden, we could either have A) a statistic treatment effect that changes the outcome level from one period to the other, or B) assume that the treatment effect unfolds dynamically over six periods before it stabilises.</span>
<span id="cb84-575"><a href="#cb84-575" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-576"><a href="#cb84-576" aria-hidden="true" tabindex="-1"></a><span class="in">```{r did-combinations, class.source = 'fold-hide', results='hide', message = FALSE, warning = FALSE}</span></span>
<span id="cb84-577"><a href="#cb84-577" aria-hidden="true" tabindex="-1"></a><span class="do">#############################</span></span>
<span id="cb84-578"><a href="#cb84-578" aria-hidden="true" tabindex="-1"></a><span class="do">### Example: Callaway DID </span><span class="al">###</span></span>
<span id="cb84-579"><a href="#cb84-579" aria-hidden="true" tabindex="-1"></a><span class="do">#############################</span></span>
<span id="cb84-580"><a href="#cb84-580" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-581"><a href="#cb84-581" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb84-582"><a href="#cb84-582" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gridExtra)</span>
<span id="cb84-583"><a href="#cb84-583" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggpubr)</span>
<span id="cb84-584"><a href="#cb84-584" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb84-585"><a href="#cb84-585" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-586"><a href="#cb84-586" aria-hidden="true" tabindex="-1"></a><span class="do">### Set up six individuals with age and happiness</span></span>
<span id="cb84-587"><a href="#cb84-587" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb84-588"><a href="#cb84-588" aria-hidden="true" tabindex="-1"></a>T <span class="ot">&lt;-</span> <span class="dv">12</span></span>
<span id="cb84-589"><a href="#cb84-589" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-590"><a href="#cb84-590" aria-hidden="true" tabindex="-1"></a><span class="co"># id and time</span></span>
<span id="cb84-591"><a href="#cb84-591" aria-hidden="true" tabindex="-1"></a>df2 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">nrow =</span> N<span class="sc">*</span>T))</span>
<span id="cb84-592"><a href="#cb84-592" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(df2) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"id"</span>, <span class="st">"time"</span>)</span>
<span id="cb84-593"><a href="#cb84-593" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-594"><a href="#cb84-594" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>id <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>N, <span class="at">each =</span> T)</span>
<span id="cb84-595"><a href="#cb84-595" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>time <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>T, <span class="at">times =</span> N)</span>
<span id="cb84-596"><a href="#cb84-596" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>idname <span class="ot">&lt;-</span> <span class="fu">factor</span>(df2<span class="sc">$</span>id, <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span>N), <span class="at">labels =</span> <span class="fu">paste</span>(<span class="st">"Person"</span>, <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span>N)))</span>
<span id="cb84-597"><a href="#cb84-597" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-598"><a href="#cb84-598" aria-hidden="true" tabindex="-1"></a><span class="co"># Treatment group</span></span>
<span id="cb84-599"><a href="#cb84-599" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>D <span class="ot">&lt;-</span> <span class="dv">0</span> </span>
<span id="cb84-600"><a href="#cb84-600" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>D[(<span class="dv">1</span><span class="sc">*</span>T <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(<span class="dv">2</span><span class="sc">*</span>T)] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb84-601"><a href="#cb84-601" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>D[(<span class="dv">2</span><span class="sc">*</span>T <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(<span class="dv">3</span><span class="sc">*</span>T)] <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb84-602"><a href="#cb84-602" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-603"><a href="#cb84-603" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>Treatment <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(df2<span class="sc">$</span>time <span class="sc">&gt;=</span> <span class="dv">4</span> <span class="sc">&amp;</span> df2<span class="sc">$</span>D <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb84-604"><a href="#cb84-604" aria-hidden="true" tabindex="-1"></a>oo <span class="ot">&lt;-</span> <span class="fu">which</span>(df2<span class="sc">$</span>time <span class="sc">&gt;=</span> <span class="dv">8</span> <span class="sc">&amp;</span> df2<span class="sc">$</span>D <span class="sc">==</span> <span class="dv">2</span>)</span>
<span id="cb84-605"><a href="#cb84-605" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>Treatment[oo] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb84-606"><a href="#cb84-606" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-607"><a href="#cb84-607" aria-hidden="true" tabindex="-1"></a><span class="co"># Starting wage</span></span>
<span id="cb84-608"><a href="#cb84-608" aria-hidden="true" tabindex="-1"></a>stw <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">2300</span>, <span class="dv">3000</span>, <span class="dv">4000</span>)</span>
<span id="cb84-609"><a href="#cb84-609" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-610"><a href="#cb84-610" aria-hidden="true" tabindex="-1"></a><span class="co"># Dynamic treatment</span></span>
<span id="cb84-611"><a href="#cb84-611" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>DT <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">as.character</span>(df2<span class="sc">$</span>Treatment))</span>
<span id="cb84-612"><a href="#cb84-612" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>DT_time <span class="ot">&lt;-</span> <span class="fu">ave</span>(df2<span class="sc">$</span>DT,</span>
<span id="cb84-613"><a href="#cb84-613" aria-hidden="true" tabindex="-1"></a>                   df2<span class="sc">$</span>id,</span>
<span id="cb84-614"><a href="#cb84-614" aria-hidden="true" tabindex="-1"></a>                   <span class="at">FUN =</span> <span class="cf">function</span>(x) <span class="fu">cumsum</span>(x))</span>
<span id="cb84-615"><a href="#cb84-615" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-616"><a href="#cb84-616" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">max</span>(df2<span class="sc">$</span>DT_time)){</span>
<span id="cb84-617"><a href="#cb84-617" aria-hidden="true" tabindex="-1"></a>  X <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(df2<span class="sc">$</span>DT_time <span class="sc">==</span> i, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb84-618"><a href="#cb84-618" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(i <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb84-619"><a href="#cb84-619" aria-hidden="true" tabindex="-1"></a>    Treatmat <span class="ot">&lt;-</span> X</span>
<span id="cb84-620"><a href="#cb84-620" aria-hidden="true" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb84-621"><a href="#cb84-621" aria-hidden="true" tabindex="-1"></a>    Treatmat <span class="ot">&lt;-</span> <span class="fu">cbind</span>(Treatmat, X)</span>
<span id="cb84-622"><a href="#cb84-622" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb84-623"><a href="#cb84-623" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb84-624"><a href="#cb84-624" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-625"><a href="#cb84-625" aria-hidden="true" tabindex="-1"></a>beta <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">100</span>, <span class="dv">300</span>, <span class="dv">500</span>, <span class="dv">400</span>, <span class="dv">300</span>, <span class="dv">200</span>, <span class="dv">100</span>, <span class="dv">100</span>, <span class="dv">100</span>)</span>
<span id="cb84-626"><a href="#cb84-626" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-627"><a href="#cb84-627" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-628"><a href="#cb84-628" aria-hidden="true" tabindex="-1"></a><span class="co"># wage equation</span></span>
<span id="cb84-629"><a href="#cb84-629" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>wage <span class="ot">&lt;-</span> <span class="fu">unname</span>(<span class="fu">rep</span>(stw, <span class="at">each =</span> T)) <span class="sc">+</span> (df2<span class="sc">$</span>time <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">*</span><span class="dv">50</span> <span class="sc">+</span> Treatmat <span class="sc">%*%</span> beta</span>
<span id="cb84-630"><a href="#cb84-630" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-631"><a href="#cb84-631" aria-hidden="true" tabindex="-1"></a><span class="co"># alternative wage equation</span></span>
<span id="cb84-632"><a href="#cb84-632" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>alt_wage <span class="ot">&lt;-</span> <span class="fu">unname</span>(<span class="fu">rep</span>(stw, <span class="at">each =</span> T)) <span class="sc">+</span> (df2<span class="sc">$</span>time <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">*</span><span class="dv">50</span> <span class="sc">+</span> df2<span class="sc">$</span>Treatment <span class="sc">*</span> <span class="dv">500</span></span>
<span id="cb84-633"><a href="#cb84-633" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-634"><a href="#cb84-634" aria-hidden="true" tabindex="-1"></a><span class="co"># counterfactual</span></span>
<span id="cb84-635"><a href="#cb84-635" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>wage0 <span class="ot">&lt;-</span> <span class="fu">unname</span>(<span class="fu">rep</span>(stw, <span class="at">each =</span> T)) <span class="sc">+</span> (df2<span class="sc">$</span>time <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">*</span><span class="dv">50</span></span>
<span id="cb84-636"><a href="#cb84-636" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-637"><a href="#cb84-637" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>Treatment <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(df2<span class="sc">$</span>Treatment)</span>
<span id="cb84-638"><a href="#cb84-638" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-639"><a href="#cb84-639" aria-hidden="true" tabindex="-1"></a><span class="co"># Add comparison groups</span></span>
<span id="cb84-640"><a href="#cb84-640" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>wage2 <span class="ot">&lt;-</span> <span class="fu">ave</span>(df2<span class="sc">$</span>wage,</span>
<span id="cb84-641"><a href="#cb84-641" aria-hidden="true" tabindex="-1"></a>                 df2<span class="sc">$</span>id,</span>
<span id="cb84-642"><a href="#cb84-642" aria-hidden="true" tabindex="-1"></a>                 <span class="at">FUN =</span> <span class="cf">function</span>(x) dplyr<span class="sc">::</span><span class="fu">lag</span>(x))</span>
<span id="cb84-643"><a href="#cb84-643" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>time2 <span class="ot">&lt;-</span> <span class="fu">ave</span>(df2<span class="sc">$</span>time,</span>
<span id="cb84-644"><a href="#cb84-644" aria-hidden="true" tabindex="-1"></a>                 df2<span class="sc">$</span>id,</span>
<span id="cb84-645"><a href="#cb84-645" aria-hidden="true" tabindex="-1"></a>                 <span class="at">FUN =</span> <span class="cf">function</span>(x) dplyr<span class="sc">::</span><span class="fu">lag</span>(x))</span>
<span id="cb84-646"><a href="#cb84-646" aria-hidden="true" tabindex="-1"></a>oo <span class="ot">&lt;-</span> <span class="fu">which</span>(df2<span class="sc">$</span>Treatment <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb84-647"><a href="#cb84-647" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>wage2[oo] <span class="ot">&lt;-</span> <span class="fu">ave</span>(df2<span class="sc">$</span>wage2[oo],</span>
<span id="cb84-648"><a href="#cb84-648" aria-hidden="true" tabindex="-1"></a>                 df2<span class="sc">$</span>id[oo],</span>
<span id="cb84-649"><a href="#cb84-649" aria-hidden="true" tabindex="-1"></a>                 <span class="at">FUN =</span> <span class="cf">function</span>(x) x[<span class="dv">1</span>])</span>
<span id="cb84-650"><a href="#cb84-650" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>time2[oo] <span class="ot">&lt;-</span> <span class="fu">ave</span>(df2<span class="sc">$</span>time2[oo],</span>
<span id="cb84-651"><a href="#cb84-651" aria-hidden="true" tabindex="-1"></a>                 df2<span class="sc">$</span>id[oo],</span>
<span id="cb84-652"><a href="#cb84-652" aria-hidden="true" tabindex="-1"></a>                 <span class="at">FUN =</span> <span class="cf">function</span>(x) x[<span class="dv">1</span>])</span>
<span id="cb84-653"><a href="#cb84-653" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-654"><a href="#cb84-654" aria-hidden="true" tabindex="-1"></a><span class="co"># for alpha</span></span>
<span id="cb84-655"><a href="#cb84-655" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>D2 <span class="ot">&lt;-</span> df2<span class="sc">$</span>D</span>
<span id="cb84-656"><a href="#cb84-656" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>D3 <span class="ot">&lt;-</span> df2<span class="sc">$</span>D</span>
<span id="cb84-657"><a href="#cb84-657" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>D2[<span class="fu">which</span>(df2<span class="sc">$</span>id <span class="sc">==</span> <span class="dv">2</span> <span class="sc">&amp;</span> df2<span class="sc">$</span>time <span class="sc">&gt;=</span> <span class="dv">8</span>)] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb84-658"><a href="#cb84-658" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>D3[<span class="fu">which</span>(df2<span class="sc">$</span>id <span class="sc">==</span> <span class="dv">2</span> <span class="sc">&amp;</span> df2<span class="sc">$</span>time <span class="sc">&gt;=</span> <span class="dv">7</span>)] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb84-659"><a href="#cb84-659" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-660"><a href="#cb84-660" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-661"><a href="#cb84-661" aria-hidden="true" tabindex="-1"></a><span class="do">### Plot the Callaway Sant Anna Comparisons </span><span class="al">###</span></span>
<span id="cb84-662"><a href="#cb84-662" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-663"><a href="#cb84-663" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-664"><a href="#cb84-664" aria-hidden="true" tabindex="-1"></a>zp1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df2, <span class="fu">aes</span>(time, wage)) <span class="sc">+</span></span>
<span id="cb84-665"><a href="#cb84-665" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> wage, <span class="at">group =</span> id, <span class="at">alpha =</span> <span class="fu">as.factor</span>(D)), <span class="at">lty =</span> <span class="st">"solid"</span>, </span>
<span id="cb84-666"><a href="#cb84-666" aria-hidden="true" tabindex="-1"></a>            <span class="at">colour =</span> <span class="st">"black"</span>, <span class="at">lwd =</span> <span class="dv">1</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span> </span>
<span id="cb84-667"><a href="#cb84-667" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>( <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> wage, <span class="at">fill =</span> Treatment, <span class="at">shape =</span> Treatment, <span class="at">alpha =</span> <span class="fu">as.factor</span>(D)), </span>
<span id="cb84-668"><a href="#cb84-668" aria-hidden="true" tabindex="-1"></a>              <span class="at">size =</span> <span class="dv">4</span>, <span class="at">stroke =</span> <span class="fl">1.5</span>, <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb84-669"><a href="#cb84-669" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_alpha_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="fl">0.2</span>), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb84-670"><a href="#cb84-670" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb84-671"><a href="#cb84-671" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>( <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">12</span>, <span class="dv">2</span>))  <span class="sc">+</span></span>
<span id="cb84-672"><a href="#cb84-672" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#85144b"</span>, <span class="st">"#0074D9"</span>)) <span class="sc">+</span></span>
<span id="cb84-673"><a href="#cb84-673" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#85144b"</span>, <span class="st">"#0074D9"</span>)) <span class="sc">+</span></span>
<span id="cb84-674"><a href="#cb84-674" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_shape_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="dv">21</span>, <span class="dv">24</span>)) <span class="sc">+</span></span>
<span id="cb84-675"><a href="#cb84-675" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Group 1: 11 2x2 DID estimates vs. never-treated"</span>) <span class="sc">+</span></span>
<span id="cb84-676"><a href="#cb84-676" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.05</span>,<span class="fl">0.95</span>), <span class="at">legend.justification =</span> <span class="fu">c</span>(<span class="st">"left"</span>, <span class="st">"top"</span>),</span>
<span id="cb84-677"><a href="#cb84-677" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb84-678"><a href="#cb84-678" aria-hidden="true" tabindex="-1"></a>        <span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb84-679"><a href="#cb84-679" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.box.background =</span> <span class="fu">element_rect</span>(<span class="at">colour =</span> <span class="st">"black"</span>)) <span class="sc">+</span></span>
<span id="cb84-680"><a href="#cb84-680" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_curve</span>(<span class="fu">aes</span>(<span class="at">x =</span> time2, <span class="at">y =</span> wage2, <span class="at">xend =</span> time, <span class="at">yend =</span> wage, <span class="at">color =</span> Treatment), </span>
<span id="cb84-681"><a href="#cb84-681" aria-hidden="true" tabindex="-1"></a>             <span class="at">curvature =</span> <span class="fl">0.3</span>, <span class="at">data =</span> df2[df2<span class="sc">$</span>D <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(df2<span class="sc">$</span>wage2), ])</span>
<span id="cb84-682"><a href="#cb84-682" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-683"><a href="#cb84-683" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-684"><a href="#cb84-684" aria-hidden="true" tabindex="-1"></a>zp2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df2, <span class="fu">aes</span>(time, wage)) <span class="sc">+</span></span>
<span id="cb84-685"><a href="#cb84-685" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> wage, <span class="at">group =</span> id, <span class="at">alpha =</span> <span class="fu">as.factor</span>(D3)), <span class="at">lty =</span> <span class="st">"solid"</span>, </span>
<span id="cb84-686"><a href="#cb84-686" aria-hidden="true" tabindex="-1"></a>            <span class="at">colour =</span> <span class="st">"black"</span>, <span class="at">lwd =</span> <span class="dv">1</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span> </span>
<span id="cb84-687"><a href="#cb84-687" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>( <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> wage,  <span class="at">fill =</span> Treatment, <span class="at">shape =</span> Treatment, <span class="at">alpha =</span> <span class="fu">as.factor</span>(D2)), </span>
<span id="cb84-688"><a href="#cb84-688" aria-hidden="true" tabindex="-1"></a>              <span class="at">size =</span> <span class="dv">4</span>, <span class="at">stroke =</span> <span class="fl">1.5</span>,  <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb84-689"><a href="#cb84-689" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_shape_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="dv">21</span>, <span class="dv">24</span>)) <span class="sc">+</span></span>
<span id="cb84-690"><a href="#cb84-690" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_alpha_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="dv">1</span>, <span class="fl">0.2</span>), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb84-691"><a href="#cb84-691" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#85144b"</span>, <span class="st">"#0074D9"</span>)) <span class="sc">+</span></span>
<span id="cb84-692"><a href="#cb84-692" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#85144b"</span>, <span class="st">"#0074D9"</span>)) <span class="sc">+</span></span>
<span id="cb84-693"><a href="#cb84-693" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> wage, <span class="at">group =</span> id, ), <span class="at">lty =</span> <span class="st">"solid"</span>, <span class="at">colour =</span> <span class="st">"black"</span>, <span class="at">lwd =</span> <span class="dv">1</span>,</span>
<span id="cb84-694"><a href="#cb84-694" aria-hidden="true" tabindex="-1"></a>            <span class="at">data =</span> df2[df2<span class="sc">$</span>D2 <span class="sc">==</span> <span class="dv">2</span> <span class="sc">&amp;</span> df2<span class="sc">$</span>time <span class="sc">&lt;=</span> <span class="dv">7</span>, ]) <span class="sc">+</span> </span>
<span id="cb84-695"><a href="#cb84-695" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>( <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> wage, <span class="at">fill =</span> Treatment, <span class="at">shape =</span> Treatment),</span>
<span id="cb84-696"><a href="#cb84-696" aria-hidden="true" tabindex="-1"></a>              <span class="at">data =</span> df2[df2<span class="sc">$</span>D <span class="sc">==</span> <span class="dv">2</span> <span class="sc">&amp;</span> df2<span class="sc">$</span>time <span class="sc">&lt;=</span> <span class="dv">7</span>, ],</span>
<span id="cb84-697"><a href="#cb84-697" aria-hidden="true" tabindex="-1"></a>              <span class="at">size =</span> <span class="dv">4</span>, <span class="at">stroke =</span> <span class="fl">1.5</span>,  <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb84-698"><a href="#cb84-698" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_shape_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="dv">21</span>, <span class="dv">24</span>)) <span class="sc">+</span></span>
<span id="cb84-699"><a href="#cb84-699" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb84-700"><a href="#cb84-700" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>( <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">12</span>, <span class="dv">2</span>))  <span class="sc">+</span></span>
<span id="cb84-701"><a href="#cb84-701" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Group 1: 6 2x2 DID estimates vs. not-yet-treated"</span>) <span class="sc">+</span></span>
<span id="cb84-702"><a href="#cb84-702" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.05</span>,<span class="fl">0.95</span>), <span class="at">legend.justification =</span> <span class="fu">c</span>(<span class="st">"left"</span>, <span class="st">"top"</span>),</span>
<span id="cb84-703"><a href="#cb84-703" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb84-704"><a href="#cb84-704" aria-hidden="true" tabindex="-1"></a>        <span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb84-705"><a href="#cb84-705" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.box.background =</span> <span class="fu">element_rect</span>(<span class="at">colour =</span> <span class="st">"black"</span>)) <span class="sc">+</span></span>
<span id="cb84-706"><a href="#cb84-706" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_curve</span>(<span class="fu">aes</span>(<span class="at">x =</span> time2, <span class="at">y =</span> wage2, <span class="at">xend =</span> time, <span class="at">yend =</span> wage, <span class="at">color =</span> Treatment), </span>
<span id="cb84-707"><a href="#cb84-707" aria-hidden="true" tabindex="-1"></a>             <span class="at">curvature =</span> <span class="fl">0.3</span>, <span class="at">data =</span> df2[df2<span class="sc">$</span>D <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(df2<span class="sc">$</span>wage2) <span class="sc">&amp;</span> df2<span class="sc">$</span>time <span class="sc">&lt;=</span> <span class="dv">7</span>, ])</span>
<span id="cb84-708"><a href="#cb84-708" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-709"><a href="#cb84-709" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-710"><a href="#cb84-710" aria-hidden="true" tabindex="-1"></a>zp3 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df2, <span class="fu">aes</span>(time, wage)) <span class="sc">+</span></span>
<span id="cb84-711"><a href="#cb84-711" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> wage, <span class="at">group =</span> id, <span class="at">alpha =</span> <span class="fu">as.factor</span>(D)), <span class="at">lty =</span> <span class="st">"solid"</span>, </span>
<span id="cb84-712"><a href="#cb84-712" aria-hidden="true" tabindex="-1"></a>            <span class="at">colour =</span> <span class="st">"black"</span>, <span class="at">lwd =</span> <span class="dv">1</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span> </span>
<span id="cb84-713"><a href="#cb84-713" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> wage, <span class="at">fill =</span> Treatment, <span class="at">shape =</span> Treatment, <span class="at">alpha =</span> <span class="fu">as.factor</span>(D)), </span>
<span id="cb84-714"><a href="#cb84-714" aria-hidden="true" tabindex="-1"></a>              <span class="at">size =</span> <span class="dv">4</span>, <span class="at">stroke =</span><span class="fl">1.5</span>, <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb84-715"><a href="#cb84-715" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#85144b"</span>, <span class="st">"#0074D9"</span>)) <span class="sc">+</span></span>
<span id="cb84-716"><a href="#cb84-716" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#85144b"</span>, <span class="st">"#0074D9"</span>)) <span class="sc">+</span></span>
<span id="cb84-717"><a href="#cb84-717" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_shape_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="dv">21</span>, <span class="dv">24</span>)) <span class="sc">+</span></span>
<span id="cb84-718"><a href="#cb84-718" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_alpha_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="fl">0.2</span>, <span class="dv">1</span>), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb84-719"><a href="#cb84-719" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb84-720"><a href="#cb84-720" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>( <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">12</span>, <span class="dv">2</span>))  <span class="sc">+</span></span>
<span id="cb84-721"><a href="#cb84-721" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Group 2: 11 2x2 DID estimates vs. never-treated"</span>) <span class="sc">+</span></span>
<span id="cb84-722"><a href="#cb84-722" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.05</span>,<span class="fl">0.95</span>), <span class="at">legend.justification =</span> <span class="fu">c</span>(<span class="st">"left"</span>, <span class="st">"top"</span>),</span>
<span id="cb84-723"><a href="#cb84-723" aria-hidden="true" tabindex="-1"></a>        <span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb84-724"><a href="#cb84-724" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb84-725"><a href="#cb84-725" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.box.background =</span> <span class="fu">element_rect</span>(<span class="at">colour =</span> <span class="st">"black"</span>)) <span class="sc">+</span></span>
<span id="cb84-726"><a href="#cb84-726" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_curve</span>(<span class="fu">aes</span>(<span class="at">x =</span> time2, <span class="at">y =</span> wage2, <span class="at">xend =</span> time, <span class="at">yend =</span> wage, <span class="at">color =</span> Treatment), </span>
<span id="cb84-727"><a href="#cb84-727" aria-hidden="true" tabindex="-1"></a>             <span class="at">curvature =</span> <span class="fl">0.3</span>, <span class="at">data =</span> df2[df2<span class="sc">$</span>D <span class="sc">==</span> <span class="dv">2</span> <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(df2<span class="sc">$</span>wage2), ])</span>
<span id="cb84-728"><a href="#cb84-728" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-729"><a href="#cb84-729" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-730"><a href="#cb84-730" aria-hidden="true" tabindex="-1"></a>text <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">"DOES NOT compare</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb84-731"><a href="#cb84-731" aria-hidden="true" tabindex="-1"></a>                             <span class="st">"group 2 (late treatment) vs.</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb84-732"><a href="#cb84-732" aria-hidden="true" tabindex="-1"></a>                             <span class="st">"the already treated periods of group 1"</span>)</span>
<span id="cb84-733"><a href="#cb84-733" aria-hidden="true" tabindex="-1"></a>zp4 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb84-734"><a href="#cb84-734" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="dv">4</span>, <span class="at">y =</span> <span class="dv">25</span>, <span class="at">size=</span><span class="dv">8</span>, <span class="at">label =</span> text, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span> </span>
<span id="cb84-735"><a href="#cb84-735" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span>
<span id="cb84-736"><a href="#cb84-736" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-737"><a href="#cb84-737" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-738"><a href="#cb84-738" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-739"><a href="#cb84-739" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-740"><a href="#cb84-740" aria-hidden="true" tabindex="-1"></a><span class="do">### Plot the Forbidden Comparisons Comparisons </span><span class="al">###</span></span>
<span id="cb84-741"><a href="#cb84-741" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-742"><a href="#cb84-742" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>D4 <span class="ot">&lt;-</span> df2<span class="sc">$</span>D</span>
<span id="cb84-743"><a href="#cb84-743" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>D4[df2<span class="sc">$</span>time <span class="sc">&lt;=</span> <span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb84-744"><a href="#cb84-744" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-745"><a href="#cb84-745" aria-hidden="true" tabindex="-1"></a><span class="co"># Feed forward</span></span>
<span id="cb84-746"><a href="#cb84-746" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>l_Treatment <span class="ot">&lt;-</span> <span class="fu">ave</span>(df2<span class="sc">$</span>Treatment,</span>
<span id="cb84-747"><a href="#cb84-747" aria-hidden="true" tabindex="-1"></a>                       df2<span class="sc">$</span>id,</span>
<span id="cb84-748"><a href="#cb84-748" aria-hidden="true" tabindex="-1"></a>                       <span class="at">FUN =</span> <span class="cf">function</span>(x) dplyr<span class="sc">::</span><span class="fu">lead</span>(x))</span>
<span id="cb84-749"><a href="#cb84-749" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-750"><a href="#cb84-750" aria-hidden="true" tabindex="-1"></a>fp1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df2, <span class="fu">aes</span>(time, wage)) <span class="sc">+</span></span>
<span id="cb84-751"><a href="#cb84-751" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> wage, <span class="at">group =</span> id, <span class="at">alpha =</span> <span class="fu">as.factor</span>(D4)), <span class="at">lty =</span> <span class="st">"solid"</span>, </span>
<span id="cb84-752"><a href="#cb84-752" aria-hidden="true" tabindex="-1"></a>            <span class="at">colour =</span> <span class="st">"black"</span>, <span class="at">lwd =</span> <span class="dv">1</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span> </span>
<span id="cb84-753"><a href="#cb84-753" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> wage, <span class="at">fill =</span> Treatment, <span class="at">shape =</span> Treatment, <span class="at">alpha =</span> <span class="fu">as.factor</span>(D4)), </span>
<span id="cb84-754"><a href="#cb84-754" aria-hidden="true" tabindex="-1"></a>              <span class="at">size =</span> <span class="dv">4</span>, <span class="at">stroke =</span><span class="fl">1.5</span>, <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb84-755"><a href="#cb84-755" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> wage0, <span class="at">group =</span> id), </span>
<span id="cb84-756"><a href="#cb84-756" aria-hidden="true" tabindex="-1"></a>            <span class="at">data =</span> df2[df2<span class="sc">$</span>l_Treatment <span class="sc">==</span> <span class="dv">1</span> <span class="sc">|</span> df2<span class="sc">$</span>Treatment <span class="sc">==</span> <span class="dv">1</span>, ],</span>
<span id="cb84-757"><a href="#cb84-757" aria-hidden="true" tabindex="-1"></a>            <span class="at">lty =</span> <span class="st">"dashed"</span>, <span class="at">alpha =</span> <span class="fl">0.2</span>,</span>
<span id="cb84-758"><a href="#cb84-758" aria-hidden="true" tabindex="-1"></a>            <span class="at">colour =</span> <span class="st">"black"</span>, <span class="at">lwd =</span> <span class="dv">1</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span> </span>
<span id="cb84-759"><a href="#cb84-759" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> wage0), </span>
<span id="cb84-760"><a href="#cb84-760" aria-hidden="true" tabindex="-1"></a>             <span class="at">data =</span> df2[df2<span class="sc">$</span>Treatment <span class="sc">==</span> <span class="dv">1</span>, ],</span>
<span id="cb84-761"><a href="#cb84-761" aria-hidden="true" tabindex="-1"></a>             <span class="at">size =</span> <span class="dv">3</span>, <span class="at">stroke =</span> <span class="dv">1</span>, <span class="at">alpha =</span> <span class="fl">0.2</span>, <span class="at">shape =</span> <span class="dv">21</span>) <span class="sc">+</span></span>
<span id="cb84-762"><a href="#cb84-762" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_blank</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> alt_wage, <span class="at">fill =</span> Treatment, <span class="at">shape =</span> Treatment, <span class="at">alpha =</span> <span class="fu">as.factor</span>(D4)), </span>
<span id="cb84-763"><a href="#cb84-763" aria-hidden="true" tabindex="-1"></a>              <span class="at">size =</span> <span class="dv">4</span>, <span class="at">stroke =</span><span class="fl">1.5</span>, <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb84-764"><a href="#cb84-764" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#85144b"</span>, <span class="st">"#0074D9"</span>)) <span class="sc">+</span></span>
<span id="cb84-765"><a href="#cb84-765" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#85144b"</span>, <span class="st">"#0074D9"</span>)) <span class="sc">+</span></span>
<span id="cb84-766"><a href="#cb84-766" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_shape_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="dv">21</span>, <span class="dv">24</span>)) <span class="sc">+</span></span>
<span id="cb84-767"><a href="#cb84-767" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_alpha_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="dv">1</span>, <span class="dv">1</span>), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb84-768"><a href="#cb84-768" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb84-769"><a href="#cb84-769" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>( <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">12</span>, <span class="dv">2</span>))  <span class="sc">+</span></span>
<span id="cb84-770"><a href="#cb84-770" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"B) Dynamic treatment effect </span><span class="sc">\n</span><span class="st">    Late-treated vs. already-treated"</span>) <span class="sc">+</span></span>
<span id="cb84-771"><a href="#cb84-771" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.05</span>,<span class="fl">0.95</span>), <span class="at">legend.justification =</span> <span class="fu">c</span>(<span class="st">"left"</span>, <span class="st">"top"</span>),</span>
<span id="cb84-772"><a href="#cb84-772" aria-hidden="true" tabindex="-1"></a>        <span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb84-773"><a href="#cb84-773" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb84-774"><a href="#cb84-774" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.box.background =</span> <span class="fu">element_rect</span>(<span class="at">colour =</span> <span class="st">"black"</span>)) </span>
<span id="cb84-775"><a href="#cb84-775" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-776"><a href="#cb84-776" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-777"><a href="#cb84-777" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-778"><a href="#cb84-778" aria-hidden="true" tabindex="-1"></a>fp2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df2, <span class="fu">aes</span>(time, alt_wage)) <span class="sc">+</span></span>
<span id="cb84-779"><a href="#cb84-779" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> alt_wage, <span class="at">group =</span> id, <span class="at">alpha =</span> <span class="fu">as.factor</span>(D4)), <span class="at">lty =</span> <span class="st">"solid"</span>, </span>
<span id="cb84-780"><a href="#cb84-780" aria-hidden="true" tabindex="-1"></a>            <span class="at">colour =</span> <span class="st">"black"</span>, <span class="at">lwd =</span> <span class="dv">1</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span> </span>
<span id="cb84-781"><a href="#cb84-781" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> alt_wage, <span class="at">fill =</span> Treatment, <span class="at">shape =</span> Treatment, <span class="at">alpha =</span> <span class="fu">as.factor</span>(D4)), </span>
<span id="cb84-782"><a href="#cb84-782" aria-hidden="true" tabindex="-1"></a>              <span class="at">size =</span> <span class="dv">4</span>, <span class="at">stroke =</span><span class="fl">1.5</span>, <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb84-783"><a href="#cb84-783" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> wage0, <span class="at">group =</span> id), </span>
<span id="cb84-784"><a href="#cb84-784" aria-hidden="true" tabindex="-1"></a>            <span class="at">data =</span> df2[df2<span class="sc">$</span>l_Treatment <span class="sc">==</span> <span class="dv">1</span> <span class="sc">|</span> df2<span class="sc">$</span>Treatment <span class="sc">==</span> <span class="dv">1</span>, ],</span>
<span id="cb84-785"><a href="#cb84-785" aria-hidden="true" tabindex="-1"></a>            <span class="at">lty =</span> <span class="st">"dashed"</span>, <span class="at">alpha =</span> <span class="fl">0.2</span>,</span>
<span id="cb84-786"><a href="#cb84-786" aria-hidden="true" tabindex="-1"></a>            <span class="at">colour =</span> <span class="st">"black"</span>, <span class="at">lwd =</span> <span class="dv">1</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span> </span>
<span id="cb84-787"><a href="#cb84-787" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> wage0), </span>
<span id="cb84-788"><a href="#cb84-788" aria-hidden="true" tabindex="-1"></a>             <span class="at">data =</span> df2[df2<span class="sc">$</span>Treatment <span class="sc">==</span> <span class="dv">1</span>, ],</span>
<span id="cb84-789"><a href="#cb84-789" aria-hidden="true" tabindex="-1"></a>             <span class="at">size =</span> <span class="dv">3</span>, <span class="at">stroke =</span> <span class="dv">1</span>, <span class="at">alpha =</span> <span class="fl">0.2</span>, <span class="at">shape =</span> <span class="dv">21</span>) <span class="sc">+</span></span>
<span id="cb84-790"><a href="#cb84-790" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#85144b"</span>, <span class="st">"#0074D9"</span>)) <span class="sc">+</span></span>
<span id="cb84-791"><a href="#cb84-791" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#85144b"</span>, <span class="st">"#0074D9"</span>)) <span class="sc">+</span></span>
<span id="cb84-792"><a href="#cb84-792" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_shape_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="dv">21</span>, <span class="dv">24</span>)) <span class="sc">+</span></span>
<span id="cb84-793"><a href="#cb84-793" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_alpha_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="dv">1</span>, <span class="dv">1</span>), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb84-794"><a href="#cb84-794" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb84-795"><a href="#cb84-795" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>( <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">12</span>, <span class="dv">2</span>))  <span class="sc">+</span></span>
<span id="cb84-796"><a href="#cb84-796" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"A) Static treatment effect </span><span class="sc">\n</span><span class="st">    Late-treated vs. already-treated"</span>) <span class="sc">+</span></span>
<span id="cb84-797"><a href="#cb84-797" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"wage"</span>) <span class="sc">+</span></span>
<span id="cb84-798"><a href="#cb84-798" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.05</span>,<span class="fl">0.95</span>), <span class="at">legend.justification =</span> <span class="fu">c</span>(<span class="st">"left"</span>, <span class="st">"top"</span>),</span>
<span id="cb84-799"><a href="#cb84-799" aria-hidden="true" tabindex="-1"></a>        <span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb84-800"><a href="#cb84-800" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb84-801"><a href="#cb84-801" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.box.background =</span> <span class="fu">element_rect</span>(<span class="at">colour =</span> <span class="st">"black"</span>)) </span>
<span id="cb84-802"><a href="#cb84-802" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-803"><a href="#cb84-803" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb84-804"><a href="#cb84-804" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-805"><a href="#cb84-805" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-806"><a href="#cb84-806" aria-hidden="true" tabindex="-1"></a><span class="in">```{r forbidden-plot, class.source = 'fold-hide', results='hide', message = FALSE, warning = FALSE}</span></span>
<span id="cb84-807"><a href="#cb84-807" aria-hidden="true" tabindex="-1"></a>zp <span class="ot">&lt;-</span> <span class="fu">ggarrange</span>(fp2, fp1  <span class="sc">+</span> <span class="fu">rremove</span>(<span class="st">"legend"</span>), </span>
<span id="cb84-808"><a href="#cb84-808" aria-hidden="true" tabindex="-1"></a>                <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">nrow =</span> <span class="dv">1</span>)</span>
<span id="cb84-809"><a href="#cb84-809" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-810"><a href="#cb84-810" aria-hidden="true" tabindex="-1"></a><span class="fu">cairo_ps</span>(<span class="at">file =</span> <span class="fu">paste</span>(<span class="st">"fig/"</span>, <span class="st">"Forbidden.eps"</span>, <span class="at">sep=</span><span class="st">""</span>), <span class="at">width =</span> <span class="dv">11</span>, <span class="at">height =</span> <span class="fl">4.5</span>, </span>
<span id="cb84-811"><a href="#cb84-811" aria-hidden="true" tabindex="-1"></a>          <span class="at">bg =</span> <span class="st">"white"</span>, <span class="at">family =</span> <span class="st">"Times New Roman"</span>)</span>
<span id="cb84-812"><a href="#cb84-812" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>))</span>
<span id="cb84-813"><a href="#cb84-813" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>), <span class="at">oma =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>))</span>
<span id="cb84-814"><a href="#cb84-814" aria-hidden="true" tabindex="-1"></a>zp</span>
<span id="cb84-815"><a href="#cb84-815" aria-hidden="true" tabindex="-1"></a><span class="fu">dev.off</span>()</span>
<span id="cb84-816"><a href="#cb84-816" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-817"><a href="#cb84-817" aria-hidden="true" tabindex="-1"></a><span class="fu">jpeg</span>(<span class="at">file =</span> <span class="fu">paste</span>(<span class="st">"fig/"</span>, <span class="st">"Forbidden.jpeg"</span>, <span class="at">sep=</span><span class="st">""</span>), <span class="at">width =</span> <span class="dv">11</span>, <span class="at">height =</span> <span class="fl">4.5</span>, </span>
<span id="cb84-818"><a href="#cb84-818" aria-hidden="true" tabindex="-1"></a>    <span class="at">units =</span> <span class="st">"in"</span>, <span class="at">res =</span> <span class="dv">300</span>, <span class="at">type =</span> <span class="st">"cairo"</span>,</span>
<span id="cb84-819"><a href="#cb84-819" aria-hidden="true" tabindex="-1"></a>          <span class="at">bg =</span> <span class="st">"white"</span>, <span class="at">family =</span> <span class="st">"Times New Roman"</span>)</span>
<span id="cb84-820"><a href="#cb84-820" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>))</span>
<span id="cb84-821"><a href="#cb84-821" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>), <span class="at">oma =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>))</span>
<span id="cb84-822"><a href="#cb84-822" aria-hidden="true" tabindex="-1"></a>zp</span>
<span id="cb84-823"><a href="#cb84-823" aria-hidden="true" tabindex="-1"></a><span class="fu">dev.off</span>()</span>
<span id="cb84-824"><a href="#cb84-824" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb84-825"><a href="#cb84-825" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-826"><a href="#cb84-826" aria-hidden="true" tabindex="-1"></a><span class="al">![Forbidden comparison of late-treated vs already-treated](fig/Forbidden.jpeg)</span>{#fig-forbidden}</span>
<span id="cb84-827"><a href="#cb84-827" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-828"><a href="#cb84-828" aria-hidden="true" tabindex="-1"></a>The problem now arises when FE compares the late treated as treatment group vs. the already treated as control group. In the static treatment case (@fig-forbidden A), everything is fine as the already-treated run parallel to counterfactual of the late-treated. We can thus use them as control. However, in the dynamic treatment case (@fig-forbidden B), the "control" group of already-treated experience still an ongoing dynamic treatment effect when the late-treated are treated. They are thus not running parallel to the counterfactual of the late-treated group. This comparison is thus also called the forbidden comparison <span class="co">[</span><span class="ot">@Roth.2023</span><span class="co">]</span>.</span>
<span id="cb84-829"><a href="#cb84-829" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-830"><a href="#cb84-830" aria-hidden="true" tabindex="-1"></a>One way of counteracting this problem is to use event study / impact function designs (see above) to explicitly model time varying treatment effects.</span>
<span id="cb84-831"><a href="#cb84-831" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-832"><a href="#cb84-832" aria-hidden="true" tabindex="-1"></a><span class="fu">### Callaway &amp; Sant’Anna dynamic Diff-in-Diff</span></span>
<span id="cb84-833"><a href="#cb84-833" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-834"><a href="#cb84-834" aria-hidden="true" tabindex="-1"></a>A second way is the application of __flexible Diff-in-Diff__ estimators as proposed by @Callaway.2020.</span>
<span id="cb84-835"><a href="#cb84-835" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-836"><a href="#cb84-836" aria-hidden="true" tabindex="-1"></a>Let's start again with the $2 \times 2$ Diff-in-Diff estimator as</span>
<span id="cb84-837"><a href="#cb84-837" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-838"><a href="#cb84-838" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb84-839"><a href="#cb84-839" aria-hidden="true" tabindex="-1"></a>\delta = \E(\Delta y_{T}) - \E(\Delta y_{C}) = (\E(y_{T}^{post}) - \E(y_{T}^{pre})) - (\E(y_{C}^{post}) - \E(y_{C}^{pre})),</span>
<span id="cb84-840"><a href="#cb84-840" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb84-841"><a href="#cb84-841" aria-hidden="true" tabindex="-1"></a>where $\delta$ is the average treatment effect on the treated (ATT).</span>
<span id="cb84-842"><a href="#cb84-842" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-843"><a href="#cb84-843" aria-hidden="true" tabindex="-1"></a>@Callaway.2020 show that we can generalize this $2 \times 2$ Diff-in-Diff to a mutlti-group and multi-timing setting by computing group-time average treatment effects. We group all treatment units which receive treatment at the same period into a common group $g$, and for each treatment-group $g$ and time period $t$ we estimate group-specific and time-specific ATTs: </span>
<span id="cb84-844"><a href="#cb84-844" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-845"><a href="#cb84-845" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb84-846"><a href="#cb84-846" aria-hidden="true" tabindex="-1"></a>\delta_{g,t} = \E(\Delta y_{g}) - \E(\Delta y_{C}) = (\E(y_{g}^{t}) - \E(y_{g}^{g-1})) - (\E(y_{C}^{t}) - \E(y_{C}^{g-1})),</span>
<span id="cb84-847"><a href="#cb84-847" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb84-848"><a href="#cb84-848" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-849"><a href="#cb84-849" aria-hidden="true" tabindex="-1"></a>where the control group can either be the never-treated or the not-yet-treated. As shown in @fig-callaway by the convex lines, this means, we estimate an individual treatment effect for each combination of treatment-timing-group and control group.</span>
<span id="cb84-850"><a href="#cb84-850" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-851"><a href="#cb84-851" aria-hidden="true" tabindex="-1"></a>Obviously, this gives us a large number of different treatment effects. So, in a second step, we re-aggregate these individual combinations back to group or time averaged treatment effect. In an event study design, @Callaway.2020 propose the following dynamic treatment effect for each period $e$ after the treatment:</span>
<span id="cb84-852"><a href="#cb84-852" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-853"><a href="#cb84-853" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb84-854"><a href="#cb84-854" aria-hidden="true" tabindex="-1"></a>  \theta_D(e) := \sum_{g=1}^G \mathbf{1} <span class="sc">\{</span> g + e \leq T <span class="sc">\}</span> \delta(g,g+e) P(G=g | G+e \leq T),</span>
<span id="cb84-855"><a href="#cb84-855" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb84-856"><a href="#cb84-856" aria-hidden="true" tabindex="-1"></a>where $e$ specifies for how long a unit has been exposed to the treatment. It's basically the average effects across all treatment-timing groups at the period $e$ after treatment. From here, one can easily calculate the cumulative effect or the overall aggregated effect.</span>
<span id="cb84-857"><a href="#cb84-857" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-858"><a href="#cb84-858" aria-hidden="true" tabindex="-1"></a>Consider the situation in @fig-callaway, where we have a control group of never-treated units, one treatment group that is treated early (group 1) and one treatment group that is treated late (group 2). As shown below, with $T=12$ we can estimate 11 2 $\times$ 2 Diff-in-Diff estimates of group 1 against the never treated, we can estimate 6 2 $\times$ 2 Diff-in-Diff estimates of group 1 against the not-yet treated (late treatment group), and we can estimate 11 2 $\times$ 2 Diff-in-Diff estimates of group 2 against the never treated.</span>
<span id="cb84-859"><a href="#cb84-859" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-860"><a href="#cb84-860" aria-hidden="true" tabindex="-1"></a>Note that the control period for all treated periods by default is set to the period before the treatment happened in each group. For group 1 this is period 3, and for group 2 this is period 7. This makes only sense if there is __no treatment anticipation__. Obviously, we can also use other (earlier) periods if we assume treatment anticipation.</span>
<span id="cb84-861"><a href="#cb84-861" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-862"><a href="#cb84-862" aria-hidden="true" tabindex="-1"></a><span class="in">```{r did-plot, class.source = 'fold-hide', results='hide', message = FALSE, warning = FALSE}</span></span>
<span id="cb84-863"><a href="#cb84-863" aria-hidden="true" tabindex="-1"></a>zp <span class="ot">&lt;-</span> <span class="fu">ggarrange</span>(zp1, zp2  <span class="sc">+</span> <span class="fu">rremove</span>(<span class="st">"legend"</span>), </span>
<span id="cb84-864"><a href="#cb84-864" aria-hidden="true" tabindex="-1"></a>                zp3  <span class="sc">+</span> <span class="fu">rremove</span>(<span class="st">"legend"</span>), zp4,</span>
<span id="cb84-865"><a href="#cb84-865" aria-hidden="true" tabindex="-1"></a>                <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">nrow =</span> <span class="dv">2</span>)</span>
<span id="cb84-866"><a href="#cb84-866" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-867"><a href="#cb84-867" aria-hidden="true" tabindex="-1"></a><span class="fu">cairo_ps</span>(<span class="at">file =</span> <span class="fu">paste</span>(<span class="st">"fig/"</span>, <span class="st">"DiD.eps"</span>, <span class="at">sep=</span><span class="st">""</span>), <span class="at">width =</span> <span class="dv">11</span>, <span class="at">height =</span> <span class="dv">8</span>, </span>
<span id="cb84-868"><a href="#cb84-868" aria-hidden="true" tabindex="-1"></a>          <span class="at">bg =</span> <span class="st">"white"</span>, <span class="at">family =</span> <span class="st">"Times New Roman"</span>)</span>
<span id="cb84-869"><a href="#cb84-869" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>))</span>
<span id="cb84-870"><a href="#cb84-870" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>), <span class="at">oma =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>))</span>
<span id="cb84-871"><a href="#cb84-871" aria-hidden="true" tabindex="-1"></a>zp</span>
<span id="cb84-872"><a href="#cb84-872" aria-hidden="true" tabindex="-1"></a><span class="fu">dev.off</span>()</span>
<span id="cb84-873"><a href="#cb84-873" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-874"><a href="#cb84-874" aria-hidden="true" tabindex="-1"></a><span class="fu">jpeg</span>(<span class="at">file =</span> <span class="fu">paste</span>(<span class="st">"fig/"</span>, <span class="st">"DiD.jpeg"</span>, <span class="at">sep=</span><span class="st">""</span>), <span class="at">width =</span> <span class="dv">11</span>, <span class="at">height =</span> <span class="dv">8</span>, </span>
<span id="cb84-875"><a href="#cb84-875" aria-hidden="true" tabindex="-1"></a>    <span class="at">units =</span> <span class="st">"in"</span>, <span class="at">res =</span> <span class="dv">300</span>, <span class="at">type =</span> <span class="st">"cairo"</span>,</span>
<span id="cb84-876"><a href="#cb84-876" aria-hidden="true" tabindex="-1"></a>          <span class="at">bg =</span> <span class="st">"white"</span>, <span class="at">family =</span> <span class="st">"Times New Roman"</span>)</span>
<span id="cb84-877"><a href="#cb84-877" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>))</span>
<span id="cb84-878"><a href="#cb84-878" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>), <span class="at">oma =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>))</span>
<span id="cb84-879"><a href="#cb84-879" aria-hidden="true" tabindex="-1"></a>zp</span>
<span id="cb84-880"><a href="#cb84-880" aria-hidden="true" tabindex="-1"></a><span class="fu">dev.off</span>()</span>
<span id="cb84-881"><a href="#cb84-881" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb84-882"><a href="#cb84-882" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-883"><a href="#cb84-883" aria-hidden="true" tabindex="-1"></a><span class="al">![Multiple 2x2 DiD comparisons with dynamic DiD estimators](fig/DiD.jpeg)</span>{#fig-callaway}</span>
<span id="cb84-884"><a href="#cb84-884" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-885"><a href="#cb84-885" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-886"><a href="#cb84-886" aria-hidden="true" tabindex="-1"></a>For a more detailled introdution see @Callaway.2020 or the respective <span class="co">[</span><span class="ot">package introcution</span><span class="co">](https://cran.r-project.org/web/packages/did/vignettes/multi-period-did.html)</span>.</span>
<span id="cb84-887"><a href="#cb84-887" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-888"><a href="#cb84-888" aria-hidden="true" tabindex="-1"></a>__Assumptions__:</span>
<span id="cb84-889"><a href="#cb84-889" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-890"><a href="#cb84-890" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Staggered treatment adoption: once a unit has been treated, it remains treated thereafter (see also the note above).</span>
<span id="cb84-891"><a href="#cb84-891" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-892"><a href="#cb84-892" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Parallel trends assumption </span>
<span id="cb84-893"><a href="#cb84-893" aria-hidden="true" tabindex="-1"></a><span class="ss">  + </span>based on never-treated: treated units would have had parallel trends to never-treated if they would not have experienced treatment. In many empirical settings this is a strong assumption (why do some units never experience treatment?).</span>
<span id="cb84-894"><a href="#cb84-894" aria-hidden="true" tabindex="-1"></a><span class="ss">  + </span>based on not-yet-treated: treated units would have had parallel trends to not-yet-treated if they would not have experienced treatment. This assumption might be a bit more likely to hold.</span>
<span id="cb84-895"><a href="#cb84-895" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb84-896"><a href="#cb84-896" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>No treatment anticipation </span>
<span id="cb84-897"><a href="#cb84-897" aria-hidden="true" tabindex="-1"></a><span class="ss">  + </span>based on never-treated: We can relax the assumption by either back-dating the treatment or include the appropriate pre-treatment periods in our results to inspect anticipation qualitatively.</span>
<span id="cb84-898"><a href="#cb84-898" aria-hidden="true" tabindex="-1"></a><span class="ss">  + </span>based on not-yet-treated: If there is treatment anticipation, our control group will be confounded by the treatment effect. A violation of the assumption can lead to stronger bias if we use the not-yet-treated as control group.</span>
<span id="cb84-899"><a href="#cb84-899" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb84-900"><a href="#cb84-900" aria-hidden="true" tabindex="-1"></a>__Trade-off__: If assumption 2) is likely to hold, we can use only the never-treated as controls to relax assumption 3). If assumption 3) is likely to hold, we can include the not-yet-treated as control to relax assumption 2).</span>
<span id="cb84-901"><a href="#cb84-901" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-902"><a href="#cb84-902" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-903"><a href="#cb84-903" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-904"><a href="#cb84-904" aria-hidden="true" tabindex="-1"></a><span class="fu">### Example</span></span>
<span id="cb84-905"><a href="#cb84-905" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-906"><a href="#cb84-906" aria-hidden="true" tabindex="-1"></a>How does that look in our marriage example? To estimate the dynamic DD we use the <span class="in">`did`</span> package, as describes in more detail <span class="co">[</span><span class="ot">here</span><span class="co">](https://cran.r-project.org/web/packages/did/vignettes/did-basics.html)</span> or in the authors <span class="co">[</span><span class="ot">blog</span><span class="co">](https://pedrohcgs.github.io/posts/twfe)</span>.</span>
<span id="cb84-907"><a href="#cb84-907" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-908"><a href="#cb84-908" aria-hidden="true" tabindex="-1"></a>__Note: This package works with staggered treatment adoption! We thus should perform all the steps we have performed above to restrict and prepare the data!__</span>
<span id="cb84-909"><a href="#cb84-909" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-910"><a href="#cb84-910" aria-hidden="true" tabindex="-1"></a>As a first step, we need to define a variable that contains the treatment timing: the first year an ever-treated individual is treated.</span>
<span id="cb84-911"><a href="#cb84-911" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-912"><a href="#cb84-912" aria-hidden="true" tabindex="-1"></a>This should be a positive number for all observations in treated groups. It defines which "group" a unit belongs to. It should be 0 for units in the untreated group.</span>
<span id="cb84-913"><a href="#cb84-913" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-916"><a href="#cb84-916" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb84-917"><a href="#cb84-917" aria-hidden="true" tabindex="-1"></a><span class="co"># treatment timing = year if married</span></span>
<span id="cb84-918"><a href="#cb84-918" aria-hidden="true" tabindex="-1"></a>mwp<span class="sc">$</span>treat_timing <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(mwp<span class="sc">$</span>marry <span class="sc">==</span> <span class="dv">1</span>, mwp<span class="sc">$</span>year, <span class="cn">NA</span>)</span>
<span id="cb84-919"><a href="#cb84-919" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-920"><a href="#cb84-920" aria-hidden="true" tabindex="-1"></a><span class="co"># set never treated to zero</span></span>
<span id="cb84-921"><a href="#cb84-921" aria-hidden="true" tabindex="-1"></a>mwp<span class="sc">$</span>treat_timing[mwp<span class="sc">$</span>evermarry <span class="sc">==</span> <span class="dv">0</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb84-922"><a href="#cb84-922" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-923"><a href="#cb84-923" aria-hidden="true" tabindex="-1"></a><span class="co"># if married is not NA, used min year per id (removing NAs)</span></span>
<span id="cb84-924"><a href="#cb84-924" aria-hidden="true" tabindex="-1"></a>mwp<span class="sc">$</span>treat_timing[<span class="sc">!</span><span class="fu">is.na</span>(mwp<span class="sc">$</span>marry)] <span class="ot">&lt;-</span> <span class="fu">ave</span>(mwp<span class="sc">$</span>treat_timing[<span class="sc">!</span><span class="fu">is.na</span>(mwp<span class="sc">$</span>marry)],</span>
<span id="cb84-925"><a href="#cb84-925" aria-hidden="true" tabindex="-1"></a>                                           mwp<span class="sc">$</span>id[<span class="sc">!</span><span class="fu">is.na</span>(mwp<span class="sc">$</span>marry)],</span>
<span id="cb84-926"><a href="#cb84-926" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">FUN =</span> <span class="cf">function</span>(x) <span class="fu">min</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb84-927"><a href="#cb84-927" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-928"><a href="#cb84-928" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-929"><a href="#cb84-929" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(mwp[, <span class="fu">c</span>(<span class="st">"id"</span>, <span class="st">"year"</span>, <span class="st">"marry"</span>, <span class="st">"evermarry"</span>, <span class="st">"treat_timing"</span>)], <span class="at">n =</span> <span class="dv">35</span>)</span>
<span id="cb84-930"><a href="#cb84-930" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb84-931"><a href="#cb84-931" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-932"><a href="#cb84-932" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-933"><a href="#cb84-933" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-936"><a href="#cb84-936" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb84-937"><a href="#cb84-937" aria-hidden="true" tabindex="-1"></a><span class="co"># estimate group-time average treatment effects using att_gt method</span></span>
<span id="cb84-938"><a href="#cb84-938" aria-hidden="true" tabindex="-1"></a>wages.attgt <span class="ot">&lt;-</span> <span class="fu">att_gt</span>(<span class="at">yname =</span> <span class="st">"lnw"</span>,</span>
<span id="cb84-939"><a href="#cb84-939" aria-hidden="true" tabindex="-1"></a>                      <span class="at">tname =</span> <span class="st">"year"</span>,</span>
<span id="cb84-940"><a href="#cb84-940" aria-hidden="true" tabindex="-1"></a>                      <span class="at">idname =</span> <span class="st">"id"</span>,</span>
<span id="cb84-941"><a href="#cb84-941" aria-hidden="true" tabindex="-1"></a>                      <span class="at">gname =</span> <span class="st">"treat_timing"</span>,</span>
<span id="cb84-942"><a href="#cb84-942" aria-hidden="true" tabindex="-1"></a>                      <span class="co">#xformla = ~ enrol + yeduc + exp + I(exp^2), # note that we omit the yeargroup here</span></span>
<span id="cb84-943"><a href="#cb84-943" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data =</span> mwp,</span>
<span id="cb84-944"><a href="#cb84-944" aria-hidden="true" tabindex="-1"></a>                      <span class="at">allow_unbalanced_panel =</span> <span class="cn">TRUE</span>,</span>
<span id="cb84-945"><a href="#cb84-945" aria-hidden="true" tabindex="-1"></a>                      <span class="at">control_group =</span> <span class="st">"notyettreated"</span>,</span>
<span id="cb84-946"><a href="#cb84-946" aria-hidden="true" tabindex="-1"></a>                      <span class="at">est_method =</span> <span class="st">"ipw"</span></span>
<span id="cb84-947"><a href="#cb84-947" aria-hidden="true" tabindex="-1"></a>                        )</span>
<span id="cb84-948"><a href="#cb84-948" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb84-949"><a href="#cb84-949" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-950"><a href="#cb84-950" aria-hidden="true" tabindex="-1"></a>One huge advantage: We do not need to make a decision about which periods (before treatment) we want to include, and which observations go into the reference category. </span>
<span id="cb84-951"><a href="#cb84-951" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-952"><a href="#cb84-952" aria-hidden="true" tabindex="-1"></a>However, we get a lot of individual treatment effects.</span>
<span id="cb84-953"><a href="#cb84-953" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-956"><a href="#cb84-956" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb84-957"><a href="#cb84-957" aria-hidden="true" tabindex="-1"></a><span class="co"># Show the group-time specific estimates</span></span>
<span id="cb84-958"><a href="#cb84-958" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(wages.attgt)</span>
<span id="cb84-959"><a href="#cb84-959" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb84-960"><a href="#cb84-960" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-961"><a href="#cb84-961" aria-hidden="true" tabindex="-1"></a>These individual effects are similar to running a lot of individual regressions, where we compute a lot of individual $2 \times 2$ DD estimators, e.g. for group 1981:</span>
<span id="cb84-962"><a href="#cb84-962" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-965"><a href="#cb84-965" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb84-966"><a href="#cb84-966" aria-hidden="true" tabindex="-1"></a>t <span class="ot">&lt;-</span> <span class="dv">1981</span></span>
<span id="cb84-967"><a href="#cb84-967" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-968"><a href="#cb84-968" aria-hidden="true" tabindex="-1"></a><span class="co"># run individual effects</span></span>
<span id="cb84-969"><a href="#cb84-969" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="fu">sort</span>(<span class="fu">unique</span>(mwp<span class="sc">$</span>year))[<span class="sc">-</span><span class="dv">1</span>]){</span>
<span id="cb84-970"><a href="#cb84-970" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb84-971"><a href="#cb84-971" aria-hidden="true" tabindex="-1"></a>  <span class="co"># not yet treated</span></span>
<span id="cb84-972"><a href="#cb84-972" aria-hidden="true" tabindex="-1"></a>  mwp<span class="sc">$</span>notyettreated <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(mwp<span class="sc">$</span>treat_timing <span class="sc">&gt;</span> t <span class="sc">&amp;</span> mwp<span class="sc">$</span>treat_timing <span class="sc">&gt;</span> i, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb84-973"><a href="#cb84-973" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb84-974"><a href="#cb84-974" aria-hidden="true" tabindex="-1"></a>  <span class="co"># select 1980 group, never-treated and not yet treated</span></span>
<span id="cb84-975"><a href="#cb84-975" aria-hidden="true" tabindex="-1"></a>  oo <span class="ot">&lt;-</span> <span class="fu">which</span>(mwp<span class="sc">$</span>treat_timing <span class="sc">==</span> t <span class="sc">|</span> mwp<span class="sc">$</span>treat_timing <span class="sc">==</span> <span class="dv">0</span> <span class="sc">|</span> mwp<span class="sc">$</span>notyettreated <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb84-976"><a href="#cb84-976" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> mwp[oo, ]</span>
<span id="cb84-977"><a href="#cb84-977" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb84-978"><a href="#cb84-978" aria-hidden="true" tabindex="-1"></a>  <span class="co"># after set to 1 for year rolling year i</span></span>
<span id="cb84-979"><a href="#cb84-979" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>after <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb84-980"><a href="#cb84-980" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>after[df<span class="sc">$</span>year <span class="sc">==</span> i] <span class="ot">&lt;-</span> <span class="dv">1</span> </span>
<span id="cb84-981"><a href="#cb84-981" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb84-982"><a href="#cb84-982" aria-hidden="true" tabindex="-1"></a>  <span class="co"># control year</span></span>
<span id="cb84-983"><a href="#cb84-983" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(i <span class="sc">&lt;</span> t){</span>
<span id="cb84-984"><a href="#cb84-984" aria-hidden="true" tabindex="-1"></a>    <span class="co"># if i is still before actual treatment, compare to previous year</span></span>
<span id="cb84-985"><a href="#cb84-985" aria-hidden="true" tabindex="-1"></a>    tc <span class="ot">&lt;-</span> i <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb84-986"><a href="#cb84-986" aria-hidden="true" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb84-987"><a href="#cb84-987" aria-hidden="true" tabindex="-1"></a>    <span class="co"># if i is beyond actual treatment, compare to year before actual treatment (t-1)</span></span>
<span id="cb84-988"><a href="#cb84-988" aria-hidden="true" tabindex="-1"></a>    tc <span class="ot">&lt;-</span> t <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb84-989"><a href="#cb84-989" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb84-990"><a href="#cb84-990" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>after[df<span class="sc">$</span>year <span class="sc">==</span> tc] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb84-991"><a href="#cb84-991" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb84-992"><a href="#cb84-992" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Restrict to the two years we want to compare</span></span>
<span id="cb84-993"><a href="#cb84-993" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> df[<span class="sc">!</span><span class="fu">is.na</span>(df<span class="sc">$</span>after), ]</span>
<span id="cb84-994"><a href="#cb84-994" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb84-995"><a href="#cb84-995" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define treated group</span></span>
<span id="cb84-996"><a href="#cb84-996" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>treat <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(df<span class="sc">$</span>treat_timing <span class="sc">==</span> t, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb84-997"><a href="#cb84-997" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb84-998"><a href="#cb84-998" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Estiamte 2x2 DD</span></span>
<span id="cb84-999"><a href="#cb84-999" aria-hidden="true" tabindex="-1"></a>  tmp.lm <span class="ot">&lt;-</span> <span class="fu">lm</span>(lnw <span class="sc">~</span> treat<span class="sc">*</span>after, <span class="at">data =</span> df)</span>
<span id="cb84-1000"><a href="#cb84-1000" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb84-1001"><a href="#cb84-1001" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Print</span></span>
<span id="cb84-1002"><a href="#cb84-1002" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">paste0</span>(i, <span class="st">": "</span>, <span class="fu">round</span>(tmp.lm<span class="sc">$</span>coefficients[<span class="dv">4</span>], <span class="dv">4</span>)))</span>
<span id="cb84-1003"><a href="#cb84-1003" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb84-1004"><a href="#cb84-1004" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb84-1005"><a href="#cb84-1005" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1006"><a href="#cb84-1006" aria-hidden="true" tabindex="-1"></a>To make this more interpretable, we re-aggregate the individuals results to a dynamic time-averaged effect (we now restrict this to observations from -3 to 6).</span>
<span id="cb84-1007"><a href="#cb84-1007" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1010"><a href="#cb84-1010" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb84-1011"><a href="#cb84-1011" aria-hidden="true" tabindex="-1"></a>wages.dyn <span class="ot">&lt;-</span> <span class="fu">aggte</span>(wages.attgt, <span class="at">type =</span> <span class="st">"dynamic"</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>,</span>
<span id="cb84-1012"><a href="#cb84-1012" aria-hidden="true" tabindex="-1"></a>                   <span class="at">min_e =</span> <span class="sc">-</span><span class="dv">3</span>, <span class="at">max_e =</span> <span class="dv">6</span>)</span>
<span id="cb84-1013"><a href="#cb84-1013" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(wages.dyn)</span>
<span id="cb84-1014"><a href="#cb84-1014" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb84-1015"><a href="#cb84-1015" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1016"><a href="#cb84-1016" aria-hidden="true" tabindex="-1"></a>The <span class="in">`did`</span> package also comes with a handy command <span class="in">`ggdid()`</span> to plot the results </span>
<span id="cb84-1017"><a href="#cb84-1017" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1020"><a href="#cb84-1020" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb84-1021"><a href="#cb84-1021" aria-hidden="true" tabindex="-1"></a>zp3 <span class="ot">&lt;-</span> <span class="fu">ggdid</span>(wages.dyn) </span>
<span id="cb84-1022"><a href="#cb84-1022" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb84-1023"><a href="#cb84-1023" aria-hidden="true" tabindex="-1"></a>zp3 <span class="ot">&lt;-</span> zp3 <span class="sc">+</span> </span>
<span id="cb84-1024"><a href="#cb84-1024" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">colour =</span> <span class="fu">gray</span>(<span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>), <span class="at">lty =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb84-1025"><a href="#cb84-1025" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="sc">-</span><span class="fl">0.5</span>, <span class="at">colour =</span> <span class="st">"black"</span>, <span class="at">lty =</span> <span class="dv">1</span>)</span>
<span id="cb84-1026"><a href="#cb84-1026" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1027"><a href="#cb84-1027" aria-hidden="true" tabindex="-1"></a>zp3</span>
<span id="cb84-1028"><a href="#cb84-1028" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb84-1029"><a href="#cb84-1029" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1030"><a href="#cb84-1030" aria-hidden="true" tabindex="-1"></a>Although it is definitely not the same, this doesn't look too different from our earlier FEIS results. </span>
<span id="cb84-1031"><a href="#cb84-1031" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1032"><a href="#cb84-1032" aria-hidden="true" tabindex="-1"></a><span class="fu"># Synthetic Control</span></span>
<span id="cb84-1033"><a href="#cb84-1033" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1034"><a href="#cb84-1034" aria-hidden="true" tabindex="-1"></a>So far, we have considered quantitative examples with multiple treated and multiple non-treated units, and we have applied "bruteforce" approaches to identify causal effects.</span>
<span id="cb84-1035"><a href="#cb84-1035" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1036"><a href="#cb84-1036" aria-hidden="true" tabindex="-1"></a>However, sometimes we face the situation of a single treated unit. This is especially common in comparative case studies. For instance, a single country or region has implemented a specific policy or experienced a specific shock. For instance, we might be interested in how a terrorist attack might influence the economic development of a region <span class="co">[</span><span class="ot">@Abadie.2003</span><span class="co">]</span>.</span>
<span id="cb84-1037"><a href="#cb84-1037" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1038"><a href="#cb84-1038" aria-hidden="true" tabindex="-1"></a>The synthetic control estimator <span class="co">[</span><span class="ot">@Abadie.2003; @Abadie.2010; @Abadie.2021</span><span class="co">]</span> has become a very popular way of dealing with situation with a single treated unit. </span>
<span id="cb84-1039"><a href="#cb84-1039" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1040"><a href="#cb84-1040" aria-hidden="true" tabindex="-1"></a>__The general idea: we use the control units to construct an average "synthetic control" unit in a way that the outcome trajectory of the synthetic control unit closely matches the outcome trajectory of the treated unit.__ Find weights to construct a "synthetic control" unit (by reweighing non-treated units) that optimally estimates a counterfactual trajectory for the treated unit. </span>
<span id="cb84-1041"><a href="#cb84-1041" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1042"><a href="#cb84-1042" aria-hidden="true" tabindex="-1"></a>With covariates, the method first calculates the importance of several covariates for the outcome and subsequently computes weights, which minimizes the difference between the treatment and control groups in the importance-weighted covariates.</span>
<span id="cb84-1043"><a href="#cb84-1043" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1044"><a href="#cb84-1044" aria-hidden="true" tabindex="-1"></a>!<span class="co">[</span><span class="ot">Left: treated (California) unit and unweighted average of all other states. Right: treated (California) unit and synthetic control group [@Abadie.2010]</span><span class="co">](fig/abadie.jpg)</span></span>
<span id="cb84-1045"><a href="#cb84-1045" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1046"><a href="#cb84-1046" aria-hidden="true" tabindex="-1"></a>__Note that we have to assume that the control units are not affected by the treatment (no spillovers) and that the treatment has no effect on the outcome before the treatment period (no anticipation).__</span>
<span id="cb84-1047"><a href="#cb84-1047" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1048"><a href="#cb84-1048" aria-hidden="true" tabindex="-1"></a>If there are reasons to believe that there potential anticipation effects (often the case), one can back-date the treatment, i.e. we set the treatment timing to the first period where there might possibly be an effect on the outcome.</span>
<span id="cb84-1049"><a href="#cb84-1049" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1050"><a href="#cb84-1050" aria-hidden="true" tabindex="-1"></a>Formally, the (time-specific) treatment effect is estimated as the difference between the outcome of the treated unit and the average re-weighted control units <span class="co">[</span><span class="ot">@Abadie.2003; @Abadie.2010, @Abadie.2011</span><span class="co">]</span>:</span>
<span id="cb84-1051"><a href="#cb84-1051" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb84-1052"><a href="#cb84-1052" aria-hidden="true" tabindex="-1"></a>\hat{\delta}_{1t} = Y_{1t} - \sum_{j=2}^{J+1}w_j^*Y_{jt},</span>
<span id="cb84-1053"><a href="#cb84-1053" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb84-1054"><a href="#cb84-1054" aria-hidden="true" tabindex="-1"></a>where $i=1$ is the treated unit and $j\neq i$ are all potential control units (donor pool).</span>
<span id="cb84-1055"><a href="#cb84-1055" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1056"><a href="#cb84-1056" aria-hidden="true" tabindex="-1"></a>$w_j^*$ are the optimally chosen (non-negative) weights for each control unit, where we impose two restrictions: a) the weights are non-negative $w_j \geq 0$ for $j=2,\dots, J+1$, and the weights sum to one $\sum_{j=2}^{J+1}w_j = 1$.</span>
<span id="cb84-1057"><a href="#cb84-1057" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1058"><a href="#cb84-1058" aria-hidden="true" tabindex="-1"></a>This leaves us with the task to find the optimally chosen weights. So assume we have $k = 1,\dots,K$ covariates $\bm X$, where $x_{1k}$ is the $k$-th covariate of the treated unit, and $\bm x_{0k}$ a $1 \times J$ vector of the same covariate for the control units / donor pool. Then we choose $W^*$ as the value that minimizes </span>
<span id="cb84-1059"><a href="#cb84-1059" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb84-1060"><a href="#cb84-1060" aria-hidden="true" tabindex="-1"></a>\sum_{k=1}^K v_k(x_{1k} - x_{0k}W)^2,</span>
<span id="cb84-1061"><a href="#cb84-1061" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb84-1062"><a href="#cb84-1062" aria-hidden="true" tabindex="-1"></a>with $v_k$ reflecting the relative importance of the covariate $k$. As we want the outcome trajectories of the treated unit and synthetic control to closely match, $v_1,\dots,v_K$ is usually determined by the predictive power of the respective covariate.</span>
<span id="cb84-1063"><a href="#cb84-1063" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1064"><a href="#cb84-1064" aria-hidden="true" tabindex="-1"></a>The original authors <span class="co">[</span><span class="ot">@Abadie.2003; @Abadie.2010, @Abadie.2011</span><span class="co">]</span> use a data driven approach to choose $V^*$ by minimizing the mean squared prediction error (MSPE) of the outcome over the pre-treatment periods $t=1,\dots,T_0$. Formally, we choose $V^*$ that minimizes:</span>
<span id="cb84-1065"><a href="#cb84-1065" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb84-1066"><a href="#cb84-1066" aria-hidden="true" tabindex="-1"></a>\sum_{t=1}^{T_0}\Big( Y_{1t} - \sum_{j=2}^{J+1}w_j^*(V)Y_{jt}\Big)</span>
<span id="cb84-1067"><a href="#cb84-1067" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb84-1068"><a href="#cb84-1068" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1069"><a href="#cb84-1069" aria-hidden="true" tabindex="-1"></a>Note: with increasing pre-intervention periods ($T_0$), we can assume that the synthetic control also accounts for unobserved factors affecting $Y$ <span class="co">[</span><span class="ot">@Abadie.2010</span><span class="co">]</span>, assuming that only units with similar unobservables exhibit a similar outcome trajectory.</span>
<span id="cb84-1070"><a href="#cb84-1070" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1071"><a href="#cb84-1071" aria-hidden="true" tabindex="-1"></a>However, with increasing pre-intervention periods, it is important to check if the outcome trajectories match well not only at far temporal distances to the treatment but also in periods closely before the treatment.</span>
<span id="cb84-1072"><a href="#cb84-1072" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1073"><a href="#cb84-1073" aria-hidden="true" tabindex="-1"></a>A __critical assumption__ is that the outcome trajectory (and other covariates) of the treated unit falls into the "convex hull" of the donor pool's outcome trajectories. Intuitively: we construct the synthetic control by giving each control unit a weight of $\geq 0$ (we only interpolate, but do not extrapolate). Thus, there must be sufficient control units with "higher" and "lower" values in the outcome for pre-intervention periods. If the treated unit is an outlier before the intervention, Synthetic Control does not make much sense.</span>
<span id="cb84-1074"><a href="#cb84-1074" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1075"><a href="#cb84-1075" aria-hidden="true" tabindex="-1"></a><span class="fu">### Statistical inference with synthetic control</span></span>
<span id="cb84-1076"><a href="#cb84-1076" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1077"><a href="#cb84-1077" aria-hidden="true" tabindex="-1"></a>Calculating uncertainty estimates for Synthetic Control methods is an ongoing methodological challenge. Recent work, for instance, suggest to quantify uncertainty based on permutation inference procedures <span class="co">[</span><span class="ot">@Chernozhukov.2021b</span><span class="co">]</span> or on conditional prediction intervals <span class="co">[</span><span class="ot">@Cattaneo.2021</span><span class="co">]</span>. In practice, however, both methods are difficult to implement with standard software (especially with covariate matching).</span>
<span id="cb84-1078"><a href="#cb84-1078" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1079"><a href="#cb84-1079" aria-hidden="true" tabindex="-1"></a>__Placebo tests__</span>
<span id="cb84-1080"><a href="#cb84-1080" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1081"><a href="#cb84-1081" aria-hidden="true" tabindex="-1"></a>@Abadie.2003 and @Abadie.2010 propose a more qualitative approach to asses the significance of the findings: __placebo tests__. The idea is that we randomly assign the treatment to a control unit and perform the Synthetic Control method with this placebo treatment unit, and we repeat this exercise with every control unit.</span>
<span id="cb84-1082"><a href="#cb84-1082" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1083"><a href="#cb84-1083" aria-hidden="true" tabindex="-1"></a>Basically, we test what treatment effect we find if we assign treatment status to a unit that actually did not receive the treatment, thereby giving us a distribution of "treatment effects" for non-treated contries. We can then compare these placebo results to our actual treatment effect.</span>
<span id="cb84-1084"><a href="#cb84-1084" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1085"><a href="#cb84-1085" aria-hidden="true" tabindex="-1"></a>!<span class="co">[</span><span class="ot">Placebo test for Synthetic Control [@Abadie.2010]</span><span class="co">](fig/abadie_placebo.jpg)</span></span>
<span id="cb84-1086"><a href="#cb84-1086" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1087"><a href="#cb84-1087" aria-hidden="true" tabindex="-1"></a>To increase the comparability of the actual treatment unit and placebo treatment units, propose to exclude those units which have a poor pre-treatment fit (left panel above) by dropping those with a mean square prediction error above a specific threshold (right panel above).</span>
<span id="cb84-1088"><a href="#cb84-1088" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1089"><a href="#cb84-1089" aria-hidden="true" tabindex="-1"></a>If the actual treatment effect lies at the extremes of the distribution of the placebo "treatment" units, we can say that the treatment likely had a significant effect on the outcome. If, in contrast, the actual treatment effect lies in the middle of the placebo effects for those not receiving the treatment, this indicates that the treatment did not have a significant influence.</span>
<span id="cb84-1090"><a href="#cb84-1090" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1091"><a href="#cb84-1091" aria-hidden="true" tabindex="-1"></a><span class="fu">### Example</span></span>
<span id="cb84-1092"><a href="#cb84-1092" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1093"><a href="#cb84-1093" aria-hidden="true" tabindex="-1"></a>Can we use our marriage wage premium example and the respective data to perform a Synthetic Control analysis? Why (not)?</span>
<span id="cb84-1094"><a href="#cb84-1094" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1095"><a href="#cb84-1095" aria-hidden="true" tabindex="-1"></a>In R, we can use the package <span class="in">`Synth`</span> to produce Synthetic Control estimates. For a demonstration using Stata by Jens Hainmueller see the following <span class="co">[</span><span class="ot">video</span><span class="co">](https://web.stanford.edu/~jhain/Video/SynthDemo.mp4)</span>.</span>
<span id="cb84-1096"><a href="#cb84-1096" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1097"><a href="#cb84-1097" aria-hidden="true" tabindex="-1"></a>Here, we use the example of @Abadie.2003, analyzing the influence of the terrorist conflict in Basque on economic outcomes.</span>
<span id="cb84-1098"><a href="#cb84-1098" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1101"><a href="#cb84-1101" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb84-1102"><a href="#cb84-1102" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Synth)</span>
<span id="cb84-1103"><a href="#cb84-1103" aria-hidden="true" tabindex="-1"></a><span class="co"># devtools::install_github("bcastanho/SCtools")</span></span>
<span id="cb84-1104"><a href="#cb84-1104" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(SCtools)</span>
<span id="cb84-1105"><a href="#cb84-1105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1106"><a href="#cb84-1106" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">"basque"</span>)</span>
<span id="cb84-1107"><a href="#cb84-1107" aria-hidden="true" tabindex="-1"></a>basque <span class="ot">&lt;-</span> basque[<span class="sc">-</span><span class="fu">which</span>(basque<span class="sc">$</span>regionno <span class="sc">==</span> <span class="dv">1</span>), ]</span>
<span id="cb84-1108"><a href="#cb84-1108" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(basque[basque<span class="sc">$</span>year <span class="sc">&gt;</span> <span class="dv">1963</span>, ])</span>
<span id="cb84-1109"><a href="#cb84-1109" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb84-1110"><a href="#cb84-1110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1111"><a href="#cb84-1111" aria-hidden="true" tabindex="-1"></a>The data contains the GDP per capita for Spanish regions in long format, and several covariates. Our treatment is the onset of political unrest in Basque in the year 1970. However, the terrorist activities were low at the beginning, but increased sharply in 1974.</span>
<span id="cb84-1112"><a href="#cb84-1112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1113"><a href="#cb84-1113" aria-hidden="true" tabindex="-1"></a>First, we need to create a dataprep object which ensures that everything is in the right format for the <span class="in">`synth()`</span> function. Apart from the standard information, we here have to decide which control units should be included, which covariates should be included in the matching procedure, and for which periods these covariates should be included. </span>
<span id="cb84-1114"><a href="#cb84-1114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1115"><a href="#cb84-1115" aria-hidden="true" tabindex="-1"></a>Here we want to include the following covariates:</span>
<span id="cb84-1116"><a href="#cb84-1116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1117"><a href="#cb84-1117" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>The average GDP per capita in 1960 - 1964 and in 1965-1969 (we use the <span class="in">`special.predictors`</span> option).</span>
<span id="cb84-1118"><a href="#cb84-1118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1119"><a href="#cb84-1119" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>The share with high school ("school.high") and more than high school ("school.post.high") for the entire observation period (which need to specified using the option <span class="in">`time.predictors.prior`</span>).</span>
<span id="cb84-1120"><a href="#cb84-1120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1121"><a href="#cb84-1121" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Population density ("popdens") in 1969 (we use the <span class="in">`special.predictors`</span> option).</span>
<span id="cb84-1122"><a href="#cb84-1122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1123"><a href="#cb84-1123" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Percentage working in the agricultural ("sec.agriculture"), the industrial ("sec.industry"), and the service sector ("sec.services.venta") from 1961, 1963, 1965, 1967, 1969 (we use the <span class="in">`special.predictors`</span> option).</span>
<span id="cb84-1124"><a href="#cb84-1124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1127"><a href="#cb84-1127" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb84-1128"><a href="#cb84-1128" aria-hidden="true" tabindex="-1"></a>data_prep.out <span class="ot">&lt;-</span> <span class="fu">dataprep</span>(<span class="at">foo =</span> basque, </span>
<span id="cb84-1129"><a href="#cb84-1129" aria-hidden="true" tabindex="-1"></a>                          <span class="at">predictors =</span> <span class="fu">c</span>(<span class="st">"school.high"</span>, <span class="st">"school.post.high"</span>),</span>
<span id="cb84-1130"><a href="#cb84-1130" aria-hidden="true" tabindex="-1"></a>                          <span class="at">predictors.op =</span> <span class="st">"mean"</span>, </span>
<span id="cb84-1131"><a href="#cb84-1131" aria-hidden="true" tabindex="-1"></a>                          <span class="at">time.predictors.prior =</span> <span class="dv">1960</span><span class="sc">:</span><span class="dv">1969</span>,</span>
<span id="cb84-1132"><a href="#cb84-1132" aria-hidden="true" tabindex="-1"></a>                          <span class="at">special.predictors =</span> <span class="fu">list</span>(</span>
<span id="cb84-1133"><a href="#cb84-1133" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">list</span>(<span class="st">"gdpcap"</span>, <span class="dv">1960</span><span class="sc">:</span><span class="dv">1964</span>, <span class="st">"mean"</span>),</span>
<span id="cb84-1134"><a href="#cb84-1134" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">list</span>(<span class="st">"gdpcap"</span>, <span class="dv">1965</span><span class="sc">:</span><span class="dv">1969</span>, <span class="st">"mean"</span>),</span>
<span id="cb84-1135"><a href="#cb84-1135" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">list</span>(<span class="st">"sec.agriculture"</span>, <span class="fu">seq</span>(<span class="dv">1961</span>, <span class="dv">1969</span>, <span class="dv">2</span>), <span class="st">"mean"</span>),</span>
<span id="cb84-1136"><a href="#cb84-1136" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">list</span>(<span class="st">"sec.industry"</span>, <span class="fu">seq</span>(<span class="dv">1961</span>, <span class="dv">1969</span>, <span class="dv">2</span>), <span class="st">"mean"</span>),</span>
<span id="cb84-1137"><a href="#cb84-1137" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">list</span>(<span class="st">"sec.services.venta"</span>, <span class="fu">seq</span>(<span class="dv">1961</span>, <span class="dv">1969</span>, <span class="dv">2</span>), <span class="st">"mean"</span>)</span>
<span id="cb84-1138"><a href="#cb84-1138" aria-hidden="true" tabindex="-1"></a>                          ),</span>
<span id="cb84-1139"><a href="#cb84-1139" aria-hidden="true" tabindex="-1"></a>                          <span class="at">dependent =</span> <span class="st">"gdpcap"</span>, </span>
<span id="cb84-1140"><a href="#cb84-1140" aria-hidden="true" tabindex="-1"></a>                          <span class="at">unit.variable =</span> <span class="st">"regionno"</span>,</span>
<span id="cb84-1141"><a href="#cb84-1141" aria-hidden="true" tabindex="-1"></a>                          <span class="at">time.variable =</span> <span class="st">"year"</span>, </span>
<span id="cb84-1142"><a href="#cb84-1142" aria-hidden="true" tabindex="-1"></a>                          <span class="at">treatment.identifier =</span> <span class="dv">17</span>,</span>
<span id="cb84-1143"><a href="#cb84-1143" aria-hidden="true" tabindex="-1"></a>                          <span class="at">controls.identifier =</span> <span class="fu">c</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">16</span>, <span class="dv">18</span>), </span>
<span id="cb84-1144"><a href="#cb84-1144" aria-hidden="true" tabindex="-1"></a>                          <span class="at">time.optimize.ssr =</span> <span class="dv">1960</span><span class="sc">:</span><span class="dv">1969</span>, </span>
<span id="cb84-1145"><a href="#cb84-1145" aria-hidden="true" tabindex="-1"></a>                          <span class="at">time.plot =</span> <span class="dv">1960</span><span class="sc">:</span><span class="dv">1997</span>,</span>
<span id="cb84-1146"><a href="#cb84-1146" aria-hidden="true" tabindex="-1"></a>                          <span class="at">unit.names.variable =</span> <span class="st">"regionname"</span>)</span>
<span id="cb84-1147"><a href="#cb84-1147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1148"><a href="#cb84-1148" aria-hidden="true" tabindex="-1"></a><span class="fu">cbind</span>(data_prep.out<span class="sc">$</span>X0, data_prep.out<span class="sc">$</span>X1)</span>
<span id="cb84-1149"><a href="#cb84-1149" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb84-1150"><a href="#cb84-1150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1151"><a href="#cb84-1151" aria-hidden="true" tabindex="-1"></a>So, this prepares a list of different objects that are used in the optimazition algorithm later on. Above, we see all the used covariates used for mathing.</span>
<span id="cb84-1152"><a href="#cb84-1152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1153"><a href="#cb84-1153" aria-hidden="true" tabindex="-1"></a>we can also use it to print the raw trajecotries of the treated region and the control pool</span>
<span id="cb84-1154"><a href="#cb84-1154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1155"><a href="#cb84-1155" aria-hidden="true" tabindex="-1"></a><span class="in">```{r class.source = 'fold-hide', message = FALSE, warning = FALSE}</span></span>
<span id="cb84-1156"><a href="#cb84-1156" aria-hidden="true" tabindex="-1"></a>Y1 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(data_prep.out<span class="sc">$</span>Y1plot)</span>
<span id="cb84-1157"><a href="#cb84-1157" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(Y1) <span class="ot">&lt;-</span> <span class="st">"y"</span></span>
<span id="cb84-1158"><a href="#cb84-1158" aria-hidden="true" tabindex="-1"></a>Y1<span class="sc">$</span>treat <span class="ot">&lt;-</span> <span class="st">"Treatment"</span></span>
<span id="cb84-1159"><a href="#cb84-1159" aria-hidden="true" tabindex="-1"></a>Y1<span class="sc">$</span>year <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">rownames</span>(Y1))</span>
<span id="cb84-1160"><a href="#cb84-1160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1161"><a href="#cb84-1161" aria-hidden="true" tabindex="-1"></a>Y0 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">rowMeans</span>(data_prep.out<span class="sc">$</span>Y0plot))</span>
<span id="cb84-1162"><a href="#cb84-1162" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(Y0) <span class="ot">&lt;-</span> <span class="st">"y"</span></span>
<span id="cb84-1163"><a href="#cb84-1163" aria-hidden="true" tabindex="-1"></a>Y0<span class="sc">$</span>treat <span class="ot">&lt;-</span> <span class="st">"Control"</span></span>
<span id="cb84-1164"><a href="#cb84-1164" aria-hidden="true" tabindex="-1"></a>Y0<span class="sc">$</span>year <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">rownames</span>(Y0))</span>
<span id="cb84-1165"><a href="#cb84-1165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1166"><a href="#cb84-1166" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">rbind</span>(Y1, Y0)</span>
<span id="cb84-1167"><a href="#cb84-1167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1168"><a href="#cb84-1168" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data =</span> data, <span class="fu">aes</span>(<span class="at">x =</span> year, <span class="at">y =</span> y)) <span class="sc">+</span></span>
<span id="cb84-1169"><a href="#cb84-1169" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">group =</span> treat, <span class="at">color =</span> treat, <span class="at">linetype =</span> treat),</span>
<span id="cb84-1170"><a href="#cb84-1170" aria-hidden="true" tabindex="-1"></a>            <span class="at">size =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb84-1171"><a href="#cb84-1171" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">guide =</span> <span class="fu">guide_axis</span>(<span class="at">check.overlap =</span> <span class="cn">TRUE</span>))<span class="sc">+</span></span>
<span id="cb84-1172"><a href="#cb84-1172" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb84-1173"><a href="#cb84-1173" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.key =</span> <span class="fu">element_blank</span>(), <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb84-1174"><a href="#cb84-1174" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.05</span>,<span class="fl">0.95</span>), <span class="at">legend.justification =</span> <span class="fu">c</span>(<span class="st">"left"</span>, <span class="st">"top"</span>),</span>
<span id="cb84-1175"><a href="#cb84-1175" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb84-1176"><a href="#cb84-1176" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.box.background =</span> <span class="fu">element_rect</span>(<span class="at">colour =</span> <span class="st">"black"</span>),</span>
<span id="cb84-1177"><a href="#cb84-1177" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.spacing.y =</span> <span class="fu">unit</span>(<span class="sc">-</span><span class="fl">0.1</span>, <span class="st">"cm"</span>))</span>
<span id="cb84-1178"><a href="#cb84-1178" aria-hidden="true" tabindex="-1"></a>p1</span>
<span id="cb84-1179"><a href="#cb84-1179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1180"><a href="#cb84-1180" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb84-1181"><a href="#cb84-1181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1182"><a href="#cb84-1182" aria-hidden="true" tabindex="-1"></a>This seems pretty hard to compare as there were already strong differences between Basque and other Spanish reasons before the onset of terrorist activities.</span>
<span id="cb84-1183"><a href="#cb84-1183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1184"><a href="#cb84-1184" aria-hidden="true" tabindex="-1"></a>So, let's see if we can do better by estimating a synthetic control unit for Basque using the <span class="in">`synth()`</span> function.</span>
<span id="cb84-1185"><a href="#cb84-1185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1188"><a href="#cb84-1188" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb84-1189"><a href="#cb84-1189" aria-hidden="true" tabindex="-1"></a>synth.out <span class="ot">&lt;-</span> <span class="fu">synth</span>(<span class="at">data.prep.obj =</span> data_prep.out)</span>
<span id="cb84-1190"><a href="#cb84-1190" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb84-1191"><a href="#cb84-1191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1192"><a href="#cb84-1192" aria-hidden="true" tabindex="-1"></a>This already gives us some important information. "solution.v" tells us the weights for the individual covariates, and "solution.w" gives us the weights for the units in the donor pool for constructing the synthetic control unit.</span>
<span id="cb84-1193"><a href="#cb84-1193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1194"><a href="#cb84-1194" aria-hidden="true" tabindex="-1"></a>Before looking at the actual results, it is helpful to check some core statistics. For instance, below we see how well the synthetic control unit mirrors our treated region across the included covariates.</span>
<span id="cb84-1195"><a href="#cb84-1195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1198"><a href="#cb84-1198" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb84-1199"><a href="#cb84-1199" aria-hidden="true" tabindex="-1"></a>synth.tables  <span class="ot">&lt;-</span> <span class="fu">synth.tab</span>(<span class="at">dataprep.res =</span> data_prep.out, <span class="at">synth.res =</span> synth.out)</span>
<span id="cb84-1200"><a href="#cb84-1200" aria-hidden="true" tabindex="-1"></a>synth.tables<span class="sc">$</span>tab.pred</span>
<span id="cb84-1201"><a href="#cb84-1201" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb84-1202"><a href="#cb84-1202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1203"><a href="#cb84-1203" aria-hidden="true" tabindex="-1"></a>For the GDP per capita variables, the synthetic control closely resembles the treated region. That's good!! However, for other covariates like "school.high" or "school.post.high", the synthetic control region matches notatbly worse than the raw sample... Nevertheless, why do we not need to worry so much about that? (look at "solution.v" above)</span>
<span id="cb84-1204"><a href="#cb84-1204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1205"><a href="#cb84-1205" aria-hidden="true" tabindex="-1"></a>Obviously, we also want to know the weights that each region receives for the construction of the synthetic control.</span>
<span id="cb84-1206"><a href="#cb84-1206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1209"><a href="#cb84-1209" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb84-1210"><a href="#cb84-1210" aria-hidden="true" tabindex="-1"></a>synth.tables<span class="sc">$</span>tab.w</span>
<span id="cb84-1211"><a href="#cb84-1211" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb84-1212"><a href="#cb84-1212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1213"><a href="#cb84-1213" aria-hidden="true" tabindex="-1"></a>So, only the Baleares, Cataluna and Madrid contribute to the synthetic control region, while all others are set to zero. Cataluna by far receives the highest weight.</span>
<span id="cb84-1214"><a href="#cb84-1214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1215"><a href="#cb84-1215" aria-hidden="true" tabindex="-1"></a>Finally, how does the synthetic control average look like and how does it compare to the treated unit of Basque?</span>
<span id="cb84-1216"><a href="#cb84-1216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1219"><a href="#cb84-1219" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb84-1220"><a href="#cb84-1220" aria-hidden="true" tabindex="-1"></a><span class="fu">path.plot</span>(<span class="at">synth.res =</span> synth.out, <span class="at">dataprep.res =</span> data_prep.out,</span>
<span id="cb84-1221"><a href="#cb84-1221" aria-hidden="true" tabindex="-1"></a>          <span class="at">Ylab =</span> <span class="fu">c</span>(<span class="st">"GDP per capita"</span>))</span>
<span id="cb84-1222"><a href="#cb84-1222" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb84-1223"><a href="#cb84-1223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1224"><a href="#cb84-1224" aria-hidden="true" tabindex="-1"></a>Before 1970, the synthetic control region aligns very well with the Basque region. From 1970, Basque shows a slightly lower GDP than its counterfactual with terrorist activities. From 1974/75 (after the sharp increase in terrorist activities) we see a pronounced decline in the GDP as compared to the synthetic control unit.</span>
<span id="cb84-1225"><a href="#cb84-1225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1226"><a href="#cb84-1226" aria-hidden="true" tabindex="-1"></a>We can also show these differences more clearly, when plotting the differences instead of the trajectory.</span>
<span id="cb84-1227"><a href="#cb84-1227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1230"><a href="#cb84-1230" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb84-1231"><a href="#cb84-1231" aria-hidden="true" tabindex="-1"></a><span class="fu">gaps.plot</span>(<span class="at">synth.res =</span> synth.out, <span class="at">dataprep.res =</span> data_prep.out,</span>
<span id="cb84-1232"><a href="#cb84-1232" aria-hidden="true" tabindex="-1"></a>          <span class="at">Ylab =</span> <span class="fu">c</span>(<span class="st">"Difference in GDP per capita"</span>))</span>
<span id="cb84-1233"><a href="#cb84-1233" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb84-1234"><a href="#cb84-1234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1235"><a href="#cb84-1235" aria-hidden="true" tabindex="-1"></a>__Inferencial statistics__</span>
<span id="cb84-1236"><a href="#cb84-1236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1237"><a href="#cb84-1237" aria-hidden="true" tabindex="-1"></a>However, is this difference statistically significant or might it be a result of pure chance?</span>
<span id="cb84-1238"><a href="#cb84-1238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1239"><a href="#cb84-1239" aria-hidden="true" tabindex="-1"></a>So give some intuition of the significance of the treatment effect, we perform an interaction of placebo test, artificially assigning the treatment status to control regions.</span>
<span id="cb84-1240"><a href="#cb84-1240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1241"><a href="#cb84-1241" aria-hidden="true" tabindex="-1"></a>The function <span class="in">`generate.placebos()`</span> of the <span class="in">`SCtools`</span> package does all of this automatically for us.</span>
<span id="cb84-1242"><a href="#cb84-1242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1243"><a href="#cb84-1243" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, results = 'hide', message = FALSE, warning = FALSE}</span></span>
<span id="cb84-1244"><a href="#cb84-1244" aria-hidden="true" tabindex="-1"></a>placebo <span class="ot">&lt;-</span> <span class="fu">generate.placebos</span>(<span class="at">dataprep.out =</span> data_prep.out,</span>
<span id="cb84-1245"><a href="#cb84-1245" aria-hidden="true" tabindex="-1"></a>                             <span class="at">synth.out =</span> synth.out, </span>
<span id="cb84-1246"><a href="#cb84-1246" aria-hidden="true" tabindex="-1"></a>                             <span class="at">strategy =</span> <span class="st">"multisession"</span>)</span>
<span id="cb84-1247"><a href="#cb84-1247" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb84-1248"><a href="#cb84-1248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1249"><a href="#cb84-1249" aria-hidden="true" tabindex="-1"></a>Also creating the respective plot.</span>
<span id="cb84-1250"><a href="#cb84-1250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1253"><a href="#cb84-1253" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb84-1254"><a href="#cb84-1254" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_placebos</span>(placebo)</span>
<span id="cb84-1255"><a href="#cb84-1255" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb84-1256"><a href="#cb84-1256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1257"><a href="#cb84-1257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1258"><a href="#cb84-1258" aria-hidden="true" tabindex="-1"></a>The real treatment region seems quite special. For some control regions, we observe similarly stong "treatment effects". However, these extreme regions have a poor pre-treatment fit, and thus should be disregarded.</span>
<span id="cb84-1259"><a href="#cb84-1259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1260"><a href="#cb84-1260" aria-hidden="true" tabindex="-1"></a><span class="fu"># Generalized Synthetic Control</span></span>
<span id="cb84-1261"><a href="#cb84-1261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1262"><a href="#cb84-1262" aria-hidden="true" tabindex="-1"></a>Generalized Synthetic Control <span class="co">[</span><span class="ot">@Xu.2017</span><span class="co">]</span> is a way of generalising the "qualitative" approach with one single treated unit to a setting with multiple treated units based on Interactive Fixed Effects or Factor Models:</span>
<span id="cb84-1263"><a href="#cb84-1263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1264"><a href="#cb84-1264" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb84-1265"><a href="#cb84-1265" aria-hidden="true" tabindex="-1"></a>Y_{it} = \sum_{r=1}^R \gamma_{ir} \delta_{tr} + \epsilon_{it} \quad \text{or} \quad,</span>
<span id="cb84-1266"><a href="#cb84-1266" aria-hidden="true" tabindex="-1"></a>\mathbf{Y} = \mathbf U \mathbf V^\mathrm T + \mathbf{\varepsilon}.</span>
<span id="cb84-1267"><a href="#cb84-1267" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb84-1268"><a href="#cb84-1268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1269"><a href="#cb84-1269" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>with with $\mathbf U$ being an $N \times r$ matrix of unknown factor loadings (unit-specific intercepts),</span>
<span id="cb84-1270"><a href="#cb84-1270" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>and $\mathbf V$ an $T \times r$  matrix of unobserved common factors (time-varying coefficients).</span>
<span id="cb84-1271"><a href="#cb84-1271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1272"><a href="#cb84-1272" aria-hidden="true" tabindex="-1"></a>Estimate $<span class="sc">\\</span>delta$ and $<span class="sc">\\</span>gamma$ by least squares and use to impute missing values.</span>
<span id="cb84-1273"><a href="#cb84-1273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1274"><a href="#cb84-1274" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb84-1275"><a href="#cb84-1275" aria-hidden="true" tabindex="-1"></a>\hat Y _{NT} = \sum_{r=1}^R \hat \delta_{Nr} \hat \gamma_{rT}.</span>
<span id="cb84-1276"><a href="#cb84-1276" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb84-1277"><a href="#cb84-1277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1278"><a href="#cb84-1278" aria-hidden="true" tabindex="-1"></a>In a matrix form, the $Y_{N \times T}$ can be rewritten as:</span>
<span id="cb84-1279"><a href="#cb84-1279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1280"><a href="#cb84-1280" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb84-1281"><a href="#cb84-1281" aria-hidden="true" tabindex="-1"></a>Y_{N\times T}= \mathbf U \mathbf V^\mathrm T + \epsilon_{N \times T} =  \mathbf L_{N \times T} + \epsilon_{N \times T} = <span class="sc">\\</span> \left(</span>
<span id="cb84-1282"><a href="#cb84-1282" aria-hidden="true" tabindex="-1"></a>\begin{array}{ccccccc}</span>
<span id="cb84-1283"><a href="#cb84-1283" aria-hidden="true" tabindex="-1"></a> \delta_{11} &amp; \dots &amp; \delta_{R1}  <span class="sc">\\</span></span>
<span id="cb84-1284"><a href="#cb84-1284" aria-hidden="true" tabindex="-1"></a>\vdots &amp; \dots &amp; \vdots   <span class="sc">\\</span></span>
<span id="cb84-1285"><a href="#cb84-1285" aria-hidden="true" tabindex="-1"></a>\vdots &amp; \dots &amp; \vdots   <span class="sc">\\</span></span>
<span id="cb84-1286"><a href="#cb84-1286" aria-hidden="true" tabindex="-1"></a>\vdots &amp; \dots &amp; \vdots   <span class="sc">\\</span></span>
<span id="cb84-1287"><a href="#cb84-1287" aria-hidden="true" tabindex="-1"></a>\delta_{1N} &amp; \dots &amp; \delta_{RN}  <span class="sc">\\</span></span>
<span id="cb84-1288"><a href="#cb84-1288" aria-hidden="true" tabindex="-1"></a>\end{array}\right)</span>
<span id="cb84-1289"><a href="#cb84-1289" aria-hidden="true" tabindex="-1"></a>\left(</span>
<span id="cb84-1290"><a href="#cb84-1290" aria-hidden="true" tabindex="-1"></a>\begin{array}{ccccccc}</span>
<span id="cb84-1291"><a href="#cb84-1291" aria-hidden="true" tabindex="-1"></a>\gamma_{11}  &amp; \dots \dots \dots &amp; \gamma_{1T}  <span class="sc">\\</span></span>
<span id="cb84-1292"><a href="#cb84-1292" aria-hidden="true" tabindex="-1"></a>\vdots &amp; \dots \dots \dots &amp; \vdots   <span class="sc">\\</span></span>
<span id="cb84-1293"><a href="#cb84-1293" aria-hidden="true" tabindex="-1"></a>\gamma_{R1}  &amp; \dots \dots \dots &amp; \gamma_{RT}  <span class="sc">\\</span></span>
<span id="cb84-1294"><a href="#cb84-1294" aria-hidden="true" tabindex="-1"></a>\end{array}</span>
<span id="cb84-1295"><a href="#cb84-1295" aria-hidden="true" tabindex="-1"></a>\right) + \epsilon_{N \times T}</span>
<span id="cb84-1296"><a href="#cb84-1296" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb84-1297"><a href="#cb84-1297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1298"><a href="#cb84-1298" aria-hidden="true" tabindex="-1"></a><span class="fu"># Matrix Completion</span></span>
<span id="cb84-1299"><a href="#cb84-1299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1300"><a href="#cb84-1300" aria-hidden="true" tabindex="-1"></a>Matrix Completion <span class="co">[</span><span class="ot">@Athey.2021</span><span class="co">]</span> uses a very similar approach. Instead of estimating the factors, we estimate the matrix $\mathbf L_{N \times T}$ directly. It is supposed to generalise the horizontal and vertical approach.</span>
<span id="cb84-1301"><a href="#cb84-1301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1302"><a href="#cb84-1302" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb84-1303"><a href="#cb84-1303" aria-hidden="true" tabindex="-1"></a>Y_{N\times T}=\left(</span>
<span id="cb84-1304"><a href="#cb84-1304" aria-hidden="true" tabindex="-1"></a>\begin{array}{cccccccccc}</span>
<span id="cb84-1305"><a href="#cb84-1305" aria-hidden="true" tabindex="-1"></a> {\color{red} ?} &amp; {\color{red} ?} &amp; {\color{red} ?} &amp; {\color{red} ?} &amp; {\color{red} ?}&amp; \checkmark  &amp; \dots  &amp; {\color{red} ?}<span class="sc">\\</span></span>
<span id="cb84-1306"><a href="#cb84-1306" aria-hidden="true" tabindex="-1"></a>\checkmark &amp; {\color{red} ?} &amp; {\color{red} ?} &amp; {\color{red} ?} &amp; \checkmark &amp; {\color{red} ?}   &amp; \dots &amp; \checkmark  <span class="sc">\\</span></span>
<span id="cb84-1307"><a href="#cb84-1307" aria-hidden="true" tabindex="-1"></a>{\color{red} ?}  &amp; \checkmark &amp; {\color{red} ?}  &amp; {\color{red} ?} &amp; {\color{red} ?} &amp; {\color{red} ?} &amp; \dots &amp; {\color{red} ?}  <span class="sc">\\</span></span>
<span id="cb84-1308"><a href="#cb84-1308" aria-hidden="true" tabindex="-1"></a> {\color{red} ?} &amp; {\color{red} ?} &amp; {\color{red} ?} &amp; {\color{red} ?} &amp; {\color{red} ?}&amp; \checkmark  &amp; \dots  &amp; {\color{red} ?}<span class="sc">\\</span></span>
<span id="cb84-1309"><a href="#cb84-1309" aria-hidden="true" tabindex="-1"></a>\checkmark &amp; {\color{red} ?} &amp; {\color{red} ?} &amp; {\color{red} ?} &amp; {\color{red} ?} &amp; {\color{red} ?}   &amp; \dots &amp; \checkmark  <span class="sc">\\</span></span>
<span id="cb84-1310"><a href="#cb84-1310" aria-hidden="true" tabindex="-1"></a>{\color{red} ?}  &amp; \checkmark &amp; {\color{red} ?}  &amp; {\color{red} ?} &amp; {\color{red} ?} &amp; {\color{red} ?} &amp; \dots &amp; {\color{red} ?}  <span class="sc">\\</span></span>
<span id="cb84-1311"><a href="#cb84-1311" aria-hidden="true" tabindex="-1"></a>\vdots   &amp;  \vdots &amp; \vdots &amp;\vdots   &amp;  \vdots &amp; \vdots &amp;\ddots &amp;\vdots <span class="sc">\\</span></span>
<span id="cb84-1312"><a href="#cb84-1312" aria-hidden="true" tabindex="-1"></a>{\color{red} ?}  &amp; {\color{red} ?} &amp; {\color{red} ?} &amp; {\color{red} ?}&amp; \checkmark &amp; {\color{red} ?}   &amp; \dots &amp; {\color{red} ?}<span class="sc">\\</span></span>
<span id="cb84-1313"><a href="#cb84-1313" aria-hidden="true" tabindex="-1"></a>\end{array}</span>
<span id="cb84-1314"><a href="#cb84-1314" aria-hidden="true" tabindex="-1"></a>\right)</span>
<span id="cb84-1315"><a href="#cb84-1315" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb84-1316"><a href="#cb84-1316" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1317"><a href="#cb84-1317" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1318"><a href="#cb84-1318" aria-hidden="true" tabindex="-1"></a>This can be done via Nuclear Norm Minimization:</span>
<span id="cb84-1319"><a href="#cb84-1319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1320"><a href="#cb84-1320" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb84-1321"><a href="#cb84-1321" aria-hidden="true" tabindex="-1"></a>\min_{L}\frac{1}{|\cal{O}|}</span>
<span id="cb84-1322"><a href="#cb84-1322" aria-hidden="true" tabindex="-1"></a>\sum_{(i,t) \in \cal{o}} \left(Y_{it} -</span>
<span id="cb84-1323"><a href="#cb84-1323" aria-hidden="true" tabindex="-1"></a>L_{it} \right)^2+\lambda_L \|L\|_*</span>
<span id="cb84-1324"><a href="#cb84-1324" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb84-1325"><a href="#cb84-1325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1326"><a href="#cb84-1326" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>where $\cal{O}$ denote the set of pairs of indices corresponding to the observed entries (the entries with $W_{it} = 0$).</span>
<span id="cb84-1327"><a href="#cb84-1327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1328"><a href="#cb84-1328" aria-hidden="true" tabindex="-1"></a>Given any $N\times T$ matrix $A$, define the two $N\times T$ matrices  $P_\cal{O}(A)$</span>
<span id="cb84-1329"><a href="#cb84-1329" aria-hidden="true" tabindex="-1"></a>and  $P_\cal{O}^\perp(A)$</span>
<span id="cb84-1330"><a href="#cb84-1330" aria-hidden="true" tabindex="-1"></a>with typical elements:</span>
<span id="cb84-1331"><a href="#cb84-1331" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb84-1332"><a href="#cb84-1332" aria-hidden="true" tabindex="-1"></a>P_\cal{O}(A)_{it}=</span>
<span id="cb84-1333"><a href="#cb84-1333" aria-hidden="true" tabindex="-1"></a>\left<span class="sc">\{</span></span>
<span id="cb84-1334"><a href="#cb84-1334" aria-hidden="true" tabindex="-1"></a>\begin{array}{ll}</span>
<span id="cb84-1335"><a href="#cb84-1335" aria-hidden="true" tabindex="-1"></a>A_{it}\hskip1cm &amp; {\rm if}\ (i,t)\in\cal{O}\,,<span class="sc">\\</span></span>
<span id="cb84-1336"><a href="#cb84-1336" aria-hidden="true" tabindex="-1"></a>0&amp;{\rm if}\ (i,t)\notin\cal{O}\,,</span>
<span id="cb84-1337"><a href="#cb84-1337" aria-hidden="true" tabindex="-1"></a>\end{array}\right.</span>
<span id="cb84-1338"><a href="#cb84-1338" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb84-1339"><a href="#cb84-1339" aria-hidden="true" tabindex="-1"></a>and</span>
<span id="cb84-1340"><a href="#cb84-1340" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb84-1341"><a href="#cb84-1341" aria-hidden="true" tabindex="-1"></a>P_\cal{O}^\perp(A)_{it}=</span>
<span id="cb84-1342"><a href="#cb84-1342" aria-hidden="true" tabindex="-1"></a>\left<span class="sc">\{</span></span>
<span id="cb84-1343"><a href="#cb84-1343" aria-hidden="true" tabindex="-1"></a>\begin{array}{ll}</span>
<span id="cb84-1344"><a href="#cb84-1344" aria-hidden="true" tabindex="-1"></a>0\hskip1cm &amp; {\rm if}\ (i,t)\in\cal{O}\,,<span class="sc">\\</span></span>
<span id="cb84-1345"><a href="#cb84-1345" aria-hidden="true" tabindex="-1"></a>A_{it}&amp;{\rm if}\ (i,t)\notin\cal{O}\,.</span>
<span id="cb84-1346"><a href="#cb84-1346" aria-hidden="true" tabindex="-1"></a>\end{array}\right.</span>
<span id="cb84-1347"><a href="#cb84-1347" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb84-1348"><a href="#cb84-1348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1349"><a href="#cb84-1349" aria-hidden="true" tabindex="-1"></a>Let $A=S\Sigma R^\top$ be the Singular Value Decomposition for $A$, with  $\sigma_1(A),\ldots,\sigma_{\min(N,T)}(A)$, denoting the singular values. Then define the matrix shrinkage operator</span>
<span id="cb84-1350"><a href="#cb84-1350" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb84-1351"><a href="#cb84-1351" aria-hidden="true" tabindex="-1"></a>\ shrink_\lambda(A)=S \tilde\Sigma R^\top\,,</span>
<span id="cb84-1352"><a href="#cb84-1352" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb84-1353"><a href="#cb84-1353" aria-hidden="true" tabindex="-1"></a>where $\tilde\Sigma$ is equal to $\Sigma$ with the $i$-th  singular value $\sigma_i(A)$ replaced by $\max(\sigma_i(A)-\lambda,0)$.</span>
<span id="cb84-1354"><a href="#cb84-1354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1355"><a href="#cb84-1355" aria-hidden="true" tabindex="-1"></a><span class="fu">### The algorithm </span></span>
<span id="cb84-1356"><a href="#cb84-1356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1357"><a href="#cb84-1357" aria-hidden="true" tabindex="-1"></a>(1) Start with the initial choice $L_1(\lambda)=P_\cal{O}(Y)$, with zeros for the missing values.</span>
<span id="cb84-1358"><a href="#cb84-1358" aria-hidden="true" tabindex="-1"></a>(2) Then for $k=1,2,\ldots,$ define,</span>
<span id="cb84-1359"><a href="#cb84-1359" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb84-1360"><a href="#cb84-1360" aria-hidden="true" tabindex="-1"></a>L_{k+1}(\lambda)=shrink_\lambda\Biggl<span class="sc">\{</span>P_\cal{O}(Y)+P_\cal{O}^\perp\Big(L_k(\lambda)\Big)\Biggr<span class="sc">\}</span>\,</span>
<span id="cb84-1361"><a href="#cb84-1361" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb84-1362"><a href="#cb84-1362" aria-hidden="true" tabindex="-1"></a>until the sequence $\left<span class="sc">\{</span>L_k(\lambda)\right<span class="sc">\}</span>_{k\ge 1}$ converges.</span>
<span id="cb84-1363"><a href="#cb84-1363" aria-hidden="true" tabindex="-1"></a>(3) The limiting matrix $L^*$ is our estimator for the regularization parameter $\lambda$, denoted by $\hat{L}(\lambda,\cal{O})$.</span>
<span id="cb84-1364"><a href="#cb84-1364" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1365"><a href="#cb84-1365" aria-hidden="true" tabindex="-1"></a><span class="al">![](fig/correlation.png)</span></span>
<span id="cb84-1366"><a href="#cb84-1366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-1367"><a href="#cb84-1367" aria-hidden="true" tabindex="-1"></a><span class="fu"># References</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



</body></html>