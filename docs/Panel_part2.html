<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="Tobias Rüttenauer" />

<meta name="date" content="2021-12-03" />

<title>2) Extensions</title>

<script src="site_libs/header-attrs-2.17/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/flatly.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<script src="site_libs/navigation-1.1/codefolding.js"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>



<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; } /* Alert */
code span.an { color: #008000; } /* Annotation */
code span.at { } /* Attribute */
code span.bu { } /* BuiltIn */
code span.cf { color: #0000ff; } /* ControlFlow */
code span.ch { color: #008080; } /* Char */
code span.cn { } /* Constant */
code span.co { color: #008000; } /* Comment */
code span.cv { color: #008000; } /* CommentVar */
code span.do { color: #008000; } /* Documentation */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.im { } /* Import */
code span.in { color: #008000; } /* Information */
code span.kw { color: #0000ff; } /* Keyword */
code span.op { } /* Operator */
code span.ot { color: #ff4000; } /* Other */
code span.pp { color: #ff4000; } /* Preprocessor */
code span.sc { color: #008080; } /* SpecialChar */
code span.ss { color: #008080; } /* SpecialString */
code span.st { color: #008080; } /* String */
code span.va { } /* Variable */
code span.vs { color: #008080; } /* VerbatimString */
code span.wa { color: #008000; font-weight: bold; } /* Warning */

.sourceCode .row {
  width: 100%;
}
.sourceCode {
  overflow-x: auto;
}
.code-folding-btn {
  margin-right: -30px;
}
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>



<style type="text/css">
/* for pandoc --citeproc since 2.11 */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>




<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark the anchor link active (and if it's in a dropdown, also mark that active)
  var dropdown = menuAnchor.closest('li.dropdown');
  if (window.bootstrap) { // Bootstrap 4+
    menuAnchor.addClass('active');
    dropdown.find('> .dropdown-toggle').addClass('active');
  } else { // Bootstrap 3
    menuAnchor.parent().addClass('active');
    dropdown.addClass('active');
  }

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before, .tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "\e259";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "\e258";
  font-family: 'Glyphicons Halflings';
  border: none;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->
<style type="text/css">
.code-folding-btn { margin-bottom: 4px; }
</style>



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}

.tocify-subheader {
  display: inline;
}
.tocify-subheader .tocify-item {
  font-size: 0.95em;
}

</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbar" data-bs-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Panel Data Analysis</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li>
  <a href="Panel_part1.html">1) Panel data methods</a>
</li>
<li>
  <a href="Panel_part2.html">2) Extensions</a>
</li>
<li>
  <a href="Panel_part3.html">3) Exercises</a>
</li>
<li>
  <a href="Panel_part3_solutions.html">Solutions</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">

<div class="btn-group pull-right float-right">
<button type="button" class="btn btn-default btn-xs btn-secondary btn-sm dropdown-toggle" data-toggle="dropdown" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span>Code</span> <span class="caret"></span></button>
<ul class="dropdown-menu dropdown-menu-right" style="min-width: 50px;">
<li><a id="rmd-show-all-code" href="#">Show All Code</a></li>
<li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li>
</ul>
</div>



<h1 class="title toc-ignore">2) Extensions</h1>
<h4 class="author">Tobias Rüttenauer</h4>
<h4 class="date">December 03, 2021</h4>

</div>


<div id="required-packages" class="section level3">
<h3>Required packages</h3>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>pkgs <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;plm&quot;</span>, <span class="st">&quot;feisr&quot;</span>, <span class="st">&quot;did&quot;</span>, <span class="st">&quot;Synth&quot;</span>, <span class="st">&quot;SCtools&quot;</span>, </span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;panelView&quot;</span>, <span class="st">&quot;texreg&quot;</span>, <span class="st">&quot;tidyr&quot;</span>, <span class="st">&quot;dplyr&quot;</span>, <span class="st">&quot;ggplot2&quot;</span>, <span class="st">&quot;ggforce&quot;</span>) </span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">lapply</span>(pkgs, require, <span class="at">character.only =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
</div>
<div id="session-info" class="section level3">
<h3>Session info</h3>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span></code></pre></div>
<pre><code>## R version 4.2.1 (2022-06-23 ucrt)
## Platform: x86_64-w64-mingw32/x64 (64-bit)
## Running under: Windows 10 x64 (build 19043)
## 
## Matrix products: default
## 
## locale:
## [1] LC_COLLATE=English_United Kingdom.utf8 
## [2] LC_CTYPE=English_United Kingdom.utf8   
## [3] LC_MONETARY=English_United Kingdom.utf8
## [4] LC_NUMERIC=C                           
## [5] LC_TIME=English_United Kingdom.utf8    
## 
## attached base packages:
## [1] stats     graphics  grDevices utils     datasets  methods   base     
## 
## other attached packages:
##  [1] ggforce_0.4.1    ggplot2_3.3.6    dplyr_1.0.10     tidyr_1.2.1     
##  [5] texreg_1.38.6    panelView_1.1.11 SCtools_0.3.2.1  future_1.28.0   
##  [9] Synth_1.1-6      did_2.1.2        feisr_1.3.0      plm_2.6-2       
## 
## loaded via a namespace (and not attached):
##  [1] nlme_3.1-157        httr_1.4.4          dreamerr_1.2.3     
##  [4] numDeriv_2016.8-1.1 tools_4.2.1         BMisc_1.4.5        
##  [7] backports_1.4.1     bslib_0.4.0         utf8_1.2.2         
## [10] R6_2.5.1            DBI_1.1.3           colorspace_2.0-3   
## [13] withr_2.5.0         tidyselect_1.2.0    gridExtra_2.3      
## [16] compiler_4.2.1      cli_3.4.1           sandwich_3.0-2     
## [19] sass_0.4.2          scales_1.2.1        lmtest_0.9-40      
## [22] rgenoud_5.9-0.3     fixest_0.10.4       stringr_1.4.1      
## [25] digest_0.6.29       rmarkdown_2.17      pkgconfig_2.0.3    
## [28] htmltools_0.5.3     parallelly_1.32.1   fastmap_1.1.0      
## [31] collapse_1.8.9      rlang_1.0.6         rstudioapi_0.14    
## [34] farver_2.1.1        jquerylib_0.1.4     generics_0.1.3     
## [37] zoo_1.8-11          jsonlite_1.8.2      car_3.1-0          
## [40] magrittr_2.0.3      Formula_1.2-4       Matrix_1.5-1       
## [43] Rcpp_1.0.9          munsell_0.5.0       fansi_1.0.3        
## [46] abind_1.4-5         lifecycle_1.0.3     stringi_1.7.8      
## [49] yaml_2.3.5          carData_3.0-5       MASS_7.3-57        
## [52] grid_4.2.1          parallel_4.2.1      listenv_0.8.0      
## [55] bdsmatrix_1.3-6     lattice_0.20-45     knitr_1.40         
## [58] pillar_1.8.1        ggpubr_0.4.0        ggsignif_0.6.4     
## [61] codetools_0.2-18    glue_1.6.2          evaluate_0.17      
## [64] LowRankQP_1.0.5     data.table_1.14.2   tweenr_2.0.2       
## [67] vctrs_0.4.2         Rdpack_2.4          miscTools_0.6-26   
## [70] polyclip_1.10-4     gtable_0.3.1        purrr_0.3.5        
## [73] kernlab_0.9-31      assertthat_0.2.1    cachem_1.0.6       
## [76] xfun_0.33           rbibutils_2.2.9     xtable_1.8-4       
## [79] broom_1.0.1         lfe_2.8-8           rstatix_0.7.0      
## [82] tibble_3.1.8        optimx_2022-4.30    maxLik_1.5-2       
## [85] globals_0.16.1</code></pre>
</div>
<div id="outline" class="section level1">
<h1>Outline</h1>
<ul>
<li><p>Fixed Effects Individual Slopes</p></li>
<li><p>Dynamic treatment effects</p></li>
<li><p>Dynamic Diff-in-Diff</p></li>
<li><p>Synthetic Control</p></li>
<li><p>TBD: Generalized Synthetic Control</p></li>
</ul>
</div>
<div id="fixed-effects-individual-slopes" class="section level1">
<h1>Fixed Effects Individual Slopes</h1>
<p>Remeber that we have to make the parallel trends assumption in
twoways FE models. A violation of the parallel trends assumption leads
to biased estimates. Usually, when controlling for time fixed effects,
we make the assumption that every observation experiences the same
“effect of time”.</p>
<p>However, we can relax this assumption by giving each individual their
own intercept <strong>and</strong> their own slope.</p>
<p>The fixed effects individual slope (FEIS) estimator is a more general
version of the well-known fixed effects estimator (FE), which allows to
control for heterogeneous slopes in addition to time-constant
heterogeneity <span class="citation">(e.g. <a
href="#ref-Bruderl.2015.387" role="doc-biblioref">Brüderl and Ludwig
2015</a>; <a href="#ref-Polachek.1994.0" role="doc-biblioref">Polachek
and Kim 1994</a>; <a href="#ref-Ruttenauer.2020"
role="doc-biblioref">Rüttenauer and Ludwig 2020</a>; <a
href="#ref-Wooldridge.2010.384" role="doc-biblioref">Wooldridge
2010</a>)</span>. Formally, the FEIS estimator can be expressed as</p>
<p><span class="math display">\[
\begin{align}
\boldsymbol{\mathbf{y}}_{i} =&amp;
\boldsymbol{\mathbf{X}}_{i}\boldsymbol{\mathbf{\beta }}+
\boldsymbol{\mathbf{W}}_i \boldsymbol{\mathbf{\alpha}}_i +
\boldsymbol{\mathbf{\epsilon}}_{i},
\end{align}
\]</span> where <span
class="math inline">\(\boldsymbol{\mathbf{y}}_{i}\)</span> is <span
class="math inline">\(T \times 1\)</span>, <span
class="math inline">\(\boldsymbol{\mathbf{X}}_{i}\)</span> is <span
class="math inline">\(T \times K\)</span>, and <span
class="math inline">\(\boldsymbol{\mathbf{\epsilon}}_{i}\)</span> is
<span class="math inline">\(T \times 1\)</span>. <span
class="math inline">\(\boldsymbol{\mathbf{W}}_i\)</span> is a <span
class="math inline">\(T \times J\)</span> matrix of slope variables, and
<span class="math inline">\(\boldsymbol{\mathbf{\alpha}}_i\)</span> a
<span class="math inline">\(J \times 1\)</span> vector of
individual-specific slope parameters, for <span
class="math inline">\(J\)</span> slope parameters including a constant
term. If <span class="math inline">\(\boldsymbol{\mathbf{W}}_i\)</span>
consists of a constant term only, <span
class="math inline">\(\boldsymbol{\mathbf{W}}_i =
\boldsymbol{\mathbf{1}}\)</span>, thus <span
class="math inline">\(\boldsymbol{\mathbf{\alpha}}_i\)</span> reduces to
<span class="math inline">\(\alpha_{i1}\)</span>, and the above equation
represents the well-known formula of a conventional FE model with
individual fixed effects.</p>
<p>As with the conventional FE, FEIS can be estimated using
<code>lm()</code> by including <span class="math inline">\(N-1\)</span>
individual-specific dummies and interaction terms of each slope variable
with the <span class="math inline">\(N-1\)</span> individual-specific
dummies (<span class="math inline">\((N-1) *J\)</span> controls). This
is however highly inefficient. As with the conventional FE estimator, we
can achieve the same result by running an <code>lm()</code> on
pre-transformed data. Therefore, specify the ‘residual maker’ matrix
<span class="math inline">\(\boldsymbol{\mathbf{M}}_i =
\boldsymbol{\mathbf{I}}_T -
\boldsymbol{\mathbf{W}}_i(\boldsymbol{\mathbf{W}}^\intercal_i
\boldsymbol{\mathbf{W}}_i)^{-1}\boldsymbol{\mathbf{W}}^\intercal_i\)</span>,
and estimate <span class="math display">\[
\begin{align}
y_{it} - \hat{y}_{it} =&amp; (\boldsymbol{\mathbf{x}}_{it} -
\hat{\boldsymbol{\mathbf{x}}}_{it})\boldsymbol{\mathbf{\beta }}+
\epsilon_{it} - \hat{\epsilon}_{it}, \\
\boldsymbol{\mathbf{M}}_i \boldsymbol{\mathbf{y}}_i =&amp;
\boldsymbol{\mathbf{M}}_i
\boldsymbol{\mathbf{X}}_i\boldsymbol{\mathbf{\beta }}+
\boldsymbol{\mathbf{M}}_i \boldsymbol{\mathbf{\epsilon}}_{i}, \\
\tilde{\boldsymbol{\mathbf{y}}}_{i} =&amp;
\tilde{\boldsymbol{\mathbf{X}}}_{i}\boldsymbol{\mathbf{\beta }}+
\tilde{\boldsymbol{\mathbf{\epsilon}}}_{i},
\end{align}
\]</span> where <span
class="math inline">\(\tilde{\boldsymbol{\mathbf{y}}}_{i}\)</span>,
<span
class="math inline">\(\tilde{\boldsymbol{\mathbf{X}}}_{i}\)</span>, and
<span
class="math inline">\(\tilde{\boldsymbol{\mathbf{\epsilon}}}_{i}\)</span>
are the residuals of regressing <span
class="math inline">\(\boldsymbol{\mathbf{y}}_{i}\)</span>, each
column-vector of <span
class="math inline">\(\boldsymbol{\mathbf{X}}_{i}\)</span>, and <span
class="math inline">\(\boldsymbol{\mathbf{\epsilon}}_{i}\)</span> on
<span class="math inline">\(\boldsymbol{\mathbf{W}}_i\)</span>.</p>
<p><strong>Intuitively</strong>, we</p>
<ol style="list-style-type: decimal">
<li><p>estimate the individual-specific predicted values for the
dependent variable and each covariate based on an individual intercept
and the additional slope variables of <span
class="math inline">\(\boldsymbol{\mathbf{W}}_i\)</span>,</p></li>
<li><p>‘detrend’ the original data by these individual-specific
predicted values, and</p></li>
<li><p>run an OLS model on the residual (‘detrended’) data.</p></li>
</ol>
<p>Similarly, we can estimate a correlated random effects (CRE) model
<span class="citation">(<a href="#ref-Chamberlain.1982"
role="doc-biblioref">Chamberlain 1982</a>; <a href="#ref-Mundlak.1978.0"
role="doc-biblioref">Mundlak 1978</a>; <a
href="#ref-Wooldridge.2010.384" role="doc-biblioref">Wooldridge
2010</a>)</span> including the individual specific predictions <span
class="math inline">\(\hat{\boldsymbol{\mathbf{X}}}_{i}\)</span> to
obtain the FEIS estimator: <span class="math display">\[
\begin{align}
\boldsymbol{\mathbf{y}}_{i} =&amp;
\boldsymbol{\mathbf{X}}_{i}\boldsymbol{\mathbf{\beta }}+
\hat{\boldsymbol{\mathbf{X}}}_{i}\boldsymbol{\mathbf{\rho }}+
\boldsymbol{\mathbf{\epsilon}}_{i}.
\end{align}
\]</span></p>
<p>Although we are here mainly interested in controlling for individual
time, FEIS can be used to control for individual specific effects of any
covariate. For instance, <span class="citation">Rüttenauer and Ludwig
(<a href="#ref-Ruttenauer.2020" role="doc-biblioref">2020</a>)</span>
discuss an example of controlling for family-specific pre-treatment
conditions in a sibling study on the effect of participating in
pre-school programs on later life outcomes.</p>
<div id="example" class="section level3">
<h3>Example</h3>
<p>As an example, we use the <code>mwp</code> panel data, containing
information on wages and family status of 268 men. This is a random
sample drawn from the National Longitudinal Survey of Youth <span
class="citation">(<a href="#ref-NLSY79.2012" role="doc-biblioref">Bureau
of Labor Statistics 2014</a>)</span>, and more details on the selection
of observations and variable construction can be found in <span
class="citation">Ludwig and Brüderl (<a href="#ref-Ludwig.2018.0"
role="doc-biblioref">2018</a>)</span>.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">&quot;mwp&quot;</span>, <span class="at">package =</span> <span class="st">&quot;feisr&quot;</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(mwp)</span></code></pre></div>
<pre><code>##   id year      lnw      exp      expq marry evermarry enrol yeduc age cohort
## 1  1 1981 1.934358 1.076923  1.159763     0         1     1    11  18   1963
## 2  1 1983 2.468140 3.019231  9.115755     0         1     1    12  20   1963
## 3  1 1984 2.162480 4.038462 16.309174     0         1     1    12  21   1963
## 4  1 1985 1.746280 5.076923 25.775146     0         1     0    12  22   1963
## 5  1 1986 2.527840 6.096154 37.163090     0         1     1    13  23   1963
## 6  1 1987 2.365361 7.500000 56.250000     0         1     1    13  24   1963
##   yeargr yeargr1 yeargr2 yeargr3 yeargr4 yeargr5
## 1      2       0       1       0       0       0
## 2      2       0       1       0       0       0
## 3      2       0       1       0       0       0
## 4      2       0       1       0       0       0
## 5      3       0       0       1       0       0
## 6      3       0       0       1       0       0</code></pre>
<p>The data set contains a unique person identifier (<code>id</code>)
and survey year indicator (<code>year</code>). Furthermore, we have
information about the log hourly wage rate (<code>lnwage</code>), work
experience (<code>exp</code>) and its square (<code>expq</code>), family
status (<code>marry</code>), enrollment in current education
(<code>enrol</code>), years of formal education education
(<code>yeduc</code>), age (<code>age</code>), birth cohort
(<code>cohort</code>), and a grouped year indicator
(<code>yeargr</code>).</p>
<p>we exemplary investigate the ‘marriage wage premium’: we analyze
whether marriage leads to an increase in the hourly wage for men. We use
the function <code>feis</code> to estimate fixed effects individual
slope models to control for the hypothesis that those men who are more
likely to marry or marry earlier, also have a steeper wage growth over
time.</p>
<p>Let’s start with our most common panel models (FE and RE):</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>wages.fe <span class="ot">&lt;-</span> <span class="fu">plm</span>(lnw <span class="sc">~</span> marry <span class="sc">+</span> enrol <span class="sc">+</span> yeduc <span class="sc">+</span> <span class="fu">as.factor</span>(yeargr)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>                <span class="sc">+</span> exp <span class="sc">+</span> <span class="fu">I</span>(exp<span class="sc">^</span><span class="dv">2</span>), <span class="at">data =</span> mwp, <span class="at">index =</span> <span class="fu">c</span>(<span class="st">&quot;id&quot;</span>, <span class="st">&quot;year&quot;</span>),</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>                <span class="at">model =</span> <span class="st">&quot;within&quot;</span>, <span class="at">effect =</span> <span class="st">&quot;individual&quot;</span>)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>wages.re <span class="ot">&lt;-</span> <span class="fu">plm</span>(lnw <span class="sc">~</span> marry <span class="sc">+</span> enrol <span class="sc">+</span> yeduc <span class="sc">+</span> <span class="fu">as.factor</span>(yeargr)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>                <span class="sc">+</span> exp <span class="sc">+</span> <span class="fu">I</span>(exp<span class="sc">^</span><span class="dv">2</span>), <span class="at">data =</span> mwp, <span class="at">index =</span> <span class="fu">c</span>(<span class="st">&quot;id&quot;</span>, <span class="st">&quot;year&quot;</span>),</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>                <span class="at">model =</span> <span class="st">&quot;random&quot;</span>, <span class="at">effect =</span> <span class="st">&quot;individual&quot;</span>)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(wages.fe)</span></code></pre></div>
<pre><code>## Oneway (individual) effect Within Model
## 
## Call:
## plm(formula = lnw ~ marry + enrol + yeduc + as.factor(yeargr) + 
##     exp + I(exp^2), data = mwp, effect = &quot;individual&quot;, model = &quot;within&quot;, 
##     index = c(&quot;id&quot;, &quot;year&quot;))
## 
## Unbalanced Panel: n = 268, T = 4-19, N = 3100
## 
## Residuals:
##       Min.    1st Qu.     Median    3rd Qu.       Max. 
## -2.5870006 -0.1580744  0.0081262  0.1701488  1.9958088 
## 
## Coefficients:
##                       Estimate  Std. Error t-value  Pr(&gt;|t|)    
## marry               0.07773216  0.02160148  3.5985 0.0003256 ***
## enrol              -0.20810059  0.02282898 -9.1156 &lt; 2.2e-16 ***
## yeduc               0.05584485  0.00715655  7.8033 8.424e-15 ***
## as.factor(yeargr)2 -0.14080625  0.03036533 -4.6371 3.694e-06 ***
## as.factor(yeargr)3 -0.16453499  0.04696595 -3.5033 0.0004667 ***
## as.factor(yeargr)4 -0.27553668  0.06196892 -4.4464 9.071e-06 ***
## as.factor(yeargr)5 -0.29750723  0.07932341 -3.7506 0.0001800 ***
## exp                 0.07299927  0.00867777  8.4122 &lt; 2.2e-16 ***
## I(exp^2)           -0.00127502  0.00036103 -3.5317 0.0004196 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Total Sum of Squares:    559.75
## Residual Sum of Squares: 327.88
## R-Squared:      0.41424
## Adj. R-Squared: 0.35697
## F-statistic: 221.816 on 9 and 2823 DF, p-value: &lt; 2.22e-16</code></pre>
<p>and we calculate panel robust standard errors and attach them back to
the model output:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate vcov</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>vcovx_fe <span class="ot">&lt;-</span> <span class="fu">vcovHC</span>(wages.fe, <span class="at">cluster =</span> <span class="st">&quot;group&quot;</span>, <span class="at">method =</span> <span class="st">&quot;arellano&quot;</span>, <span class="at">type =</span> <span class="st">&quot;HC3&quot;</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>vcovx_re <span class="ot">&lt;-</span> <span class="fu">vcovHC</span>(wages.re, <span class="at">cluster =</span> <span class="st">&quot;group&quot;</span>, <span class="at">method =</span> <span class="st">&quot;arellano&quot;</span>, <span class="at">type =</span> <span class="st">&quot;HC3&quot;</span>)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Replace original vcov in output</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>wages.fe<span class="sc">$</span>vcov <span class="ot">&lt;-</span> vcovx_fe</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>wages.re<span class="sc">$</span>vcov <span class="ot">&lt;-</span> vcovx_re</span></code></pre></div>
<p>Replacing the vcov in the model output has the advantage that we now
use the cluster robust SEs in all following operations (like
<code>summary()</code> or <code>screenreg</code>).</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(wages.fe)</span></code></pre></div>
<pre><code>## Oneway (individual) effect Within Model
## 
## Call:
## plm(formula = lnw ~ marry + enrol + yeduc + as.factor(yeargr) + 
##     exp + I(exp^2), data = mwp, effect = &quot;individual&quot;, model = &quot;within&quot;, 
##     index = c(&quot;id&quot;, &quot;year&quot;))
## 
## Unbalanced Panel: n = 268, T = 4-19, N = 3100
## 
## Residuals:
##       Min.    1st Qu.     Median    3rd Qu.       Max. 
## -2.5870006 -0.1580744  0.0081262  0.1701488  1.9958088 
## 
## Coefficients:
##                       Estimate  Std. Error t-value  Pr(&gt;|t|)    
## marry               0.07773216  0.03160634  2.4594 0.0139771 *  
## enrol              -0.20810059  0.02738300 -7.5996 4.015e-14 ***
## yeduc               0.05584485  0.01025801  5.4440 5.656e-08 ***
## as.factor(yeargr)2 -0.14080625  0.03554205 -3.9617 7.627e-05 ***
## as.factor(yeargr)3 -0.16453499  0.05338645 -3.0820 0.0020763 ** 
## as.factor(yeargr)4 -0.27553668  0.06829208 -4.0347 5.613e-05 ***
## as.factor(yeargr)5 -0.29750723  0.08916462 -3.3366 0.0008591 ***
## exp                 0.07299927  0.01245954  5.8589 5.198e-09 ***
## I(exp^2)           -0.00127502  0.00057274 -2.2262 0.0260794 *  
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Total Sum of Squares:    559.75
## Residual Sum of Squares: 327.88
## R-Squared:      0.41424
## Adj. R-Squared: 0.35697
## F-statistic: 77.9716 on 9 and 2823 DF, p-value: &lt; 2.22e-16</code></pre>
<p>And finally, we allow for individual specific trends. To replicate
the analysis of <span class="citation">Ludwig and Brüderl (<a
href="#ref-Ludwig.2018.0" role="doc-biblioref">2018</a>)</span>, we use
work experience (<code>exp</code>) and squared work experience as the
slope variables.</p>
<p><strong>One mayor advantage of using work experience as slope is that
we can still control for (grouped) time fixed effects</strong></p>
<p><strong>Assuming linear trends (only using exp), is a strong
assumption. However, for each additional slope (e.g. polynomial), FEIS
becomes more data hungry: each individual needs at least <span
class="math inline">\(T \geq K + 1\)</span> observations to contribute
to the model. If not, they are dropped!</strong></p>
<p>Here we use <code>feis</code> with panel robust standard errors. The
command <code>felm</code> from <code>lfe</code> can be used to calculate
individual slopes as well.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>wages.feis <span class="ot">&lt;-</span> <span class="fu">feis</span>(lnw <span class="sc">~</span> marry <span class="sc">+</span> enrol <span class="sc">+</span> yeduc <span class="sc">+</span> <span class="fu">as.factor</span>(yeargr)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>                   <span class="sc">|</span> exp <span class="sc">+</span> <span class="fu">I</span>(exp<span class="sc">^</span><span class="dv">2</span>), <span class="at">data =</span> mwp, <span class="at">id =</span> <span class="st">&quot;id&quot;</span>,</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>                   <span class="at">robust =</span> <span class="cn">TRUE</span>)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(wages.feis)</span></code></pre></div>
<pre><code>## 
## 
## Call:
## feis(formula = lnw ~ marry + enrol + yeduc + as.factor(yeargr) | 
##     exp + I(exp^2), data = mwp, id = &quot;id&quot;, robust = TRUE)
## 
## 
## Residuals:
##       Min.    1st Qu.     Median    3rd Qu.       Max. 
## -2.0790815 -0.1050450  0.0046876  0.1112708  1.9412090 
## 
## Coefficients:
##                      Estimate Std. Error t-value  Pr(&gt;|t|)    
## marry               0.0134582  0.0292771  0.4597   0.64579    
## enrol              -0.1181725  0.0235003 -5.0286 5.325e-07 ***
## yeduc              -0.0020607  0.0175059 -0.1177   0.90630    
## as.factor(yeargr)2 -0.0464504  0.0378675 -1.2267   0.22008    
## as.factor(yeargr)3 -0.0189333  0.0524265 -0.3611   0.71803    
## as.factor(yeargr)4 -0.1361305  0.0615033 -2.2134   0.02697 *  
## as.factor(yeargr)5 -0.1868589  0.0742904 -2.5152   0.01196 *  
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Cluster robust standard errors
## Slope parameters:  exp, I(exp^2) 
## Total Sum of Squares:    190.33
## Residual Sum of Squares: 185.64
## R-Squared:      0.024626
## Adj. R-Squared: 0.022419</code></pre>
<p>Let’s compare the results.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">screenreg</span>(<span class="fu">list</span>(wages.re, wages.fe, wages.feis), <span class="at">digits =</span> <span class="dv">3</span>,</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>          <span class="at">custom.model.names =</span> <span class="fu">c</span>(<span class="st">&quot;RE&quot;</span>, <span class="st">&quot;FE&quot;</span>, <span class="st">&quot;FEIS&quot;</span>))</span></code></pre></div>
<pre><code>## 
## ============================================================
##                     RE            FE            FEIS        
## ------------------------------------------------------------
## (Intercept)            1.562 ***                            
##                       (0.094)                               
## marry                  0.091 **      0.078 *       0.013    
##                       (0.032)       (0.032)       (0.029)   
## enrol                 -0.202 ***    -0.208 ***    -0.118 ***
##                       (0.025)       (0.027)       (0.024)   
## yeduc                  0.063 ***     0.056 ***    -0.002    
##                       (0.008)       (0.010)       (0.018)   
## as.factor(yeargr)2    -0.157 ***    -0.141 ***    -0.046    
##                       (0.034)       (0.036)       (0.038)   
## as.factor(yeargr)3    -0.197 ***    -0.165 **     -0.019    
##                       (0.050)       (0.053)       (0.052)   
## as.factor(yeargr)4    -0.316 ***    -0.276 ***    -0.136 *  
##                       (0.066)       (0.068)       (0.062)   
## as.factor(yeargr)5    -0.349 ***    -0.298 ***    -0.187 *  
##                       (0.089)       (0.089)       (0.074)   
## exp                    0.074 ***     0.073 ***              
##                       (0.012)       (0.012)                 
## exp^2                 -0.001 *      -0.001 *                
##                       (0.001)       (0.001)                 
## ------------------------------------------------------------
## s_idios                0.341                                
## s_id                   0.279                                
## R^2                    0.440         0.414         0.025    
## Adj. R^2               0.439         0.357         0.022    
## Num. obs.           3100          3100          3100        
## Num. groups: id                                  268        
## RMSE                                               0.285    
## ============================================================
## *** p &lt; 0.001; ** p &lt; 0.01; * p &lt; 0.05</code></pre>
<p>Interpretation:</p>
<ul>
<li><p>RE: Married observations have a significantly higher wage than
unmarried observations.</p></li>
<li><p>FE: If people marry, they experience an increase in wages
afterwards. The effect is significant and slightly lower than the
RE.</p></li>
<li><p>FEIS: Accounting for the individual wage trend before marriage,
we do not observe an increase in wages if people marry. The effect is
small and non-significant.</p></li>
</ul>
<p>Overall, this indicates that there is a problem with non-parallel
trends: Those with steeper wage trajectories are more likely to marry
(or marry earlier).</p>
<p>As mentioned above, we can achieve the same by 1) manually
calculating the individual specific trends and 2) including them as
additional covariates in the model.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="do">### Individual predicted value of covariates</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>vars <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;marry&quot;</span>, <span class="st">&quot;enrol&quot;</span>, <span class="st">&quot;yeduc&quot;</span>, </span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;yeargr2&quot;</span>, <span class="st">&quot;yeargr3&quot;</span>, <span class="st">&quot;yeargr4&quot;</span>, <span class="st">&quot;yeargr5&quot;</span>)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(v <span class="cf">in</span> vars){</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  fm <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="fu">paste</span>(v, <span class="st">&quot;~ exp + expq&quot;</span>))</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>  pred_x <span class="ot">&lt;-</span> <span class="fu">by</span>(mwp[, <span class="fu">c</span>(v, <span class="st">&quot;exp&quot;</span>, <span class="st">&quot;expq&quot;</span>)],</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>                mwp<span class="sc">$</span>id,</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>                <span class="at">FUN =</span> <span class="cf">function</span>(z) <span class="fu">predict</span>(<span class="fu">lm</span>(fm, <span class="at">data =</span> z)))</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>  pred_x <span class="ot">&lt;-</span> <span class="fu">unlist</span>(pred_x)</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>  mwp[, <span class="fu">paste0</span>(<span class="st">&quot;pred_&quot;</span>, v)] <span class="ot">&lt;-</span> pred_x</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(mwp[, <span class="fu">c</span>(<span class="st">&quot;id&quot;</span>, <span class="st">&quot;pred_marry&quot;</span>, <span class="st">&quot;pred_enrol&quot;</span>)], <span class="at">n =</span> <span class="dv">20</span>)</span></code></pre></div>
<pre><code>##    id  pred_marry   pred_enrol
## 1   1 -0.12205318  1.206579223
## 2   1 -0.03068796  0.863033817
## 3   1  0.03926230  0.716309276
## 4   1  0.12611077  0.590568171
## 5   1  0.22664093  0.490467488
## 6   1  0.38990636  0.390403467
## 7   1  0.54837205  0.340389443
## 8   1  0.66317654  0.324200699
## 9   1  0.87480284  0.326554307
## 10  1  1.04489924  0.351640932
## 11  1  1.23957011  0.399853176
## 12  2  0.00000000  1.103938282
## 13  2  0.00000000  0.503880518
## 14  2  0.00000000  0.304456317
## 15  2  0.00000000  0.176757843
## 16  2  0.00000000  0.012061441
## 17  2  0.00000000 -0.105551709
## 18  2  0.00000000  0.004457309
## 19  3  0.00000000  0.000000000
## 20  3  0.00000000  0.000000000</code></pre>
<p>This gives us individual-specific predicted values of each covariate
based on and intercept, exp and expsq. Note that - in contrast to
person-specific means - these predicted values (can) vary within a
person.</p>
<p>Do you know why person-id 2 has all zeros on the pre_marry
variable?</p>
<p>Using these individual predicted values, we can retreive the FEIS
estimates in a Mundlak-style model.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>wages.lmfeis <span class="ot">&lt;-</span> <span class="fu">lm</span>(lnw <span class="sc">~</span> marry <span class="sc">+</span> enrol <span class="sc">+</span> yeduc <span class="sc">+</span> <span class="fu">as.factor</span>(yeargr) <span class="sc">+</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>                     pred_marry <span class="sc">+</span> pred_enrol <span class="sc">+</span> pred_yeduc <span class="sc">+</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>                     pred_yeargr2 <span class="sc">+</span> pred_yeargr3 <span class="sc">+</span> pred_yeargr4 <span class="sc">+</span> pred_yeargr5,</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>                   <span class="at">data =</span> mwp)</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="fu">screenreg</span>(<span class="fu">list</span>(wages.feis, wages.lmfeis), <span class="at">digits =</span> <span class="dv">3</span>,</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>          <span class="at">custom.model.names =</span> <span class="fu">c</span>(<span class="st">&quot;FEIS&quot;</span>, <span class="st">&quot;Manual FEIS&quot;</span>))</span></code></pre></div>
<pre><code>## 
## ==============================================
##                     FEIS          Manual FEIS 
## ----------------------------------------------
## marry                  0.013         0.013    
##                       (0.029)       (0.043)   
## enrol                 -0.118 ***    -0.118 ** 
##                       (0.024)       (0.037)   
## yeduc                 -0.002        -0.002    
##                       (0.018)       (0.022)   
## as.factor(yeargr)2    -0.046        -0.046    
##                       (0.038)       (0.055)   
## as.factor(yeargr)3    -0.019        -0.019    
##                       (0.052)       (0.080)   
## as.factor(yeargr)4    -0.136 *      -0.136    
##                       (0.062)       (0.097)   
## as.factor(yeargr)5    -0.187 *      -0.187    
##                       (0.074)       (0.121)   
## (Intercept)                          1.576 ***
##                                     (0.056)   
## pred_marry                           0.269 ***
##                                     (0.048)   
## pred_enrol                          -0.238 ***
##                                     (0.048)   
## pred_yeduc                           0.079 ***
##                                     (0.022)   
## pred_yeargr2                        -0.061    
##                                     (0.074)   
## pred_yeargr3                        -0.012    
##                                     (0.092)   
## pred_yeargr4                         0.169    
##                                     (0.110)   
## pred_yeargr5                         0.347 ** 
##                                     (0.132)   
## ----------------------------------------------
## R^2                    0.025         0.359    
## Adj. R^2               0.022         0.356    
## Num. obs.           3100          3100        
## Num. groups: id      268                      
## RMSE                   0.285                  
## ==============================================
## *** p &lt; 0.001; ** p &lt; 0.01; * p &lt; 0.05</code></pre>
<p>Note, however, that this manual approach will lead to incorrect
standard errors!</p>
</div>
</div>
<div id="dynamic-treatment-effects" class="section level1">
<h1>Dynamic treatment effects</h1>
<p>Often, we are not only interested in the overall treatment effect,
but we also want to know how treatment effects unfold after a treatment.
For example, how does happiness change around specific life course
events <span class="citation">(<a href="#ref-Clark.2013"
role="doc-biblioref">Clark and Georgellis 2013</a>)</span>, or how do
housing prices develop after the opening of an industrial plant <span
class="citation">(<a href="#ref-Currie.2015" role="doc-biblioref">Currie
et al. 2015</a>)</span>?</p>
<p>There are various ways of calculating how a treatment effect develops
over time:</p>
<div class="figure">
<img src="fig/Impact-function.PNG" alt="" />
<p class="caption">Various impact functions for event study designs from
<a
href="https://www.ls3.soziologie.uni-muenchen.de/studium-lehre/archiv/teaching-marterials/panel-analysis_april-2019.pdf">Brüderl/Ludwig
2019 teaching materials</a></p>
</div>
<p>Usually, it is best to not impose a structural form, but rather to
use dummy impact functions. However, even with this, there is an ongoing
debate on what is the best choice of specification <span
class="citation">(<a href="#ref-Ludwig.2021" role="doc-biblioref">Ludwig
and Brüderl 2021</a>)</span>, or see for instance <a
href="https://pedrohcgs.github.io/posts/twfe">blog post by Pedro H. C.
Sant’Anna and Brantly Callaway</a>.</p>
<p><strong>Note that these settings usually require a staggered
treatment adoption: individuals are treated once, and afterwards reamin
treated</strong></p>
<p>There are many cases where this does not apply. However, one can
think about potential ways of artificially creating such designs:</p>
<ul>
<li><p>Dichotomize continuous treatments (if theoretically
plausible!)</p></li>
<li><p>Create id-period splits. E.g. if a person gets divorced, either
drop from sample, or treat as a “new id” as a person can re-marry (note
that this assumes that first and second marriage have equal
effects).</p></li>
</ul>
<div id="example-1" class="section level3">
<h3>Example</h3>
<p>We stick with our example and try to estimate how the wage changes
around the year of marriage.</p>
<p>To do so, we first estimate make sure the data is ordered by id and
time</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>mwp <span class="ot">&lt;-</span> mwp[<span class="fu">order</span>(mwp<span class="sc">$</span>id, mwp<span class="sc">$</span>year), ]</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(mwp[, <span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>], <span class="at">n =</span> <span class="dv">20</span>)</span></code></pre></div>
<pre><code>##    id year      lnw        exp        expq marry
## 1   1 1981 1.934358  1.0769231   1.1597635     0
## 2   1 1983 2.468140  3.0192308   9.1157551     0
## 3   1 1984 2.162480  4.0384617  16.3091736     0
## 4   1 1985 1.746280  5.0769229  25.7751465     0
## 5   1 1986 2.527840  6.0961537  37.1630898     0
## 6   1 1987 2.365361  7.5000000  56.2500000     0
## 7   1 1988 2.467478  8.6730766  75.2222595     1
## 8   1 1989 4.398027  9.4423075  89.1571732     1
## 9   1 1990 2.822144 10.7307692 115.1494064     1
## 10  1 1991 2.654965 11.6730766 136.2607117     1
## 11  1 1992 2.665088 12.6730766 160.6068726     1
## 12  2 1979 2.236233  0.9423077   0.8879438     0
## 13  2 1981 2.916389  2.9615386   8.7707109     0
## 14  2 1982 2.751646  3.8269231  14.6453409     0
## 15  2 1983 2.629372  4.4807692  20.0772915     0
## 16  2 1984 2.965442  5.5384617  30.6745586     0
## 17  2 1985 2.890669  6.6538463  44.2736702     0
## 18  2 1989 2.392579 11.1538458 124.4082794     0
## 19  3 1979 2.456405  1.1730769   1.3761094     0
## 20  3 1980 2.661142  2.1153846   4.4748521     0</code></pre>
<p>Then, we make sure that our data looks like a staggered treatment
design. Are there people who jump from married to not married in the
data?</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Change in marriage status within an id</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>mwp<span class="sc">$</span>fd_marry <span class="ot">&lt;-</span> <span class="fu">ave</span>(mwp<span class="sc">$</span>marry,</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>                    mwp<span class="sc">$</span>id,</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>                    <span class="at">FUN =</span> <span class="cf">function</span>(x) x <span class="sc">-</span> dplyr<span class="sc">::</span><span class="fu">lag</span>(x, <span class="dv">1</span>, <span class="at">default =</span> <span class="dv">0</span>)) <span class="co"># 0 insteat of NA for 1st year</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Mark observations starting with a negative fd value (jump from marry=1 to marry =0)</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>mwp<span class="sc">$</span>notstag_marry <span class="ot">&lt;-</span> <span class="fu">ave</span>(<span class="fu">ifelse</span>(mwp<span class="sc">$</span>fd_marry <span class="sc">==</span> <span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>                         mwp<span class="sc">$</span>id,</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>                         <span class="at">FUN =</span> <span class="cf">function</span>(x) <span class="fu">cumsum</span>(x))</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(mwp<span class="sc">$</span>fd_marry)</span></code></pre></div>
<pre><code>## 
##    0    1 
## 2896  204</code></pre>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(mwp<span class="sc">$</span>notstag_marry)</span></code></pre></div>
<pre><code>## 
##    0 
## 3100</code></pre>
<p>Luckily, the dataset is already cleaned: there are only transitions
into marriage, not out of marriage.</p>
<p>Next we want to make sure if there are any individuals who already
start with the treatment (who are married right from their first wave
on).</p>
<p><strong>We only want to have those in our sample who potentially can
go from not-treated to treated!</strong></p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>mwp <span class="ot">&lt;-</span> mwp[<span class="fu">order</span>(mwp<span class="sc">$</span>id, mwp<span class="sc">$</span>year), ] <span class="co"># just to be sure</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Person year number</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>mwp<span class="sc">$</span>pynr <span class="ot">&lt;-</span> <span class="fu">ave</span>(mwp<span class="sc">$</span>year,</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>                mwp<span class="sc">$</span>id,</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>                <span class="at">FUN =</span> <span class="cf">function</span>(x) <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(x))</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Marry status at first wave</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>mwp<span class="sc">$</span>f_marry <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(mwp<span class="sc">$</span>pynr <span class="sc">==</span> <span class="dv">1</span>, mwp<span class="sc">$</span>marry, <span class="cn">NA</span>)</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Distribute across individual, using mean and na.rm = TRUE</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>mwp<span class="sc">$</span>f_marry <span class="ot">&lt;-</span> <span class="fu">ave</span>(mwp<span class="sc">$</span>f_marry,</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>                   mwp<span class="sc">$</span>id,</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>                   <span class="at">FUN =</span> <span class="cf">function</span>(x) <span class="fu">mean</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(mwp<span class="sc">$</span>f_marry)</span></code></pre></div>
<pre><code>## 
##    0 
## 3100</code></pre>
<p>Again, someone has already done the job. There are no individuals who
start married in the first wave.</p>
<p>We can also look at this graphically with <code>panelView</code>
(mainly helpful for small N data):</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">panelview</span>(lnw <span class="sc">~</span> marry, </span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>          <span class="at">data =</span> mwp, <span class="at">index =</span> <span class="fu">c</span>(<span class="st">&quot;id&quot;</span>,<span class="st">&quot;year&quot;</span>),</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>          <span class="at">type =</span> <span class="st">&quot;treat&quot;</span>, <span class="at">theme.bw =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
<pre><code>## Time is not evenly distributed (possibly due to missing data).</code></pre>
<p><img src="Panel_part2_files/figure-html/unnamed-chunk-14-1.png" width="480" /></p>
<p>Alright, so lets create a dummy impact function / a count variable
around the treatment.</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>mwp <span class="ot">&lt;-</span> mwp[<span class="fu">order</span>(mwp<span class="sc">$</span>id, mwp<span class="sc">$</span>year), ] <span class="co"># just to be sure!!</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Function that creates distance to the treatment (assuming 0=control, 1=treated)</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>impfun <span class="ot">&lt;-</span> <span class="cf">function</span>(x, <span class="at">default =</span> <span class="sc">-</span><span class="dv">99</span>){</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>  nas <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">is.na</span>(x))  <span class="co">#save nas</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>  ft <span class="ot">&lt;-</span> <span class="fu">which</span>(x <span class="sc">==</span> <span class="dv">1</span>)[<span class="dv">1</span>]  <span class="co">#first teatment index</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.na</span>(ft)){          <span class="co">#replicate default if never treated</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>    count <span class="ot">&lt;-</span> <span class="fu">rep</span>(default, <span class="fu">length</span>(x))</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>    ri <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(x)       <span class="co">#running index</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>    count <span class="ot">&lt;-</span> ri <span class="sc">-</span> ft        <span class="co">#distance to first treatment</span></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">length</span>(nas) <span class="sc">!=</span> <span class="dv">0</span>){   <span class="co">#replace nas if any</span></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>    count[nas] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(count)           <span class="co">#return counter</span></span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply to each individual</span></span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>mwp<span class="sc">$</span>marry_if <span class="ot">&lt;-</span> <span class="fu">ave</span>(mwp<span class="sc">$</span>marry,</span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>                    mwp<span class="sc">$</span>id,</span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>                    <span class="at">FUN =</span> <span class="cf">function</span>(x) <span class="fu">impfun</span>(x))</span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(mwp[, <span class="fu">c</span>(<span class="st">&quot;id&quot;</span>, <span class="st">&quot;year&quot;</span>, <span class="st">&quot;marry&quot;</span>, <span class="st">&quot;marry_if&quot;</span>)], <span class="at">n =</span> <span class="dv">50</span>)</span></code></pre></div>
<pre><code>##    id year marry marry_if
## 1   1 1981     0       -6
## 2   1 1983     0       -5
## 3   1 1984     0       -4
## 4   1 1985     0       -3
## 5   1 1986     0       -2
## 6   1 1987     0       -1
## 7   1 1988     1        0
## 8   1 1989     1        1
## 9   1 1990     1        2
## 10  1 1991     1        3
## 11  1 1992     1        4
## 12  2 1979     0      -99
## 13  2 1981     0      -99
## 14  2 1982     0      -99
## 15  2 1983     0      -99
## 16  2 1984     0      -99
## 17  2 1985     0      -99
## 18  2 1989     0      -99
## 19  3 1979     0      -99
## 20  3 1980     0      -99
## 21  3 1981     0      -99
## 22  3 1982     0      -99
## 23  3 1983     0      -99
## 24  3 1984     0      -99
## 25  3 1985     0      -99
## 26  3 1986     0      -99
## 27  3 1987     0      -99
## 28  3 1988     0      -99
## 29  3 1989     0      -99
## 30  3 1993     0      -99
## 31  3 1994     0      -99
## 32  3 2000     0      -99
## 33  4 1979     0       -2
## 34  4 1981     0       -1
## 35  4 1982     1        0
## 36  4 1983     1        1
## 37  4 1984     1        2
## 38  4 1985     1        3
## 39  4 1986     1        4
## 40  4 1987     1        5
## 41  4 1988     1        6
## 42  4 1989     1        7
## 43  4 1990     1        8
## 44  4 1991     1        9
## 45  4 1992     1       10
## 46  4 1993     1       11
## 47  5 1979     0       -6
## 48  5 1980     0       -5
## 49  5 1981     0       -4
## 50  5 1982     0       -3</code></pre>
<p>We can now use this time count function to estimate dynamic treatment
effects.</p>
<p>Note that we need to make to important decisions (<a
href="https://pedrohcgs.github.io/posts/twfe">blog post by Pedro H. C.
Sant’Anna and Brantly Callaway</a>):</p>
<ul>
<li><p>Which dates to use a reference category</p></li>
<li><p>How many pre-treatment periods to include (to test for
anticipation or potential pre-treatment differences)</p></li>
</ul>
<p>Here, re will just include three periods before marriage and use the
rest as reference categories</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set all before -3 to -99</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>mwp<span class="sc">$</span>marry_if[mwp<span class="sc">$</span>marry_if <span class="sc">&lt;</span> <span class="sc">-</span><span class="dv">3</span> <span class="sc">&amp;</span> mwp<span class="sc">$</span>marry_if <span class="sc">&gt;</span> <span class="sc">-</span><span class="dv">99</span>] <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">99</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Make factor with -99 as reference category</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>mwp<span class="sc">$</span>marry_if <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(mwp<span class="sc">$</span>marry_if)</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>mwp<span class="sc">$</span>marry_if <span class="ot">&lt;-</span> <span class="fu">relevel</span>(mwp<span class="sc">$</span>marry_if, <span class="st">&quot;-99&quot;</span>)</span></code></pre></div>
<p>And we use this as our treatment variable in the FE estimator.</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Standard marriage indicator</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>wages.fe <span class="ot">&lt;-</span> <span class="fu">plm</span>(lnw <span class="sc">~</span> marry <span class="sc">+</span> enrol <span class="sc">+</span> yeduc <span class="sc">+</span> <span class="fu">as.factor</span>(yeargr)</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>                <span class="sc">+</span> exp <span class="sc">+</span> <span class="fu">I</span>(exp<span class="sc">^</span><span class="dv">2</span>), <span class="at">data =</span> mwp, <span class="at">index =</span> <span class="fu">c</span>(<span class="st">&quot;id&quot;</span>, <span class="st">&quot;year&quot;</span>),</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>                <span class="at">model =</span> <span class="st">&quot;within&quot;</span>, <span class="at">effect =</span> <span class="st">&quot;individual&quot;</span>)</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="co"># with dummy impact function</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>wages2.fe <span class="ot">&lt;-</span> <span class="fu">plm</span>(lnw <span class="sc">~</span> marry_if <span class="sc">+</span> enrol <span class="sc">+</span> yeduc <span class="sc">+</span> <span class="fu">as.factor</span>(yeargr)</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>                 <span class="sc">+</span> exp <span class="sc">+</span> <span class="fu">I</span>(exp<span class="sc">^</span><span class="dv">2</span>), <span class="at">data =</span> mwp, <span class="at">index =</span> <span class="fu">c</span>(<span class="st">&quot;id&quot;</span>, <span class="st">&quot;year&quot;</span>),</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>                 <span class="at">model =</span> <span class="st">&quot;within&quot;</span>, <span class="at">effect =</span> <span class="st">&quot;individual&quot;</span>)</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a><span class="co"># add cluster robust SEs</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>vcovx_fe2 <span class="ot">&lt;-</span> <span class="fu">vcovHC</span>(wages2.fe, <span class="at">cluster =</span> <span class="st">&quot;group&quot;</span>, <span class="at">method =</span> <span class="st">&quot;arellano&quot;</span>, <span class="at">type =</span> <span class="st">&quot;HC3&quot;</span>)</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>wages2.fe<span class="sc">$</span>vcov <span class="ot">&lt;-</span> vcovx_fe2</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(wages2.fe)</span></code></pre></div>
<pre><code>## Oneway (individual) effect Within Model
## 
## Call:
## plm(formula = lnw ~ marry_if + enrol + yeduc + as.factor(yeargr) + 
##     exp + I(exp^2), data = mwp, effect = &quot;individual&quot;, model = &quot;within&quot;, 
##     index = c(&quot;id&quot;, &quot;year&quot;))
## 
## Unbalanced Panel: n = 268, T = 4-19, N = 3100
## 
## Residuals:
##      Min.   1st Qu.    Median   3rd Qu.      Max. 
## -2.566752 -0.160001  0.010038  0.175003  2.011790 
## 
## Coefficients:
##                       Estimate  Std. Error t-value  Pr(&gt;|t|)    
## marry_if-3          0.03388225  0.03253942  1.0413 0.2978411    
## marry_if-2          0.05166995  0.04238715  1.2190 0.2229466    
## marry_if-1          0.09151624  0.04265046  2.1457 0.0319803 *  
## marry_if0           0.08816919  0.05121551  1.7215 0.0852644 .  
## marry_if1           0.15544954  0.05601346  2.7752 0.0055530 ** 
## marry_if2           0.15658061  0.06078860  2.5758 0.0100509 *  
## marry_if3           0.16687443  0.06762257  2.4677 0.0136564 *  
## marry_if4           0.14591461  0.07412203  1.9686 0.0491005 *  
## marry_if5           0.14033773  0.07930392  1.7696 0.0768992 .  
## marry_if6           0.15706194  0.08660097  1.8136 0.0698418 .  
## marry_if7           0.13008248  0.09727237  1.3373 0.1812327    
## marry_if8           0.11979150  0.10451397  1.1462 0.2518197    
## marry_if9           0.14007172  0.10390453  1.3481 0.1777412    
## marry_if10          0.11550144  0.11151584  1.0357 0.3004126    
## marry_if11          0.20483579  0.12281306  1.6679 0.0954538 .  
## marry_if12          0.10767466  0.12345702  0.8722 0.3831940    
## marry_if13          0.10542488  0.13897395  0.7586 0.4481589    
## marry_if14         -0.13934447  0.12815514 -1.0873 0.2769929    
## enrol              -0.20477142  0.02737332 -7.4807 9.833e-14 ***
## yeduc               0.05500238  0.01059840  5.1897 2.257e-07 ***
## as.factor(yeargr)2 -0.13830215  0.03594278 -3.8478 0.0001218 ***
## as.factor(yeargr)3 -0.16356110  0.05379641 -3.0404 0.0023847 ** 
## as.factor(yeargr)4 -0.27248909  0.06839547 -3.9840 6.948e-05 ***
## as.factor(yeargr)5 -0.28895919  0.08907335 -3.2441 0.0011922 ** 
## exp                 0.06728858  0.01357307  4.9575 7.565e-07 ***
## I(exp^2)           -0.00111675  0.00061151 -1.8262 0.0679250 .  
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Total Sum of Squares:    559.75
## Residual Sum of Squares: 325.96
## R-Squared:      0.41767
## Adj. R-Squared: 0.35686
## F-statistic: 75.8727 on 26 and 2806 DF, p-value: &lt; 2.22e-16</code></pre>
<p>Let’s plot that</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set up results matrix</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>coef.df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">matrix</span>(<span class="cn">NA</span>,</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">nrow =</span> (<span class="fu">length</span>(<span class="fu">levels</span>(mwp<span class="sc">$</span>marry_if)) <span class="sc">-</span> <span class="dv">1</span>),</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">ncol =</span> <span class="dv">3</span>))</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(coef.df) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;time&quot;</span>, <span class="st">&quot;att&quot;</span>, <span class="st">&quot;se&quot;</span>)</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a><span class="co"># paste results</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>coef.df<span class="sc">$</span>time <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">3</span><span class="sc">:</span><span class="dv">14</span>)</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>output <span class="ot">&lt;-</span> <span class="fu">summary</span>(wages2.fe)<span class="sc">$</span>coefficients</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>coef.df[, <span class="fu">c</span>(<span class="st">&quot;att&quot;</span>, <span class="st">&quot;se&quot;</span>)] <span class="ot">&lt;-</span> output[<span class="fu">which</span>(<span class="fu">grepl</span>(<span class="st">&quot;marry_if&quot;</span>, <span class="fu">rownames</span>(output))), <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a><span class="co"># 95% CI</span></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>interval2  <span class="ot">&lt;-</span>  <span class="sc">-</span><span class="fu">qnorm</span>((<span class="dv">1</span><span class="fl">-0.95</span>)<span class="sc">/</span><span class="dv">2</span>)  <span class="co"># 95% multiplier</span></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>coef.df<span class="sc">$</span>ll <span class="ot">&lt;-</span> coef.df<span class="sc">$</span>att <span class="sc">-</span> coef.df<span class="sc">$</span>se<span class="sc">*</span>interval2</span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>coef.df<span class="sc">$</span>ul <span class="ot">&lt;-</span> coef.df<span class="sc">$</span>att <span class="sc">+</span> coef.df<span class="sc">$</span>se<span class="sc">*</span>interval2</span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>zp1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(coef.df[coef.df<span class="sc">$</span>time <span class="sc">&lt;</span> <span class="dv">7</span>, ], </span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>              <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> att)) <span class="sc">+</span>  </span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_pointrange</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> att, <span class="at">ymin =</span> ll, <span class="at">ymax =</span> ul),</span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a>                                <span class="at">lwd =</span> <span class="dv">1</span>, <span class="at">fatten =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> att)) <span class="sc">+</span></span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">colour =</span> <span class="fu">gray</span>(<span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>), <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">lwd =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="sc">-</span><span class="fl">0.5</span>, <span class="at">colour =</span> <span class="st">&quot;black&quot;</span>, <span class="at">lty =</span> <span class="dv">1</span>, <span class="at">lwd =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a>zp1</span></code></pre></div>
<p><img src="Panel_part2_files/figure-html/unnamed-chunk-18-1.png" width="672" /></p>
<p>An interesting finding here. There is a positive anticipation effect:
“The anticipation of marriage already increases the husbands wage”.</p>
<p>Is this plausible?</p>
<p><strong>FEIS</strong></p>
<p>Obviously, we can also use these dummy impact function in other
estimators.</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="do">### FEIS with dummy impact function</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>wages2.feis <span class="ot">&lt;-</span> <span class="fu">feis</span>(lnw <span class="sc">~</span> marry_if <span class="sc">+</span> enrol <span class="sc">+</span> yeduc <span class="sc">+</span> <span class="fu">as.factor</span>(yeargr)</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>                   <span class="sc">|</span> exp <span class="sc">+</span> <span class="fu">I</span>(exp<span class="sc">^</span><span class="dv">2</span>), </span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>                   <span class="at">data =</span> mwp, <span class="at">id =</span> <span class="st">&quot;id&quot;</span>,</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">robust =</span> <span class="cn">TRUE</span>)</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(wages2.feis)</span></code></pre></div>
<pre><code>## 
## 
## Call:
## feis(formula = lnw ~ marry_if + enrol + yeduc + as.factor(yeargr) | 
##     exp + I(exp^2), data = mwp, id = &quot;id&quot;, robust = TRUE)
## 
## 
## Residuals:
##       Min.    1st Qu.     Median    3rd Qu.       Max. 
## -2.0385140 -0.1070148  0.0063363  0.1116305  1.9422823 
## 
## Coefficients:
##                       Estimate  Std. Error t-value  Pr(&gt;|t|)    
## marry_if-3         -0.01009512  0.03282428 -0.3076   0.75845    
## marry_if-2         -0.01269923  0.05387564 -0.2357   0.81368    
## marry_if-1          0.00945697  0.06556529  0.1442   0.88533    
## marry_if0          -0.00934465  0.08669423 -0.1078   0.91417    
## marry_if1           0.05239527  0.10439373  0.5019   0.61579    
## marry_if2           0.06024667  0.11996538  0.5022   0.61558    
## marry_if3           0.05481404  0.14066586  0.3897   0.69681    
## marry_if4           0.03469671  0.15894441  0.2183   0.82722    
## marry_if5           0.04209049  0.18134196  0.2321   0.81648    
## marry_if6           0.07219889  0.20694589  0.3489   0.72721    
## marry_if7           0.05371600  0.22543835  0.2383   0.81169    
## marry_if8           0.00422209  0.26924683  0.0157   0.98749    
## marry_if9           0.05496285  0.29238662  0.1880   0.85091    
## marry_if10          0.08980275  0.34176479  0.2628   0.79276    
## marry_if11          0.18093806  0.40047134  0.4518   0.65145    
## marry_if12          0.11491753  0.44824664  0.2564   0.79769    
## marry_if13          0.07479506  0.51906834  0.1441   0.88544    
## marry_if14          0.14775390  0.57381382  0.2575   0.79682    
## enrol              -0.11902058  0.02363290 -5.0362 5.122e-07 ***
## yeduc              -0.00082298  0.01772763 -0.0464   0.96298    
## as.factor(yeargr)2 -0.04618140  0.04080643 -1.1317   0.25787    
## as.factor(yeargr)3 -0.01934802  0.05387474 -0.3591   0.71953    
## as.factor(yeargr)4 -0.13656650  0.06179928 -2.2098   0.02722 *  
## as.factor(yeargr)5 -0.18414365  0.07407322 -2.4860   0.01299 *  
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Cluster robust standard errors
## Slope parameters:  exp, I(exp^2) 
## Total Sum of Squares:    190.33
## Residual Sum of Squares: 184.71
## R-Squared:      0.029511
## Adj. R-Squared: 0.021939</code></pre>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="do">### Plot</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Set up results matrix</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>coef2.df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">matrix</span>(<span class="cn">NA</span>,</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">nrow =</span> (<span class="fu">length</span>(<span class="fu">levels</span>(mwp<span class="sc">$</span>marry_if)) <span class="sc">-</span> <span class="dv">1</span>),</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>                  <span class="at">ncol =</span> <span class="dv">3</span>))</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(coef2.df) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;time&quot;</span>, <span class="st">&quot;att&quot;</span>, <span class="st">&quot;se&quot;</span>)</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a><span class="co"># paste results</span></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>coef2.df<span class="sc">$</span>time <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">3</span><span class="sc">:</span><span class="dv">14</span>)</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>output <span class="ot">&lt;-</span> <span class="fu">summary</span>(wages2.feis)<span class="sc">$</span>coefficients</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>coef2.df[, <span class="fu">c</span>(<span class="st">&quot;att&quot;</span>, <span class="st">&quot;se&quot;</span>)] <span class="ot">&lt;-</span> output[<span class="fu">which</span>(<span class="fu">grepl</span>(<span class="st">&quot;marry_if&quot;</span>, <span class="fu">rownames</span>(output))), <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a><span class="co"># 95% CI</span></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>interval2  <span class="ot">&lt;-</span>  <span class="sc">-</span><span class="fu">qnorm</span>((<span class="dv">1</span><span class="fl">-0.95</span>)<span class="sc">/</span><span class="dv">2</span>)  <span class="co"># 95% multiplier</span></span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>coef2.df<span class="sc">$</span>ll <span class="ot">&lt;-</span> coef2.df<span class="sc">$</span>att <span class="sc">-</span> coef2.df<span class="sc">$</span>se<span class="sc">*</span>interval2</span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>coef2.df<span class="sc">$</span>ul <span class="ot">&lt;-</span> coef2.df<span class="sc">$</span>att <span class="sc">+</span> coef2.df<span class="sc">$</span>se<span class="sc">*</span>interval2</span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a>zp2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(coef2.df[coef2.df<span class="sc">$</span>time <span class="sc">&lt;</span> <span class="dv">7</span>, ], </span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>              <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> att)) <span class="sc">+</span>  </span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_pointrange</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> att, <span class="at">ymin =</span> ll, <span class="at">ymax =</span> ul),</span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a>                                <span class="at">lwd =</span> <span class="dv">1</span>, <span class="at">fatten =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> att)) <span class="sc">+</span></span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">colour =</span> <span class="fu">gray</span>(<span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>), <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">lwd =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="sc">-</span><span class="fl">0.5</span>, <span class="at">colour =</span> <span class="st">&quot;black&quot;</span>, <span class="at">lty =</span> <span class="dv">1</span>, <span class="at">lwd =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb37-28"><a href="#cb37-28" aria-hidden="true" tabindex="-1"></a>zp2</span></code></pre></div>
<p><img src="Panel_part2_files/figure-html/unnamed-chunk-19-1.png" width="672" /></p>
<p>This gives us what we already expected: using FEIS, the marital wage
premium disappears.</p>
</div>
</div>
<div id="dynamic-diff-in-diff" class="section level1">
<h1>Dynamic Diff-in-Diff</h1>
<p>Remember, we have defined the <strong>2</strong> <span
class="math inline">\(\times\)</span> <strong>2 Diff-in-Diff</strong>
as:</p>
<p><span class="math display">\[
y_{it} = \alpha + \gamma D_{i} + \lambda Post_{t} + \delta_{DD} (D_{i}
\times Post_{t}) + \upsilon_{it},
\]</span></p>
<p>which we can easily estimate as:</p>
<p><span class="math display">\[
\hat{\delta}_{DD} = \mathrm{E}(\Delta y_{T}) - \mathrm{E}(\Delta y_{C})
= (\mathrm{E}(y_{T}^{post}) - \mathrm{E}(y_{T}^{pre})) -
(\mathrm{E}(y_{C}^{post}) - \mathrm{E}(y_{C}^{pre})).
\]</span></p>
<p>Moreover, we have written the <strong>twoways FE</strong> estimator
as:</p>
<p><span class="math display">\[
y_{it} = \beta_{TWFE} D_{it} + \alpha_i + \zeta_t + \epsilon_{it},
\]</span> In a setting with only two time periods, a binary treatment,
and all observations untreated in <span
class="math inline">\(t=1\)</span>, the Diff-in-Diff estimator equals
the twoways FE estimator <span class="math inline">\(\hat{\delta}_{DD} =
\hat{\beta}_{TWFE}\)</span>.</p>
<p>However, it is more complicated when we go beyond the 2 <span
class="math inline">\(\times\)</span> 2 setting. There is an ongoing
discussion on how the Difference in Differences estimator relates to the
two-ways FE estimator when treatment timing varies: different
individuals receive the treatment at different periods.</p>
<p>Assume we can divide our setting into treatment groups (treated
vs. control) and into timing groups (every observation treated in the
same period form a timing group).</p>
<p><span class="citation">Goodman-Bacon (<a
href="#ref-GoodmanBacon.2021" role="doc-biblioref">2021</a>)</span>
shows that the two-ways FE is a weighted average of all possible
two-group/two-period DD estimators. The weights determine how much each
of these single combinations contributes to the two-ways FE are
determined by the group size (e.g. how long do we observe each
combination before and after treatment) and the variance in the
treatment.</p>
<div class="figure">
<img src="fig/goodman.jpg" alt="" />
<p class="caption">Two-ways FE and DD with varying treatment timing
<span class="citation">(<a href="#ref-GoodmanBacon.2021"
role="doc-biblioref">Goodman-Bacon 2021</a>)</span>.</p>
</div>
<p>In the example above we have three groups: 1) control / never treated
(<span class="math inline">\(C\)</span>), 2) early treated (at period
<span class="math inline">\(k\)</span>), and 3) late treated (at period
<span class="math inline">\(l\)</span>). Those who are treated in later
time periods are not only compared to those who are never treated but
also to those who have already been treated in earlier periods.</p>
<p><span class="citation">Goodman-Bacon (<a
href="#ref-GoodmanBacon.2021" role="doc-biblioref">2021</a>)</span>
shows that this setting with three treatment groups consists of 4
possible 2 <span class="math inline">\(\times\)</span> 2 Diff-in-Diff
settings.</p>
<p>Panels A) and B) compare <span class="math inline">\(j = k,l\)</span>
against control group <span class="math inline">\(C\)</span>, and can be
written as: <span class="math display">\[
\hat{\delta}_{DD}^{jC} = (\mathrm{E}(y_{j}^{post(j)}) -
\mathrm{E}(y_{j}^{pre(j)})) - (\mathrm{E}(y_{C}^{post}) -
\mathrm{E}(y_{C}^{pre})), ~\text{with} ~ j = k,l.
\]</span></p>
<p>Panel C) compares early treated <span
class="math inline">\(k\)</span> against untreated periods of late
treated <span class="math inline">\(l\)</span>. Note that we replace the
<span class="math inline">\(POST\)</span> period with period between
treatment of the early treated and the late treated <span
class="math inline">\(MID(k,l)\)</span> <span class="math display">\[
\hat{\delta}_{DD}^{kl} = (\mathrm{E}(y_{k}^{MID(k,l)}) -
\mathrm{E}(y_{k}^{pre(k)})) - (\mathrm{E}(y_{l}^{MID(k,l)}) -
\mathrm{E}(y_{l}^{pre(k)})).
\]</span></p>
<p>Panel D) compares late treated <span class="math inline">\(l\)</span>
against already treated periods of early treated <span
class="math inline">\(k\)</span>. Note that we replace the <span
class="math inline">\(PRE\)</span> period with period between treatment
of the early treated and the late treated <span
class="math inline">\(MID(k,l)\)</span> <span class="math display">\[
\hat{\delta}_{DD}^{lk} = (\mathrm{E}(y_{l}^{post(l)}) -
\mathrm{E}(y_{l}^{MID(k,l)})) - (\mathrm{E}(y_{k}^{post(l)}) -
\mathrm{E}(y_{k}^{MID(k,l)})).
\]</span></p>
<p>THE twoways FE estimator can now be recovered as a weighted
combinations of these four <span class="math inline">\(2\times2\)</span>
Diff-in-Diff estimators.</p>
<p>The <strong>weights</strong> of each of them depend on</p>
<ol style="list-style-type: lower-alpha">
<li><p><strong>the number of periods each subsample uses</strong>,
and</p></li>
<li><p><strong>the amount of treatment variance within each
subsample</strong>.</p></li>
</ol>
<p>Define <span class="math inline">\(\bar{D}_{kl}\)</span> as the
variance of <span class="math inline">\(D_{it}\)</span> in the subsample
that compares groups <span class="math inline">\(k\)</span> and <span
class="math inline">\(l\)</span>, and the relative size of each group in
the pair <span class="math inline">\(n_{kl} = \frac{n_k}{n_k +
n_l}\)</span>. Then, the weights are given by:</p>
<p><span class="math display">\[
W_{jC} = \frac{(n_j + n_C)^2 \hat{V}_D^{jU}}{\hat{V}_D}, ~\text{with}~
\hat{V}_D^{jU} = n_{jU}(1-n_{jU}) \bar{D}_j(1-\bar{D}_j), ~for~ j = k,l.
\]</span></p>
<p><span class="math display">\[
W_{kl} = \frac{\bigl( (n_k + n_l)(1-\bar{D}_l) \bigr)^2
\hat{V}_D^{kl}}{\hat{V}_D}, ~\text{with}~ \hat{V}_D^{kl} =
n_{kl}(1-n_{kl}) \frac{\bar{D}_k-\bar{D}_l}{1-\bar{D}_l}
\frac{1-\bar{D}_k}{1-\bar{D}_l}.
\]</span></p>
<p><span class="math display">\[
W_{lk} = \frac{\bigl( (n_l + n_k)\bar{D}_k \bigr)^2
\hat{V}_D^{lk}}{\hat{V}_D}, ~\text{with}~ \hat{V}_D^{lk} =
n_{lk}(1-n_{lk}) \frac{\bar{D}_l}{\bar{D}_k}
\frac{\bar{D}_k-\bar{D}_l}{\bar{D}_k}.
\]</span></p>
<p>If group-sizes are equal, then the treatment variance <span
class="math inline">\(\hat{V}_D\)</span> in each combination group
depends on the timing of the treatment. The variance get larger the more
similar the groups sizes <span class="math inline">\(n_{ju}\)</span>,
and the more central (in the middle of the observation period) the
treatment timing (<span class="math inline">\(\bar{D}_k,
\frac{\bar{D}_k-\bar{D}_l}{1-\bar{D}_l},
\frac{\bar{D}_l}{\bar{D}_k}\)</span> close to 0.5).</p>
<p>Note that <strong>these weights are always positive</strong>.</p>
<p>QUESTION: Do you know which of the above groups A), B), C), D) get
the highest weights in the example. Why?</p>
<div id="biased-estimates" class="section level3">
<h3>Biased Estimates</h3>
<p>So why (or when) could this lead to problems with the twoways FE
estimator? <span class="citation">de Chaisemartin and D’Haultfœuille (<a
href="#ref-deChaisemartin.2020" role="doc-biblioref">2020</a>)</span>
and <span class="citation">Sun and Abraham (<a href="#ref-Sun.2021"
role="doc-biblioref">2021</a>)</span> criticize the TWFE on the grounds
of negative weights of some subgroups / sub-effects, arguing that this
may induce substantial bias in the case of heterogeneous treatment
effects.</p>
<p><span class="citation">Goodman-Bacon (<a
href="#ref-GoodmanBacon.2021" role="doc-biblioref">2021</a>)</span> also
explains the observation of these “negative” weights:</p>
<blockquote>
<p>“Negative weights only arise when average treatment effects vary over
time. The DD decomposition shows why: when already-treated units act as
controls, changes in their outcomes are subtracted and these changes may
include time-varying treatment effects. This does not imply a failure of
the design in the sense of non-parallel trends in counterfactual
outcomes, but it does suggest caution when using TWFE estimators to
summarize treatment effects.”</p>
</blockquote>
<p>Basically, if the treatment effect varies over time (e.g. treatment
effect grows over time) TWFE might be biased because early treated
groups (with an increasing treatment effect) are used as control groups
for late treated groups, thereby masking the treatment effect of these
late treated groups (which might however receive a high weight for the
overall treatment effect).</p>
<p>Especially for “trend-breaking” treatment effects like in the
following figure, this will lead to biased estimates of the average
treatment effect <span class="citation">(<a
href="#ref-GoodmanBacon.2021" role="doc-biblioref">Goodman-Bacon
2021</a>; <a href="#ref-Meer.2016" role="doc-biblioref">Meer and West
2016</a>)</span>.</p>
<div class="figure">
<img src="fig/goodman2.jpg" alt="" />
<p class="caption">Bias of two-ways FE with trend-breaking treatment
<span class="citation">(<a href="#ref-GoodmanBacon.2021"
role="doc-biblioref">Goodman-Bacon 2021</a>)</span>.</p>
</div>
<p>In the middle period, we compare the trend in the early treated with
the not-yet treated periods of the late treatment group, and we see the
divergence between those two groups (a positive treatment effect).
However, for the late treated (right art of the figure), the earlier
treated are the control cases (which already includes a trend-breaking
treatment effect). For the late treatment group, and we do not observe a
positive, but actually a negative treatment effect as we erroneously
have the treatment effect in the control group!!!</p>
<p>One way of counteracting this problem is to use event study / impact
function designs (see above) to explicitly model time varying treatment
effects.</p>
</div>
<div id="callaway-santanna-dynamic-diff-in-diff" class="section level3">
<h3>Callaway &amp; Sant’Anna dynamic Diff-in-Diff</h3>
<p>A second way is the application of <strong>flexible
Diff-in-Diff</strong> estimators as proposed by <span
class="citation">Callaway and Sant’Anna (<a href="#ref-Callaway.2020"
role="doc-biblioref">2020</a>)</span>.</p>
<p>Let’s start again with the <span class="math inline">\(2 \times
2\)</span> Diff-in-Diff estimator as</p>
<p><span class="math display">\[
\delta = \mathrm{E}(\Delta y_{T}) - \mathrm{E}(\Delta y_{C}) =
(\mathrm{E}(y_{T}^{post}) - \mathrm{E}(y_{T}^{pre})) -
(\mathrm{E}(y_{C}^{post}) - \mathrm{E}(y_{C}^{pre})),
\]</span> where <span class="math inline">\(\delta\)</span> is the
average tretment effect on the treated (ATT).</p>
<p><span class="citation">Callaway and Sant’Anna (<a
href="#ref-Callaway.2020" role="doc-biblioref">2020</a>)</span> show
that we can generalize this <span class="math inline">\(2 \times
2\)</span> Diff-in-Diff to a mutlti-group and multi-timing setting by
computing group-time average treatment effects. We group all treatment
units which receive treatment at the same period into a common group
<span class="math inline">\(g\)</span>, and for each treatment-group
<span class="math inline">\(g\)</span> and time period <span
class="math inline">\(t\)</span> we estimate group-specific and
time-specific ATTs:</p>
<p><span class="math display">\[
\delta_{g,t} = \mathrm{E}(\Delta y_{g}) - \mathrm{E}(\Delta y_{C}) =
(\mathrm{E}(y_{g}^{t}) - \mathrm{E}(y_{g}^{g-1})) -
(\mathrm{E}(y_{C}^{t}) - \mathrm{E}(y_{C}^{g-1})),
\]</span></p>
<p>where the control group can either be the never-treated or the
not-yet-treated.</p>
<p>Intuitively, this means, we estimate an individual treatment effect
for each combination of treatment-timing-group and control group.</p>
<p>Obviously, this gives us a large number of different treatment
effects. So, in a second step, we re-aggregate these individual
combinations back to group or time averaged treatment effect. In an
event study design, propose the following dynamic treatment effect:</p>
<p><span class="math display">\[
  \theta_D(e) := \sum_{g=2}^T \mathbf{1} \{ g + e \leq T \}
\delta(g,g+e) P(G=g | G+e \leq T),
\]</span> where <span class="math inline">\(e\)</span> specifies for how
long a unit has been exposed to the treatment.</p>
<p>Let’s consider a setting equal to the situation above <span
class="citation">(<a href="#ref-GoodmanBacon.2021"
role="doc-biblioref">Goodman-Bacon 2021</a>)</span> where we have a
control group of never-treated units, one treatment group that is
treated early (group 1) and one treatment group that is treated late
(group 2). As shown below, with <span
class="math inline">\(T=12\)</span> we can estimate 11 2 <span
class="math inline">\(\times\)</span> 2 Diff-in-Diff estimates of group
1 against the never treated, we can estimate 6 2 <span
class="math inline">\(\times\)</span> 2 Diff-in-Diff estimates of group
1 against the not-yet treated (late treatment group), and we can
estimate 11 2 <span class="math inline">\(\times\)</span> 2 Diff-in-Diff
estimates of group 2 against the never treated.</p>
<p>Note that the control period for all treated periods is set to the
period before the treatment happened in each group. For group 1 this is
period 3, and for group 2 this is period 7.</p>
<div class="sourceCode" id="cb38"><pre
class="sourceCode r fold-hide"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="do">################################</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="do">### Example: Marriage Income </span><span class="al">###</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="do">################################</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="do">### Set up six individuals with age and happiness</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>T <span class="ot">&lt;-</span> <span class="dv">12</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a><span class="co"># id and wave</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>df2 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">nrow =</span> N<span class="sc">*</span>T))</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(df2) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;id&quot;</span>, <span class="st">&quot;wave&quot;</span>)</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>id <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>N, <span class="at">each =</span> T)</span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>wave <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>T, <span class="at">times =</span> N)</span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>idname <span class="ot">&lt;-</span> <span class="fu">factor</span>(df2<span class="sc">$</span>id, <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span>N), <span class="at">labels =</span> <span class="fu">paste</span>(<span class="st">&quot;Person&quot;</span>, <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span>N)))</span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Treatment group</span></span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>D <span class="ot">&lt;-</span> <span class="dv">0</span> </span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>D[(<span class="dv">1</span><span class="sc">*</span>T <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(<span class="dv">2</span><span class="sc">*</span>T)] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>D[(<span class="dv">2</span><span class="sc">*</span>T <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(<span class="dv">3</span><span class="sc">*</span>T)] <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>Treatment <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(df2<span class="sc">$</span>wave <span class="sc">&gt;=</span> <span class="dv">4</span> <span class="sc">&amp;</span> df2<span class="sc">$</span>D <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a>oo <span class="ot">&lt;-</span> <span class="fu">which</span>(df2<span class="sc">$</span>wave <span class="sc">&gt;=</span> <span class="dv">8</span> <span class="sc">&amp;</span> df2<span class="sc">$</span>D <span class="sc">==</span> <span class="dv">2</span>)</span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>Treatment[oo] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-26"><a href="#cb38-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Starting wage</span></span>
<span id="cb38-27"><a href="#cb38-27" aria-hidden="true" tabindex="-1"></a>stw <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">2000</span>, <span class="dv">3000</span>, <span class="dv">4000</span>)</span>
<span id="cb38-28"><a href="#cb38-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-29"><a href="#cb38-29" aria-hidden="true" tabindex="-1"></a><span class="co"># wage equation</span></span>
<span id="cb38-30"><a href="#cb38-30" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>wage <span class="ot">&lt;-</span> <span class="fu">unname</span>(<span class="fu">rep</span>(stw, <span class="at">each =</span> T)) <span class="sc">+</span> (df2<span class="sc">$</span>wave <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">*</span><span class="dv">50</span> <span class="sc">+</span> df2<span class="sc">$</span>Treatment <span class="sc">*</span> <span class="dv">500</span></span>
<span id="cb38-31"><a href="#cb38-31" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>Treatment <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(df2<span class="sc">$</span>Treatment)</span>
<span id="cb38-32"><a href="#cb38-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-33"><a href="#cb38-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Add comparison groups</span></span>
<span id="cb38-34"><a href="#cb38-34" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>wage2 <span class="ot">&lt;-</span> <span class="fu">ave</span>(df2<span class="sc">$</span>wage,</span>
<span id="cb38-35"><a href="#cb38-35" aria-hidden="true" tabindex="-1"></a>                 df2<span class="sc">$</span>id,</span>
<span id="cb38-36"><a href="#cb38-36" aria-hidden="true" tabindex="-1"></a>                 <span class="at">FUN =</span> <span class="cf">function</span>(x) <span class="fu">lag</span>(x))</span>
<span id="cb38-37"><a href="#cb38-37" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>wave2 <span class="ot">&lt;-</span> <span class="fu">ave</span>(df2<span class="sc">$</span>wave,</span>
<span id="cb38-38"><a href="#cb38-38" aria-hidden="true" tabindex="-1"></a>                 df2<span class="sc">$</span>id,</span>
<span id="cb38-39"><a href="#cb38-39" aria-hidden="true" tabindex="-1"></a>                 <span class="at">FUN =</span> <span class="cf">function</span>(x) <span class="fu">lag</span>(x))</span>
<span id="cb38-40"><a href="#cb38-40" aria-hidden="true" tabindex="-1"></a>oo <span class="ot">&lt;-</span> <span class="fu">which</span>(df2<span class="sc">$</span>Treatment <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb38-41"><a href="#cb38-41" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>wage2[oo] <span class="ot">&lt;-</span> <span class="fu">ave</span>(df2<span class="sc">$</span>wage2[oo],</span>
<span id="cb38-42"><a href="#cb38-42" aria-hidden="true" tabindex="-1"></a>                 df2<span class="sc">$</span>id[oo],</span>
<span id="cb38-43"><a href="#cb38-43" aria-hidden="true" tabindex="-1"></a>                 <span class="at">FUN =</span> <span class="cf">function</span>(x) x[<span class="dv">1</span>])</span>
<span id="cb38-44"><a href="#cb38-44" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>wave2[oo] <span class="ot">&lt;-</span> <span class="fu">ave</span>(df2<span class="sc">$</span>wave2[oo],</span>
<span id="cb38-45"><a href="#cb38-45" aria-hidden="true" tabindex="-1"></a>                 df2<span class="sc">$</span>id[oo],</span>
<span id="cb38-46"><a href="#cb38-46" aria-hidden="true" tabindex="-1"></a>                 <span class="at">FUN =</span> <span class="cf">function</span>(x) x[<span class="dv">1</span>])</span>
<span id="cb38-47"><a href="#cb38-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-48"><a href="#cb38-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-49"><a href="#cb38-49" aria-hidden="true" tabindex="-1"></a><span class="do">### Plot </span></span>
<span id="cb38-50"><a href="#cb38-50" aria-hidden="true" tabindex="-1"></a>zp1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df2, <span class="fu">aes</span>(wave, wage)) <span class="sc">+</span></span>
<span id="cb38-51"><a href="#cb38-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> wave, <span class="at">y =</span> wage, <span class="at">group =</span> id, <span class="at">alpha =</span> <span class="fu">as.factor</span>(D)), <span class="at">lty =</span> <span class="st">&quot;solid&quot;</span>, <span class="at">colour =</span> <span class="st">&quot;black&quot;</span>, <span class="at">lwd =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb38-52"><a href="#cb38-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>( <span class="fu">aes</span>(<span class="at">x =</span> wave, <span class="at">y =</span> wage, <span class="at">shape =</span> Treatment, <span class="at">color =</span> Treatment, <span class="at">alpha =</span> <span class="fu">as.factor</span>(D)), </span>
<span id="cb38-53"><a href="#cb38-53" aria-hidden="true" tabindex="-1"></a>              <span class="at">size =</span> <span class="dv">2</span>, <span class="at">stroke =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb38-54"><a href="#cb38-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_alpha_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="fl">0.2</span>), <span class="at">guide =</span> <span class="st">&quot;none&quot;</span>) <span class="sc">+</span></span>
<span id="cb38-55"><a href="#cb38-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb38-56"><a href="#cb38-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>( <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">12</span>, <span class="dv">2</span>))  <span class="sc">+</span></span>
<span id="cb38-57"><a href="#cb38-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Group 1: 11 2x2 DID estimates against never-treated&quot;</span>) <span class="sc">+</span></span>
<span id="cb38-58"><a href="#cb38-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.05</span>,<span class="fl">0.95</span>), <span class="at">legend.justification =</span> <span class="fu">c</span>(<span class="st">&quot;left&quot;</span>, <span class="st">&quot;top&quot;</span>),</span>
<span id="cb38-59"><a href="#cb38-59" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb38-60"><a href="#cb38-60" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.box.background =</span> <span class="fu">element_rect</span>(<span class="at">colour =</span> <span class="st">&quot;black&quot;</span>)) <span class="sc">+</span></span>
<span id="cb38-61"><a href="#cb38-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_curve</span>(<span class="fu">aes</span>(<span class="at">x =</span> wave2, <span class="at">y =</span> wage2, <span class="at">xend =</span> wave, <span class="at">yend =</span> wage, <span class="at">color =</span> Treatment), </span>
<span id="cb38-62"><a href="#cb38-62" aria-hidden="true" tabindex="-1"></a>             <span class="at">curvature =</span> <span class="fl">0.3</span>, <span class="at">data =</span> df2[df2<span class="sc">$</span>D <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(df2<span class="sc">$</span>wage2), ])</span>
<span id="cb38-63"><a href="#cb38-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-64"><a href="#cb38-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-65"><a href="#cb38-65" aria-hidden="true" tabindex="-1"></a>zp2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df2, <span class="fu">aes</span>(wave, wage)) <span class="sc">+</span></span>
<span id="cb38-66"><a href="#cb38-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> wave, <span class="at">y =</span> wage, <span class="at">group =</span> id, <span class="at">alpha =</span> <span class="fu">as.factor</span>(D)), <span class="at">lty =</span> <span class="st">&quot;solid&quot;</span>, <span class="at">colour =</span> <span class="st">&quot;black&quot;</span>, <span class="at">lwd =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb38-67"><a href="#cb38-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>( <span class="fu">aes</span>(<span class="at">x =</span> wave, <span class="at">y =</span> wage, <span class="at">shape =</span> Treatment, <span class="at">color =</span> Treatment, <span class="at">alpha =</span> <span class="fu">as.factor</span>(D)), </span>
<span id="cb38-68"><a href="#cb38-68" aria-hidden="true" tabindex="-1"></a>              <span class="at">size =</span> <span class="dv">2</span>, <span class="at">stroke =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb38-69"><a href="#cb38-69" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_alpha_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="dv">1</span>, <span class="fl">0.2</span>), <span class="at">guide =</span> <span class="st">&quot;none&quot;</span>) <span class="sc">+</span></span>
<span id="cb38-70"><a href="#cb38-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> wave, <span class="at">y =</span> wage, <span class="at">group =</span> id, ), <span class="at">lty =</span> <span class="st">&quot;solid&quot;</span>, <span class="at">colour =</span> <span class="st">&quot;black&quot;</span>, <span class="at">lwd =</span> <span class="dv">1</span>,</span>
<span id="cb38-71"><a href="#cb38-71" aria-hidden="true" tabindex="-1"></a>            <span class="at">data =</span> df2[df2<span class="sc">$</span>D <span class="sc">==</span> <span class="dv">2</span> <span class="sc">&amp;</span> df2<span class="sc">$</span>wave <span class="sc">&lt;=</span> <span class="dv">7</span>, ]) <span class="sc">+</span> </span>
<span id="cb38-72"><a href="#cb38-72" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>( <span class="fu">aes</span>(<span class="at">x =</span> wave, <span class="at">y =</span> wage, <span class="at">shape =</span> Treatment, <span class="at">color =</span> Treatment), </span>
<span id="cb38-73"><a href="#cb38-73" aria-hidden="true" tabindex="-1"></a>              <span class="at">size =</span> <span class="dv">2</span>, <span class="at">stroke =</span> <span class="dv">2</span>,</span>
<span id="cb38-74"><a href="#cb38-74" aria-hidden="true" tabindex="-1"></a>              <span class="at">data =</span> df2[df2<span class="sc">$</span>D <span class="sc">==</span> <span class="dv">2</span> <span class="sc">&amp;</span> df2<span class="sc">$</span>wave <span class="sc">&lt;=</span> <span class="dv">7</span>, ]) <span class="sc">+</span></span>
<span id="cb38-75"><a href="#cb38-75" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb38-76"><a href="#cb38-76" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>( <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">12</span>, <span class="dv">2</span>))  <span class="sc">+</span></span>
<span id="cb38-77"><a href="#cb38-77" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Group 1: 6 2x2 DID estimates against not-yet-treated&quot;</span>) <span class="sc">+</span></span>
<span id="cb38-78"><a href="#cb38-78" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.05</span>,<span class="fl">0.95</span>), <span class="at">legend.justification =</span> <span class="fu">c</span>(<span class="st">&quot;left&quot;</span>, <span class="st">&quot;top&quot;</span>),</span>
<span id="cb38-79"><a href="#cb38-79" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb38-80"><a href="#cb38-80" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.box.background =</span> <span class="fu">element_rect</span>(<span class="at">colour =</span> <span class="st">&quot;black&quot;</span>)) <span class="sc">+</span></span>
<span id="cb38-81"><a href="#cb38-81" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_curve</span>(<span class="fu">aes</span>(<span class="at">x =</span> wave2, <span class="at">y =</span> wage2, <span class="at">xend =</span> wave, <span class="at">yend =</span> wage, <span class="at">color =</span> Treatment), </span>
<span id="cb38-82"><a href="#cb38-82" aria-hidden="true" tabindex="-1"></a>             <span class="at">curvature =</span> <span class="fl">0.3</span>, <span class="at">data =</span> df2[df2<span class="sc">$</span>D <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(df2<span class="sc">$</span>wage2) <span class="sc">&amp;</span> df2<span class="sc">$</span>wave <span class="sc">&lt;=</span> <span class="dv">7</span>, ])</span>
<span id="cb38-83"><a href="#cb38-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-84"><a href="#cb38-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-85"><a href="#cb38-85" aria-hidden="true" tabindex="-1"></a>zp3 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df2, <span class="fu">aes</span>(wave, wage)) <span class="sc">+</span></span>
<span id="cb38-86"><a href="#cb38-86" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> wave, <span class="at">y =</span> wage, <span class="at">group =</span> id, <span class="at">alpha =</span> <span class="fu">as.factor</span>(D)), <span class="at">lty =</span> <span class="st">&quot;solid&quot;</span>, <span class="at">colour =</span> <span class="st">&quot;black&quot;</span>, <span class="at">lwd =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb38-87"><a href="#cb38-87" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>( <span class="fu">aes</span>(<span class="at">x =</span> wave, <span class="at">y =</span> wage, <span class="at">shape =</span> Treatment, <span class="at">color =</span> Treatment, <span class="at">alpha =</span> <span class="fu">as.factor</span>(D)), </span>
<span id="cb38-88"><a href="#cb38-88" aria-hidden="true" tabindex="-1"></a>              <span class="at">size =</span> <span class="dv">2</span>, <span class="at">stroke =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb38-89"><a href="#cb38-89" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_alpha_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="fl">0.2</span>, <span class="dv">1</span>), <span class="at">guide =</span> <span class="st">&quot;none&quot;</span>) <span class="sc">+</span></span>
<span id="cb38-90"><a href="#cb38-90" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb38-91"><a href="#cb38-91" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>( <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">12</span>, <span class="dv">2</span>))  <span class="sc">+</span></span>
<span id="cb38-92"><a href="#cb38-92" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Group 2: 11 2x2 DID estimates against never-treated&quot;</span>) <span class="sc">+</span></span>
<span id="cb38-93"><a href="#cb38-93" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.05</span>,<span class="fl">0.95</span>), <span class="at">legend.justification =</span> <span class="fu">c</span>(<span class="st">&quot;left&quot;</span>, <span class="st">&quot;top&quot;</span>),</span>
<span id="cb38-94"><a href="#cb38-94" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb38-95"><a href="#cb38-95" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.box.background =</span> <span class="fu">element_rect</span>(<span class="at">colour =</span> <span class="st">&quot;black&quot;</span>)) <span class="sc">+</span></span>
<span id="cb38-96"><a href="#cb38-96" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_curve</span>(<span class="fu">aes</span>(<span class="at">x =</span> wave2, <span class="at">y =</span> wage2, <span class="at">xend =</span> wave, <span class="at">yend =</span> wage, <span class="at">color =</span> Treatment), </span>
<span id="cb38-97"><a href="#cb38-97" aria-hidden="true" tabindex="-1"></a>             <span class="at">curvature =</span> <span class="fl">0.3</span>, <span class="at">data =</span> df2[df2<span class="sc">$</span>D <span class="sc">==</span> <span class="dv">2</span> <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(df2<span class="sc">$</span>wage2), ])</span></code></pre></div>
<div class="sourceCode" id="cb39"><pre
class="sourceCode r fold-hide"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">4</span>, .<span class="dv">1</span>, .<span class="dv">1</span>))</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>zp1</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>zp2</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>zp3</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>text <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">&quot;We DO NOT compare</span><span class="sc">\n</span><span class="st">&quot;</span>,</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>                             <span class="st">&quot;group 2 (late treatment) against</span><span class="sc">\n</span><span class="st">&quot;</span>,</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>                             <span class="st">&quot;the already treated periods of group 1&quot;</span>)</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">&quot;text&quot;</span>, <span class="at">x =</span> <span class="dv">4</span>, <span class="at">y =</span> <span class="dv">25</span>, <span class="at">size=</span><span class="dv">8</span>, <span class="at">label =</span> text, <span class="at">color =</span> <span class="st">&quot;red&quot;</span>) <span class="sc">+</span> </span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span></code></pre></div>
<p><img src="Panel_part2_files/figure-html/figures-side-1.png" width="50%" /><img src="Panel_part2_files/figure-html/figures-side-2.png" width="50%" /><img src="Panel_part2_files/figure-html/figures-side-3.png" width="50%" /><img src="Panel_part2_files/figure-html/figures-side-4.png" width="50%" /></p>
<p>For a more detailled introdution see <span class="citation">Callaway
and Sant’Anna (<a href="#ref-Callaway.2020"
role="doc-biblioref">2020</a>)</span> or the respective <a
href="https://cran.r-project.org/web/packages/did/vignettes/multi-period-did.html">package
introcution</a>.</p>
<p><strong>Assumptions</strong>:</p>
<ol style="list-style-type: decimal">
<li><p>Staggered treatment adoption: once a unit has been treated, it
remains treated thereafter (see also the note above).</p></li>
<li><p>Parallel trends assumption</p></li>
</ol>
<ul>
<li>based on never-treated: treated units would have had parallel trends
to never-treated if they would not have experienced treatment. In many
empirical settings this is a strong assumption (why do some units never
experience treatment?).</li>
<li>based on not-yet-treated: treated units would have had parallel
trends to not-yet-treated if they would not have experienced treatment.
This assumption might be a bit more likely to hold.</li>
</ul>
<ol start="3" style="list-style-type: decimal">
<li>No treatment anticipation</li>
</ol>
<ul>
<li>based on never-treated: We can relax the assumption by either
back-dating the treatment or include the appropriate pre-treatment
periods in our results to inspect anticipation qualitatively.</li>
<li>based on not-yet-treated: If there is treatment anticipation, our
control group will be confounded by the treatment effect. A violation of
the assumption can lead to stronger bias if we use the not-yet-treated
as control group.</li>
</ul>
<p><strong>Trade-off</strong>: If assumption 2) is likely to hold, we
can use only the never-treated as controls to relax assumption 3). If
assumption 3) is likely to hold, we can include the not-yet-treated as
control to relax assumption 2).</p>
</div>
<div id="example-2" class="section level3">
<h3>Example</h3>
<p>How does that look in our marriage example? To estimate the dynamic
DD we use the <code>did</code> package, as describes in more detail <a
href="https://cran.r-project.org/web/packages/did/vignettes/did-basics.html">here</a>
or in the authors <a
href="https://pedrohcgs.github.io/posts/twfe">blog</a>.</p>
<p><strong>Note: This package works with staggered treatment adoption!
We thus should perform all the steps we have performed above to restrict
and prepare the data!</strong></p>
<p>As a first step, we need to define a variable that contains the
treatment timing: the first year an ever-treated individual is
treated.</p>
<p>This should be a positive number for all observations in treated
groups. It defines which “group” a unit belongs to. It should be 0 for
units in the untreated group.</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># treatment timing = year if married</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>mwp<span class="sc">$</span>treat_timing <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(mwp<span class="sc">$</span>marry <span class="sc">==</span> <span class="dv">1</span>, mwp<span class="sc">$</span>year, <span class="cn">NA</span>)</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="co"># set never treated to zero</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>mwp<span class="sc">$</span>treat_timing[mwp<span class="sc">$</span>evermarry <span class="sc">==</span> <span class="dv">0</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a><span class="co"># if married is not NA, used min year per id (removing NAs)</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>mwp<span class="sc">$</span>treat_timing[<span class="sc">!</span><span class="fu">is.na</span>(mwp<span class="sc">$</span>marry)] <span class="ot">&lt;-</span> <span class="fu">ave</span>(mwp<span class="sc">$</span>treat_timing[<span class="sc">!</span><span class="fu">is.na</span>(mwp<span class="sc">$</span>marry)],</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>                                           mwp<span class="sc">$</span>id[<span class="sc">!</span><span class="fu">is.na</span>(mwp<span class="sc">$</span>marry)],</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">FUN =</span> <span class="cf">function</span>(x) <span class="fu">min</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(mwp[, <span class="fu">c</span>(<span class="st">&quot;id&quot;</span>, <span class="st">&quot;year&quot;</span>, <span class="st">&quot;marry&quot;</span>, <span class="st">&quot;evermarry&quot;</span>, <span class="st">&quot;treat_timing&quot;</span>)], <span class="at">n =</span> <span class="dv">35</span>)</span></code></pre></div>
<pre><code>##    id year marry evermarry treat_timing
## 1   1 1981     0         1         1988
## 2   1 1983     0         1         1988
## 3   1 1984     0         1         1988
## 4   1 1985     0         1         1988
## 5   1 1986     0         1         1988
## 6   1 1987     0         1         1988
## 7   1 1988     1         1         1988
## 8   1 1989     1         1         1988
## 9   1 1990     1         1         1988
## 10  1 1991     1         1         1988
## 11  1 1992     1         1         1988
## 12  2 1979     0         0            0
## 13  2 1981     0         0            0
## 14  2 1982     0         0            0
## 15  2 1983     0         0            0
## 16  2 1984     0         0            0
## 17  2 1985     0         0            0
## 18  2 1989     0         0            0
## 19  3 1979     0         0            0
## 20  3 1980     0         0            0
## 21  3 1981     0         0            0
## 22  3 1982     0         0            0
## 23  3 1983     0         0            0
## 24  3 1984     0         0            0
## 25  3 1985     0         0            0
## 26  3 1986     0         0            0
## 27  3 1987     0         0            0
## 28  3 1988     0         0            0
## 29  3 1989     0         0            0
## 30  3 1993     0         0            0
## 31  3 1994     0         0            0
## 32  3 2000     0         0            0
## 33  4 1979     0         1         1982
## 34  4 1981     0         1         1982
## 35  4 1982     1         1         1982</code></pre>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co"># estimate group-time average treatment effects using att_gt method</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>wages.attgt <span class="ot">&lt;-</span> <span class="fu">att_gt</span>(<span class="at">yname =</span> <span class="st">&quot;lnw&quot;</span>,</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>                      <span class="at">tname =</span> <span class="st">&quot;year&quot;</span>,</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>                      <span class="at">idname =</span> <span class="st">&quot;id&quot;</span>,</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>                      <span class="at">gname =</span> <span class="st">&quot;treat_timing&quot;</span>,</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>                      <span class="co">#xformla = ~ enrol + yeduc + exp + I(exp^2), # note that we omit the yeargroup here</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data =</span> mwp,</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>                      <span class="at">allow_unbalanced_panel =</span> <span class="cn">TRUE</span>,</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>                      <span class="at">control_group =</span> <span class="st">&quot;notyettreated&quot;</span>,</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>                      <span class="at">est_method =</span> <span class="st">&quot;ipw&quot;</span></span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>                        )</span></code></pre></div>
<pre><code>## Warning in pre_process_did(yname = yname, tname = tname, idname = idname, : Be aware that there are some small groups in your dataset.
##   Check groups: 1980,1982,1990,1994.</code></pre>
<pre><code>## Warning in compute.att_gt(dp): No units in group 1980 in time period 1996</code></pre>
<pre><code>## Warning in compute.att_gt(dp): No units in group 1980 in time period 1998</code></pre>
<pre><code>## Warning in compute.att_gt(dp): No units in group 1980 in time period 2000</code></pre>
<pre><code>## Warning in compute.att_gt(dp): No units in group 1981 in time period 1996</code></pre>
<pre><code>## Warning in compute.att_gt(dp): No units in group 1981 in time period 1998</code></pre>
<pre><code>## Warning in compute.att_gt(dp): No units in group 1981 in time period 2000</code></pre>
<pre><code>## Warning in compute.att_gt(dp): No units in group 1982 in time period 1994</code></pre>
<pre><code>## Warning in compute.att_gt(dp): No units in group 1982 in time period 1996</code></pre>
<pre><code>## Warning in compute.att_gt(dp): No units in group 1982 in time period 1998</code></pre>
<pre><code>## Warning in compute.att_gt(dp): No units in group 1982 in time period 2000</code></pre>
<pre><code>## Warning in compute.att_gt(dp): No units in group 1983 in time period 1998</code></pre>
<pre><code>## Warning in compute.att_gt(dp): No units in group 1983 in time period 2000</code></pre>
<pre><code>## Warning in compute.att_gt(dp): No units in group 1984 in time period 2000</code></pre>
<pre><code>## Warning in compute.att_gt(dp): No units in group 1985 in time period 2000</code></pre>
<pre><code>## Warning in compute.att_gt(dp): No units in group 1994 in time period 1979</code></pre>
<p>One huge advantage: We do not need to make a decision about which
periods (before treatment) we want to include, and which observations go
into the reference category.</p>
<p>However, we get a lot of individual treatment effects.</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Show the group-time specific estimates</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(wages.attgt)</span></code></pre></div>
<pre><code>## 
## Call:
## att_gt(yname = &quot;lnw&quot;, tname = &quot;year&quot;, idname = &quot;id&quot;, gname = &quot;treat_timing&quot;, 
##     data = mwp, allow_unbalanced_panel = TRUE, control_group = &quot;notyettreated&quot;, 
##     est_method = &quot;ipw&quot;)
## 
## Reference: Callaway, Brantly and Pedro H.C. Sant&#39;Anna.  &quot;Difference-in-Differences with Multiple Time Periods.&quot; Journal of Econometrics, Vol. 225, No. 2, pp. 200-230, 2021. &lt;https://doi.org/10.1016/j.jeconom.2020.12.001&gt;, &lt;https://arxiv.org/abs/1803.09015&gt; 
## 
## Group-Time Average Treatment Effects:
##  Group Time ATT(g,t) Std. Error [95% Simult.  Conf. Band]  
##   1980 1980   0.0458     0.1715       -0.4942      0.5858  
##   1980 1981   0.0231     0.2691       -0.8244      0.8705  
##   1980 1982   0.1336     0.1460       -0.3261      0.5933  
##   1980 1983  -0.0032     0.2968       -0.9380      0.9316  
##   1980 1984   0.1506     0.1557       -0.3397      0.6408  
##   1980 1985   0.1559     0.1602       -0.3487      0.6605  
##   1980 1986   0.0510     0.1632       -0.4628      0.5648  
##   1980 1987   0.0072     0.1546       -0.4797      0.4940  
##   1980 1988  -0.0259     0.1643       -0.5433      0.4914  
##   1980 1989  -0.0530     0.2036       -0.6941      0.5881  
##   1980 1990  -0.0255     0.1738       -0.5728      0.5218  
##   1980 1991   0.0051     0.1836       -0.5730      0.5832  
##   1980 1992   0.0074     0.2521       -0.7864      0.8012  
##   1980 1993   0.1456     0.1954       -0.4697      0.7609  
##   1980 1994  -0.2120     0.1950       -0.8260      0.4021  
##   1980 1996       NA         NA            NA          NA  
##   1980 1998       NA         NA            NA          NA  
##   1980 2000       NA         NA            NA          NA  
##   1981 1980  -0.1289     0.1127       -0.4839      0.2260  
##   1981 1981   0.0490     0.0833       -0.2135      0.3114  
##   1981 1982   0.1016     0.1282       -0.3023      0.5054  
##   1981 1983  -0.0413     0.1462       -0.5017      0.4192  
##   1981 1984   0.0303     0.1511       -0.4455      0.5060  
##   1981 1985  -0.0700     0.1380       -0.5045      0.3645  
##   1981 1986  -0.1021     0.1339       -0.5238      0.3196  
##   1981 1987  -0.0572     0.1619       -0.5671      0.4527  
##   1981 1988  -0.0552     0.1676       -0.5830      0.4727  
##   1981 1989  -0.1644     0.1401       -0.6057      0.2768  
##   1981 1990  -0.1310     0.1307       -0.5425      0.2804  
##   1981 1991  -0.2290     0.1939       -0.8397      0.3817  
##   1981 1992  -0.0732     0.1554       -0.5627      0.4163  
##   1981 1993   0.0749     0.1760       -0.4795      0.6292  
##   1981 1994  -0.1662     0.1791       -0.7302      0.3979  
##   1981 1996       NA         NA            NA          NA  
##   1981 1998       NA         NA            NA          NA  
##   1981 2000       NA         NA            NA          NA  
##   1982 1980  -0.1950     0.2646       -1.0284      0.6383  
##   1982 1981   0.2637     0.3229       -0.7533      1.2806  
##   1982 1982   0.1626     0.5429       -1.5470      1.8722  
##   1982 1983   0.1908     0.7018       -2.0195      2.4010  
##   1982 1984   0.0543     0.5375       -1.6384      1.7470  
##   1982 1985   0.3166     0.5567       -1.4366      2.0698  
##   1982 1986  -0.0989     0.2946       -1.0267      0.8288  
##   1982 1987   0.0248     0.2772       -0.8481      0.8978  
##   1982 1988   0.0292     0.2640       -0.8023      0.8607  
##   1982 1989   0.1573     0.2520       -0.6363      0.9508  
##   1982 1990  -0.0694     0.2613       -0.8922      0.7533  
##   1982 1991   0.0606     0.2449       -0.7105      0.8317  
##   1982 1992   0.1227     0.2406       -0.6350      0.8805  
##   1982 1993   0.0560     0.2525       -0.7391      0.8511  
##   1982 1994       NA         NA            NA          NA  
##   1982 1996       NA         NA            NA          NA  
##   1982 1998       NA         NA            NA          NA  
##   1982 2000       NA         NA            NA          NA  
##   1983 1980   0.1212     0.0992       -0.1914      0.4337  
##   1983 1981  -0.0378     0.0738       -0.2702      0.1947  
##   1983 1982   0.1181     0.0724       -0.1099      0.3460  
##   1983 1983  -0.0772     0.0948       -0.3757      0.2213  
##   1983 1984  -0.0860     0.0916       -0.3744      0.2024  
##   1983 1985  -0.0279     0.1109       -0.3770      0.3212  
##   1983 1986  -0.0125     0.1427       -0.4618      0.4368  
##   1983 1987  -0.0215     0.1845       -0.6027      0.5596  
##   1983 1988  -0.1636     0.1689       -0.6954      0.3682  
##   1983 1989  -0.1976     0.1578       -0.6946      0.2994  
##   1983 1990  -0.2338     0.1571       -0.7284      0.2609  
##   1983 1991  -0.1548     0.1727       -0.6986      0.3889  
##   1983 1992  -0.1332     0.1795       -0.6986      0.4321  
##   1983 1993  -0.0297     0.2316       -0.7592      0.6997  
##   1983 1994   0.0511     0.3122       -0.9321      1.0343  
##   1983 1996   0.0934     0.2753       -0.7737      0.9605  
##   1983 1998       NA         NA            NA          NA  
##   1983 2000       NA         NA            NA          NA  
##   1984 1980   0.1525     0.0562       -0.0244      0.3293  
##   1984 1981  -0.2389     0.2045       -0.8830      0.4051  
##   1984 1982   0.4429     0.2095       -0.2169      1.1027  
##   1984 1983  -0.1672     0.1203       -0.5462      0.2118  
##   1984 1984  -0.2668     0.3603       -1.4015      0.8680  
##   1984 1985   0.1108     0.1130       -0.2450      0.4666  
##   1984 1986   0.1001     0.1481       -0.3661      0.5664  
##   1984 1987  -0.0674     0.2907       -0.9827      0.8480  
##   1984 1988   0.1631     0.2357       -0.5791      0.9053  
##   1984 1989   0.1929     0.1213       -0.1891      0.5750  
##   1984 1990   0.1890     0.1847       -0.3928      0.7708  
##   1984 1991   0.2210     0.1208       -0.1593      0.6013  
##   1984 1992   0.3217     0.1452       -0.1356      0.7790  
##   1984 1993   0.1625     0.1679       -0.3663      0.6913  
##   1984 1994   0.3103     0.2277       -0.4068      1.0274  
##   1984 1996   0.3587     0.1937       -0.2513      0.9687  
##   1984 1998   0.3045     0.2245       -0.4024      1.0113  
##   1984 2000       NA         NA            NA          NA  
##   1985 1980   0.1140     0.1509       -0.3613      0.5892  
##   1985 1981  -0.0779     0.1501       -0.5505      0.3946  
##   1985 1982   0.0244     0.1142       -0.3353      0.3841  
##   1985 1983   0.0026     0.0822       -0.2564      0.2615  
##   1985 1984  -0.0224     0.0747       -0.2575      0.2128  
##   1985 1985  -0.0594     0.0598       -0.2477      0.1290  
##   1985 1986   0.0003     0.0868       -0.2730      0.2736  
##   1985 1987   0.0666     0.1103       -0.2808      0.4139  
##   1985 1988   0.1122     0.1212       -0.2697      0.4940  
##   1985 1989   0.1080     0.1368       -0.3229      0.5389  
##   1985 1990   0.0859     0.1670       -0.4401      0.6118  
##   1985 1991   0.0433     0.1789       -0.5200      0.6067  
##   1985 1992   0.2087     0.2000       -0.4212      0.8387  
##   1985 1993   0.3690     0.2194       -0.3219      1.0599  
##   1985 1994   0.3064     0.2282       -0.4122      1.0250  
##   1985 1996   0.0689     0.2122       -0.5993      0.7370  
##   1985 1998   0.2565     0.2913       -0.6608      1.1738  
##   1985 2000       NA         NA            NA          NA  
##   1986 1980  -0.0355     0.2022       -0.6723      0.6013  
##   1986 1981   0.1164     0.1863       -0.4704      0.7031  
##   1986 1982  -0.0427     0.1543       -0.5287      0.4432  
##   1986 1983  -0.1012     0.1200       -0.4791      0.2767  
##   1986 1984   0.0884     0.1546       -0.3986      0.5754  
##   1986 1985   0.0113     0.0921       -0.2786      0.3012  
##   1986 1986  -0.2075     0.0902       -0.4915      0.0766  
##   1986 1987  -0.0586     0.1037       -0.3851      0.2680  
##   1986 1988  -0.0168     0.1373       -0.4493      0.4156  
##   1986 1989  -0.3852     0.1583       -0.8839      0.1134  
##   1986 1990  -0.1849     0.1455       -0.6429      0.2732  
##   1986 1991  -0.2494     0.1448       -0.7053      0.2065  
##   1986 1992  -0.1631     0.1671       -0.6894      0.3632  
##   1986 1993  -0.3148     0.1986       -0.9402      0.3105  
##   1986 1994  -0.1290     0.2362       -0.8730      0.6150  
##   1986 1996  -0.3379     0.4228       -1.6694      0.9937  
##   1986 1998  -0.4934     0.5600       -2.2571      1.2703  
##   1986 2000   0.1782     0.2943       -0.7485      1.1050  
##   1987 1980  -0.0870     0.1262       -0.4843      0.3103  
##   1987 1981  -0.1077     0.1459       -0.5671      0.3518  
##   1987 1982  -0.2367     0.1380       -0.6715      0.1980  
##   1987 1983  -0.0504     0.1129       -0.4061      0.3052  
##   1987 1984   0.0422     0.1960       -0.5750      0.6593  
##   1987 1985   0.3759     0.1262       -0.0216      0.7733  
##   1987 1986  -0.0060     0.1043       -0.3344      0.3223  
##   1987 1987  -0.0954     0.1502       -0.5685      0.3777  
##   1987 1988  -0.1029     0.1217       -0.4860      0.2802  
##   1987 1989  -0.1012     0.1212       -0.4828      0.2803  
##   1987 1990  -0.0826     0.1190       -0.4573      0.2920  
##   1987 1991   0.0224     0.0969       -0.2827      0.3274  
##   1987 1992   0.0868     0.1207       -0.2934      0.4670  
##   1987 1993   0.0554     0.1458       -0.4038      0.5145  
##   1987 1994   0.0322     0.1640       -0.4843      0.5487  
##   1987 1996   0.0578     0.1438       -0.3951      0.5106  
##   1987 1998   0.1176     0.1747       -0.4325      0.6677  
##   1987 2000  -0.0506     0.1972       -0.6715      0.5704  
##   1988 1980   0.1629     0.2686       -0.6830      1.0087  
##   1988 1981   0.1777     0.1333       -0.2421      0.5975  
##   1988 1982   0.0052     0.1513       -0.4714      0.4818  
##   1988 1983   0.0105     0.1339       -0.4113      0.4323  
##   1988 1984  -0.0048     0.1084       -0.3461      0.3364  
##   1988 1985   0.1437     0.0919       -0.1458      0.4332  
##   1988 1986  -0.2029     0.1298       -0.6116      0.2058  
##   1988 1987  -0.0009     0.0936       -0.2956      0.2939  
##   1988 1988   0.1335     0.0666       -0.0761      0.3431  
##   1988 1989   0.3157     0.1231       -0.0720      0.7035  
##   1988 1990   0.3005     0.0980       -0.0080      0.6091  
##   1988 1991   0.3596     0.1063        0.0249      0.6944 *
##   1988 1992   0.2546     0.1191       -0.1205      0.6298  
##   1988 1993   0.3282     0.1299       -0.0809      0.7374  
##   1988 1994   0.3124     0.1654       -0.2086      0.8333  
##   1988 1996   0.3425     0.1409       -0.1013      0.7864  
##   1988 1998   0.1312     0.2700       -0.7191      0.9816  
##   1988 2000   0.1996     0.1677       -0.3287      0.7278  
##   1989 1980   0.0841     0.1780       -0.4763      0.6445  
##   1989 1981  -0.1884     0.2445       -0.9584      0.5816  
##   1989 1982   0.2056     0.2562       -0.6011      1.0123  
##   1989 1983   0.0025     0.2978       -0.9353      0.9403  
##   1989 1984   0.0223     0.0906       -0.2629      0.3076  
##   1989 1985  -0.2832     0.2322       -1.0146      0.4482  
##   1989 1986   0.0454     0.2680       -0.7986      0.8895  
##   1989 1987  -0.0350     0.1441       -0.4888      0.4187  
##   1989 1988   0.0708     0.0946       -0.2271      0.3687  
##   1989 1989   0.0486     0.1128       -0.3067      0.4040  
##   1989 1990   0.0521     0.1256       -0.3433      0.4475  
##   1989 1991   0.0720     0.1663       -0.4517      0.5958  
##   1989 1992   0.2708     0.2922       -0.6495      1.1911  
##   1989 1993   0.0143     0.2168       -0.6686      0.6971  
##   1989 1994   0.1855     0.3038       -0.7712      1.1423  
##   1989 1996   0.2842     0.4128       -1.0159      1.5843  
##   1989 1998   0.3437     0.2956       -0.5872      1.2745  
##   1989 2000   0.0745     0.4139       -1.2289      1.3778  
##   1990 1980   0.0271     0.3336       -1.0234      1.0776  
##   1990 1981  -0.0903     0.1477       -0.5555      0.3749  
##   1990 1982  -0.3019     0.1521       -0.7808      0.1770  
##   1990 1983   0.2384     0.2117       -0.4282      0.9049  
##   1990 1984   0.4904     0.2603       -0.3293      1.3101  
##   1990 1985  -0.5329     0.2228       -1.2346      0.1688  
##   1990 1986  -0.1602     0.2059       -0.8087      0.4884  
##   1990 1987  -0.0241     0.1222       -0.4088      0.3606  
##   1990 1988   0.0585     0.3256       -0.9670      1.0839  
##   1990 1989   0.0291     0.2646       -0.8042      0.8623  
##   1990 1990   0.0951     0.2251       -0.6139      0.8041  
##   1990 1991   0.0717     0.3791       -1.1223      1.2657  
##   1990 1992   0.2766     0.2254       -0.4332      0.9863  
##   1990 1993   0.3321     0.3194       -0.6738      1.3380  
##   1990 1994   0.2388     0.3427       -0.8403      1.3179  
##   1990 1996   0.2235     0.3398       -0.8465      1.2935  
##   1990 1998   0.2999     0.3388       -0.7671      1.3669  
##   1990 2000   0.0711     0.3473       -1.0228      1.1650  
##   1991 1980   0.0674     0.3240       -0.9528      1.0876  
##   1991 1981   0.1846     0.1313       -0.2289      0.5981  
##   1991 1982  -0.3465     0.2384       -1.0973      0.4043  
##   1991 1983   0.1857     0.1882       -0.4068      0.7783  
##   1991 1984  -0.3355     0.1587       -0.8351      0.1642  
##   1991 1985   0.2739     0.2270       -0.4408      0.9887  
##   1991 1986   0.0838     0.1643       -0.4336      0.6013  
##   1991 1987   0.0179     0.1770       -0.5395      0.5752  
##   1991 1988   0.0641     0.1635       -0.4508      0.5790  
##   1991 1989  -0.1817     0.1682       -0.7112      0.3479  
##   1991 1990   0.2377     0.1095       -0.1073      0.5827  
##   1991 1991  -0.0155     0.1030       -0.3399      0.3090  
##   1991 1992  -0.0115     0.1407       -0.4548      0.4317  
##   1991 1993   0.0052     0.1477       -0.4598      0.4702  
##   1991 1994  -0.1098     0.1950       -0.7240      0.5043  
##   1991 1996  -0.2591     0.1627       -0.7714      0.2532  
##   1991 1998  -0.1275     0.1750       -0.6786      0.4237  
##   1991 2000  -0.2352     0.2356       -0.9772      0.5069  
##   1992 1980   0.0273     0.2258       -0.6839      0.7385  
##   1992 1981  -0.0104     0.1961       -0.6278      0.6071  
##   1992 1982   0.1930     0.1389       -0.2444      0.6305  
##   1992 1983  -0.0356     0.1399       -0.4762      0.4049  
##   1992 1984  -0.1464     0.1037       -0.4729      0.1800  
##   1992 1985   0.0910     0.1882       -0.5015      0.6835  
##   1992 1986  -0.0967     0.1754       -0.6490      0.4556  
##   1992 1987  -0.0081     0.2517       -0.8007      0.7846  
##   1992 1988   0.0831     0.1310       -0.3293      0.4956  
##   1992 1989  -0.0646     0.0919       -0.3540      0.2248  
##   1992 1990   0.1328     0.0919       -0.1566      0.4222  
##   1992 1991   0.0683     0.1434       -0.3833      0.5199  
##   1992 1992   0.1507     0.1122       -0.2027      0.5042  
##   1992 1993  -0.0434     0.1286       -0.4484      0.3616  
##   1992 1994  -0.0208     0.1591       -0.5217      0.4801  
##   1992 1996  -0.0925     0.1808       -0.6620      0.4769  
##   1992 1998  -0.1061     0.2079       -0.7608      0.5486  
##   1992 2000  -0.1084     0.1826       -0.6834      0.4667  
##   1993 1980   0.0885     0.1311       -0.3243      0.5012  
##   1993 1981  -0.1510     0.0508       -0.3109      0.0089  
##   1993 1982  -0.2665     0.2250       -0.9750      0.4420  
##   1993 1983   0.5454     0.2846       -0.3508      1.4416  
##   1993 1984  -0.2586     0.1303       -0.6690      0.1519  
##   1993 1985   0.3506     0.2181       -0.3364      1.0375  
##   1993 1986   0.1320     0.3362       -0.9267      1.1906  
##   1993 1987  -0.0727     0.2700       -0.9231      0.7778  
##   1993 1988  -0.0676     0.0931       -0.3607      0.2254  
##   1993 1989   0.0641     0.0919       -0.2253      0.3536  
##   1993 1990  -0.0863     0.0753       -0.3233      0.1507  
##   1993 1991  -0.0007     0.0909       -0.2868      0.2855  
##   1993 1992  -0.0081     0.1527       -0.4890      0.4728  
##   1993 1993  -0.1149     0.1627       -0.6272      0.3974  
##   1993 1994  -0.1264     0.1810       -0.6963      0.4436  
##   1993 1996   0.0338     0.1717       -0.5070      0.5747  
##   1993 1998  -0.0599     0.2033       -0.7002      0.5805  
##   1993 2000  -0.2164     0.2296       -0.9395      0.5067  
##   1994 1980       NA         NA            NA          NA  
##   1994 1981   0.2721     0.0684        0.0565      0.4876 *
##   1994 1982  -0.2316     0.0982       -0.5408      0.0777  
##   1994 1983   0.2402     0.1104       -0.1076      0.5880  
##   1994 1984  -0.4270     0.0498       -0.5838     -0.2702 *
##   1994 1985  -0.1525     0.1508       -0.6274      0.3224  
##   1994 1986   0.4009     0.1195        0.0245      0.7773 *
##   1994 1987   0.2158     0.3305       -0.8252      1.2568  
##   1994 1988   0.1474     0.1128       -0.2080      0.5027  
##   1994 1989   0.0033     0.0779       -0.2421      0.2487  
##   1994 1990  -0.0831     0.0539       -0.2527      0.0865  
##   1994 1991   0.0904     0.0595       -0.0970      0.2779  
##   1994 1992   0.3169     0.1371       -0.1149      0.7487  
##   1994 1993  -0.1169     0.0885       -0.3955      0.1617  
##   1994 1994  -0.1990     0.1539       -0.6836      0.2857  
##   1994 1996  -0.0386     0.1270       -0.4385      0.3614  
##   1994 1998  -0.1785     0.2413       -0.9383      0.5813  
##   1994 2000  -0.5138     0.3340       -1.5656      0.5380  
##   1996 1980  -0.5476     0.2773       -1.4209      0.3256  
##   1996 1981   0.2139     0.1776       -0.3455      0.7732  
##   1996 1982   0.0462     0.1739       -0.5015      0.5939  
##   1996 1983  -0.3550     0.2176       -1.0401      0.3302  
##   1996 1984   0.1749     0.1265       -0.2233      0.5732  
##   1996 1985  -0.1094     0.2319       -0.8395      0.6208  
##   1996 1986  -0.0334     0.2788       -0.9114      0.8446  
##   1996 1987   0.4432     0.3578       -0.6837      1.5700  
##   1996 1988  -0.5265     0.3677       -1.6844      0.6315  
##   1996 1989   0.3380     0.2618       -0.4865      1.1624  
##   1996 1990  -0.0997     0.0867       -0.3726      0.1732  
##   1996 1991  -0.0993     0.1232       -0.4874      0.2888  
##   1996 1992  -0.0424     0.1877       -0.6337      0.5488  
##   1996 1993   0.2969     0.3944       -0.9453      1.5391  
##   1996 1994  -0.1758     0.3927       -1.4127      1.0610  
##   1996 1996   0.3742     0.2646       -0.4592      1.2077  
##   1996 1998   0.1061     0.2193       -0.5844      0.7967  
##   1996 2000   0.0994     0.2855       -0.7997      0.9986  
##   1998 1980  -0.3484     0.1145       -0.7090      0.0122  
##   1998 1981   0.2643     0.1031       -0.0604      0.5890  
##   1998 1982   0.1757     0.1760       -0.3786      0.7301  
##   1998 1983  -0.1331     0.2178       -0.8190      0.5528  
##   1998 1984  -0.0396     0.1338       -0.4608      0.3816  
##   1998 1985  -0.2229     0.0880       -0.5000      0.0542  
##   1998 1986   0.4393     0.1655       -0.0819      0.9604  
##   1998 1987  -0.1735     0.1383       -0.6090      0.2620  
##   1998 1988   0.2486     0.0928       -0.0437      0.5409  
##   1998 1989  -0.1116     0.4171       -1.4251      1.2019  
##   1998 1990  -0.1982     0.3996       -1.4565      1.0602  
##   1998 1991   0.1722     0.1365       -0.2577      0.6021  
##   1998 1992   0.0115     0.1217       -0.3718      0.3947  
##   1998 1993  -0.0237     0.1110       -0.3734      0.3260  
##   1998 1994   0.2398     0.3409       -0.8337      1.3133  
##   1998 1996  -0.3608     0.3240       -1.3813      0.6597  
##   1998 1998  -0.0142     0.1631       -0.5279      0.4995  
##   1998 2000   0.1968     0.3331       -0.8523      1.2460  
## ---
## Signif. codes: `*&#39; confidence band does not cover 0
## 
## P-value for pre-test of parallel trends assumption:  0
## Control Group:  Not Yet Treated,  Anticipation Periods:  0
## Estimation Method:  Inverse Probability Weighting</code></pre>
<p>These individual effects are similar to running a lot of individual
regressions, where we compute a lot of individual <span
class="math inline">\(2 \times 2\)</span> DD estimators, e.g. for group
1981:</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>t <span class="ot">&lt;-</span> <span class="dv">1981</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a><span class="co"># run individual effects</span></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="fu">sort</span>(<span class="fu">unique</span>(mwp<span class="sc">$</span>year))[<span class="sc">-</span><span class="dv">1</span>]){</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># not yet treated</span></span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>  mwp<span class="sc">$</span>notyettreated <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(mwp<span class="sc">$</span>treat_timing <span class="sc">&gt;</span> t <span class="sc">&amp;</span> mwp<span class="sc">$</span>treat_timing <span class="sc">&gt;</span> i, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># select 1980 group, never-treated and not yet treated</span></span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a>  oo <span class="ot">&lt;-</span> <span class="fu">which</span>(mwp<span class="sc">$</span>treat_timing <span class="sc">==</span> t <span class="sc">|</span> mwp<span class="sc">$</span>treat_timing <span class="sc">==</span> <span class="dv">0</span> <span class="sc">|</span> mwp<span class="sc">$</span>notyettreated <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> mwp[oo, ]</span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># after set to 1 for year rolling year i</span></span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>after <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>after[df<span class="sc">$</span>year <span class="sc">==</span> i] <span class="ot">&lt;-</span> <span class="dv">1</span> </span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb61-17"><a href="#cb61-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># control year</span></span>
<span id="cb61-18"><a href="#cb61-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(i <span class="sc">&lt;</span> t){</span>
<span id="cb61-19"><a href="#cb61-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># if i is still before actual treatment, compare to previous year</span></span>
<span id="cb61-20"><a href="#cb61-20" aria-hidden="true" tabindex="-1"></a>    tc <span class="ot">&lt;-</span> i <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb61-21"><a href="#cb61-21" aria-hidden="true" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb61-22"><a href="#cb61-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># if i is beyond actual treatment, compare to year before actual treatment (t-1)</span></span>
<span id="cb61-23"><a href="#cb61-23" aria-hidden="true" tabindex="-1"></a>    tc <span class="ot">&lt;-</span> t <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb61-24"><a href="#cb61-24" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb61-25"><a href="#cb61-25" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>after[df<span class="sc">$</span>year <span class="sc">==</span> tc] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb61-26"><a href="#cb61-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb61-27"><a href="#cb61-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Restrict to the two years we want to compare</span></span>
<span id="cb61-28"><a href="#cb61-28" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> df[<span class="sc">!</span><span class="fu">is.na</span>(df<span class="sc">$</span>after), ]</span>
<span id="cb61-29"><a href="#cb61-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb61-30"><a href="#cb61-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define treated group</span></span>
<span id="cb61-31"><a href="#cb61-31" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>treat <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(df<span class="sc">$</span>treat_timing <span class="sc">==</span> t, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb61-32"><a href="#cb61-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb61-33"><a href="#cb61-33" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Estiamte 2x2 DD</span></span>
<span id="cb61-34"><a href="#cb61-34" aria-hidden="true" tabindex="-1"></a>  tmp.lm <span class="ot">&lt;-</span> <span class="fu">lm</span>(lnw <span class="sc">~</span> treat<span class="sc">*</span>after, <span class="at">data =</span> df)</span>
<span id="cb61-35"><a href="#cb61-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb61-36"><a href="#cb61-36" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Print</span></span>
<span id="cb61-37"><a href="#cb61-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">paste0</span>(i, <span class="st">&quot;: &quot;</span>, <span class="fu">round</span>(tmp.lm<span class="sc">$</span>coefficients[<span class="dv">4</span>], <span class="dv">4</span>)))</span>
<span id="cb61-38"><a href="#cb61-38" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<pre><code>## [1] &quot;1980: -0.1289&quot;
## [1] &quot;1981: 0.049&quot;
## [1] &quot;1982: 0.1016&quot;
## [1] &quot;1983: -0.0413&quot;
## [1] &quot;1984: 0.0303&quot;
## [1] &quot;1985: -0.07&quot;
## [1] &quot;1986: -0.1021&quot;
## [1] &quot;1987: -0.0572&quot;
## [1] &quot;1988: -0.0552&quot;
## [1] &quot;1989: -0.1644&quot;
## [1] &quot;1990: -0.131&quot;
## [1] &quot;1991: -0.229&quot;
## [1] &quot;1992: -0.0732&quot;
## [1] &quot;1993: 0.0749&quot;
## [1] &quot;1994: -0.1662&quot;
## [1] &quot;1996: NA&quot;
## [1] &quot;1998: NA&quot;
## [1] &quot;2000: NA&quot;</code></pre>
<p>To make this more interpretable, we re-aggregate the individuals
results to a dynamic time-averaged effect (we now restrict this to
observations from -3 to 6).</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>wages.dyn <span class="ot">&lt;-</span> <span class="fu">aggte</span>(wages.attgt, <span class="at">type =</span> <span class="st">&quot;dynamic&quot;</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>,</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>                   <span class="at">min_e =</span> <span class="sc">-</span><span class="dv">3</span>, <span class="at">max_e =</span> <span class="dv">6</span>)</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(wages.dyn)</span></code></pre></div>
<pre><code>## 
## Call:
## aggte(MP = wages.attgt, type = &quot;dynamic&quot;, min_e = -3, max_e = 6, 
##     na.rm = TRUE)
## 
## Reference: Callaway, Brantly and Pedro H.C. Sant&#39;Anna.  &quot;Difference-in-Differences with Multiple Time Periods.&quot; Journal of Econometrics, Vol. 225, No. 2, pp. 200-230, 2021. &lt;https://doi.org/10.1016/j.jeconom.2020.12.001&gt;, &lt;https://arxiv.org/abs/1803.09015&gt; 
## 
## 
## Overall summary of ATT&#39;s based on event-study/dynamic aggregation:  
##     ATT    Std. Error     [ 95%  Conf. Int.] 
##  0.0458        0.0434    -0.0393      0.1309 
## 
## 
## Dynamic Effects:
##  Event time Estimate Std. Error [95% Simult.  Conf. Band] 
##          -3   0.0400     0.0475       -0.0854      0.1654 
##          -2   0.0172     0.0484       -0.1106      0.1450 
##          -1   0.0186     0.0311       -0.0635      0.1007 
##           0  -0.0039     0.0345       -0.0949      0.0872 
##           1   0.0352     0.0415       -0.0743      0.1447 
##           2   0.0705     0.0414       -0.0387      0.1798 
##           3   0.0710     0.0593       -0.0855      0.2274 
##           4   0.0584     0.0566       -0.0911      0.2078 
##           5   0.0508     0.0649       -0.1205      0.2221 
##           6   0.0384     0.0717       -0.1507      0.2275 
## ---
## Signif. codes: `*&#39; confidence band does not cover 0
## 
## Control Group:  Not Yet Treated,  Anticipation Periods:  0
## Estimation Method:  Inverse Probability Weighting</code></pre>
<p>The <code>did</code> package also comes with a handy command
<code>ggdid()</code> to plot the results</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>zp3 <span class="ot">&lt;-</span> <span class="fu">ggdid</span>(wages.dyn) </span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>zp3 <span class="ot">&lt;-</span> zp3 <span class="sc">+</span> </span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">colour =</span> <span class="fu">gray</span>(<span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>), <span class="at">lty =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="sc">-</span><span class="fl">0.5</span>, <span class="at">colour =</span> <span class="st">&quot;black&quot;</span>, <span class="at">lty =</span> <span class="dv">1</span>)</span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>zp3</span></code></pre></div>
<p><img src="Panel_part2_files/figure-html/unnamed-chunk-26-1.png" width="672" /></p>
<p>Although it is definitely not the same, this doesn’t look too
different from our earlier FEIS results.</p>
</div>
</div>
<div id="synthetic-control" class="section level1">
<h1>Synthetic Control</h1>
<p>So far, we have considered quantitative examples with multiple
treated and multiple non-treated units, and we have applied “bruteforce”
approaches to identify causal effects.</p>
<p>However, sometimes we face the situation of a single treated unit.
This is especially common in comparative case studies. For instance, a
single country or region has implemented a specific policy or
experienced a specific shock. For instance, we might be interested in
how a terrorist attack might influence the economic development of a
region <span class="citation">(<a href="#ref-Abadie.2003"
role="doc-biblioref">Abadie and Gardeazabal 2003</a>)</span>.</p>
<p>The synthetic control estimator <span class="citation">(<a
href="#ref-Abadie.2003" role="doc-biblioref">Abadie and Gardeazabal
2003</a>; <a href="#ref-Abadie.2010" role="doc-biblioref">Abadie,
Diamond, and Hainmueller 2010</a>; <a href="#ref-Abadie.2021"
role="doc-biblioref">Abadie 2021</a>)</span> has become a very popular
way of dealing with situation with a single treated unit.</p>
<p><strong>The general idea: we use the control units to construct an
average “synthetic control” unit in a way that the outcome trajectory of
the synthetic control unit closely matches the outcome trajectory of the
treated unit.</strong> Find weights to construct a “synthetic control”
unit (by reweighing non-treated units) that optimally estimates a
counterfactual trajectory for the treated unit.</p>
<p>With covariates, the method first calculates the importance of
several covariates for the outcome and subsequently computes weights,
which minimizes the difference between the treatment and control groups
in the importance-weighted covariates.</p>
<div class="figure">
<img src="fig/abadie.jpg" alt="" />
<p class="caption">Left: treated (California) unit and unweighted
average of all other states. Right: treated (California) unit and
synthetic control group <span class="citation">(<a
href="#ref-Abadie.2010" role="doc-biblioref">Abadie, Diamond, and
Hainmueller 2010</a>)</span></p>
</div>
<p><strong>Note that we have to assume that the control units are not
affected by the treatment (no spillovers) and that the treatment has no
effect on the outcome before the treatment period (no
anticipation).</strong></p>
<p>If there are reasons to believe that there potential anticipation
effects (often the case), one can back-date the treatment, i.e. we set
the treatment timing to the first period where there might possibly be
an effect on the outcome.</p>
<p>Formally, the (time-specific) treatment effect is estimated as the
difference between the outcome of the treated unit and the average
re-weighted control units <span class="citation">Abadie, Diamond, and
Hainmueller (<a href="#ref-Abadie.2011"
role="doc-biblioref">2011</a>)</span>: <span class="math display">\[
\hat{\delta}_{1t} = Y_{1t} - \sum_{j=2}^{J+1}w_j^*Y_{jt},
\]</span> where <span class="math inline">\(i=1\)</span> is the treated
unit and <span class="math inline">\(j\neq i\)</span> are all potential
control units (donor pool).</p>
<p><span class="math inline">\(w_j^*\)</span> are the optimally chosen
(non-negative) weights for each control unit, where we impose two
restrictions: a) the weights are non-negative <span
class="math inline">\(w_j \geq 0\)</span> for <span
class="math inline">\(j=2,\dots, J+1\)</span>, and the weights sum to
one <span class="math inline">\(\sum_{j=2}^{J+1}w_j = 1\)</span>.</p>
<p>This leaves us with the task to find the optimally chosen weights. So
assume we have <span class="math inline">\(k = 1,\dots,K\)</span>
covariates <span class="math inline">\(\boldsymbol{\mathbf{X}}\)</span>,
where <span class="math inline">\(x_{1k}\)</span> is the <span
class="math inline">\(k\)</span>-th covariate of the treated unit, and
<span class="math inline">\(\boldsymbol{\mathbf{x}}_{0k}\)</span> a
<span class="math inline">\(1 \times J\)</span> vector of the same
covariate for the control units / donor pool. Then we choose <span
class="math inline">\(W^*\)</span> as the value that minimizes <span
class="math display">\[
\sum_{k=1}^K v_k(x_{1k} - x_{0k}W)^2,
\]</span> with <span class="math inline">\(v_k\)</span> reflecting the
relative importance of the covariate <span
class="math inline">\(k\)</span>. As we want the outcome trajectories of
the treated unit and synthetic control to closely match, <span
class="math inline">\(v_1,\dots,v_K\)</span> is usually determined by
the predictive power of the respective covariate.</p>
<p>The original authors <span class="citation">Abadie, Diamond, and
Hainmueller (<a href="#ref-Abadie.2011"
role="doc-biblioref">2011</a>)</span> use a data driven approach to
choose <span class="math inline">\(V^*\)</span> by minimizing the mean
squared prediction error (MSPE) of the outcome over the pre-treatment
periods <span class="math inline">\(t=1,\dots,T_0\)</span>. Formally, we
choose <span class="math inline">\(V^*\)</span> that minimizes: <span
class="math display">\[
\sum_{t=1}^{T_0}\Big( Y_{1t} - \sum_{j=2}^{J+1}w_j^*(V)Y_{jt}\Big)
\]</span></p>
<p>Note: with increasing pre-intervention periods (<span
class="math inline">\(T_0\)</span>), we can assume that the synthetic
control also accounts for unobserved factors affecting <span
class="math inline">\(Y\)</span> <span class="citation">(<a
href="#ref-Abadie.2010" role="doc-biblioref">Abadie, Diamond, and
Hainmueller 2010</a>)</span>, assuming that only units with similar
unobservables exhibit a similar outcome trajectory.</p>
<p>However, with increasing pre-intervention periods, it is important to
check if the outcome trajectories match well not only at far temporal
distances to the treatment but also in periods closely before the
treatment.</p>
<p>A <strong>critical assumption</strong> is that the outcome trajectory
(and other covariates) of the treated unit falls into the “convex hull”
of the donor pool’s outcome trajectories. Intuitively: we construct the
synthetic control by giving each control unit a weight of <span
class="math inline">\(\geq 0\)</span> (we only interpolate, but do not
extrapolate). Thus, there must be sufficient control units with “higher”
and “lower” values in the outcome for pre-intervention periods. If the
treated unit is an outlier before the intervention, Synthetic Control
does not make much sense.</p>
<div id="statistical-inference-with-synthetic-control"
class="section level3">
<h3>Statistical inference with synthetic control</h3>
<p>Calculating uncertainty estimates for Synthetic Control methods is an
ongoing methodological challenge. Recent work, for instance, suggest to
quantify uncertainty based on permutation inference procedures <span
class="citation">(<a href="#ref-Chernozhukov.2021b"
role="doc-biblioref">Chernozhukov, Wüthrich, and Zhu 2021</a>)</span> or
on conditional prediction intervals <span class="citation">(<a
href="#ref-Cattaneo.2021" role="doc-biblioref">Cattaneo, Feng, and
Titiunik 2021</a>)</span>. In practice, however, both methods are
difficult to implement with standard software (especially with covariate
matching).</p>
<p><strong>Placebo tests</strong></p>
<p><span class="citation">Abadie and Gardeazabal (<a
href="#ref-Abadie.2003" role="doc-biblioref">2003</a>)</span> and <span
class="citation">Abadie, Diamond, and Hainmueller (<a
href="#ref-Abadie.2010" role="doc-biblioref">2010</a>)</span> propose a
more qualitative approach to asses the significance of the findings:
<strong>placebo tests</strong>. The idea is that we randomly assign the
treatment to a control unit and perform the Synthetic Control method
with this placebo treatment unit, and we repeat this exercise with every
control unit.</p>
<p>Basically, we test what treatment effect we find if we assign
treatment status to a unit that actually did not receive the treatment,
thereby giving us a distribution of “treatment effects” for non-treated
contries. We can then compare these placebo results to our actual
treatment effect.</p>
<div class="figure">
<img src="fig/abadie_placebo.jpg" alt="" />
<p class="caption">Placebo test for Synthetic Control <span
class="citation">(<a href="#ref-Abadie.2010"
role="doc-biblioref">Abadie, Diamond, and Hainmueller
2010</a>)</span></p>
</div>
<p>To increase the comparability of the actual treatment unit and
placebo treatment units, propose to exclude those units which have a
poor pre-treatment fit (left panel above) by dropping those with a mean
square prediction error above a specific threshold (right panel
above).</p>
<p>If the actual treatment effect lies at the extremes of the
distribution of the placebo “treatment” units, we can say that the
treatment likely had a significant effect on the outcome. If, in
contrast, the actual treatment effect lies in the middle of the placebo
effects for those not receiving the treatment, this indicates that the
treatment did not have a significant influence.</p>
</div>
<div id="example-3" class="section level3">
<h3>Example</h3>
<p>Can we use our marriage wage premium example and the respective data
to perform a Synthetic Control analysis? Why (not)?</p>
<p>In R, we can use the package <code>Synth</code> to produce Synthetic
Control estimates. For a demonstration using Stata by Jens Hainmueller
see the following <a
href="https://web.stanford.edu/~jhain/Video/SynthDemo.mp4">video</a>.</p>
<p>Here, we use the example of <span class="citation">Abadie and
Gardeazabal (<a href="#ref-Abadie.2003"
role="doc-biblioref">2003</a>)</span>, analyzing the influence of the
terrorist conflict in Basque on economic outcomes.</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">&quot;basque&quot;</span>)</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>basque <span class="ot">&lt;-</span> basque[<span class="sc">-</span><span class="fu">which</span>(basque<span class="sc">$</span>regionno <span class="sc">==</span> <span class="dv">1</span>), ]</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(basque[basque<span class="sc">$</span>year <span class="sc">&gt;</span> <span class="dv">1963</span>, ])</span></code></pre></div>
<pre><code>##    regionno regionname year   gdpcap sec.agriculture sec.energy sec.industry
## 53        2  Andalucia 1964 2.508855              NA         NA           NA
## 54        2  Andalucia 1965 2.584690           24.52       2.65        18.18
## 55        2  Andalucia 1966 2.694444              NA         NA           NA
## 56        2  Andalucia 1967 2.802342           21.87       2.65        18.22
## 57        2  Andalucia 1968 2.987361              NA         NA           NA
## 58        2  Andalucia 1969 3.179092           19.73       3.24        18.43
##    sec.construction sec.services.venta sec.services.nonventa school.illit
## 53               NA                 NA                    NA     924.4030
## 54             8.55              38.32                  7.78     899.3490
## 55               NA                 NA                    NA     874.7877
## 56             8.54              39.08                  9.65     850.7106
## 57               NA                 NA                    NA     827.1093
## 58             8.86              39.23                 10.52     803.9755
##    school.prim school.med school.high school.post.high popdens   invest
## 53    3028.127   129.5121    48.95936         24.93797      NA 17.40149
## 54    3036.816   136.1797    51.77722         25.75277      NA 18.30896
## 55    3049.442   143.5947    54.98323         26.63120      NA 18.42999
## 56    3072.636   152.2357    58.61038         27.67255      NA 19.11566
## 57    3086.955   174.5955    62.49103         28.29547      NA 20.60849
## 58    3100.572   197.2741    66.77776         30.38357   68.51 22.05559</code></pre>
<p>The data contains the GDP per capita for Spanish regions in long
format, and several covariates. Our treatment is the onset of political
unrest in Basque in the year 1970. However, the terrorist activities
were low at the beginning, but increased sharply in 1974.</p>
<p>First, we need to create a dataprep object which ensures that
everything is in the right format for the <code>synth()</code> function.
Apart from the standard information, we here have to decide which
control units should be included, which covariates should be included in
the matching procedure, and for which periods these covariates should be
included.</p>
<p>Here we want to include the following covariates:</p>
<ul>
<li><p>The average GDP per capita in 1960 - 1964 and in 1965-1969 (we
use the <code>special.predictors</code> option).</p></li>
<li><p>The share with high school (“school.high”) and more than high
school (“school.post.high”) for the entire observation period (which
need to specified using the option
<code>time.predictors.prior</code>).</p></li>
<li><p>Population density (“popdens”) in 1969 (we use the
<code>special.predictors</code> option).</p></li>
<li><p>Percentage working in the agricultural (“sec.agriculture”), the
industrial (“sec.industry”), and the service sector
(“sec.services.venta”) from 1961, 1963, 1965, 1967, 1969 (we use the
<code>special.predictors</code> option).</p></li>
</ul>
<div class="sourceCode" id="cb68"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>data_prep.out <span class="ot">&lt;-</span> <span class="fu">dataprep</span>(<span class="at">foo =</span> basque, </span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>                          <span class="at">predictors =</span> <span class="fu">c</span>(<span class="st">&quot;school.high&quot;</span>, <span class="st">&quot;school.post.high&quot;</span>),</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>                          <span class="at">predictors.op =</span> <span class="st">&quot;mean&quot;</span>, </span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>                          <span class="at">time.predictors.prior =</span> <span class="dv">1960</span><span class="sc">:</span><span class="dv">1969</span>,</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>                          <span class="at">special.predictors =</span> <span class="fu">list</span>(</span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">list</span>(<span class="st">&quot;gdpcap&quot;</span>, <span class="dv">1960</span><span class="sc">:</span><span class="dv">1964</span>, <span class="st">&quot;mean&quot;</span>),</span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">list</span>(<span class="st">&quot;gdpcap&quot;</span>, <span class="dv">1965</span><span class="sc">:</span><span class="dv">1969</span>, <span class="st">&quot;mean&quot;</span>),</span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">list</span>(<span class="st">&quot;sec.agriculture&quot;</span>, <span class="fu">seq</span>(<span class="dv">1961</span>, <span class="dv">1969</span>, <span class="dv">2</span>), <span class="st">&quot;mean&quot;</span>),</span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">list</span>(<span class="st">&quot;sec.industry&quot;</span>, <span class="fu">seq</span>(<span class="dv">1961</span>, <span class="dv">1969</span>, <span class="dv">2</span>), <span class="st">&quot;mean&quot;</span>),</span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">list</span>(<span class="st">&quot;sec.services.venta&quot;</span>, <span class="fu">seq</span>(<span class="dv">1961</span>, <span class="dv">1969</span>, <span class="dv">2</span>), <span class="st">&quot;mean&quot;</span>)</span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a>                          ),</span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a>                          <span class="at">dependent =</span> <span class="st">&quot;gdpcap&quot;</span>, </span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a>                          <span class="at">unit.variable =</span> <span class="st">&quot;regionno&quot;</span>,</span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a>                          <span class="at">time.variable =</span> <span class="st">&quot;year&quot;</span>, </span>
<span id="cb68-15"><a href="#cb68-15" aria-hidden="true" tabindex="-1"></a>                          <span class="at">treatment.identifier =</span> <span class="dv">17</span>,</span>
<span id="cb68-16"><a href="#cb68-16" aria-hidden="true" tabindex="-1"></a>                          <span class="at">controls.identifier =</span> <span class="fu">c</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">16</span>, <span class="dv">18</span>), </span>
<span id="cb68-17"><a href="#cb68-17" aria-hidden="true" tabindex="-1"></a>                          <span class="at">time.optimize.ssr =</span> <span class="dv">1960</span><span class="sc">:</span><span class="dv">1969</span>, </span>
<span id="cb68-18"><a href="#cb68-18" aria-hidden="true" tabindex="-1"></a>                          <span class="at">time.plot =</span> <span class="dv">1960</span><span class="sc">:</span><span class="dv">1997</span>,</span>
<span id="cb68-19"><a href="#cb68-19" aria-hidden="true" tabindex="-1"></a>                          <span class="at">unit.names.variable =</span> <span class="st">&quot;regionname&quot;</span>)</span></code></pre></div>
<pre><code>## 
##  Missing data- treated unit; predictor: school.high ; for period: 1960 
##  We ignore (na.rm = TRUE) all missing values for predictors.op.
## 
##  Missing data- treated unit; predictor: school.high ; for period: 1961 
##  We ignore (na.rm = TRUE) all missing values for predictors.op.
## 
##  Missing data- treated unit; predictor: school.high ; for period: 1962 
##  We ignore (na.rm = TRUE) all missing values for predictors.op.
## 
##  Missing data- treated unit; predictor: school.high ; for period: 1963 
##  We ignore (na.rm = TRUE) all missing values for predictors.op.
## 
##  Missing data- treated unit; predictor: school.post.high ; for period: 1960 
##  We ignore (na.rm = TRUE) all missing values for predictors.op.
## 
##  Missing data- treated unit; predictor: school.post.high ; for period: 1961 
##  We ignore (na.rm = TRUE) all missing values for predictors.op.
## 
##  Missing data- treated unit; predictor: school.post.high ; for period: 1962 
##  We ignore (na.rm = TRUE) all missing values for predictors.op.
## 
##  Missing data- treated unit; predictor: school.post.high ; for period: 1963 
##  We ignore (na.rm = TRUE) all missing values for predictors.op.
## 
##  Missing data - control unit: 2 ; predictor: school.high ; for period: 1960 
##  We ignore (na.rm = TRUE) all missing values for predictors.op.
## 
##  Missing data - control unit: 2 ; predictor: school.high ; for period: 1961 
##  We ignore (na.rm = TRUE) all missing values for predictors.op.
## 
##  Missing data - control unit: 2 ; predictor: school.post.high ; for period: 1960 
##  We ignore (na.rm = TRUE) all missing values for predictors.op.
## 
##  Missing data - control unit: 2 ; predictor: school.post.high ; for period: 1961 
##  We ignore (na.rm = TRUE) all missing values for predictors.op.</code></pre>
<div class="sourceCode" id="cb70"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cbind</span>(data_prep.out<span class="sc">$</span>X0, data_prep.out<span class="sc">$</span>X1)</span></code></pre></div>
<pre><code>##                                              2         3         4         5
## school.high                          57.266496 16.091676 14.799358  5.921604
## school.post.high                     27.278924  8.684416  6.424505  3.680154
## special.gdpcap.1960.1964              2.271908  3.326892  3.350914  4.605498
## special.gdpcap.1965.1969              2.849586  4.072922  4.116838  5.826450
## special.sec.agriculture.1961.1969    24.194000 21.726000 12.362000 13.130000
## special.sec.industry.1961.1969       18.276000 22.780000 24.126000 18.258000
## special.sec.services.venta.1961.1969 38.186000 34.289999 30.152000 51.752000
##                                              6         7         8         9
## school.high                          12.086849  7.304420 37.787317 16.539727
## school.post.high                      5.844122  2.885214 19.173427  6.308165
## special.gdpcap.1960.1964              2.649514  3.526164  2.456512  1.922979
## special.gdpcap.1965.1969              3.452514  4.216181  3.157612  2.558398
## special.sec.agriculture.1961.1969    19.944000 15.922000 29.718000 36.086001
## special.sec.industry.1961.1969        9.816000 36.530000 16.474000 17.178000
## special.sec.services.venta.1961.1969 45.278001 33.484000 30.844000 29.238000
##                                             10        11        12        13
## school.high                          63.608315 34.275772 11.271676 29.341941
## school.post.high                     32.374611 16.822106  4.570566 13.543060
## special.gdpcap.1960.1964              4.778920  3.548129  1.707641  2.199986
## special.gdpcap.1965.1969              5.515096  4.138360  2.145316  2.832591
## special.sec.agriculture.1961.1969     6.936000 18.582000 37.948000 28.862000
## special.sec.industry.1961.1969       40.056000 28.046000 10.886000 17.882000
## special.sec.services.venta.1961.1969 39.068000 39.064001 31.720000 33.714001
##                                             14        15        16        18
## school.high                          62.458658  9.082540  6.550353  3.377170
## school.post.high                     57.704985  4.428528  4.190368  1.732763
## special.gdpcap.1960.1964              5.751671  2.507169  3.600557  3.400129
## special.gdpcap.1965.1969              6.201714  3.291945  4.391617  4.218281
## special.sec.agriculture.1961.1969     1.864000 19.352000 24.704000 30.322001
## special.sec.industry.1961.1969       23.834000 19.644000 28.398000 26.612000
## special.sec.services.venta.1961.1969 52.714000 36.177999 30.468000 28.300000
##                                             17
## school.high                          25.727525
## school.post.high                     13.479720
## special.gdpcap.1960.1964              4.859026
## special.gdpcap.1965.1969              5.711911
## special.sec.agriculture.1961.1969     6.844000
## special.sec.industry.1961.1969       45.082000
## special.sec.services.venta.1961.1969 33.754000</code></pre>
<p>So, this prepares a list of different objects that are used in the
optimazition algorithm later on. Above, we see all the used covariates
used for mathing.</p>
<p>we can also use it to print the raw trajecotries of the treated
region and the control pool</p>
<div class="sourceCode" id="cb72"><pre
class="sourceCode r fold-hide"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>Y1 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(data_prep.out<span class="sc">$</span>Y1plot)</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(Y1) <span class="ot">&lt;-</span> <span class="st">&quot;y&quot;</span></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>Y1<span class="sc">$</span>treat <span class="ot">&lt;-</span> <span class="st">&quot;Treatment&quot;</span></span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>Y1<span class="sc">$</span>year <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">rownames</span>(Y1))</span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>Y0 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">rowMeans</span>(data_prep.out<span class="sc">$</span>Y0plot))</span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(Y0) <span class="ot">&lt;-</span> <span class="st">&quot;y&quot;</span></span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a>Y0<span class="sc">$</span>treat <span class="ot">&lt;-</span> <span class="st">&quot;Control&quot;</span></span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a>Y0<span class="sc">$</span>year <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">rownames</span>(Y0))</span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">rbind</span>(Y1, Y0)</span>
<span id="cb72-12"><a href="#cb72-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-13"><a href="#cb72-13" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data =</span> data, <span class="fu">aes</span>(<span class="at">x =</span> year, <span class="at">y =</span> y)) <span class="sc">+</span></span>
<span id="cb72-14"><a href="#cb72-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">group =</span> treat, <span class="at">color =</span> treat, <span class="at">linetype =</span> treat),</span>
<span id="cb72-15"><a href="#cb72-15" aria-hidden="true" tabindex="-1"></a>            <span class="at">size =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb72-16"><a href="#cb72-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">guide =</span> <span class="fu">guide_axis</span>(<span class="at">check.overlap =</span> <span class="cn">TRUE</span>))<span class="sc">+</span></span>
<span id="cb72-17"><a href="#cb72-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb72-18"><a href="#cb72-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.key =</span> <span class="fu">element_blank</span>(), <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb72-19"><a href="#cb72-19" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.05</span>,<span class="fl">0.95</span>), <span class="at">legend.justification =</span> <span class="fu">c</span>(<span class="st">&quot;left&quot;</span>, <span class="st">&quot;top&quot;</span>),</span>
<span id="cb72-20"><a href="#cb72-20" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb72-21"><a href="#cb72-21" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.box.background =</span> <span class="fu">element_rect</span>(<span class="at">colour =</span> <span class="st">&quot;black&quot;</span>),</span>
<span id="cb72-22"><a href="#cb72-22" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.spacing.y =</span> <span class="fu">unit</span>(<span class="sc">-</span><span class="fl">0.1</span>, <span class="st">&quot;cm&quot;</span>))</span>
<span id="cb72-23"><a href="#cb72-23" aria-hidden="true" tabindex="-1"></a>p1</span></code></pre></div>
<p><img src="Panel_part2_files/figure-html/unnamed-chunk-29-1.png" width="672" /></p>
<p>This seems pretty hard to compare as there were already strong
differences between Basque and other Spanish reasons before the onset of
terrorist activities.</p>
<p>So, let’s see if we can do better by estimating a synthetic control
unit for Basque using the <code>synth()</code> function.</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>synth.out <span class="ot">&lt;-</span> <span class="fu">synth</span>(<span class="at">data.prep.obj =</span> data_prep.out)</span></code></pre></div>
<pre><code>## 
## X1, X0, Z1, Z0 all come directly from dataprep object.
## 
## 
## **************** 
##  searching for synthetic control unit  
##  
## 
## **************** 
## **************** 
## **************** 
## 
## MSPE (LOSS V): 0.004303228 
## 
## solution.v:
##  0.005771656 0.002774483 0.2459551 0.2711423 0.4700225 0.004333906 2.35e-08 
## 
## solution.w:
##  3.637e-07 1.0433e-06 0.0001466839 0.2090779 2.1999e-06 9.92302e-05 2.842e-07 2.729e-07 0.6449995 9.236e-07 2.988e-07 4.46e-07 0.1456666 3.3936e-06 6.043e-07 2.627e-07</code></pre>
<p>This already gives us some important information. “solution.v” tells
us the weights for the individual covariates, and “solution.w” gives us
the weights for the units in the donor pool for constructing the
synthetic control unit.</p>
<p>Before looking at the actual results, it is helpful to check some
core statistics. For instance, below we see how well the synthetic
control unit mirrors our treated region across the included
covariates.</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>synth.tables  <span class="ot">&lt;-</span> <span class="fu">synth.tab</span>(<span class="at">dataprep.res =</span> data_prep.out, <span class="at">synth.res =</span> synth.out)</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>synth.tables<span class="sc">$</span>tab.pred</span></code></pre></div>
<pre><code>##                                      Treated Synthetic Sample Mean
## school.high                           25.728    51.367      24.235
## school.post.high                      13.480    30.058      13.478
## special.gdpcap.1960.1964               4.859     4.884       3.225
## special.gdpcap.1965.1969               5.712     5.680       3.937
## special.sec.agriculture.1961.1969      6.844     7.494      21.353
## special.sec.industry.1961.1969        45.082    33.133      22.425
## special.sec.services.venta.1961.1969  33.754    43.706      36.528</code></pre>
<p>For the GDP per capita variables, the synthetic control closely
resembles the treated region. That’s good!! However, for other
covariates like “school.high” or “school.post.high”, the synthetic
control region matches notatbly worse than the raw sample… Nevertheless,
why do we not need to worry so much about that? (look at “solution.v”
above)</p>
<p>Obviously, we also want to know the weights that each region receives
for the construction of the synthetic control.</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>synth.tables<span class="sc">$</span>tab.w</span></code></pre></div>
<pre><code>##    w.weights                   unit.names unit.numbers
## 2      0.000                    Andalucia            2
## 3      0.000                       Aragon            3
## 4      0.000       Principado De Asturias            4
## 5      0.209             Baleares (Islas)            5
## 6      0.000                     Canarias            6
## 7      0.000                    Cantabria            7
## 8      0.000              Castilla Y Leon            8
## 9      0.000           Castilla-La Mancha            9
## 10     0.645                     Cataluna           10
## 11     0.000         Comunidad Valenciana           11
## 12     0.000                  Extremadura           12
## 13     0.000                      Galicia           13
## 14     0.146        Madrid (Comunidad De)           14
## 15     0.000           Murcia (Region de)           15
## 16     0.000 Navarra (Comunidad Foral De)           16
## 18     0.000                   Rioja (La)           18</code></pre>
<p>So, only the Baleares, Cataluna and Madrid contribute to the
synthetic control region, while all others are set to zero. Cataluna by
far receives the highest weight.</p>
<p>Finally, how does the synthetic control average look like and how
does it compare to the treated unit of Basque?</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="fu">path.plot</span>(<span class="at">synth.res =</span> synth.out, <span class="at">dataprep.res =</span> data_prep.out,</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>          <span class="at">Ylab =</span> <span class="fu">c</span>(<span class="st">&quot;GDP per capita&quot;</span>))</span></code></pre></div>
<p><img src="Panel_part2_files/figure-html/unnamed-chunk-33-1.png" width="672" /></p>
<p>Before 1970, the synthetic control region aligns very well with the
Basque region. From 1970, Basque shows a slightly lower GDP than its
counterfactual with terrorist activities. From 1974/75 (after the sharp
increase in terrorist activities) we see a pronounced decline in the GDP
as compared to the synthetic control unit.</p>
<p>We can also show these differences more clearly, when plotting the
differences instead of the trajectory.</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="fu">gaps.plot</span>(<span class="at">synth.res =</span> synth.out, <span class="at">dataprep.res =</span> data_prep.out,</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>          <span class="at">Ylab =</span> <span class="fu">c</span>(<span class="st">&quot;Difference in GDP per capita&quot;</span>))</span></code></pre></div>
<p><img src="Panel_part2_files/figure-html/unnamed-chunk-34-1.png" width="672" /></p>
<p><strong>Inferencial statistics</strong></p>
<p>However, is this difference statistically significant or might it be
a result of pure chance?</p>
<p>So give some intuition of the significance of the treatment effect,
we perform an interaction of placebo test, artificially assigning the
treatment status to control regions.</p>
<p>The function <code>generate.placebos()</code> of the
<code>SCtools</code> package does all of this automatically for us.</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>placebo <span class="ot">&lt;-</span> <span class="fu">generate.placebos</span>(<span class="at">dataprep.out =</span> data_prep.out,</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>                             <span class="at">synth.out =</span> synth.out, </span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>                             <span class="at">strategy =</span> <span class="st">&quot;multiprocess&quot;</span>)</span></code></pre></div>
<p>Also creating the respective plot.</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_placebos</span>(placebo)</span></code></pre></div>
<p><img src="Panel_part2_files/figure-html/unnamed-chunk-36-1.png" width="672" /></p>
<p>The real treatment region seems quite special. For some control
regions, we observe similarly stong “treatment effects”. However, these
extreme regions have a poor pre-treatment fit, and thus should be
disregarded.</p>
</div>
</div>
<div id="generalized-synthetic-control" class="section level1">
<h1>Generalized Synthetic Control</h1>
<p><strong>tbd (+ Matrix Completion?)</strong></p>
</div>
<div id="references" class="section level1 unnumbered">
<h1 class="unnumbered">References</h1>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-Abadie.2021" class="csl-entry">
Abadie, Alberto. 2021. <span>“<span class="nocase">Using synthetic
controls: Feasibility, data requirements, and methodological
Aspects</span>.”</span> <em><span>Journal of Economic
Literature</span></em>, Forthcoming.
</div>
<div id="ref-Abadie.2010" class="csl-entry">
Abadie, Alberto, Alexis Diamond, and Jens Hainmueller. 2010.
<span>“<span class="nocase">Synthetic control methods for comparative
case studies: Estimating the effect of California’s tobacco control
program</span>.”</span> <em><span>Journal of the American Statistical
Association</span></em> 105 (490): 493–505. <a
href="https://doi.org/10.1198/jasa.2009.ap08746">https://doi.org/10.1198/jasa.2009.ap08746</a>.
</div>
<div id="ref-Abadie.2011" class="csl-entry">
———. 2011. <span>“<span class="nocase">Synth : An R Package for
Synthetic Control Methods in Comparative Case Studies</span>.”</span>
<em><span>Journal of Statistical Software</span></em> 42 (13). <a
href="https://doi.org/10.18637/jss.v042.i13">https://doi.org/10.18637/jss.v042.i13</a>.
</div>
<div id="ref-Abadie.2003" class="csl-entry">
Abadie, Alberto, and Javier Gardeazabal. 2003. <span>“<span
class="nocase">The Economic Costs of Conflict: A Case Study of the
Basque Country</span>.”</span> <em><span>American Economic
Review</span></em> 93 (1): 113–32. <a
href="https://doi.org/10.1257/000282803321455188">https://doi.org/10.1257/000282803321455188</a>.
</div>
<div id="ref-Bruderl.2015.387" class="csl-entry">
Brüderl, Josef, and Volker Ludwig. 2015. <span>“<span>Fixed-Effects
Panel Regression</span>.”</span> In <em><span class="nocase">The Sage
Handbook of Regression Analysis and Causal Inference</span></em>, edited
by Henning Best and Christof Wolf, 327–57. Los Angeles: Sage.
</div>
<div id="ref-NLSY79.2012" class="csl-entry">
Bureau of Labor Statistics. 2014. <em><span class="nocase">National
Longitudinal Survey of Youth 1979 Cohort, 1979-2012 (rounds
1-23)</span></em>. Columbus, OH: <span>Center for Human Resource
Research, The Ohio State University</span>.
</div>
<div id="ref-Callaway.2020" class="csl-entry">
Callaway, Brantly, and Pedro H. C. Sant’Anna. 2020. <span>“<span
class="nocase">Difference-in-Differences with multiple time
periods</span>.”</span> <em><span>Journal of Econometrics</span></em> 72
(5): 1. <a
href="https://doi.org/10.1016/j.jeconom.2020.12.001">https://doi.org/10.1016/j.jeconom.2020.12.001</a>.
</div>
<div id="ref-Cattaneo.2021" class="csl-entry">
Cattaneo, Matias D., Yingjie Feng, and Rocio Titiunik. 2021.
<span>“<span class="nocase">Prediction Intervals for Synthetic Control
Methods</span>.”</span> <em><span>Journal of the American Statistical
Association</span></em> 116 (536): 1865–80. <a
href="https://doi.org/10.1080/01621459.2021.1979561">https://doi.org/10.1080/01621459.2021.1979561</a>.
</div>
<div id="ref-Chamberlain.1982" class="csl-entry">
Chamberlain, Gary. 1982. <span>“<span class="nocase">Multivariate
Regression Models for Panel Data</span>.”</span> <em><span>Journal of
Econometrics</span></em> 18 (1): 5–46. <a
href="https://doi.org/10.1016/0304-4076(82)90094-X">https://doi.org/10.1016/0304-4076(82)90094-X</a>.
</div>
<div id="ref-Chernozhukov.2021b" class="csl-entry">
Chernozhukov, Victor, Kaspar Wüthrich, and Yinchu Zhu. 2021.
<span>“<span class="nocase">An Exact and Robust Conformal Inference
Method for Counterfactual and Synthetic Controls</span>.”</span>
<em><span>Journal of the American Statistical Association</span></em>
116 (536): 1849–64. <a
href="https://doi.org/10.1080/01621459.2021.1920957">https://doi.org/10.1080/01621459.2021.1920957</a>.
</div>
<div id="ref-Clark.2013" class="csl-entry">
Clark, Andrew E., and Yannis Georgellis. 2013. <span>“<span
class="nocase">Back to Baseline in Britain: Adaptation in the British
Household Panel Survey</span>.”</span> <em><span>Economica</span></em>
80 (319): 496–512. <a
href="https://doi.org/10.1111/ecca.12007">https://doi.org/10.1111/ecca.12007</a>.
</div>
<div id="ref-Currie.2015" class="csl-entry">
Currie, Janet, Lucas Davis, Michael Greenstone, and Reed Walker. 2015.
<span>“<span class="nocase">Environmental Health Risks and Housing
Values: Evidence from 1,600 Toxic Plant Openings and
Closings</span>.”</span> <em><span>American Economic Review</span></em>
105 (2): 678–709. <a
href="https://doi.org/10.1257/aer.20121656">https://doi.org/10.1257/aer.20121656</a>.
</div>
<div id="ref-deChaisemartin.2020" class="csl-entry">
de Chaisemartin, Clément, and Xavier D’Haultfœuille. 2020.
<span>“Two-<span>Way Fixed Effects Estimators</span> with
<span>Heterogeneous Treatment Effects</span>.”</span> <em>American
Economic Review</em> 110 (9): 2964–96. <a
href="https://doi.org/10.1257/aer.20181169">https://doi.org/10.1257/aer.20181169</a>.
</div>
<div id="ref-GoodmanBacon.2021" class="csl-entry">
Goodman-Bacon, Andrew. 2021. <span>“<span
class="nocase">Difference-in-differences with variation in treatment
timing</span>.”</span> <em><span>Journal of Econometrics</span></em> 225
(2): 254–77. <a
href="https://doi.org/10.1016/j.jeconom.2021.03.014">https://doi.org/10.1016/j.jeconom.2021.03.014</a>.
</div>
<div id="ref-Ludwig.2018.0" class="csl-entry">
Ludwig, Volker, and Josef Brüderl. 2018. <span>“<span class="nocase">Is
There a Male Marital Wage Premium? New Evidence from the United
States</span>.”</span> <em><span>American Sociological
Review</span></em> 83 (4): 744–70. <a
href="https://doi.org/10.1177/0003122418784909">https://doi.org/10.1177/0003122418784909</a>.
</div>
<div id="ref-Ludwig.2021" class="csl-entry">
———. 2021. <span>“<span class="nocase">What You Need to Know When
Estimating Impact Functions with Panel Data for Demographic
Research</span>.”</span> <em><span>Comparative Population
Studies</span></em> 46. <a
href="https://doi.org/10.12765/CPoS-2021-16">https://doi.org/10.12765/CPoS-2021-16</a>.
</div>
<div id="ref-Meer.2016" class="csl-entry">
Meer, Jonathan, and Jeremy West. 2016. <span>“<span
class="nocase">Effects of the Minimum Wage on Employment
Dynamics</span>.”</span> <em><span>Journal of Human
Resources</span></em> 51 (2): 500–522. <a
href="https://doi.org/10.3368/jhr.51.2.0414-6298R1">https://doi.org/10.3368/jhr.51.2.0414-6298R1</a>.
</div>
<div id="ref-Mundlak.1978.0" class="csl-entry">
Mundlak, Yair. 1978. <span>“<span class="nocase">On the Pooling of Time
Series and Cross Section Data</span>.”</span>
<em><span>Econometrica</span></em> 46 (1): 69. <a
href="https://doi.org/10.2307/1913646">https://doi.org/10.2307/1913646</a>.
</div>
<div id="ref-Polachek.1994.0" class="csl-entry">
Polachek, Solomon W., and Moon-Kak Kim. 1994. <span>“<span
class="nocase">Panel Estimates of the Gender Earnings
Gap</span>.”</span> <em><span>Journal of Econometrics</span></em> 61
(1): 23–42. <a
href="https://doi.org/10.1016/0304-4076(94)90075-2">https://doi.org/10.1016/0304-4076(94)90075-2</a>.
</div>
<div id="ref-Ruttenauer.2020" class="csl-entry">
Rüttenauer, Tobias, and Volker Ludwig. 2020. <span>“<span
class="nocase">Fixed effects individual slopes: Accounting and testing
for heterogeneous effects in panel data or other multilevel
models</span>.”</span> <em><span>Sociological Methods <span>&amp;</span>
Research</span></em> OnlineFirst. <a
href="https://doi.org/10.1177/0049124120926211">https://doi.org/10.1177/0049124120926211</a>.
</div>
<div id="ref-Sun.2021" class="csl-entry">
Sun, Liyang, and Sarah Abraham. 2021. <span>“Estimating Dynamic
Treatment Effects in Event Studies with Heterogeneous Treatment
Effects.”</span> <em>Journal of Econometrics</em> 225 (2): 175–99. <a
href="https://doi.org/10.1016/j.jeconom.2020.09.006">https://doi.org/10.1016/j.jeconom.2020.09.006</a>.
</div>
<div id="ref-Wooldridge.2010.384" class="csl-entry">
Wooldridge, Jeffrey M. 2010. <em><span class="nocase">Econometric
Analysis of Cross Section and Panel Data</span></em>. Cambridge, Mass.:
<span>MIT Press</span>.
</div>
</div>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->
<script>
$(document).ready(function () {
  window.initializeCodeFolding("show" === "show");
});
</script>

<script>
$(document).ready(function ()  {

    // temporarily add toc-ignore selector to headers for the consistency with Pandoc
    $('.unlisted.unnumbered').addClass('toc-ignore')

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = false;
    options.smoothScroll = false;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
